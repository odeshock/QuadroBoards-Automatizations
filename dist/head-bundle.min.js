/*!
 * QuadroBoards Automatizations - HEAD BUNDLE
 * @version 1.0.0
 */
!function(){"use strict";const e=window.FMV=window.FMV||{};e.escapeHtml=e.escapeHtml||function(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},e.normSpace=e.normSpace||function(e){return String(e??"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim()},e.waitForSelector=e.waitForSelector||function(e,t=8e3){return new Promise((r,n)=>{const o=document.querySelector(e);if(o)return r(o);const i=new MutationObserver(()=>{const t=document.querySelector(e);t&&(i.disconnect(),r(t))});i.observe(document.documentElement,{childList:!0,subtree:!0}),setTimeout(()=>{i.disconnect(),n(new Error("timeout: "+e))},t)})},e.sleep=e.sleep||function(e){return new Promise(t=>setTimeout(t,e))},e.readTagText=e.readTagText||function(t,r){if(!t)return"";const n=t.querySelector(r);return e.normSpace(n?n.textContent??"":"")},e.idToNameFromPage=e.idToNameFromPage||function(){const t=new Map;return document.querySelectorAll('a[href*="profile.php?id="]').forEach(r=>{const n=r.href.match(/profile\.php\?id=(\d+)/i),o=e.normSpace(r.textContent||"");n&&o&&!t.has(n[1])&&t.set(n[1],o)}),t},e.parseOrderStrict=e.parseOrderStrict||function(t){const r=e.normSpace(t);return r?/^-?\d+$/.test(r)?{ok:!0,value:parseInt(r,10),html:e.escapeHtml(r)}:{ok:!1,html:`<span class="fmv-missing">Ошибка! Нужен формат целого числа (пример: -3 или 5)</span> — ${e.escapeHtml(r)}`}:{ok:!1,html:""}},e.extractUserIdsFromTags=e.extractUserIdsFromTags||function(e){const t=new Set;return String(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},e.buildIdToNameMapFromTags=e.buildIdToNameMapFromTags||async function(t){if(window.__FMV_ID_TO_NAME_MAP__ instanceof Map&&window.__FMV_ID_TO_NAME_MAP__.size)return window.__FMV_ID_TO_NAME_MAP__;const r=e.extractUserIdsFromTags(t),n=new Map;return"function"!=typeof window.getProfileNameById||await Promise.all(r.map(async e=>{try{const t=await window.getProfileNameById(e);t&&n.set(e,t)}catch{}})),n},e.parseCharactersUnified=e.parseCharactersUnified||function(t,r,n=window.profileLink){const o=String(t||"").trim();if(!o)return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:""};if(!/^\s*user\d+(?:\s*=\s*[^;]+)?(?:\s*;\s*user\d+(?:\s*=\s*[^;]+)?)*\s*$/i.test(o))return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:'<span class="fmv-missing">Ошибка формата! Нужен вид: userN; userM=маска; userM=маска; …</span>'};const i=o.split(/\s*;\s*/).filter(Boolean),s=new Set,c=new Map,a=[];for(const t of i){const[o,i]=t.split("="),l=String(Number((o.match(/user(\d+)/i)||[,""])[1])),u=("user"+l).toLowerCase();s.add(u);const f="function"==typeof n?n(l,r?.get(l)):e.escapeHtml(`user${l}`);if(i){const t=e.normSpace(i);c.has(u)||c.set(u,new Set),c.get(u).add(t.toLowerCase()),a.push(`${f}=${e.escapeHtml(t)}`)}}const l=Array.from(s),u=l.map(t=>{const o=Array.from(c.get(t)||[]),i=String(+t.replace(/^user/i,"")),s="function"==typeof n?n(i,r?.get(i)):e.escapeHtml(`user${i}`);return o.length?`${s} [as ${e.escapeHtml(o.join(", "))}]`:s}).join("; ");return{ok:!0,participantsLower:l,masksByCharLower:c,htmlParticipants:u,htmlMasks:a.join("; "),htmlError:""}},e.renderParticipantsHtml=e.renderParticipantsHtml||function(t,r,n=window.profileLink){const o=e.parseCharactersUnified(t,r,n);if(o&&o.ok)return o.htmlParticipants;const i=e.escapeHtml(String(t??""));return o&&o.htmlError&&o.htmlError.trim()?o.htmlError:`<span class="fmv-missing">Аааа! Нужен формат: userN; userM=маска; userK</span> — ${i}`},window.scrapeUsers=async function(t={}){const r=t.force||!1,n=t.maxPages||1e3,o=t.batchSize||5,i="fmv_users_cache_v2",s=(()=>{if(r)return null;try{const e=sessionStorage.getItem(i);if(!e)return null;const t=JSON.parse(e);return t&&t.time&&t.data?Date.now()-t.time>18e5?null:t.data:null}catch(e){return null}})();if(s)return window.scrapedUsers=s,s;async function c(t){const r=`/userlist.php?p=${t}`;let n;if("function"==typeof window.fetchHtml)n=await window.fetchHtml(r);else{const e=await fetch(r,{credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status} (${r})`);n=await e.text()}const o=(new DOMParser).parseFromString(n,"text/html"),i=[];return o.querySelectorAll("td.tcl.username span.usersname").forEach(t=>{const r=t.querySelector("a[href*='id=']"),n=e.normSpace(r?.textContent||""),o=(e=>{if(!e)return null;const t=e.match(/(?:[?&/])id=(\d+)/i);return t?Number(t[1]):null})(r?.getAttribute("href")||"");n&&Number.isFinite(o)&&i.push({id:o,code:"user"+o,name:n})}),i}const a=new Set,l=[];(await c(1)).forEach(e=>{a.has(e.code)||(a.add(e.code),l.push(e))});for(let t=2;t<=n;t+=o){const r=[];for(let e=0;e<o&&t+e<=n;e++)r.push(t+e);const i=await Promise.all(r.map(e=>c(e).catch(()=>[])));let s=!1;for(const e of i){const t=e.filter(e=>!a.has(e.code));t.length>0&&(s=!0,t.forEach(e=>{a.add(e.code),l.push(e)}))}if(!s)break;t+o<=n&&await e.sleep(300)}return l.sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"})),(e=>{try{sessionStorage.setItem(i,JSON.stringify({time:Date.now(),data:e}))}catch(e){}})(l),window.scrapedUsers=l,l},window.fetchProfileInfo=async function(e=window.UserID){if(null==e)throw new Error("UserID не задан (ни аргументом, ни в window.UserID)");const t=`/profile.php?id=${encodeURIComponent(e)}`,r=await fetch(t,{credentials:"same-origin"});if(!r.ok)throw new Error(`HTTP ${r.status} для ${t}`);const n=await r.text(),o=(new DOMParser).parseFromString(n,"text/html"),i=(e,t=o)=>(t.querySelector(e)?.textContent||"").replace(/\u00A0/g," ").trim(),s=e=>{if(!e)return null;const t=String(e).replace(/[^\d+-]/g,"").match(/^[+-]?\d+/);return t?Number(t[0]):null},c=await(async()=>{const e=window.MainUsrFieldResolver?.getFieldValue;if(e)try{return await e({doc:o,fieldId:6})}catch(e){console.warn("[fetchProfileInfo] getFieldValue error:",e)}const t=i("li#pa-fld6 strong");if(t)return t;const r=i("li#pa-fld6");return r?r.split(":").slice(-1)[0].trim():""})(),a=(()=>{const e=s(c);return Number.isFinite(e)?e:0})(),l=i("li#pa-register-date strong"),u=i("li#pa-respect strong"),f=i("li#pa-positive strong"),p=i("li#pa-posts strong");return{id:Number(e),date:(e=>{const t=(e||"").match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);if(!t)return null;const r=Number(t[1]),n=Number(t[2]);return[Number(t[3]),n,r]})(l),respect:s(u),positive:s(f),messages:(d=p,s((d||"").split(" - ")[0])),money:a};var d},window.encodeWithSep=function(e,t=!1){const r=t?"+AND+":"+";return e.trim().split(/\s+/).map(e=>e.split("").map(e=>/[A-Za-z0-9'`~_]/.test(e)?e:encodeURIComponent(e)).join("")).join(r)},window.scrapePosts=async function(t,r,n=!1,o="",{maxPages:i=999,delayMs:s=300}={}){if(!t)throw new Error("author обязателен");if(!r||Array.isArray(r)&&0===r.length)throw new Error("forums обязателен");const c=Array.isArray(r)?r.join(","):String(r),a=e=>{const r=new URL("/search.php",location.origin);return r.search=new URLSearchParams({action:"search",author:window.encodeWithSep(t),forums:c,sort_dir:"DESC",p:String(e)}).toString(),r.toString()};async function l(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),r=await t.text();return(new DOMParser).parseFromString(r,"text/html")}const u=(e="")=>{const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll(".quote-box.hide-box").forEach(e=>{const t=e.querySelector("blockquote");if(t){const r=document.createElement("div");r.innerHTML=t.innerHTML,e.replaceWith(r)}}),t.querySelectorAll("cite").forEach(e=>e.remove()),t.querySelectorAll(".code-box").forEach(e=>{const t=e.querySelector("pre"),r=t?t.textContent:"",n=document.createElement("div");n.textContent=r||"",e.replaceWith(n)}),t.querySelectorAll(".custom_tag, .hidden_tag, characters, location, order").forEach(e=>e.remove()),t.querySelectorAll('script[type="text/html"]').forEach(e=>{const t=document.createElement("div");t.innerHTML=e.textContent||"",t.querySelectorAll("p, br").forEach(e=>e.insertAdjacentText("afterend","\n"));let r=(t.textContent||"").replace(/\u00A0/g," ").replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");e.insertAdjacentText("beforebegin",r?`\n${r}\n`:""),e.remove()});t.querySelectorAll(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DIV","DL","DT","DD","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","THEAD","TBODY","TFOOT","TR","UL","BR"].join(",")).forEach(e=>{"BR"===e.tagName?e.insertAdjacentText("beforebegin","\n"):e.insertAdjacentText("afterend","\n")});let r=(t.textContent||"").replace(/\u00A0/g," ");r=r.replace(/\[\/?indent\]/gi,"").replace(/\[\/?float(?:=[^\]]+)?\]/gi,"").replace(/\[DiceFM[^\]]*?\]/gi,""),r=r.replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n");const n=[];for(const e of r.split("\n")){const t=e.trim();""===t?n.length&&""!==n[n.length-1]&&n.push(""):n.push(t)}return n.join("\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n").replace(/^\n+|\n+$/g,"").trim()},f=e=>{const t=e.querySelector("h3 > span"),r=t?t.querySelectorAll("a"):[],n=r[1]?.textContent?.trim()||"",o=r[2]?new URL(r[2].getAttribute("href"),location.href).href:"",i=e.querySelector(".post-content");let s=i?.innerHTML?.trim()||"";s=((e="")=>e.replace(/\[html\]([\s\S]*?)\[\/html\]/gi,(e,t)=>u(t)))(s);const c=u(s);return{title:n,src:o,text:c,html:s,symbols_num:c.length}},p=e=>[...e.querySelectorAll(".post")].map(f),d=e=>(e=>{let t=0;for(const r of e)t=(t<<5)-t+r.charCodeAt(0),t|=0;return t})(e.map(e=>e.src).join("\n"));return n?await async function(){const t=await l(a(1)),r=p(t);if(!r.length)return m([]);const n=d(r);for(const e of r){if(o&&e.src===o)return m([]);if(e.symbols_num>0)return m([e])}await e.sleep(s);for(let t=2;t<=i;t++){const r=await l(a(t)),i=p(r);if(!i.length)break;if(d(i)===n)break;for(const e of i){if(o&&e.src===o)return m([]);if(e.symbols_num>0)return m([e])}await e.sleep(s)}return m([])}():await async function(){const t=[],r=await l(a(1)),n=p(r);if(!n.length)return m([]);const c=d(n),u=e=>{for(const r of e){if(o&&r.src===o)return!0;t.push(r)}return!1};if(u(n))return m(t);await e.sleep(s);for(let r=2;r<=i;r++){const n=await l(a(r)),o=p(n);if(!o.length)break;if(d(o)===c)break;if(u(o))return m(t);await e.sleep(s)}return m(t)}();function m(e){const t=e.slice().reverse();try{console.table(t.map(e=>({title:e.title,src:e.src,symbols_num:e.symbols_num,textPreview:e.text.slice(0,120).replace(/\s+/g," ")})))}catch{console.log(t)}return window.__scrapedPosts=t,t}},window.scrapeTopicFirstPostLinks=async function(t,r,{maxPages:n=999,delayMs:o=300}={}){if(!t)throw new Error("author обязателен");if(!Array.isArray(r)||0===r.length)throw new Error("forums обязателен и должен быть массивом");const i=r.join(","),s=e=>{const r=new URL("/search.php",location.origin);return r.search=new URLSearchParams({action:"search",author:window.encodeWithSep(t),forums:i,sort_dir:"DESC",show_as:"topics",p:String(e)}).toString(),r.toString()};async function c(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),r=await t.text();return(new DOMParser).parseFromString(r,"text/html")}const a=e=>{let t=0;for(const r of e)t=(t<<5)-t+r.charCodeAt(0),t|=0;return t};function l(e){for(const t of e.children)if("A"===t.tagName)return t;return null}function u(e){const t=[...e.querySelectorAll(".tclcon")],r=[];for(const e of t){let t=e.querySelector(".byuser-username")?.textContent?.trim();if(!t){const r=e.closest("tr");t=r?.querySelector(".tcr .byuser-username")?.textContent?.trim()||""}if(t!==targetAuthor)continue;const n=l(e),o=n?.getAttribute("href");o&&r.push(new URL(o,location.href).href)}return r}function f(e){try{const t=new URL(e,location.href);if(("/viewtopic.php"===t.pathname||t.pathname.endsWith("/viewtopic.php"))&&t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}if(t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}return t.href}catch{return e}}function p(e,t){let r=e.querySelector(".post.topicpost a.permalink");if(r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;if(r=e.querySelector(".post.topicpost h3 a[href*='#p']"),r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;if(r=e.querySelector(".post.topicpost a[href*='#p']"),r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;try{const r=new URL(t).searchParams.get("id");if(r)for(const n of e.querySelectorAll("a[href*='#p']")){const e=new URL(n.getAttribute("href"),t);if(e.pathname.endsWith("/viewtopic.php")&&e.searchParams.get("id")===r)return e.href}}catch{}return null}const d=u(await c(s(1))),m=a(d.join("\n")),w=[...d];await e.sleep(o);for(let t=2;t<=n;t++){const r=u(await c(s(t)));if(a(r.join("\n"))===m)break;w.push(...r),await e.sleep(o)}const h=[...new Set(w)],g=[];for(const t of h){const r=f(t);try{const e=p(await c(r),r);if(e){const t=e.match(/#p(\d+)/);if(t){const n=t[1],o=new URL(e,r),i=new URL("/viewtopic.php",o.origin);i.searchParams.set("pid",n),g.push(`${i.href}#p${n}`)}else g.push(e)}}catch{}await e.sleep(o)}return window.__scrapedTopicFirstPosts=g,g}}(),function(){"use strict";window.FMV||(window.FMV={}),FMV.fetchUsers=async function(e={}){if("function"!=typeof window.scrapeUsers)throw new Error("window.scrapeUsers не найдена. Убедитесь, что common.js загружен.");return await window.scrapeUsers(e)},FMV.invalidateUsersCache=function(){try{sessionStorage.removeItem("fmv_users_cache_v2"),sessionStorage.removeItem("fmv_users_cache_v1")}catch(e){}}}();const __cp1251Map=(()=>{const e={};for(let t=1040;t<=1103;t++)e[t]=t-848;return e[1025]=168,e[1105]=184,e})();function encodeURIcp1251(e){const t=[];for(const r of String(e)){let e=r.charCodeAt(0);if(void 0!==__cp1251Map[e]&&(e=__cp1251Map[e]),e<=255)e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"));else{const e=`&#${r.charCodeAt(0)};`;for(const r of e){const e=r.charCodeAt(0);e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"))}}}return t.join("").replace(/\+/g,"%2B")}function serializeFormCP1251_SelectSubmit(e,t="save"){const r=[];for(const n of Array.from(e.elements||[])){if(!n.name||n.disabled)continue;const e=(n.type||"").toLowerCase();if("submit"!==e&&"button"!==e){if("preview"!==n.name&&("checkbox"!==e&&"radio"!==e||n.checked))if("SELECT"===n.tagName&&n.multiple)for(const e of n.options)e.selected&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(e.value));else r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value??""))}else n.name===t&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value||""))}return r.join("&")}async function fetchCP1251Doc(e){const t=await fetch(e,{credentials:"include"});if(!t.ok)throw new Error(`GET ${e} → HTTP ${t.status}`);const r=await t.arrayBuffer(),n=new TextDecoder("windows-1251").decode(r);return(new DOMParser).parseFromString(n,"text/html")}async function fetchCP1251Text(e,t){const r=await fetch(e,t),n=await r.arrayBuffer();return{res:r,text:new TextDecoder("windows-1251").decode(n)}}function serializeFormCP1251(e){const t=[];for(const r of Array.from(e.elements||[]))if(r.name&&!r.disabled&&("checkbox"!==r.type&&"radio"!==r.type||r.checked))if("SELECT"===r.tagName&&r.multiple)for(const e of r.options)e.selected&&t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(e.value));else t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(r.value));return t.join("&")}async function fetchHtml(e){const t=await fetch(e,{credentials:"include"});if(!t.ok)throw new Error("HTTP "+t.status);const r=await t.arrayBuffer(),n=t.headers.get("content-type")||"",o=(n.match(/charset=([\w-]+)/i)||[])[1]?.toLowerCase();if(o&&"utf-8"!==o)try{return new TextDecoder(o).decode(r)}catch{}const i=new TextDecoder("utf-8").decode(r),s=i.match(/<meta[^>]+charset\s*=\s*["']?([\w-]+)/i)||i.match(/<meta[^>]+content=["'][^"']*charset\s*=\s*([\w-]+)/i),c=(s&&s[1]||"").toLowerCase();if(!o&&c&&"utf-8"!==c)try{return new TextDecoder(c).decode(r)}catch{}const a=new TextDecoder("windows-1251").decode(r),l=/[ÂÃÐÑ][\u0080-\u00FF]?/g,u=e=>({mixed:(e.match(/\b(?:[A-Za-z]+[А-Яа-яЁё]+|[А-Яа-яЁё]+[A-Za-z]+)[A-Za-zА-Яа-яЁё]*\b/g)||[]).length,bad:(e.match(l)||[]).length+(e.match(/\uFFFD/g)||[]).length}),f=u(i),p=u(a);return p.bad>f.bad+3?i:f.bad>p.bad+3||f.mixed>p.mixed+1?a:i}function userLink(e,t="",r=!1){const n=String(e),o=t||`user${n}`,i=(window.SITE_URL||location.origin).replace(/\/+$/,"");return r?`[url=${i}/profile.php?id=${n}]${o}[/url]`:"function"==typeof window.profileLink?window.profileLink(n,o):`<a href="/profile.php?id=${n}">${o}</a>`}function missingUser(e,t=!1){const r=String(e);return t?`[mark]${r}[/mark]`:`<span class="fmv-missing" data-found="0">${r}</span>`}function topicTitleFromCrumbs(e){const t=e.querySelector("#pun-crumbs1 .crumbs")||e.querySelector(".section .crumbs, .container.crumbs, .crumbs");if(!t)return"";for(let e=t.childNodes.length-1;e>=0;e--){const r=t.childNodes[e];if(r)if(3===r.nodeType){const e=r.nodeValue.replace(/\s+/g," ").trim();if(e)return e}else if(1===r.nodeType&&"A"!==r.tagName&&"EM"!==r.tagName){const e=r.textContent.replace(/\s+/g," ").trim();if(e)return e}}return""}function parseFromScriptHTML(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstElementChild,r=[];return t.querySelectorAll("p").forEach(e=>{const t=parseParagraph(e);t&&r.push(t)}),r}function parseFromRendered(e){const t=e.querySelectorAll("p");if(t.length)return Array.from(t).map(parseParagraph).filter(Boolean);return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").split(/\n{2,}/).map(e=>{const t=document.createElement("div");return t.innerHTML=`<p>${e}</p>`,parseParagraph(t.firstElementChild)}).filter(Boolean)}function findPostNode(e,t){const r=`p${t}`;let n=e.getElementById(r);if(n)return n;const o=e.querySelector(`a[name="${r}"]`);return o?o.closest(".post")||o.closest(".blockpost")||o.parentElement:(n=e.querySelector(`[id^="p${t}"]`),n)}function textFromNodes(e){return e.map(e=>3===e.nodeType?e.nodeValue||"":1===e.nodeType&&e.textContent||"").join("").replace(/\s+/g," ").trim()}function getCurrentGroupId(){const e=Number(document.body?.dataset?.groupId||NaN),t=Number((window&&window.GroupID)??(window&&window.PUNBB&&window.PUNBB.group_id)??(window&&window.PUNBB&&window.PUNBB.user&&window.PUNBB.user.g_id)??e);return Number.isFinite(t)?t:null}async function ensureAllowed(e){const t=getCurrentGroupId(),r=new Set(e.map(String));return null!==t&&r.has(String(t))}
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */window.parseChronoTagsRaw=function(e){const t=t=>e.querySelector(t)?.textContent.trim()||"",r=t("characters"),n=t("masks"),o=(r?r.split(/\s*;\s*/):[]).map(e=>e.trim().toLowerCase()).filter(Boolean),i={};(n||"").split(/\s*;\s*/).forEach(e=>{const t=e.indexOf("=");t>0&&(i[e.slice(0,t).trim().toLowerCase()]=e.slice(t+1).trim())});const s=new Set(o);return Object.keys(i).forEach(e=>s.add(e)),{participantsLower:Array.from(s),masks:i,location:t("location"),order:t("order")}},window.resolveChronoData=async function(e,t={}){const r={...e,idToName:new Map,participantsHtml:"",masksHtml:""},n=new Set;for(const t of e.participantsLower){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const t of Object.keys(e.masks||{})){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const e of n)try{r.idToName.set(e,await getProfileNameById(e)||null)}catch{r.idToName.set(e,null)}const o=e=>{const t=/^user(\d+)$/i.exec(e);if(!t)return window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml(e):e;const n=String(+t[1]),o=r.idToName.get(n)||null;return profileLink(n,o)},i=window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml:e=>e;return r.participantsHtml=e.participantsLower.map(o).join("; "),r.masksHtml=Object.entries(e.masks||{}).map(([e,t])=>`${o(e)}=${i(t)}`).join("; "),r},function(){"use strict";window.FMV=window.FMV||{},FMV.escapeHtmlShort=FMV.escapeHtmlShort||function(e="",t=500){const r=String(e),n=r.length>t?r.slice(0,t)+"…":r;return"function"==typeof FMV.escapeHtml?FMV.escapeHtml(n):n},FMV.fetchDoc=FMV.fetchDoc||async function(e){const t=await fetchHtml(e);return"function"==typeof window.parseHTML?window.parseHTML(t):(new DOMParser).parseFromString(t,"text/html")},FMV.toCp1251Entities=FMV.toCp1251Entities||function(e){const t=/[\u0000-\u007F\u0400-\u045F\u0401\u0451]/;let r="";for(const n of String(e))r+=t.test(n)?n:`&#${n.codePointAt(0)};`;return r}}(),(()=>{"use strict";const e=window.MAKE_NAMES_LINKS??!0;const t=window.fetchHtml||(async e=>{const t=await fetch(e,{credentials:"include"});return await t.text()});window.profileLink=function(t,r){const n=String(Number(t));if(!("string"==typeof r&&r.trim().length>0)){const e=`user${n}`;return`<span class="fmv-missing" data-user-id="${n}" data-found="0">${FMV.escapeHtml(e)}</span>`}const o=FMV.escapeHtml(r.trim());if(!e)return o;const i=document.createElement("a");return i.className="fmv-user",i.href="/profile.php?id="+encodeURIComponent(n),i.textContent=o,i.setAttribute("data-user-id",n),i.setAttribute("data-found","1"),i.outerHTML},window.profileLinkMeta=function(e,t){const r=window.profileLink(e,t),n="string"==typeof r&&!/\bfmv-missing\b/.test(r);return{html:String(r||""),found:n,id:String(Number(e)),name:"string"==typeof t&&t.trim()?t.trim():null}};const r=new Map;let n=null,o=null;async function i(e){const r=await async function(){if(n)return n;if(o)return o;if(!window.EX_PROFILES||"object"!=typeof window.EX_PROFILES)return console.error("[loadExProfiles] Ошибка: window.EX_PROFILES не задан или имеет неверный формат"),n=new Map,n;const{topicID:e,commentID:r}=window.EX_PROFILES;if(null==e||null==r)return console.error("[loadExProfiles] Ошибка: отсутствует topicID или commentID в window.EX_PROFILES"),n=new Map,n;const i=`/viewtopic.php?id=${encodeURIComponent(e)}#p${encodeURIComponent(r)}`;return o=(async()=>{const e=await t(i),r=(new DOMParser).parseFromString(e,"text/html"),o=new Map;for(const e of r.querySelectorAll('a[href*="profile.php?id="]')){const t=(e.getAttribute("href")||"").match(/profile\.php\?id=(\d+)/i);if(!t)continue;const r=String(Number(t[1])),n=(e.textContent||"").trim().toLowerCase();n&&!o.has(r)&&o.set(r,n)}return n=o,o})(),o}();return r.get(String(Number(e)))||null}async function s(e){if(e=String(Number(e)),r.has(e))return r.get(e);let n=function(e){const t=Array.from(document.querySelectorAll(`a[href*="profile.php?id=${e}"]`));for(const e of t){const t=(e.textContent||"").trim();if(t&&!/Профил|Profile/i.test(t))return t}return null}(e);if(!n)try{const r=await t(`/profile.php?id=${e}`);n=function(e){const t=e.querySelector(".user-ident .username")||e.querySelector(".user-box .username")||null;if(t){const e=(t.textContent||"").trim();if(e)return e}const r=["#pun-title span","h1 span","h1","h2.hn",".hn",".title",".subhead h2"].map(t=>e.querySelector(t)).filter(Boolean).map(e=>(e.textContent||"").trim()).filter(Boolean),n=(e.querySelector("title")?.textContent||"").trim();n&&r.unshift(n);const o=[/Профил[ья]\s*[:\-—–]\s*(.+)$/i,/Просмотр\s+профиля\s*[:\-—–]\s*(.+)$/i,/Profile\s*[:\-—–]\s*(.+)$/i];for(let e of r){e=e.replace(/\s+/g," ").trim();for(const t of o){const r=e.match(t);if(r){const e=r[1].trim().replace(/^[«"'\\[]|[»"'\\]]$/g,"").trim();if(e)return e}}}return null}((new DOMParser).parseFromString(r,"text/html"))}catch{}if(!n)try{const t=await i(e);t&&(n=`[ex] ${t}`)}catch{}return r.set(e,n||null),n||null}window.profileLinkByIdAsync=async function(e){const t=String(Number(e)),r=await s(t);return window.profileLinkMeta(t,r)},window.extractUserIdsFromString=function(e){const t=new Set;return(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},window.getProfileNameById=s})(),function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,r=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),n=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${r(e)}, .${r(e)}`,i=new TextDecoder("utf-8");let s;async function c(e){const t=await fetch(e,{credentials:"same-origin"}),r=await t.arrayBuffer();let n=i.decode(r);if(/charset\s*=\s*windows-1251/i.test(n)||n.includes("�"))try{n=(s||=new TextDecoder("windows-1251")).decode(r)}catch{}return n}function a(e,t){const r=e.querySelector(o(t)),n=r?.querySelector("strong, b");let i=n?.textContent?.trim();if(!i){const e=(r?.textContent||"").trim();i=e.split(":").slice(-1)[0]?.trim()}return(i||"").replace(/\u00A0/g," ").trim()}const l=new Map;function u(e,t){if(l.has(e))return l.get(e);const r=(async()=>{const r=await c(`/profile.php?id=${encodeURIComponent(e)}`);return a((new DOMParser).parseFromString(r,"text/html"),t)})();return l.set(e,r),r}function f(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const r=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=r.nextNode();){const t=(e.nodeValue||"").match(n);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:r})=>{u(r,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+r,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:r}={}){const i=`pa-fld${String(r??e).replace(/\D/g,"")||e}`,s=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(n);if(t)return t[1]}return null}(t.querySelector(o(i)));if(s)try{return await u(s,i)}catch(e){console.warn("[main-field] remote error:",e)}return a(t,i)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f,{once:!0}):f()}();const HIDDEN_OPERATIONS=["form-gift-custom","form-gift-present","form-icon-custom","form-icon-present","form-badge-custom","form-badge-present","form-bg-custom","form-bg-present"];function formatBankOperations(e){let t="";return e.forEach(e=>{const r=e.form_id.replace(/^#/,""),n=HIDDEN_OPERATIONS.includes(r);t+=n?"[hide=9999999999]":"",t+=`[b]— ${e.title}[/b] = ${e.sum}\n`,e.form_id&&(t+=`[size=9]form_id: ${e.form_id}[/size]\n`);const o=e.info?.[0];if(!o)return void(t+="\n\n");const{comment:i,type:s}=o;Array.isArray(i)&&("plain"===s?t+=i.join("\n"):"list"===s?t+=i.map((e,t)=>`${t+1}. ${e}`).join("\n"):"list separated"===s?t+=i.map((e,t)=>`${t+1}. ${e}`).join("\n\n"):s&&(t+=i.join("\n"))),t+=n?"[/hide]\n\n":"\n\n"}),t.trim()}window.formatBankOperations=formatBankOperations;