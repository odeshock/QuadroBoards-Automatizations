/*!
 * QuadroBoards Automatizations - HEAD BUNDLE
 * @version 1.0.0
 */
!function(){"use strict";window.FMV||(window.FMV={}),FMV.fetchUsers=async function(e={}){if("function"!=typeof window.scrapeUsers)throw new Error("window.scrapeUsers не найдена. Убедитесь, что common.js загружен.");return await window.scrapeUsers(e)},FMV.invalidateUsersCache=function(){try{sessionStorage.removeItem("fmv_users_cache_v2"),sessionStorage.removeItem("fmv_users_cache_v1")}catch(e){}}}();const __cp1251Map=(()=>{const e={};for(let t=1040;t<=1103;t++)e[t]=t-848;return e[1025]=168,e[1105]=184,e})();function encodeURIcp1251(e){const t=[];for(const r of String(e)){let e=r.charCodeAt(0);if(void 0!==__cp1251Map[e]&&(e=__cp1251Map[e]),e<=255)e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"));else{const e=`&#${r.charCodeAt(0)};`;for(const r of e){const e=r.charCodeAt(0);e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"))}}}return t.join("").replace(/\+/g,"%2B")}function serializeFormCP1251_SelectSubmit(e,t="save"){const r=[];for(const n of Array.from(e.elements||[])){if(!n.name||n.disabled)continue;const e=(n.type||"").toLowerCase();if("submit"!==e&&"button"!==e){if("preview"!==n.name&&("checkbox"!==e&&"radio"!==e||n.checked))if("SELECT"===n.tagName&&n.multiple)for(const e of n.options)e.selected&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(e.value));else r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value??""))}else n.name===t&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value||""))}return r.join("&")}async function fetchCP1251Doc(e){const t=await fetch(e,{credentials:"include"});if(!t.ok)throw new Error(`GET ${e} → HTTP ${t.status}`);const r=await t.arrayBuffer(),n=new TextDecoder("windows-1251").decode(r);return(new DOMParser).parseFromString(n,"text/html")}async function fetchCP1251Text(e,t){const r=await fetch(e,t),n=await r.arrayBuffer();return{res:r,text:new TextDecoder("windows-1251").decode(n)}}function serializeFormCP1251(e){const t=[];for(const r of Array.from(e.elements||[]))if(r.name&&!r.disabled&&("checkbox"!==r.type&&"radio"!==r.type||r.checked))if("SELECT"===r.tagName&&r.multiple)for(const e of r.options)e.selected&&t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(e.value));else t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(r.value));return t.join("&")}async function fetchHtml(e){const t=await fetch(e,{credentials:"include"});if(!t.ok)throw new Error("HTTP "+t.status);const r=await t.arrayBuffer(),n=t.headers.get("content-type")||"",o=(n.match(/charset=([\w-]+)/i)||[])[1]?.toLowerCase();if(o&&"utf-8"!==o)try{return new TextDecoder(o).decode(r)}catch{}const i=new TextDecoder("utf-8").decode(r),s=i.match(/<meta[^>]+charset\s*=\s*["']?([\w-]+)/i)||i.match(/<meta[^>]+content=["'][^"']*charset\s*=\s*([\w-]+)/i),c=(s&&s[1]||"").toLowerCase();if(!o&&c&&"utf-8"!==c)try{return new TextDecoder(c).decode(r)}catch{}const a=new TextDecoder("windows-1251").decode(r),f=/[ÂÃÐÑ][\u0080-\u00FF]?/g,u=e=>({mixed:(e.match(/\b(?:[A-Za-z]+[А-Яа-яЁё]+|[А-Яа-яЁё]+[A-Za-z]+)[A-Za-zА-Яа-яЁё]*\b/g)||[]).length,bad:(e.match(f)||[]).length+(e.match(/\uFFFD/g)||[]).length}),d=u(i),l=u(a);return l.bad>d.bad+3?i:d.bad>l.bad+3||d.mixed>l.mixed+1?a:i}function userLink(e,t="",r=!1){const n=String(e),o=t||`user${n}`,i=(window.SITE_URL||location.origin).replace(/\/+$/,"");return r?`[url=${i}/profile.php?id=${n}]${o}[/url]`:"function"==typeof window.profileLink?window.profileLink(n,o):`<a href="/profile.php?id=${n}">${o}</a>`}function missingUser(e,t=!1){const r=String(e);return t?`[mark]${r}[/mark]`:`<span class="fmv-missing" data-found="0">${r}</span>`}function topicTitleFromCrumbs(e){const t=e.querySelector("#pun-crumbs1 .crumbs")||e.querySelector(".section .crumbs, .container.crumbs, .crumbs");if(!t)return"";for(let e=t.childNodes.length-1;e>=0;e--){const r=t.childNodes[e];if(r)if(3===r.nodeType){const e=r.nodeValue.replace(/\s+/g," ").trim();if(e)return e}else if(1===r.nodeType&&"A"!==r.tagName&&"EM"!==r.tagName){const e=r.textContent.replace(/\s+/g," ").trim();if(e)return e}}return""}function parseFromScriptHTML(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstElementChild,r=[];return t.querySelectorAll("p").forEach(e=>{const t=parseParagraph(e);t&&r.push(t)}),r}function parseFromRendered(e){const t=e.querySelectorAll("p");if(t.length)return Array.from(t).map(parseParagraph).filter(Boolean);return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").split(/\n{2,}/).map(e=>{const t=document.createElement("div");return t.innerHTML=`<p>${e}</p>`,parseParagraph(t.firstElementChild)}).filter(Boolean)}function findPostNode(e,t){const r=`p${t}`;let n=e.getElementById(r);if(n)return n;const o=e.querySelector(`a[name="${r}"]`);return o?o.closest(".post")||o.closest(".blockpost")||o.parentElement:(n=e.querySelector(`[id^="p${t}"]`),n)}function textFromNodes(e){return e.map(e=>3===e.nodeType?e.nodeValue||"":1===e.nodeType&&e.textContent||"").join("").replace(/\s+/g," ").trim()}function getCurrentGroupId(){const e=Number(document.body?.dataset?.groupId||NaN),t=Number((window&&window.GroupID)??(window&&window.PUNBB&&window.PUNBB.group_id)??(window&&window.PUNBB&&window.PUNBB.user&&window.PUNBB.user.g_id)??e);return Number.isFinite(t)?t:null}async function ensureAllowed(e){const t=getCurrentGroupId(),r=new Set(e.map(String));return null!==t&&r.has(String(t))}
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */function formatBankText(e){if(!e||!Array.isArray(e.fullData))return"";let t="";"undefined"!=typeof window&&"string"==typeof window.SITE_URL&&(t=window.SITE_URL.trim().replace(/\/+$/,""));const r=["form-income-anketa","form-income-akcion","form-income-needchar","form-income-episode-of","form-income-post-of","form-income-writer","form-income-activist"],n=["form-income-topup","form-income-ams"],o=["form-income-firstpost"],i=["form-income-personalpost","form-income-plotpost"],s=["form-income-flyer"],c=["form-income-100msgs","form-income-100pos","form-income-100rep","form-income-month"],a=["form-income-needrequest","form-income-contest","form-income-avatar","form-income-avatar","form-income-design-other","form-income-run-contest","form-income-mastering","form-income-rpgtop"],f=["form-income-banner-mayak","form-income-banner-reno"],u=["form-exp-face-1m","form-exp-face-3m","form-exp-face-6m","form-exp-char-1m","form-exp-char-3m","form-exp-char-6m","form-exp-face-own-1m","form-exp-face-own-3m","form-exp-face-own-6m","form-exp-need-1w","form-exp-need-2w","form-exp-need-1m"],d=["form-exp-thirdchar"],l=["form-exp-changechar"],m=["form-exp-refuse"],p=["form-exp-transfer"],w=["form-exp-mask","form-exp-bonus1d1","form-exp-bonus2d1","form-exp-bonus1w1","form-exp-bonus2w1","form-exp-bonus1m1","form-exp-bonus2m1","form-exp-bonus1m3","form-exp-bonus2m3","form-exp-clean"],h=["form-icon-custom","form-icon-present","form-badge-custom","form-badge-present","form-bg-custom","form-bg-present","form-gift-custom","form-gift-present"],y=["price-adjustment"],g=["gift-discount"],b=[...r,...n,...o,...i,...s,...c,...a,...f,...u,...d,...l,...m,...p,...w,...h,...y,...g],$=new Map;for(let e=0;e<b.length;e++)$.has(b[e])||$.set(b[e],e);const S=(e,t,r)=>`[b]— ${e}[/b] = ${t}\n[quote]${r.length?r.join("\n"):""}[/quote]`,_=(e,t)=>`[b]— ${e}[/b]\n[quote]${t.length?t.join("\n"):""}[/quote]`,A=e=>{if(!e)return[];try{const t="string"==typeof e?JSON.parse(e):e;return Array.isArray(t)?t:[]}catch{return[]}},x=e=>null!=e&&""!==String(e).trim(),F=e.fullData.filter(e=>$.has(e.form_id)).sort((e,t)=>$.get(e.form_id)-$.get(t.form_id)),M=new Set([...r,...n,...o,...i,...s,...c,...a,...f]),k=new Set([...u,...d,...l,...m,...p,...w,...y,...h]),E=new Set([...w,...h,...y]),N=F.some(e=>M.has(e.form_id)),C=F.findIndex(e=>k.has(e.form_id)),I=-1!==C;let T=-1,O=-1;F.forEach((e,t)=>{E.has(e.form_id)&&(-1===T&&(T=t),O=t)});const L=-1!==T,P=[];N&&P.push("[quote][size=16][b][align=center]ДОХОДЫ[/align][/b][/size][/quote]"),F.forEach((e,a)=>{I&&a===C&&P.push("[quote][size=16][b][align=center]РАСХОДЫ[/align][/b][/size][/quote]"),L&&a===T&&P.push("[hide=99999999]");const b=e?.title??"",$=e?.modalAmount??e?.amount??"";let F;if(r.includes(e.form_id))F=_(b,((e,r)=>{if(!Array.isArray(e))return[];const n=[];let o=1;for(const i of e){const e=i?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));for(const i of s){const s=e[`recipient_${i.split("_")[1]}`];s&&(n.push(`${o}. ${t}/profile.php?id=${s} — ${r??""}`),o++)}}return n})(e.entries,e.price));else if(n.includes(e.form_id))F=_(b,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const i=Object.keys(e).filter(e=>e.startsWith("recipient_"));i.forEach((o,s)=>{const c=o.split("_")[1],a=e[`recipient_${c}`],f=e[`amount_${c}`],u=e[`comment_${c}`];if(!a)return;let d=`${n}. ${t}/profile.php?id=${a} — ${f??""}\n`;const l=x(u);l&&(d+=`\n[b]Комментарий:[/b] ${String(u).trim()}\n`),!(s===i.length-1)&&l&&(d+="[hr]\n"),r.push(d),n++})}return r})(e.entries));else if(o.includes(e.form_id))F=((e,t)=>`[b]— ${e}[/b] = ${t}`)(b,$);else if(i.includes(e.form_id)){const t="form-income-personalpost"===e.form_id?"personal":"plot";F=S(b,$,((e,t)=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data||{},i="personal"===t?e.personal_posts_json??e.personalPostsJson:e.plot_posts_json??e.plotPostsJson;for(const e of A(i)){const t=e?.src??"",o=e?.text??"",i=e?.symbols_num??"";r.push(`${n}. [url=${t}]${o}[/url] — ${i} символов`),n++}}return r})(e.entries,t))}else F=s.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data||{};for(const n of A(e.flyer_links_json??e.flyerLinksJson)){const e=n?.src??"",o=n?.text??"";t.push(`${r}. [url=${e}]${o}[/url]`),r++}}return t})(e.entries)):c.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[],r=(e,t)=>{if(!e)return;const r=String(t).toLowerCase();for(const t of Object.keys(e))if(t.toLowerCase().endsWith(r))return e[t]};for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(!e)continue;const o=r(e,"_old"),i=r(e,"_new"),s=r(e,"_rounded"),c=n?.multiplier;t.push(`[b]Последнее обработанное значение:[/b] ${o??""}`,`[b]Текущее значение:[/b] ${i??""}`,`[b]Условно округленное значение:[/b] ${s??""}`,`[b]Сколько раз начисляем:[/b] ${c??""}`)}return t})(e.entries)):f.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data?.url;e&&t.push(`[b]Ссылка:[/b] ${e}`)}return t})(e.entries)):u.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data?.quantity;null!=e&&t.push(`[b]Количество[/b]: ${e}`)}return t})(e.entries)):d.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.url??"";r&&t.push(`[b]Согласование:[/b] ${r}`)}}return t})(e.entries)):l.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.text??"";""!==r&&t.push(`[b]Новое имя профиля:[/b]\n[code]${r}[/code]`)}}return t})(e.entries)):m.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.comment??"";""!==r&&t.push(`[b]Комментарий:[/b]\n${r}`)}}return t})(e.entries)):p.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(e&&"object"==typeof e)for(const o of Object.keys(e))if(o.startsWith("recipient_")){const i=o.split("_")[1],s=e[`recipient_${i}`],c=e[`amount_${i}`];s&&(r.push(`${n}. ${t}/profile.php?id=${s} — ${c??""}`),n++)}}return r})(e.entries)):w.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const i=Object.keys(e).filter(e=>e.startsWith("recipient_"));i.forEach((o,s)=>{const c=o.split("_")[1],a=e[`recipient_${c}`],f=e[`quantity_${c}`],u=e[`from_${c}`],d=e[`wish_${c}`],l=x(u),m=x(d);if(!a)return;let p=`${n}. ${t}/profile.php?id=${a} — ${f??""}\n`;if(l||m){let e="";l&&m?e=`${String(u).trim()}: ${String(d).trim()}`:l?e=String(u).trim():m&&(e=String(d).trim()),p+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}p+=s===i.length-1||!l&&!m?"":"[hr]\n",r.push(p),n++})}return r})(e.entries)):h.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const i=Object.keys(e).filter(e=>e.startsWith("recipient_"));i.forEach((o,s)=>{const c=o.split("_")[1],a=e[`recipient_${c}`],f=e[`from_${c}`],u=e[`wish_${c}`],d=e[`gift_data_${c}`],l=x(f),m=x(u),p=x(d);if(!a)return;let w=`${n}. ${t}/profile.php?id=${a}\n`;if(l||m){let e="";l&&m?e=`${String(f).trim()}: ${String(u).trim()}`:l?e=String(f).trim():m&&(e=String(u).trim()),w+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}p&&(w+=`\n[b]Данные:[/b]\n${String(d)}\n`),w+=s!==i.length-1&&(l||m||p)?"[hr]\n":"",r.push(w),n++})}return r})(e.entries)):y.includes(e.form_id)?_(b,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data;if(!e){r++;continue}const o=Array.isArray(e)?e:[e];for(const e of o){const n=e?.adjustment_title??"",o=e?.adjustment_amount??"";t.push(`${r}. [b]${n}:[/b] -${o}`)}r++}return t})(e.entries)):g.includes(e.form_id)?S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data;if(!e){r++;continue}const o=Array.isArray(e)?e:[e];for(const e of o){const n=e?.discount_title??"",o=e?.discount_amount??"";t.push(`${r}. [b]${n}:[/b] ${o}`)}r++}return t})(e.entries)):S(b,$,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(e)for(const n of Object.keys(e))t.push(`${r}. ${e[n]}`),r++}return t})(e.entries));P.push(F),L&&a===O&&P.push("[/hide]")});let U=P.join("\n\n");if(void 0!==e.totalSum&&null!==e.totalSum&&""!==e.totalSum){U+=`\n\n[quote][size=16][align=center][b]ИТОГО:[/b] [color=${Number(e.totalSum)<0?"red":"green"}]${Number(e.totalSum)>0?"+":""}${e.totalSum}[/color][/align][/size][/quote]`}return U}function encodeJSON(e){const t=JSON.stringify(e),r=(new TextEncoder).encode(t),n=Array.from(r,e=>String.fromCharCode(e)).join("");return btoa(n)}function decodeJSON(e){const t=atob(e),r=Uint8Array.from(t,e=>e.charCodeAt(0)),n=(new TextDecoder).decode(r);return JSON.parse(n)}window.parseChronoTagsRaw=function(e){const t=t=>e.querySelector(t)?.textContent.trim()||"",r=t("characters"),n=t("masks"),o=(r?r.split(/\s*;\s*/):[]).map(e=>e.trim().toLowerCase()).filter(Boolean),i={};(n||"").split(/\s*;\s*/).forEach(e=>{const t=e.indexOf("=");t>0&&(i[e.slice(0,t).trim().toLowerCase()]=e.slice(t+1).trim())});const s=new Set(o);return Object.keys(i).forEach(e=>s.add(e)),{participantsLower:Array.from(s),masks:i,location:t("location"),order:t("order")}},window.resolveChronoData=async function(e,t={}){const r={...e,idToName:new Map,participantsHtml:"",masksHtml:""},n=new Set;for(const t of e.participantsLower){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const t of Object.keys(e.masks||{})){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const e of n)try{r.idToName.set(e,await getProfileNameById(e)||null)}catch{r.idToName.set(e,null)}const o=e=>{const t=/^user(\d+)$/i.exec(e);if(!t)return window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml(e):e;const n=String(+t[1]),o=r.idToName.get(n)||null;return profileLink(n,o)},i=window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml:e=>e;return r.participantsHtml=e.participantsLower.map(o).join("; "),r.masksHtml=Object.entries(e.masks||{}).map(([e,t])=>`${o(e)}=${i(t)}`).join("; "),r},function(){"use strict";window.FMV=window.FMV||{},FMV.escapeHtmlShort=FMV.escapeHtmlShort||function(e="",t=500){const r=String(e),n=r.length>t?r.slice(0,t)+"…":r;return"function"==typeof FMV.escapeHtml?FMV.escapeHtml(n):n},FMV.fetchDoc=FMV.fetchDoc||async function(e){const t=await fetchHtml(e);return"function"==typeof window.parseHTML?window.parseHTML(t):(new DOMParser).parseFromString(t,"text/html")},FMV.toCp1251Entities=FMV.toCp1251Entities||function(e){const t=/[\u0000-\u007F\u0400-\u045F\u0401\u0451]/;let r="";for(const n of String(e))r+=t.test(n)?n:`&#${n.codePointAt(0)};`;return r}}(),(()=>{"use strict";const e=window.MAKE_NAMES_LINKS??!0;const t=window.fetchHtml||(async e=>{const t=await fetch(e,{credentials:"include"});return await t.text()});window.profileLink=function(t,r){const n=String(Number(t));if(!("string"==typeof r&&r.trim().length>0)){const e=`user${n}`;return`<span class="fmv-missing" data-user-id="${n}" data-found="0">${FMV.escapeHtml(e)}</span>`}const o=FMV.escapeHtml(r.trim());if(!e)return o;const i=document.createElement("a");return i.className="fmv-user",i.href="/profile.php?id="+encodeURIComponent(n),i.textContent=o,i.setAttribute("data-user-id",n),i.setAttribute("data-found","1"),i.outerHTML},window.profileLinkMeta=function(e,t){const r=window.profileLink(e,t),n="string"==typeof r&&!/\bfmv-missing\b/.test(r);return{html:String(r||""),found:n,id:String(Number(e)),name:"string"==typeof t&&t.trim()?t.trim():null}};const r=new Map;let n=null,o=null;async function i(e){const r=await async function(){if(n)return n;if(o)return o;if(!window.EX_PROFILES||"object"!=typeof window.EX_PROFILES)return console.error("[loadExProfiles] Ошибка: window.EX_PROFILES не задан или имеет неверный формат"),n=new Map,n;const{topicID:e,commentID:r}=window.EX_PROFILES;if(null==e||null==r)return console.error("[loadExProfiles] Ошибка: отсутствует topicID или commentID в window.EX_PROFILES"),n=new Map,n;const i=`/viewtopic.php?id=${encodeURIComponent(e)}#p${encodeURIComponent(r)}`;return o=(async()=>{const e=await t(i),r=(new DOMParser).parseFromString(e,"text/html"),o=new Map;for(const e of r.querySelectorAll('a[href*="profile.php?id="]')){const t=(e.getAttribute("href")||"").match(/profile\.php\?id=(\d+)/i);if(!t)continue;const r=String(Number(t[1])),n=(e.textContent||"").trim().toLowerCase();n&&!o.has(r)&&o.set(r,n)}return n=o,o})(),o}();return r.get(String(Number(e)))||null}async function s(e){if(e=String(Number(e)),r.has(e))return r.get(e);let n=function(e){const t=Array.from(document.querySelectorAll(`a[href*="profile.php?id=${e}"]`));for(const e of t){const t=(e.textContent||"").trim();if(t&&!/Профил|Profile/i.test(t))return t}return null}(e);if(!n)try{const r=await t(`/profile.php?id=${e}`);n=function(e){const t=e.querySelector(".user-ident .username")||e.querySelector(".user-box .username")||null;if(t){const e=(t.textContent||"").trim();if(e)return e}const r=["#pun-title span","h1 span","h1","h2.hn",".hn",".title",".subhead h2"].map(t=>e.querySelector(t)).filter(Boolean).map(e=>(e.textContent||"").trim()).filter(Boolean),n=(e.querySelector("title")?.textContent||"").trim();n&&r.unshift(n);const o=[/Профил[ья]\s*[:\-—–]\s*(.+)$/i,/Просмотр\s+профиля\s*[:\-—–]\s*(.+)$/i,/Profile\s*[:\-—–]\s*(.+)$/i];for(let e of r){e=e.replace(/\s+/g," ").trim();for(const t of o){const r=e.match(t);if(r){const e=r[1].trim().replace(/^[«"'\\[]|[»"'\\]]$/g,"").trim();if(e)return e}}}return null}((new DOMParser).parseFromString(r,"text/html"))}catch{}if(!n)try{const t=await i(e);t&&(n=`[ex] ${t}`)}catch{}return r.set(e,n||null),n||null}window.profileLinkByIdAsync=async function(e){const t=String(Number(e)),r=await s(t);return window.profileLinkMeta(t,r)},window.extractUserIdsFromString=function(e){const t=new Set;return(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},window.getProfileNameById=s})(),function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,r=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),n=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${r(e)}, .${r(e)}`,i=new TextDecoder("utf-8");let s;async function c(e){const t=await fetch(e,{credentials:"same-origin"}),r=await t.arrayBuffer();let n=i.decode(r);if(/charset\s*=\s*windows-1251/i.test(n)||n.includes("�"))try{n=(s||=new TextDecoder("windows-1251")).decode(r)}catch{}return n}function a(e,t){const r=e.querySelector(o(t)),n=r?.querySelector("strong, b");let i=n?.textContent?.trim();if(!i){const e=(r?.textContent||"").trim();i=e.split(":").slice(-1)[0]?.trim()}return(i||"").replace(/\u00A0/g," ").trim()}const f=new Map;function u(e,t){if(f.has(e))return f.get(e);const r=(async()=>{const r=await c(`/profile.php?id=${encodeURIComponent(e)}`);return a((new DOMParser).parseFromString(r,"text/html"),t)})();return f.set(e,r),r}function d(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const r=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=r.nextNode();){const t=(e.nodeValue||"").match(n);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:r})=>{u(r,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+r,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:r}={}){const i=`pa-fld${String(r??e).replace(/\D/g,"")||e}`,s=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(n);if(t)return t[1]}return null}(t.querySelector(o(i)));if(s)try{return await u(s,i)}catch(e){console.warn("[main-field] remote error:",e)}return a(t,i)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d,{once:!0}):d()}(),function(e){const t="/api.php";let r=!1;const n=e=>new URLSearchParams(e);async function o(e,o={},i=1){const s="fmv_bank_info_"+i;if("storage.get"===e){const r=n({user_id:1,method:e,key:s}),o=await fetch(`${t}?${r}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!o.ok)throw new Error(`GET ${o.status}`);return o.json()}if("storage.set"===e){const i=n({user_id:1,token:r,method:e,key:s,...o}),c=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},credentials:"same-origin",body:i});if(!c.ok)throw new Error(`POST ${c.status}`);return!0}throw new Error("Unknown method")}!function(){const t=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;if(t)r=t;else{let t=5;const n=setInterval(()=>{if(r||--t<0)return void clearInterval(n);const o=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;o&&(r=o,clearInterval(n))},200)}}(),e.FMVbank={setTicket:function(e){r=e},storageGet:async function(e=1){const t="fmv_bank_info_"+e;return((e,t)=>{try{const r=e?.response?.storage?.data?.[t];return r?JSON.parse(r):{}}catch{return{}}})(await o("storage.get",{},e),t)},storageSet:async function(e,t=1){if(!e||"object"!=typeof e||Array.isArray(e))throw new Error("[FMVbank] storageSet: ожидался объект JSON");const r=JSON.stringify(e);return await o("storage.set",{value:r},t),!0}}}(window),window.formatBankText=formatBankText,window.encodeJSON=encodeJSON,window.decodeJSON=decodeJSON;