/*!
 * QuadroBoards Automatizations - BODY BUNDLE
 * @version 1.0.0
 */
async function pageExistsViaEditEndpoint(e){const t=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,n=await fetchCP1251Doc(t),r=(n.querySelector("title")?.textContent||"").trim(),o=(n.querySelector("h1, .pagetitle, .tclcon h2")?.textContent||"").trim(),i=/Страница создана/i.test(r),a=!!n.querySelector('input[name="edit_page"]'),s=!![...n.querySelectorAll('input[type="submit"],button[type="submit"]')].find(e=>/сохран/i.test(e.value||e.textContent||""));/Информация/i.test(r)||/Информация/i.test(o);return!!(i||a||s)}function extractInfoMessage(e){const t=(new DOMParser).parseFromString(e,"text/html"),n=(t.querySelector("title")?.textContent||"").trim();return(n?`[${n}] `:"")+([...t.querySelectorAll(".message, .msg, .infobox, .warn, .error, #pun-main p, .block p, .box p")].map(e=>e.textContent.trim()).filter(Boolean).join("\n").trim()||"").trim()}function classifyResult(e){const t=extractInfoMessage(e).toLowerCase();return/уже существует|занято|должно быть уникаль/.test(t)?{status:"duplicate",msg:t}:/страница создана|добавлен|успешно|сохранена/.test(t)?{status:"created",msg:t}:/ошибка|forbidden|нет прав|не удалось|некоррект|заполните/.test(t)?{status:"error",msg:t}:{status:"unknown",msg:t}}async function FMVcreatePersonalPage(e,t,n,r,o,i){const a="/admin_pages.php?action=adddel";try{if(await pageExistsViaEditEndpoint(t))return{status:"exists",title:e,name:t,serverMessage:`Страница "${t}" уже существует (до отправки формы).`,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`};const s=await fetchCP1251Doc(a),l=[...s.querySelectorAll("form")].find(e=>(e.action||"").includes("/admin_pages.php"))||s.querySelector('form[action*="admin_pages.php"]');if(!l)return{status:"error",title:e,name:t,serverMessage:"Форма добавления не найдена",details:"admin_pages.php без формы"};(l.querySelector('[name="title"]')||{}).value=e,(l.querySelector('[name="name"]')||{}).value=t,(l.querySelector('[name="content"]')||{}).value=n;const c=l.querySelector('[name="tags"]');c&&(c.value=r);const d=l.querySelector('select[name="announcement"]');d?d.value=i:[...l.querySelectorAll('input[name="announcement"]')].forEach(e=>e.checked=e.value===i);for(const e of o){const t=l.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}let u="add_page";const p=[...l.elements].find(e=>"submit"===e.type&&("add_page"===e.name||/создать/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(l,u),{res:f,text:h}=await fetchCP1251Text(a,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m}),g=classifyResult(h),y=extractInfoMessage(h)||"",w=await pageExistsViaEditEndpoint(t);return"created"===g.status||w?(console.log(y||"Страница создана"),{status:"created",title:e,name:t,serverMessage:y||"Страница создана",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"duplicate"===g.status?(console.log(y||"Уже существует страница с таким адресным именем"),{status:"exists",title:e,name:t,serverMessage:y||"Уже существует страница с таким адресным именем",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"error"===g.status?(console.log(g.msg||y||"Ошибка при создании"),{status:"error",title:e,name:t,serverMessage:g.msg||y||"Ошибка при создании",httpStatus:f.status}):(console.log(y||"Не удалось подтвердить создание. Проверьте админку."),{status:"uncertain",title:e,name:t,serverMessage:y||"Не удалось подтвердить создание. Проверьте админку.",httpStatus:f.status})}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,console.log(t),n}}async function FMVeditPersonalPage(e,t={}){if(!e)throw new Error('FMVeditPersonalPage: "name" is required');const n=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,r=await("function"==typeof fetchCP1251Doc?fetchCP1251Doc(n):(async()=>{const e=await fetch(n,{credentials:"include"}).then(e=>e.text());return(new DOMParser).parseFromString(e,"text/html")})()),o=(r.body&&r.body.textContent||"").trim();if(/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(o))return{status:"forbidden",serverMessage:"Ссылка неверная или устаревшая",url:n};const i=[...r.querySelectorAll("form")].find(e=>(e.action||"").includes("admin_pages.php"))||r.querySelector("form");if(!i)return{status:"notfound",serverMessage:"Форма редактирования не найдена",url:n};if(null!=t.title){const e=i.querySelector('[name="title"]');e&&(e.value=String(t.title))}if(null!=t.content){const e=i.querySelector('#page-content,[name="content"]');e&&(e.value=String(t.content))}if(null!=t.announcement){const e=i.querySelector('select[name="announcement"]');if(e)e.value=String(t.announcement);else{const e=[...i.querySelectorAll('input[name="announcement"]')];e.length&&e.forEach(e=>e.checked=e.value==t.announcement)}}if(null!=t.tags){const e=i.querySelector('[name="tags"]');e&&(e.value=String(t.tags))}if(Array.isArray(t.groupsOn))for(const e of t.groupsOn){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}if(Array.isArray(t.groupsOff))for(const e of t.groupsOff){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!1)}let a="save";const s=[...i.elements].find(e=>"submit"===e.type&&("save"===e.name||/сохр|save/i.test(e.value||e.textContent||"")));let l,c;s?.name&&(a=s.name);const d=new URL(i.getAttribute("action")||n,location.origin).toString();if("function"==typeof serializeFormCP1251_SelectSubmit&&"function"==typeof fetchCP1251Text){const e=serializeFormCP1251_SelectSubmit(i,a);({res:l,text:c}=await fetchCP1251Text(d,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=windows-1251"},referrer:n,referrerPolicy:"strict-origin-when-cross-origin",body:e}))}else{const e=new FormData(i);e.append(a,s?.value||"1"),l=await fetch(d,{method:"POST",credentials:"include",body:e}),c=await l.text()}const u=/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(c),p=("function"==typeof extractInfoMessage?extractInfoMessage(c):"")||"",m=l.ok&&l.url&&/\/admin_pages\.php(?:\?|$)/.test(l.url)&&!/ошибк|forbidden|нет прав|устаревш/i.test((c||"").toLowerCase()),f=/Администрировани[ея]\s*[–-]\s*Страниц[ыь]/i.test(c)||/Список\s+персональных\s+страниц/i.test(c);if(l.ok&&(u||m||f))return{status:"saved",serverMessage:p||"Изменения сохранены",httpStatus:l.status,url:n};let h={status:"unknown",msg:p};if("function"==typeof classifyResult)try{h=classifyResult(c)}catch{}return/ошибк|forbidden|нет прав|устаревш/i.test((p||h.msg||"").toLowerCase())?{status:"forbidden",serverMessage:p||h.msg||"Нет прав/ошибка сохранения",httpStatus:l.status,url:n}:{status:"error",serverMessage:p||"Ошибка сохранения",httpStatus:l.status,url:n}}async function FMVeditTextareaOnly(e,t){return FMVeditPersonalPage(e,{content:t})}function isProfileFieldsPage(){try{const e=new URL(location.href);return/\/profile\.php$/i.test(e.pathname)&&"fields"===e.searchParams.get("section")&&/^\d+$/.test(e.searchParams.get("id")||"")}catch{return!1}}function getProfileId(){return new URL(location.href).searchParams.get("id")||""}async function fetchDocSmart(e){if(window.FMV?.fetchDoc)return await FMV.fetchDoc(e);if("function"==typeof window.fetchHtml){const t=await window.fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),n=await t.text();return(new DOMParser).parseFromString(n,"text/html")}function findMainPointerId(e){const t=e.querySelector("#pun-main .container")||e.querySelector(".pun-main .container");if(!t)return null;const n=e.createTreeWalker(t,NodeFilter.SHOW_COMMENT);for(let e=n.nextNode();e;e=n.nextNode()){const t=/main:\s*usr(\d+)_skin/i.exec(e.nodeValue||"");if(t)return t[1]}return null}function pickItemsHTML(e,t){return Array.from(e.querySelectorAll(t)).map(e=>(e.innerHTML||"").trim()).filter(Boolean)}async function collectSkinSets(){if(!isProfileFieldsPage())return{icons:[],plashki:[],backs:[]};const e=getProfileId(),t=await fetchDocSmart(`/pages/usr${e}_skin`);if(!t)return{icons:[],plashki:[],backs:[]};const n=findMainPointerId(t);if(!n)return{icons:pickItemsHTML(t,"#pun-main ._icon .item, .pun-main ._icon .item"),plashki:pickItemsHTML(t,"#pun-main ._plashka .item, .pun-main ._plashka .item"),backs:pickItemsHTML(t,"#pun-main ._background .item, .pun-main ._background .item")};const r=await fetchDocSmart(`/pages/usr${n}_skin`);if(!r)return{icons:[],plashki:[],backs:[]};return findMainPointerId(r)?(console.log("Найден цикл"),{icons:[],plashki:[],backs:[]}):{icons:pickItemsHTML(r,"#pun-main ._icon .item, .pun-main ._icon .item"),plashki:pickItemsHTML(r,"#pun-main ._plashka .item, .pun-main ._plashka .item"),backs:pickItemsHTML(r,"#pun-main ._background .item, .pun-main ._background .item")}}(()=>{const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});(async()=>{try{await e;Number(document.body?.dataset?.groupId||NaN);const t=window.GroupID?Number(window.GroupID):null,n=[...window.PROFILE_CHECK?.GroupID||[],...window.CHRONO_CHECK?.GroupID||[]],r=[...window.PROFILE_CHECK?.ForumID||[],...window.CHRONO_CHECK?.ForumID||[],...window.CHRONO_CHECK?.AmsForumID||[]],o=n.includes(t),i=document.querySelector(".container.crumbs"),a=i&&Array.from(i.querySelectorAll("a[href]")).some(e=>{try{const t=new URL(e.getAttribute("href"),location.href),n=t.searchParams.get("id"),o=!!n&&r.includes(Number(n));return t.pathname.endsWith("/viewforum.php")&&o}catch{return!1}});if(!o||!a)return;let s=document.querySelectorAll(".topicpost .post-body .post-box .post-content");if(!s.length)try{await FMV.waitForSelector(".topicpost .post-body .post-box .post-content",5e3),s=document.querySelectorAll(".topicpost .post-body .post-box .post-content")}catch{return}const l=s[s.length-1];if(!l||l.querySelector(".ams_info"))return;const c=document.createElement("div");c.className="ams_info",c.textContent="",l.appendChild(document.createElement("br")),l.appendChild(c),window.__ams_ready=!0,window.dispatchEvent(new CustomEvent("ams:ready",{detail:{node:c}})),"function"==typeof window.__amsReadyResolve&&window.__amsReadyResolve(c)}catch(e){console.log("[AMS injector] error:",e)}})()})(),(()=>{"use strict";const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});window.createForumButton=async function(t){const{allowedGroups:n=[],allowedForums:r=[],label:o="Действие",onClick:i,containerSelector:a=".ams_info",order:s=0,showStatus:l=!0,showDetails:c=!0,showLink:d=!0,topicId:u=null}=t||{};if("function"!=typeof i)return;await async function(){await e,window.__ams_ready||await new Promise(e=>window.addEventListener("ams:ready",e,{once:!0}))}();const p="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(!Array.isArray(n)||0===n.length)return;if(!n.map(Number).includes(Number(p)))return;if(!Array.isArray(r)||0===r.length)return;if(!function(e){const t=(e||[]).map(String),n=document.querySelector(".container.crumbs"),r=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const n=new URL(e.getAttribute("href"),location.href);if(!n.pathname.includes("viewforum.php"))return!1;const r=(n.searchParams.get("id")||"").trim();return r&&t.includes(r)}catch{return!1}});if(n&&r(n))return!0;if(r(document))return!0;const o=document.body?.dataset?.forumId;return!(!o||!t.includes(String(o)))}(r))return;if(!function(e){if(null==e)return!0;const t=String(e).trim();if(!t)return!1;try{const e=new URL(location.href);return!!e.pathname.includes("viewtopic.php")&&(e.searchParams.get("id")||"").trim()===t}catch{return!1}}(u))return;const m=await FMV.waitForSelector(a,5e3).catch(()=>null);if(!m)return;const f=document.createElement("br"),h=document.createElement("div");h.dataset.order=s;const g=document.createElement("button");g.type="button",g.className="button",g.textContent=o;const y=l?document.createElement("span"):null;y&&(y.style.marginLeft="10px",y.style.fontSize="14px",y.style.color="#555");const w=d?document.createElement("a"):null;w&&(w.className="fmv-action-link",w.target="_blank",w.rel="noopener",w.style.marginLeft="10px",w.style.fontSize="14px",w.style.display="none");const v=c?document.createElement("details"):null;let b=null;if(v){v.style.marginTop="6px";const e=document.createElement("summary");e.textContent="Показать детали",e.style.cursor="pointer",b=document.createElement("pre"),b.style.whiteSpace="pre-wrap",b.style.margin="6px 0 0",b.style.fontSize="12px",v.appendChild(e),v.appendChild(b)}h.appendChild(g),y&&h.appendChild(y),w&&h.appendChild(w),v&&h.appendChild(v),m.appendChild(f);const S=Array.from(m.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>Number(s));S?m.insertBefore(h,S):m.appendChild(h);const x=(e,t="#555")=>{y&&(y.textContent=e,y.style.color=t)},C=(e="")=>{b&&(b.textContent=String(e||""))},k=(e,t="Открыть")=>{w&&(e?(w.href=e,w.textContent=t,w.style.display="inline"):(w.style.display="none",w.textContent="",w.removeAttribute("href")))};g.addEventListener("click",async()=>{l&&x("Выполняю…","#555"),c&&C(""),d&&k(null);try{await i({statusEl:y||null,linkEl:w||null,detailsEl:b||null,setStatus:x,setDetails:C,setLink:k,wrap:h})}catch(e){l&&x("✖ Ошибка","red"),c&&C(e&&e.message?e.message:String(e)),console.error("[createForumButton]",e)}})}})(),function(){async function e(e){if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(e),!0}catch(e){}return function(){try{return document.execCommand&&document.execCommand("copy")}catch(e){return!1}}()}let t=null;function n(){try{const e=window.getSelection&&window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges(),document.selection&&document.selection.empty&&document.selection.empty()}catch(e){}try{document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}catch(e){}const e=document.body,t=e.style.userSelect,n=e.style.webkitUserSelect;e.style.userSelect="none",e.style.webkitUserSelect="none",e.offsetHeight,e.style.userSelect=t,e.style.webkitUserSelect=n}function r(e){(function(e){return!!t&&!t.contains(e)})(e.target||e.srcElement)&&(t=null,n())}function o(n){!function(e){let t=e.querySelector(".legend");if(t||(t=document.createElement("strong"),t.className="legend",e.insertBefore(t,e.firstChild)),!t.dataset.copyReady){if(!t.querySelector(".code-copy")){let e=(t.textContent||"").trim();e&&!/^код:?\s*$/i.test(e)||(e="Скопировать код"),t.textContent="";const n=document.createElement("button");n.type="button",n.className="code-copy",n.textContent=e,t.appendChild(n)}t.dataset.copyReady="1"}}(n),n.__armed||(n.__armed=!0,n.addEventListener("click",async function(r){if(!(r.target.closest&&r.target.closest(".code-copy, .legend")||null))return;r.preventDefault(),r.stopPropagation();const o=n.querySelector("pre");o&&(!function(e){try{var t=document.createRange();t.selectNodeContents(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}catch(e){}}(o),function(e){t=e||null}(o),await e(function(e){return(e&&(e.innerText||e.textContent)||"").replace(/\s+$/,"")}(o)))},!0))}function i(e){var t,n;(t=".code-box",n=e,Array.prototype.slice.call((n||document).querySelectorAll(t))).forEach(o)}i(),document.addEventListener("pun_main_ready",function(){i()}),new MutationObserver(function(e){e.forEach(function(e){(e.addedNodes||[]).forEach(function(e){1===e.nodeType&&(e.matches&&e.matches(".code-box")&&o(e),e.querySelectorAll&&e.querySelectorAll(".code-box").forEach(o))})})}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("pointerdown",r,!0),document.addEventListener("mousedown",r,!0),document.addEventListener("click",r,!0),document.addEventListener("touchstart",r,!0),document.addEventListener("focusin",r,!0),document.addEventListener("scroll",function(){t&&(t=null,n())},!0),document.addEventListener("selectionchange",function(){if(!t)return;const e=window.getSelection&&window.getSelection();if(!e||!e.rangeCount||e.isCollapsed)return void(t=null);const r=e.anchorNode;r&&!t.contains(r)&&(t=null,n())},!0),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&(t=null,n())},!0),window.addEventListener("blur",function(){t&&(t=null,n())},!0)}(),function(){"use strict";if(window.skinAdmin&&"function"==typeof window.skinAdmin.load)return;const e="function"==typeof window.fetchHtml?window.fetchHtml:async e=>(await fetch(e,{credentials:"include"})).text(),t=e=>(new DOMParser).parseFromString(e,"text/html"),n=e=>String(e||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/&quot;/g,'"').replace(/>\s+</g,"><").replace(/[ \t\n]+/g," ").replace(/\s*=\s*/g,"=").trim();window.skinAdmin={load:async function(r){const o=e=>new URL(`/admin_pages.php?edit_page=usr${e}_skin`,location.origin).toString(),i=/<!--\s*main\s*:\s*usr\s*(\d+)\s*_skin\s*-->/i,a=/&lt;!--\s*main\s*:\s*usr\s*(\d+)\s*_skin\s*--&gt;/i,s=e=>{const t=e.querySelector('#page-content,[name="content"]');if(!t)return{id:null,value:""};const n=String(t.value||"");let r=n.match(i);return r?{id:r[1],value:n}:(r=(e=>{const t=document.createElement("textarea");return t.innerHTML=String(e||""),t.value})(n).match(i),r?{id:r[1],value:n}:(r=n.match(a),r?{id:r[1],value:n}:{id:null,value:n}))};let l=String(r),c=o(l),d=await e(c),u=t(d);if(/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(u.body?.textContent||""))return{status:"ошибка доступа к персональной странице"};let{id:p,value:m}=s(u);if(p){if(p===l)return{status:"ошибка: найден цикл main-страниц"};if(l=p,c=o(l),d=await e(c),u=t(d),/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(u.body?.textContent||""))return{status:"ошибка доступа к персональной странице"};const{id:n,value:r}=s(u);if(n)return{status:"ошибка: найден цикл main-страниц"};m=r}const f=u.querySelector('form[action*="admin_pages.php"]')||u.querySelector("form"),h=u.querySelector('#page-content,[name="content"]');if(!f||!h)return{status:"ошибка: не найдены форма или textarea"};async function g(r){try{const o=await e(c),i=t(o).querySelector('#page-content,[name="content"]');return i&&n(i.value)===n(r)}catch{return!1}}return{status:"ok",initialHtml:String(m??h.value??""),save:async function(n){const r=await e(c),o=t(r),i=o.querySelector('form[action*="admin_pages.php"]')||o.querySelector("form"),a=o.querySelector('#page-content,[name="content"]');if(!i||!a)return{ok:!1,status:"ошибка: не найдены форма/textarea при сохранении"};a.value=n;const s=new URL(i.getAttribute("action")||c,location.origin).toString(),l=[...i.elements].find(e=>"submit"===e.type&&("save"===e.name||/сохр|save/i.test(e.value||e.textContent||""))),d=l?.name||"save",u=l?.value||"1";if("function"==typeof window.serializeFormCP1251_SelectSubmit&&"function"==typeof window.fetchCP1251Text){const e=window.serializeFormCP1251_SelectSubmit(i,d),{res:t,text:r}=await window.fetchCP1251Text(s,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=windows-1251"},referrer:c,referrerPolicy:"strict-origin-when-cross-origin",body:e}),o=t.ok||t.redirected||/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(r)||await g(n);return{ok:o,status:o?"успешно":"ошибка сохранения"}}const p=new FormData(i);p.set(a.getAttribute("name")||"content",a.value),p.append(d,u);const m=await fetch(s,{method:"POST",credentials:"include",body:p,referrer:c,referrerPolicy:"strict-origin-when-cross-origin"}),f=await m.text(),h=m.ok||m.redirected||/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(f)||await g(n);return{ok:h,status:h?"успешно":"ошибка сохранения"}},targetUserId:l}}}}(),window.ChronoFilter={init:({root:e}={})=>function(e){const t=(t,n=e)=>n.querySelector(t),n=(t,n=e)=>Array.from(n.querySelectorAll(t)),r=e=>e?new Date(e):null,o=(e,t)=>Array.from(e?.querySelectorAll(`input[name="${t}"]:checked`)||[]).map(e=>e.value),i=t("#filters"),a=t("#list");if(!i||!a)return{apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}};const s=t("#dateStart"),l=t("#dateEnd"),c=t("#resetBtn"),d=t("#typeList"),u=t("#statusList"),p=t("#maskList"),m=t("#playerList"),f=t("#locationList");function h(e,n){const r=t(e);if(!r||!n)return()=>{};const o=e=>{e.stopPropagation(),n.style.display="block"===n.style.display?"none":"block"},i=e=>{n.contains(e.target)||r.contains(e.target)||(n.style.display="none")};return r.addEventListener("click",o),document.addEventListener("click",i),()=>{r.removeEventListener("click",o),document.removeEventListener("click",i)}}const g=h("#typeToggle",d),y=h("#statusToggle",u),w=h("#maskToggle",p),v=h("#playerToggle",m),b=h("#locationToggle",f),S=n("#list .episode").map(e=>{const t=(e.dataset.mask||"").split(";").map(e=>e.trim()).filter(Boolean),n=(e.dataset.players||"").split(";").map(e=>e.trim()).filter(Boolean);return{el:e,type:(e.dataset.type||"").trim(),status:(e.dataset.status||"").trim(),startL:r(e.dataset.startL),startR:r(e.dataset.startR),endL:r(e.dataset.endL),endR:r(e.dataset.endR),masks:t,players:n,location:(e.dataset.location||"").trim()}});function x(){const t=s?.value?new Date(s.value):null,n=l?.value?new Date(l.value):null,r=o(d,"type"),i=o(u,"status"),a=o(p,"mask"),c=o(m,"player"),h=o(f,"location"),g=[],y=[];return S.forEach(e=>{let o=!0;o&&t&&e.endL&&e.endL<t&&(o=!1),o&&n&&e.startR&&e.startR>n&&(o=!1),o&&r.length&&!r.includes(e.type)&&(o=!1),o&&i.length&&!i.includes(e.status)&&(o=!1),o&&a.length&&!e.masks.some(e=>a.includes(e))&&(o=!1),o&&c.length&&!e.players.some(e=>c.includes(e))&&(o=!1),o&&h.length&&!h.includes(e.location)&&(o=!1),e.el.style.display=o?"":"none",(o?g:y).push(e.el)}),e.dispatchEvent(new CustomEvent("chrono:filtered",{detail:{visible:g,hidden:y}})),g}function C(){return s&&(s.value=""),l&&(l.value=""),n('#filters .dropdown-list input[type="checkbox"]').forEach(e=>{e.checked=!1}),x()}function k(e){e.target.closest("#filters .dropdown-list")&&e.target.matches('input[type="checkbox"]')&&x()}return e.addEventListener("change",k),s?.addEventListener("change",x),l?.addEventListener("change",x),c?.addEventListener("click",e=>{e.preventDefault(),C()}),x(),{apply:x,reset:C,getVisible:()=>S.filter(e=>"none"!==e.el.style.display).map(e=>e.el),destroy:()=>{e.removeEventListener("change",k),s?.removeEventListener("change",x),l?.removeEventListener("change",x),c?.removeEventListener("click",C),g(),y(),w(),v(),b()}}}(e||document),apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}},function(){window.FMV||(window.FMV={});const e=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t=t=>e(t).replace(/"/g,"&quot;"),n=e=>Array.from(new Set((e||[]).filter(Boolean))),r=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"";FMV.utils={esc:e,escAttr:t,unique:n,capitalize:r};const o={personal:{label:"личный",emoji:"<иконка>"},plot:{label:"сюжетный",emoji:"<иконка>"},au:{label:"au",emoji:"<иконка>"}},i={on:{label:"активен",emoji:"<иконка>"},archived:{label:"неактуален",emoji:"<иконка>"},off:{label:"закрыт",emoji:"<иконка>"}},a=e=>String(e).padStart(2,"0"),s=(e,t)=>new Date(e,t,0).getDate(),l=(e,t,n)=>`${e}-${a(t)}-${a(n)}`;function c(e){const t=String(e||"").trim();if(!t)return null;let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);return n?{y:+n[3],m:+n[2],d:+n[1],g:"day"}:(n=t.match(/^(\d{4})-(\d{2})-(\d{2})$/),n?{y:+n[1],m:+n[2],d:+n[3],g:"day"}:(n=t.match(/^(\d{1,2})\.(\d{4})$/),n?{y:+n[2],m:+n[1],d:1,g:"month"}:(n=t.match(/^(\d{4})$/),n?{y:+n[1],m:1,d:1,g:"year"}:null)))}FMV.buildChronoHtml=function(d,u={}){u.titlePrefix,e(d?.name||"");const p=Array.isArray(d?.episodes)?d.episodes:[],m=n(p.flatMap(e=>Array.isArray(e?.masks)?e.masks:[])),f=n(p.flatMap(e=>(Array.isArray(e?.participants)?e.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return t.length?t.join(", "):String(e?.name||"").trim()}).map(e=>e.replace(/;/g," ")).filter(Boolean))),h=n(p.map(e=>e?.location).filter(Boolean));let g=null,y=null;const w=p.map(e=>{const t=function(e,t){const n=c(e),r=t?c(t):null;if(!n&&!r)return{startL:"",startR:"",endL:"",endR:""};let o="",i="";n?"day"===n.g?(o=l(n.y,n.m,1),i=l(n.y,n.m,n.d)):"month"===n.g?(o=l(n.y,n.m,1),i=l(n.y,n.m,s(n.y,n.m))):(o=l(n.y,1,1),i=l(n.y,12,31)):r&&("day"===r.g?(o=l(r.y,r.m,1),i=l(r.y,r.m,r.d)):"month"===r.g?(o=l(r.y,r.m,1),i=l(r.y,r.m,s(r.y,r.m))):(o=l(r.y,1,1),i=l(r.y,12,31)));let a="",d="";return r?"day"===r.g?(a=l(r.y,r.m,r.d),d=l(r.y,r.m,s(r.y,r.m))):"month"===r.g?(a=l(r.y,r.m,1),d=l(r.y,r.m,s(r.y,r.m))):(a=l(r.y,1,1),d=l(r.y,12,31)):n&&("day"===n.g?(a=l(n.y,n.m,n.d),d=l(n.y,n.m,s(n.y,n.m))):"month"===n.g?(a=l(n.y,n.m,1),d=l(n.y,n.m,s(n.y,n.m))):(a=l(n.y,1,1),d=l(n.y,12,31))),{startL:o,startR:i,endL:a,endR:d}}(e?.dateStart,e?.dateEnd);return t.startL&&(!g||t.startL<g)&&(g=t.startL),t.endR&&(!y||t.endR>y)&&(y=t.endR),t}),v=Object.entries(o).map(([n,r])=>`<label><input type="checkbox" name="type" value="${t(n)}"> ${e(r.label)}</label>`).join(""),b=Object.entries(i).map(([n,r])=>`<label><input type="checkbox" name="status" value="${t(n)}"> ${e(r.label)}</label>`).join(""),S=n(m).map(n=>`<label><input type="checkbox" name="mask" value="${t(n)}"> ${e(n)}</label>`).join(""),x=f.map(n=>`<label><input type="checkbox" name="player" value="${t(n)}"> ${e(n)}</label>`).join(""),C=h.map(n=>`<label><input type="checkbox" name="location" value="${t(n)}"> ${e(n)}</label>`).join("");let k=`<div class="filters" id="filters">\n    <div class="f">\n      <label>Дата начала фильтра</label>\n      <input type="date" id="dateStart" value="${t(g||"")}">\n    </div>\n    <div class="f">\n      <label>Дата конца фильтра</label>\n      <input type="date" id="dateEnd" value="${t(y||"")}">\n    </div>\n    <div class="f">\n      <label>Тип</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="typeToggle">Выбрать тип</button>\n        <div class="dropdown-list" id="typeList">\n          ${v}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Статус</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="statusToggle">Выбрать статус</button>\n        <div class="dropdown-list" id="statusList">\n          ${b}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Маска</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="maskToggle">Выбрать маску</button>\n        <div class="dropdown-list" id="maskList">\n          ${S}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Участник</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="playerToggle">Выбрать участника</button>\n        <div class="dropdown-list" id="playerList">\n          ${x}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Локация</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="locationToggle">Выбрать локацию</button>\n        <div class="dropdown-list" id="locationList">\n          ${C}\n        </div>\n      </div>\n    </div>\n    <div class="actions">\n      <button class="button" id="resetBtn">Сбросить</button>\n    </div>\n  </div>\n  \n  <div class="list" id="list">\n    `;return p.length?(p.forEach((n,s)=>{const l=o[n?.type]||o.au,d=i[n?.status]||i.archived,u=n?.type||"",p=`${r(u)} ${l.emoji}`,m=n?.status||"",f=`${r(m)} ${d.emoji}`,h=Array.isArray(n?.masks)?n.masks.filter(Boolean):[],g=(Array.isArray(n?.participants)?n.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return(t.length?t.join(", "):String(e?.name||"").trim()).replace(/;/g," ")}).filter(Boolean),y=g.join(";"),v=(Array.isArray(n?.participants)?n.participants:[]).map(n=>{const r=Array.isArray(n?.masks)&&n.masks.length?n.masks.join(", "):String(n?.name||"").trim(),o=n?.id?String(n.id).trim():"";return o?`<a href="/profile.php?id=${t(o)}">${e(r)}</a>`:e(r)}).filter(Boolean).join(", "),b=n?.location||"",S=w[s],x=function(e,t){const n=c(e),r=c(t),o=e=>`${a(e.d)}.${a(e.m)}.${e.y}`,i=e=>`${a(e.m)}.${e.y}`,s=e=>`${e.y}`;if(!n&&!r)return"";if(n&&r&&("day"===n.g&&"day"===r.g&&n.y===r.y&&n.m===r.m&&n.d===r.d||"month"===n.g&&"month"===r.g&&n.y===r.y&&n.m===r.m||"year"===n.g&&"year"===r.g&&n.y===r.y)){if("day"===n.g)return o(n);if("month"===n.g)return i(n);if("year"===n.g)return s(n)}if(!n||!r)return"";const l={...n},d={...r},u=(e,t,n=1)=>{e.m="number"==typeof t?t:e.m??1,e.d=n,e.g="day"},p=(e,t)=>{e.m="number"==typeof t?t:e.m??1,e.d=1,e.g="month"};return"day"===l.g&&"month"===d.g&&u(d,d.m,1),"day"===d.g&&"month"===l.g&&u(l,l.m,1),"day"===l.g&&"year"===d.g&&u(d,1,1),"day"===d.g&&"year"===l.g&&u(l,1,1),"month"===l.g&&"year"===d.g&&p(d,l.m),"month"===d.g&&"year"===l.g&&p(l,d.m),"day"===l.g&&"day"===d.g?l.y===d.y&&l.m===d.m&&l.d===d.d?o(l):l.y===d.y&&l.m===d.m?`${a(l.d)}-${a(d.d)}.${a(l.m)}.${l.y}`:l.y===d.y&&l.m!==d.m?`${a(l.d)}.${a(l.m)}-${a(d.d)}.${a(d.m)}.${l.y}`:`${o(l)}-${o(d)}`:"month"===l.g&&"month"===d.g?l.y===d.y&&l.m===d.m?i(l):l.y===d.y&&l.m!==d.m?`${a(l.m)}-${a(d.m)}.${l.y}`:`${i(l)}-${i(d)}`:"year"===l.g&&"year"===d.g?l.y===d.y?s(l):`${s(l)}-${s(d)}`:"day"===l.g&&"month"===d.g?l.y===d.y&&l.m===d.m?o(l):l.y===d.y?`${a(l.d)}.${a(l.m)}-${a(d.m)}.${l.y}`:`${o(l)}-${i(d)}`:"month"===l.g&&"day"===d.g?l.y===d.y&&l.m===d.m?o(d):l.y===d.y?`${a(l.m)}.${l.y}-${a(d.d)}.${a(d.m)}.${d.y}`:`${i(l)}-${o(d)}`:"day"===l.g&&"year"===d.g?l.y===d.y?o(l):`${o(l)}-${s(d)}`:"year"===l.g&&"day"===d.g?l.y===d.y?o(d):`${s(l)}-${o(d)}`:"month"===l.g&&"year"===d.g?l.y===d.y?i(l):`${i(l)}-${s(d)}`:"year"===l.g&&"month"===d.g?l.y===d.y?i(d):`${s(l)}-${i(d)}`:""}(n?.dateStart,n?.dateEnd),C=x?`<span class="muted">${e(x)} — </span>`:"";k+=`\n  <div class="episode" \n       data-type="${t(u)}" \n       data-status="${t(m)}" \n       data-start-l="${t(S.startL)}" data-start-r="${t(S.startR)}" \n       data-end-l="${t(S.endL)}" data-end-r="${t(S.endR)}"\n       ${h.length?`data-mask="${t(h.join(";"))}"`:""}\n       ${b?`data-location="${t(b)}"`:""}\n       ${g.length?`data-players="${t(y)}"`:""}>\n    <div>тип: ${e(p)}; статус: ${e(f)}</div>\n    <div>${C}<span class="title"><a href="${e(n?.href||"#")}">${e(n?.title||"")}</a></span>\n      ${h.length?` [as ${e(h.join(", "))}]`:""}</div>\n    <div>локация: ${e(b)}</div>\n    <div>участники: ${v}</div>\n  </div>`}),k+='</div>\n<script type="text/javascript" src="https://odeshock.github.io/QuadroBoards-Automatizations/additional_functional/private_pages/chrono_filter.js"><\/script>',k):(k+='<div class="meta">Нет эпизодов</div></section>',k)}}(),function(){const e=/<!--\s*main:\s*usr(\d+)_skin\s*-->/i,t=".character[data-id]",n=".skin_info",r=".chrono_info";async function o(e){const t=await fetch(e,{credentials:"same-origin"});if(!t.ok)return null;const n=await t.arrayBuffer(),r=(t.headers.get("content-type")||"").match(/charset=([^;]+)/i),o=(r?r[1]:"windows-1251").toLowerCase();try{return new TextDecoder(o).decode(n)}catch{return new TextDecoder("utf-8").decode(n)}}function i(e){if(!e||e.includes("Ссылка, по которой Вы пришли, неверная или устаревшая."))return null;return(new DOMParser).parseFromString(e,"text/html").querySelector("#pun-main .container")}function a(e,t){e&&t&&(e.innerHTML="",e.appendChild(t.cloneNode(!0)))}function s(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function l(t,r){const s=r.querySelector(n);if(!s)return;const l=await o(`/pages/usr${t}_skin`);if(!l)return;const c=e.exec(l);if(c){const t=c[1],n=await o(`/pages/usr${t}_skin`);if(!n||e.test(n))return;return void a(s,i(n))}a(s,i(l))}async function c(e,t){const n=t.querySelector(r);if(!n)return;a(n,i(await o(`/pages/usr${e}_chrono`)))}async function d(e){if(!e)return;const o=e.querySelector(t)||document.querySelector(t);if(!o)return;const i=s(o);!function(e){const o=e.querySelector(t);if(!o)return;const i=e.querySelector(n),a=e.querySelector(r);i&&i.parentElement!==o&&o.appendChild(i),a&&a.parentElement!==o&&o.appendChild(a)}(i);const a=o.getAttribute("data-id")?.trim();a&&await Promise.all([l(a,i),c(a,i)])}window.loadUserSections=function({root:e,rootSelector:t}={}){d(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>d(document));const u=new WeakSet;new MutationObserver(e=>{e.forEach(e=>{e.addedNodes&&e.addedNodes.forEach(e=>{e instanceof Element&&(e.matches&&e.matches(t)&&!u.has(e)&&(u.add(e),d(s(e))),e.querySelectorAll&&e.querySelectorAll(t).forEach(e=>{u.has(e)||(u.add(e),d(s(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0})}(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Создать страницу",order:1,async onClick({setStatus:e,setDetails:t,setLink:n}){const r=document.querySelector("#pun-main h1 span"),o=r?r.textContent.trim().toLowerCase():"";if(!o)return e("✖ нет имени темы","red"),void t("Ожидался #pun-main h1 span");let i=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!i)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),i=document.querySelector('a[href*="profile.php?id="]')}catch{}const a=i?.href?.match(/profile\.php\?id=(\d+)/i);if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=`usr${a[1]}`,l=window.PROFILE_CHECK?.PPageTemplate,c=window.PROFILE_CHECK?.PPageGroupID;if("function"!=typeof window.FMVcreatePersonalPage)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVcreatePersonalPage(arg1, arg2, arg3, arg4, arg5, arg6)");e("Создаём…","#555"),t(""),n(null);try{const r=await window.FMVcreatePersonalPage(o,s,l,"",c,"0");switch(r?.status){case"created":e("✔ создано","green");break;case"exists":e("ℹ уже существует","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}r?.url&&n(r.url,"Открыть страницу");const i=[];r?.serverMessage&&i.push("Сообщение сервера: "+r.serverMessage),r?.httpStatus&&i.push("HTTP: "+r.httpStatus),r?.title&&i.push("Пользователь: "+r.title),r?.name&&i.push("Адресное имя: "+r.name),r?.details&&i.push("Details: "+r.details),t(i.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n?.message||String(n)),console.error("[button_personal_page]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Сменить группу",order:4,async onClick({setStatus:e,setDetails:t}){const n=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupUserID||"",r=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupPlayerID||"";if(!n||!r){const o=[n?null:"PROFILE_CHECK.GroupUserID",r?null:"PROFILE_CHECK.GroupPlayerID"].filter(Boolean).join(", ");return e("✖ Замена не выполнена","red"),void t("Не удалось запустить изменение группы: "+(o?`не заданы параметры ${o}. Укажите значения и повторите.`:"отсутствуют необходимые параметры."))}let o=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!o)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),o=document.querySelector('a[href*="profile.php?id="]')}catch{}const i=o?.href?.match(/profile\.php\?id=(\d+)/i),a=i?i[1]:"";if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=... из страницы темы");if("function"!=typeof window.FMVupdateGroupIfEquals)return e("✖ функция недоступна","red"),void t("Ожидалась window.FMVupdateGroupIfEquals(userId, fromId, toId)");e("Проверяю и обновляю…","#555"),t("");try{const o=await window.FMVupdateGroupIfEquals(a,n,r);let i="";if(o?.details){const e=String(o.details).match(/current=([^\s]+)/);e&&(i=e[1])}switch(o?.status){case"updated":e("✔ Группа изменена","green");break;case"nochange":e("ℹ Изменений нет — пользователь уже в целевой группе","#555");break;case"skipped":return e("✖ Исходная группа не совпадает","red"),void t(`Исходное значение группы — ${i||"не определено"}.\nЛибо вы пытаетесь поправить не тот профиль, либо выполните замену вручную для дополнительной валидации.`);case"uncertain":e("❔ Не удалось подтвердить результат","#b80");break;default:e("✖ Ошибка при сохранении","red")}const s=[];o?.serverMessage&&s.push("Сообщение сервера: "+o.serverMessage),o?.httpStatus&&s.push("HTTP: "+o.httpStatus),s.push("Пользователь: "+(o?.userId??a)),s.push(`Замена: ${n} → ${r}`),i&&s.push("Текущее (до попытки): "+i),o?.details&&!i&&s.push("Details: "+o.details),t(s.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ Сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_group]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Выдать монетки",order:3,async onClick({setStatus:e,setDetails:t}){let n=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!n)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),n=document.querySelector('a[href*="profile.php?id="]')}catch{}const r=n?.href?.match(/profile\.php\?id=(\d+)/i);if(!r)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const o=r[1],i=window.PROFILE_CHECK?.MoneyFieldID,a=window.PROFILE_CHECK?.MoneyFieldTemplate,s=String(a);if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция обновления не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляем…","#555"),t("");try{const n=await window.FMVreplaceFieldData(o,i,s);switch(n?.status){case"updated":e("✔ обновлено","green");break;case"nochange":e("ℹ изменений нет","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}const r=[];n?.serverMessage&&r.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&r.push("HTTP: "+n.httpStatus),r.push("Поле: "+(n?.fieldId??i)),r.push("Пользователь: "+(n?.userId??o)),r.push("Значение: "+s),n?.details&&r.push("Details: "+n.details),t(r.join("\n"))}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_money_field]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Установить плашку",order:2,async onClick({setStatus:e,setDetails:t}){const n=document.querySelector("#pun-main h1 span");if(!(n?n.textContent.trim().toLowerCase():""))return e("✖ не найдено имя темы (arg1)","red"),void t("Ожидался #pun-main h1 span");let r=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!r)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),r=document.querySelector('a[href*="profile.php?id="]')}catch{}const o=r?.href?.match(/profile\.php\?id=(\d+)/i),i=o?o[1]:"",a=i?`usr${i}`:"";if(!i)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=window.PROFILE_CHECK?.PPageFieldID,l=window.PROFILE_CHECK?.PPageFieldTemplate,c=String(l).replace(/\bID\b/g,a);if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляю…","#555"),t("");try{const n=await window.FMVreplaceFieldData(i,s,c);switch(n?.status){case"updated":e("✔ обновлено","green");break;case"nochange":e("ℹ изменений нет","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ неизвестный результат","#b80")}const r=[];n?.serverMessage&&r.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&r.push("HTTP: "+n.httpStatus),r.push("Поле: "+(n?.fieldId??s)),r.push("Пользователь: "+(n?.userId??i)),r.push("Значение (template→arg2): "+c),n?.details&&r.push("Details: "+n.details),t(r.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_personal_field]",n)}}})})(),function(){"use strict";const e=(e,t=document)=>t.querySelector(e),t=async e=>((e,t=document)=>new Promise(n=>{const r=t.querySelector(e);if(r)return n(r);const o=new MutationObserver(()=>{const r=t.querySelector(e);r&&(o.disconnect(),n(r))});o.observe(document.documentElement,{childList:!0,subtree:!0})}))(e),n='\n  details.ufo-panel{margin-top:12px;border:1px solid #d0d0d7;border-radius:10px;background:#fff}\n  details.ufo-panel>summary{cursor:pointer;list-style:none;padding:10px 14px;font-weight:600;background:#f6f6f8;border-bottom:1px solid #e6e6ef;border-radius:10px}\n  details.ufo-panel>summary::-webkit-details-marker{display:none}\n  .ufo-wrap{display:flex;flex-direction:column;gap:16px;padding:14px}\n  .ufo-col{display:flex;flex-direction:column;gap:8px}\n  .ufo-col h4{margin:0;font-size:14px;opacity:.8;display:flex;justify-content:space-between;align-items:center}\n  .ufo-search{padding:6px 10px;font-size:13px;border:1px solid #d0d0d7;border-radius:8px;background:#f5f2e8}\n  .ufo-lib,.ufo-selected{border:1px dashed #c9c9d9;border-radius:8px;background:#fafafd;padding:8px;overflow:auto}\n  .ufo-lib{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}\n  .ufo-lib .ufo-card{margin:0}\n  .ufo-card{display:grid;grid-template-columns:auto 1fr auto auto;grid-template-rows:auto auto;grid-template-areas:"id full date actions" "id title title actions";gap:8px;background:#fff;border:1px solid #e7e7ef;border-radius:8px;padding:8px;margin:6px 0;max-width:100%;position:relative;overflow:hidden}\n  .ufo-idtag{grid-area:id;font-size:11px;opacity:.7;align-self:start}\n  .ufo-actions{grid-area:actions;display:flex;align-items:center;gap:6px}\n  .ufo-btn{border:1px solid #d7d7e0;background:#f3f3f7;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;line-height:1.15;display:inline-flex;align-items:center}\n  .ufo-btn:hover{background:#ececf4}\n  .ufo-card.disabled{opacity:.4;pointer-events:none}\n  .ufo-full{grid-area:full;box-sizing:border-box;margin:0;padding:0;border:0;background:transparent;overflow:hidden}\n  .ufo-full .item{position:relative;margin:0}\n  .ufo-full .item .modal-link{display:block}\n  .ufo-full .item img{display:block;max-width:100%;height:auto;border-radius:6px}\n  .ufo-lib .ufo-full .item img{height:90px;width:100%;object-fit:cover}\n  .ufo-lib .ufo-full a{pointer-events:none}\n  .ufo-title-edit{grid-area:title;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;white-space:pre-wrap;overflow:visible}\n  .ufo-title-edit:focus{outline:none;background:#fffdf1}\n  .ufo-date-edit{grid-area:date;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;align-self:start}\n  .ufo-date-edit input{border:none;background:transparent;font-size:13px;width:100%;font-family:inherit}\n  .ufo-date-edit input:focus{outline:none}\n  ';!function(){const e=document.createElement("style");e.textContent=n,document.head.appendChild(e),"function"==typeof GM_addStyle&&GM_addStyle(n)}();const r=[],o=(e,t)=>{const n=document.createElement("button");return n.type="button",n.className="ufo-btn",n.textContent=e,n.addEventListener("click",t),n};function i(e){const t=e.querySelector(".ufo-card");if(!t)return void(e.style.maxHeight="");const n=getComputedStyle(t),r=t.getBoundingClientRect().height,o=parseFloat(n.marginTop)||0,i=parseFloat(n.marginBottom)||0,a=getComputedStyle(e),s=parseFloat(a.paddingTop)||0,l=parseFloat(a.paddingBottom)||0,c=Math.round(2*r+3*(o+i)+s+l);e.style.maxHeight=c+"px"}function a(e){const t=function(e){return[...e.querySelectorAll(".ufo-card")].find(e=>"none"!==getComputedStyle(e).display)||null}(e);if(!t)return void(e.style.maxHeight="");const n=t.getBoundingClientRect().height,r=getComputedStyle(e),o=parseFloat(r.rowGap)||0,i=parseFloat(r.paddingTop)||0,a=parseFloat(r.paddingBottom)||0,s=Math.round(2*n+o+i+a);e.style.maxHeight=s+"px"}const s=e=>String(e).replace(/--/g,"—");function l(e,t,n,r){const{targetClass:o,itemSelector:i=".item",idAttr:a="data-id"}=t,l=new Set((t.library||[]).map(e=>String(e.id))),c=document.createElement("div");c.innerHTML=e;const d=c.querySelector("div."+o);if(d){const e=[];d.childNodes.forEach(t=>e.push((e=>{if(1===e.nodeType){const t=e;if(t.matches(i)){let e=t.getAttribute(a);return null==e&&(e="undefined"),l.has(String(e))?"":`\x3c!-- preserved (${a}="${s(e)}")\n${s(t.outerHTML)}\n--\x3e`}return`\x3c!-- preserved (${a}="undefined")\n${s(t.outerHTML)}\n--\x3e`}if(8===e.nodeType)return`\x3c!--${s(e.nodeValue)}--\x3e`;if(3===e.nodeType){const t=e.nodeValue;return""===t.trim()?"":`\x3c!-- preserved (${a}="undefined")\n${s(t)}\n--\x3e`}return""})(t))),d.innerHTML=(n?n+"\n":"")+e.filter(Boolean).join("\n")}else{const e=document.createElement("div");e.className=o,e.innerHTML=n,c.appendChild(e)}return c.innerHTML}function c(t){if(c._installed)return;c._installed=!0;const n=e("#editpage")||e('form[action*="admin_pages.php"]');n&&n.addEventListener("submit",()=>{const n=e(t)||e("#page-content"),o=window.tinymce&&window.tinymce.get&&window.tinymce.get(n?.id||"page-content")||null;let i="";o?i=o.getContent():n&&(i=n.value||"");for(const e of r){const t=e.getSelectedInner();e.getSelectedIds();i=l(i,e.opts,t)}o&&o.setContent(i),n&&(n.value=i)},!0)}window.createChoicePanel=function(n){const s=Object.assign({title:"Библиотека и выбранные",targetClass:"_section",library:[],startOpen:!1,textareaSelector:"#page-content",anchorSelector:null,itemSelector:".item",idAttr:"data-id",editableAttr:"title",searchPlaceholder:"поиск по id",mountEl:null,initialHtml:null,external:!1,allowMultiAdd:!1,expirableAttr:null},n||{});Array.isArray(s.library)||(s.library=[]);const d="ufo_"+(s.targetClass||"section").replace(/\W+/g,"_")+"_"+Math.random().toString(36).slice(2,7),u=document.createElement("details");u.className="ufo-panel",u.open=!!s.startOpen;const p=document.createElement("summary");p.textContent=s.title||"Панель";const m=document.createElement("div");m.className="ufo-wrap";const f=document.createElement("div");f.className="ufo-col";const h=document.createElement("h4");h.textContent="Библиотека";const g=document.createElement("input");g.type="text",g.placeholder=s.searchPlaceholder||"поиск по id",g.className="ufo-search",h.appendChild(g);const y=document.createElement("div");y.className="ufo-lib",y.id=d+"-lib",f.append(h,y);const w=document.createElement("div");w.className="ufo-col",w.innerHTML="<h4>Выбранные (сверху — новее)</h4>";const v=document.createElement("div");function b(e,t){t=t||{};const n=y.querySelector(`.ufo-card[data-id="${e.id}"]`);if(!s.allowMultiAdd&&(n&&n.classList.add("disabled"),v.querySelector(`.ufo-card[data-id="${e.id}"]`)))return;const r=document.createElement("div");r.className="ufo-card",r.draggable=!0,r.dataset.id=e.id;const a=document.createElement("div");a.className="ufo-idtag",a.textContent="#"+e.id;const l=document.createElement("div");l.className="ufo-full";const c=document.createElement("div");c.innerHTML=(t.usePageHtml?t.usePageHtml:e.html).trim(),l.appendChild(c.firstElementChild);const d=document.createElement("div");d.className="ufo-title-edit",d.contentEditable=!0;const u=l.querySelector(s.itemSelector),p=u&&u.getAttribute(s.editableAttr)||"";d.textContent=p;let m=null;if(s.expirableAttr){m=document.createElement("div"),m.className="ufo-date-edit";const e=document.createElement("input");e.type="date";const t=u&&u.getAttribute(s.expirableAttr)||"";e.value=t,m.appendChild(e)}const f=document.createElement("div");f.className="ufo-actions";const h=()=>i(v),g=o("↑",e=>{e.preventDefault(),e.stopPropagation(),r.previousElementSibling&&r.parentElement.insertBefore(r,r.previousElementSibling),h()}),w=o("↓",e=>{e.preventDefault(),e.stopPropagation(),r.nextElementSibling&&r.parentElement.insertBefore(r.nextElementSibling,r),h()}),b=o("✕",e=>{e.preventDefault(),e.stopPropagation(),r.remove(),!s.allowMultiAdd&&n&&n.classList.remove("disabled"),h()});f.append(g,w,b),r.dataset.html=e.html.trim(),t.usePageHtml&&(r.dataset.pageHtml=t.usePageHtml.trim()),t.usePageHtml&&(r.dataset.pageHtml=t.usePageHtml.trim()),r.append(a,l,f,d),m&&r.appendChild(m),v.insertBefore(r,v.firstChild),h()}function S(){return new Set([...v.querySelectorAll(".ufo-card")].map(e=>e.dataset.id||"").filter(Boolean))}function x(){return[...v.querySelectorAll(".ufo-card")].map(e=>function(e,t,n={}){if(!e||"function"!=typeof e.querySelector)return String(t||"");const r=n.editableAttr||"title",o=e.dataset.pageHtml||e.dataset.html||String(t||""),i=e.querySelector(".ufo-title-edit"),a=String(i?i.innerHTML:"").replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;|[\u00A0\u200B-\u200D\u2060\uFEFF]/g,"").replace(/\s+/g," ").trim(),s=document.createElement("div");s.innerHTML=o.trim();const l=s.querySelector(n&&n.itemSelector||".item");if(l&&(a&&l.setAttribute(r,a),n.expirableAttr)){const t=e.querySelector(".ufo-date-edit input");if(t){const e=(t.value||"").trim(),r=l.querySelector(".coupon_deadline");r&&r.remove();const o=l.querySelector("img"),i=document.createElement("span");if(i.className="coupon_deadline",e){const t=e.split("-");if(3===t.length){const e=t[0].slice(2),n=t[1],r=t[2];i.textContent=`${r}/${n}/${e}`}l.setAttribute(n.expirableAttr,e)}else i.textContent="",l.removeAttribute(n.expirableAttr);o&&o.nextSibling?l.insertBefore(i,o.nextSibling):o?o.parentNode.appendChild(i):l.appendChild(i)}}const c=e.querySelector(".ufo-text-edit");if(c&&l){const e=c.innerHTML||c.textContent||"",t=String(e).replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;|[\u00A0\u200B-\u200D\u2060\uFEFF]/g,"").replace(/\s+$/g,"").trim(),n=l.querySelector("wrds");t&&n&&(n.textContent=t)}return s.innerHTML}(e,e.dataset.html||"",{editableAttr:s.editableAttr,expirableAttr:s.expirableAttr,itemSelector:s.itemSelector})).join("\n")}return v.className="ufo-selected",v.id=d+"-selected",w.appendChild(v),m.append(f,w),u.append(p,m),(async()=>{if(s.mountEl)s.mountEl.appendChild(u);else{await t(s.textareaSelector);const n=s.anchorSelector?e(s.anchorSelector):e(s.textareaSelector);n&&n.insertAdjacentElement("afterend",u)}})(),s.library.forEach(e=>y.appendChild(function(e){const t=document.createElement("div");t.className="ufo-card",t.dataset.id=e.id;const n=document.createElement("div");n.className="ufo-idtag",n.textContent="#"+e.id;const r=document.createElement("div");r.className="ufo-full";const i=document.createElement("div");i.innerHTML=e.html.trim(),r.appendChild(i.firstElementChild);const a=document.createElement("div");return a.className="ufo-actions",a.appendChild(o("Добавить ↑",t=>{t.preventDefault(),t.stopPropagation(),b(e)})),t.append(n,r,a),t}(e))),function(e){let t=null;e.addEventListener("dragstart",e=>{const n=e.target.closest(".ufo-card");n&&(t=n,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""))}),e.addEventListener("dragover",e=>{e.preventDefault();const n=e.target.closest(".ufo-card");if(!n||n===t)return;const r=n.getBoundingClientRect(),o=(e.clientY-r.top)/r.height<.5;n.parentElement.insertBefore(t,o?n:n.nextSibling)}),e.addEventListener("drop",n=>{n.preventDefault(),t=null,i(e)}),e.addEventListener("dragend",()=>{t=null,i(e)})}(v),g.addEventListener("input",()=>{const e=g.value.trim();y.querySelectorAll(".ufo-card").forEach(t=>{t.style.display=!e||t.dataset.id.includes(e)?"":"none"}),a(y)}),new MutationObserver(()=>i(v)).observe(v,{childList:!0,subtree:!0,attributes:!0}),new MutationObserver(()=>a(y)).observe(y,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),window.addEventListener("resize",()=>{a(y),i(v)}),a(y),i(v),function(){let t="";if("string"==typeof s.initialHtml)t=s.initialHtml;else{const n=e(s.textareaSelector),r=window.tinymce&&window.tinymce.get&&window.tinymce.get(n?.id||"page-content")||null;r?t=r.getContent():n&&(t=n.value||"")}if(!t)return;const n=document.createElement("div");n.innerHTML=t;const r=n.querySelector("div."+s.targetClass);if(!r)return;const o=new Set(s.library.map(e=>e.id)),i=[];r.childNodes.forEach(e=>{if(1===e.nodeType&&e.matches(s.itemSelector)){const t=e.getAttribute(s.idAttr)||"";t&&o.has(t)&&i.push({id:t,pageHtml:e.outerHTML,lib:s.library.find(e=>e.id===t)})}});for(let e=i.length-1;e>=0;e--){const t=i[e];b({id:t.id,html:t.lib.html},{usePageHtml:t.pageHtml});const n=y.querySelector(`.ufo-card[data-id="${t.id}"]`);!s.allowMultiAdd&&n&&n.classList.add("disabled")}}(),r.push({uid:d,opts:s,rootEl:u,selectedBox:v,libBox:y,getSelectedInner:x,getSelectedIds:S}),s.external||c(s.textareaSelector),{details:u,builder:function(t){let n="";if("string"==typeof t)n=t;else if("string"==typeof s.initialHtml)n=s.initialHtml;else{const t=e(s.textareaSelector),r=window.tinymce&&window.tinymce.get&&window.tinymce.get(t?.id||"page-content")||null;r?n=r.getContent():t&&(n=t.value||"")}const r=x();return S(),l(n,s,r)},getSelectedIds:S}}}(),
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */
function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,n=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),r=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${n(e)}, .${n(e)}`,i=new TextDecoder("utf-8");let a;async function s(e){const t=await fetch(e,{credentials:"same-origin"}),n=await t.arrayBuffer();let r=i.decode(n);if(/charset\s*=\s*windows-1251/i.test(r)||r.includes("�"))try{r=(a||=new TextDecoder("windows-1251")).decode(n)}catch{}return r}function l(e,t){const n=e.querySelector(o(t)),r=n?.querySelector("strong, b");let i=r?.textContent?.trim();if(!i){const e=(n?.textContent||"").trim();i=e.split(":").slice(-1)[0]?.trim()}return(i||"").replace(/\u00A0/g," ").trim()}const c=new Map;function d(e,t){if(c.has(e))return c.get(e);const n=(async()=>{const n=await s(`/profile.php?id=${encodeURIComponent(e)}`);return l((new DOMParser).parseFromString(n,"text/html"),t)})();return c.set(e,n),n}function u(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const n=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=n.nextNode();){const t=(e.nodeValue||"").match(r);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:n})=>{d(n,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+n,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:n}={}){const i=`pa-fld${String(n??e).replace(/\D/g,"")||e}`,a=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(r);if(t)return t[1]}return null}(t.querySelector(o(i)));if(a)try{return await d(a,i)}catch(e){console.warn("[main-field] remote error:",e)}return l(t,i)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()}(),function(){"use strict";if(window.__profileRunnerMounted)return;window.__profileRunnerMounted=!0;const e=(e,t=document)=>t.querySelector(e);function t(e){return String(e||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/&quot;/g,'"').replace(/>\s+</g,"><").replace(/[ \t\n]+/g," ").replace(/\s*=\s*/g,"=").trim()}async function n(){await new Promise(e=>{if("complete"===document.readyState||"interactive"===document.readyState)return e();document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})});const t=e("#viewprofile .container")||e("#viewprofile")||e("#pun-main")||document.body,n=document.createElement("div");return n.id="fmv-skins-panel",n.style.margin="16px 0",n.innerHTML='\n       <details open style="border:1px solid #d6d6de;border-radius:10px;background:#fff">\n        <summary style="list-style:none;padding:10px 14px;border-bottom:1px solid #e8e8ef;border-radius:10px;font-weight:600;background:#f6f7fb;cursor:pointer">\n          Обновление скинов\n        </summary>\n        <div class="fmv-skins-body" style="padding:14px"></div>\n        <div class="fmv-skins-footer" style="display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid #eee">\n          <button type="button" class="fmv-save"\n            style="background:#2f67ff;color:#fff;border:1px solid #2f67ff;border-radius:8px;padding:8px 14px;cursor:pointer">\n            Сохранить\n          </button>\n          <span class="fmv-status" style="margin-left:8px;font-size:14px;color:#666"></span>\n        </div>\n      </details>\n    ',t.appendChild(n),n.querySelector(".fmv-skins-body")}(async()=>{if("/profile.php"!==location.pathname)return;const e=new URLSearchParams(location.search);if(!e.has("id")||[...e.keys()].some(e=>"id"!==e))return;const r=(e.get("id")||"").trim();if(!r)return;const o=window.SKIN?.GroupID||[];if("function"!=typeof window.ensureAllowed)return;if(!await window.ensureAllowed(o))return;if(!window.skinAdmin||"function"!=typeof window.skinAdmin.load)return void console.error("[profile_runner] skinAdmin.load не найден.");const{status:i,initialHtml:a,save:s,targetUserId:l}=await window.skinAdmin.load(r);if("ok"!==i&&"ок"!==i)return void console.error("[profile_runner] Не удалось загрузить страницу со скинами");const c=await n();let d=null;if("function"==typeof window.setupSkins)try{const e=await window.setupSkins(c,a);e&&"function"==typeof e.build&&(d=e.build)}catch(e){console.error("setupSkins() error:",e)}if(!d)return void console.error("[profile_runner] Не удалось инициализировать панели");const u=document.getElementById("fmv-skins-panel"),p=u?.querySelector(".fmv-save"),m=u?.querySelector(".fmv-status");if(!p)return;const f=`usr${l||r}_skin`;p.addEventListener("click",async()=>{try{m&&(m.textContent="Сохраняю…",m.style.color="#666");const e=d?d():"";if(!e)return void(m&&(m.textContent="Нечего сохранять",m.style.color="#c24141"));let n=null;if("function"==typeof window.FMVeditTextareaOnly)n=await window.FMVeditTextareaOnly(f,e);else{if("function"!=typeof s)return void(m&&(m.textContent="Нет функции сохранения",m.style.color="#c24141"));n=await s(e)}let o=!(!n||!n.ok&&"saved"!==n.status&&"успешно"!==n.status&&"ok"!==n.status);if(!o&&window.skinAdmin&&"function"==typeof window.skinAdmin.load)try{const n=await window.skinAdmin.load(r);!n||"ok"!==n.status&&"ок"!==n.status||(o=t(n.initialHtml)===t(e))}catch(e){console.warn("[profile_runner] verify failed:",e)}m&&(o?(m.textContent="✓ Успешно сохранено",m.style.color="#16a34a",setTimeout(()=>location.reload(),1e3)):(m.textContent="Ошибка сохранения",m.style.color="#c24141"))}catch(e){console.error(e),m&&(m.textContent="Ошибка сохранения",m.style.color="#c24141")}})})()}();const IP_ROWS=1,IP_GAP=8,IP_REQUIRED=!0;function isProfileFieldsPage(){try{const e=new URL(location.href);if(!/\/profile\.php$/i.test(e.pathname))return!1;const t=e.searchParams;if("fields"!==t.get("section"))return!1;const n=t.get("id");return!!n&&/^\d+$/.test(n)}catch{return!1}}const STYLE_ID="ip-style-clean";function injectStylesOnce(){if(document.getElementById(STYLE_ID))return;const e=document.createElement("style");e.id=STYLE_ID,e.textContent="\n    /* скрываем исходный textarea/input */\n    .ip-hidden {\n      display: none !important;\n      resize: none !important;\n      visibility: hidden !important;\n    }\n\n    /* Белый контейнер подстраивается под ширину контента */\n    .ip-box {\n      position: relative;\n      display: inline-block;          /* ширина = контенту */\n      max-width: 100%;\n      border: 1px solid #ccc;\n      border-radius: 10px;\n      background: #fff;\n      padding: 6px;\n    }\n\n    /* Вертикальный скролл */\n    .ip-scroll {\n      overflow-y: auto;\n      overflow-x: hidden;\n      -webkit-overflow-scrolling: touch;\n      max-height: calc(var(--ip-rows,1) * var(--ip-h,44px)\n                      + (var(--ip-rows,1) - 1) * var(--ip-gap,8px));\n    }\n\n    /* Сетка: перенос вниз, ширина по контенту */\n    .ip-grid {\n      display: flex;\n      flex-wrap: wrap;\n      gap: var(--ip-gap,8px);\n      align-content: flex-start;\n      justify-content: flex-start;\n    }\n\n    .ip-btn {\n      position: relative;\n      overflow: hidden;\n      width: var(--ip-w,44px);\n      height: var(--ip-h,44px);\n      border: 2px solid #d0d0d0;\n      border-radius: 10px;\n      background: #fff;\n      padding: 0;\n      cursor: pointer;\n      touch-action: manipulation;\n    }\n    .ip-btn[selected] {\n      border-color: #0b74ff;\n      box-shadow: 0 0 0 3px rgba(11,116,255,.15);\n    }\n\n    .ip-slot {\n      position: relative;\n      width: 100%;\n      height: 100%;\n    }\n    .ip-slot img {\n      width: 100%;\n      height: 100%;\n      display: block;\n      object-fit: cover;\n    }\n    .ip-slot * {\n      pointer-events: none;\n    }\n  ",document.head.appendChild(e)}function resolveFieldBySuffix(e){const t=`fld${String(e)}`,n=`form[fld${String(e)}]`;return document.querySelector(`#${CSS.escape(t)}[name="${n}"]`)||document.getElementById(t)||document.querySelector(`[name="${n}"]`)}function normalizeModalLinkAttrs(e){const t=document.createElement("template");return t.innerHTML=String(e??""),t.content.querySelectorAll("a.modal-link").forEach(e=>{Array.from(e.attributes).forEach(t=>{"class"!==t.name&&"style"!==t.name&&e.removeAttribute(t.name)})}),t.innerHTML.trim()}function prepareModalLinkAttrs(e){const t=document.createElement("template");t.innerHTML=String(e??"");const n=t.content.querySelectorAll("a.modal-link");if(n.length){const e=new URL(location.href).searchParams.get("id"),t=e&&/^\d+$/.test(e)?`usr${e}`:null;n.forEach(e=>{e.setAttribute("data-reveal-id","character"),t&&e.setAttribute("id",t)})}return t.innerHTML.trim()}function createThumbSlot(e){const t=document.createElement("div");t.className="ip-slot";const n=String(e??"").trim();if(!n)return t;const r=document.createElement("template");if(r.innerHTML=n,r.content.querySelector("*"))t.appendChild(r.content.cloneNode(!0));else{const e=document.createElement("img");e.src=n,e.alt="",e.loading="lazy",t.appendChild(e)}return t}function keyFor(e){const t=String(e??"");let n=5381;for(let e=0;e<t.length;e++)n=(n<<5)+n^t.charCodeAt(e);return"k"+(n>>>0).toString(36)}const FORM_STATE=new WeakMap;function applyImagePicker(e,t,n={}){if(!isProfileFieldsPage())return;injectStylesOnce();const r=!!n.modalLinkMode,o=(Array.isArray(e)?e:[]).map(e=>String(e??"")),i=resolveFieldBySuffix(t);if(!i)return;i.classList.add("ip-hidden");const a=Number.isFinite(n.btnWidth)?Math.max(1,n.btnWidth):44,s=Number.isFinite(n.btnHeight)?Math.max(1,n.btnHeight):44,l=Number.isFinite(n.gridColSize)?Math.max(1,n.gridColSize):a,c=o.map(e=>r?normalizeModalLinkAttrs(e):e),d=new Set(c),u=new Map(c.map(e=>[e,keyFor(e)])),p=r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");let m=null;if(o.length>0){const e=document.createElement("div");e.className="ip-box",e.style.setProperty("--ip-rows",String(1)),e.style.setProperty("--ip-gap","8px"),e.style.setProperty("--ip-w",`${a}px`),e.style.setProperty("--ip-h",`${s}px`),e.style.setProperty("--ip-col",`${l}px`);const t=document.createElement("div");t.className="ip-scroll";const n=document.createElement("div");n.className="ip-grid";const d=i.id?document.querySelector(`label[for="${i.id}"]`):null;(i.closest("label")||d||i).insertAdjacentElement("afterend",e),t.addEventListener("pointerdown",e=>e.stopPropagation()),t.addEventListener("click",e=>e.stopPropagation()),c.forEach((e,t)=>{const i=document.createElement("button");i.type="button",i.className="ip-btn",i.dataset.key=u.get(e);const a=r?e:o[t];i.appendChild(createThumbSlot(a));const s=t=>{t.preventDefault(),t.stopPropagation(),g(e)};i.addEventListener("pointerdown",s),i.addEventListener("click",s),n.appendChild(i)}),t.appendChild(n),e.appendChild(t),m=n}function f(e){if(!m)return;const t=u.get(String(e))||"";if(m.querySelectorAll(".ip-btn").forEach(e=>e.removeAttribute("selected")),t){const e=m.querySelector(`.ip-btn[data-key="${t}"]`);e&&e.setAttribute("selected","")}}let h=!1;function g(e){const t=String(e??"");i.value!==t&&(h=!0,i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})),h=!1),f(t)}const y=c[0]||"",w=o.length?d.has(p)?p:y:"";i.dataset.ipInitial=w,g(w),i.addEventListener("input",()=>{h||f(r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))}),i.addEventListener("change",()=>{h||f(r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))});const v=i.closest("form");if(!v)return{set:g};let b=FORM_STATE.get(v);b||(b={entries:[],hooked:!1},FORM_STATE.set(v,b));if(b.entries.push({input:i,fieldSuffix:t,prepareOne:()=>{let e=r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");if(!o.length){const e=r?prepareModalLinkAttrs(""):"";return i.value=e,e}if(!d.has(e)){const t=i.dataset.ipInitial??y;e=String(t),g(e)}const t=r?prepareModalLinkAttrs(e):e;return i.value=t,t}}),!b.hooked){b.hooked=!0;const e=v.submit,t=()=>{b.entries.forEach(({prepareOne:e})=>{e()})};v.addEventListener("submit",e=>{"1"!==v.dataset.ipResuming&&t()},!0),v.addEventListener("formdata",e=>{t(),b.entries.forEach(({input:t,fieldSuffix:n})=>{try{const r=t.name||`form[fld${n}]`;e.formData.set(r,t.value)}catch(e){}})}),v.submit=function(...n){return"1"===v.dataset.ipResuming||t(),e.apply(this,n)}}return{set:g}}async function FMVreplaceFieldData(e,t,n,r=!1){const o=`/profile.php?section=fields&id=${encodeURIComponent(e)}&nohead`,i="#fld"+t;try{const e=await fetchCP1251Doc(o),s=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!s)return{status:"error",fieldId:String(t),value:n,serverMessage:"Форма редактирования профиля не найдена",details:"profile.php без формы"};const l=s.querySelector(i);if(!l)return{status:"error",fieldId:String(t),value:n,serverMessage:`Поле ${i} не найдено. Проверьте номер fld.`};const c=l.value??"";if(""!==(a=c)&&" "!==a&&!r)return{status:"nochange",fieldId:String(t),value:n,serverMessage:"Поле уже содержит значение. Перезапись запрещена.",details:`Прежнее значение: ${String(c)}`};if(l.value=n,![...s.elements].some(e=>"update"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="update",t.value="1",s.appendChild(t)}let d="update";const u=[...s.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));u?.name&&(d=u.name);const p=serializeFormCP1251_SelectSubmit(s,d),m=s.getAttribute("action")||"/profile.php",{res:f}=await fetchCP1251Text(m,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:o,referrerPolicy:"strict-origin-when-cross-origin",body:p});if(!f.ok)return{status:"error",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:`HTTP ${f.status} при сохранении`};const h=await fetchCP1251Doc(o),g=h.querySelector("form#profile8")||[...h.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));return(g?.querySelector(i)?.value??null)===n?{status:"updated",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Значение успешно обновлено"}:{status:"uncertain",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Не удалось подтвердить новое значение, проверьте вручную"}}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,n}var a}async function FMVupdateGroupIfEquals(e,t,n,r={}){const o=!!r.overwriteSame,i=String(e),a=`/profile.php?section=admin&id=${encodeURIComponent(i)}&nohead`;try{const e=await fetchCP1251Doc(a),r=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!r)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Форма администрирования профиля не найдена",details:"profile.php?section=admin без ожидаемой формы"};const s=r.querySelector('select[name="group_id"]')||r.querySelector("#group_id");if(!s)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Селектор group_id не найден"};const l=(s.value??"").trim(),c=String(t).trim(),d=String(n).trim();if(l===d&&!o)return{status:"nochange",userId:i,fromGroupId:c,toGroupId:d,serverMessage:"Пользователь уже в целевой группе; перезапись отключена",details:`current=${l}`};if(l!==c&&(l!==d||!o))return{status:"skipped",userId:i,fromGroupId:c,toGroupId:d,serverMessage:"Текущая группа не совпадает с fromGroupId — изменения не требуются",details:`current=${l}`};if(s.value=d,![...r.elements].some(e=>"form_sent"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="form_sent",t.value="1",r.appendChild(t)}let u="update_group_membership";const p=[...r.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(r,u),f=r.getAttribute("action")||`/profile.php?section=admin&id=${encodeURIComponent(i)}`,{res:h,text:g}=await fetchCP1251Text(f,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m});if(!h.ok)return{status:"error",userId:i,fromGroupId:c,toGroupId:d,httpStatus:h.status,serverMessage:`HTTP ${h.status} при сохранении`};const y=await fetchCP1251Doc(a),w=y.querySelector("form#profile8")||[...y.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php")),v=w?.querySelector('select[name="group_id"]')||w?.querySelector("#group_id"),b=(v?.value??"").trim();return b===d?{status:"updated",userId:i,fromGroupId:c,toGroupId:d,httpStatus:h.status,serverMessage:"Группа успешно обновлена"}:{status:"uncertain",userId:i,fromGroupId:c,toGroupId:d,httpStatus:h.status,serverMessage:"Сервер ответил 200, но подтвердить новое значение не удалось — проверьте вручную",details:`readback=${b}`}}catch(r){const o=r&&r.message?r.message:String(r);return{status:"error",userId:String(e),fromGroupId:String(t),toGroupId:String(n),serverMessage:"Transport/Runtime error",details:o}}}async function fetchCardsWrappedClean(e,t){const n=`${location.origin.replace(/\/$/,"")}/viewtopic.php?id=${encodeURIComponent(String(e))}`,r=e=>{const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""},o=e=>(new DOMParser).parseFromString(e,"text/html");const i=o(await async function(e){if("function"==typeof window.fetchHtml)return window.fetchHtml(e);const t=await fetch(e,{credentials:"include"}),n=await t.arrayBuffer(),r=/charset=([^;]+)/i.exec(t.headers.get("content-type")||"")?.[1]?.toLowerCase(),o=e=>{try{return new TextDecoder(e).decode(n)}catch{return null}};if(r){const e=o(r);if(e)return e}const i=o("utf-8")??"",a=o("windows-1251")??"",s=e=>(e.match(/\uFFFD/g)||[]).length;if(s(a)&&!s(i))return i;if(s(i)&&!s(a))return a;const l=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return l(a)>l(i)?a:i}(n)),a=[];for(const e of t){const t=i.querySelector(`#p${String(e)}-content`);if(!t){console.warn(`Не найден #p${e}-content на ${n}`);continue}const s=[...t.querySelectorAll('script[type="text/html"]')];if(!s.length)continue;const l=[...o(r(s.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," ")).querySelectorAll("#grid .card")].map(e=>{const t=FMV.normSpace(e.querySelector(".id")?.textContent||""),n=FMV.normSpace(e.querySelector(".desc")?.textContent||"");return{id:t,html:`<div class="item" data-id="${t}"${n?` title="${n}"`:""}>${(e.querySelector(".content")?.innerHTML||"").replace(/\u00A0/g," ").trim()}</div>`}});a.push(...l)}return a}function findChronoRendered(e){const t=Array.from(e.querySelectorAll("*")).find(e=>/Собранная\s+хронология/i.test(e.textContent||""));return t?t.closest(".quote-box, .media, .spoiler-box, .content, .post, div, section")||t:null}function renderStatus(e,t){const n=window.CHRONO_CHECK?.EpisodeMapType||{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},r=window.CHRONO_CHECK?.EpisodeMapStat||{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},o=n[e]||n.au,i=r[t]||r.archived;return`[color=${o[1]}]${o[0]}[/color] / [color=${i[1]}]${i[0]}[/color]`}function parseParagraph(e){const t=[[],[],[],[]];let n=0;for(const r of e.childNodes)1!==r.nodeType||"BR"!==r.tagName?t[n].push(r):n=Math.min(n+1,3);const r=t[0],o=t[1],i=t[2],a=t[3],s=document.createElement("div");r.forEach(e=>s.appendChild(e.cloneNode(!0)));const l=s.querySelector('a[href*="viewtopic.php?id="]')||e.querySelector('a[href*="viewtopic.php?id="]'),{type:c,status:d,order:u,dateStart:p,dateEnd:m,title:f}=parseHeaderNew(r,o,l),{participants:h,masksLines:g}=parseParticipants(i),y=cleanLocation(textFromNodes(a)),w="au"===c?"":p||"",v="au"===c?"":m||w||"";return{type:c,status:d,title:f,href:l?.href||"",dateStart:w,dateEnd:v,order:Number.isFinite(u)?u:0,participants:h,masksLines:g,location:y}}function parseHeaderNew(e,t,n){const r=(n?.textContent||"").trim(),o=document.createElement("div");e.forEach(e=>o.appendChild(e.cloneNode(!0)));const i=(o.textContent||"").replace(/\s+/g," ").trim();let a="",s="",l=(o.querySelector("strong")?.textContent||"").trim();if(l){const e=l.replace(/[\u2012-\u2015\u2212—–−]/g,"-").replace(/\s*-\s*/g,"-").split("-").slice(0,2).map(e=>e.trim());a=e[0]||"",s=e[1]||""}else{const e=i.split(/\s[—–-]\s/)[0]?.trim()||"",t=parseDateFlexible(e);if(t&&t.hasDate){const e=e=>null!=e?.y?null!=e.d?`${String(e.d).padStart(2,"0")}.${String(e.m).padStart(2,"0")}.${e.y}`:null!=e.m?`${String(e.m).padStart(2,"0")}.${e.y}`:String(e.y):"";a=e(t.left),s=!t.right||t.right.y===t.left.y&&null==t.right.m&&null==t.right.d?"":e(t.right)}}/дата\s+не\s+указан/i.test(l||"")&&(a="",s="");let c="",d="",u=0;const p=textFromNodes(t).match(/\[([^\]]+)\]/);if(p){const e=p[1].split("/").map(e=>e.trim());if(c=(e[0]||"").toLowerCase(),d=(e[1]||"").toLowerCase(),e[2]){const t=parseInt(e[2],10);Number.isFinite(t)&&(u=t)}}return{type:c,status:d,order:u,dateStart:a,dateEnd:s,title:r}}function parseParticipants(e){const t=[];!function e(n){Array.from(n).forEach(n=>{3===n.nodeType?t.push({t:"text",v:n.nodeValue||""}):1===n.nodeType&&("A"===n.tagName?t.push({t:"link",name:(n.textContent||"").trim(),href:n.href||""}):e(n.childNodes))})}(e);const n=[],r=new Map;let o=null;for(const e of t){if("link"===e.t){const t=e.name;n.push({name:t,href:e.href}),o=t;continue}if("text"===e.t){let t=e.v||"";if(/\bне\s*указан/i.test(t))return{participants:[],masksLines:[]};t=t.replace(/\[\s*as\s*([^\]]+)\]/gi,(e,t)=>{const n=t.split(/\s*,\s*/).map(e=>e.trim()).filter(Boolean);var i,a;return a=n,(i=o)&&a&&a.length&&(r.has(i)||r.set(i,[]),r.get(i).push(...a)),""}),t.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{/^[–—-]+$/.test(e)||/^\[.*\]$/.test(e)||(n.push({name:e,href:""}),o=e)})}}const i=[];for(const e of n){const t=r.get(e.name);t&&t.length&&t.forEach(t=>i.push(`${e.name} — ${t}`))}return{participants:n,masksLines:i}}function cleanLocation(e){const t=String(e||"").trim();return t?/^локац/i.test(t)&&/не\s+указан/i.test(t)||/^не\s+указан/i.test(t)?"":t:""}async function collectEpisodesFromForums(e={}){async function t(e,t,n){const r=[],o=new Set;for(const i of t){const t=Promise.resolve().then(()=>n(i));r.push(t),o.add(t);const a=()=>o.delete(t);t.then(a,a),o.size>=e&&await Promise.race(o)}return Promise.all(r)}let n=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];if(!n.length){const e=new Set;document.querySelectorAll('a[href*="viewforum.php?id="]').forEach(t=>{const n=String(t.getAttribute("href")||"").match(/viewforum\.php\?id=(\d+)/i);n&&e.add(n[1])}),n=Array.from(e).map(e=>({id:e}))}if(!n.length)return console.warn("[collectEpisodesFromForums] Не удалось определить список разделов (sections)"),[];const r=(e,t)=>{try{return new URL(t,e).href}catch{return t}};const o=/[\u2012-\u2015\u2212—–−]/g,i=/[.\u2024\u2219\u00B7\u2027\u22C5·∙•]/g,a=e=>String(e).padStart(2,"0");function s(e){const t=Number(e);return Number.isFinite(t)?2===String(e).length?t>30?1900+t:2e3+t:t:null}function l(e,t){return new Date(e,t,0).getDate()}function c(e){const t=String(e||"").trim().replace(i,".");let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);if(n){const e=+n[1],t=+n[2],r=s(n[3]);return t<1||t>12||(e<1||e>l(r,t))?null:{y:r,m:t,d:e}}if(n=t.match(/^(\d{1,2})\.(\d{2}|\d{4})$/),n){const e=+n[1],t=s(n[2]);if(e>=1&&e<=12)return{y:t,m:e}}if(n=t.match(/^(\d{1,2})\.(\d{1,2})$/),n){const e=+n[1],t=+n[2];return t>=1&&t<=12&&e>=1&&e<=31?{m:t,d:e}:null}return n=t.match(/^(\d{2}|\d{4})$/),n?{y:s(n[1])}:null}function d(e){return null!=e.d?`${a(e.d)}.${a(e.m)}.${e.y}`:null!=e.m?`${a(e.m)}.${e.y}`:String(e.y)}function u(e){let t=String(e||"").trim();if(!t)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};t=t.replace(o,"-").replace(i,".").replace(/\s*-\s*/g,"-");const n=t.split("-").slice(0,2);if(1===n.length){const e=c(n[0]);if(!e||!e.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};const t=[e.y,e.m??0,e.d??0];return{hasDate:!0,display:d(e),startSort:t,endSort:t,left:e,right:e}}const r=n[0].trim(),u=n[1].trim(),p=c(u);if(!p||!p.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};let m=c(r);const f=r.match(/^\d{1,2}$/);if(f){const e=+f[0];m=null!=p.d&&null!=p.m?{y:p.y,m:p.m,d:e}:null!=p.m?{y:p.y,m:e}:{y:s(e)}}const h=/^\d{1,2}$/.test(r),g=/^\d{1,2}$/.test(u);if(h&&g&&m?.y&&p?.y&&null==m.m&&null==m.d&&null==p.m&&null==p.d&&m.y>p.y){const e=100*Math.floor(p.y/100),t=+r;m.y=e+t}m&&null==m.y&&null!=m.d&&null!=m.m&&p.y&&(m.y=p.y);const y=e=>null==e.d||e.y&&e.m&&e.d>=1&&e.d<=l(e.y,e.m);if(!y(m)||!y(p))return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};return{hasDate:!0,startSort:[m.y,m.m??0,m.d??0],endSort:[p.y??m.y,p.m??0,p.d??0],display:(w=m,v=p,null!=w.d&&null!=v.d?`${a(w.d)}.${a(w.m)}.${w.y}-${a(v.d)}.${v.m}.${v.y}`:null!=w.m&&null!=v.m?`${a(w.m)}.${w.y}-${a(v.m)}.${v.y}`:`${w.y}-${v.y}`),left:m,right:p};var w,v}function p(e,t){for(let n=0;n<3;n++){const r=(e[n]??0)-(t[n]??0);if(r)return r}return 0}async function m(n,o){let i=r(location.href,`/viewforum.php?id=${n.id}`);const a=new Set,s=[];let l=0;const c=new Set;let d="";for(;i&&!a.has(i)&&l<100;){l++,a.add(i);const u=await FMV.fetchDoc(i),p=new Map;u.querySelectorAll('a[href*="viewtopic.php?id="]').forEach(e=>{const t=r(i,e.getAttribute("href")),n=t.match(/viewtopic\.php\?id=(\d+)/i),o=((a=e)&&(a.innerText??a.textContent)||"").trim();var a;n&&(/^\s*(RSS|Atom)\s*$/i.test(o)||/#p\d+$/i.test(t)||/^\d{1,2}\.\d{1,2}\.\d{2,4}(?:\s+\d{1,2}:\d{2})?$/.test(o)||p.set(n[1],{url:t,title:o}))});const m=Array.from(p.keys()).sort(),h=m.join(",");if(h&&h===d)break;d=h;const g=m.filter(e=>!c.has(e));if(0===g.length)break;g.forEach(e=>c.add(e));const y=Number.isFinite(+e?.concurrencyPerPage)?+e.concurrencyPerPage:6,w=Array.from(p.entries()),v=await t(y,w,async([e,{url:t,title:r}])=>{const i=e?`id:${e}`:`url:${t.replace(/#.*$/,"")}`;if(o.has(i))return null;const a=await f(t,r,n.type,n.status);return a?{key:i,row:a}:null});for(const e of v)e&&(o.add(e.key),s.push(e.row));const b=function(e){const t=e.querySelector('a[rel="next"], a[href*="&p="]:not([rel="prev"])');return t?t.getAttribute("href"):null}(u),S=b?r(i,b):null;if(!S||a.has(S)){i=null;break}i=S}return s}async function f(e,t,n,r){try{const o=await FMV.fetchDoc(e),i=o.querySelector(".post.topicpost .post-content")||o.querySelector(".post.topicpost")||o,a=function(e){const t=(e.querySelector("title")?.textContent||"").trim();if(/\[.+\]\s+.+/.test(t))return t;const n=e.querySelector(".crumbs, .crumbs-nav, #pun-crumbs1 .crumbs, #pun-crumbs1");if(n){const e=(n.textContent||"").replace(/\s+/g," ").trim(),t=e.split("»").pop()?.trim()||"";if(t)return t}const r=e.querySelector('a[href*="viewtopic.php?id="]');return(r?.textContent||"").trim()}(o),s=t||a||"",{dateRaw:l,episode:c}=function(e){const t=String(e||"").trim(),n=t.match(/^\s*\[(.*?)\]\s*(.*)$/s);if(n){const e=(n[1]||"").trim(),t=(n[2]||"").trim(),r=u(e);if(r&&r.hasDate)return{dateRaw:e,episode:t.replace(/\s+/g," ")}}return{dateRaw:"",episode:t.replace(/\s+/g," ")}}(s),p=u(l),m=function(e,t,n){const r=String(t||"").trim();let o=!0;if("plot"===e){const e=/\s\[\s*(?:c|с)\s*\]$/i,t=e.test(r);return o=!!n&&t,{title:t?r.replace(e,"").trim():r,ok:o}}if("au"===e){const e=/^(?:\[\s*au\s*\]\s+|\[\s*AU\s*\]\s+)/,t=e.test(r);return o=t,{title:t?r.replace(e,"").trim():r,ok:o}}return{title:r,ok:o}}(n,c||"",p.hasDate),f=FMV.readTagText(i,"characters"),h=FMV.readTagText(i,"location"),g=FMV.readTagText(i,"order"),y=await FMV.buildIdToNameMapFromTags(f),w=FMV.parseCharactersUnified(f,y,window.profileLink),v=w.ok?w.participantsLower:[],b=w.ok?w.masksByCharLower:new Map,S=FMV.parseOrderStrict(g).ok?FMV.parseOrderStrict(g).value:0,x=h?h.split(/\s*[,;]\s*/).map(e=>e.trim().toLowerCase()).filter(Boolean):[],C=v.map(e=>{const t=Array.from(b.get(e)||[]),n=/^user(\d+)$/i.exec(String(e));if(n){const e=n[1];return y&&y.has(e)?{id:e,name:y.get(e),masks:t}:{name:`user${e}`,masks:t}}return{name:String(e),masks:t}}),k=p.hasDate?null!=p.left?.d||null!=p.left?.m?d(p.left):String(p.left?.y??""):"";return{dateStart:k,dateEnd:p.hasDate?null!=p.right?.d||null!=p.right?.m?d(p.right):String(p.right?.y??p.left?.y??""):k||"",title:m.title||"",href:e,type:n,status:r,order:Number(S)||0,location:x.join(", "),participants:C,isTitleNormalized:m.ok,__hasDate:p.hasDate,__startSort:p.startSort,__endSort:p.endSort}}catch{return null}}const h=new Set;let g=[];for(const e of n){const t=await m(e,h);g=g.concat(t)}return g=g.filter(Boolean).sort(function(e,t){const n=!!e.__hasDate;if(n!==!!t.__hasDate)return n?-1:1;if(n){const n=p(e.__startSort,t.__startSort);if(n)return n;const r=p(e.__endSort,t.__endSort);if(r)return r}const r=e.order??0,o=t.order??0;return r!==o?r-o:String(e.title||"").toLowerCase().localeCompare(String(t.title||"").toLowerCase(),"ru",{sensitivity:"base"})}),g.forEach(e=>{delete e.__hasDate,delete e.__startSort,delete e.__endSort}),g}async function collectChronoByUser(e={}){if("function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");let t=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];const n=Number.isFinite(+e.maxPagesPerSection)?+e.maxPagesPerSection:void 0,r=await collectEpisodesFromForums({sections:t,maxPagesPerSection:n}),o=Object.create(null);r.forEach((e,t)=>{Number.isFinite(e.order)||(e.order=t)});for(const e of r){const t=(e.participants||[]).map(e=>{const t=e?.id?String(e.id).trim():"";return t?{id:t,name:(e.name||"").trim(),masks:Array.isArray(e.masks)?e.masks.slice():[]}:null}).filter(Boolean);for(const n of t){const r=t.filter(e=>e!==n).map(e=>({id:e.id,name:e.name,masks:e.masks.slice()})),i={dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",order:Number(e.order||0),location:e.location||"",masks:n.masks||[],participants:r,isTitleNormalized:!!e.isTitleNormalized};o[n.id]||(o[n.id]={name:n.name||"",episodes:[]}),o[n.id].episodes.push(i)}}return o}(async()=>{const{icons:e,plashki:t,backs:n}=await collectSkinSets();window.SKIN?.PlashkaFieldID&&applyImagePicker(t,SKIN.PlashkaFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0}),window.SKIN?.BackFieldID&&applyImagePicker(n,SKIN.BackFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0}),window.SKIN?.IconFieldID&&applyImagePicker(e,SKIN.IconFieldID,{btnWidth:44})})(),function(){"use strict";window.setupSkins=async function(e,t,n={}){if(!(e&&e instanceof HTMLElement))throw new Error("[setupSkins] container обязателен и должен быть HTMLElement");if("function"!=typeof window.createChoicePanel)throw new Error("[setupSkins] createChoicePanel не найден. Подключите файл с панелью раньше.");if(window.__skinsSetupMounted)return window.__skinsSetupMounted;const r=n.withHeaders??!0,o=n.startOpen??!1,i=window.SKIN;if(!i)return void console.warn("[setupSkins] window.SKIN не найден — прекращаю выполнение.");let[a,s,l,c,d]=await Promise.all([fetchCardsWrappedClean(i.LibraryFieldID,i.LibraryPlashkaPostID),fetchCardsWrappedClean(i.LibraryFieldID,i.LibraryIconPostID),fetchCardsWrappedClean(i.LibraryFieldID,i.LibraryBackPostID),fetchCardsWrappedClean(i.LibraryFieldID,i.LibraryGiftPostID),fetchCardsWrappedClean(i.LibraryFieldID,i.LibraryCouponPostID)]);a=Array.isArray(a)?a:[],s=Array.isArray(s)?s:[],l=Array.isArray(l)?l:[],c=Array.isArray(c)?c:[],d=Array.isArray(d)?d:[];let u=e.querySelector(".skins-setup-grid");u||(u=document.createElement("div"),u.className="skins-setup-grid",u.style.display="grid",u.style.gridTemplateColumns="1fr",u.style.gap="16px",e.appendChild(u));const p=window.createChoicePanel({title:r?"Подарки":void 0,targetClass:"_gift",library:c,mountEl:u,initialHtml:t,external:!0,startOpen:o,allowMultiAdd:!0}),m=window.createChoicePanel({title:r?"Купоны":void 0,targetClass:"_coupon",library:d,mountEl:u,initialHtml:t,external:!0,startOpen:o,allowMultiAdd:!0,expirableAttr:"data-expired-date"}),f=window.createChoicePanel({title:r?"Плашки":void 0,targetClass:"_plashka",library:a,mountEl:u,initialHtml:t,external:!0,startOpen:o}),h=window.createChoicePanel({title:r?"Иконки":void 0,targetClass:"_icon",library:s,mountEl:u,initialHtml:t,external:!0,startOpen:o}),g=window.createChoicePanel({title:r?"Фон":void 0,targetClass:"_background",library:l,mountEl:u,initialHtml:t,external:!0,startOpen:o}),y={build:function(e){let n="string"==typeof e?e:t||"";return f?.builder&&(n=f.builder(n)),h?.builder&&(n=h.builder(n)),g?.builder&&(n=g.builder(n)),p?.builder&&(n=p.builder(n)),m?.builder&&(n=m.builder(n)),n},panels:{plashka:f,icon:h,back:g,gift:p,coupon:m}};return window.__skinsSetupMounted=y,y}}(),function(){if(window.jQuery){var e=jQuery;/\/profile\.php$/i.test(location.pathname)&&/[?&]id=\d+/.test(location.search)&&(e("<style>").text("\n    #pa-bank-link a.is-empty{\n      color:#999!important;text-decoration:none!important;\n      pointer-events:none;cursor:default;opacity:.8;\n    }").appendTo(document.head||document.documentElement),e(async function(){var n=function(){var t=e("#viewprofile #profile-right");if(!t.length)return null;FORUM_IDS.length&&FORUM_IDS.join(",");var n=e('\n      <li id="pa-bank-link">\n        <span>Банковские операции:</span>\n        <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n      </li>\n    '),r=t.find("#pa-last-visit");return r.length?n.insertAfter(r):t.append(n),n.find("a")}();if(n&&n.length)if("function"==typeof window.scrapePosts)if(window.UserLogin&&window.SITE_URL){var r=Array.isArray(window.BANK_FORUMS)?window.BANK_FORUMS:[];try{var o=await window.scrapePosts(window.UserLogin,r,{title_prefix:"Гринготтс",stopOnFirstNonEmpty:!0,keywords:"ДОХОДЫ OR РАСХОДЫ AND ИТОГО"});if(Array.isArray(o)&&o.length&&o[0]?.src)!function(e,t){e.removeClass("is-empty").attr({href:t}).text("Последняя")}(n,String(window.SITE_URL||"").replace(/\/$/,"")+"/viewtopic.php?"+o[0].src);else t(n)}catch(e){console.error("[bank_last_comment] scrapePosts failed",e),t(n,"ошибка поиска")}}else t(n,"нет данных пользователя");else t(n,"нет доступа к поиску")}))}function t(e,t){var n="Не найдена";e.addClass("is-empty").attr({href:"#",title:t||n}).text(n)}}(),function(){if(window.jQuery){var e=jQuery,t=[11,12,13,20,21,23,24];if(/\/profile\.php$/i.test(location.pathname)&&/[?&]id=\d+/.test(location.search)){e("<style>").text("\n    #pa-lastpost-link a.is-empty{\n      color:#999!important;text-decoration:none!important;\n      pointer-events:none;cursor:default;opacity:.8;\n    }\n    #pa-lastpost-link small { opacity:.8; margin-left:.5em; }\n  ").appendTo(document.head||document.documentElement);var n=function(){var t=e("#viewprofile").text()||"",n=t.match(/UTC\s*([+\-]\d{1,2})(?::?(\d{2}))?/i)||t.match(/GMT\s*([+\-]\d{1,2})/i);if(n){var r=parseInt(n[1],10),o=n[2]?parseInt(n[2],10):0;return{type:"offset",minutes:60*r+(r>=0?o:-o)}}var i=document.cookie.match(/(?:punbb_tz|timezone|tzoffset)=([+\-]?\d{1,3})/i);if(i)return{type:"offset",minutes:parseInt(i[1],10)};try{var a=Intl.DateTimeFormat().resolvedOptions().timeZone;if(a)return{type:"iana",zone:a}}catch(e){}return{type:"browser"}}();e(function(){var n=function(){var t=e("#viewprofile #profile-right");if(!t.length)return null;var n=e('\n      <li id="pa-lastpost-link">\n        <span>Последний пост:</span>\n        <strong>\n          <a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a>\n        </strong>\n      </li>\n    '),r=t.find("#pa-last-visit");return r.length?n.insertAfter(r):t.append(n),n}();if(n){var i=e("#profile-name > strong").first().text().trim()||[e("#viewprofile h1 span").text(),e("#viewprofile h1").text(),e("#viewprofile #profile-right .pa-author strong").first().text(),e("#viewprofile #profile-left .pa-author strong").first().text(),document.title||""].map(e=>(e||"").replace(/^Профиль:\s*/i,"").replace(/[«»]/g,"").trim()).filter(Boolean)[0]||null;if(i){var l=!1,c=setTimeout(function(){l||(l=!0,r(n,"таймаут"))},8e3),d=1,u=1,p=[],m=[],f=!1,h=!1,g=0,y=0;!function e(){if(!l){if(!p.length&&!f)return w("posts",e);if(!m.length&&!h)return w("topics",e);if(!p.length&&!m.length)return l=!0,clearTimeout(c),void r(n);if(!m.length)return(t=p.shift())&&isFinite(t.ts)?(l=!0,clearTimeout(c),void o(n,t.href,t.ts)):e();if(!p.length)return f?(l=!0,clearTimeout(c),void r(n)):w("posts",e);var t=p[0],i=m[0];return isFinite(i.ts)?t.ts>i.ts?(p.shift(),l=!0,clearTimeout(c),void o(n,t.href,t.ts)):t.ts===i.ts&&t.topicId&&i.topicId&&t.topicId===i.topicId?(p.shift(),m.shift(),e()):(m.shift(),e()):(m.shift(),e())}}()}else r(n,"не удалось определить ник")}function w(o,w){if(!l){var v,b,S,x="posts"===o?(v=i,b=d,S=t.join(","),"/search.php?action=search&keywords=&author="+encodeURIComponent(v)+(S?"&forum="+encodeURIComponent(S)+"&forums="+encodeURIComponent(S):"")+"&search_in=1&sort_by=0&sort_dir=DESC&show_as=posts"+(b?"&p="+b:"")):function(e,t){return"/search.php?action=show_user_topics&author="+encodeURIComponent(e)+(t?"&p="+t:"")}(i,u);e.get(x,function(t){if(!l){if(clearTimeout(c),c=setTimeout(function(){l||(l=!0,r(n,"таймаут"))},8e3),function(e){var t=(e||"").toLowerCase();return t.includes('id="pun-login"')||t.includes("недостаточно прав")||t.includes("вы не авторизованы")||t.includes("нет доступа")}(t))return l=!0,clearTimeout(c),void r(n,"доступ закрыт");if("posts"===o?function(e){return(e||"").toLowerCase().includes("по вашему запросу ничего не найдено")||!/<div[^>]+class="post\b/i.test(e||"")}(t):function(e){return(e||"").toLowerCase().includes("по вашему запросу ничего не найдено")||!/<div[^>]+class="forum\b/i.test(e||"")}(t))return"posts"===o?(p=[],f=!0):(m=[],h=!0),void w();var i=e(t);if("posts"===o){p=function(t){var n=e(t),r=[];return n.find("div.post").each(function(){var t=e(this),n=parseInt(t.attr("data-posted"),10),o=t.find(".post-links a[href*='viewtopic.php?pid=']").first(),i=o.length?o.attr("href"):null,s=NaN,l=t.find("h3 a[href*='viewtopic.php?id=']").last();l.length&&(s=a(l.attr("href"))),n&&i&&r.push({ts:n,href:i,topicId:s})}),r}(t);var v=!!function(e){var t=e.find("#pun-searchposts .pagelink a.next").first();return t.length?t.attr("href"):null}(i);g++,!v||g>=20?f=!0:d++}else{m=s(t);var b=!!function(e){var t=e.find("#pun-searchtopics .pagelink a.next").first();return t.length?t.attr("href"):null}(i);y++,!b||y>=20?h=!0:u++}w()}},"html").fail(function(){l||(clearTimeout(c),l=!0,r(n,"ошибка сети"))})}}})}}function r(e,t){var n="Не найден";e.find("a").addClass("is-empty").attr({href:"#",title:t||n}).text(n)}function o(e,t,r){e.find("a").removeClass("is-empty").attr({href:t}).text(function(e){var t=new Date(1e3*e);if("offset"===n.type){return i(new Date(t.getTime()+6e4*(n.minutes-t.getTimezoneOffset())))}try{var r="iana"===n.type?n.zone:void 0;return new Intl.DateTimeFormat("ru-RU",{timeZone:r,year:"numeric",month:"long",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(t).replace(/\s*г\.,?\s*/," ").replace(/\u202F/g," ")}catch(e){return i(t)}}(r))}function i(e){function t(e){return(e<10?"0":"")+e}return e.getDate()+" "+["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"][e.getMonth()]+" "+e.getFullYear()+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())}function a(e){var t=(e||"").match(/viewtopic\.php\?id=(\d+)/i);return t?+t[1]:NaN}function s(n){var r=e(n),o=[];return r.find("tbody.hasicon tr").each(function(){var n=e(this),r=n.find("td.tc2 a[href*='viewforum.php?id=']"),i=r.length?function(e){var t=(e||"").match(/viewforum\.php\?id=(\d+)/i);return t?+t[1]:NaN}(r.attr("href")):NaN;if(t.includes(i)){var s=n.find("td.tcl a[href*='viewtopic.php?id=']").first(),l=s.length?a(s.attr("href")):NaN,c=n.find("td.tcr a[href*='#p']");if(c.length){var d=c.attr("href"),u=function(e){e=(e||"").trim().toLowerCase();var t,n,r=new Date,o=new Date(r.getFullYear(),r.getMonth(),r.getDate());if(/^сегодня\s+\d{1,2}:\d{2}:\d{2}$/.test(e))return n=e.match(/(\d{1,2}):(\d{2}):(\d{2})/),t=new Date(o.getFullYear(),o.getMonth(),o.getDate(),+n[1],+n[2],+n[3]),Math.floor(t.getTime()/1e3);if(/^вчера\s+\d{1,2}:\d{2}:\d{2}$/.test(e)){n=e.match(/(\d{1,2}):(\d{2}):(\d{2})/);var i=new Date(o.getTime()-864e5);return t=new Date(i.getFullYear(),i.getMonth(),i.getDate(),+n[1],+n[2],+n[3]),Math.floor(t.getTime()/1e3)}var a={"января":0,"февраля":1,"марта":2,"апреля":3,"мая":4,"июня":5,"июля":6,"августа":7,"сентября":8,"октября":9,"ноября":10,"декабря":11};return(n=e.match(/^(\d{1,2})\s+([а-я]+)\s+(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})$/i))&&null!=a[n[2]]?(t=new Date(+n[3],a[n[2]],+n[1],+n[4],+n[5],+n[6]),Math.floor(t.getTime()/1e3)):NaN}((c.text()||"").trim());o.push({ts:u,href:d,topicId:l,forumId:i})}}}),o}}(),(()=>{"use strict";"function"!=typeof window.extractErrorMessage&&(window.extractErrorMessage=()=>""),"function"!=typeof window.extractInfoMessage&&(window.extractInfoMessage=()=>""),"function"!=typeof window.classifyResult&&(window.classifyResult=()=>"unknown"),window.FMV=window.FMV||{},window.FMV.replaceComment=async function(e,t,n){const r="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():null,o=new Set((e||[]).map(e=>String(Number(e))));if(!r||!o.has(String(Number(r))))return{ok:!1,status:"forbidden",postId:String(t),newText:n,errorMessage:"Нет доступа по группе"};const i=parseInt(t,10);if(!Number.isFinite(i))return{ok:!1,status:"badid",postId:String(t),newText:n,errorMessage:`Некорректный postId: ${t}`};const a=String(i),s=`/edit.php?id=${encodeURIComponent(a)}&action=edit`;try{let e,t,r,o="";try{e=await fetchCP1251Doc(s),o=e.documentElement?e.documentElement.outerHTML:"",r=e.querySelector('textarea#main-reply[name="req_message"], textarea[name="req_message"]'),r&&(t=r.closest("form"))}catch(e){return{ok:!1,status:"transport",postId:a,newText:n,errorMessage:e?.message||String(e)}}if(!t||!r){const e=extractInfoMessage(o)||"",t=extractErrorMessage(o)||"";return{ok:!1,status:classifyResult(o)||"noform",postId:a,newText:n,infoMessage:e,errorMessage:t}}const i=String(r.value||"").trim();r.value=n;const l=[...t.elements].find(e=>"submit"===e.type&&(e.name||/Отправ|Сохран|Submit|Save/i.test(e.value||"")))?.name||"submit",c=serializeFormCP1251_SelectSubmit(t,l),{res:d,text:u}=await fetchCP1251Text(s,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c,referrer:s,referrerPolicy:"strict-origin-when-cross-origin"}),p=extractInfoMessage(u)||"",m=extractErrorMessage(u)||"",f=classifyResult(u);let h="string"==typeof f?f:f&&(f.status||f.code)?String(f.status||f.code):"unknown";return!d.ok||"unknown"!==h&&""!==h||(h="ok"),d.ok&&"ok"===h?{ok:!0,status:"ok",postId:a,oldText:i,newText:n,httpStatus:d.status}:{ok:!1,status:h,postId:a,oldText:i,newText:n,httpStatus:d.status,infoMessage:p.slice(0,200),errorMessage:m.slice(0,200)}}catch(e){return{ok:!1,status:"transport",postId:String(t),newText:n,errorMessage:e?.message||String(e)}}}})(),function(){"use strict";window.checkChronoFields=function(e=[]){const t=window.CHRONO_CHECK;return!(!t||"object"!=typeof t)&&(!Array.isArray(e)||!e.length||e.every(e=>{const n=t[e];return null!=n&&(Array.isArray(n)?n.length>0:"string"==typeof n?""!==n.trim():"number"==typeof n?Number.isFinite(n):"object"!=typeof n||Object.keys(n).length>0)}))}}(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_total_to_excel] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,i=(window.SITE_URL||location.origin).replace(/\/+$/,""),a=window.CHRONO_CHECK.ForumInfo;let s="";createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"выгрузить общее хроно в excel",order:2,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Скачать",linkHref:"",async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{}),r=e?.setLink||(()=>{});e?.setLink?.("","");try{t("Собираю…"),n("");const p=await collectEpisodesFromForums({sections:a});if(!p.length)throw new Error("Эпизоды не найдены.");const h=p.map(e=>{const t=(e.participants||[]).map(e=>{const t=String(e.name||"").trim();if(!t)return"";if(null!=e.id&&""!==e.id){return`${t} — ${`${i}/profile.php?id=${encodeURIComponent(String(e.id))}`}`}return t}).filter(Boolean).join("\n"),n=(e.participants||[]).flatMap(e=>{const t=Array.isArray(e.masks)?e.masks.filter(Boolean):[],n=String(e.name||"").trim()||(null!=e.id?`user${e.id}`:"");return t.map(e=>`${n} — ${e}`)}).filter(Boolean);return{type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",order:Number(e.order||0)||0,participantsText:t,masksLines:n,location:e.location||""}});t("Формирую файл…");const{blob:g,filename:v}=function(e){const t=[],n=(e,n)=>t.push({name:e,data:l(n)}),r='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n</Relationships>',o='<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"\n          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n  <sheets>\n    <sheet name="Хронология" sheetId="1" r:id="rId1"/>\n  </sheets>\n</workbook>';n("[Content_Types].xml",'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml"  ContentType="application/xml"/>\n  <Override PartName="/xl/workbook.xml"          ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>\n  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n</Types>'),n("_rels/.rels",'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n</Relationships>'),n("xl/workbook.xml",o),n("xl/_rels/workbook.xml.rels",r),n("xl/worksheets/sheet1.xml",function(e){const t=`<row r="1">${["Тип","Статус","Тема","Дата начала","Дата конца","Порядок","Участники","Маски","Локация"].map(y).join("")}</row>`,n=e.map((e,t)=>`<row r="${t+2}">${[y(e.type||""),y(e.status||""),b(e.href||"",e.title||e.href||""),y(e.dateStart||""),y(e.dateEnd||e.dateStart||""),w(e.order||0),y(e.participantsText||""),y((e.masksLines||[]).join("\n")),y(e.location||"")].join("")}</row>`).join("");return`<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n  <sheetData>${t}${n}</sheetData>\n</worksheet>`}(e));const i=function(e){const t=f(),n=[],r=[];let o=0;e.forEach(e=>{const i=l(e.name),a=e.data,s=m(a),p=u([d(67324752),c(20),c(0),c(0),c(t.time),c(t.date),d(s),d(a.length),d(a.length),c(i.length),c(0),i,a]),f=u([d(33639248),c(20),c(20),c(0),c(0),c(t.time),c(t.date),d(s),d(a.length),d(a.length),c(i.length),c(0),c(0),c(0),c(0),d(0),d(o),i]);n.push(p),r.push(f),o+=p.length});const i=u(r),a=n.reduce((e,t)=>e+t.length,0),s=i.length,p=u([d(101010256),c(0),c(0),c(e.length),c(e.length),d(s),d(a),c(0)]);return new Blob([u([...n,i,p])],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}(t),a=`chronology_${(new Date).toISOString().slice(0,10)}.xlsx`;return{blob:i,filename:a}}(h);if(s)try{URL.revokeObjectURL(s)}catch{}s=URL.createObjectURL(g),t("Готово"),n(`Строк: ${h.length}\nИсточник: ${FMV.escapeHtml(o)}\nФайл: ${FMV.escapeHtml(v)}`),r(s,"Скачать");const S=e?.wrap?.querySelector("a.fmv-action-link");S&&S.setAttribute("download",v)}catch(r){t("Ошибка"),n(FMV.escapeHtmlShort(r?.message||String(r))),e?.setLink?.("","")}}});const l=e=>(new TextEncoder).encode(e),c=e=>new Uint8Array([255&e,e>>>8&255]),d=e=>new Uint8Array([255&e,e>>>8&255,e>>>16&255,e>>>24&255]),u=e=>{let t=0;e.forEach(e=>t+=e.length);const n=new Uint8Array(t);let r=0;return e.forEach(e=>{n.set(e,r),r+=e.length}),n},p=(()=>{let e,t=new Uint32Array(256);for(let n=0;n<256;n++){e=n;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e>>>0}return t})(),m=e=>{let t=~0;for(let n=0;n<e.length;n++)t=t>>>8^p[255&(t^e[n])];return(-1^t)>>>0},f=(e=new Date)=>({time:(31&e.getHours())<<11|(63&e.getMinutes())<<5|31&Math.floor(e.getSeconds()/2),date:(e.getFullYear()-1980&127)<<9|(e.getMonth()+1&15)<<5|31&e.getDate()}),h=e=>String(e||"").replace(/[<>&"]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e])),g=e=>String(e||"").replace(/"/g,'""');function y(e){return`<c t="inlineStr"><is><t xml:space="preserve">${h(e).replace(/\r?\n/g,"&#10;")}</t></is></c>`}function w(e){return`<c><v>${Number(e)||0}</v></c>`}function v(e){return`<c><f>${h(e)}</f></c>`}function b(e,t){return e&&t?v(`HYPERLINK("${g(e)}","${g(t)}")`):e&&!t?v(`HYPERLINK("${g(e)}","${g(e)}")`):y(t||"")}})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","PerPersonChronoPostID","ForumInfo"]))return void console.warn("[button_update_per_user] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, PerPersonChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.PerPersonChronoPostID).trim(),o=(window.SITE_URL||location.origin).replace(/\/+$/,""),i=window.CHRONO_CHECK.ForumInfo;"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`);const a=e=>String(e||"").trim();function s(e){const t=function(e,t){const n=a(e),r=a(t);return n||r?r&&r!==n?`[b]${n}-${r}[/b]`:`[b]${n}[/b]`:""}(e.dateStart,e.dateEnd),n=`[url=${FMV.escapeHtml(a(e.href))}]${FMV.escapeHtml(a(e.title)||a(e.href))}[/url]`,r=Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:"",o=t?`${t} — ${n}${r}`:`${n}${r}`,i=`[${renderStatus(e.type,e.status)} / ${`${FMV.escapeHtml(String(e.order??0))}`}]`,s=function(e=[]){return e.length?`[i]${e.map(e=>{const t=!0;return`${null!=e.id&&""!==String(e.id)?userLink(String(e.id),e.name,t):missingUser(String(e.name||""),t)}${Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:""}`}).join(", ")}[/i]`:""}(e.participants||[]),l=[o,i];return s&&l.push(s),a(e.location)&&l.push(FMV.escapeHtml(a(e.location))),l.join("\n")}const l=`${o}/viewtopic.php?id=${n}#p${r}`;createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить хроно по персам",order:3,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть пост",linkHref:l,async onClick(t){const c=t?.setStatus||(()=>{}),d=t?.setDetails||(()=>{}),u=t?.setLink||(()=>{}),p=t?.setLinkVisible||(()=>{});u("",""),p?.(!1);try{c("Собираю…"),d("");const t=await(window.collectChronoByUser?window.collectChronoByUser({sections:i}):Promise.reject(new Error("collectChronoByUser недоступна"))),m=Object.entries(t||{}).map(([e,t])=>({id:e,name:t?.name||"",episodes:Array.isArray(t?.episodes)?t.episodes:[]})).filter(e=>e.name).sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));if(!m.length)return c("Пусто"),void d("Нет данных для вывода.");c("Формирую текст…");const f=m.map(e=>function(e,t=[]){return`[media="[url=${o}/viewtopic.php?id=${n}]${FMV.escapeHtml(a(e))}[/url]"]\n${t.map(s).join("\n\n")}\n[/media]`}(e.name,e.episodes)).join("\n\n"),h=`[media="Хронология по персонажам"]\n${f}\n[/media]`;c("Записываю…");const g=FMV.toCp1251Entities(h),y=await FMV.replaceComment(e,r,g),w=String(y?.status||""),v=!!y?.ok||"ok"===w;c(v?"Готово":"Ошибка"),v?(u(l,"Открыть пост"),p?.(!0)):(u("",""),p?.(!1));const b=(y?.infoMessage||"").replace(/<[^>]*>/g," ").trim(),S=(y?.errorMessage||"").replace(/<[^>]*>/g," ").trim(),x=[`Статус: ${v?"ok":w||"unknown"}`];b&&x.push(b),S&&x.push(S),d(x.join("\n"))}catch(e){c("Ошибка"),d(e?.message||String(e)),u("",""),p?.(!1)}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ForumInfo"]))return void console.warn("[button_update_personal_page] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=window.CHRONO_CHECK.ForumInfo;function r(e){const t=o(e);if("function"!=typeof t)throw new Error(`${e} не найден — подключите соответствующий скрипт`);return t}function o(e){return e.split(".").reduce((e,t)=>e&&e[t],window)}async function i(e,t={}){const n=r("FMVeditPersonalPage"),o=r("collectChronoByUser"),i=r("FMV.buildChronoHtml"),a=String(e),s=`usr${a}_chrono`,l=t.sections;let c;try{c=await o({sections:l})}catch(e){return{id:a,status:`ошибка collectChronoByUser: ${e?.message||e}`}}const d=c?.[a];if(!d)return{id:a,status:"нет данных (пользователь не найден в хроно-коллекции)"};let u,p;try{u=i(d,{titlePrefix:"Хронология"})}catch(e){return{id:a,status:`ошибка buildChronoHtml: ${e?.message||e}`}}try{p=await n(s,{content:u})}catch(e){return{id:a,status:`ошибка сохранения: ${e?.message||e}`}}const m=function(e){const t=(e&&(e.status||e.result||e.ok))??"unknown";return!0===t||"ok"===t||"saved"===t||"success"===t?"обновлено":"forbidden"===t||"noaccess"===t?"нет доступа":"notfound"===t?"страница не найдена":String(t)}(p);return{id:a,status:m,page:s}}function a(e){const t=String(e||"").toLowerCase();return t.includes("нет доступа")?"нет доступа":t.includes("нет данных")||t.includes("не найден")?"пользователь не упоминается в хронологии":""}window.FMV||(window.FMV={}),"function"!=typeof window.userLinkHtml&&(window.userLinkHtml=(e,t)=>`${FMV.escapeHtml(String(t||e))}`),createForumButton({allowedGroups:e,allowedForums:t,label:"обновить личные страницы",order:4,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),r=e?.setDetails||(()=>{});r("");try{t("Собираю…");const e=Array.isArray(window.CHRONO_CHECK?.UserIDs)?window.CHRONO_CHECK.UserIDs:void 0,s=await async function(e){const t=window.FMV&&"function"==typeof FMV.fetchUsers?FMV.fetchUsers:null;let n=[];if(Array.isArray(e)&&e.length)n=e.map(e=>({id:String(e)}));else if(t)try{const e=await t();n=Array.isArray(e)?e:[]}catch{}const r=new Map;for(const e of n){if(!e)continue;const t=String(e.id??""),n=String(e.name??"").trim();t&&r.set(t,n||t)}return r}(e);t("Обновляю…");const l=await async function(e={}){const t=Number.isFinite(e.delayMs)?e.delayMs:200;let n;if(Array.isArray(e.ids)&&e.ids.length)n=e.ids.map(e=>({id:String(e)}));else{const e=o("FMV.fetchUsers");if("function"!=typeof e)throw new Error("Не заданы ids и отсутствует FMV.fetchUsers()");const t=await e();n=Array.isArray(t)?t:[]}const r=[];for(const o of n){const n=await i(o.id,{sections:e.sections});r.push(n),t&&await FMV.sleep(t)}try{console.table(r.map(e=>({id:e.id,status:e.status})))}catch{}return r}({ids:e,sections:n}),c=[];for(const e of l||[]){const t=a(e?.status);if(!t)continue;const n=String(e?.id||""),r=s.get(n)||n;c.push(`${userLinkHtml(n,r)} — ${FMV.escapeHtml(t)}`)}t("Готово"),r(c.length?c.join("\n"):"")}catch(e){t("Ошибка"),r(e?.message||String(e))}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_update_total] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,i=window.CHRONO_CHECK.ForumInfo;let a=!1;function s(e="",t=200){const n=String(e).replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"…":n}createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить общее хроно",order:1,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть ссылку",linkHref:o,async onClick(t){if(a)return;a=!0;const n=t?.setStatus||(()=>{}),l=t?.setDetails||(()=>{});t?.setLinkVisible?.(!1),t?.setLink?.("","");try{if(n("Собираю…"),l(""),"function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");const a=await collectEpisodesFromForums({sections:i});n("Формирую текст…");const d=function(e){const t=(e||[]).map(e=>{const t=renderStatus(e.type,e.status),n="au"===e.type?"":e.dateStart?`[b]${FMV.escapeHtml(e.dateEnd&&e.dateEnd!==e.dateStart?`${e.dateStart}-${e.dateEnd}`:e.dateStart)}[/b]`:"[mark]дата не указана[/mark]",r=FMV.escapeHtml(e.href||""),o=FMV.escapeHtml(e.title||""),i=e.isTitleNormalized?"":"au"===e.type?" [mark]в названии нет [au][/mark]":" [mark]в названии нет [с][/mark]",a=`${FMV.escapeHtml(String(e.order??0))}`,s=!0;return`${n}${n?" — ":" "}[url=${r}]${o}[/url]${i}\n[${t} / ${a}]\n[i]${Array.isArray(e.participants)&&e.participants.length?e.participants.map(e=>{const t=null!=e.id&&""!==e.id?userLink(String(e.id),e.name,s):missingUser(String(e.name||""),s),n=Array.isArray(e.masks)?e.masks:[];return`${t}${n.length?` [as ${FMV.escapeHtml(n.join(", "))}]`:""}`}).join(", "):"[mark]не указаны[/mark]"}[/i]\n${e.location?FMV.escapeHtml(e.location):"[mark]локация не указана[/mark]"}\n\n`});return`[media="Общая хронология"]${t.join("")||""}[/media]`}(a);n("Записываю…");const u=FMV.toCp1251Entities(d),p=await FMV.replaceComment(e,r,u),m=null==(c=p.status)?"":"string"==typeof c?c:String("object"==typeof c?c.status||c.code||(c.ok?"ok":"unknown"):c),f=!!p.ok||"ok"===m;n(f?"Готово":"Ошибка"),f?(t?.setLink?.(o,"Открыть ссылку"),t?.setLinkVisible?.(!0)):(t?.setLink?.("",""),t?.setLinkVisible?.(!1));const h=s(p.infoMessage||""),g=s(p.errorMessage||""),y=[`Статус: ${f?"ok":m||"unknown"}`];h&&y.push(h),g&&y.push(`<span style="color:#b00020">${FMV.escapeHtml(g)}</span>`),l(y.join("<br>"))}catch(e){n("Ошибка"),l(FMV.escapeHtmlShort(e?.message||String(e))),t?.setLinkVisible?.(!1),t?.setLink?.("","")}finally{a=!1}var c}}),"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`)})(),function(){"use strict";var e;window.FMV||(window.FMV={}),window.FMV.fetchUsers||console.warn("[FMV] Подключите общий модуль с FMV.fetchUsers до ui.js"),window.FMV.UI||function(){function e(e){const t=String(e||"").match(/\[FMVcast\]([\s\S]*?)\[\/FMVcast\]/i),n=t&&t[1]?(r=t[1],String(r||"").split(";").map(e=>e.trim()).filter(Boolean)):[];var r;const o={};return n.forEach(e=>{const t=e.match(/^(user\d+)(?:=(.+))?$/i);if(!t)return;const n=t[1],r=(t[2]||"").trim(),i=o[n]||(o[n]={code:n,masks:[]});r&&i.masks.push(r)}),o}function t(e){const t=[];return(e||[]).forEach(e=>{const n=Array.isArray(e.masks)?e.masks.filter(Boolean):[];n.length?n.forEach(n=>t.push(e.code+"="+n)):t.push(e.code)}),t.length?"[FMVcast]"+t.join(";")+"[/FMVcast]":""}function n(e){return(e=String(e||"").trim())?"[FMVplace]"+e+"[/FMVplace]":""}function r(e){let t=parseInt(String(e||"").trim(),10);return Number.isNaN(t)&&(t=0),"[FMVord]"+t+"[/FMVord]"}function o(e){return String(e||"").replace(/\[FMVcast\][\s\S]*?\[\/FMVcast\]/gi,"").replace(/\[FMVplace\][\s\S]*?\[\/FMVplace\]/gi,"").replace(/\[FMVord\][\s\S]*?\[\/FMVord\]/gi,"").replace(/^\s+|\s+$/g,"")}let i=!1;window.FMV.UI={attach:function(a){!function(){if(i)return;i=!0;const e=document.createElement("style");e.textContent="\n        :root{\n          --fmv-bg:#f7f4ea; --fmv-b:#d8d1c3; --fmv-chip:#fff;\n          --fmv-radius:10px; --fmv-gap:8px; --fmv-text:#2d2a26; --fmv-muted:#6b6359;\n        }\n\n        .msg-with-characters.fmv,\n        .msg-with-characters.fmv * { box-sizing: border-box; }\n        .msg-with-characters.fmv { width:100%; max-width:100%; overflow-x:hidden; }\n\n        .msg-with-characters.fmv{margin:10px 0; padding:10px; border:1px solid var(--fmv-b); background:var(--fmv-bg); border-radius:var(--fmv-radius)}\n        .fmv .char-row{display:flex; gap:var(--fmv-gap); align-items:flex-start; flex-wrap:wrap}\n        .fmv .combo{position:relative; flex:1 1 480px; width:100%; max-width:100%}\n        .fmv .combo input,\n        .fmv .place-row input,\n        .fmv .order-row input{\n          width:100%; max-width:100%; height:36px;\n          padding:8px 10px; border:1px solid var(--fmv-b); border-radius:8px;\n          background:#efe9dc; color:var(--fmv-text); font-size:14px;\n        }\n        .fmv .place-row,.fmv .order-row{margin-top:8px; width:100%; max-width:100%}\n        .fmv .order-row label{display:block; margin-bottom:4px; font-weight:600; color:var(--fmv-text)}\n        .fmv .order-hint,.fmv .hint{font-size:12.5px; color:var(--fmv-muted); margin-top:4px; overflow-wrap:anywhere}\n\n        .fmv .ac-list{\n          position:absolute; z-index:50; left:0; right:0; max-width:100%; background:#fff;\n          border:1px solid var(--fmv-b); border-radius:8px; margin-top:4px; max-height:240px; overflow:auto\n        }\n        .fmv .ac-item{padding:.45em .65em; cursor:pointer; font-size:14px}\n        .fmv .ac-item.active,.fmv .ac-item:hover{background:#f0efe9}\n        .fmv .ac-item .muted{color:var(--fmv-muted)}\n\n        .fmv .chips{ max-width:100%; overflow-x:hidden; }\n        .fmv .chips .chip{\n          display:flex; align-items:center; justify-content:flex-start;\n          gap:10px; padding:.45em .6em; background:var(--fmv-chip);\n          border:1px solid var(--fmv-b); border-radius:8px; margin:.35em 0; font-size:14px\n        }\n        .fmv .chip .drag{cursor:grab; margin-right:.4em; color:#8b8378}\n        .fmv .chip .name{font-weight:600}\n\n        .fmv .masks{display:flex; align-items:center; gap:6px; flex-wrap:wrap; color:var(--fmv-muted)}\n        .fmv .masks .masks-label{ color:var(--fmv-muted); margin-right:2px; }\n        .fmv .mask-badge{\n          display:inline-flex; align-items:center; gap:6px;\n          padding:2px 8px; border:1px solid var(--fmv-b); border-radius:999px;\n          background:#efe9dc; font-size:13px; color:var(--fmv-text);\n        }\n        .fmv .mask-badge .mask-remove{\n          border:0; background:none; cursor:pointer; line-height:1;\n          color:#8b8378; font-size:14px; padding:0 2px;\n        }\n\n        .fmv .chip .add-mask{border:0; background:none; color:#2e5aac; cursor:pointer; padding:0; text-decoration:underline; margin-left:auto}\n        .fmv .chip .x{border:0; background:none; font-size:16px; line-height:1; cursor:pointer; color:#8b8378; margin-left:8px}\n\n        .fmv .chip .mask-input{ display:none; margin-left:auto; }\n        .fmv .chip .mask-input.is-open{ display:flex; align-items:center; gap:8px; }\n        .fmv .chip .mask-input input{\n          flex:1; min-width:220px; height:30px;\n          padding:6px 8px; border:1px solid var(--fmv-b); border-radius:6px;\n          background:#efe9dc; color:var(--fmv-text);\n        }\n        .fmv .chip .btn{ border:1px solid var(--fmv-b); border-radius:6px; background:#fff; padding:6px 10px; cursor:pointer; line-height:1; }\n        .fmv .chip .btn-ok{ background:#e9f6e9; }\n        .fmv .chip .btn-cancel{ background:#f4eeee; }\n\n        .fmv-admin-tools{display:flex;justify-content:flex-end;margin:6px 0 8px}\n        .fmv-admin-tools .fmv-toggle{border:1px solid var(--fmv-b);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}\n\n        /* заголовок блока */\n        .fmv .section-title{\n          font-weight:700;\n          font-size:14px;\n          text-align: center;\n          line-height:1.25;\n          margin:4px 0 12px;\n          color: var(--fmv-text);\n        }\n\n        /* делаем «колонку» с равным шагом и без внутренних margin */\n        .fmv .combo,\n        .fmv .place-row,\n        .fmv .order-row {\n          display: grid;\n          grid-template-columns: 1fr;\n          row-gap: 8px;             /* вот этим управляем расстоянием между label ↔ input ↔ hint */\n        }\n        \n        .fmv .place-row label,\n        .fmv .order-row label,\n        .fmv .combo label,\n        .fmv .place-row .hint,\n        .fmv .order-row .order-hint,\n        .fmv .combo .hint {\n          margin: 0;                /* убираем наследованные отступы, чтобы они не «схлопывались» */\n        }\n        \n        /* (оставляем общий верхний зазор секции) */\n        .fmv .place-row, .fmv .order-row { margin-top: 8px; }\n\n        .fmv .chip .name { font-weight: 600; }\n        .fmv .chip .name .name-code { font-weight: 400; color: var(--fmv-muted); }\n\n        ",document.head.appendChild(e)}();const s="string"==typeof a.form?$(a.form):a.form,l="string"==typeof a.textarea?$(a.textarea):a.textarea;if(!s?.length||!l?.length)return null;const c=l.val()||"",d=/\[FMV(?:cast|place|ord)\][\s\S]*?\[\/FMV(?:cast|place|ord)\]/i.test(c);if(a.showOnlyIfFMVcast&&!d)return null;if(a.stripOnMount&&l.val(o(c)),s.data("fmvBoundUI"))return s.data("fmvBoundUI");const u="msg-with-characters fmv "+(a.className||""),p=$("<div/>",{class:u}),m=$('<div class="section-title">Для автоматического сбора хронологии</div>'),f=$('<div class="char-row"/>'),h=$('<div class="combo"/>'),g=$('<label for="character-combo" style="font-weight:600;display:block;margin-bottom:4px">Участники эпизода:</label>'),y=$('<input type="text" id="character-combo" placeholder="Наберите имя персонажа…" autocomplete="off">'),w=$('<div class="ac-list" role="listbox" aria-label="Варианты персонажей"></div>'),v=$('<div class="hint">Если что-то не работает, напишите в Приемную.</div>');h.append(g,y,w,v),f.append(h);const b=$('<div class="chips"/>'),S=$('<div class="place-row"/>'),x=$('<label for="fmv-place" style="font-weight:600">Локация:</label>'),C=$('<input type="text" id="fmv-place" placeholder="Укажите локацию">'),k=$('<div class="hint">Лучше указывать в едином формате: Хогвартс, Косой переулок, Лютный переулок, Министерство и т.д.</div>');S.append(x,C,k);const E=$('<div class="order-row"/>'),F=$('<label for="fmv-ord" style="font-weight:600">Для сортировки эпизодов в один день</label>'),I=$('<input type="number" id="fmv-ord" placeholder="0" value="0" step="1">'),M=$('<div class="order-hint">Помогает упорядочить эпизоды, которые стоят в один день. Чем больше значение, тем позже эпизод. Лучше оставлять 0.</div>');E.append(F,I,M),l.before(p),p.append(m,f,b,S,E);let _=[],L=[];function A(){b.empty(),_.forEach(function(e,t){const n=$('<div class="chip" draggable="true" data-idx="'+t+'"/>');n.append('<span class="drag" title="Перетащите для изменения порядка">↕</span>');const r=$('<span class="name"/>');r.append(document.createTextNode(e.name+" ")),r.append($('<span class="name-code"/>').text("("+e.code+")")),n.append(r);const o=$('<span class="masks"/>');e.masks?.length?(o.append('<span class="masks-label">— маски:</span>'),e.masks.forEach(function(e,t){const n=$('<span class="mask-badge" data-mi="'+t+'"><span class="mask-text"></span><button type="button" class="mask-remove" aria-label="Удалить маску">×</button></span>');n.find(".mask-text").text(e),o.append(n)})):o.text(" — масок нет");const i=$('<button class="add-mask" type="button">добавить маску</button>'),a=$('<button class="x" type="button" aria-label="Удалить">×</button>'),s=$('<span class="mask-input"></span>').hide(),l=$('<input type="text" placeholder="маска (текст)">'),c=$('<button type="button" class="btn btn-ok">Ок</button>'),d=$('<button type="button" class="btn btn-cancel">Отмена</button>');s.append(l,c,d),l.on("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),c.click())}),i.on("click",()=>{n.find(".mask-input").removeClass("is-open").hide(),s.addClass("is-open").show(),l.val("").focus()}),c.on("click",()=>{const t=$.trim(l.val());t&&((e.masks||(e.masks=[])).push(t),A())}),d.on("click",()=>{s.removeClass("is-open").hide()}),a.on("click",()=>{_.splice(t,1),A()}),n.append(o,i,s,a),b.append(n)})}function H(e){if(!e||_.some(t=>t.code===e))return;const t=L.find(t=>t.code===e);_.push({code:e,name:t?t.name:e,masks:[]}),A(),y.val(""),w.hide().empty()}function D(e){const t=(e||"").trim().toLowerCase(),n=L.filter(e=>!_.some(t=>t.code===e.code)).filter(e=>!t||e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)).slice().sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));w.empty(),n.length?(n.slice(0,40).forEach(e=>{w.append($('<div class="ac-item" role="option"/>').attr("data-code",e.code).text(e.name+" ("+e.code+")"))}),w.show(),P(0)):w.append('<div class="ac-item"><span class="muted">Ничего не найдено</span></div>').show()}function P(e){const t=w.children(".ac-item");t.removeClass("active"),t.length&&(e=(e+t.length)%t.length,t.eq(e).addClass("active"),w.data("activeIndex",e))}if(b.on("dragstart",".chip",function(e){$(this).addClass("dragging"),e.originalEvent.dataTransfer.setData("text/plain",$(this).data("idx"))}),b.on("dragend",".chip",function(){$(this).removeClass("dragging")}),b.on("dragover",function(e){e.preventDefault()}),b.on("drop",function(e){e.preventDefault();const t=+e.originalEvent.dataTransfer.getData("text/plain"),n=$(e.target).closest(".chip");if(!n.length)return;const r=+n.data("idx");if(isNaN(t)||isNaN(r)||t===r)return;const o=_.splice(t,1)[0];_.splice(r,0,o),A()}),b.on("click",".mask-remove",function(){const e=+$(this).closest(".chip").data("idx"),t=+$(this).closest(".mask-badge").data("mi");isNaN(e)||isNaN(t)||!Array.isArray(_[e].masks)||(_[e].masks.splice(t,1),A())}),y.on("input",function(){D(this.value)}),y.on("keydown",function(e){const t=0|w.data("activeIndex");if("ArrowDown"===e.key&&w.is(":visible"))e.preventDefault(),P(t+1);else if("ArrowUp"===e.key&&w.is(":visible"))e.preventDefault(),P(t-1);else if("Enter"===e.key){e.preventDefault();const t=w.is(":visible")?function(){const e=0|w.data("activeIndex");return w.children(".ac-item").eq(e).data("code")}():function(){const e=($.trim(y.val())||"").toLowerCase();if(!e)return null;const t=L.filter(e=>!_.some(t=>t.code===e.code)),n=t.find(t=>t.name.toLowerCase()===e)||t.find(t=>t.code.toLowerCase()===e);if(n)return n.code;const r=t.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e));if(1===r.length)return r[0].code;const o=r.filter(t=>t.name.toLowerCase().startsWith(e));return 1===o.length?o[0].code:null}();t?H(t):D(this.value)}else"Escape"===e.key&&w.hide()}),w.on("mousedown",".ac-item",function(){const e=$(this).data("code");e&&H(e)}),$(document).on("click",function(e){$(e.target).closest(h).length||w.hide()}),"function"==typeof FMV.fetchUsers&&FMV.fetchUsers().then(function(t){L=(t||[]).slice(),!1!==a.prefill&&function(t){_=[];const n=e(t||""),r=String(t||"").match(/\[FMVplace\]([\s\S]*?)\[\/FMVplace\]/i);r&&"string"==typeof r[1]&&C.val(r[1].trim());const o=String(t||"").match(/\[FMVord\]([\s\S]*?)\[\/FMVord\]/i);if(o&&"string"==typeof o[1]){let e=parseInt(o[1].trim(),10);Number.isNaN(e)&&(e=0),I.val(e)}Object.keys(n).forEach(e=>{const t=L.find(t=>t.code===e);_.push({code:e,name:t?t.name:e,masks:n[e].masks})}),A()}(c)}).catch(function(e){w.html('<div class="ac-item"><span class="muted">'+(e||"Ошибка загрузки")+"</span></div>").show()}),s.off("submit.fmv.ui").on("submit.fmv.ui",function(e){const i=s.find('input[name="req_subject"]'),a=!i.length||$.trim(i.val()||"").length>0,c=o(l.val()||""),d=$.trim(c).length>0,u=_.length>0,p=$.trim(C.val()||"").length>0;if(!(a&&d&&u&&p)){e.preventDefault(),"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation(),"function"==typeof e.stopPropagation&&e.stopPropagation();const t=[];return a||t.push("Заголовок"),d||t.push("Основной текст"),u||t.push("Участники"),p||t.push("Локация"),alert("Заполните: "+t.join(", ")),!1}const m=[t(_),n(C.val()),r(I.val())].filter(Boolean).join("");let f=c.replace(/[ \t]+$/,"");const h=!f||/\n$/.test(f)?"":"\n";l.val(f+h+m)}),function(){const e=(window.CHRONO_CHECK?.GroupID||[]).map(String),t=(window.CHRONO_CHECK?.AllowedUser||[]).map(String),n="function"==typeof window.getCurrentGroupId?String(window.getCurrentGroupId()):"",r="function"==typeof window.getCurrentUserId?String(window.getCurrentUserId()):"";return n&&e.includes(n)||r&&t.includes(r)}()){let e=s.data("fmvAdminTools");e&&e.length||(e=$('<div class="fmv-admin-tools"><button type="button" class="fmv-toggle">Режим ручного редактирования</button></div>'),s.data("fmvAdminTools",e)),p.before(e);const i=e.find(".fmv-toggle");i.off("click.fmv");const a=()=>{const e=[t(_),n(C.val()),r(I.val())].filter(Boolean).join(""),a=o(l.val()||"").replace(/[ \t]+$/,""),c=!a||/\n$/.test(a)?"":"\n";l.val(a+(e?c+e:"")),p.remove(),s.off("submit.fmv.ui").removeData("fmvBoundUI"),i.data("raw",!0).text("Вернуться к удобной форме")},c=()=>{FMV.UI.attach({form:s,textarea:l,prefill:!0,showOnlyIfFMVcast:!1,className:"fmv--compact",stripOnMount:!0}),i.data("raw",!1).text("Режим ручного редактирования")};i.on("click.fmv",()=>i.data("raw")?c():a())}const T={serialize:()=>[t(_),n(C.val()),r(I.val())].filter(Boolean).join(""),stripFMV:o,mountPoint:p};return s.data("fmvBoundUI",T),T}}}(),e=function(){if(window.__FMV_BOOTSTRAPPED__)return;if(window.__FMV_BOOTSTRAPPED__=!0,!FMV.UI||"function"!=typeof FMV.UI.attach)return;const e=new URL(location.href),t=e.pathname,n=e.searchParams;function r({strip:e=!1,showOnlyIfCast:t=!1}={}){const n=$('#post form, form[action*="post.php"], form[action*="edit.php"]').first(),r=n.find('textarea[name="req_message"], #main-reply, .questionary-post textarea').first();return n.length&&r.length?FMV.UI.attach({form:n,textarea:r,prefill:!0,showOnlyIfFMVcast:!!t,className:"fmv--compact",stripOnMount:!!e}):null}if(/\/post\.php$/i.test(t)&&!n.has("action")){const e=+(n.get("fid")||0);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(e)&&r({strip:!1,showOnlyIfCast:!1})}if(/\/edit\.php$/i.test(t)&&"1"===n.get("topicpost")&&r({strip:!0,showOnlyIfCast:!0}),/\/post\.php$/i.test(t)&&"post"===n.get("action")){if(n.has("tid"))return;const e=Number(n.get("fid")),t=(window.CHRONO_CHECK?.ForumID||[]).map(Number);e&&!t.includes(e)||r({strip:!0,showOnlyIfCast:!1})}/\/edit\.php$/i.test(t)&&n.has("id")&&document.querySelector('input[name="firstpost"]')&&r({strip:!0,showOnlyIfCast:!1})},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}(),(()=>{"use strict";const e="Показать скрытые теги";async function t(e,{timeout:t=1e4,interval:n=100}={}){const r=performance.now();for(;performance.now()-r<t;){try{const t=e();if(t)return t}catch{}await FMV.sleep(n)}return null}function n(){const t=document.querySelector(".ams_info");return t&&Array.from(t.querySelectorAll("div[data-order]")).find(t=>{const n=t.querySelector("button.button");return 1===Number(t.dataset.order)&&n&&n.textContent.trim()===e})||null}async function r(){if(!await t(()=>window.FMV&&"function"==typeof FMV.readTagText&&"function"==typeof FMV.escapeHtml&&"function"==typeof FMV.parseOrderStrict&&"function"==typeof FMV.buildIdToNameMapFromTags&&"function"==typeof FMV.parseCharactersUnified&&"function"==typeof window.profileLink,{timeout:15e3}))return null;const e=await t(()=>document.querySelector(".topic .post.topicpost, .post.topicpost, .message:first-of-type"),{timeout:15e3});if(!e)return null;const n=window.CHRONO_CHECK?.GroupID||[];if("function"==typeof window.ensureAllowed&&!window.ensureAllowed(n))return null;const r=FMV.readTagText(e,"characters"),o=FMV.readTagText(e,"location"),i=FMV.readTagText(e,"order"),a=await FMV.buildIdToNameMapFromTags(r),s=[];if(r){const e=FMV.renderParticipantsHtml(r,a,(e,t)=>window.profileLink(e,t));s.push(`<div class="fmv-row"><span class="fmv-label">Участники:</span>${e}</div>`)}if(o&&s.push(`<div class="fmv-row"><span class="fmv-label">Локация:</span>${FMV.escapeHtml(o)}</div>`),i){const e=FMV.parseOrderStrict(i);s.push(`<div class="fmv-row"><span class="fmv-label">Для сортировки:</span>${e.html}</div>`)}if(!s.length)return null;!function(){if(document.getElementById("fmv-meta-style"))return;const e=document.createElement("style");e.id="fmv-meta-style",e.textContent="\n      .fmv-meta{\n        margin:8px 0; padding:8px; border:1px solid #d7d7d7;\n        background:#f7f7f7; border-radius:6px;\n      }\n      .fmv-row{margin:.25em 0}\n      .fmv-label{font-weight:700;margin-right:.25em}\n      .fmv-missing{color:#c00;background:#ffe6e6;border-radius:6px;padding:0 .25em;font-weight:700}\n    ",document.head.appendChild(e)}();const l=document.createElement("div");return l.className="fmv-meta",l.innerHTML=s.join("\n"),l}async function o(){const e=n();if(!e)return;!function(){const e=n(),t=e?.nextElementSibling;t&&t.classList.contains("fmv-meta")&&t.remove()}();const t=await r();t&&e.parentNode.insertBefore(t,e.nextSibling)}window.CHRONO_CHECK&&Array.isArray(window.CHRONO_CHECK.GroupID)&&Array.isArray(window.CHRONO_CHECK.ForumID)?createForumButton({allowedGroups:window.CHRONO_CHECK.GroupID,allowedForums:window.CHRONO_CHECK.ForumID,label:e,order:1,showStatus:!1,showDetails:!1,showLink:!1,async onClick({wrap:e}){if(e.nextElementSibling?.classList.contains("fmv-meta"))e.nextElementSibling.remove(),localStorage.setItem("fmv:meta:enabled","0");else{const t=await r();t&&(e.parentNode.insertBefore(t,e.nextSibling),localStorage.setItem("fmv:meta:enabled","1"))}}}):console.warn("[tags_visibility] Требуются CHRONO_CHECK.GroupID, ForumID"),(async()=>{"1"!==localStorage.getItem(function(){try{const e=new URL(location.href);return`fmv:meta:enabled:${e.searchParams.get("id")||e.searchParams.get("tid")||e.pathname}`}catch{return`fmv:meta:enabled:${location.href}`}}())||function(){const e=n(),t=e?.nextElementSibling;return!(!t||!t.classList.contains("fmv-meta"))}()||await o()})()})();