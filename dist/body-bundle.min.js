/*!
 * QuadroBoards Automatizations - BODY BUNDLE
 * @version 1.0.0
 */
function dfm_escape(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function dfm_insertAtCaret(e,t){e.focus();var n="number"==typeof e.selectionStart?e.selectionStart:e.value.length,r="number"==typeof e.selectionEnd?e.selectionEnd:e.value.length;e.value=e.value.slice(0,n)+t+e.value.slice(r),e.selectionStart=e.selectionEnd=n+t.length;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch(e){}}function dfm_hash32(e){var t,n=2166136261;for(t=0;t<e.length;t++)n=16777619*((n^=e.charCodeAt(t))>>>0);return n>>>0}function dfm_prng(e){var t=e>>>0||2654435769;return function(){return t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>=0)/4294967296}}function dfm_rng_int(e,t,n){var r=e();return t+Math.floor(r*(n-t+1))}function dfm_roll_det(e,t,n){var r,o=dfm_prng(n),a=[];for(r=0;r<e;r++)a.push(dfm_rng_int(o,1,t));return a}function dfm_canon(e,t,n){var r=String(parseInt(e,10)),o=String(parseInt(t,10)),a=parseInt(n,10);return r+":"+o+":"+(a=a>=0?"+"+a:""+a)}function dfm_makeSeed(e,t,n){return dfm_hash32("DiceFM|"+((e&&e.id?e.id:"").match(/\d+/)||[0])[0]+"|"+(e&&e.getAttribute("data-posted")||"0")+"|"+t+"|"+n)}function dfm_attach(){var e=document.getElementById("dicefm-btn"),t=document.getElementById("main-reply");e&&t&&e.addEventListener("click",function(){var e=prompt("Сколько дайсов бросаем?","1");if(null!==e){var n=parseInt(e,10);if(n>=1&&n<=100){var r=prompt("Сколько граней у каждого дайса?","6");if(null!==r){var o=parseInt(r,10);if(o>=2&&o<=1e5){var a=prompt("Есть ли бонус/штраф?","+0");if(null!==a)if(a=(a||"").trim(),/^[+-]?\d+$/.test(a)){var i=parseInt(a,10);if(Math.abs(i)>1e5)alert("Абсолютное значение должно быть не больше 100000");else{var s=i>=0?"+"+i:""+i,c=prompt("Причина броска (опционально)","")||"";c=c.replace(/\]/g," ").replace(/\s+/g," ").trim(),dfm_insertAtCaret(t,"[DiceFM "+n+":"+o+":"+s+":"+(c||"")+"]")}}else alert("Нужен формат +1 или -1")}else alert("Значение должно быть в пределах [2;100000]")}}else alert("Значение должно быть в пределах [1;100]")}})}function dfm_render(e,t,n,r,o){var a=parseInt(e,10),i=parseInt(t,10),s=parseInt(n,10);if(!(a>=1&&a<=100&&i>=2&&i<=1e5&&Math.abs(s)<=1e5))throw new Error("Проблема с данными");var c,l=dfm_roll_det(a,i,o),d=0,u="";for(c=0;c<l.length;c++)d+=l[c],u+=(c?"+":"")+l[c];var p="("+u+")"+(0===s?"":s>0?"+"+s:""+s)+"="+(d+s);return'<div class="quote-box"><blockquote style="text-align:left"><p>'+("<b>Бросок "+a+"d"+i+(0===s?"":s>0?" с бонусом "+s:" со штрафом "+s)+"</b>")+(r?"<br><em>"+dfm_escape(r)+"</em>":"")+"<br><br><b>Результат:</b> "+p+"</p></blockquote></div>"}function dfm_replace(e){if(e){var t=e.closest?e.closest(".post"):null,n=e.innerHTML,r={},o=n.replace(/\[(?:DiceFM)\s+(\d+)\s*:\s*(\d+)\s*:\s*([+-]?\d+)\s*:\s*(?:"([^"]*)"|([^\]]*))\s*\]/gi,function(e,n,o,a,i,s){try{var c=((null!=i?i:s)||"").replace(/\s+/g," ").trim(),l=dfm_canon(n,o,a),d=r[l]||0;return r[l]=d+1,dfm_render(n,o,a,c,dfm_makeSeed(t,l,d))}catch(t){return e}});o!==n&&(e.innerHTML=o)}}function dfm_init(){if("undefined"==typeof FORUM||FORUM.topic)for(var e=document.querySelectorAll?document.querySelectorAll(".post-content"):[],t=0;t<e.length;t++)dfm_replace(e[t])}async function pageExistsViaEditEndpoint(e){const t=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,n=await fetchCP1251Doc(t),r=(n.querySelector("title")?.textContent||"").trim(),o=(n.querySelector("h1, .pagetitle, .tclcon h2")?.textContent||"").trim(),a=/Страница создана/i.test(r),i=!!n.querySelector('input[name="edit_page"]'),s=!![...n.querySelectorAll('input[type="submit"],button[type="submit"]')].find(e=>/сохран/i.test(e.value||e.textContent||""));/Информация/i.test(r)||/Информация/i.test(o);return!!(a||i||s)}function extractInfoMessage(e){const t=(new DOMParser).parseFromString(e,"text/html"),n=(t.querySelector("title")?.textContent||"").trim();return(n?`[${n}] `:"")+([...t.querySelectorAll(".message, .msg, .infobox, .warn, .error, #pun-main p, .block p, .box p")].map(e=>e.textContent.trim()).filter(Boolean).join("\n").trim()||"").trim()}function classifyResult(e){const t=extractInfoMessage(e).toLowerCase();return/уже существует|занято|должно быть уникаль/.test(t)?{status:"duplicate",msg:t}:/страница создана|добавлен|успешно|сохранена/.test(t)?{status:"created",msg:t}:/ошибка|forbidden|нет прав|не удалось|некоррект|заполните/.test(t)?{status:"error",msg:t}:{status:"unknown",msg:t}}async function FMVcreatePersonalPage(e,t,n,r,o,a){const i="/admin_pages.php?action=adddel";try{if(await pageExistsViaEditEndpoint(t))return{status:"exists",title:e,name:t,serverMessage:`Страница "${t}" уже существует (до отправки формы).`,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`};const s=await fetchCP1251Doc(i),c=[...s.querySelectorAll("form")].find(e=>(e.action||"").includes("/admin_pages.php"))||s.querySelector('form[action*="admin_pages.php"]');if(!c)return{status:"error",title:e,name:t,serverMessage:"Форма добавления не найдена",details:"admin_pages.php без формы"};(c.querySelector('[name="title"]')||{}).value=e,(c.querySelector('[name="name"]')||{}).value=t,(c.querySelector('[name="content"]')||{}).value=n;const l=c.querySelector('[name="tags"]');l&&(l.value=r);const d=c.querySelector('select[name="announcement"]');d?d.value=a:[...c.querySelectorAll('input[name="announcement"]')].forEach(e=>e.checked=e.value===a);for(const e of o){const t=c.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}let u="add_page";const p=[...c.elements].find(e=>"submit"===e.type&&("add_page"===e.name||/создать/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(c,u),{res:f,text:h}=await fetchCP1251Text(i,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:i,referrerPolicy:"strict-origin-when-cross-origin",body:m}),g=classifyResult(h),y=extractInfoMessage(h)||"",w=await pageExistsViaEditEndpoint(t);return"created"===g.status||w?(console.log(y||"Страница создана"),{status:"created",title:e,name:t,serverMessage:y||"Страница создана",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"duplicate"===g.status?(console.log(y||"Уже существует страница с таким адресным именем"),{status:"exists",title:e,name:t,serverMessage:y||"Уже существует страница с таким адресным именем",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"error"===g.status?(console.log(g.msg||y||"Ошибка при создании"),{status:"error",title:e,name:t,serverMessage:g.msg||y||"Ошибка при создании",httpStatus:f.status}):(console.log(y||"Не удалось подтвердить создание. Проверьте админку."),{status:"uncertain",title:e,name:t,serverMessage:y||"Не удалось подтвердить создание. Проверьте админку.",httpStatus:f.status})}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,console.log(t),n}}async function FMVeditPersonalPage(e,t={}){if(!e)throw new Error('FMVeditPersonalPage: "name" is required');const n=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,r=await("function"==typeof fetchCP1251Doc?fetchCP1251Doc(n):(async()=>{const e=await fetch(n,{credentials:"include"}).then(e=>e.text());return(new DOMParser).parseFromString(e,"text/html")})()),o=(r.body&&r.body.textContent||"").trim();if(/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(o))return{status:"forbidden",serverMessage:"Ссылка неверная или устаревшая",url:n};const a=[...r.querySelectorAll("form")].find(e=>(e.action||"").includes("admin_pages.php"))||r.querySelector("form");if(!a)return{status:"notfound",serverMessage:"Форма редактирования не найдена",url:n};if(null!=t.title){const e=a.querySelector('[name="title"]');e&&(e.value=String(t.title))}if(null!=t.content){const e=a.querySelector('#page-content,[name="content"]');e&&(e.value=String(t.content))}if(null!=t.announcement){const e=a.querySelector('select[name="announcement"]');if(e)e.value=String(t.announcement);else{const e=[...a.querySelectorAll('input[name="announcement"]')];e.length&&e.forEach(e=>e.checked=e.value==t.announcement)}}if(null!=t.tags){const e=a.querySelector('[name="tags"]');e&&(e.value=String(t.tags))}if(Array.isArray(t.groupsOn))for(const e of t.groupsOn){const t=a.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}if(Array.isArray(t.groupsOff))for(const e of t.groupsOff){const t=a.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!1)}let i="save";const s=[...a.elements].find(e=>"submit"===e.type&&("save"===e.name||/сохр|save/i.test(e.value||e.textContent||"")));let c,l;s?.name&&(i=s.name);const d=new URL(a.getAttribute("action")||n,location.origin).toString();if("function"==typeof serializeFormCP1251_SelectSubmit&&"function"==typeof fetchCP1251Text){const e=serializeFormCP1251_SelectSubmit(a,i);({res:c,text:l}=await fetchCP1251Text(d,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=windows-1251"},referrer:n,referrerPolicy:"strict-origin-when-cross-origin",body:e}))}else{const e=new FormData(a);e.append(i,s?.value||"1"),c=await fetch(d,{method:"POST",credentials:"include",body:e}),l=await c.text()}const u=/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(l),p=("function"==typeof extractInfoMessage?extractInfoMessage(l):"")||"",m=c.ok&&c.url&&/\/admin_pages\.php(?:\?|$)/.test(c.url)&&!/ошибк|forbidden|нет прав|устаревш/i.test((l||"").toLowerCase()),f=/Администрировани[ея]\s*[–-]\s*Страниц[ыь]/i.test(l)||/Список\s+персональных\s+страниц/i.test(l);if(c.ok&&(u||m||f))return{status:"saved",serverMessage:p||"Изменения сохранены",httpStatus:c.status,url:n};let h={status:"unknown",msg:p};if("function"==typeof classifyResult)try{h=classifyResult(l)}catch{}return/ошибк|forbidden|нет прав|устаревш/i.test((p||h.msg||"").toLowerCase())?{status:"forbidden",serverMessage:p||h.msg||"Нет прав/ошибка сохранения",httpStatus:c.status,url:n}:{status:"error",serverMessage:p||"Ошибка сохранения",httpStatus:c.status,url:n}}async function FMVeditTextareaOnly(e,t){return FMVeditPersonalPage(e,{content:t})}window.jQuery?(jQuery(function(){dfm_attach(),dfm_init()}),jQuery(document).on("pun_post",function(){dfm_init()}),jQuery(document).on("pun_edit",function(){dfm_init()})):document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){dfm_attach(),dfm_init()}),$.fn.fixDashes=function(){var e="[\\s\\u00A0\\u202F\\u2009\\u2002-\\u2008\\u200A\\u200B\\uFEFF\\u200C\\u200D]",t=new RegExp(e),n=new RegExp("^"+e+"*$");function r(e){return!!e&&t.test(e)}function o(e){return!e||n.test(e)}function a(e){return"-"===e||"−"===e||e&&e>="‐"&&e<="―"}var i=new RegExp("("+e+")(?:-|[\\u2010-\\u2015]|\\u2212)(?="+e+")","g"),s=new RegExp(e+"(?:-|[\\u2010-\\u2015]|\\u2212)"+e+"*$"),c={ADDRESS:1,ARTICLE:1,ASIDE:1,BLOCKQUOTE:1,DIV:1,DL:1,DT:1,DD:1,FIELDSET:1,FIGCAPTION:1,FIGURE:1,FOOTER:1,FORM:1,H1:1,H2:1,H3:1,H4:1,H5:1,H6:1,HEADER:1,HR:1,LI:1,MAIN:1,NAV:1,OL:1,P:1,PRE:1,SECTION:1,TABLE:1,THEAD:1,TBODY:1,TFOOT:1,TR:1,TD:1,TH:1,UL:1},l={SCRIPT:1,STYLE:1,CODE:1,PRE:1,KBD:1,SAMP:1};function d(e){for(var t=e.length-1;t>=0;t--)if(!r(e.charAt(t)))return t;return-1}function u(e){for(var t=0;t<e.length;t++)if(!r(e.charAt(t)))return t;return-1}function p(e){for(var t,n=[e];n.length;)for(t=n.shift().firstChild;t;t=t.nextSibling){if(3===t.nodeType&&!o(t.nodeValue))return t;if(1===t.nodeType){var r=t.nodeName.toUpperCase();if(l[r])continue;n.push(t)}}return null}function m(e){for(var t=e;t;t=t.parentNode)if(1===t.nodeType){var n=t.className||"";if("string"==typeof n&&-1!==n.indexOf("quote-box")&&-1!==n.indexOf("spoiler-box")&&-1!==n.indexOf("media-box"))return!0}return!1}function f(e,t){if(e&&t){var n=e.nodeValue;if(s.test(n)){var o=d(n);if(-1!==o){var i=n.charAt(o),c=o>0?n.charAt(o-1):"";if(a(i)&&r(c)){var l=t.nodeValue;l.length&&r(l.charAt(0))&&(e.nodeValue=n.slice(0,o)+"—"+n.slice(o+1))}}}}}function h(e,t){try{if("text/html"!==(e.getAttribute("type")||"").toLowerCase())return;var n=e.text||e.textContent||"";if(!n)return;var r=document.createElement("div");r.innerHTML=n,t(r);var o=r.innerHTML;e.text=o,e.textContent=o}catch(e){}}function g(e){var t=null,n=!1;!function y(w){for(var v=w.firstChild;v;v=v.nextSibling)if(3===v.nodeType){var b=v.nodeValue;if(o(b)){t&&(n=!0);continue}b=b.replace(i,"$1—");var S=!t||n||t&&t.nodeValue.length&&r(t.nodeValue.charAt(t.nodeValue.length-1)),C=u(b);if(S&&-1!==C&&a(b.charAt(C)))r(C+1<b.length?b.charAt(C+1):"")&&(b=b.slice(0,C)+"—"+b.slice(C+1));if(v.nodeValue=b,t){var x=t.nodeValue,k=b.length&&r(b.charAt(0));if(s.test(x)){var E=d(x);if(-1!==E){var $=x.charAt(E),F=E>0?x.charAt(E-1):"";a($)&&r(F)&&(k||n)&&(t.nodeValue=x.slice(0,E)+"—"+x.slice(E+1))}}}t=v,n=!1}else if(1===v.nodeType){var M=v.nodeName.toUpperCase();if("SCRIPT"===M&&m(v)){h(v,g),t=null,n=!1;continue}if(l[M]){t=null,n=!1;continue}if("BR"===M){t=null,n=!1;continue}if(c[M]&&v!==e)g(v),t=null,n=!1;else{if(t){var _=p(v);_&&f(t,_)}y(v)}}}(e)}return this.each(function(){g(this)})},$(function(){$(".post-content").fixDashes()}),(()=>{const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});(async()=>{try{await e;Number(document.body?.dataset?.groupId||NaN);const t=window.GroupID?Number(window.GroupID):null,n=[...window.PROFILE_CHECK?.GroupID||[],...window.CHRONO_CHECK?.GroupID||[]],r=[...window.PROFILE_CHECK?.ForumID||[],...window.CHRONO_CHECK?.ForumID||[],...window.CHRONO_CHECK?.AmsForumID||[]],o=n.includes(t),a=document.querySelector(".container.crumbs"),i=a&&Array.from(a.querySelectorAll("a[href]")).some(e=>{try{const t=new URL(e.getAttribute("href"),location.href),n=t.searchParams.get("id"),o=!!n&&r.includes(Number(n));return t.pathname.endsWith("/viewforum.php")&&o}catch{return!1}});if(!o||!i)return;let s=document.querySelectorAll(".topicpost .post-body .post-box .post-content");if(!s.length)try{await FMV.waitForSelector(".topicpost .post-body .post-box .post-content",5e3),s=document.querySelectorAll(".topicpost .post-body .post-box .post-content")}catch{return}const c=s[s.length-1];if(!c||c.querySelector(".ams_info"))return;const l=document.createElement("div");l.className="ams_info",l.textContent="",c.appendChild(document.createElement("br")),c.appendChild(l),window.__ams_ready=!0,window.dispatchEvent(new CustomEvent("ams:ready",{detail:{node:l}})),"function"==typeof window.__amsReadyResolve&&window.__amsReadyResolve(l)}catch(e){console.log("[AMS injector] error:",e)}})()})(),function(){async function e(e){if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(e),!0}catch(e){}return function(){try{return document.execCommand&&document.execCommand("copy")}catch(e){return!1}}()}let t=null;function n(){try{const e=window.getSelection&&window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges(),document.selection&&document.selection.empty&&document.selection.empty()}catch(e){}try{document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}catch(e){}const e=document.body,t=e.style.userSelect,n=e.style.webkitUserSelect;e.style.userSelect="none",e.style.webkitUserSelect="none",e.offsetHeight,e.style.userSelect=t,e.style.webkitUserSelect=n}function r(e){(function(e){return!!t&&!t.contains(e)})(e.target||e.srcElement)&&(t=null,n())}function o(n){!function(e){let t=e.querySelector(".legend");if(t||(t=document.createElement("strong"),t.className="legend",e.insertBefore(t,e.firstChild)),!t.dataset.copyReady){if(!t.querySelector(".code-copy")){let e=(t.textContent||"").trim();e&&!/^код:?\s*$/i.test(e)||(e="Скопировать код"),t.textContent="";const n=document.createElement("button");n.type="button",n.className="code-copy",n.textContent=e,t.appendChild(n)}t.dataset.copyReady="1"}}(n),n.__armed||(n.__armed=!0,n.addEventListener("click",async function(r){if(!(r.target.closest&&r.target.closest(".code-copy, .legend")||null))return;r.preventDefault(),r.stopPropagation();const o=n.querySelector("pre");o&&(!function(e){try{var t=document.createRange();t.selectNodeContents(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}catch(e){}}(o),function(e){t=e||null}(o),await e(function(e){return(e&&(e.innerText||e.textContent)||"").replace(/\s+$/,"")}(o)))},!0))}function a(e){var t,n;(t=".code-box",n=e,Array.prototype.slice.call((n||document).querySelectorAll(t))).forEach(o)}a(),document.addEventListener("pun_main_ready",function(){a()}),new MutationObserver(function(e){e.forEach(function(e){(e.addedNodes||[]).forEach(function(e){1===e.nodeType&&(e.matches&&e.matches(".code-box")&&o(e),e.querySelectorAll&&e.querySelectorAll(".code-box").forEach(o))})})}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("pointerdown",r,!0),document.addEventListener("mousedown",r,!0),document.addEventListener("click",r,!0),document.addEventListener("touchstart",r,!0),document.addEventListener("focusin",r,!0),document.addEventListener("scroll",function(){t&&(t=null,n())},!0),document.addEventListener("selectionchange",function(){if(!t)return;const e=window.getSelection&&window.getSelection();if(!e||!e.rangeCount||e.isCollapsed)return void(t=null);const r=e.anchorNode;r&&!t.contains(r)&&(t=null,n())},!0),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&(t=null,n())},!0),window.addEventListener("blur",function(){t&&(t=null,n())},!0)}(),function(){"use strict";const e={icon:"icon_",plashka:"plashka_",background:"background_",gift:"gift_",coupon:"coupon_"};window.skinAdmin={load:async function(t,n={}){const r=function(){const e=document.querySelector(".modal_script");if(!e)return null;const t=e.getAttribute("data-main-user_id");if(t&&t.trim())return Number(t.trim());const n=e.getAttribute("data-id");return n&&n.trim()?Number(n.trim()):null}()||Number(t);return r?{status:"ok",initialData:await async function(t){const n={icon:[],plashka:[],background:[],gift:[],coupon:[]};if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[admin_bridge_json] FMVbank.storageGet не найден"),n;for(const[r,o]of Object.entries(e))try{const e=await window.FMVbank.storageGet(t,o);e&&"object"==typeof e&&Array.isArray(e.data)&&(n[r]=e.data.filter(e=>!1!==e.is_visible))}catch(e){console.error(`[admin_bridge_json] Ошибка загрузки ${r}:`,e)}return n}(r),save:async function(t){const o=await async function(t,n,r){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageSet)return console.error("[admin_bridge_json] FMVbank.storageSet не найден"),!1;try{for(const[o,a]of Object.entries(e)){const e=await window.FMVbank.storageGet(t,a),i=e&&Array.isArray(e.data)?e.data:[],s=r[o]||new Set,c=i.filter(e=>!s.has(String(e.id))).map(e=>({...e,is_visible:!1})),l=[...(n[o]||[]).map(e=>({...e,is_visible:!0})),...c],d={last_update_ts:Math.floor(Date.now()/1e3),data:l};if(!await window.FMVbank.storageSet(d,t,a))return console.error(`[admin_bridge_json] Не удалось сохранить ${o}`),!1}return!0}catch(e){return console.error("[admin_bridge_json] Ошибка сохранения:",e),!1}}(r,t,n);return{ok:o,status:o?"успешно":"ошибка сохранения"}},targetUserId:r}:{status:"error",initialData:{},save:null,targetUserId:null}}}}(),function(){console.log("[collect_skins_api] Скрипт загружен");const e=".modal_script[data-id]",t=(...e)=>console.log("[collect_skins_api]",...e),n={icon:"._icon",plashka:"._plashka",background:"._background",gift:"._gift",coupon:"._coupon"};function r(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function o(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function a(a){if(t("initIn вызван, root:",a),!a)return void t("root не передан");if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return void console.warn("[collect_skins_api] FMVbank.storageGet не найден");const i=a.querySelector(e)||document.querySelector(e);if(t("charEl:",i),!i)return void t("character не найден");const s=o(i);t("scope:",s),function(t){const r=t.querySelector(e);r&&Object.values(n).forEach(e=>{const n=t.querySelector(e);n&&n.parentElement!==r&&r.appendChild(n)})}(s);const c=function(e){if(!e)return null;const t=e.getAttribute("data-main-user_id");if(t&&t.trim())return Number(t.trim());const n=e.getAttribute("data-id");return n&&n.trim()?Number(n.trim()):null}(i);if(t("userId:",c),!c)return void t("userId не найден");t("Загружаю данные для userId",c);const l=await async function(e){if(t("Загружаю данные из API для userId",e),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[collect_skins_api] FMVbank.storageGet не найден"),null;const n={icon:[],plashka:[],background:[],gift:[],coupon:[]},r={icon:"icon_",plashka:"plashka_",background:"background_",gift:"gift_",coupon:"coupon_"};for(const[o,a]of Object.entries(r))try{const r=await window.FMVbank.storageGet(e,a);t(`${o} ответ:`,r),r&&"object"==typeof r&&Array.isArray(r.data)&&(n[o]=r.data.filter(e=>!1!==e.is_visible),t(`${o} загружено ${n[o].length} видимых элементов из ${r.data.length}`))}catch(e){console.error(`[collect_skins_api] Ошибка загрузки ${o}:`,e)}return t("Все данные загружены:",n),n}(c);l?(!function(e,o){t("Вставляю данные в DOM:",o);for(const[a,i]of Object.entries(n)){const n=e.querySelector(i);if(!n){t(`Контейнер ${i} не найден`);continue}const s=o[a]||[];if(0===s.length){t(`Нет данных для ${a}`),n.innerHTML="";continue}const c=s.map(e=>`<div class="item" ${[`data-id="${r(e.id)}"`,`title="${r(e.title||"")}"`].join(" ")}>${e.content||""}</div>`).join("\n");n.innerHTML=c,t(`Вставлено ${s.length} элементов в ${i}`)}}(s,l),t("Данные вставлены для userId",c)):t("Данные не загружены")}window.loadUserSkinsFromApi=function({root:e,rootSelector:t}={}){a(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{t("DOMContentLoaded событие"),a(document)});const i=new WeakSet;new MutationObserver(n=>{n.forEach(n=>{n.addedNodes&&n.addedNodes.forEach(n=>{n instanceof Element&&(n.matches&&n.matches(e)&&!i.has(n)&&(i.add(n),t("Обнаружен новый character:",n),a(o(n))),n.querySelectorAll&&n.querySelectorAll(e).forEach(e=>{i.has(e)||(i.add(e),t("Обнаружен вложенный character:",e),a(o(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0}),t("Скрипт инициализирован")}(),function(){console.log("[collect_api] Скрипт загружен");const e=".modal_script[data-id]",t=".chrono_info",n=(...e)=>console.log("[collect_api]",...e);function r(){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank не найден — подключите src/bank/api.js")}function o(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function a(e,o){console.log("[collect_api] loadChronoFromApi, ищем",t,"в scope");const a=o.querySelector(t);if(console.log("[collect_api] target найден:",a),!a)return void n("chrono_info не найден для userId",e);console.log("[collect_api] Показываем индикатор загрузки"),a.innerHTML="<p>Загрузка хронологии...</p>",console.log("[collect_api] Запрашиваем данные из API");const i=await async function(e){r();try{const t=await window.FMVbank.storageGet(Number(e),"chrono_");return n("Получены данные для userId",e,":",t),t}catch(t){return console.error(`[collect_api] Ошибка получения данных для userId ${e}:`,t),null}}(e);if(console.log("[collect_api] Получены данные:",i),!i)return console.log("[collect_api] Данные не получены"),void(a.innerHTML="<p>Не удалось загрузить данные хронологии</p>");console.log("[collect_api] Строим HTML");const s=function(e){if(!e||"object"!=typeof e)return"<p>Нет данных хронологии</p>";if(window.FMV&&"function"==typeof window.FMV.buildChronoHtml)try{return window.FMV.buildChronoHtml(e,{titlePrefix:"Хронология"})}catch(e){console.error("[collect_api] Ошибка FMV.buildChronoHtml:",e)}n("FMV.buildChronoHtml не найден, используем fallback");const t=Object.entries(e);if(0===t.length)return"<p>Хронология пуста</p>";let r='<div class="chrono-data">';for(const[e,n]of t)r+=`<div><strong>${e}:</strong> ${JSON.stringify(n)}</div>`;return r+="</div>",r}(i);console.log("[collect_api] HTML построен, длина:",s.length),function(e,t){e&&(e.innerHTML=t)}(a,s),console.log("[collect_api] Хронология загружена для userId",e)}async function i(i){if(console.log("[collect_api] initIn вызван, root:",i),!i)return void console.log("[collect_api] root не передан");try{r(),console.log("[collect_api] FMVbank найден")}catch(e){return void console.warn("[collect_api]",e.message)}const s=i.querySelector(e)||document.querySelector(e);if(console.log("[collect_api] charEl:",s),!s)return void n("no character");const c=o(s);console.log("[collect_api] scope:",c),function(n){const r=n.querySelector(e);if(!r)return;const o=n.querySelector(t);o&&o.parentElement!==r&&r.appendChild(o)}(c);const l=s.getAttribute("data-id")?.trim();console.log("[collect_api] userId:",l),l?(console.log("[collect_api] Вызываем loadChronoFromApi для userId",l),await a(l,c)):n("no data-id")}window.loadUserChronoFromApi=function({root:e,rootSelector:t}={}){i(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{console.log("[collect_api] DOMContentLoaded событие"),i(document)});const s=new WeakSet;new MutationObserver(t=>{t.forEach(t=>{t.addedNodes&&t.addedNodes.forEach(t=>{t instanceof Element&&(t.matches&&t.matches(e)&&!s.has(t)&&(s.add(t),i(o(t))),t.querySelectorAll&&t.querySelectorAll(e).forEach(e=>{s.has(e)||(s.add(e),i(o(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0})}(),window.ChronoFilter={init:({root:e}={})=>function(e){const t=(t,n=e)=>n.querySelector(t),n=(t,n=e)=>Array.from(n.querySelectorAll(t)),r=e=>e?new Date(e):null,o=(e,t)=>Array.from(e?.querySelectorAll(`input[name="${t}"]:checked`)||[]).map(e=>e.value),a=t("#filters"),i=t("#list");if(!a||!i)return{apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}};const s=t("#dateStart"),c=t("#dateEnd"),l=t("#resetBtn"),d=t("#typeList"),u=t("#statusList"),p=t("#maskList"),m=t("#playerList"),f=t("#locationList");function h(e,n){const r=t(e);if(!r||!n)return()=>{};const o=e=>{e.stopPropagation(),n.style.display="block"===n.style.display?"none":"block"},a=e=>{n.contains(e.target)||r.contains(e.target)||(n.style.display="none")};return r.addEventListener("click",o),document.addEventListener("click",a),()=>{r.removeEventListener("click",o),document.removeEventListener("click",a)}}const g=h("#typeToggle",d),y=h("#statusToggle",u),w=h("#maskToggle",p),v=h("#playerToggle",m),b=h("#locationToggle",f),S=n("#list .episode").map(e=>{const t=(e.dataset.mask||"").split(";").map(e=>e.trim()).filter(Boolean),n=(e.dataset.players||"").split(";").map(e=>e.trim()).filter(Boolean);return{el:e,type:(e.dataset.type||"").trim(),status:(e.dataset.status||"").trim(),startL:r(e.dataset.startL),startR:r(e.dataset.startR),endL:r(e.dataset.endL),endR:r(e.dataset.endR),masks:t,players:n,location:(e.dataset.location||"").trim()}});function C(){const t=s?.value?new Date(s.value):null,n=c?.value?new Date(c.value):null,r=o(d,"type"),a=o(u,"status"),i=o(p,"mask"),l=o(m,"player"),h=o(f,"location"),g=[],y=[];return S.forEach(e=>{let o=!0;o&&t&&e.endL&&e.endL<t&&(o=!1),o&&n&&e.startR&&e.startR>n&&(o=!1),o&&r.length&&!r.includes(e.type)&&(o=!1),o&&a.length&&!a.includes(e.status)&&(o=!1),o&&i.length&&!e.masks.some(e=>i.includes(e))&&(o=!1),o&&l.length&&!e.players.some(e=>l.includes(e))&&(o=!1),o&&h.length&&!h.includes(e.location)&&(o=!1),e.el.style.display=o?"":"none",(o?g:y).push(e.el)}),e.dispatchEvent(new CustomEvent("chrono:filtered",{detail:{visible:g,hidden:y}})),g}function x(){return s&&(s.value=""),c&&(c.value=""),n('#filters .dropdown-list input[type="checkbox"]').forEach(e=>{e.checked=!1}),C()}function k(e){e.target.closest("#filters .dropdown-list")&&e.target.matches('input[type="checkbox"]')&&C()}return e.addEventListener("change",k),s?.addEventListener("change",C),c?.addEventListener("change",C),l?.addEventListener("click",e=>{e.preventDefault(),x()}),C(),{apply:C,reset:x,getVisible:()=>S.filter(e=>"none"!==e.el.style.display).map(e=>e.el),destroy:()=>{e.removeEventListener("change",k),s?.removeEventListener("change",C),c?.removeEventListener("change",C),l?.removeEventListener("click",x),g(),y(),w(),v(),b()}}}(e||document),apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}},function(){window.FMV||(window.FMV={});const e=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t=t=>e(t).replace(/"/g,"&quot;"),n=e=>Array.from(new Set((e||[]).filter(Boolean))),r=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"";FMV.utils={esc:e,escAttr:t,unique:n,capitalize:r};const o={personal:{label:"личный",emoji:"<иконка>"},plot:{label:"сюжетный",emoji:"<иконка>"},au:{label:"au",emoji:"<иконка>"}},a={on:{label:"активен",emoji:"<иконка>"},archived:{label:"неактуален",emoji:"<иконка>"},off:{label:"закрыт",emoji:"<иконка>"}},i=e=>String(e).padStart(2,"0"),s=(e,t)=>new Date(e,t,0).getDate(),c=(e,t,n)=>`${e}-${i(t)}-${i(n)}`;function l(e){const t=String(e||"").trim();if(!t)return null;let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);return n?{y:+n[3],m:+n[2],d:+n[1],g:"day"}:(n=t.match(/^(\d{4})-(\d{2})-(\d{2})$/),n?{y:+n[1],m:+n[2],d:+n[3],g:"day"}:(n=t.match(/^(\d{1,2})\.(\d{4})$/),n?{y:+n[2],m:+n[1],d:1,g:"month"}:(n=t.match(/^(\d{4})$/),n?{y:+n[1],m:1,d:1,g:"year"}:null)))}FMV.buildChronoHtml=function(d,u={}){u.titlePrefix,e(d?.name||"");const p=Array.isArray(d?.episodes)?d.episodes:[],m=n(p.flatMap(e=>Array.isArray(e?.masks)?e.masks:[])),f=n(p.flatMap(e=>(Array.isArray(e?.participants)?e.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return t.length?t.join(", "):String(e?.name||"").trim()}).map(e=>e.replace(/;/g," ")).filter(Boolean))),h=n(p.map(e=>e?.location).filter(Boolean));let g=null,y=null;const w=p.map(e=>{const t=function(e,t){const n=l(e),r=t?l(t):null;if(!n&&!r)return{startL:"",startR:"",endL:"",endR:""};let o="",a="";n?"day"===n.g?(o=c(n.y,n.m,1),a=c(n.y,n.m,n.d)):"month"===n.g?(o=c(n.y,n.m,1),a=c(n.y,n.m,s(n.y,n.m))):(o=c(n.y,1,1),a=c(n.y,12,31)):r&&("day"===r.g?(o=c(r.y,r.m,1),a=c(r.y,r.m,r.d)):"month"===r.g?(o=c(r.y,r.m,1),a=c(r.y,r.m,s(r.y,r.m))):(o=c(r.y,1,1),a=c(r.y,12,31)));let i="",d="";return r?"day"===r.g?(i=c(r.y,r.m,r.d),d=c(r.y,r.m,s(r.y,r.m))):"month"===r.g?(i=c(r.y,r.m,1),d=c(r.y,r.m,s(r.y,r.m))):(i=c(r.y,1,1),d=c(r.y,12,31)):n&&("day"===n.g?(i=c(n.y,n.m,n.d),d=c(n.y,n.m,s(n.y,n.m))):"month"===n.g?(i=c(n.y,n.m,1),d=c(n.y,n.m,s(n.y,n.m))):(i=c(n.y,1,1),d=c(n.y,12,31))),{startL:o,startR:a,endL:i,endR:d}}(e?.dateStart,e?.dateEnd);return t.startL&&(!g||t.startL<g)&&(g=t.startL),t.endR&&(!y||t.endR>y)&&(y=t.endR),t}),v=Object.entries(o).map(([n,r])=>`<label><input type="checkbox" name="type" value="${t(n)}"> ${e(r.label)}</label>`).join(""),b=Object.entries(a).map(([n,r])=>`<label><input type="checkbox" name="status" value="${t(n)}"> ${e(r.label)}</label>`).join(""),S=n(m).map(n=>`<label><input type="checkbox" name="mask" value="${t(n)}"> ${e(n)}</label>`).join(""),C=f.map(n=>`<label><input type="checkbox" name="player" value="${t(n)}"> ${e(n)}</label>`).join(""),x=h.map(n=>`<label><input type="checkbox" name="location" value="${t(n)}"> ${e(n)}</label>`).join("");let k=`<div class="filters" id="filters">\n    <div class="f">\n      <label>Дата начала фильтра</label>\n      <input type="date" id="dateStart" value="${t(g||"")}">\n    </div>\n    <div class="f">\n      <label>Дата конца фильтра</label>\n      <input type="date" id="dateEnd" value="${t(y||"")}">\n    </div>\n    <div class="f">\n      <label>Тип</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="typeToggle">Выбрать тип</button>\n        <div class="dropdown-list" id="typeList">\n          ${v}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Статус</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="statusToggle">Выбрать статус</button>\n        <div class="dropdown-list" id="statusList">\n          ${b}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Маска</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="maskToggle">Выбрать маску</button>\n        <div class="dropdown-list" id="maskList">\n          ${S}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Участник</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="playerToggle">Выбрать участника</button>\n        <div class="dropdown-list" id="playerList">\n          ${C}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Локация</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="locationToggle">Выбрать локацию</button>\n        <div class="dropdown-list" id="locationList">\n          ${x}\n        </div>\n      </div>\n    </div>\n    <div class="actions">\n      <button class="button" id="resetBtn">Сбросить</button>\n    </div>\n  </div>\n  \n  <div class="list" id="list">\n    `;return p.length?(p.forEach((n,s)=>{const c=o[n?.type]||o.au,d=a[n?.status]||a.archived,u=n?.type||"",p=`${r(u)} ${c.emoji}`,m=n?.status||"",f=`${r(m)} ${d.emoji}`,h=Array.isArray(n?.masks)?n.masks.filter(Boolean):[],g=(Array.isArray(n?.participants)?n.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return(t.length?t.join(", "):String(e?.name||"").trim()).replace(/;/g," ")}).filter(Boolean),y=g.join(";"),v=(Array.isArray(n?.participants)?n.participants:[]).map(n=>{const r=Array.isArray(n?.masks)&&n.masks.length?n.masks.join(", "):String(n?.name||"").trim(),o=n?.id?String(n.id).trim():"";return o?`<a href="/profile.php?id=${t(o)}">${e(r)}</a>`:e(r)}).filter(Boolean).join(", "),b=n?.location||"",S=w[s],C=function(e,t){const n=l(e),r=l(t),o=e=>`${i(e.d)}.${i(e.m)}.${e.y}`,a=e=>`${i(e.m)}.${e.y}`,s=e=>`${e.y}`;if(!n&&!r)return"";if(n&&r&&("day"===n.g&&"day"===r.g&&n.y===r.y&&n.m===r.m&&n.d===r.d||"month"===n.g&&"month"===r.g&&n.y===r.y&&n.m===r.m||"year"===n.g&&"year"===r.g&&n.y===r.y)){if("day"===n.g)return o(n);if("month"===n.g)return a(n);if("year"===n.g)return s(n)}if(!n||!r)return"";const c={...n},d={...r},u=(e,t,n=1)=>{e.m="number"==typeof t?t:e.m??1,e.d=n,e.g="day"},p=(e,t)=>{e.m="number"==typeof t?t:e.m??1,e.d=1,e.g="month"};return"day"===c.g&&"month"===d.g&&u(d,d.m,1),"day"===d.g&&"month"===c.g&&u(c,c.m,1),"day"===c.g&&"year"===d.g&&u(d,1,1),"day"===d.g&&"year"===c.g&&u(c,1,1),"month"===c.g&&"year"===d.g&&p(d,c.m),"month"===d.g&&"year"===c.g&&p(c,d.m),"day"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m&&c.d===d.d?o(c):c.y===d.y&&c.m===d.m?`${i(c.d)}-${i(d.d)}.${i(c.m)}.${c.y}`:c.y===d.y&&c.m!==d.m?`${i(c.d)}.${i(c.m)}-${i(d.d)}.${i(d.m)}.${c.y}`:`${o(c)}-${o(d)}`:"month"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?a(c):c.y===d.y&&c.m!==d.m?`${i(c.m)}-${i(d.m)}.${c.y}`:`${a(c)}-${a(d)}`:"year"===c.g&&"year"===d.g?c.y===d.y?s(c):`${s(c)}-${s(d)}`:"day"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?o(c):c.y===d.y?`${i(c.d)}.${i(c.m)}-${i(d.m)}.${c.y}`:`${o(c)}-${a(d)}`:"month"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m?o(d):c.y===d.y?`${i(c.m)}.${c.y}-${i(d.d)}.${i(d.m)}.${d.y}`:`${a(c)}-${o(d)}`:"day"===c.g&&"year"===d.g?c.y===d.y?o(c):`${o(c)}-${s(d)}`:"year"===c.g&&"day"===d.g?c.y===d.y?o(d):`${s(c)}-${o(d)}`:"month"===c.g&&"year"===d.g?c.y===d.y?a(c):`${a(c)}-${s(d)}`:"year"===c.g&&"month"===d.g?c.y===d.y?a(d):`${s(c)}-${a(d)}`:""}(n?.dateStart,n?.dateEnd),x=C?`<span class="muted">${e(C)} — </span>`:"";k+=`\n  <div class="episode" \n       data-type="${t(u)}" \n       data-status="${t(m)}" \n       data-start-l="${t(S.startL)}" data-start-r="${t(S.startR)}" \n       data-end-l="${t(S.endL)}" data-end-r="${t(S.endR)}"\n       ${h.length?`data-mask="${t(h.join(";"))}"`:""}\n       ${b?`data-location="${t(b)}"`:""}\n       ${g.length?`data-players="${t(y)}"`:""}>\n    <div>тип: ${e(p)}; статус: ${e(f)}</div>\n    <div>${x}<span class="title"><a href="${e(n?.href||"#")}">${e(n?.title||"")}</a></span>\n      ${h.length?` [as ${e(h.join(", "))}]`:""}</div>\n    <div>локация: ${e(b)}</div>\n    <div>участники: ${v}</div>\n  </div>`}),k+="</div>",k):(k+='<div class="meta">Нет эпизодов</div></section>',k)}}(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Создать страницу",order:1,async onClick({setStatus:e,setDetails:t,setLink:n}){const r=document.querySelector("#pun-main h1 span"),o=r?r.textContent.trim().toLowerCase():"";if(!o)return e("✖ нет имени темы","red"),void t("Ожидался #pun-main h1 span");let a=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!a)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),a=document.querySelector('a[href*="profile.php?id="]')}catch{}const i=a?.href?.match(/profile\.php\?id=(\d+)/i);if(!i)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=`usr${i[1]}`,c=window.PROFILE_CHECK?.PPageTemplate,l=window.PROFILE_CHECK?.PPageGroupID;if("function"!=typeof window.FMVcreatePersonalPage)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVcreatePersonalPage(arg1, arg2, arg3, arg4, arg5, arg6)");e("Создаём…","#555"),t(""),n(null);try{const r=await window.FMVcreatePersonalPage(o,s,c,"",l,"0");switch(r?.status){case"created":e("✔ создано","green");break;case"exists":e("ℹ уже существует","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}r?.url&&n(r.url,"Открыть страницу");const a=[];r?.serverMessage&&a.push("Сообщение сервера: "+r.serverMessage),r?.httpStatus&&a.push("HTTP: "+r.httpStatus),r?.title&&a.push("Пользователь: "+r.title),r?.name&&a.push("Адресное имя: "+r.name),r?.details&&a.push("Details: "+r.details),t(a.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n?.message||String(n)),console.error("[button_personal_page]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Сменить группу",order:4,async onClick({setStatus:e,setDetails:t}){const n=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupUserID||"",r=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupPlayerID||"";if(!n||!r){const o=[n?null:"PROFILE_CHECK.GroupUserID",r?null:"PROFILE_CHECK.GroupPlayerID"].filter(Boolean).join(", ");return e("✖ Замена не выполнена","red"),void t("Не удалось запустить изменение группы: "+(o?`не заданы параметры ${o}. Укажите значения и повторите.`:"отсутствуют необходимые параметры."))}let o=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!o)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),o=document.querySelector('a[href*="profile.php?id="]')}catch{}const a=o?.href?.match(/profile\.php\?id=(\d+)/i),i=a?a[1]:"";if(!i)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=... из страницы темы");if("function"!=typeof window.FMVupdateGroupIfEquals)return e("✖ функция недоступна","red"),void t("Ожидалась window.FMVupdateGroupIfEquals(userId, fromId, toId)");e("Проверяю и обновляю…","#555"),t("");try{const o=await window.FMVupdateGroupIfEquals(i,n,r);let a="";if(o?.details){const e=String(o.details).match(/current=([^\s]+)/);e&&(a=e[1])}switch(o?.status){case"updated":e("✔ Группа изменена","green");break;case"nochange":e("ℹ Изменений нет — пользователь уже в целевой группе","#555");break;case"skipped":return e("✖ Исходная группа не совпадает","red"),void t(`Исходное значение группы — ${a||"не определено"}.\nЛибо вы пытаетесь поправить не тот профиль, либо выполните замену вручную для дополнительной валидации.`);case"uncertain":e("❔ Не удалось подтвердить результат","#b80");break;default:e("✖ Ошибка при сохранении","red")}const s=[];o?.serverMessage&&s.push("Сообщение сервера: "+o.serverMessage),o?.httpStatus&&s.push("HTTP: "+o.httpStatus),s.push("Пользователь: "+(o?.userId??i)),s.push(`Замена: ${n} → ${r}`),a&&s.push("Текущее (до попытки): "+a),o?.details&&!a&&s.push("Details: "+o.details),t(s.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ Сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_group]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Выдать монетки",order:3,async onClick({setStatus:e,setDetails:t}){let n=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!n)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),n=document.querySelector('a[href*="profile.php?id="]')}catch{}const r=n?.href?.match(/profile\.php\?id=(\d+)/i);if(!r)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const o=r[1],a=window.PROFILE_CHECK?.MoneyFieldID,i=window.PROFILE_CHECK?.MoneyFieldTemplate,s=String(i);if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция обновления не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляем…","#555"),t("");try{const n=await window.FMVreplaceFieldData(o,a,s);switch(n?.status){case"updated":e("✔ обновлено","green");break;case"nochange":e("ℹ изменений нет","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}const r=[];n?.serverMessage&&r.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&r.push("HTTP: "+n.httpStatus),r.push("Поле: "+(n?.fieldId??a)),r.push("Пользователь: "+(n?.userId??o)),r.push("Значение: "+s),n?.details&&r.push("Details: "+n.details),t(r.join("\n"))}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_money_field]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Установить плашку",order:2,async onClick({setStatus:e,setDetails:t}){const n=document.querySelector("#pun-main h1 span");if(!(n?n.textContent.trim().toLowerCase():""))return e("✖ не найдено имя темы (arg1)","red"),void t("Ожидался #pun-main h1 span");let r=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!r)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),r=document.querySelector('a[href*="profile.php?id="]')}catch{}const o=r?.href?.match(/profile\.php\?id=(\d+)/i),a=o?o[1]:"",i=a?`usr${a}`:"";if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=window.PROFILE_CHECK?.PPageFieldID,c=window.PROFILE_CHECK?.PPageFieldTemplate,l=String(c).replace(/\bID\b/g,i);if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляю…","#555"),t("");try{const n=await window.FMVreplaceFieldData(a,s,l);switch(n?.status){case"updated":e("✔ обновлено","green");break;case"nochange":e("ℹ изменений нет","red");break;case"error":e("✖ ошибка","red");break;default:e("❔ неизвестный результат","#b80")}const r=[];n?.serverMessage&&r.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&r.push("HTTP: "+n.httpStatus),r.push("Поле: "+(n?.fieldId??s)),r.push("Пользователь: "+(n?.userId??a)),r.push("Значение (template→arg2): "+l),n?.details&&r.push("Details: "+n.details),t(r.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_personal_field]",n)}}})})(),function(){"use strict";const e='\n  details.ufo-panel{margin-top:12px;border:1px solid #d0d0d7;border-radius:10px;background:#fff}\n  details.ufo-panel>summary{cursor:pointer;list-style:none;padding:10px 14px;font-weight:600;background:#f6f6f8;border-bottom:1px solid #e6e6ef;border-radius:10px}\n  details.ufo-panel>summary::-webkit-details-marker{display:none}\n  .ufo-wrap{display:flex;flex-direction:column;gap:16px;padding:14px}\n  .ufo-col{display:flex;flex-direction:column;gap:8px}\n  .ufo-col h4{margin:0;font-size:14px;opacity:.8;display:flex;justify-content:space-between;align-items:center}\n  .ufo-search{padding:6px 10px;font-size:13px;border:1px solid #d0d0d7;border-radius:8px;background:#f5f2e8}\n  .ufo-lib,.ufo-selected{border:1px dashed #c9c9d9;border-radius:8px;background:#fafafd;padding:8px;overflow:auto}\n  .ufo-lib{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}\n  .ufo-lib .ufo-card{margin:0}\n  .ufo-card{display:grid;grid-template-columns:auto 1fr auto auto;grid-template-rows:auto auto;grid-template-areas:"id full date actions" "id title title actions";gap:8px;background:#fff;border:1px solid #e7e7ef;border-radius:8px;padding:8px;margin:6px 0;max-width:100%;position:relative;overflow:hidden}\n  .ufo-idtag{grid-area:id;font-size:11px;opacity:.7;align-self:start}\n  .ufo-actions{grid-area:actions;display:flex;align-items:center;gap:6px}\n  .ufo-btn{border:1px solid #d7d7e0;background:#f3f3f7;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;line-height:1.15;display:inline-flex;align-items:center}\n  .ufo-btn:hover{background:#ececf4}\n  .ufo-card.disabled{opacity:.4;pointer-events:none}\n  .ufo-full{grid-area:full;box-sizing:border-box;margin:0;padding:0;border:0;background:transparent;overflow:hidden}\n  .ufo-full .item{position:relative;margin:0}\n  .ufo-full .item .modal-link{display:block}\n  .ufo-full .item img{display:block;max-width:100%;height:auto;border-radius:6px}\n  .ufo-lib .ufo-full .item img{height:90px;width:100%;object-fit:cover}\n  .ufo-lib .ufo-full a{pointer-events:none}\n  .ufo-title-edit{grid-area:title;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;white-space:pre-wrap;overflow:visible}\n  .ufo-title-edit:focus{outline:none;background:#fffdf1}\n  .ufo-date-edit{grid-area:date;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;align-self:start}\n  .ufo-date-edit input{border:none;background:transparent;font-size:13px;width:100%;font-family:inherit}\n  .ufo-date-edit input:focus{outline:none}\n  ';!function(){if(window.__ufoCSS)return;window.__ufoCSS=!0;const t=document.createElement("style");t.textContent=e,document.head.appendChild(t),"function"==typeof GM_addStyle&&GM_addStyle(e)}();const t=(e,t)=>{const n=document.createElement("button");return n.type="button",n.className="ufo-btn",n.textContent=e,n.addEventListener("click",t),n};function n(e){const t=e.querySelector(".ufo-card");if(!t)return void(e.style.maxHeight="");const n=getComputedStyle(t),r=t.getBoundingClientRect().height,o=parseFloat(n.marginTop)||0,a=parseFloat(n.marginBottom)||0,i=getComputedStyle(e),s=parseFloat(i.paddingTop)||0,c=parseFloat(i.paddingBottom)||0,l=Math.round(2*r+3*(o+a)+s+c);e.style.maxHeight=l+"px"}function r(e){const t=function(e){return[...e.querySelectorAll(".ufo-card")].find(e=>"none"!==getComputedStyle(e).display)||null}(e);if(!t)return void(e.style.maxHeight="");const n=t.getBoundingClientRect().height,r=getComputedStyle(e),o=parseFloat(r.rowGap)||0,a=parseFloat(r.paddingTop)||0,i=parseFloat(r.paddingBottom)||0,s=Math.round(2*n+o+a+i);e.style.maxHeight=s+"px"}window.createChoicePanelJSON=function(e){const o=Object.assign({title:"Библиотека и выбранные",targetClass:"_section",library:[],startOpen:!1,itemSelector:".item",idAttr:"data-id",editableAttr:"title",searchPlaceholder:"поиск по id",mountEl:null,allowMultiAdd:!1,expirableAttr:null},e||{});Array.isArray(o.library)||(o.library=[]);const a="ufo_"+(o.targetClass||"section").replace(/\W+/g,"_")+"_"+Math.random().toString(36).slice(2,7);let i=[];const s=document.createElement("details");s.className="ufo-panel",s.open=!!o.startOpen;const c=document.createElement("summary");c.textContent=o.title||"Панель";const l=document.createElement("div");l.className="ufo-wrap";const d=document.createElement("div");d.className="ufo-col";const u=document.createElement("h4");u.textContent="Библиотека";const p=document.createElement("input");p.type="text",p.placeholder=o.searchPlaceholder||"поиск по id",p.className="ufo-search",u.appendChild(p);const m=document.createElement("div");m.className="ufo-lib",m.id=a+"-lib",d.append(u,m);const f=document.createElement("div");f.className="ufo-col",f.innerHTML="<h4>Выбранные (сверху — новее)</h4>";const h=document.createElement("div");function g(e){const n=document.createElement("div");n.className="ufo-card",n.dataset.id=e.id;const r=document.createElement("div");r.className="ufo-idtag",r.textContent="#"+e.id;const a=document.createElement("div");a.className="ufo-full";const s=document.createElement("div");s.innerHTML=e.html.trim(),a.appendChild(s.firstElementChild);const c=document.createElement("div");return c.className="ufo-actions",c.appendChild(t("Добавить ↑",t=>{t.preventDefault(),t.stopPropagation(),function(e){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);if(!o.allowMultiAdd){if(i.some(t=>t.id===e.id))return;t&&t.classList.add("disabled")}const n=document.createElement("div");n.innerHTML=e.html.trim();const r=n.querySelector(o.itemSelector),a={id:e.id,title:r&&r.getAttribute(o.editableAttr)||"",content:r?r.innerHTML.trim():""};o.expirableAttr&&r&&(a.expired_date=r.getAttribute(o.expirableAttr)||"");i.unshift(a),y()}(e)})),n.append(r,a,c),n}function y(){h.innerHTML="",i.forEach((e,n)=>{const r=function(e,n){const r=document.createElement("div");r.className="ufo-card",r.draggable=!0,r.dataset.id=e.id,r.dataset.index=n;const a=document.createElement("div");a.className="ufo-idtag",a.textContent="#"+e.id;const s=document.createElement("div");s.className="ufo-full";const c=document.createElement("div");c.innerHTML=e.content.trim(),s.appendChild(c.firstElementChild);const l=document.createElement("div");l.className="ufo-title-edit",l.contentEditable=!0,l.textContent=e.title||"",l.addEventListener("blur",()=>{const e=String(l.innerHTML||"").replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;|[\u00A0\u200B-\u200D\u2060\uFEFF]/g,"").replace(/\s+/g," ").trim();i[n].title=e});let d=null;if(o.expirableAttr){d=document.createElement("div"),d.className="ufo-date-edit";const t=document.createElement("input");t.type="date",t.value=e.expired_date||"",t.addEventListener("change",()=>{i[n].expired_date=t.value}),d.appendChild(t)}const u=document.createElement("div");u.className="ufo-actions";const p=t("↑",e=>{e.preventDefault(),e.stopPropagation(),n>0&&([i[n-1],i[n]]=[i[n],i[n-1]],y())}),f=t("↓",e=>{e.preventDefault(),e.stopPropagation(),n<i.length-1&&([i[n],i[n+1]]=[i[n+1],i[n]],y())}),h=t("✕",t=>{if(t.preventDefault(),t.stopPropagation(),i.splice(n,1),!o.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.remove("disabled")}y()});u.append(p,f,h),r.append(a,s,u,l),d&&r.appendChild(d);return r}(e,n);h.appendChild(r)}),n(h)}return h.className="ufo-selected",h.id=a+"-selected",f.appendChild(h),l.append(d,f),s.append(c,l),o.mountEl&&o.mountEl.appendChild(s),o.library.forEach(e=>m.appendChild(g(e))),function(e){let t=null;e.addEventListener("dragstart",e=>{const n=e.target.closest(".ufo-card");n&&(t=parseInt(n.dataset.index,10),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""))}),e.addEventListener("dragover",e=>{e.preventDefault();const n=e.target.closest(".ufo-card");if(!n||null===t)return;const r=parseInt(n.dataset.index,10);if(t===r)return;const o=i[t];i.splice(t,1),i.splice(r,0,o),t=r,y()}),e.addEventListener("drop",e=>{e.preventDefault(),t=null}),e.addEventListener("dragend",()=>{t=null})}(h),p.addEventListener("input",()=>{const e=p.value.trim();m.querySelectorAll(".ufo-card").forEach(t=>{t.style.display=!e||t.dataset.id.includes(e)?"":"none"}),r(m)}),new MutationObserver(()=>n(h)).observe(h,{childList:!0,subtree:!0,attributes:!0}),new MutationObserver(()=>r(m)).observe(m,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),window.addEventListener("resize",()=>{r(m),n(h)}),r(m),n(h),{details:s,init:function(e){Array.isArray(e)&&(i=[],e.forEach(e=>{if(i.push({...e}),!o.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.add("disabled")}}),y())},getData:function(){return i.map(e=>{const t=document.createElement("div");if(t.innerHTML=e.content.trim(),e.title){t.querySelectorAll(`[${o.editableAttr}]`).forEach(t=>{t.setAttribute(o.editableAttr,e.title)})}if(o.expirableAttr&&e.expired_date){t.querySelectorAll(`[${o.expirableAttr}]`).forEach(t=>{t.setAttribute(o.expirableAttr,e.expired_date);let n=t.querySelector(".coupon_deadline");if(!n){n=document.createElement("span"),n.className="coupon_deadline";const e=t.querySelector("img");e&&e.nextSibling?t.insertBefore(n,e.nextSibling):e?e.parentNode.appendChild(n):t.appendChild(n)}const r=e.expired_date.split("-");if(3===r.length){const e=r[0].slice(2),t=r[1],o=r[2];n.textContent=`${o}/${t}/${e}`}})}else if(o.expirableAttr&&!e.expired_date){t.querySelectorAll(`[${o.expirableAttr}]`).forEach(e=>{e.removeAttribute(o.expirableAttr);const t=e.querySelector(".coupon_deadline");t&&t.remove()})}return{id:e.id,title:e.title||"",content:t.innerHTML.trim()}})}}}}(),function(){"use strict";window.setupSkinsJSON=async function(e,t={}){if(!(e&&e instanceof HTMLElement))throw new Error("[setupSkinsJSON] container обязателен и должен быть HTMLElement");if("function"!=typeof window.createChoicePanelJSON)throw new Error("[setupSkinsJSON] createChoicePanelJSON не найден. Подключите файл с панелью раньше.");if(window.__skinsSetupJSONMounted)return window.__skinsSetupJSONMounted;const n=t.withHeaders??!0,r=t.startOpen??!1,o=t.initialData||{},a=window.SKIN;if(!a)return void console.warn("[setupSkinsJSON] window.SKIN не найден — прекращаю выполнение.");let[i,s,c,l,d]=await Promise.all([fetchCardsWrappedClean(a.LibraryFieldID,a.LibraryPlashkaPostID),fetchCardsWrappedClean(a.LibraryFieldID,a.LibraryIconPostID),fetchCardsWrappedClean(a.LibraryFieldID,a.LibraryBackPostID),fetchCardsWrappedClean(a.LibraryFieldID,a.LibraryGiftPostID),fetchCardsWrappedClean(a.LibraryFieldID,a.LibraryCouponPostID,{isCoupon:!0})]);i=Array.isArray(i)?i:[],s=Array.isArray(s)?s:[],c=Array.isArray(c)?c:[],l=Array.isArray(l)?l:[],d=Array.isArray(d)?d:[];let u=e.querySelector(".skins-setup-grid");u||(u=document.createElement("div"),u.className="skins-setup-grid",u.style.display="grid",u.style.gridTemplateColumns="1fr",u.style.gap="16px",e.appendChild(u));const p=window.createChoicePanelJSON({title:n?"Подарки":void 0,targetClass:"_gift",library:l,mountEl:u,startOpen:r,allowMultiAdd:!0}),m=window.createChoicePanelJSON({title:n?"Купоны":void 0,targetClass:"_coupon",library:d,mountEl:u,startOpen:r,allowMultiAdd:!0,expirableAttr:"data-expired-date"}),f=window.createChoicePanelJSON({title:n?"Плашки":void 0,targetClass:"_plashka",library:i,mountEl:u,startOpen:r}),h=window.createChoicePanelJSON({title:n?"Иконки":void 0,targetClass:"_icon",library:s,mountEl:u,startOpen:r}),g=window.createChoicePanelJSON({title:n?"Фон":void 0,targetClass:"_background",library:c,mountEl:u,startOpen:r});o.gift&&p.init(o.gift),o.coupon&&m.init(o.coupon),o.plashka&&f.init(o.plashka),o.icon&&h.init(o.icon),o.background&&g.init(o.background);const y={getData:function(){return{icon:h.getData(),plashka:f.getData(),background:g.getData(),gift:p.getData(),coupon:m.getData()}},getLibraryIds:function(){return{icon:new Set(s.map(e=>String(e.id))),plashka:new Set(i.map(e=>String(e.id))),background:new Set(c.map(e=>String(e.id))),gift:new Set(l.map(e=>String(e.id))),coupon:new Set(d.map(e=>String(e.id)))}},panels:{plashka:f,icon:h,back:g,gift:p,coupon:m}};return window.__skinsSetupJSONMounted=y,y}}(),function(){"use strict";if(window.__profileRunnerJSONMounted)return;window.__profileRunnerJSONMounted=!0;const e=(e,t=document)=>t.querySelector(e);async function t(){await new Promise(e=>{if("complete"===document.readyState||"interactive"===document.readyState)return e();document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})});const t=e("#viewprofile .container")||e("#viewprofile")||e("#pun-main")||document.body,n=document.createElement("div");return n.id="fmv-skins-panel",n.style.margin="16px 0",n.innerHTML='\n       <details open style="border:1px solid #d6d6de;border-radius:10px;background:#fff">\n        <summary style="list-style:none;padding:10px 14px;border-bottom:1px solid #e8e8ef;border-radius:10px;font-weight:600;background:#f6f7fb;cursor:pointer">\n          Обновление скинов\n        </summary>\n        <div class="fmv-skins-body" style="padding:14px"></div>\n        <div class="fmv-skins-footer" style="display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid #eee">\n          <button type="button" class="fmv-save"\n            style="background:#2f67ff;color:#fff;border:1px solid #2f67ff;border-radius:8px;padding:8px 14px;cursor:pointer">\n            Сохранить\n          </button>\n          <span class="fmv-status" style="margin-left:8px;font-size:14px;color:#666"></span>\n        </div>\n      </details>\n    ',t.appendChild(n),n.querySelector(".fmv-skins-body")}(async()=>{if("/profile.php"!==location.pathname)return;const e=new URLSearchParams(location.search);if(!e.has("id")||[...e.keys()].some(e=>"id"!==e))return;const n=(e.get("id")||"").trim();if(!n)return;const r=window.SKIN?.GroupID||[];if("function"!=typeof window.ensureAllowed)return;if(!await window.ensureAllowed(r))return;const o=await t();let a=null,i=null;if("function"==typeof window.setupSkinsJSON)try{const e=await window.setupSkinsJSON(o,{initialData:{}});e&&"function"==typeof e.getData&&(a=e.getData),e&&"function"==typeof e.getLibraryIds&&(i=e.getLibraryIds)}catch(e){console.error("setupSkinsJSON() error:",e)}if(!a||!i)return void console.error("[profile_runner_json] Не удалось инициализировать панели");const s=i();if(!window.skinAdmin||"function"!=typeof window.skinAdmin.load)return void console.error("[profile_runner_json] skinAdmin.load не найден.");const{status:c,initialData:l,save:d}=await window.skinAdmin.load(n,s);if("ok"!==c&&"ок"!==c)return void console.error("[profile_runner_json] Не удалось загрузить данные со скинами");if(window.__skinsSetupJSONMounted&&window.__skinsSetupJSONMounted.panels){const e=window.__skinsSetupJSONMounted.panels;l.gift&&e.gift&&e.gift.init(l.gift),l.coupon&&e.coupon&&e.coupon.init(l.coupon),l.plashka&&e.plashka&&e.plashka.init(l.plashka),l.icon&&e.icon&&e.icon.init(l.icon),l.background&&e.back&&e.back.init(l.background)}const u=document.getElementById("fmv-skins-panel"),p=u?.querySelector(".fmv-save"),m=u?.querySelector(".fmv-status");p&&p.addEventListener("click",async()=>{try{m&&(m.textContent="Сохраняю…",m.style.color="#666");const e=a?a():null;if(!e)return void(m&&(m.textContent="Нечего сохранять",m.style.color="#c24141"));let t=null;if("function"!=typeof d)return void(m&&(m.textContent="Нет функции сохранения",m.style.color="#c24141"));t=await d(e);const n=!(!t||!t.ok&&"saved"!==t.status&&"успешно"!==t.status&&"ok"!==t.status);m&&(n?(m.textContent="✓ Успешно сохранено",m.style.color="#16a34a",setTimeout(()=>location.reload(),1e3)):(m.textContent="Ошибка сохранения",m.style.color="#c24141"))}catch(e){console.error(e),m&&(m.textContent="Ошибка сохранения",m.style.color="#c24141")}})})()}(),
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */
function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,n=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),r=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${n(e)}, .${n(e)}`,a=new TextDecoder("utf-8");let i;async function s(e){const t=await fetch(e,{credentials:"same-origin"}),n=await t.arrayBuffer();let r=a.decode(n);if(/charset\s*=\s*windows-1251/i.test(r)||r.includes("�"))try{r=(i||=new TextDecoder("windows-1251")).decode(n)}catch{}return r}function c(e,t){const n=e.querySelector(o(t)),r=n?.querySelector("strong, b");let a=r?.textContent?.trim();if(!a){const e=(n?.textContent||"").trim();a=e.split(":").slice(-1)[0]?.trim()}return(a||"").replace(/\u00A0/g," ").trim()}const l=new Map;function d(e,t){if(l.has(e))return l.get(e);const n=(async()=>{const n=await s(`/profile.php?id=${encodeURIComponent(e)}`);return c((new DOMParser).parseFromString(n,"text/html"),t)})();return l.set(e,n),n}function u(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const n=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=n.nextNode();){const t=(e.nodeValue||"").match(r);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:n})=>{d(n,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+n,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:n}={}){const a=`pa-fld${String(n??e).replace(/\D/g,"")||e}`,i=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(r);if(t)return t[1]}return null}(t.querySelector(o(a)));if(i)try{return await d(i,a)}catch(e){console.warn("[main-field] remote error:",e)}return c(t,a)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()}();const IP_ROWS=1,IP_GAP=8,IP_REQUIRED=!0;function isProfileFieldsPage(){try{const e=new URL(location.href);if(!/\/profile\.php$/i.test(e.pathname))return!1;const t=e.searchParams;if("fields"!==t.get("section"))return!1;const n=t.get("id");return!!n&&/^\d+$/.test(n)}catch{return!1}}const STYLE_ID="ip-style-clean";function injectStylesOnce(){if(document.getElementById(STYLE_ID))return;const e=document.createElement("style");e.id=STYLE_ID,e.textContent="\n    /* скрываем исходный textarea/input */\n    .ip-hidden {\n      display: none !important;\n      resize: none !important;\n      visibility: hidden !important;\n    }\n\n    /* Белый контейнер подстраивается под ширину контента */\n    .ip-box {\n      position: relative;\n      display: inline-block;          /* ширина = контенту */\n      max-width: 100%;\n      border: 1px solid #ccc;\n      border-radius: 10px;\n      background: #fff;\n      padding: 6px;\n    }\n\n    /* Вертикальный скролл */\n    .ip-scroll {\n      overflow-y: auto;\n      overflow-x: hidden;\n      -webkit-overflow-scrolling: touch;\n      max-height: calc(var(--ip-rows,1) * var(--ip-h,44px)\n                      + (var(--ip-rows,1) - 1) * var(--ip-gap,8px));\n    }\n\n    /* Сетка: перенос вниз, ширина по контенту */\n    .ip-grid {\n      display: flex;\n      flex-wrap: wrap;\n      gap: var(--ip-gap,8px);\n      align-content: flex-start;\n      justify-content: flex-start;\n    }\n\n    .ip-btn {\n      position: relative;\n      overflow: hidden;\n      width: var(--ip-w,44px);\n      height: var(--ip-h,44px);\n      border: 2px solid #d0d0d0;\n      border-radius: 10px;\n      background: #fff;\n      padding: 0;\n      cursor: pointer;\n      touch-action: manipulation;\n    }\n    .ip-btn[selected] {\n      border-color: #0b74ff;\n      box-shadow: 0 0 0 3px rgba(11,116,255,.15);\n    }\n\n    .ip-slot {\n      position: relative;\n      width: 100%;\n      height: 100%;\n    }\n    .ip-slot img {\n      width: 100%;\n      height: 100%;\n      display: block;\n      object-fit: cover;\n    }\n    .ip-slot * {\n      pointer-events: none;\n    }\n  ",document.head.appendChild(e)}function resolveFieldBySuffix(e){const t=`fld${String(e)}`,n=`form[fld${String(e)}]`;return document.querySelector(`#${CSS.escape(t)}[name="${n}"]`)||document.getElementById(t)||document.querySelector(`[name="${n}"]`)}function normalizeModalLinkAttrs(e){const t=document.createElement("template");return t.innerHTML=String(e??""),t.content.querySelectorAll("a.modal-link").forEach(e=>{Array.from(e.attributes).forEach(t=>{"class"!==t.name&&"style"!==t.name&&e.removeAttribute(t.name)})}),t.innerHTML.trim()}function prepareModalLinkAttrs(e){const t=document.createElement("template");t.innerHTML=String(e??"");const n=t.content.querySelectorAll("a.modal-link");if(n.length){const e=new URL(location.href).searchParams.get("id"),t=e&&/^\d+$/.test(e)?`usr${e}`:null;n.forEach(e=>{e.setAttribute("data-reveal-id","character"),t&&e.setAttribute("id",t)})}return t.innerHTML.trim()}function createThumbSlot(e){const t=document.createElement("div");t.className="ip-slot";const n=String(e??"").trim();if(!n)return t;const r=document.createElement("template");if(r.innerHTML=n,r.content.querySelector("*"))t.appendChild(r.content.cloneNode(!0));else{const e=document.createElement("img");e.src=n,e.alt="",e.loading="lazy",t.appendChild(e)}return t}function keyFor(e){const t=String(e??"");let n=5381;for(let e=0;e<t.length;e++)n=(n<<5)+n^t.charCodeAt(e);return"k"+(n>>>0).toString(36)}const FORM_STATE=new WeakMap;function applyImagePicker(e,t,n={}){if(!isProfileFieldsPage())return;injectStylesOnce();const r=!!n.modalLinkMode,o=(Array.isArray(e)?e:[]).map(e=>String(e??"")),a=resolveFieldBySuffix(t);if(!a)return;a.classList.add("ip-hidden");const i=Number.isFinite(n.btnWidth)?Math.max(1,n.btnWidth):44,s=Number.isFinite(n.btnHeight)?Math.max(1,n.btnHeight):44,c=Number.isFinite(n.gridColSize)?Math.max(1,n.gridColSize):i,l=o.map(e=>r?normalizeModalLinkAttrs(e):e),d=new Set(l),u=new Map(l.map(e=>[e,keyFor(e)])),p=r?normalizeModalLinkAttrs(String(a.value??"")):String(a.value??"");let m=null;if(o.length>0){const e=document.createElement("div");e.className="ip-box",e.style.setProperty("--ip-rows",String(1)),e.style.setProperty("--ip-gap","8px"),e.style.setProperty("--ip-w",`${i}px`),e.style.setProperty("--ip-h",`${s}px`),e.style.setProperty("--ip-col",`${c}px`);const t=document.createElement("div");t.className="ip-scroll";const n=document.createElement("div");n.className="ip-grid";const d=a.id?document.querySelector(`label[for="${a.id}"]`):null;(a.closest("label")||d||a).insertAdjacentElement("afterend",e),t.addEventListener("pointerdown",e=>e.stopPropagation()),t.addEventListener("click",e=>e.stopPropagation()),l.forEach((e,t)=>{const a=document.createElement("button");a.type="button",a.className="ip-btn",a.dataset.key=u.get(e);const i=r?e:o[t];a.appendChild(createThumbSlot(i));const s=t=>{t.preventDefault(),t.stopPropagation(),g(e)};a.addEventListener("pointerdown",s),a.addEventListener("click",s),n.appendChild(a)}),t.appendChild(n),e.appendChild(t),m=n}function f(e){if(!m)return;const t=u.get(String(e))||"";if(m.querySelectorAll(".ip-btn").forEach(e=>e.removeAttribute("selected")),t){const e=m.querySelector(`.ip-btn[data-key="${t}"]`);e&&e.setAttribute("selected","")}}let h=!1;function g(e){const t=String(e??"");a.value!==t&&(h=!0,a.value=t,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),h=!1),f(t)}const y=l[0]||"",w=o.length?d.has(p)?p:y:"";a.dataset.ipInitial=w,g(w),a.addEventListener("input",()=>{h||f(r?normalizeModalLinkAttrs(String(a.value??"")):String(a.value??""))}),a.addEventListener("change",()=>{h||f(r?normalizeModalLinkAttrs(String(a.value??"")):String(a.value??""))});const v=a.closest("form");if(!v)return{set:g};let b=FORM_STATE.get(v);b||(b={entries:[],hooked:!1},FORM_STATE.set(v,b));if(b.entries.push({input:a,fieldSuffix:t,prepareOne:()=>{let e=r?normalizeModalLinkAttrs(String(a.value??"")):String(a.value??"");if(!o.length){const e=r?prepareModalLinkAttrs(""):"";return a.value=e,e}if(!d.has(e)){const t=a.dataset.ipInitial??y;e=String(t),g(e)}const t=r?prepareModalLinkAttrs(e):e;return a.value=t,t}}),!b.hooked){b.hooked=!0;const e=v.submit,t=()=>{b.entries.forEach(({prepareOne:e})=>{e()})};v.addEventListener("submit",e=>{"1"!==v.dataset.ipResuming&&t()},!0),v.addEventListener("formdata",e=>{t(),b.entries.forEach(({input:t,fieldSuffix:n})=>{try{const r=t.name||`form[fld${n}]`;e.formData.set(r,t.value)}catch(e){}})}),v.submit=function(...n){return"1"===v.dataset.ipResuming||t(),e.apply(this,n)}}return{set:g}}async function FMVreplaceFieldData(e,t,n,r=!1){const o=`/profile.php?section=fields&id=${encodeURIComponent(e)}&nohead`,a="#fld"+t;try{const e=await fetchCP1251Doc(o),s=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!s)return{status:"error",fieldId:String(t),value:n,serverMessage:"Форма редактирования профиля не найдена",details:"profile.php без формы"};const c=s.querySelector(a);if(!c)return{status:"error",fieldId:String(t),value:n,serverMessage:`Поле ${a} не найдено. Проверьте номер fld.`};const l=c.value??"";if(""!==(i=l)&&" "!==i&&!r)return{status:"nochange",fieldId:String(t),value:n,serverMessage:"Поле уже содержит значение. Перезапись запрещена.",details:`Прежнее значение: ${String(l)}`};if(c.value=n,![...s.elements].some(e=>"update"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="update",t.value="1",s.appendChild(t)}let d="update";const u=[...s.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));u?.name&&(d=u.name);const p=serializeFormCP1251_SelectSubmit(s,d),m=s.getAttribute("action")||"/profile.php",{res:f}=await fetchCP1251Text(m,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:o,referrerPolicy:"strict-origin-when-cross-origin",body:p});if(!f.ok)return{status:"error",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:`HTTP ${f.status} при сохранении`};const h=await fetchCP1251Doc(o),g=h.querySelector("form#profile8")||[...h.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));return(g?.querySelector(a)?.value??null)===n?{status:"updated",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Значение успешно обновлено"}:{status:"uncertain",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Не удалось подтвердить новое значение, проверьте вручную"}}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,n}var i}async function FMVupdateGroupIfEquals(e,t,n,r={}){const o=!!r.overwriteSame,a=String(e),i=`/profile.php?section=admin&id=${encodeURIComponent(a)}&nohead`;try{const e=await fetchCP1251Doc(i),r=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!r)return{status:"error",userId:a,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Форма администрирования профиля не найдена",details:"profile.php?section=admin без ожидаемой формы"};const s=r.querySelector('select[name="group_id"]')||r.querySelector("#group_id");if(!s)return{status:"error",userId:a,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Селектор group_id не найден"};const c=(s.value??"").trim(),l=String(t).trim(),d=String(n).trim();if(c===d&&!o)return{status:"nochange",userId:a,fromGroupId:l,toGroupId:d,serverMessage:"Пользователь уже в целевой группе; перезапись отключена",details:`current=${c}`};if(c!==l&&(c!==d||!o))return{status:"skipped",userId:a,fromGroupId:l,toGroupId:d,serverMessage:"Текущая группа не совпадает с fromGroupId — изменения не требуются",details:`current=${c}`};if(s.value=d,![...r.elements].some(e=>"form_sent"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="form_sent",t.value="1",r.appendChild(t)}let u="update_group_membership";const p=[...r.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(r,u),f=r.getAttribute("action")||`/profile.php?section=admin&id=${encodeURIComponent(a)}`,{res:h,text:g}=await fetchCP1251Text(f,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:i,referrerPolicy:"strict-origin-when-cross-origin",body:m});if(!h.ok)return{status:"error",userId:a,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:`HTTP ${h.status} при сохранении`};const y=await fetchCP1251Doc(i),w=y.querySelector("form#profile8")||[...y.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php")),v=w?.querySelector('select[name="group_id"]')||w?.querySelector("#group_id"),b=(v?.value??"").trim();return b===d?{status:"updated",userId:a,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:"Группа успешно обновлена"}:{status:"uncertain",userId:a,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:"Сервер ответил 200, но подтвердить новое значение не удалось — проверьте вручную",details:`readback=${b}`}}catch(r){const o=r&&r.message?r.message:String(r);return{status:"error",userId:String(e),fromGroupId:String(t),toGroupId:String(n),serverMessage:"Transport/Runtime error",details:o}}}async function fetchCardsWrappedClean(e,t,n={}){const{isCoupon:r=!1}=n,o=`${location.origin.replace(/\/$/,"")}/viewtopic.php?id=${encodeURIComponent(String(e))}`,a=e=>{const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""},i=e=>(new DOMParser).parseFromString(e,"text/html");const s=i(await async function(e){if("function"==typeof window.fetchHtml)return window.fetchHtml(e);const t="function"==typeof window.fetchWithRetry?window.fetchWithRetry:fetch,n=await t(e,{credentials:"include"}),r=await n.arrayBuffer(),o=/charset=([^;]+)/i.exec(n.headers.get("content-type")||"")?.[1]?.toLowerCase(),a=e=>{try{return new TextDecoder(e).decode(r)}catch{return null}};if(o){const e=a(o);if(e)return e}const i=a("utf-8")??"",s=a("windows-1251")??"",c=e=>(e.match(/\uFFFD/g)||[]).length;if(c(s)&&!c(i))return i;if(c(i)&&!c(s))return s;const l=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return l(s)>l(i)?s:i}(o)),c=[];for(const e of t){const t=s.querySelector(`#p${String(e)}-content`);if(!t){console.warn(`Не найден #p${e}-content на ${o}`);continue}const n=[...t.querySelectorAll('script[type="text/html"]')];if(!n.length)continue;const l=[...i(a(n.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," ")).querySelectorAll("#grid article.card")].map(e=>{const t=FMV.normSpace(e.querySelector(".id")?.textContent||""),n=FMV.normSpace(e.querySelector(".desc")?.textContent||""),o=(e.querySelector(".content")?.innerHTML||"").replace(/\u00A0/g," ").trim(),a=n?` title="${n}"`:"";let i="";if(r){const t=FMV.normSpace(e.querySelector(".title")?.textContent||""),n=FMV.normSpace(e.querySelector(".type")?.textContent||""),r=FMV.normSpace(e.querySelector(".form")?.textContent||""),o=FMV.normSpace(e.querySelector(".value")?.textContent||"");i=`${t?` data-coupon-title="${t}"`:""}${n?` data-coupon-type="${n}"`:""}${r?` data-coupon-form="${r}"`:""}${o?` data-coupon-value="${o}"`:""}`}return{id:t,html:`<div class="item" data-id="${t}"${a}${i}>${o}</div>`}});c.push(...l)}return c}function findChronoRendered(e){const t=Array.from(e.querySelectorAll("*")).find(e=>/Собранная\s+хронология/i.test(e.textContent||""));return t?t.closest(".quote-box, .media, .spoiler-box, .content, .post, div, section")||t:null}function renderStatus(e,t){const n=window.CHRONO_CHECK?.EpisodeMapType||{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},r=window.CHRONO_CHECK?.EpisodeMapStat||{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},o=n[e]||n.au,a=r[t]||r.archived;return`[color=${o[1]}]${o[0]}[/color] / [color=${a[1]}]${a[0]}[/color]`}function parseParagraph(e){const t=[[],[],[],[]];let n=0;for(const r of e.childNodes)1!==r.nodeType||"BR"!==r.tagName?t[n].push(r):n=Math.min(n+1,3);const r=t[0],o=t[1],a=t[2],i=t[3],s=document.createElement("div");r.forEach(e=>s.appendChild(e.cloneNode(!0)));const c=s.querySelector('a[href*="viewtopic.php?id="]')||e.querySelector('a[href*="viewtopic.php?id="]'),{type:l,status:d,order:u,dateStart:p,dateEnd:m,title:f}=parseHeaderNew(r,o,c),{participants:h,masksLines:g}=parseParticipants(a),y=cleanLocation(textFromNodes(i)),w="au"===l?"":p||"",v="au"===l?"":m||w||"";return{type:l,status:d,title:f,href:c?.href||"",dateStart:w,dateEnd:v,order:Number.isFinite(u)?u:0,participants:h,masksLines:g,location:y}}function parseHeaderNew(e,t,n){const r=(n?.textContent||"").trim(),o=document.createElement("div");e.forEach(e=>o.appendChild(e.cloneNode(!0)));const a=(o.textContent||"").replace(/\s+/g," ").trim();let i="",s="",c=(o.querySelector("strong")?.textContent||"").trim();if(c){const e=c.replace(/[\u2012-\u2015\u2212—–−]/g,"-").replace(/\s*-\s*/g,"-").split("-").slice(0,2).map(e=>e.trim());i=e[0]||"",s=e[1]||""}else{const e=a.split(/\s[—–-]\s/)[0]?.trim()||"",t=parseDateFlexible(e);if(t&&t.hasDate){const e=e=>null!=e?.y?null!=e.d?`${String(e.d).padStart(2,"0")}.${String(e.m).padStart(2,"0")}.${e.y}`:null!=e.m?`${String(e.m).padStart(2,"0")}.${e.y}`:String(e.y):"";i=e(t.left),s=!t.right||t.right.y===t.left.y&&null==t.right.m&&null==t.right.d?"":e(t.right)}}/дата\s+не\s+указан/i.test(c||"")&&(i="",s="");let l="",d="",u=0;const p=textFromNodes(t).match(/\[([^\]]+)\]/);if(p){const e=p[1].split("/").map(e=>e.trim());if(l=(e[0]||"").toLowerCase(),d=(e[1]||"").toLowerCase(),e[2]){const t=parseInt(e[2],10);Number.isFinite(t)&&(u=t)}}return{type:l,status:d,order:u,dateStart:i,dateEnd:s,title:r}}function parseParticipants(e){const t=[];!function e(n){Array.from(n).forEach(n=>{3===n.nodeType?t.push({t:"text",v:n.nodeValue||""}):1===n.nodeType&&("A"===n.tagName?t.push({t:"link",name:(n.textContent||"").trim(),href:n.href||""}):e(n.childNodes))})}(e);const n=[],r=new Map;let o=null;for(const e of t){if("link"===e.t){const t=e.name;n.push({name:t,href:e.href}),o=t;continue}if("text"===e.t){let t=e.v||"";if(/\bне\s*указан/i.test(t))return{participants:[],masksLines:[]};t=t.replace(/\[\s*as\s*([^\]]+)\]/gi,(e,t)=>{const n=t.split(/\s*,\s*/).map(e=>e.trim()).filter(Boolean);var a,i;return i=n,(a=o)&&i&&i.length&&(r.has(a)||r.set(a,[]),r.get(a).push(...i)),""}),t.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{/^[–—-]+$/.test(e)||/^\[.*\]$/.test(e)||(n.push({name:e,href:""}),o=e)})}}const a=[];for(const e of n){const t=r.get(e.name);t&&t.length&&t.forEach(t=>a.push(`${e.name} — ${t}`))}return{participants:n,masksLines:a}}function cleanLocation(e){const t=String(e||"").trim();return t?/^локац/i.test(t)&&/не\s+указан/i.test(t)||/^не\s+указан/i.test(t)?"":t:""}async function collectEpisodesFromForums(e={}){async function t(e,t,n){const r=[],o=new Set;for(const a of t){const t=Promise.resolve().then(()=>n(a));r.push(t),o.add(t);const i=()=>o.delete(t);t.then(i,i),o.size>=e&&await Promise.race(o)}return Promise.all(r)}let n=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];if(!n.length){const e=new Set;document.querySelectorAll('a[href*="viewforum.php?id="]').forEach(t=>{const n=String(t.getAttribute("href")||"").match(/viewforum\.php\?id=(\d+)/i);n&&e.add(n[1])}),n=Array.from(e).map(e=>({id:e}))}if(!n.length)return console.warn("[collectEpisodesFromForums] Не удалось определить список разделов (sections)"),[];const r=(e,t)=>{try{return new URL(t,e).href}catch{return t}};const o=/[\u2012-\u2015\u2212—–−]/g,a=/[.\u2024\u2219\u00B7\u2027\u22C5·∙•]/g,i=e=>String(e).padStart(2,"0");function s(e){const t=Number(e);return Number.isFinite(t)?2===String(e).length?t>30?1900+t:2e3+t:t:null}function c(e,t){return new Date(e,t,0).getDate()}function l(e){const t=String(e||"").trim().replace(a,".");let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);if(n){const e=+n[1],t=+n[2],r=s(n[3]);return t<1||t>12||(e<1||e>c(r,t))?null:{y:r,m:t,d:e}}if(n=t.match(/^(\d{1,2})\.(\d{2}|\d{4})$/),n){const e=+n[1],t=s(n[2]);if(e>=1&&e<=12)return{y:t,m:e}}if(n=t.match(/^(\d{1,2})\.(\d{1,2})$/),n){const e=+n[1],t=+n[2];return t>=1&&t<=12&&e>=1&&e<=31?{m:t,d:e}:null}return n=t.match(/^(\d{2}|\d{4})$/),n?{y:s(n[1])}:null}function d(e){return null!=e.d?`${i(e.d)}.${i(e.m)}.${e.y}`:null!=e.m?`${i(e.m)}.${e.y}`:String(e.y)}function u(e){let t=String(e||"").trim();if(!t)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};t=t.replace(o,"-").replace(a,".").replace(/\s*-\s*/g,"-");const n=t.split("-").slice(0,2);if(1===n.length){const e=l(n[0]);if(!e||!e.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};const t=[e.y,e.m??0,e.d??0];return{hasDate:!0,display:d(e),startSort:t,endSort:t,left:e,right:e}}const r=n[0].trim(),u=n[1].trim(),p=l(u);if(!p||!p.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};let m=l(r);const f=r.match(/^\d{1,2}$/);if(f){const e=+f[0];m=null!=p.d&&null!=p.m?{y:p.y,m:p.m,d:e}:null!=p.m?{y:p.y,m:e}:{y:s(e)}}const h=/^\d{1,2}$/.test(r),g=/^\d{1,2}$/.test(u);if(h&&g&&m?.y&&p?.y&&null==m.m&&null==m.d&&null==p.m&&null==p.d&&m.y>p.y){const e=100*Math.floor(p.y/100),t=+r;m.y=e+t}m&&null==m.y&&null!=m.d&&null!=m.m&&p.y&&(m.y=p.y);const y=e=>null==e.d||e.y&&e.m&&e.d>=1&&e.d<=c(e.y,e.m);if(!y(m)||!y(p))return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};return{hasDate:!0,startSort:[m.y,m.m??0,m.d??0],endSort:[p.y??m.y,p.m??0,p.d??0],display:(w=m,v=p,null!=w.d&&null!=v.d?`${i(w.d)}.${i(w.m)}.${w.y}-${i(v.d)}.${v.m}.${v.y}`:null!=w.m&&null!=v.m?`${i(w.m)}.${w.y}-${i(v.m)}.${v.y}`:`${w.y}-${v.y}`),left:m,right:p};var w,v}function p(e,t){for(let n=0;n<3;n++){const r=(e[n]??0)-(t[n]??0);if(r)return r}return 0}async function m(n,o){let a=r(location.href,`/viewforum.php?id=${n.id}`);const i=new Set,s=[];let c=0;const l=new Set;let d="";for(;a&&!i.has(a)&&c<100;){c++,i.add(a);const u=await FMV.fetchDoc(a),p=new Map;u.querySelectorAll('a[href*="viewtopic.php?id="]').forEach(e=>{const t=r(a,e.getAttribute("href")),n=t.match(/viewtopic\.php\?id=(\d+)/i),o=((i=e)&&(i.innerText??i.textContent)||"").trim();var i;n&&(/^\s*(RSS|Atom)\s*$/i.test(o)||/#p\d+$/i.test(t)||/^\d{1,2}\.\d{1,2}\.\d{2,4}(?:\s+\d{1,2}:\d{2})?$/.test(o)||p.set(n[1],{url:t,title:o}))});const m=Array.from(p.keys()).sort(),h=m.join(",");if(h&&h===d)break;d=h;const g=m.filter(e=>!l.has(e));if(0===g.length)break;g.forEach(e=>l.add(e));const y=Number.isFinite(+e?.concurrencyPerPage)?+e.concurrencyPerPage:6,w=Array.from(p.entries()),v=await t(y,w,async([e,{url:t,title:r}])=>{const a=e?`id:${e}`:`url:${t.replace(/#.*$/,"")}`;if(o.has(a))return null;const i=await f(t,r,n.type,n.status);return i?{key:a,row:i}:null});for(const e of v)e&&(o.add(e.key),s.push(e.row));const b=function(e){const t=e.querySelector('a[rel="next"], a[href*="&p="]:not([rel="prev"])');return t?t.getAttribute("href"):null}(u),S=b?r(a,b):null;if(!S||i.has(S)){a=null;break}a=S}return s}async function f(e,t,n,r){try{const o=await FMV.fetchDoc(e),a=o.querySelector(".post.topicpost .post-content")||o.querySelector(".post.topicpost")||o,i=function(e){const t=(e.querySelector("title")?.textContent||"").trim();if(/\[.+\]\s+.+/.test(t))return t;const n=e.querySelector(".crumbs, .crumbs-nav, #pun-crumbs1 .crumbs, #pun-crumbs1");if(n){const e=(n.textContent||"").replace(/\s+/g," ").trim(),t=e.split("»").pop()?.trim()||"";if(t)return t}const r=e.querySelector('a[href*="viewtopic.php?id="]');return(r?.textContent||"").trim()}(o),s=t||i||"",{dateRaw:c,episode:l}=function(e){const t=String(e||"").trim(),n=t.match(/^\s*\[(.*?)\]\s*(.*)$/s);if(n){const e=(n[1]||"").trim(),t=(n[2]||"").trim(),r=u(e);if(r&&r.hasDate)return{dateRaw:e,episode:t.replace(/\s+/g," ")}}return{dateRaw:"",episode:t.replace(/\s+/g," ")}}(s),p=u(c),m=function(e,t,n){const r=String(t||"").trim();let o=!0;if("plot"===e){const e=/\s\[\s*(?:c|с)\s*\]$/i,t=e.test(r);return o=!!n&&t,{title:t?r.replace(e,"").trim():r,ok:o}}if("au"===e){const e=/^(?:\[\s*au\s*\]\s+|\[\s*AU\s*\]\s+)/,t=e.test(r);return o=t,{title:t?r.replace(e,"").trim():r,ok:o}}return{title:r,ok:o}}(n,l||"",p.hasDate),f=FMV.readTagText(a,"characters"),h=FMV.readTagText(a,"location"),g=FMV.readTagText(a,"order"),y=await FMV.buildIdToNameMapFromTags(f),w=FMV.parseCharactersUnified(f,y,window.profileLink),v=w.ok?w.participantsLower:[],b=w.ok?w.masksByCharLower:new Map,S=FMV.parseOrderStrict(g).ok?FMV.parseOrderStrict(g).value:0,C=h?h.split(/\s*[,;]\s*/).map(e=>e.trim().toLowerCase()).filter(Boolean):[],x=v.map(e=>{const t=Array.from(b.get(e)||[]),n=/^user(\d+)$/i.exec(String(e));if(n){const e=n[1];return y&&y.has(e)?{id:e,name:y.get(e),masks:t}:{name:`user${e}`,masks:t}}return{name:String(e),masks:t}}),k=p.hasDate?null!=p.left?.d||null!=p.left?.m?d(p.left):String(p.left?.y??""):"";return{dateStart:k,dateEnd:p.hasDate?null!=p.right?.d||null!=p.right?.m?d(p.right):String(p.right?.y??p.left?.y??""):k||"",title:m.title||"",href:e,type:n,status:r,order:Number(S)||0,location:C.join(", "),participants:x,isTitleNormalized:m.ok,__hasDate:p.hasDate,__startSort:p.startSort,__endSort:p.endSort}}catch{return null}}const h=new Set;let g=[];for(const e of n){const t=await m(e,h);g=g.concat(t)}return g=g.filter(Boolean).sort(function(e,t){const n=!!e.__hasDate;if(n!==!!t.__hasDate)return n?-1:1;if(n){const n=p(e.__startSort,t.__startSort);if(n)return n;const r=p(e.__endSort,t.__endSort);if(r)return r}const r=e.order??0,o=t.order??0;return r!==o?r-o:String(e.title||"").toLowerCase().localeCompare(String(t.title||"").toLowerCase(),"ru",{sensitivity:"base"})}),g.forEach(e=>{delete e.__hasDate,delete e.__startSort,delete e.__endSort}),g}async function collectChronoByUser(e={}){if("function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");let t=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];const n=Number.isFinite(+e.maxPagesPerSection)?+e.maxPagesPerSection:void 0,r=await collectEpisodesFromForums({sections:t,maxPagesPerSection:n}),o=Object.create(null);r.forEach((e,t)=>{Number.isFinite(e.order)||(e.order=t)});for(const e of r){const t=(e.participants||[]).map(e=>{const t=e?.id?String(e.id).trim():"";return t?{id:t,name:(e.name||"").trim(),masks:Array.isArray(e.masks)?e.masks.slice():[]}:null}).filter(Boolean);for(const n of t){const r=t.filter(e=>e!==n).map(e=>({id:e.id,name:e.name,masks:e.masks.slice()})),a={dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",order:Number(e.order||0),location:e.location||"",masks:n.masks||[],participants:r,isTitleNormalized:!!e.isTitleNormalized};o[n.id]||(o[n.id]={name:n.name||"",episodes:[]}),o[n.id].episodes.push(a)}}return o}(async()=>{const{icons:e,plashki:t,backs:n}=await collectSkinSets();window.SKIN?.PlashkaFieldID&&applyImagePicker(t,SKIN.PlashkaFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0}),window.SKIN?.BackFieldID&&applyImagePicker(n,SKIN.BackFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0}),window.SKIN?.IconFieldID&&applyImagePicker(e,SKIN.IconFieldID,{btnWidth:44})})(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-bank-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-bank-link",t.innerHTML='\n      <span>Банковская операция:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePosts)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserLogin)return void t(e,"нет данных пользователя");const n=window.FORUMS_IDS?.Bank||[0];try{const r=await window.scrapePosts(window.UserLogin,n,{title_prefix:"Гринготтс",stopOnNthPost:1,keywords:"ИТОГО"});if(Array.isArray(r)&&r.length&&r[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t){e.classList.remove("is-empty"),e.href=t,e.textContent="Последняя"}(e,`${t}/viewtopic.php?${r[0].src}`,r[0].date_text||r[0].text)}else t(e)}catch(n){console.error("[bank_last_comment] scrapePosts failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-lastpost-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-lastpost-link",t.innerHTML='\n      <span>Последний пост:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePosts)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserLogin)return void t(e,"нет данных пользователя");const n=[...window.FORUMS_IDS?.PersonalPosts||[1e4],...window.FORUMS_IDS?.PlotPosts||[1e4]];try{const r=await window.scrapePosts(window.UserLogin,n,{stopOnNthPost:1,comments_only:!0});if(Array.isArray(r)&&r.length&&r[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t,n){e.classList.remove("is-empty"),e.href=t,e.textContent=n||"Последняя"}(e,`${t}/viewtopic.php?${r[0].src}`,r[0].date_text||"Последний пост")}else t(e)}catch(n){console.error("[post_last_comment] scrapePosts failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),(()=>{"use strict";"function"!=typeof window.extractErrorMessage&&(window.extractErrorMessage=()=>""),"function"!=typeof window.extractInfoMessage&&(window.extractInfoMessage=()=>""),"function"!=typeof window.classifyResult&&(window.classifyResult=()=>"unknown"),window.FMV=window.FMV||{},window.FMV.replaceComment=async function(e,t,n){const r="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():null,o=new Set((e||[]).map(e=>String(Number(e))));if(!r||!o.has(String(Number(r))))return{ok:!1,status:"forbidden",postId:String(t),newText:n,errorMessage:"Нет доступа по группе"};const a=parseInt(t,10);if(!Number.isFinite(a))return{ok:!1,status:"badid",postId:String(t),newText:n,errorMessage:`Некорректный postId: ${t}`};const i=String(a),s=`/edit.php?id=${encodeURIComponent(i)}&action=edit`;try{let e,t,r,o="";try{e=await fetchCP1251Doc(s),o=e.documentElement?e.documentElement.outerHTML:"",r=e.querySelector('textarea#main-reply[name="req_message"], textarea[name="req_message"]'),r&&(t=r.closest("form"))}catch(e){return{ok:!1,status:"transport",postId:i,newText:n,errorMessage:e?.message||String(e)}}if(!t||!r){const e=extractInfoMessage(o)||"",t=extractErrorMessage(o)||"";return{ok:!1,status:classifyResult(o)||"noform",postId:i,newText:n,infoMessage:e,errorMessage:t}}const a=String(r.value||"").trim();r.value=n;const c=[...t.elements].find(e=>"submit"===e.type&&(e.name||/Отправ|Сохран|Submit|Save/i.test(e.value||"")))?.name||"submit",l=serializeFormCP1251_SelectSubmit(t,c),{res:d,text:u}=await fetchCP1251Text(s,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l,referrer:s,referrerPolicy:"strict-origin-when-cross-origin"}),p=extractInfoMessage(u)||"",m=extractErrorMessage(u)||"",f=classifyResult(u);let h="string"==typeof f?f:f&&(f.status||f.code)?String(f.status||f.code):"unknown";return!d.ok||"unknown"!==h&&""!==h||(h="ok"),d.ok&&"ok"===h?{ok:!0,status:"ok",postId:i,oldText:a,newText:n,httpStatus:d.status}:{ok:!1,status:h,postId:i,oldText:a,newText:n,httpStatus:d.status,infoMessage:p.slice(0,200),errorMessage:m.slice(0,200)}}catch(e){return{ok:!1,status:"transport",postId:String(t),newText:n,errorMessage:e?.message||String(e)}}}})(),function(){"use strict";window.checkChronoFields=function(e=[]){const t=window.CHRONO_CHECK;return!(!t||"object"!=typeof t)&&(!Array.isArray(e)||!e.length||e.every(e=>{const n=t[e];return null!=n&&(Array.isArray(n)?n.length>0:"string"==typeof n?""!==n.trim():"number"==typeof n?Number.isFinite(n):"object"!=typeof n||Object.keys(n).length>0)}))}}(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_update_total] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,a=window.CHRONO_CHECK.ForumInfo;let i=!1;function s(e="",t=200){const n=String(e).replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"…":n}createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить общее хроно",order:1,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть ссылку",linkHref:o,async onClick(t){if(i)return;i=!0;const n=t?.setStatus||(()=>{}),c=t?.setDetails||(()=>{});t?.setLinkVisible?.(!1),t?.setLink?.("","");try{if(n("Собираю…"),c(""),"function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");const i=await collectEpisodesFromForums({sections:a});n("Формирую текст…");const d=function(e){const t=(e||[]).map(e=>{const t=renderStatus(e.type,e.status),n="au"===e.type?"":e.dateStart?`[b]${FMV.escapeHtml(e.dateEnd&&e.dateEnd!==e.dateStart?`${e.dateStart}-${e.dateEnd}`:e.dateStart)}[/b]`:"[mark]дата не указана[/mark]",r=FMV.escapeHtml(e.href||""),o=FMV.escapeHtml(e.title||""),a=e.isTitleNormalized?"":"au"===e.type?" [mark]в названии нет [au][/mark]":" [mark]в названии нет [с][/mark]",i=`${FMV.escapeHtml(String(e.order??0))}`,s=!0;return`${n}${n?" — ":" "}[url=${r}]${o}[/url]${a}\n[${t} / ${i}]\n[i]${Array.isArray(e.participants)&&e.participants.length?e.participants.map(e=>{const t=null!=e.id&&""!==e.id?userLink(String(e.id),e.name,s):missingUser(String(e.name||""),s),n=Array.isArray(e.masks)?e.masks:[];return`${t}${n.length?` [as ${FMV.escapeHtml(n.join(", "))}]`:""}`}).join(", "):"[mark]не указаны[/mark]"}[/i]\n${e.location?FMV.escapeHtml(e.location):"[mark]локация не указана[/mark]"}\n\n`});return`[media="Общая хронология"]${t.join("")||""}[/media]`}(i);n("Записываю…");const u=FMV.toCp1251Entities(d),p=await FMV.replaceComment(e,r,u),m=null==(l=p.status)?"":"string"==typeof l?l:String("object"==typeof l?l.status||l.code||(l.ok?"ok":"unknown"):l),f=!!p.ok||"ok"===m;n(f?"Готово":"Ошибка"),f?(t?.setLink?.(o,"Открыть ссылку"),t?.setLinkVisible?.(!0)):(t?.setLink?.("",""),t?.setLinkVisible?.(!1));const h=s(p.infoMessage||""),g=s(p.errorMessage||""),y=[`Статус: ${f?"ok":m||"unknown"}`];h&&y.push(h),g&&y.push(`<span style="color:#b00020">${FMV.escapeHtml(g)}</span>`),c(y.join("<br>"))}catch(e){n("Ошибка"),c(FMV.escapeHtmlShort(e?.message||String(e))),t?.setLinkVisible?.(!1),t?.setLink?.("","")}finally{i=!1}var l}}),"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`)})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_total_to_excel] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,a=(window.SITE_URL||location.origin).replace(/\/+$/,""),i=window.CHRONO_CHECK.ForumInfo;let s="";createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"выгрузить общее хроно в excel",order:2,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Скачать",linkHref:"",async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{}),r=e?.setLink||(()=>{});e?.setLink?.("","");try{t("Собираю…"),n("");const p=await collectEpisodesFromForums({sections:i});if(!p.length)throw new Error("Эпизоды не найдены.");const h=p.map(e=>{const t=(e.participants||[]).map(e=>{const t=String(e.name||"").trim();if(!t)return"";if(null!=e.id&&""!==e.id){return`${t} — ${`${a}/profile.php?id=${encodeURIComponent(String(e.id))}`}`}return t}).filter(Boolean).join("\n"),n=(e.participants||[]).flatMap(e=>{const t=Array.isArray(e.masks)?e.masks.filter(Boolean):[],n=String(e.name||"").trim()||(null!=e.id?`user${e.id}`:"");return t.map(e=>`${n} — ${e}`)}).filter(Boolean);return{type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",order:Number(e.order||0)||0,participantsText:t,masksLines:n,location:e.location||""}});t("Формирую файл…");const{blob:g,filename:v}=function(e){const t=[],n=(e,n)=>t.push({name:e,data:c(n)}),r='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n</Relationships>',o='<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"\n          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n  <sheets>\n    <sheet name="Хронология" sheetId="1" r:id="rId1"/>\n  </sheets>\n</workbook>';n("[Content_Types].xml",'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml"  ContentType="application/xml"/>\n  <Override PartName="/xl/workbook.xml"          ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>\n  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n</Types>'),n("_rels/.rels",'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n</Relationships>'),n("xl/workbook.xml",o),n("xl/_rels/workbook.xml.rels",r),n("xl/worksheets/sheet1.xml",function(e){const t=`<row r="1">${["Тип","Статус","Тема","Дата начала","Дата конца","Порядок","Участники","Маски","Локация"].map(y).join("")}</row>`,n=e.map((e,t)=>`<row r="${t+2}">${[y(e.type||""),y(e.status||""),b(e.href||"",e.title||e.href||""),y(e.dateStart||""),y(e.dateEnd||e.dateStart||""),w(e.order||0),y(e.participantsText||""),y((e.masksLines||[]).join("\n")),y(e.location||"")].join("")}</row>`).join("");return`<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n  <sheetData>${t}${n}</sheetData>\n</worksheet>`}(e));const a=function(e){const t=f(),n=[],r=[];let o=0;e.forEach(e=>{const a=c(e.name),i=e.data,s=m(i),p=u([d(67324752),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(i.length),d(i.length),l(a.length),l(0),a,i]),f=u([d(33639248),l(20),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(i.length),d(i.length),l(a.length),l(0),l(0),l(0),l(0),d(0),d(o),a]);n.push(p),r.push(f),o+=p.length});const a=u(r),i=n.reduce((e,t)=>e+t.length,0),s=a.length,p=u([d(101010256),l(0),l(0),l(e.length),l(e.length),d(s),d(i),l(0)]);return new Blob([u([...n,a,p])],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}(t),i=`chronology_${(new Date).toISOString().slice(0,10)}.xlsx`;return{blob:a,filename:i}}(h);if(s)try{URL.revokeObjectURL(s)}catch{}s=URL.createObjectURL(g),t("Готово"),n(`Строк: ${h.length}\nИсточник: ${FMV.escapeHtml(o)}\nФайл: ${FMV.escapeHtml(v)}`),r(s,"Скачать");const S=e?.wrap?.querySelector("a.fmv-action-link");S&&S.setAttribute("download",v)}catch(r){t("Ошибка"),n(FMV.escapeHtmlShort(r?.message||String(r))),e?.setLink?.("","")}}});const c=e=>(new TextEncoder).encode(e),l=e=>new Uint8Array([255&e,e>>>8&255]),d=e=>new Uint8Array([255&e,e>>>8&255,e>>>16&255,e>>>24&255]),u=e=>{let t=0;e.forEach(e=>t+=e.length);const n=new Uint8Array(t);let r=0;return e.forEach(e=>{n.set(e,r),r+=e.length}),n},p=(()=>{let e,t=new Uint32Array(256);for(let n=0;n<256;n++){e=n;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e>>>0}return t})(),m=e=>{let t=~0;for(let n=0;n<e.length;n++)t=t>>>8^p[255&(t^e[n])];return(-1^t)>>>0},f=(e=new Date)=>({time:(31&e.getHours())<<11|(63&e.getMinutes())<<5|31&Math.floor(e.getSeconds()/2),date:(e.getFullYear()-1980&127)<<9|(e.getMonth()+1&15)<<5|31&e.getDate()}),h=e=>String(e||"").replace(/[<>&"]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e])),g=e=>String(e||"").replace(/"/g,'""');function y(e){return`<c t="inlineStr"><is><t xml:space="preserve">${h(e).replace(/\r?\n/g,"&#10;")}</t></is></c>`}function w(e){return`<c><v>${Number(e)||0}</v></c>`}function v(e){return`<c><f>${h(e)}</f></c>`}function b(e,t){return e&&t?v(`HYPERLINK("${g(e)}","${g(t)}")`):e&&!t?v(`HYPERLINK("${g(e)}","${g(e)}")`):y(t||"")}})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","PerPersonChronoPostID","ForumInfo"]))return void console.warn("[button_update_per_user] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, PerPersonChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.PerPersonChronoPostID).trim(),o=(window.SITE_URL||location.origin).replace(/\/+$/,""),a=window.CHRONO_CHECK.ForumInfo;"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`);const i=e=>String(e||"").trim();function s(e){const t=function(e,t){const n=i(e),r=i(t);return n||r?r&&r!==n?`[b]${n}-${r}[/b]`:`[b]${n}[/b]`:""}(e.dateStart,e.dateEnd),n=`[url=${FMV.escapeHtml(i(e.href))}]${FMV.escapeHtml(i(e.title)||i(e.href))}[/url]`,r=Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:"",o=t?`${t} — ${n}${r}`:`${n}${r}`,a=`[${renderStatus(e.type,e.status)} / ${`${FMV.escapeHtml(String(e.order??0))}`}]`,s=function(e=[]){return e.length?`[i]${e.map(e=>{const t=!0;return`${null!=e.id&&""!==String(e.id)?userLink(String(e.id),e.name,t):missingUser(String(e.name||""),t)}${Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:""}`}).join(", ")}[/i]`:""}(e.participants||[]),c=[o,a];return s&&c.push(s),i(e.location)&&c.push(FMV.escapeHtml(i(e.location))),c.join("\n")}const c=`${o}/viewtopic.php?id=${n}#p${r}`;createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить хроно по персам",order:3,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть пост",linkHref:c,async onClick(t){const l=t?.setStatus||(()=>{}),d=t?.setDetails||(()=>{}),u=t?.setLink||(()=>{}),p=t?.setLinkVisible||(()=>{});u("",""),p?.(!1);try{l("Собираю…"),d("");const t=await(window.collectChronoByUser?window.collectChronoByUser({sections:a}):Promise.reject(new Error("collectChronoByUser недоступна"))),m=Object.entries(t||{}).map(([e,t])=>({id:e,name:t?.name||"",episodes:Array.isArray(t?.episodes)?t.episodes:[]})).filter(e=>e.name).sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));if(!m.length)return l("Пусто"),void d("Нет данных для вывода.");l("Формирую текст…");const f=m.map(e=>function(e,t=[]){return`[media="[url=${o}/viewtopic.php?id=${n}]${FMV.escapeHtml(i(e))}[/url]"]\n${t.map(s).join("\n\n")}\n[/media]`}(e.name,e.episodes)).join("\n\n"),h=`[media="Хронология по персонажам"]\n${f}\n[/media]`;l("Записываю…");const g=FMV.toCp1251Entities(h),y=await FMV.replaceComment(e,r,g),w=String(y?.status||""),v=!!y?.ok||"ok"===w;l(v?"Готово":"Ошибка"),v?(u(c,"Открыть пост"),p?.(!0)):(u("",""),p?.(!1));const b=(y?.infoMessage||"").replace(/<[^>]*>/g," ").trim(),S=(y?.errorMessage||"").replace(/<[^>]*>/g," ").trim(),C=[`Статус: ${v?"ok":w||"unknown"}`];b&&C.push(b),S&&C.push(S),d(C.join("<br>"))}catch(e){l("Ошибка"),d(e?.message||String(e)),u("",""),p?.(!1)}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ForumInfo"]))return void console.warn("[button_update_personal_page] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=window.CHRONO_CHECK.ForumInfo;function r(e){const t=o(e);if("function"!=typeof t)throw new Error(`${e} не найден — подключите соответствующий скрипт`);return t}function o(e){return e.split(".").reduce((e,t)=>e&&e[t],window)}async function a(e,t={}){const n=r("FMVeditPersonalPage"),o=r("collectChronoByUser"),a=r("FMV.buildChronoHtml"),i=String(e),s=`usr${i}_chrono`,c=t.sections;let l;try{l=await o({sections:c})}catch(e){return{id:i,status:`ошибка collectChronoByUser: ${e?.message||e}`}}const d=l?.[i];if(!d)return{id:i,status:"нет данных (пользователь не найден в хроно-коллекции)"};let u,p;try{u=a(d,{titlePrefix:"Хронология"})}catch(e){return{id:i,status:`ошибка buildChronoHtml: ${e?.message||e}`}}try{p=await n(s,{content:u})}catch(e){return{id:i,status:`ошибка сохранения: ${e?.message||e}`}}const m=function(e){const t=(e&&(e.status||e.result||e.ok))??"unknown";return!0===t||"ok"===t||"saved"===t||"success"===t?"обновлено":"forbidden"===t||"noaccess"===t?"нет доступа":"notfound"===t?"страница не найдена":String(t)}(p);return{id:i,status:m,page:s}}function i(e){const t=String(e||"").toLowerCase();return t.includes("нет доступа")?"нет доступа":t.includes("нет данных")||t.includes("не найден")?"пользователь не упоминается в хронологии":""}window.FMV||(window.FMV={}),"function"!=typeof window.userLinkHtml&&(window.userLinkHtml=(e,t)=>`${FMV.escapeHtml(String(t||e))}`),createForumButton({allowedGroups:e,allowedForums:t,label:"обновить личные страницы",order:4,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),r=e?.setDetails||(()=>{});r("");try{t("Собираю…");const e=Array.isArray(window.CHRONO_CHECK?.UserIDs)?window.CHRONO_CHECK.UserIDs:void 0,s=await async function(e){const t=window.FMV&&"function"==typeof FMV.fetchUsers?FMV.fetchUsers:null;let n=[];if(Array.isArray(e)&&e.length)n=e.map(e=>({id:String(e)}));else if(t)try{const e=await t();n=Array.isArray(e)?e:[]}catch{}const r=new Map;for(const e of n){if(!e)continue;const t=String(e.id??""),n=String(e.name??"").trim();t&&r.set(t,n||t)}return r}(e);t("Обновляю…");const c=await async function(e={}){const t=Number.isFinite(e.delayMs)?e.delayMs:200;let n;if(Array.isArray(e.ids)&&e.ids.length)n=e.ids.map(e=>({id:String(e)}));else{const e=o("FMV.fetchUsers");if("function"!=typeof e)throw new Error("Не заданы ids и отсутствует FMV.fetchUsers()");const t=await e();n=Array.isArray(t)?t:[]}const r=[];for(const o of n){const n=await a(o.id,{sections:e.sections});r.push(n),t&&await FMV.sleep(t)}try{console.table(r.map(e=>({id:e.id,status:e.status})))}catch{}return r}({ids:e,sections:n}),l=[];for(const e of c||[]){const t=i(e?.status);if(!t)continue;const n=String(e?.id||""),r=s.get(n)||n;l.push(`${userLinkHtml(n,r)} — ${FMV.escapeHtml(t)}`)}t("Готово"),r(l.length?l.join("<br>"):"")}catch(e){t("Ошибка"),r(e?.message||String(e))}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ForumInfo"]))return void console.warn("[button_update_chrono_api] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=window.CHRONO_CHECK.ForumInfo;function r(e){const t=e.split(".").reduce((e,t)=>e&&e[t],window);if("function"!=typeof t)throw new Error(`${e} не найден — подключите соответствующий скрипт`);return t}async function o(e,t){const n=r("FMVbank.storageSet"),o=String(e);if(!t||"object"!=typeof t)return{id:o,status:"нет данных для сохранения"};let a;try{a=await n(t,Number(o),"chrono_")}catch(e){return{id:o,status:`ошибка сохранения: ${e?.message||e}`}}const i=function(e){return!0===e?"сохранено":!1===e?"ошибка сохранения":String(e)}(a);return{id:o,status:i}}function a(e){const t=String(e||"").toLowerCase();return t.includes("ошибка сохранения")?"ошибка сохранения":t.includes("нет данных")||t.includes("не найден")?"пользователь не упоминается в хронологии":""}window.FMV||(window.FMV={}),"function"!=typeof window.userLinkHtml&&(window.userLinkHtml=(e,t)=>`${FMV.escapeHtml(String(t||e))}`),createForumButton({allowedGroups:e,allowedForums:t,label:"Сохранить хронологию в API",order:5,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),i=e?.setDetails||(()=>{});i("");try{t("Собираю…");const e=Array.isArray(window.CHRONO_CHECK?.UserIDs)?window.CHRONO_CHECK.UserIDs:void 0,s=await async function(e){const t=window.FMV&&"function"==typeof FMV.fetchUsers?FMV.fetchUsers:null;let n=[];if(Array.isArray(e)&&e.length)n=e.map(e=>({id:String(e)}));else if(t)try{const e=await t();n=Array.isArray(e)?e:[]}catch{}const r=new Map;for(const e of n){if(!e)continue;const t=String(e.id??""),n=String(e.name??"").trim();t&&r.set(t,n||t)}return r}(e);t("Сохраняю…");const c=await async function(e={}){const t=Number.isFinite(e.delayMs)?e.delayMs:200,n=r("collectChronoByUser"),a=e.sections;let i,s;try{i=await n({sections:a})}catch(e){throw new Error(`Ошибка collectChronoByUser: ${e?.message||e}`)}if(!i||"object"!=typeof i)throw new Error("collectChronoByUser вернул пустой результат");s=Array.isArray(e.ids)&&e.ids.length?e.ids.map(e=>({id:String(e)})):Object.keys(i).map(e=>({id:String(e)}));const c=[];for(const e of s){const n=i[e.id];if(!n){c.push({id:e.id,status:"нет данных (пользователь не найден в хроно-коллекции)"});continue}const r=await o(e.id,n);c.push(r),t&&await FMV.sleep(t)}try{console.table(c.map(e=>({id:e.id,status:e.status})))}catch{}return c}({ids:e,sections:n}),l=[];for(const e of c||[]){const t=a(e?.status);if(!t)continue;const n=String(e?.id||""),r=s.get(n)||n;l.push(`${userLinkHtml(n,r)} — ${FMV.escapeHtml(t)}`)}t("Готово"),i(l.length?l.join("<br>"):"")}catch(e){t("Ошибка"),i(e?.message||String(e))}}})})(),function(){"use strict";var e;window.FMV||(window.FMV={}),window.FMV.fetchUsers||console.warn("[FMV] Подключите общий модуль с FMV.fetchUsers до ui.js"),window.FMV.UI||function(){function e(e){const t=String(e||"").match(/\[FMVcast\]([\s\S]*?)\[\/FMVcast\]/i),n=t&&t[1]?(r=t[1],String(r||"").split(";").map(e=>e.trim()).filter(Boolean)):[];var r;const o={};return n.forEach(e=>{const t=e.match(/^(user\d+)(?:=(.+))?$/i);if(!t)return;const n=t[1],r=(t[2]||"").trim(),a=o[n]||(o[n]={code:n,masks:[]});r&&a.masks.push(r)}),o}function t(e){const t=[];return(e||[]).forEach(e=>{const n=Array.isArray(e.masks)?e.masks.filter(Boolean):[];n.length?n.forEach(n=>t.push(e.code+"="+n)):t.push(e.code)}),t.length?"[FMVcast]"+t.join(";")+"[/FMVcast]":""}function n(e){return(e=String(e||"").trim())?"[FMVplace]"+e+"[/FMVplace]":""}function r(e){let t=parseInt(String(e||"").trim(),10);return Number.isNaN(t)&&(t=0),"[FMVord]"+t+"[/FMVord]"}function o(e){return String(e||"").replace(/\[FMVcast\][\s\S]*?\[\/FMVcast\]/gi,"").replace(/\[FMVplace\][\s\S]*?\[\/FMVplace\]/gi,"").replace(/\[FMVord\][\s\S]*?\[\/FMVord\]/gi,"").replace(/^\s+|\s+$/g,"")}let a=!1;window.FMV.UI={attach:function(i){!function(){if(a)return;a=!0;const e=document.createElement("style");e.textContent="\n        :root{\n          --fmv-bg:#f7f4ea; --fmv-b:#d8d1c3; --fmv-chip:#fff;\n          --fmv-radius:10px; --fmv-gap:8px; --fmv-text:#2d2a26; --fmv-muted:#6b6359;\n        }\n\n        .msg-with-characters.fmv,\n        .msg-with-characters.fmv * { box-sizing: border-box; }\n        .msg-with-characters.fmv { width:100%; max-width:100%; overflow-x:hidden; }\n\n        .msg-with-characters.fmv{margin:10px 0; padding:10px; border:1px solid var(--fmv-b); background:var(--fmv-bg); border-radius:var(--fmv-radius)}\n        .fmv .char-row{display:flex; gap:var(--fmv-gap); align-items:flex-start; flex-wrap:wrap}\n        .fmv .combo{position:relative; flex:1 1 480px; width:100%; max-width:100%}\n        .fmv .combo input,\n        .fmv .place-row input,\n        .fmv .order-row input{\n          width:100%; max-width:100%; height:36px;\n          padding:8px 10px; border:1px solid var(--fmv-b); border-radius:8px;\n          background:#efe9dc; color:var(--fmv-text); font-size:14px;\n        }\n        .fmv .place-row,.fmv .order-row{margin-top:8px; width:100%; max-width:100%}\n        .fmv .order-row label{display:block; margin-bottom:4px; font-weight:600; color:var(--fmv-text)}\n        .fmv .order-hint,.fmv .hint{font-size:12.5px; color:var(--fmv-muted); margin-top:4px; overflow-wrap:anywhere}\n\n        .fmv .ac-list{\n          position:absolute; z-index:50; left:0; right:0; max-width:100%; background:#fff;\n          border:1px solid var(--fmv-b); border-radius:8px; margin-top:4px; max-height:240px; overflow:auto\n        }\n        .fmv .ac-item{padding:.45em .65em; cursor:pointer; font-size:14px}\n        .fmv .ac-item.active,.fmv .ac-item:hover{background:#f0efe9}\n        .fmv .ac-item .muted{color:var(--fmv-muted)}\n\n        .fmv .chips{ max-width:100%; overflow-x:hidden; }\n        .fmv .chips .chip{\n          display:flex; align-items:center; justify-content:flex-start;\n          gap:10px; padding:.45em .6em; background:var(--fmv-chip);\n          border:1px solid var(--fmv-b); border-radius:8px; margin:.35em 0; font-size:14px\n        }\n        .fmv .chip .drag{cursor:grab; margin-right:.4em; color:#8b8378}\n        .fmv .chip .name{font-weight:600}\n\n        .fmv .masks{display:flex; align-items:center; gap:6px; flex-wrap:wrap; color:var(--fmv-muted)}\n        .fmv .masks .masks-label{ color:var(--fmv-muted); margin-right:2px; }\n        .fmv .mask-badge{\n          display:inline-flex; align-items:center; gap:6px;\n          padding:2px 8px; border:1px solid var(--fmv-b); border-radius:999px;\n          background:#efe9dc; font-size:13px; color:var(--fmv-text);\n        }\n        .fmv .mask-badge .mask-remove{\n          border:0; background:none; cursor:pointer; line-height:1;\n          color:#8b8378; font-size:14px; padding:0 2px;\n        }\n\n        .fmv .chip .add-mask{border:0; background:none; color:#2e5aac; cursor:pointer; padding:0; text-decoration:underline; margin-left:auto}\n        .fmv .chip .x{border:0; background:none; font-size:16px; line-height:1; cursor:pointer; color:#8b8378; margin-left:8px}\n\n        .fmv .chip .mask-input{ display:none; margin-left:auto; }\n        .fmv .chip .mask-input.is-open{ display:flex; align-items:center; gap:8px; }\n        .fmv .chip .mask-input input{\n          flex:1; min-width:220px; height:30px;\n          padding:6px 8px; border:1px solid var(--fmv-b); border-radius:6px;\n          background:#efe9dc; color:var(--fmv-text);\n        }\n        .fmv .chip .btn{ border:1px solid var(--fmv-b); border-radius:6px; background:#fff; padding:6px 10px; cursor:pointer; line-height:1; }\n        .fmv .chip .btn-ok{ background:#e9f6e9; }\n        .fmv .chip .btn-cancel{ background:#f4eeee; }\n\n        .fmv-admin-tools{display:flex;justify-content:flex-end;margin:6px 0 8px}\n        .fmv-admin-tools .fmv-toggle{border:1px solid var(--fmv-b);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}\n\n        /* заголовок блока */\n        .fmv .section-title{\n          font-weight:700;\n          font-size:14px;\n          text-align: center;\n          line-height:1.25;\n          margin:4px 0 12px;\n          color: var(--fmv-text);\n        }\n\n        /* делаем «колонку» с равным шагом и без внутренних margin */\n        .fmv .combo,\n        .fmv .place-row,\n        .fmv .order-row {\n          display: grid;\n          grid-template-columns: 1fr;\n          row-gap: 8px;             /* вот этим управляем расстоянием между label ↔ input ↔ hint */\n        }\n        \n        .fmv .place-row label,\n        .fmv .order-row label,\n        .fmv .combo label,\n        .fmv .place-row .hint,\n        .fmv .order-row .order-hint,\n        .fmv .combo .hint {\n          margin: 0;                /* убираем наследованные отступы, чтобы они не «схлопывались» */\n        }\n        \n        /* (оставляем общий верхний зазор секции) */\n        .fmv .place-row, .fmv .order-row { margin-top: 8px; }\n\n        .fmv .chip .name { font-weight: 600; }\n        .fmv .chip .name .name-code { font-weight: 400; color: var(--fmv-muted); }\n\n        ",document.head.appendChild(e)}();const s="string"==typeof i.form?$(i.form):i.form,c="string"==typeof i.textarea?$(i.textarea):i.textarea;if(!s?.length||!c?.length)return null;const l=c.val()||"",d=/\[FMV(?:cast|place|ord)\][\s\S]*?\[\/FMV(?:cast|place|ord)\]/i.test(l);if(i.showOnlyIfFMVcast&&!d)return null;if(i.stripOnMount&&c.val(o(l)),s.data("fmvBoundUI"))return s.data("fmvBoundUI");const u="msg-with-characters fmv "+(i.className||""),p=$("<div/>",{class:u}),m=$('<div class="section-title">Для автоматического сбора хронологии</div>'),f=$('<div class="char-row"/>'),h=$('<div class="combo"/>'),g=$('<label for="character-combo" style="font-weight:600;display:block;margin-bottom:4px">Участники эпизода:</label>'),y=$('<input type="text" id="character-combo" placeholder="Наберите имя персонажа…" autocomplete="off">'),w=$('<div class="ac-list" role="listbox" aria-label="Варианты персонажей"></div>'),v=$('<div class="hint">Если что-то не работает, напишите в Приемную.</div>');h.append(g,y,w,v),f.append(h);const b=$('<div class="chips"/>'),S=$('<div class="place-row"/>'),C=$('<label for="fmv-place" style="font-weight:600">Локация:</label>'),x=$('<input type="text" id="fmv-place" placeholder="Укажите локацию">'),k=$('<div class="hint">Лучше указывать в едином формате: Хогвартс, Косой переулок, Лютный переулок, Министерство и т.д.</div>');S.append(C,x,k);const E=$('<div class="order-row"/>'),F=$('<label for="fmv-ord" style="font-weight:600">Для сортировки эпизодов в один день</label>'),M=$('<input type="number" id="fmv-ord" placeholder="0" value="0" step="1">'),_=$('<div class="order-hint">Помогает упорядочить эпизоды, которые стоят в один день. Чем больше значение, тем позже эпизод. Лучше оставлять 0.</div>');E.append(F,M,_),c.before(p),p.append(m,f,b,S,E);let I=[],L=[];function A(){b.empty(),I.forEach(function(e,t){const n=$('<div class="chip" draggable="true" data-idx="'+t+'"/>');n.append('<span class="drag" title="Перетащите для изменения порядка">↕</span>');const r=$('<span class="name"/>');r.append(document.createTextNode(e.name+" ")),r.append($('<span class="name-code"/>').text("("+e.code+")")),n.append(r);const o=$('<span class="masks"/>');e.masks?.length?(o.append('<span class="masks-label">— маски:</span>'),e.masks.forEach(function(e,t){const n=$('<span class="mask-badge" data-mi="'+t+'"><span class="mask-text"></span><button type="button" class="mask-remove" aria-label="Удалить маску">×</button></span>');n.find(".mask-text").text(e),o.append(n)})):o.text(" — масок нет");const a=$('<button class="add-mask" type="button">добавить маску</button>'),i=$('<button class="x" type="button" aria-label="Удалить">×</button>'),s=$('<span class="mask-input"></span>').hide(),c=$('<input type="text" placeholder="маска (текст)">'),l=$('<button type="button" class="btn btn-ok">Ок</button>'),d=$('<button type="button" class="btn btn-cancel">Отмена</button>');s.append(c,l,d),c.on("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),l.click())}),a.on("click",()=>{n.find(".mask-input").removeClass("is-open").hide(),s.addClass("is-open").show(),c.val("").focus()}),l.on("click",()=>{const t=$.trim(c.val());t&&((e.masks||(e.masks=[])).push(t),A())}),d.on("click",()=>{s.removeClass("is-open").hide()}),i.on("click",()=>{I.splice(t,1),A()}),n.append(o,a,s,i),b.append(n)})}function D(e){if(!e||I.some(t=>t.code===e))return;const t=L.find(t=>t.code===e);I.push({code:e,name:t?t.name:e,masks:[]}),A(),y.val(""),w.hide().empty()}function O(e){const t=(e||"").trim().toLowerCase(),n=L.filter(e=>!I.some(t=>t.code===e.code)).filter(e=>!t||e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)).slice().sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));w.empty(),n.length?(n.slice(0,40).forEach(e=>{w.append($('<div class="ac-item" role="option"/>').attr("data-code",e.code).text(e.name+" ("+e.code+")"))}),w.show(),H(0)):w.append('<div class="ac-item"><span class="muted">Ничего не найдено</span></div>').show()}function H(e){const t=w.children(".ac-item");t.removeClass("active"),t.length&&(e=(e+t.length)%t.length,t.eq(e).addClass("active"),w.data("activeIndex",e))}if(b.on("dragstart",".chip",function(e){$(this).addClass("dragging"),e.originalEvent.dataTransfer.setData("text/plain",$(this).data("idx"))}),b.on("dragend",".chip",function(){$(this).removeClass("dragging")}),b.on("dragover",function(e){e.preventDefault()}),b.on("drop",function(e){e.preventDefault();const t=+e.originalEvent.dataTransfer.getData("text/plain"),n=$(e.target).closest(".chip");if(!n.length)return;const r=+n.data("idx");if(isNaN(t)||isNaN(r)||t===r)return;const o=I.splice(t,1)[0];I.splice(r,0,o),A()}),b.on("click",".mask-remove",function(){const e=+$(this).closest(".chip").data("idx"),t=+$(this).closest(".mask-badge").data("mi");isNaN(e)||isNaN(t)||!Array.isArray(I[e].masks)||(I[e].masks.splice(t,1),A())}),y.on("input",function(){O(this.value)}),y.on("keydown",function(e){const t=0|w.data("activeIndex");if("ArrowDown"===e.key&&w.is(":visible"))e.preventDefault(),H(t+1);else if("ArrowUp"===e.key&&w.is(":visible"))e.preventDefault(),H(t-1);else if("Enter"===e.key){e.preventDefault();const t=w.is(":visible")?function(){const e=0|w.data("activeIndex");return w.children(".ac-item").eq(e).data("code")}():function(){const e=($.trim(y.val())||"").toLowerCase();if(!e)return null;const t=L.filter(e=>!I.some(t=>t.code===e.code)),n=t.find(t=>t.name.toLowerCase()===e)||t.find(t=>t.code.toLowerCase()===e);if(n)return n.code;const r=t.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e));if(1===r.length)return r[0].code;const o=r.filter(t=>t.name.toLowerCase().startsWith(e));return 1===o.length?o[0].code:null}();t?D(t):O(this.value)}else"Escape"===e.key&&w.hide()}),w.on("mousedown",".ac-item",function(){const e=$(this).data("code");e&&D(e)}),$(document).on("click",function(e){$(e.target).closest(h).length||w.hide()}),"function"==typeof FMV.fetchUsers&&FMV.fetchUsers().then(function(t){L=(t||[]).slice(),!1!==i.prefill&&function(t){I=[];const n=e(t||""),r=String(t||"").match(/\[FMVplace\]([\s\S]*?)\[\/FMVplace\]/i);r&&"string"==typeof r[1]&&x.val(r[1].trim());const o=String(t||"").match(/\[FMVord\]([\s\S]*?)\[\/FMVord\]/i);if(o&&"string"==typeof o[1]){let e=parseInt(o[1].trim(),10);Number.isNaN(e)&&(e=0),M.val(e)}Object.keys(n).forEach(e=>{const t=L.find(t=>t.code===e);I.push({code:e,name:t?t.name:e,masks:n[e].masks})}),A()}(l)}).catch(function(e){w.html('<div class="ac-item"><span class="muted">'+(e||"Ошибка загрузки")+"</span></div>").show()}),s.off("submit.fmv.ui").on("submit.fmv.ui",function(e){const a=s.find('input[name="req_subject"]'),i=!a.length||$.trim(a.val()||"").length>0,l=o(c.val()||""),d=$.trim(l).length>0,u=I.length>0,p=$.trim(x.val()||"").length>0;if(!(i&&d&&u&&p)){e.preventDefault(),"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation(),"function"==typeof e.stopPropagation&&e.stopPropagation();const t=[];return i||t.push("Заголовок"),d||t.push("Основной текст"),u||t.push("Участники"),p||t.push("Локация"),alert("Заполните: "+t.join(", ")),!1}const m=[t(I),n(x.val()),r(M.val())].filter(Boolean).join("");let f=l.replace(/[ \t]+$/,"");const h=!f||/\n$/.test(f)?"":"\n";c.val(f+h+m)}),function(){const e=(window.CHRONO_CHECK?.GroupID||[]).map(String),t=(window.CHRONO_CHECK?.AllowedUser||[]).map(String),n="function"==typeof window.getCurrentGroupId?String(window.getCurrentGroupId()):"",r="function"==typeof window.getCurrentUserId?String(window.getCurrentUserId()):"";return n&&e.includes(n)||r&&t.includes(r)}()){let e=s.data("fmvAdminTools");e&&e.length||(e=$('<div class="fmv-admin-tools"><button type="button" class="fmv-toggle">Режим ручного редактирования</button></div>'),s.data("fmvAdminTools",e)),p.before(e);const a=e.find(".fmv-toggle");a.off("click.fmv");const i=()=>{const e=[t(I),n(x.val()),r(M.val())].filter(Boolean).join(""),i=o(c.val()||"").replace(/[ \t]+$/,""),l=!i||/\n$/.test(i)?"":"\n";c.val(i+(e?l+e:"")),p.remove(),s.off("submit.fmv.ui").removeData("fmvBoundUI"),a.data("raw",!0).text("Вернуться к удобной форме")},l=()=>{FMV.UI.attach({form:s,textarea:c,prefill:!0,showOnlyIfFMVcast:!1,className:"fmv--compact",stripOnMount:!0}),a.data("raw",!1).text("Режим ручного редактирования")};a.on("click.fmv",()=>a.data("raw")?l():i())}const P={serialize:()=>[t(I),n(x.val()),r(M.val())].filter(Boolean).join(""),stripFMV:o,mountPoint:p};return s.data("fmvBoundUI",P),P}}}(),e=function(){if(window.__FMV_BOOTSTRAPPED__)return;if(window.__FMV_BOOTSTRAPPED__=!0,!FMV.UI||"function"!=typeof FMV.UI.attach)return;const e=new URL(location.href),t=e.pathname,n=e.searchParams;function r({strip:e=!1,showOnlyIfCast:t=!1}={}){const n=$('#post form, form[action*="post.php"], form[action*="edit.php"]').first(),r=n.find('textarea[name="req_message"], #main-reply, .questionary-post textarea').first();return n.length&&r.length?FMV.UI.attach({form:n,textarea:r,prefill:!0,showOnlyIfFMVcast:!!t,className:"fmv--compact",stripOnMount:!!e}):null}if(/\/post\.php$/i.test(t)&&!n.has("action")){const e=+(n.get("fid")||0);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(e)&&r({strip:!1,showOnlyIfCast:!1})}if(/\/post\.php$/i.test(t)&&"post"===n.get("action")){if(n.has("tid"))return;const e=Number(n.get("fid")),t=(window.CHRONO_CHECK?.ForumID||[]).map(Number);e&&!t.includes(e)||r({strip:!0,showOnlyIfCast:!1})}if(/\/edit\.php$/i.test(t)&&n.has("id")&&document.querySelector('input[name="firstpost"]')){const e=document.querySelector(".container.crumbs a:nth-of-type(2)");if(e&&e.href.includes("/viewforum.php?id=")&&e.href.split("/viewforum.php?id=").length>=2){const t=Number(e.href.split("/viewforum.php?id=")[1]);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(t)&&r({strip:!0,showOnlyIfCast:!1})}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}(),(()=>{"use strict";const e="Показать скрытые теги";async function t(e,{timeout:t=1e4,interval:n=100}={}){const r=performance.now();for(;performance.now()-r<t;){try{const t=e();if(t)return t}catch{}await FMV.sleep(n)}return null}function n(){const t=document.querySelector(".ams_info");return t&&Array.from(t.querySelectorAll("div[data-order]")).find(t=>{const n=t.querySelector("button.button");return 1===Number(t.dataset.order)&&n&&n.textContent.trim()===e})||null}async function r(){if(!await t(()=>window.FMV&&"function"==typeof FMV.readTagText&&"function"==typeof FMV.escapeHtml&&"function"==typeof FMV.parseOrderStrict&&"function"==typeof FMV.buildIdToNameMapFromTags&&"function"==typeof FMV.parseCharactersUnified&&"function"==typeof window.profileLink,{timeout:15e3}))return null;const e=await t(()=>document.querySelector(".topic .post.topicpost, .post.topicpost, .message:first-of-type"),{timeout:15e3});if(!e)return null;const n=window.CHRONO_CHECK?.GroupID||[];if("function"==typeof window.ensureAllowed&&!window.ensureAllowed(n))return null;const r=FMV.readTagText(e,"characters"),o=FMV.readTagText(e,"location"),a=FMV.readTagText(e,"order"),i=await FMV.buildIdToNameMapFromTags(r),s=[];if(r){const e=FMV.renderParticipantsHtml(r,i,(e,t)=>window.profileLink(e,t));s.push(`<div class="fmv-row"><span class="fmv-label">Участники:</span>${e}</div>`)}if(o&&s.push(`<div class="fmv-row"><span class="fmv-label">Локация:</span>${FMV.escapeHtml(o)}</div>`),a){const e=FMV.parseOrderStrict(a);s.push(`<div class="fmv-row"><span class="fmv-label">Для сортировки:</span>${e.html}</div>`)}if(!s.length)return null;!function(){if(document.getElementById("fmv-meta-style"))return;const e=document.createElement("style");e.id="fmv-meta-style",e.textContent="\n      .fmv-meta{\n        margin:8px 0; padding:8px; border:1px solid #d7d7d7;\n        background:#f7f7f7; border-radius:6px;\n      }\n      .fmv-row{margin:.25em 0}\n      .fmv-label{font-weight:700;margin-right:.25em}\n      .fmv-missing{color:#c00;background:#ffe6e6;border-radius:6px;padding:0 .25em;font-weight:700}\n    ",document.head.appendChild(e)}();const c=document.createElement("div");return c.className="fmv-meta",c.innerHTML=s.join("\n"),c}async function o(){const e=n();if(!e)return;!function(){const e=n(),t=e?.nextElementSibling;t&&t.classList.contains("fmv-meta")&&t.remove()}();const t=await r();t&&e.parentNode.insertBefore(t,e.nextSibling)}window.CHRONO_CHECK&&Array.isArray(window.CHRONO_CHECK.GroupID)&&Array.isArray(window.CHRONO_CHECK.ForumID)?createForumButton({allowedGroups:window.CHRONO_CHECK.GroupID,allowedForums:window.CHRONO_CHECK.ForumID,label:e,order:1,showStatus:!1,showDetails:!1,showLink:!1,async onClick({wrap:e}){if(e.nextElementSibling?.classList.contains("fmv-meta"))e.nextElementSibling.remove(),localStorage.setItem("fmv:meta:enabled","0");else{const t=await r();t&&(e.parentNode.insertBefore(t,e.nextSibling),localStorage.setItem("fmv:meta:enabled","1"))}}}):console.warn("[tags_visibility] Требуются CHRONO_CHECK.GroupID, ForumID"),(async()=>{"1"!==localStorage.getItem(function(){try{const e=new URL(location.href);return`fmv:meta:enabled:${e.searchParams.get("id")||e.searchParams.get("tid")||e.pathname}`}catch{return`fmv:meta:enabled:${location.href}`}}())||function(){const e=n(),t=e?.nextElementSibling;return!(!t||!t.classList.contains("fmv-meta"))}()||await o()})()})();