/*!
 * QuadroBoards Automatizations - BODY BUNDLE
 * @version 1.0.0
 */
function dfm_escape(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function dfm_insertAtCaret(e,t){e.focus();var n="number"==typeof e.selectionStart?e.selectionStart:e.value.length,o="number"==typeof e.selectionEnd?e.selectionEnd:e.value.length;e.value=e.value.slice(0,n)+t+e.value.slice(o),e.selectionStart=e.selectionEnd=n+t.length;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch(e){}}function dfm_hash32(e){var t,n=2166136261;for(t=0;t<e.length;t++)n=16777619*((n^=e.charCodeAt(t))>>>0);return n>>>0}function dfm_prng(e){var t=e>>>0||2654435769;return function(){return t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>=0)/4294967296}}function dfm_rng_int(e,t,n){var o=e();return t+Math.floor(o*(n-t+1))}function dfm_roll_det(e,t,n){var o,r=dfm_prng(n),i=[];for(o=0;o<e;o++)i.push(dfm_rng_int(r,1,t));return i}function dfm_canon(e,t,n){var o=String(parseInt(e,10)),r=String(parseInt(t,10)),i=parseInt(n,10);return o+":"+r+":"+(i=i>=0?"+"+i:""+i)}function dfm_makeSeed(e,t,n){return dfm_hash32("DiceFM|"+((e&&e.id?e.id:"").match(/\d+/)||[0])[0]+"|"+(e&&e.getAttribute("data-posted")||"0")+"|"+t+"|"+n)}function dfm_attach(){var e=document.getElementById("dicefm-btn"),t=document.getElementById("main-reply");e&&t&&e.addEventListener("click",function(){var e=prompt("Сколько дайсов бросаем?","1");if(null!==e){var n=parseInt(e,10);if(n>=1&&n<=100){var o=prompt("Сколько граней у каждого дайса?","6");if(null!==o){var r=parseInt(o,10);if(r>=2&&r<=1e5){var i=prompt("Есть ли бонус/штраф?","+0");if(null!==i)if(i=(i||"").trim(),/^[+-]?\d+$/.test(i)){var a=parseInt(i,10);if(Math.abs(a)>1e5)alert("Абсолютное значение должно быть не больше 100000");else{var s=a>=0?"+"+a:""+a,c=prompt("Причина броска (опционально)","")||"";c=c.replace(/\]/g," ").replace(/\s+/g," ").trim(),dfm_insertAtCaret(t,"[DiceFM "+n+":"+r+":"+s+":"+(c||"")+"]")}}else alert("Нужен формат +1 или -1")}else alert("Значение должно быть в пределах [2;100000]")}}else alert("Значение должно быть в пределах [1;100]")}})}function dfm_render(e,t,n,o,r){var i=parseInt(e,10),a=parseInt(t,10),s=parseInt(n,10);if(!(i>=1&&i<=100&&a>=2&&a<=1e5&&Math.abs(s)<=1e5))throw new Error("Проблема с данными");var c,l=dfm_roll_det(i,a,r),d=0,u="";for(c=0;c<l.length;c++)d+=l[c],u+=(c?"+":"")+l[c];var p="("+u+")"+(0===s?"":s>0?"+"+s:""+s)+"="+(d+s);return'<div class="quote-box"><blockquote style="text-align:left"><p>'+("<b>Бросок "+i+"d"+a+(0===s?"":s>0?" с бонусом "+s:" со штрафом "+s)+"</b>")+(o?"<br><em>"+dfm_escape(o)+"</em>":"")+"<br><br><b>Результат:</b> "+p+"</p></blockquote></div>"}function dfm_replace(e){if(e){var t=e.closest?e.closest(".post"):null,n=e.innerHTML,o={},r=n.replace(/\[(?:DiceFM)\s+(\d+)\s*:\s*(\d+)\s*:\s*([+-]?\d+)\s*:\s*(?:"([^"]*)"|([^\]]*))\s*\]/gi,function(e,n,r,i,a,s){try{var c=((null!=a?a:s)||"").replace(/\s+/g," ").trim(),l=dfm_canon(n,r,i),d=o[l]||0;return o[l]=d+1,dfm_render(n,r,i,c,dfm_makeSeed(t,l,d))}catch(t){return e}});r!==n&&(e.innerHTML=r)}}function dfm_init(){if("undefined"==typeof FORUM||FORUM.topic)for(var e=document.querySelectorAll?document.querySelectorAll(".post-content"):[],t=0;t<e.length;t++)dfm_replace(e[t])}function isProfileFieldsPage(){try{const e=new URL(location.href);return/\/profile\.php$/i.test(e.pathname)&&"fields"===e.searchParams.get("section")&&/^\d+$/.test(e.searchParams.get("id")||"")}catch{return!1}}function getProfileId(){return new URL(location.href).searchParams.get("id")||""}async function getUserIdFromPage(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return console.error(`[get_skin_api] Не удалось загрузить ${t}`),Number(e);const o=await n.text(),r=new DOMParser,i=r.parseFromString(o,"text/html").querySelector(".modal_script");if(!i)return console.warn(`[get_skin_api] .modal_script не найден в ${t}, используем profileId=${e}`),Number(e);const a=i.getAttribute("data-main-user_id");return a&&a.trim()?(console.log(`[get_skin_api] Найден data-main-user_id=${a}`),Number(a.trim())):Number(e)}catch(t){return console.error("[get_skin_api] Ошибка загрузки страницы:",t),Number(e)}}async function loadSkinsFromAPI(e){if(console.log("[get_skin_api] Загружаю данные из API для userId:",e),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[get_skin_api] FMVbank.storageGet не найден"),{icons:[],plashki:[],backs:[]};const t={icons:[],plashki:[],backs:[]};try{const n=await window.FMVbank.storageGet(e,"skin_");if(console.log("[get_skin_api] skin_ ответ:",n),!n||"object"!=typeof n)return console.warn("[get_skin_api] Нет данных в skin_ для userId:",e),t;const o={icon:"icons",plashka:"plashki",background:"backs"};for(const[e,r]of Object.entries(o)){const o=n[e];Array.isArray(o)?(t[r]=o.map(e=>e.content||"").filter(Boolean),console.log(`[get_skin_api] ${r} загружено ${o.length} элементов`)):console.log(`[get_skin_api] ${r} отсутствует или не массив`)}}catch(e){console.error("[get_skin_api] Ошибка загрузки данных:",e)}return console.log("[get_skin_api] Результат:",t),t}async function collectSkinSets(){if(console.log("[get_skin_api] collectSkinSets вызван"),!isProfileFieldsPage())return console.log("[get_skin_api] Не страница fields"),{icons:[],plashki:[],backs:[]};const e=getProfileId();console.log("[get_skin_api] profileId:",e);const t=await getUserIdFromPage(e);console.log("[get_skin_api] Целевой userId:",t);const n=await loadSkinsFromAPI(t);return console.log("[get_skin_api] Данные загружены:",n),n}async function pageExistsViaEditEndpoint(e){const t=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,n=await fetchCP1251Doc(t),o=(n.querySelector("title")?.textContent||"").trim(),r=(n.querySelector("h1, .pagetitle, .tclcon h2")?.textContent||"").trim(),i=/Страница создана/i.test(o),a=!!n.querySelector('input[name="edit_page"]'),s=!![...n.querySelectorAll('input[type="submit"],button[type="submit"]')].find(e=>/сохран/i.test(e.value||e.textContent||""));/Информация/i.test(o)||/Информация/i.test(r);return!!(i||a||s)}function extractInfoMessage(e){const t=(new DOMParser).parseFromString(e,"text/html"),n=(t.querySelector("title")?.textContent||"").trim();return(n?`[${n}] `:"")+([...t.querySelectorAll(".message, .msg, .infobox, .warn, .error, #pun-main p, .block p, .box p")].map(e=>e.textContent.trim()).filter(Boolean).join("\n").trim()||"").trim()}function classifyResult(e){const t=extractInfoMessage(e).toLowerCase();return/уже существует|занято|должно быть уникаль/.test(t)?{status:"duplicate",msg:t}:/страница создана|добавлен|успешно|сохранена/.test(t)?{status:"created",msg:t}:/ошибка|forbidden|нет прав|не удалось|некоррект|заполните/.test(t)?{status:"error",msg:t}:{status:"unknown",msg:t}}async function FMVcreatePersonalPage(e,t,n,o,r,i){const a="/admin_pages.php?action=adddel";try{if(await pageExistsViaEditEndpoint(t))return{status:"exists",title:e,name:t,serverMessage:`Страница "${t}" уже существует (до отправки формы).`,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`};const s=await fetchCP1251Doc(a),c=[...s.querySelectorAll("form")].find(e=>(e.action||"").includes("/admin_pages.php"))||s.querySelector('form[action*="admin_pages.php"]');if(!c)return{status:"error",title:e,name:t,serverMessage:"Форма добавления не найдена",details:"admin_pages.php без формы"};(c.querySelector('[name="title"]')||{}).value=e,(c.querySelector('[name="name"]')||{}).value=t,(c.querySelector('[name="content"]')||{}).value=n;const l=c.querySelector('[name="tags"]');l&&(l.value=o);const d=c.querySelector('select[name="announcement"]');d?d.value=i:[...c.querySelectorAll('input[name="announcement"]')].forEach(e=>e.checked=e.value===i);for(const e of r){const t=c.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}let u="add_page";const p=[...c.elements].find(e=>"submit"===e.type&&("add_page"===e.name||/создать/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(c,u),{res:f,text:g}=await fetchCP1251Text(a,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m}),h=classifyResult(g),w=extractInfoMessage(g)||"",y=await pageExistsViaEditEndpoint(t);return"created"===h.status||y?(console.log(w||"Страница создана"),{status:"created",title:e,name:t,serverMessage:w||"Страница создана",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"duplicate"===h.status?(console.log(w||"Уже существует страница с таким адресным именем"),{status:"exists",title:e,name:t,serverMessage:w||"Уже существует страница с таким адресным именем",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"error"===h.status?(console.log(h.msg||w||"Ошибка при создании"),{status:"error",title:e,name:t,serverMessage:h.msg||w||"Ошибка при создании",httpStatus:f.status}):(console.log(w||"Не удалось подтвердить создание. Проверьте админку."),{status:"uncertain",title:e,name:t,serverMessage:w||"Не удалось подтвердить создание. Проверьте админку.",httpStatus:f.status})}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,console.log(t),n}}async function FMVeditPersonalPage(e,t={}){if(!e)throw new Error('FMVeditPersonalPage: "name" is required');const n=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,o=await("function"==typeof fetchCP1251Doc?fetchCP1251Doc(n):(async()=>{const e=await fetch(n,{credentials:"include"}).then(e=>e.text());return(new DOMParser).parseFromString(e,"text/html")})()),r=(o.body&&o.body.textContent||"").trim();if(/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(r))return{status:"forbidden",serverMessage:"Ссылка неверная или устаревшая",url:n};const i=[...o.querySelectorAll("form")].find(e=>(e.action||"").includes("admin_pages.php"))||o.querySelector("form");if(!i)return{status:"notfound",serverMessage:"Форма редактирования не найдена",url:n};if(null!=t.title){const e=i.querySelector('[name="title"]');e&&(e.value=String(t.title))}if(null!=t.content){const e=i.querySelector('#page-content,[name="content"]');e&&(e.value=String(t.content))}if(null!=t.announcement){const e=i.querySelector('select[name="announcement"]');if(e)e.value=String(t.announcement);else{const e=[...i.querySelectorAll('input[name="announcement"]')];e.length&&e.forEach(e=>e.checked=e.value==t.announcement)}}if(null!=t.tags){const e=i.querySelector('[name="tags"]');e&&(e.value=String(t.tags))}if(Array.isArray(t.groupsOn))for(const e of t.groupsOn){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}if(Array.isArray(t.groupsOff))for(const e of t.groupsOff){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!1)}let a="save";const s=[...i.elements].find(e=>"submit"===e.type&&("save"===e.name||/сохр|save/i.test(e.value||e.textContent||"")));let c,l;s?.name&&(a=s.name);const d=new URL(i.getAttribute("action")||n,location.origin).toString();if("function"==typeof serializeFormCP1251_SelectSubmit&&"function"==typeof fetchCP1251Text){const e=serializeFormCP1251_SelectSubmit(i,a);({res:c,text:l}=await fetchCP1251Text(d,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=windows-1251"},referrer:n,referrerPolicy:"strict-origin-when-cross-origin",body:e}))}else{const e=new FormData(i);e.append(a,s?.value||"1"),c=await fetch(d,{method:"POST",credentials:"include",body:e}),l=await c.text()}const u=/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(l),p=("function"==typeof extractInfoMessage?extractInfoMessage(l):"")||"",m=c.ok&&c.url&&/\/admin_pages\.php(?:\?|$)/.test(c.url)&&!/ошибк|forbidden|нет прав|устаревш/i.test((l||"").toLowerCase()),f=/Администрировани[ея]\s*[–-]\s*Страниц[ыь]/i.test(l)||/Список\s+персональных\s+страниц/i.test(l);if(c.ok&&(u||m||f))return{status:"saved",serverMessage:p||"Изменения сохранены",httpStatus:c.status,url:n};let g={status:"unknown",msg:p};if("function"==typeof classifyResult)try{g=classifyResult(l)}catch{}return/ошибк|forbidden|нет прав|устаревш/i.test((p||g.msg||"").toLowerCase())?{status:"forbidden",serverMessage:p||g.msg||"Нет прав/ошибка сохранения",httpStatus:c.status,url:n}:{status:"error",serverMessage:p||"Ошибка сохранения",httpStatus:c.status,url:n}}async function FMVeditTextareaOnly(e,t){return FMVeditPersonalPage(e,{content:t})}async function fetchAllLibraries(){if(console.log("[fetchAllLibraries] Загружаю библиотеки из API"),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[fetchAllLibraries] FMVbank.storageGet не найден"),{plashka:[],icon:[],back:[],gift:[],coupon:[]};function e(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const t={plashka:[],icon:[],back:[],gift:[],coupon:[]},n=["icon","plashka","background","gift","coupon"];for(const o of n)try{const n=await window.FMVbank.storageGet(1,`library_${o}_`);if(!n||!n.items||!Array.isArray(n.items)){console.warn(`[fetchAllLibraries] library_${o}_1 не найдена или пуста`);continue}if("coupon"===o)t.coupon=n.items.map(t=>{const n=t.t?` title="${e(t.t)}"`:"",o=t.s_t?` data-coupon-title="${e(t.s_t)}"`:"",r=t.type?` data-coupon-type="${e(t.type)}"`:"",i=t.f?` data-coupon-form="${e(t.f)}"`:"",a=void 0!==t.v?` data-coupon-value="${e(String(t.v))}"`:"";return{id:t.id,html:`<div class="item" data-id="${e(t.id)}"${n}${o}${r}${i}${a}>${t.content||""}</div>`}});else{const r=n.items.filter(e=>1!==e.h).map(t=>({id:t.id,html:`<div class="item" data-id="${e(t.id)}" title="${e(t.t||"")}">${t.content||""}</div>`}));t["background"===o?"back":o]=r}}catch(e){console.error(`[fetchAllLibraries] Ошибка загрузки ${o}:`,e)}return t}window.jQuery?(jQuery(function(){dfm_attach(),dfm_init()}),jQuery(document).on("pun_post",function(){dfm_init()}),jQuery(document).on("pun_edit",function(){dfm_init()})):document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){dfm_attach(),dfm_init()}),$.fn.fixDashes=function(){var e="[\\s\\u00A0\\u202F\\u2009\\u2002-\\u2008\\u200A\\u200B\\uFEFF\\u200C\\u200D]",t=new RegExp(e),n=new RegExp("^"+e+"*$");function o(e){return!!e&&t.test(e)}function r(e){return!e||n.test(e)}function i(e){return"-"===e||"−"===e||e&&e>="‐"&&e<="―"}var a=new RegExp("("+e+")(?:-|[\\u2010-\\u2015]|\\u2212)(?="+e+")","g"),s=new RegExp(e+"(?:-|[\\u2010-\\u2015]|\\u2212)"+e+"*$"),c={ADDRESS:1,ARTICLE:1,ASIDE:1,BLOCKQUOTE:1,DIV:1,DL:1,DT:1,DD:1,FIELDSET:1,FIGCAPTION:1,FIGURE:1,FOOTER:1,FORM:1,H1:1,H2:1,H3:1,H4:1,H5:1,H6:1,HEADER:1,HR:1,LI:1,MAIN:1,NAV:1,OL:1,P:1,PRE:1,SECTION:1,TABLE:1,THEAD:1,TBODY:1,TFOOT:1,TR:1,TD:1,TH:1,UL:1},l={SCRIPT:1,STYLE:1,CODE:1,PRE:1,KBD:1,SAMP:1};function d(e){for(var t=e.length-1;t>=0;t--)if(!o(e.charAt(t)))return t;return-1}function u(e){for(var t=0;t<e.length;t++)if(!o(e.charAt(t)))return t;return-1}function p(e){for(var t,n=[e];n.length;)for(t=n.shift().firstChild;t;t=t.nextSibling){if(3===t.nodeType&&!r(t.nodeValue))return t;if(1===t.nodeType){var o=t.nodeName.toUpperCase();if(l[o])continue;n.push(t)}}return null}function m(e){for(var t=e;t;t=t.parentNode)if(1===t.nodeType){var n=t.className||"";if("string"==typeof n&&-1!==n.indexOf("quote-box")&&-1!==n.indexOf("spoiler-box")&&-1!==n.indexOf("media-box"))return!0}return!1}function f(e,t){if(e&&t){var n=e.nodeValue;if(s.test(n)){var r=d(n);if(-1!==r){var a=n.charAt(r),c=r>0?n.charAt(r-1):"";if(i(a)&&o(c)){var l=t.nodeValue;l.length&&o(l.charAt(0))&&(e.nodeValue=n.slice(0,r)+"—"+n.slice(r+1))}}}}}function g(e,t){try{if("text/html"!==(e.getAttribute("type")||"").toLowerCase())return;var n=e.text||e.textContent||"";if(!n)return;var o=document.createElement("div");o.innerHTML=n,t(o);var r=o.innerHTML;e.text=r,e.textContent=r}catch(e){}}function h(e){var t=null,n=!1;!function w(y){for(var b=y.firstChild;b;b=b.nextSibling)if(3===b.nodeType){var v=b.nodeValue;if(r(v)){t&&(n=!0);continue}v=v.replace(a,"$1—");var S=!t||n||t&&t.nodeValue.length&&o(t.nodeValue.charAt(t.nodeValue.length-1)),_=u(v);if(S&&-1!==_&&i(v.charAt(_)))o(_+1<v.length?v.charAt(_+1):"")&&(v=v.slice(0,_)+"—"+v.slice(_+1));if(b.nodeValue=v,t){var k=t.nodeValue,x=v.length&&o(v.charAt(0));if(s.test(k)){var C=d(k);if(-1!==C){var $=k.charAt(C),E=C>0?k.charAt(C-1):"";i($)&&o(E)&&(x||n)&&(t.nodeValue=k.slice(0,C)+"—"+k.slice(C+1))}}}t=b,n=!1}else if(1===b.nodeType){var F=b.nodeName.toUpperCase();if("SCRIPT"===F&&m(b)){g(b,h),t=null,n=!1;continue}if(l[F]){t=null,n=!1;continue}if("BR"===F){t=null,n=!1;continue}if(c[F]&&b!==e)h(b),t=null,n=!1;else{if(t){var I=p(b);I&&f(t,I)}w(b)}}}(e)}return this.each(function(){h(this)})},$(function(){$(".post-content").fixDashes()}),(()=>{const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});(async()=>{try{await e;Number(document.body?.dataset?.groupId||NaN);const t=window.GroupID?Number(window.GroupID):null,n=[...window.PROFILE_CHECK?.GroupID||[],...window.CHRONO_CHECK?.GroupID||[]],o=[...window.PROFILE_CHECK?.ForumID||[],...window.CHRONO_CHECK?.ForumID||[],...window.CHRONO_CHECK?.AmsForumID||[]],r=n.includes(t),i=document.querySelector(".container.crumbs"),a=i&&Array.from(i.querySelectorAll("a[href]")).some(e=>{try{const t=new URL(e.getAttribute("href"),location.href),n=t.searchParams.get("id"),r=!!n&&o.includes(Number(n));return t.pathname.endsWith("/viewforum.php")&&r}catch{return!1}});if(!r||!a)return;let s=document.querySelectorAll(".topicpost .post-body .post-box .post-content");if(!s.length)try{await FMV.waitForSelector(".topicpost .post-body .post-box .post-content",5e3),s=document.querySelectorAll(".topicpost .post-body .post-box .post-content")}catch{return}const c=s[s.length-1];if(!c||c.querySelector(".ams_info"))return;const l=document.createElement("div");l.className="ams_info",l.textContent="",c.appendChild(document.createElement("br")),c.appendChild(l),window.__ams_ready=!0,window.dispatchEvent(new CustomEvent("ams:ready",{detail:{node:l}})),"function"==typeof window.__amsReadyResolve&&window.__amsReadyResolve(l)}catch(e){console.log("[AMS injector] error:",e)}})()})(),function(){async function e(e){if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(e),!0}catch(e){}return function(){try{return document.execCommand&&document.execCommand("copy")}catch(e){return!1}}()}let t=null;function n(){try{const e=window.getSelection&&window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges(),document.selection&&document.selection.empty&&document.selection.empty()}catch(e){}try{document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}catch(e){}const e=document.body,t=e.style.userSelect,n=e.style.webkitUserSelect;e.style.userSelect="none",e.style.webkitUserSelect="none",e.offsetHeight,e.style.userSelect=t,e.style.webkitUserSelect=n}function o(e){(function(e){return!!t&&!t.contains(e)})(e.target||e.srcElement)&&(t=null,n())}function r(n){!function(e){let t=e.querySelector(".legend");if(t||(t=document.createElement("strong"),t.className="legend",e.insertBefore(t,e.firstChild)),!t.dataset.copyReady){if(!t.querySelector(".code-copy")){let e=(t.textContent||"").trim();e&&!/^код:?\s*$/i.test(e)||(e="Скопировать код"),t.textContent="";const n=document.createElement("button");n.type="button",n.className="code-copy",n.textContent=e,t.appendChild(n)}t.dataset.copyReady="1"}}(n),n.__armed||(n.__armed=!0,n.addEventListener("click",async function(o){if(!(o.target.closest&&o.target.closest(".code-copy, .legend")||null))return;o.preventDefault(),o.stopPropagation();const r=n.querySelector("pre");r&&(!function(e){try{var t=document.createRange();t.selectNodeContents(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}catch(e){}}(r),function(e){t=e||null}(r),await e(function(e){return(e&&(e.innerText||e.textContent)||"").replace(/\s+$/,"")}(r)))},!0))}function i(e){var t,n;(t=".code-box",n=e,Array.prototype.slice.call((n||document).querySelectorAll(t))).forEach(r)}i(),document.addEventListener("pun_main_ready",function(){i()}),new MutationObserver(function(e){e.forEach(function(e){(e.addedNodes||[]).forEach(function(e){1===e.nodeType&&(e.matches&&e.matches(".code-box")&&r(e),e.querySelectorAll&&e.querySelectorAll(".code-box").forEach(r))})})}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("pointerdown",o,!0),document.addEventListener("mousedown",o,!0),document.addEventListener("click",o,!0),document.addEventListener("touchstart",o,!0),document.addEventListener("focusin",o,!0),document.addEventListener("scroll",function(){t&&(t=null,n())},!0),document.addEventListener("selectionchange",function(){if(!t)return;const e=window.getSelection&&window.getSelection();if(!e||!e.rangeCount||e.isCollapsed)return void(t=null);const o=e.anchorNode;o&&!t.contains(o)&&(t=null,n())},!0),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&(t=null,n())},!0),window.addEventListener("blur",function(){t&&(t=null,n())},!0)}(),function(){"use strict";async function e(e,t){if(console.log("[admin_bridge_json] 🔥 СОХРАНЕНИЕ ДЛЯ userId:",e),console.log("[admin_bridge_json] 🔥 skinData:",JSON.parse(JSON.stringify(t))),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet||"function"!=typeof window.FMVbank.storageSet)return console.error("[admin_bridge_json] FMVbank.storageGet или storageSet не найдены"),!1;const n=(()=>{const e=new Date,t=e.getTimezoneOffset(),n=new Date(e.getTime()+6e4*(180+t));return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`})();try{console.log("[admin_bridge_json] 📥 Загружаю текущие данные из API...");const o=await window.FMVbank.storageGet(e,"skin_"),r=o&&"object"==typeof o?o:{};console.log("[admin_bridge_json] 📥 Текущие данные из API:",JSON.parse(JSON.stringify(r)));const i=r.comment_id;if(!i)return alert("Укажите id комментария для юзера."),console.error("[admin_bridge_json] ❌ comment_id не указан"),!1;console.log("[admin_bridge_json] ✅ comment_id:",i);const a=["icon","plashka","background","gift","coupon"];for(const e of a){let o=t[e]||[];if("coupon"===e){const e=o.length;o=o.filter(e=>!(e.expired_date&&e.expired_date<n)||(console.log(`[admin_bridge_json] Удалён истекший купон: ${e.id}, expired_date=${e.expired_date} < ${n}`),!1));const t=o.length;e!==t&&console.log(`[admin_bridge_json] 🗑️ Купоны: удалено ${e-t} истекших`)}console.log("[admin_bridge_json] 📦 "+e+": "+o.length+" элементов"),r[e]=o}r.last_timestamp=Math.floor(Date.now()/1e3),console.log("[admin_bridge_json] 💾 Финальный объект для сохранения:",JSON.parse(JSON.stringify(r)));if(!await window.FMVbank.storageSet(r,e,"skin_"))return console.error("[admin_bridge_json] ❌ Не удалось сохранить данные"),!1;console.log("[admin_bridge_json] ✅ Данные успешно сохранены в API"),console.log("[admin_bridge_json] 📝 Обновляю комментарий #"+i);const s=await async function(e,t,n){return new Promise((o,r)=>{try{const i={...n},a=["icon","plashka","background","gift","coupon"];for(const e of a){const t=n[e]||[];i[e]=t.map(e=>{const t={...e};return delete t.content,t})}const s=JSON.stringify(i),c=window.SITE_URL+"/profile.php?id="+t+"\n"+s,l="/edit.php?id="+e;console.log("[admin_bridge_json] 🌐 Создаём iframe для редактирования комментария:",l);const d=document.createElement("iframe");d.style.display="none",d.src=l,document.body.appendChild(d);const u=setTimeout(()=>{d.remove(),r(new Error("Таймаут обновления комментария (10 секунд)"))},1e4);let p=0;d.onload=function(){if(p++,console.log("[admin_bridge_json] iframe onload #"+p),1!==p)2===p&&(console.log("[admin_bridge_json] ✅ Форма успешно отправлена, комментарий обновлён"),clearTimeout(u),d.remove(),o(!0));else try{const e=d.contentDocument||d.contentWindow.document,t=e.querySelector('textarea[name="req_message"]'),n=e.querySelector('input[type="submit"][name="submit"]');if(!t||!n)return clearTimeout(u),d.remove(),void r(new Error("Форма редактирования не найдена"));t.value=c,console.log("[admin_bridge_json] 📝 Данные вставлены в форму, длина:",c.length),console.log("[admin_bridge_json] 📤 Нажимаю кнопку отправки"),n.click()}catch(e){clearTimeout(u),d.remove(),r(e)}},d.onerror=function(){clearTimeout(u),d.remove(),r(new Error("Не удалось загрузить страницу редактирования"))}}catch(e){console.error("[admin_bridge_json] Ошибка обновления комментария:",e),r(e)}})}(i,e,r);return s?(console.log("[admin_bridge_json] ✅ Комментарий успешно обновлён"),!0):(console.error("[admin_bridge_json] ❌ Не удалось обновить комментарий"),!1)}catch(e){return console.error("[admin_bridge_json] Ошибка сохранения:",e),!1}}window.skinAdmin={load:async function(t,n){const o=await async function(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return console.error(`[admin_bridge_json] Не удалось загрузить ${t}`),Number(e);const o=await n.text(),r=(new DOMParser).parseFromString(o,"text/html").querySelector(".modal_script");if(!r)return console.warn(`[admin_bridge_json] .modal_script не найден в ${t}, используем profileId=${e}`),Number(e);const i=r.getAttribute("data-main-user_id");return i&&i.trim()?Number(i.trim()):Number(e)}catch(t){return console.error("[admin_bridge_json] Ошибка загрузки страницы:",t),Number(e)}}(t);if(!o)return{status:"error",visibleData:{},chrono:{},comment_id:null,save:null,targetUserId:null};const{data:r,chrono:i,comment_id:a}=await async function(e){const t={icon:[],plashka:[],background:[],gift:[],coupon:[]};let n={},o=null;if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[admin_bridge_json] FMVbank.storageGet не найден"),{data:t,chrono:n,comment_id:o};const r=(()=>{const e=new Date,t=e.getTimezoneOffset(),n=new Date(e.getTime()+6e4*(180+t));return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`})();try{const i=await window.FMVbank.storageGet(e,"skin_");if(!i||"object"!=typeof i)return console.warn("[admin_bridge_json] Нет данных в API для userId="+e),{data:t,chrono:n,comment_id:o};n=i.chrono||{},o=i.comment_id||null;const a=["icon","plashka","background","gift","coupon"];for(const e of a){const n=i[e]||[];Array.isArray(n)&&n.forEach(n=>{"coupon"===e&&n.expired_date&&n.expired_date<r?console.log(`[admin_bridge_json] Пропущен истекший купон: ${n.id}, expired_date=${n.expired_date} < ${r}`):t[e].push(n)})}}catch(e){console.error("[admin_bridge_json] Ошибка загрузки данных:",e)}return{data:t,chrono:n,comment_id:o}}(o);return{status:"ok",visibleData:r,chrono:i,comment_id:a,save:async function(t){const n=await e(o,t);return{ok:n,status:n?"успешно":"ошибка сохранения"}},targetUserId:o}}}}(),function(){console.log("[collect_skins_api] Скрипт загружен");const e=".modal_script[data-id]",t=(...e)=>console.log("[collect_skins_api]",...e),n={icon:"._icon",plashka:"._plashka",background:"._background",gift:"._gift",coupon:"._coupon"};function o(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function r(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function i(i){if(t("initIn вызван, root:",i),!i)return void t("root не передан");if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return void console.warn("[collect_skins_api] FMVbank.storageGet не найден");const a=i.querySelector(e)||document.querySelector(e);if(t("charEl:",a),!a)return void t("character не найден");const s=r(a);t("scope:",s),function(t){const o=t.querySelector(e);o&&Object.values(n).forEach(e=>{const n=t.querySelector(e);n&&n.parentElement!==o&&o.appendChild(n)})}(s);const c=function(e){if(!e)return t("getUserIdFromCharacter: charEl отсутствует"),null;const n=e.getAttribute("data-main-user_id");if(t("getUserIdFromCharacter: data-main-user_id =",n),n&&n.trim()){const e=Number(n.trim());return t("getUserIdFromCharacter: используем data-main-user_id =",e),e}const o=e.getAttribute("data-id");if(t("getUserIdFromCharacter: data-id =",o),o&&o.trim()){const e=Number(o.trim());return t("getUserIdFromCharacter: используем data-id =",e),e}return t("getUserIdFromCharacter: userId не найден"),null}(a);if(t("userId:",c),!c)return void t("userId не найден");t("Загружаю данные для userId",c);const l=await async function(e){if(t("Загружаю данные из API для userId",e),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[collect_skins_api] FMVbank.storageGet не найден"),null;const n={icon:[],plashka:[],background:[],gift:[],coupon:[]};try{const o=await window.FMVbank.storageGet(e,"skin_");return t("skin_ ответ:",o),o&&"object"==typeof o?(["icon","plashka","background","gift","coupon"].forEach(e=>{const r=o[e];if(Array.isArray(r)){const o=r.filter(e=>!1!==e.is_visible);n[e]=o,t(`${e} загружено ${o.length} видимых элементов из ${r.length}`)}else t(`${e} отсутствует или не массив`),n[e]=[]}),t("Все данные загружены:",n),n):(t("Нет данных в skin_ для userId",e),n)}catch(e){return console.error("[collect_skins_api] Ошибка загрузки данных:",e),n}}(c);l?(!function(e,r){t("Вставляю данные в DOM:",r);for(const[i,a]of Object.entries(n)){const n=e.querySelector(a);if(!n){t(`Контейнер ${a} не найден`);continue}const s=r[i]||[];if(0===s.length){t(`Нет данных для ${i}`),n.innerHTML="";continue}const c=s.map(e=>{const t=[`data-id="${o(e.id)}"`,`title="${o(e.title||"")}"`];return Object.keys(e).forEach(n=>{if("id"!==n&&"title"!==n&&"content"!==n&&"is_visible"!==n){const r="data-"+n.replace(/_/g,"-");t.push(`${r}="${o(e[n]||"")}"`)}}),`<div class="item" ${t.join(" ")}>${e.content||""}</div>`}).join("\n");n.innerHTML=c,t(`Вставлено ${s.length} элементов в ${a}`)}}(s,l),t("Данные вставлены для userId",c)):t("Данные не загружены")}window.loadUserSkinsFromApi=function({root:e,rootSelector:t}={}){i(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{t("DOMContentLoaded событие"),i(document)});const a=new WeakSet;new MutationObserver(n=>{n.forEach(n=>{n.addedNodes&&n.addedNodes.forEach(n=>{n instanceof Element&&(n.matches&&n.matches(e)&&!a.has(n)&&(a.add(n),t("Обнаружен новый character:",n),i(r(n))),n.querySelectorAll&&n.querySelectorAll(e).forEach(e=>{a.has(e)||(a.add(e),t("Обнаружен вложенный character:",e),i(r(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0}),t("Скрипт инициализирован")}(),function(){console.log("[collect_api] Скрипт загружен");const e=".modal_script[data-id]",t=".chrono_info",n=(...e)=>console.log("[collect_api]",...e);function o(){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank не найден — подключите src/bank/api.js")}function r(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function i(e,r){console.log("[collect_api] loadChronoFromApi, ищем",t,"в scope");const i=r.querySelector(t);if(console.log("[collect_api] target найден:",i),!i)return void n("chrono_info не найден для userId",e);console.log("[collect_api] Показываем индикатор загрузки"),i.innerHTML="<p>Загрузка хронологии...</p>",console.log("[collect_api] Запрашиваем данные из API");const a=await async function(e){o();try{const t=await window.FMVbank.storageGet(Number(e),"chrono_");return n("Получены данные для userId",e,":",t),t&&"object"==typeof t&&t.chrono?(n("Извлечены данные chrono:",t.chrono),t.chrono):(n("Данные chrono не найдены в API"),null)}catch(t){return console.error(`[collect_api] Ошибка получения данных для userId ${e}:`,t),null}}(e);if(console.log("[collect_api] Получены данные:",a),!a)return console.log("[collect_api] Данные не получены"),void(i.innerHTML="<p>Не удалось загрузить данные хронологии</p>");console.log("[collect_api] Строим HTML");const s=function(e){if(!e||"object"!=typeof e)return"<p>Нет данных хронологии</p>";if(window.FMV&&"function"==typeof window.FMV.buildChronoHtml)try{return window.FMV.buildChronoHtml(e,{titlePrefix:"Хронология"})}catch(e){console.error("[collect_api] Ошибка FMV.buildChronoHtml:",e)}n("FMV.buildChronoHtml не найден, используем fallback");const t=Object.entries(e);if(0===t.length)return"<p>Хронология пуста</p>";let o='<div class="chrono-data">';for(const[e,n]of t)o+=`<div><strong>${e}:</strong> ${JSON.stringify(n)}</div>`;return o+="</div>",o}(a);console.log("[collect_api] HTML построен, длина:",s.length),function(e,t){e&&(e.innerHTML=t)}(i,s),console.log("[collect_api] Хронология загружена для userId",e)}async function a(a){if(console.log("[collect_api] initIn вызван, root:",a),!a)return void console.log("[collect_api] root не передан");try{o(),console.log("[collect_api] FMVbank найден")}catch(e){return void console.warn("[collect_api]",e.message)}const s=a.querySelector(e)||document.querySelector(e);if(console.log("[collect_api] charEl:",s),!s)return void n("no character");const c=r(s);console.log("[collect_api] scope:",c),function(n){const o=n.querySelector(e);if(!o)return;const r=n.querySelector(t);r&&r.parentElement!==o&&o.appendChild(r)}(c);const l=s.getAttribute("data-id")?.trim();console.log("[collect_api] userId:",l),l?(console.log("[collect_api] Вызываем loadChronoFromApi для userId",l),await i(l,c)):n("no data-id")}window.loadUserChronoFromApi=function({root:e,rootSelector:t}={}){a(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{console.log("[collect_api] DOMContentLoaded событие"),a(document)});const s=new WeakSet;new MutationObserver(t=>{t.forEach(t=>{t.addedNodes&&t.addedNodes.forEach(t=>{t instanceof Element&&(t.matches&&t.matches(e)&&!s.has(t)&&(s.add(t),a(r(t))),t.querySelectorAll&&t.querySelectorAll(e).forEach(e=>{s.has(e)||(s.add(e),a(r(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0})}(),(()=>{"use strict";if(!(window.PROFILE_CHECK&&window.PROFILE_CHECK.GroupID&&window.SKIN&&window.PROFILE_CHECK.ForumID&&window.SKIN.LogFieldID))return void console.warn("[button_create_storage] Требуется window.PROFILE_CHECK с GroupID, ForumID и window.SKIN с LogFieldID");const e=window.PROFILE_CHECK.GroupID.map(Number),t=window.SKIN.LogFieldID,n=window.PROFILE_CHECK.ForumID||[];async function o(e,n,o,r){try{n("Проверяю..."),o(""),r&&r("");const i=window.SITE_URL||window.location.origin,a=await async function(e){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank.storageGet не найден");try{const t=await window.FMVbank.storageGet(e,"skin_");return t&&"object"==typeof t?{skinExists:!0,commentId:t.comment_id||null,data:t,error:!1}:{skinExists:!1,commentId:null,data:null,error:!1}}catch(e){return console.log("[button_create_storage] Ошибка при проверке skin_:",e),{skinExists:!1,commentId:null,data:null,error:!0}}}(e);if(!a.error&&a.skinExists){if(a.commentId){if(n("✓ уже указано","green"),o(`Хранилище уже создано (comment_id: ${a.commentId})`),r){r(`${i}/viewtopic.php?id=${t}#p${a.commentId}`)}return}console.log("[button_create_storage] skin_ существует, но comment_id не указан")}!a.error&&a.skinExists||console.log("[button_create_storage] skin_ не найден или ошибка, проверяем /pages/usr"+e),n("Проверяю страницу...");const s=await async function(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return{valid:!1,error:`HTTP ${n.status}`,hasMainUser:!1};const o=await n.text(),r=(new DOMParser).parseFromString(o,"text/html"),i=r.querySelector(".info .container");if(i&&/неверная или устаревшая/i.test(i.textContent))return{valid:!1,error:"Необходимо создать персональную страницу",hasMainUser:!1};const a=r.querySelector(".modal_script[data-main-user_id]"),s=a?.getAttribute("data-main-user_id");return s&&s.trim()?{valid:!1,error:"Используется хранилище основного профиля",hasMainUser:!0}:{valid:!0,error:null,hasMainUser:!1}}catch(e){return{valid:!1,error:`Ошибка загрузки страницы: ${e.message}`,hasMainUser:!1}}}(e);if(!s.valid)return n("✖ ошибка","red"),void o(s.error);n("Создаю комментарий...");const c=await async function(e){return new Promise((n,o)=>{const r="/viewtopic.php?id="+t,i=window.SITE_URL+"/profile.php?id="+e;console.log("[button_create_storage] Создаём iframe для топика:",r);const a=document.createElement("iframe");a.style.display="none",a.src=r,document.body.appendChild(a);let s=0;const c=setTimeout(()=>{a.remove(),o(new Error("Таймаут создания комментария (15 секунд)"))},15e3);a.onload=function(){if(s++,console.log("[button_create_storage] onload событие #"+s),1!==s){if(2===s){console.log("[button_create_storage] Вторая загрузка - пытаемся извлечь comment_id");try{const e=(a.contentDocument||a.contentWindow.document).querySelectorAll('div.post[id^="p"]');if(console.log("[button_create_storage] Найдено постов с id:",e.length),e.length>0){const t=e[e.length-1].id;console.log("[button_create_storage] ID последнего поста:",t);const o=t.match(/^p(\d+)$/);if(o){const e=Number(o[1]);return console.log("[button_create_storage] ✅ Извлечён comment_id:",e),clearTimeout(c),a.remove(),void n(e)}}try{const e=a.contentWindow.location.href;console.log("[button_create_storage] URL после редиректа:",e);const t=e.match(/[?&]pid=(\d+)/);if(t){const e=Number(t[1]);return console.log("[button_create_storage] ✅ Извлечён comment_id из URL:",e),clearTimeout(c),a.remove(),void n(e)}const o=e.match(/#p(\d+)/);if(o){const e=Number(o[1]);return console.log("[button_create_storage] ✅ Извлечён comment_id из якоря:",e),clearTimeout(c),a.remove(),void n(e)}}catch(e){console.log("[button_create_storage] Не удалось прочитать URL (CORS):",e.message)}clearTimeout(c),a.remove(),o(new Error("Не удалось извлечь comment_id после создания комментария"))}catch(e){clearTimeout(c),a.remove(),o(e)}}}else try{const e=a.contentDocument||a.contentWindow.document,t=e.querySelector('textarea#main-reply[name="req_message"]'),n=e.querySelector('input[type="submit"][name="submit"]');if(!t||!n)return clearTimeout(c),a.remove(),void o(new Error("Не найдена форма ответа в теме логов"));t.value=i,console.log("[button_create_storage] Текст вставлен в textarea:",i),console.log("[button_create_storage] Нажимаю кнопку отправки"),n.click()}catch(e){clearTimeout(c),a.remove(),o(e)}},a.onerror=function(){clearTimeout(c),clearInterval(redirectCheckInterval),a.remove(),o(new Error("Не удалось загрузить страницу темы"))}})}(e);if(n("Сохраняю..."),await async function(e,t,n=null){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageSet)throw new Error("FMVbank не найден");const o=n&&"object"==typeof n?n:{};if(o.comment_id=t,o.last_timestamp=Math.floor(Date.now()/1e3),!await window.FMVbank.storageSet(o,e,"skin_"))throw new Error("Не удалось сохранить данные в API");return console.log("[button_create_storage] comment_id сохранён в API"),!0}(e,c,a.data),n("✓ готово","green"),o(`Хранилище создано (comment_id: ${c})`),r){r(`${i}/viewtopic.php?id=${t}#p${c}`)}}catch(e){n("✖ ошибка","red"),o(e?.message||String(e)),console.error("[button_create_storage] Ошибка:",e)}}window.FMV||(window.FMV={}),"function"==typeof window.createForumButton?window.createForumButton({allowedGroups:e,allowedForums:n,label:"Создать хранилище данных",order:4.5,showStatus:!0,showDetails:!0,showLink:!0,async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{}),r=e?.setLink||(()=>{}),i=document.querySelector("div.post.topicpost");if(!i)return t("✖ ошибка","red"),void n("Не найден контейнер div.post.topicpost");const a=function(e){const t=e.querySelector('.pl-email.profile a[href*="profile.php?id="]');if(!t)return null;const n=t.href.match(/profile\.php\?id=(\d+)/);return n?Number(n[1]):null}(i);if(!a)return t("✖ ошибка","red"),void n("Не удалось определить ID пользователя");console.log("[button_create_storage] userId:",a),await o(a,t,n,r)}}):console.warn("[button_create_storage] createForumButton не найдена")})(),(()=>{"use strict";if(console.log("[button_load_library] Скрипт загружен"),console.log("[button_load_library] window.SKIN:",window.SKIN),!window.SKIN||!window.SKIN.LibraryFieldID)return console.warn("[button_load_library] Требуется window.SKIN с LibraryFieldID"),void console.warn("[button_load_library] window.SKIN:",window.SKIN);const e=[window.SKIN.LibraryForumID],t=window.SKIN.GroupID||[],n=String(window.SKIN.LibraryFieldID).trim();console.log("[button_load_library] LIBRARY_FORUM_ID:",e),console.log("[button_load_library] GID:",t),console.log("[button_load_library] TID (LibraryFieldID):",n);const o={gift:window.SKIN.LibraryGiftPostID||[],plashka:window.SKIN.LibraryPlashkaPostID||[],icon:window.SKIN.LibraryIconPostID||[],background:window.SKIN.LibraryBackPostID||[],coupon:window.SKIN.LibraryCouponPostID||[]};function r(e){const t=e.querySelector(".id"),n=e.querySelector(".content"),o=e.querySelector(".desc");if(!t)return null;const r=t.textContent.trim();if(!r)return null;const i={id:r,content:n?n.innerHTML.trim():"",t:o?o.textContent.trim():""};return i.h=e.classList.contains("hidden")?1:0,i.c=e.classList.contains("custom")?1:0,i.s=e.classList.contains("system")?1:0,i}function i(e){const t=e.querySelector(".id"),n=e.querySelector(".content"),o=e.querySelector(".desc"),r=e.querySelector(".title"),i=e.querySelector(".type"),a=e.querySelector(".form"),s=e.querySelector(".value");if(!t)return null;const c=t.textContent.trim();if(!c)return null;const l={id:c,content:n?n.innerHTML.trim():"",t:o?o.textContent.trim():""};if(r){const e=r.textContent.trim();e&&(l.s_t=e)}if(i){const e=i.textContent.trim();e&&(l.type=e)}if(a){const e=a.textContent.trim();e&&(l.f=e)}if(s){const e=s.textContent.trim();if(e){const t=Number(e);isNaN(t)||(l.v=t)}}return l}async function a(e,t=!1){try{const n=`/viewtopic.php?pid=${e}#p${e}`;console.log(`[button_load_library] Загружаю URL: ${n}`);const o=await async function(e){const t=await fetch(e,{credentials:"include"}),n=await t.arrayBuffer(),o=e=>{try{return new TextDecoder(e).decode(n)}catch{return null}},r=o("utf-8")??"",i=o("windows-1251")??"",a=e=>(e.match(/\uFFFD/g)||[]).length;if(a(i)&&!a(r))return r;if(a(r)&&!a(i))return i;const s=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return s(i)>s(r)?i:r}(n),a=new DOMParser,s=a.parseFromString(o,"text/html").querySelector(`#p${e}-content`);if(!s)return console.warn(`[button_load_library] Не найден #p${e}-content`),[];console.log(`[button_load_library] Найден #p${e}-content`);const c=[...s.querySelectorAll('script[type="text/html"]')];if(console.log(`[button_load_library] Найдено script[type="text/html"]: ${c.length}`),!c.length)return console.warn(`[button_load_library] Нет script[type="text/html"] в посте ${e}`),[];const l=function(e){const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""}(c.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," "),d=a.parseFromString(l,"text/html").querySelectorAll("#grid article.card");console.log(`[button_load_library] Найдено article.card: ${d.length}`);const u=[];for(const e of d){const n=t?i(e):r(e);n&&u.push(n)}return u}catch(t){return console.error(`[button_load_library] Ошибка загрузки поста ${e}:`,t),[]}}console.log("[button_load_library] Проверяем createForumButton:",typeof window.createForumButton),"function"==typeof window.createForumButton?(console.log("[button_load_library] Создаём кнопку с параметрами:",{allowedGroups:t,allowedForums:e,topicId:n,label:"Подгрузить библиотеку"}),window.createForumButton({allowedGroups:t,allowedForums:e,topicId:n,label:"Подгрузить библиотеку",order:1,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{});try{t("Собираю данные..."),n("");const e=await async function(){const e={gift:[],plashka:[],icon:[],background:[],coupon:[]};for(const[t,n]of Object.entries(o)){if(!Array.isArray(n)||0===n.length){console.log(`[button_load_library] Нет постов для категории ${t}`);continue}const o="coupon"===t;for(const r of n){console.log(`[button_load_library] Загружаю пост ${r} для ${t}...`);const n=await a(r,o);e[t].push(...n),console.log(`[button_load_library] Загружено ${n.length} элементов из поста ${r}`)}}return e}(),r=Object.values(e).reduce((e,t)=>e+t.length,0);if(0===r)return t("✓ готово","green"),void n("Не найдено элементов в постах библиотеки");t("Сохраняю..."),await async function(e){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageSet)throw new Error("FMVbank.storageSet не найден");const t=Math.floor(Date.now()/1e3),n=["icon","plashka","background","gift","coupon"];for(const o of n){const n={items:e[o]||[],last_timestamp:t};if(console.log(`[button_load_library] Сохраняю ${o}:`,n),!await window.FMVbank.storageSet(n,1,`library_${o}_`))throw new Error(`Не удалось сохранить данные для ${o} в API`)}return!0}(e),t("✓ готово","green");n(`Загружено элементов:<br>${Object.entries(e).map(([e,t])=>`${e}: ${t.length} шт.`).join("<br>")}<br>Всего: ${r}`)}catch(e){t("✖ ошибка","red"),n(e?.message||String(e)),console.error("[button_load_library] Ошибка:",e)}}}),console.log("[button_load_library] Кнопка создана")):console.warn("[button_load_library] createForumButton не найдена"),console.log("[button_load_library] Инициализация завершена")})(),window.ChronoFilter={init:({root:e}={})=>function(e){const t=(t,n=e)=>n.querySelector(t),n=(t,n=e)=>Array.from(n.querySelectorAll(t)),o=e=>e?new Date(e):null,r=(e,t)=>Array.from(e?.querySelectorAll(`input[name="${t}"]:checked`)||[]).map(e=>e.value),i=t("#filters"),a=t("#list");if(!i||!a)return{apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}};const s=t("#dateStart"),c=t("#dateEnd"),l=t("#resetBtn"),d=t("#typeList"),u=t("#statusList"),p=t("#maskList"),m=t("#playerList"),f=t("#locationList");function g(e,n){const o=t(e);if(!o||!n)return()=>{};const r=e=>{e.stopPropagation(),n.style.display="block"===n.style.display?"none":"block"},i=e=>{n.contains(e.target)||o.contains(e.target)||(n.style.display="none")};return o.addEventListener("click",r),document.addEventListener("click",i),()=>{o.removeEventListener("click",r),document.removeEventListener("click",i)}}const h=g("#typeToggle",d),w=g("#statusToggle",u),y=g("#maskToggle",p),b=g("#playerToggle",m),v=g("#locationToggle",f),S=n("#list .episode").map(e=>{const t=(e.dataset.mask||"").split(";").map(e=>e.trim()).filter(Boolean),n=(e.dataset.players||"").split(";").map(e=>e.trim()).filter(Boolean);return{el:e,type:(e.dataset.type||"").trim(),status:(e.dataset.status||"").trim(),startL:o(e.dataset.startL),startR:o(e.dataset.startR),endL:o(e.dataset.endL),endR:o(e.dataset.endR),masks:t,players:n,location:(e.dataset.location||"").trim()}});function _(){const t=s?.value?new Date(s.value):null,n=c?.value?new Date(c.value):null,o=r(d,"type"),i=r(u,"status"),a=r(p,"mask"),l=r(m,"player"),g=r(f,"location"),h=[],w=[];return S.forEach(e=>{let r=!0;r&&t&&e.endL&&e.endL<t&&(r=!1),r&&n&&e.startR&&e.startR>n&&(r=!1),r&&o.length&&!o.includes(e.type)&&(r=!1),r&&i.length&&!i.includes(e.status)&&(r=!1),r&&a.length&&!e.masks.some(e=>a.includes(e))&&(r=!1),r&&l.length&&!e.players.some(e=>l.includes(e))&&(r=!1),r&&g.length&&!g.includes(e.location)&&(r=!1),e.el.style.display=r?"":"none",(r?h:w).push(e.el)}),e.dispatchEvent(new CustomEvent("chrono:filtered",{detail:{visible:h,hidden:w}})),h}function k(){return s&&(s.value=""),c&&(c.value=""),n('#filters .dropdown-list input[type="checkbox"]').forEach(e=>{e.checked=!1}),_()}function x(e){e.target.closest("#filters .dropdown-list")&&e.target.matches('input[type="checkbox"]')&&_()}return e.addEventListener("change",x),s?.addEventListener("change",_),c?.addEventListener("change",_),l?.addEventListener("click",e=>{e.preventDefault(),k()}),_(),{apply:_,reset:k,getVisible:()=>S.filter(e=>"none"!==e.el.style.display).map(e=>e.el),destroy:()=>{e.removeEventListener("change",x),s?.removeEventListener("change",_),c?.removeEventListener("change",_),l?.removeEventListener("click",k),h(),w(),y(),b(),v()}}}(e||document),apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}},function(){window.FMV||(window.FMV={});const e=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t=t=>e(t).replace(/"/g,"&quot;"),n=e=>Array.from(new Set((e||[]).filter(Boolean))),o=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"";FMV.utils={esc:e,escAttr:t,unique:n,capitalize:o};const r={personal:{label:"личный",emoji:"<иконка>"},plot:{label:"сюжетный",emoji:"<иконка>"},au:{label:"au",emoji:"<иконка>"}},i={on:{label:"активен",emoji:"<иконка>"},archived:{label:"неактуален",emoji:"<иконка>"},off:{label:"закрыт",emoji:"<иконка>"}},a=e=>String(e).padStart(2,"0"),s=(e,t)=>new Date(e,t,0).getDate(),c=(e,t,n)=>`${e}-${a(t)}-${a(n)}`;function l(e){const t=String(e||"").trim();if(!t)return null;let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);return n?{y:+n[3],m:+n[2],d:+n[1],g:"day"}:(n=t.match(/^(\d{4})-(\d{2})-(\d{2})$/),n?{y:+n[1],m:+n[2],d:+n[3],g:"day"}:(n=t.match(/^(\d{1,2})\.(\d{4})$/),n?{y:+n[2],m:+n[1],d:1,g:"month"}:(n=t.match(/^(\d{4})$/),n?{y:+n[1],m:1,d:1,g:"year"}:null)))}FMV.buildChronoHtml=function(d,u={}){u.titlePrefix,e(d?.name||"");const p=Array.isArray(d?.episodes)?d.episodes:[],m=n(p.flatMap(e=>Array.isArray(e?.masks)?e.masks:[])),f=n(p.flatMap(e=>(Array.isArray(e?.participants)?e.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return t.length?t.join(", "):String(e?.name||"").trim()}).map(e=>e.replace(/;/g," ")).filter(Boolean))),g=n(p.map(e=>e?.location).filter(Boolean));let h=null,w=null;const y=p.map(e=>{const t=function(e,t){const n=l(e),o=t?l(t):null;if(!n&&!o)return{startL:"",startR:"",endL:"",endR:""};let r="",i="";n?"day"===n.g?(r=c(n.y,n.m,1),i=c(n.y,n.m,n.d)):"month"===n.g?(r=c(n.y,n.m,1),i=c(n.y,n.m,s(n.y,n.m))):(r=c(n.y,1,1),i=c(n.y,12,31)):o&&("day"===o.g?(r=c(o.y,o.m,1),i=c(o.y,o.m,o.d)):"month"===o.g?(r=c(o.y,o.m,1),i=c(o.y,o.m,s(o.y,o.m))):(r=c(o.y,1,1),i=c(o.y,12,31)));let a="",d="";return o?"day"===o.g?(a=c(o.y,o.m,o.d),d=c(o.y,o.m,s(o.y,o.m))):"month"===o.g?(a=c(o.y,o.m,1),d=c(o.y,o.m,s(o.y,o.m))):(a=c(o.y,1,1),d=c(o.y,12,31)):n&&("day"===n.g?(a=c(n.y,n.m,n.d),d=c(n.y,n.m,s(n.y,n.m))):"month"===n.g?(a=c(n.y,n.m,1),d=c(n.y,n.m,s(n.y,n.m))):(a=c(n.y,1,1),d=c(n.y,12,31))),{startL:r,startR:i,endL:a,endR:d}}(e?.dateStart,e?.dateEnd);return t.startL&&(!h||t.startL<h)&&(h=t.startL),t.endR&&(!w||t.endR>w)&&(w=t.endR),t}),b=Object.entries(r).map(([n,o])=>`<label><input type="checkbox" name="type" value="${t(n)}"> ${e(o.label)}</label>`).join(""),v=Object.entries(i).map(([n,o])=>`<label><input type="checkbox" name="status" value="${t(n)}"> ${e(o.label)}</label>`).join(""),S=n(m).map(n=>`<label><input type="checkbox" name="mask" value="${t(n)}"> ${e(n)}</label>`).join(""),_=f.map(n=>`<label><input type="checkbox" name="player" value="${t(n)}"> ${e(n)}</label>`).join(""),k=g.map(n=>`<label><input type="checkbox" name="location" value="${t(n)}"> ${e(n)}</label>`).join("");let x=`<div class="filters" id="filters">\n    <div class="f">\n      <label>Дата начала фильтра</label>\n      <input type="date" id="dateStart" value="${t(h||"")}">\n    </div>\n    <div class="f">\n      <label>Дата конца фильтра</label>\n      <input type="date" id="dateEnd" value="${t(w||"")}">\n    </div>\n    <div class="f">\n      <label>Тип</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="typeToggle">Выбрать тип</button>\n        <div class="dropdown-list" id="typeList">\n          ${b}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Статус</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="statusToggle">Выбрать статус</button>\n        <div class="dropdown-list" id="statusList">\n          ${v}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Маска</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="maskToggle">Выбрать маску</button>\n        <div class="dropdown-list" id="maskList">\n          ${S}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Участник</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="playerToggle">Выбрать участника</button>\n        <div class="dropdown-list" id="playerList">\n          ${_}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Локация</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="locationToggle">Выбрать локацию</button>\n        <div class="dropdown-list" id="locationList">\n          ${k}\n        </div>\n      </div>\n    </div>\n    <div class="actions">\n      <button class="button" id="resetBtn">Сбросить</button>\n    </div>\n  </div>\n  \n  <div class="list" id="list">\n    `;return p.length?(p.forEach((n,s)=>{const c=r[n?.type]||r.au,d=i[n?.status]||i.archived,u=n?.type||"",p=`${o(u)} ${c.emoji}`,m=n?.status||"",f=`${o(m)} ${d.emoji}`,g=Array.isArray(n?.masks)?n.masks.filter(Boolean):[],h=(Array.isArray(n?.participants)?n.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return(t.length?t.join(", "):String(e?.name||"").trim()).replace(/;/g," ")}).filter(Boolean),w=h.join(";"),b=(Array.isArray(n?.participants)?n.participants:[]).map(n=>{const o=Array.isArray(n?.masks)&&n.masks.length?n.masks.join(", "):String(n?.name||"").trim(),r=n?.id?String(n.id).trim():"";return r?`<a href="/profile.php?id=${t(r)}">${e(o)}</a>`:e(o)}).filter(Boolean).join(", "),v=n?.location||"",S=y[s],_=function(e,t){const n=l(e),o=l(t),r=e=>`${a(e.d)}.${a(e.m)}.${e.y}`,i=e=>`${a(e.m)}.${e.y}`,s=e=>`${e.y}`;if(!n&&!o)return"";if(n&&o&&("day"===n.g&&"day"===o.g&&n.y===o.y&&n.m===o.m&&n.d===o.d||"month"===n.g&&"month"===o.g&&n.y===o.y&&n.m===o.m||"year"===n.g&&"year"===o.g&&n.y===o.y)){if("day"===n.g)return r(n);if("month"===n.g)return i(n);if("year"===n.g)return s(n)}if(!n||!o)return"";const c={...n},d={...o},u=(e,t,n=1)=>{e.m="number"==typeof t?t:e.m??1,e.d=n,e.g="day"},p=(e,t)=>{e.m="number"==typeof t?t:e.m??1,e.d=1,e.g="month"};return"day"===c.g&&"month"===d.g&&u(d,d.m,1),"day"===d.g&&"month"===c.g&&u(c,c.m,1),"day"===c.g&&"year"===d.g&&u(d,1,1),"day"===d.g&&"year"===c.g&&u(c,1,1),"month"===c.g&&"year"===d.g&&p(d,c.m),"month"===d.g&&"year"===c.g&&p(c,d.m),"day"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m&&c.d===d.d?r(c):c.y===d.y&&c.m===d.m?`${a(c.d)}-${a(d.d)}.${a(c.m)}.${c.y}`:c.y===d.y&&c.m!==d.m?`${a(c.d)}.${a(c.m)}-${a(d.d)}.${a(d.m)}.${c.y}`:`${r(c)}-${r(d)}`:"month"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?i(c):c.y===d.y&&c.m!==d.m?`${a(c.m)}-${a(d.m)}.${c.y}`:`${i(c)}-${i(d)}`:"year"===c.g&&"year"===d.g?c.y===d.y?s(c):`${s(c)}-${s(d)}`:"day"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?r(c):c.y===d.y?`${a(c.d)}.${a(c.m)}-${a(d.m)}.${c.y}`:`${r(c)}-${i(d)}`:"month"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m?r(d):c.y===d.y?`${a(c.m)}.${c.y}-${a(d.d)}.${a(d.m)}.${d.y}`:`${i(c)}-${r(d)}`:"day"===c.g&&"year"===d.g?c.y===d.y?r(c):`${r(c)}-${s(d)}`:"year"===c.g&&"day"===d.g?c.y===d.y?r(d):`${s(c)}-${r(d)}`:"month"===c.g&&"year"===d.g?c.y===d.y?i(c):`${i(c)}-${s(d)}`:"year"===c.g&&"month"===d.g?c.y===d.y?i(d):`${s(c)}-${i(d)}`:""}(n?.dateStart,n?.dateEnd),k=_?`<span class="muted">${e(_)} — </span>`:"";x+=`\n  <div class="episode" \n       data-type="${t(u)}" \n       data-status="${t(m)}" \n       data-start-l="${t(S.startL)}" data-start-r="${t(S.startR)}" \n       data-end-l="${t(S.endL)}" data-end-r="${t(S.endR)}"\n       ${g.length?`data-mask="${t(g.join(";"))}"`:""}\n       ${v?`data-location="${t(v)}"`:""}\n       ${h.length?`data-players="${t(w)}"`:""}>\n    <div>тип: ${e(p)}; статус: ${e(f)}</div>\n    <div>${k}<span class="title"><a href="${e(n?.href||"#")}">${e(n?.title||"")}</a></span>\n      ${g.length?` [as ${e(g.join(", "))}]`:""}</div>\n    <div>локация: ${e(v)}</div>\n    <div>участники: ${b}</div>\n  </div>`}),x+="</div>",x):(x+='<div class="meta">Нет эпизодов</div></section>',x)}}(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Создать страницу",order:1,async onClick({setStatus:e,setDetails:t,setLink:n}){const o=document.querySelector("#pun-main h1 span"),r=o?o.textContent.trim().toLowerCase():"";if(!r)return e("✖ нет имени темы","red"),void t("Ожидался #pun-main h1 span");let i=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]');if(!i)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),i=document.querySelector('a[href*="profile.php?id="]')}catch{}const a=i?.href?.match(/profile\.php\?id=(\d+)/i);if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=a[1],c=`usr${s}`,l=(window.PROFILE_CHECK?.PPageTemplate||"").replace(/data-id="N"/g,`data-id="${s}"`),d=window.PROFILE_CHECK?.PPageGroupID;if("function"!=typeof window.FMVcreatePersonalPage)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVcreatePersonalPage(arg1, arg2, arg3, arg4, arg5, arg6)");e("Создаём…","#555"),t(""),n(null);try{const o=await window.FMVcreatePersonalPage(r,c,l,"",d,"0");switch(o?.status){case"created":e("✓ создано","green");break;case"exists":e("ℹ уже существует","green");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}o?.url&&n(o.url,"Открыть страницу");const i=[];o?.serverMessage&&i.push("Сообщение сервера: "+o.serverMessage),o?.httpStatus&&i.push("HTTP: "+o.httpStatus),o?.title&&i.push("Пользователь: "+o.title),o?.name&&i.push("Адресное имя: "+o.name),o?.details&&i.push("Details: "+o.details),t(i.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n?.message||String(n)),console.error("[button_personal_page]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Сменить группу",order:4,async onClick({setStatus:e,setDetails:t}){const n=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupUserID||"",o=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupPlayerID||"";if(!n||!o){const r=[n?null:"PROFILE_CHECK.GroupUserID",o?null:"PROFILE_CHECK.GroupPlayerID"].filter(Boolean).join(", ");return e("✖ замена не выполнена","red"),void t("Не удалось запустить изменение группы: "+(r?`не заданы параметры ${r}. Укажите значения и повторите.`:"отсутствуют необходимые параметры."))}let r=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!r)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),r=document.querySelector('a[href*="profile.php?id="]')}catch{}const i=r?.href?.match(/profile\.php\?id=(\d+)/i),a=i?i[1]:"";if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=... из страницы темы");if("function"!=typeof window.FMVupdateGroupIfEquals)return e("✖ функция недоступна","red"),void t("Ожидалась window.FMVupdateGroupIfEquals(userId, fromId, toId)");e("Проверяю и обновляю…","#555"),t("");try{const r=await window.FMVupdateGroupIfEquals(a,n,o);let i="";if(r?.details){const e=String(r.details).match(/current=([^\s]+)/);e&&(i=e[1])}switch(r?.status){case"updated":e("✓ группа изменена","green");break;case"nochange":e("ℹ изменений нет — пользователь уже в целевой группе","green");break;case"skipped":return e("✖ исходная группа не совпадает","red"),void t(`Исходное значение группы — ${i||"не определено"}.\nЛибо вы пытаетесь поправить не тот профиль, либо выполните замену вручную для дополнительной валидации.`);case"uncertain":e("❔ не удалось подтвердить результат","#b80");break;default:e("✖ ошибка при сохранении","red")}const s=[];r?.serverMessage&&s.push("Сообщение сервера: "+r.serverMessage),r?.httpStatus&&s.push("HTTP: "+r.httpStatus),s.push("Пользователь: "+(r?.userId??a)),s.push(`Замена: ${n} → ${o}`),i&&s.push("Текущее (до попытки): "+i),r?.details&&!i&&s.push("Details: "+r.details),t(s.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_group]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Выдать монетки",order:3,async onClick({setStatus:e,setDetails:t}){let n=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]');if(!n)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),n=document.querySelector('a[href*="profile.php?id="]')}catch{}const o=n?.href?.match(/profile\.php\?id=(\d+)/i);if(!o)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const r=o[1],i=window.PROFILE_CHECK?.MoneyFieldID,a=window.PROFILE_CHECK?.MoneyFieldTemplate;let s;try{const n=`/pages/usr${r}`,o=await fetch(n);if(!o.ok)return e("✖ ошибка загрузки страницы","red"),void t(`Не удалось загрузить ${n}: HTTP ${o.status}`);const i=await o.text(),c=(new DOMParser).parseFromString(i,"text/html"),l=c.querySelector(".info .container");if(l&&/неверная или устаревшая/i.test(l.textContent))return e("✖ страница не создана","red"),void t("Необходимо создать персональную страницу");const d=c.querySelector(".modal_script[data-main-user_id]"),u=d?.getAttribute("data-main-user_id");s=u&&u.trim()?`\x3c!-- main: usr${u.trim()} --\x3e`:String(a)}catch(n){return e("✖ ошибка проверки страницы","red"),t(`Ошибка при загрузке /pages/usr${r}: ${n.message}`),void console.error("[button_update_money_field]",n)}if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция обновления не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляем…","#555"),t("");try{const n=await window.FMVreplaceFieldData(r,i,s);switch(n?.status){case"updated":e("✓ обновлено","green");break;case"nochange":e("ℹ изменений нет","green");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}const o=[];n?.serverMessage&&o.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&o.push("HTTP: "+n.httpStatus),o.push("Поле: "+(n?.fieldId??i)),o.push("Пользователь: "+(n?.userId??r)),o.push("Значение: "+s),n?.details&&o.push("Details: "+n.details),t(o.join("\n"))}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_money_field]",n)}}})})(),window.fetchAllLibraries=fetchAllLibraries,function(){"use strict";const e='\n  details.ufo-panel{margin-top:12px;border:1px solid #d0d0d7;border-radius:10px;background:#fff}\n  details.ufo-panel>summary{cursor:pointer;list-style:none;padding:10px 14px;font-weight:600;background:#f6f6f8;border-bottom:1px solid #e6e6ef;border-radius:10px}\n  details.ufo-panel>summary::-webkit-details-marker{display:none}\n  .ufo-wrap{display:flex;flex-direction:column;gap:16px;padding:14px}\n  .ufo-col{display:flex;flex-direction:column;gap:8px}\n  .ufo-col h4{margin:0;font-size:14px;opacity:.8;display:flex;justify-content:space-between;align-items:center}\n  .ufo-search{padding:6px 10px;font-size:13px;border:1px solid #d0d0d7;border-radius:8px;background:#f5f2e8}\n  .ufo-lib,.ufo-selected{border:1px dashed #c9c9d9;border-radius:8px;background:#fafafd;padding:8px;overflow:auto}\n  .ufo-lib{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}\n  .ufo-lib .ufo-card{margin:0}\n  .ufo-card{display:grid;grid-template-columns:auto 1fr auto auto;grid-template-rows:auto auto;grid-template-areas:"id full date actions" "id title title actions";gap:8px;background:#fff;border:1px solid #e7e7ef;border-radius:8px;padding:8px;margin:6px 0;max-width:100%;position:relative;overflow:hidden}\n  .ufo-idtag{grid-area:id;font-size:11px;opacity:.7;align-self:start}\n  .ufo-actions{grid-area:actions;display:flex;align-items:center;gap:6px}\n  .ufo-btn{border:1px solid #d7d7e0;background:#f3f3f7;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;line-height:1.15;display:inline-flex;align-items:center}\n  .ufo-btn:hover{background:#ececf4}\n  .ufo-card.disabled{opacity:.4;pointer-events:none}\n  .ufo-full{grid-area:full;box-sizing:border-box;margin:0;padding:0;border:0;background:transparent;overflow:hidden}\n  .ufo-full .item{position:relative;margin:0}\n  .ufo-full .item .modal-link{display:block}\n  .ufo-full .item img{display:block;max-width:100%;height:auto;border-radius:6px}\n  .ufo-lib .ufo-full .item img{height:90px;width:100%;object-fit:cover}\n  .ufo-lib .ufo-full a{pointer-events:none}\n  .ufo-title-edit{grid-area:title;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;white-space:pre-wrap;overflow:visible}\n  .ufo-title-edit:focus{outline:none;background:#fffdf1}\n  .ufo-date-edit{grid-area:date;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;align-self:start}\n  .ufo-date-edit input{border:none;background:transparent;font-size:13px;width:100%;font-family:inherit}\n  .ufo-date-edit input:focus{outline:none}\n  ';!function(){if(window.__ufoCSS)return;window.__ufoCSS=!0;const t=document.createElement("style");t.textContent=e,document.head.appendChild(t),"function"==typeof GM_addStyle&&GM_addStyle(e)}();const t=(e,t)=>{const n=document.createElement("button");return n.type="button",n.className="ufo-btn",n.textContent=e,n.addEventListener("click",t),n};function n(e){const t=e.querySelector(".ufo-card");if(!t)return void(e.style.maxHeight="");const n=getComputedStyle(t),o=t.getBoundingClientRect().height,r=parseFloat(n.marginTop)||0,i=parseFloat(n.marginBottom)||0,a=getComputedStyle(e),s=parseFloat(a.paddingTop)||0,c=parseFloat(a.paddingBottom)||0,l=Math.round(2*o+3*(r+i)+s+c);e.style.maxHeight=l+"px"}function o(e){const t=function(e){return[...e.querySelectorAll(".ufo-card")].find(e=>"none"!==getComputedStyle(e).display)||null}(e);if(!t)return void(e.style.maxHeight="");const n=t.getBoundingClientRect().height,o=getComputedStyle(e),r=parseFloat(o.rowGap)||0,i=parseFloat(o.paddingTop)||0,a=parseFloat(o.paddingBottom)||0,s=Math.round(2*n+r+i+a);e.style.maxHeight=s+"px"}window.createChoicePanelJSON=function(e){const r=Object.assign({title:"Библиотека и выбранные",targetClass:"_section",library:[],startOpen:!1,itemSelector:".item",idAttr:"data-id",editableAttr:"title",searchPlaceholder:"поиск по id",mountEl:null,allowMultiAdd:!1,expirableAttr:null},e||{});Array.isArray(r.library)||(r.library=[]);const i="ufo_"+(r.targetClass||"section").replace(/\W+/g,"_")+"_"+Math.random().toString(36).slice(2,7);let a=[];const s=document.createElement("details");s.className="ufo-panel",s.open=!!r.startOpen;const c=document.createElement("summary");c.textContent=r.title||"Панель";const l=document.createElement("div");l.className="ufo-wrap";const d=document.createElement("div");d.className="ufo-col";const u=document.createElement("h4");u.textContent="Библиотека";const p=document.createElement("input");p.type="text",p.placeholder=r.searchPlaceholder||"поиск по id",p.className="ufo-search",u.appendChild(p);const m=document.createElement("div");m.className="ufo-lib",m.id=i+"-lib",d.append(u,m);const f=document.createElement("div");f.className="ufo-col",f.innerHTML="<h4>Выбранные (сверху — новее)</h4>";const g=document.createElement("div");function h(e){const n=document.createElement("div");n.className="ufo-card",n.dataset.id=e.id;const o=document.createElement("div");o.className="ufo-idtag",o.textContent="#"+e.id;const i=document.createElement("div");i.className="ufo-full";const s=document.createElement("div");s.innerHTML=e.html.trim(),i.appendChild(s.firstElementChild);const c=document.createElement("div");return c.className="ufo-actions",c.appendChild(t("Добавить ↑",t=>{t.preventDefault(),t.stopPropagation(),function(e){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);if(!r.allowMultiAdd){if(a.some(t=>t.id===e.id))return;t&&t.classList.add("disabled")}const n=document.createElement("div");n.innerHTML=e.html.trim();const o=n.querySelector(r.itemSelector),i={id:e.id,title:o&&o.getAttribute(r.editableAttr)||"",content:o?o.innerHTML.trim():""};if(o&&o.attributes)for(let e=0;e<o.attributes.length;e++){const t=o.attributes[e];if(t.name.startsWith("data-")&&"data-id"!==t.name){i[t.name.substring(5).replace(/-/g,"_")]=t.value}}r.expirableAttr&&o&&(i.expired_date=o.getAttribute(r.expirableAttr)||"");a.unshift(i),w()}(e)})),n.append(o,i,c),n}function w(){g.innerHTML="",a.forEach((e,n)=>{const o=function(e,n){const o=document.createElement("div");o.className="ufo-card",o.draggable=!0,o.dataset.id=e.id,o.dataset.index=n;const i=document.createElement("div");i.className="ufo-idtag",i.textContent="#"+e.id;const s=document.createElement("div");s.className="ufo-full";const c=document.createElement("div");c.innerHTML=e.content.trim(),s.appendChild(c.firstElementChild);const l=document.createElement("div");l.className="ufo-title-edit",l.contentEditable=!0,l.textContent=e.title||"",l.addEventListener("blur",()=>{const e=String(l.innerHTML||"").replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;|[\u00A0\u200B-\u200D\u2060\uFEFF]/g,"").replace(/\s+/g," ").trim();a[n].title=e});let d=null;if(r.expirableAttr){d=document.createElement("div"),d.className="ufo-date-edit";const t=document.createElement("input");t.type="date",t.value=e.expired_date||"",t.addEventListener("change",()=>{a[n].expired_date=t.value}),d.appendChild(t)}const u=document.createElement("div");u.className="ufo-actions";const p=t("↑",e=>{e.preventDefault(),e.stopPropagation(),n>0&&([a[n-1],a[n]]=[a[n],a[n-1]],w())}),f=t("↓",e=>{e.preventDefault(),e.stopPropagation(),n<a.length-1&&([a[n],a[n+1]]=[a[n+1],a[n]],w())}),g=t("✕",t=>{if(t.preventDefault(),t.stopPropagation(),a.splice(n,1),!r.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.remove("disabled")}w()});u.append(p,f,g),o.append(i,s,u,l),d&&o.appendChild(d);return o}(e,n);g.appendChild(o)}),n(g)}return g.className="ufo-selected",g.id=i+"-selected",f.appendChild(g),l.append(d,f),s.append(c,l),r.mountEl&&r.mountEl.appendChild(s),r.library.forEach(e=>m.appendChild(h(e))),function(e){let t=null;e.addEventListener("dragstart",e=>{const n=e.target.closest(".ufo-card");n&&(t=parseInt(n.dataset.index,10),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""))}),e.addEventListener("dragover",e=>{e.preventDefault();const n=e.target.closest(".ufo-card");if(!n||null===t)return;const o=parseInt(n.dataset.index,10);if(t===o)return;const r=a[t];a.splice(t,1),a.splice(o,0,r),t=o,w()}),e.addEventListener("drop",e=>{e.preventDefault(),t=null}),e.addEventListener("dragend",()=>{t=null})}(g),p.addEventListener("input",()=>{const e=p.value.trim();m.querySelectorAll(".ufo-card").forEach(t=>{t.style.display=!e||t.dataset.id.includes(e)?"":"none"}),o(m)}),new MutationObserver(()=>n(g)).observe(g,{childList:!0,subtree:!0,attributes:!0}),new MutationObserver(()=>o(m)).observe(m,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),window.addEventListener("resize",()=>{o(m),n(g)}),o(m),n(g),{details:s,init:function(e){Array.isArray(e)&&(a=[],e.forEach(e=>{if(a.push({...e}),!r.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.add("disabled")}}),w())},getData:function(){return a.map(e=>{const t=document.createElement("div");if(t.innerHTML=e.content.trim(),r.expirableAttr){const n=t.querySelector("img");if(n){const t=n.parentNode.querySelector(".coupon_deadline");t&&t.remove();const o=document.createElement("span");if(o.className="coupon_deadline",e.expired_date){const t=e.expired_date.split("-");if(3===t.length){const e=t[0].slice(2),n=t[1],r=t[2];o.textContent=`${r}/${n}/${e}`}}n.nextSibling?n.parentNode.insertBefore(o,n.nextSibling):n.parentNode.appendChild(o)}}if(e.title){t.querySelectorAll(`[${r.editableAttr}]`).forEach(t=>{t.setAttribute(r.editableAttr,e.title)})}const n={id:e.id,title:e.title||"",content:t.innerHTML.trim()};return Object.keys(e).forEach(t=>{"id"!==t&&"title"!==t&&"content"!==t&&(n[t]=e[t])}),n})}}}}(),function(){"use strict";window.setupSkinsJSON=async function(e,t={}){if(!(e&&e instanceof HTMLElement))throw new Error("[setupSkinsJSON] container обязателен и должен быть HTMLElement");if("function"!=typeof window.createChoicePanelJSON)throw new Error("[setupSkinsJSON] createChoicePanelJSON не найден. Подключите файл с панелью раньше.");if(window.__skinsSetupJSONMounted)return window.__skinsSetupJSONMounted;const n=t.withHeaders??!0,o=t.startOpen??!1,r=t.initialData||{};if("function"!=typeof window.fetchAllLibraries)return void console.error("[setupSkinsJSON] window.fetchAllLibraries не найдена. Подключите fetch_libraries.js");const i=await window.fetchAllLibraries(),a=i.plashka,s=i.icon,c=i.back,l=i.gift,d=i.coupon;let u=e.querySelector(".skins-setup-grid");u||(u=document.createElement("div"),u.className="skins-setup-grid",u.style.display="grid",u.style.gridTemplateColumns="1fr",u.style.gap="16px",e.appendChild(u));const p=window.createChoicePanelJSON({title:n?"Подарки":void 0,targetClass:"_gift",library:l,mountEl:u,startOpen:o,allowMultiAdd:!0}),m=window.createChoicePanelJSON({title:n?"Купоны":void 0,targetClass:"_coupon",library:d,mountEl:u,startOpen:o,allowMultiAdd:!0,expirableAttr:"data-expired-date"}),f=window.createChoicePanelJSON({title:n?"Плашки":void 0,targetClass:"_plashka",library:a,mountEl:u,startOpen:o}),g=window.createChoicePanelJSON({title:n?"Иконки":void 0,targetClass:"_icon",library:s,mountEl:u,startOpen:o}),h=window.createChoicePanelJSON({title:n?"Фон":void 0,targetClass:"_background",library:c,mountEl:u,startOpen:o});r.gift&&p.init(r.gift),r.coupon&&m.init(r.coupon),r.plashka&&f.init(r.plashka),r.icon&&g.init(r.icon),r.background&&h.init(r.background);const w={getData:function(){return{icon:g.getData(),plashka:f.getData(),background:h.getData(),gift:p.getData(),coupon:m.getData()}},getLibraryIds:function(){return{icon:new Set(s.map(e=>String(e.id))),plashka:new Set(a.map(e=>String(e.id))),background:new Set(c.map(e=>String(e.id))),gift:new Set(l.map(e=>String(e.id))),coupon:new Set(d.map(e=>String(e.id)))}},panels:{plashka:f,icon:g,back:h,gift:p,coupon:m}};return window.__skinsSetupJSONMounted=w,w}}(),function(){"use strict";if(window.__profileRunnerJSONMounted)return;window.__profileRunnerJSONMounted=!0;const e=(e,t=document)=>t.querySelector(e);async function t(){await new Promise(e=>{if("complete"===document.readyState||"interactive"===document.readyState)return e();document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})});const t=e("#viewprofile .container")||e("#viewprofile")||e("#pun-main")||document.body,n=document.createElement("div");return n.id="fmv-skins-panel",n.style.margin="16px 0",n.innerHTML='\n       <details open style="border:1px solid #d6d6de;border-radius:10px;background:#fff">\n        <summary style="list-style:none;padding:10px 14px;border-bottom:1px solid #e8e8ef;border-radius:10px;font-weight:600;background:#f6f7fb;cursor:pointer">\n          Обновление скинов\n        </summary>\n        <div class="fmv-skins-body" style="padding:14px"></div>\n        <div class="fmv-skins-footer" style="display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid #eee">\n          <button type="button" class="fmv-save"\n            style="background:#2f67ff;color:#fff;border:1px solid #2f67ff;border-radius:8px;padding:8px 14px;cursor:pointer">\n            Сохранить\n          </button>\n          <span class="fmv-status" style="margin-left:8px;font-size:14px;color:#666"></span>\n        </div>\n      </details>\n    ',t.appendChild(n),n.querySelector(".fmv-skins-body")}(async()=>{if("/profile.php"!==location.pathname)return;const e=new URLSearchParams(location.search);if(!e.has("id")||[...e.keys()].some(e=>"id"!==e))return;const n=(e.get("id")||"").trim();if(!n)return;const o=window.SKIN?.GroupID||[];if("function"!=typeof window.ensureAllowed)return;if(!await window.ensureAllowed(o))return;const r=await t();let i=null,a=null;if("function"==typeof window.setupSkinsJSON)try{const e=await window.setupSkinsJSON(r,{initialData:{}});e&&"function"==typeof e.getData&&(i=e.getData),e&&"function"==typeof e.getLibraryIds&&(a=e.getLibraryIds)}catch(e){console.error("setupSkinsJSON() error:",e)}if(!i||!a)return void console.error("[profile_runner_json] Не удалось инициализировать панели");const s=a();if(!window.skinAdmin||"function"!=typeof window.skinAdmin.load)return void console.error("[profile_runner_json] skinAdmin.load не найден.");const{status:c,visibleData:l,save:d}=await window.skinAdmin.load(n,s);if("ok"!==c&&"ок"!==c)return void console.error("[profile_runner_json] Не удалось загрузить данные со скинами");if(window.__skinsSetupJSONMounted&&window.__skinsSetupJSONMounted.panels){const e=window.__skinsSetupJSONMounted.panels;l.gift&&e.gift&&e.gift.init(l.gift),l.coupon&&e.coupon&&e.coupon.init(l.coupon),l.plashka&&e.plashka&&e.plashka.init(l.plashka),l.icon&&e.icon&&e.icon.init(l.icon),l.background&&e.back&&e.back.init(l.background)}const u=document.getElementById("fmv-skins-panel"),p=u?.querySelector(".fmv-save"),m=u?.querySelector(".fmv-status");p&&p.addEventListener("click",async()=>{try{m&&(m.textContent="Сохраняю…",m.style.color="#666");const e=i?i():null;if(!e)return void(m&&(m.textContent="Нечего сохранять",m.style.color="#c24141"));let t=null;if("function"!=typeof d)return void(m&&(m.textContent="Нет функции сохранения",m.style.color="#c24141"));t=await d(e);const n=!(!t||!t.ok&&"saved"!==t.status&&"успешно"!==t.status&&"ok"!==t.status);m&&(n?(m.textContent="✓ Успешно сохранено",m.style.color="#16a34a",setTimeout(()=>location.reload(),1e3)):(m.textContent="Ошибка сохранения",m.style.color="#c24141"))}catch(e){console.error(e),m&&(m.textContent="Ошибка сохранения",m.style.color="#c24141")}})})()}(),
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */
function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,n=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),o=/^\s*main:\s*usr(\d+)\s*$/i,r=e=>`#${n(e)}, .${n(e)}`,i=new TextDecoder("utf-8");let a;async function s(e){const t=await fetch(e,{credentials:"same-origin"}),n=await t.arrayBuffer();let o=i.decode(n);if(/charset\s*=\s*windows-1251/i.test(o)||o.includes("�"))try{o=(a||=new TextDecoder("windows-1251")).decode(n)}catch{}return o}function c(e,t){const n=e.querySelector(r(t)),o=n?.querySelector("strong, b");let i=o?.textContent?.trim();if(!i){const e=(n?.textContent||"").trim();i=e.split(":").slice(-1)[0]?.trim()}return(i||"").replace(/\u00A0/g," ").trim()}const l=new Map;function d(e,t){if(l.has(e))return l.get(e);const n=(async()=>{const n=await s(`/profile.php?id=${encodeURIComponent(e)}`);return c((new DOMParser).parseFromString(n,"text/html"),t)})();return l.set(e,n),n}function u(){document.querySelectorAll(r(t)).forEach(e=>function(e,t){const n=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),r=[];for(let e;e=n.nextNode();){const t=(e.nodeValue||"").match(o);t&&r.push({node:e,uid:t[1]})}r.forEach(({node:e,uid:n})=>{d(n,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+n,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:n}={}){const i=`pa-fld${String(n??e).replace(/\D/g,"")||e}`,a=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(o);if(t)return t[1]}return null}(t.querySelector(r(i)));if(a)try{return await d(a,i)}catch(e){console.warn("[main-field] remote error:",e)}return c(t,i)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()}();const IP_ROWS=1,IP_GAP=8,IP_REQUIRED=!0;function isProfileFieldsPage(){try{const e=new URL(location.href);if(!/\/profile\.php$/i.test(e.pathname))return!1;const t=e.searchParams;if("fields"!==t.get("section"))return!1;const n=t.get("id");return!!n&&/^\d+$/.test(n)}catch{return!1}}const STYLE_ID="ip-style-clean";function injectStylesOnce(){if(document.getElementById(STYLE_ID))return;const e=document.createElement("style");e.id=STYLE_ID,e.textContent="\n    /* скрываем исходный textarea/input */\n    .ip-hidden {\n      display: none !important;\n      resize: none !important;\n      visibility: hidden !important;\n    }\n\n    /* Белый контейнер подстраивается под ширину контента */\n    .ip-box {\n      position: relative;\n      display: inline-block;          /* ширина = контенту */\n      max-width: 100%;\n      border: 1px solid #ccc;\n      border-radius: 10px;\n      background: #fff;\n      padding: 6px;\n    }\n\n    /* Вертикальный скролл */\n    .ip-scroll {\n      overflow-y: auto;\n      overflow-x: hidden;\n      -webkit-overflow-scrolling: touch;\n      max-height: calc(var(--ip-rows,1) * var(--ip-h,44px)\n                      + (var(--ip-rows,1) - 1) * var(--ip-gap,8px));\n    }\n\n    /* Сетка: перенос вниз, ширина по контенту */\n    .ip-grid {\n      display: flex;\n      flex-wrap: wrap;\n      gap: var(--ip-gap,8px);\n      align-content: flex-start;\n      justify-content: flex-start;\n    }\n\n    .ip-btn {\n      position: relative;\n      overflow: hidden;\n      width: var(--ip-w,44px);\n      height: var(--ip-h,44px);\n      border: 2px solid #d0d0d0;\n      border-radius: 10px;\n      background: #fff;\n      padding: 0;\n      cursor: pointer;\n      touch-action: manipulation;\n    }\n    .ip-btn[selected] {\n      border-color: #0b74ff;\n      box-shadow: 0 0 0 3px rgba(11,116,255,.15);\n    }\n\n    .ip-slot {\n      position: relative;\n      width: 100%;\n      height: 100%;\n    }\n    .ip-slot img {\n      width: 100%;\n      height: 100%;\n      display: block;\n      object-fit: cover;\n    }\n    .ip-slot * {\n      pointer-events: none;\n    }\n  ",document.head.appendChild(e)}function resolveFieldBySuffix(e){const t=`fld${String(e)}`,n=`form[fld${String(e)}]`;return document.querySelector(`#${CSS.escape(t)}[name="${n}"]`)||document.getElementById(t)||document.querySelector(`[name="${n}"]`)}function normalizeModalLinkAttrs(e){const t=document.createElement("template");return t.innerHTML=String(e??""),t.content.querySelectorAll("a.modal-link").forEach(e=>{Array.from(e.attributes).forEach(t=>{"class"!==t.name&&"style"!==t.name&&e.removeAttribute(t.name)})}),t.innerHTML.trim()}function prepareModalLinkAttrs(e){const t=document.createElement("template");t.innerHTML=String(e??"");const n=t.content.querySelectorAll("a.modal-link");if(n.length){const e=new URL(location.href).searchParams.get("id"),t=e&&/^\d+$/.test(e)?`usr${e}`:null;n.forEach(e=>{e.setAttribute("data-reveal-id","character"),t&&e.setAttribute("id",t)})}return t.innerHTML.trim()}function createThumbSlot(e){const t=document.createElement("div");t.className="ip-slot";const n=String(e??"").trim();if(!n)return t;const o=document.createElement("template");if(o.innerHTML=n,o.content.querySelector("*"))t.appendChild(o.content.cloneNode(!0));else{const e=document.createElement("img");e.src=n,e.alt="",e.loading="lazy",t.appendChild(e)}return t}function keyFor(e){const t=String(e??"");let n=5381;for(let e=0;e<t.length;e++)n=(n<<5)+n^t.charCodeAt(e);return"k"+(n>>>0).toString(36)}const FORM_STATE=new WeakMap;function applyImagePicker(e,t,n={}){if(!isProfileFieldsPage())return;injectStylesOnce();const o=!!n.modalLinkMode,r=(Array.isArray(e)?e:[]).map(e=>String(e??"")),i=resolveFieldBySuffix(t);if(!i)return;i.classList.add("ip-hidden");const a=Number.isFinite(n.btnWidth)?Math.max(1,n.btnWidth):44,s=Number.isFinite(n.btnHeight)?Math.max(1,n.btnHeight):44,c=Number.isFinite(n.gridColSize)?Math.max(1,n.gridColSize):a,l=r.map(e=>o?normalizeModalLinkAttrs(e):e),d=new Set(l),u=new Map(l.map(e=>[e,keyFor(e)])),p=o?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");let m=null;if(r.length>0){const e=document.createElement("div");e.className="ip-box",e.style.setProperty("--ip-rows",String(1)),e.style.setProperty("--ip-gap","8px"),e.style.setProperty("--ip-w",`${a}px`),e.style.setProperty("--ip-h",`${s}px`),e.style.setProperty("--ip-col",`${c}px`);const t=document.createElement("div");t.className="ip-scroll";const n=document.createElement("div");n.className="ip-grid";const d=i.id?document.querySelector(`label[for="${i.id}"]`):null;(i.closest("label")||d||i).insertAdjacentElement("afterend",e),t.addEventListener("pointerdown",e=>e.stopPropagation()),t.addEventListener("click",e=>e.stopPropagation()),l.forEach((e,t)=>{const i=document.createElement("button");i.type="button",i.className="ip-btn",i.dataset.key=u.get(e);const a=o?e:r[t];i.appendChild(createThumbSlot(a));const s=t=>{t.preventDefault(),t.stopPropagation(),h(e)};i.addEventListener("pointerdown",s),i.addEventListener("click",s),n.appendChild(i)}),t.appendChild(n),e.appendChild(t),m=n}function f(e){if(!m)return;const t=u.get(String(e))||"";if(m.querySelectorAll(".ip-btn").forEach(e=>e.removeAttribute("selected")),t){const e=m.querySelector(`.ip-btn[data-key="${t}"]`);e&&e.setAttribute("selected","")}}let g=!1;function h(e){const t=String(e??"");i.value!==t&&(g=!0,i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})),g=!1),f(t)}const w=l[0]||"",y=r.length?d.has(p)?p:w:"";i.dataset.ipInitial=y,h(y),i.addEventListener("input",()=>{g||f(o?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))}),i.addEventListener("change",()=>{g||f(o?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))});const b=i.closest("form");if(!b)return{set:h};let v=FORM_STATE.get(b);v||(v={entries:[],hooked:!1},FORM_STATE.set(b,v));if(v.entries.push({input:i,fieldSuffix:t,prepareOne:()=>{let e=o?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");if(!r.length){const e=o?prepareModalLinkAttrs(""):"";return i.value=e,e}if(!d.has(e)){const t=i.dataset.ipInitial??w;e=String(t),h(e)}const t=o?prepareModalLinkAttrs(e):e;return i.value=t,t}}),!v.hooked){v.hooked=!0;const e=b.submit,t=()=>{v.entries.forEach(({prepareOne:e})=>{e()})};b.addEventListener("submit",e=>{"1"!==b.dataset.ipResuming&&t()},!0),b.addEventListener("formdata",e=>{t(),v.entries.forEach(({input:t,fieldSuffix:n})=>{try{const o=t.name||`form[fld${n}]`;e.formData.set(o,t.value)}catch(e){}})}),b.submit=function(...n){return"1"===b.dataset.ipResuming||t(),e.apply(this,n)}}return{set:h}}async function FMVreplaceFieldData(e,t,n,o=!1){const r=`/profile.php?section=fields&id=${encodeURIComponent(e)}&nohead`,i="#fld"+t;try{const e=await fetchCP1251Doc(r),s=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!s)return{status:"error",fieldId:String(t),value:n,serverMessage:"Форма редактирования профиля не найдена",details:"profile.php без формы"};const c=s.querySelector(i);if(!c)return{status:"error",fieldId:String(t),value:n,serverMessage:`Поле ${i} не найдено. Проверьте номер fld.`};const l=c.value??"";if(""!==(a=l)&&" "!==a&&!o)return{status:"nochange",fieldId:String(t),value:n,serverMessage:"Поле уже содержит значение. Перезапись запрещена.",details:`Прежнее значение: ${String(l)}`};if(c.value=n,![...s.elements].some(e=>"update"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="update",t.value="1",s.appendChild(t)}let d="update";const u=[...s.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));u?.name&&(d=u.name);const p=serializeFormCP1251_SelectSubmit(s,d),m=s.getAttribute("action")||"/profile.php",{res:f}=await fetchCP1251Text(m,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:r,referrerPolicy:"strict-origin-when-cross-origin",body:p});if(!f.ok)return{status:"error",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:`HTTP ${f.status} при сохранении`};const g=await fetchCP1251Doc(r),h=g.querySelector("form#profile8")||[...g.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));return(h?.querySelector(i)?.value??null)===n?{status:"updated",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Значение успешно обновлено"}:{status:"uncertain",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Не удалось подтвердить новое значение, проверьте вручную"}}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,n}var a}async function FMVupdateGroupIfEquals(e,t,n,o={}){const r=!!o.overwriteSame,i=String(e),a=`/profile.php?section=admin&id=${encodeURIComponent(i)}&nohead`;try{const e=await fetchCP1251Doc(a),o=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!o)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Форма администрирования профиля не найдена",details:"profile.php?section=admin без ожидаемой формы"};const s=o.querySelector('select[name="group_id"]')||o.querySelector("#group_id");if(!s)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Селектор group_id не найден"};const c=(s.value??"").trim(),l=String(t).trim(),d=String(n).trim();if(c===d&&!r)return{status:"nochange",userId:i,fromGroupId:l,toGroupId:d,serverMessage:"Пользователь уже в целевой группе; перезапись отключена",details:`current=${c}`};if(c!==l&&(c!==d||!r))return{status:"skipped",userId:i,fromGroupId:l,toGroupId:d,serverMessage:"Текущая группа не совпадает с fromGroupId — изменения не требуются",details:`current=${c}`};if(s.value=d,![...o.elements].some(e=>"form_sent"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="form_sent",t.value="1",o.appendChild(t)}let u="update_group_membership";const p=[...o.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(o,u),f=o.getAttribute("action")||`/profile.php?section=admin&id=${encodeURIComponent(i)}`,{res:g,text:h}=await fetchCP1251Text(f,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m});if(!g.ok)return{status:"error",userId:i,fromGroupId:l,toGroupId:d,httpStatus:g.status,serverMessage:`HTTP ${g.status} при сохранении`};const w=await fetchCP1251Doc(a),y=w.querySelector("form#profile8")||[...w.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php")),b=y?.querySelector('select[name="group_id"]')||y?.querySelector("#group_id"),v=(b?.value??"").trim();return v===d?{status:"updated",userId:i,fromGroupId:l,toGroupId:d,httpStatus:g.status,serverMessage:"Группа успешно обновлена"}:{status:"uncertain",userId:i,fromGroupId:l,toGroupId:d,httpStatus:g.status,serverMessage:"Сервер ответил 200, но подтвердить новое значение не удалось — проверьте вручную",details:`readback=${v}`}}catch(o){const r=o&&o.message?o.message:String(o);return{status:"error",userId:String(e),fromGroupId:String(t),toGroupId:String(n),serverMessage:"Transport/Runtime error",details:r}}}async function fetchCardsWrappedClean(e,t,n={}){const{isCoupon:o=!1}=n,r=`${location.origin.replace(/\/$/,"")}/viewtopic.php?id=${encodeURIComponent(String(e))}`,i=e=>{const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""},a=e=>(new DOMParser).parseFromString(e,"text/html");const s=a(await async function(e){if("function"==typeof window.fetchHtml)return window.fetchHtml(e);const t="function"==typeof window.fetchWithRetry?window.fetchWithRetry:fetch,n=await t(e,{credentials:"include"}),o=await n.arrayBuffer(),r=/charset=([^;]+)/i.exec(n.headers.get("content-type")||"")?.[1]?.toLowerCase(),i=e=>{try{return new TextDecoder(e).decode(o)}catch{return null}};if(r){const e=i(r);if(e)return e}const a=i("utf-8")??"",s=i("windows-1251")??"",c=e=>(e.match(/\uFFFD/g)||[]).length;if(c(s)&&!c(a))return a;if(c(a)&&!c(s))return s;const l=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return l(s)>l(a)?s:a}(r)),c=[];for(const e of t){const t=s.querySelector(`#p${String(e)}-content`);if(!t){console.warn(`Не найден #p${e}-content на ${r}`);continue}const n=[...t.querySelectorAll('script[type="text/html"]')];if(!n.length)continue;const l=[...a(i(n.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," ")).querySelectorAll("#grid article.card")].map(e=>{const t=FMV.normSpace(e.querySelector(".id")?.textContent||""),n=FMV.normSpace(e.querySelector(".desc")?.textContent||""),r=(e.querySelector(".content")?.innerHTML||"").replace(/\u00A0/g," ").trim(),i=n?` title="${n}"`:"";let a="";if(o){const t=FMV.normSpace(e.querySelector(".title")?.textContent||""),n=FMV.normSpace(e.querySelector(".type")?.textContent||""),o=FMV.normSpace(e.querySelector(".form")?.textContent||""),r=FMV.normSpace(e.querySelector(".value")?.textContent||"");a=`${t?` data-coupon-title="${t}"`:""}${n?` data-coupon-type="${n}"`:""}${o?` data-coupon-form="${o}"`:""}${r?` data-coupon-value="${r}"`:""}`}return{id:t,html:`<div class="item" data-id="${t}"${i}${a}>${r}</div>`}});c.push(...l)}return c}function findChronoRendered(e){const t=Array.from(e.querySelectorAll("*")).find(e=>/Собранная\s+хронология/i.test(e.textContent||""));return t?t.closest(".quote-box, .media, .spoiler-box, .content, .post, div, section")||t:null}function renderStatus(e,t){const n=window.CHRONO_CHECK?.EpisodeMapType||{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},o=window.CHRONO_CHECK?.EpisodeMapStat||{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},r=n[e]||n.au,i=o[t]||o.archived;return`[color=${r[1]}]${r[0]}[/color] / [color=${i[1]}]${i[0]}[/color]`}function parseParagraph(e){const t=[[],[],[],[]];let n=0;for(const o of e.childNodes)1!==o.nodeType||"BR"!==o.tagName?t[n].push(o):n=Math.min(n+1,3);const o=t[0],r=t[1],i=t[2],a=t[3],s=document.createElement("div");o.forEach(e=>s.appendChild(e.cloneNode(!0)));const c=s.querySelector('a[href*="viewtopic.php?id="]')||e.querySelector('a[href*="viewtopic.php?id="]'),{type:l,status:d,order:u,dateStart:p,dateEnd:m,title:f}=parseHeaderNew(o,r,c),{participants:g,masksLines:h}=parseParticipants(i),w=cleanLocation(textFromNodes(a)),y="au"===l?"":p||"",b="au"===l?"":m||y||"";return{type:l,status:d,title:f,href:c?.href||"",dateStart:y,dateEnd:b,order:Number.isFinite(u)?u:0,participants:g,masksLines:h,location:w}}function parseHeaderNew(e,t,n){const o=(n?.textContent||"").trim(),r=document.createElement("div");e.forEach(e=>r.appendChild(e.cloneNode(!0)));const i=(r.textContent||"").replace(/\s+/g," ").trim();let a="",s="",c=(r.querySelector("strong")?.textContent||"").trim();if(c){const e=c.replace(/[\u2012-\u2015\u2212—–−]/g,"-").replace(/\s*-\s*/g,"-").split("-").slice(0,2).map(e=>e.trim());a=e[0]||"",s=e[1]||""}else{const e=i.split(/\s[—–-]\s/)[0]?.trim()||"",t=parseDateFlexible(e);if(t&&t.hasDate){const e=e=>null!=e?.y?null!=e.d?`${String(e.d).padStart(2,"0")}.${String(e.m).padStart(2,"0")}.${e.y}`:null!=e.m?`${String(e.m).padStart(2,"0")}.${e.y}`:String(e.y):"";a=e(t.left),s=!t.right||t.right.y===t.left.y&&null==t.right.m&&null==t.right.d?"":e(t.right)}}/дата\s+не\s+указан/i.test(c||"")&&(a="",s="");let l="",d="",u=0;const p=textFromNodes(t).match(/\[([^\]]+)\]/);if(p){const e=p[1].split("/").map(e=>e.trim());if(l=(e[0]||"").toLowerCase(),d=(e[1]||"").toLowerCase(),e[2]){const t=parseInt(e[2],10);Number.isFinite(t)&&(u=t)}}return{type:l,status:d,order:u,dateStart:a,dateEnd:s,title:o}}function parseParticipants(e){const t=[];!function e(n){Array.from(n).forEach(n=>{3===n.nodeType?t.push({t:"text",v:n.nodeValue||""}):1===n.nodeType&&("A"===n.tagName?t.push({t:"link",name:(n.textContent||"").trim(),href:n.href||""}):e(n.childNodes))})}(e);const n=[],o=new Map;let r=null;for(const e of t){if("link"===e.t){const t=e.name;n.push({name:t,href:e.href}),r=t;continue}if("text"===e.t){let t=e.v||"";if(/\bне\s*указан/i.test(t))return{participants:[],masksLines:[]};t=t.replace(/\[\s*as\s*([^\]]+)\]/gi,(e,t)=>{const n=t.split(/\s*,\s*/).map(e=>e.trim()).filter(Boolean);var i,a;return a=n,(i=r)&&a&&a.length&&(o.has(i)||o.set(i,[]),o.get(i).push(...a)),""}),t.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{/^[–—-]+$/.test(e)||/^\[.*\]$/.test(e)||(n.push({name:e,href:""}),r=e)})}}const i=[];for(const e of n){const t=o.get(e.name);t&&t.length&&t.forEach(t=>i.push(`${e.name} — ${t}`))}return{participants:n,masksLines:i}}function cleanLocation(e){const t=String(e||"").trim();return t?/^локац/i.test(t)&&/не\s+указан/i.test(t)||/^не\s+указан/i.test(t)?"":t:""}async function collectEpisodesFromForums(e={}){async function t(e,t,n){const o=[],r=new Set;for(const i of t){const t=Promise.resolve().then(()=>n(i));o.push(t),r.add(t);const a=()=>r.delete(t);t.then(a,a),r.size>=e&&await Promise.race(r)}return Promise.all(o)}let n=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];if(!n.length){const e=new Set;document.querySelectorAll('a[href*="viewforum.php?id="]').forEach(t=>{const n=String(t.getAttribute("href")||"").match(/viewforum\.php\?id=(\d+)/i);n&&e.add(n[1])}),n=Array.from(e).map(e=>({id:e}))}if(!n.length)return console.warn("[collectEpisodesFromForums] Не удалось определить список разделов (sections)"),[];const o=(e,t)=>{try{return new URL(t,e).href}catch{return t}};const r=/[\u2012-\u2015\u2212—–−]/g,i=/[.\u2024\u2219\u00B7\u2027\u22C5·∙•]/g,a=e=>String(e).padStart(2,"0");function s(e){const t=Number(e);return Number.isFinite(t)?2===String(e).length?t>30?1900+t:2e3+t:t:null}function c(e,t){return new Date(e,t,0).getDate()}function l(e){const t=String(e||"").trim().replace(i,".");let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);if(n){const e=+n[1],t=+n[2],o=s(n[3]);return t<1||t>12||(e<1||e>c(o,t))?null:{y:o,m:t,d:e}}if(n=t.match(/^(\d{1,2})\.(\d{2}|\d{4})$/),n){const e=+n[1],t=s(n[2]);if(e>=1&&e<=12)return{y:t,m:e}}if(n=t.match(/^(\d{1,2})\.(\d{1,2})$/),n){const e=+n[1],t=+n[2];return t>=1&&t<=12&&e>=1&&e<=31?{m:t,d:e}:null}return n=t.match(/^(\d{2}|\d{4})$/),n?{y:s(n[1])}:null}function d(e){return null!=e.d?`${a(e.d)}.${a(e.m)}.${e.y}`:null!=e.m?`${a(e.m)}.${e.y}`:String(e.y)}function u(e){let t=String(e||"").trim();if(!t)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};t=t.replace(r,"-").replace(i,".").replace(/\s*-\s*/g,"-");const n=t.split("-").slice(0,2);if(1===n.length){const e=l(n[0]);if(!e||!e.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};const t=[e.y,e.m??0,e.d??0];return{hasDate:!0,display:d(e),startSort:t,endSort:t,left:e,right:e}}const o=n[0].trim(),u=n[1].trim(),p=l(u);if(!p||!p.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};let m=l(o);const f=o.match(/^\d{1,2}$/);if(f){const e=+f[0];m=null!=p.d&&null!=p.m?{y:p.y,m:p.m,d:e}:null!=p.m?{y:p.y,m:e}:{y:s(e)}}const g=/^\d{1,2}$/.test(o),h=/^\d{1,2}$/.test(u);if(g&&h&&m?.y&&p?.y&&null==m.m&&null==m.d&&null==p.m&&null==p.d&&m.y>p.y){const e=100*Math.floor(p.y/100),t=+o;m.y=e+t}m&&null==m.y&&null!=m.d&&null!=m.m&&p.y&&(m.y=p.y);const w=e=>null==e.d||e.y&&e.m&&e.d>=1&&e.d<=c(e.y,e.m);if(!w(m)||!w(p))return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};return{hasDate:!0,startSort:[m.y,m.m??0,m.d??0],endSort:[p.y??m.y,p.m??0,p.d??0],display:(y=m,b=p,null!=y.d&&null!=b.d?`${a(y.d)}.${a(y.m)}.${y.y}-${a(b.d)}.${b.m}.${b.y}`:null!=y.m&&null!=b.m?`${a(y.m)}.${y.y}-${a(b.m)}.${b.y}`:`${y.y}-${b.y}`),left:m,right:p};var y,b}function p(e,t){for(let n=0;n<3;n++){const o=(e[n]??0)-(t[n]??0);if(o)return o}return 0}async function m(n,r){let i=o(location.href,`/viewforum.php?id=${n.id}`);const a=new Set,s=[];let c=0;const l=new Set;let d="";for(;i&&!a.has(i)&&c<100;){c++,a.add(i);const u=await FMV.fetchDoc(i),p=new Map;u.querySelectorAll('a[href*="viewtopic.php?id="]').forEach(e=>{const t=o(i,e.getAttribute("href")),n=t.match(/viewtopic\.php\?id=(\d+)/i),r=((a=e)&&(a.innerText??a.textContent)||"").trim();var a;n&&(/^\s*(RSS|Atom)\s*$/i.test(r)||/#p\d+$/i.test(t)||/^\d{1,2}\.\d{1,2}\.\d{2,4}(?:\s+\d{1,2}:\d{2})?$/.test(r)||p.set(n[1],{url:t,title:r}))});const m=Array.from(p.keys()).sort(),g=m.join(",");if(g&&g===d)break;d=g;const h=m.filter(e=>!l.has(e));if(0===h.length)break;h.forEach(e=>l.add(e));const w=Number.isFinite(+e?.concurrencyPerPage)?+e.concurrencyPerPage:6,y=Array.from(p.entries()),b=await t(w,y,async([e,{url:t,title:o}])=>{const i=e?`id:${e}`:`url:${t.replace(/#.*$/,"")}`;if(r.has(i))return null;const a=await f(t,o,n.type,n.status);return a?{key:i,row:a}:null});for(const e of b)e&&(r.add(e.key),s.push(e.row));const v=function(e){const t=e.querySelector('a[rel="next"], a[href*="&p="]:not([rel="prev"])');return t?t.getAttribute("href"):null}(u),S=v?o(i,v):null;if(!S||a.has(S)){i=null;break}i=S}return s}async function f(e,t,n,o){try{const r=await FMV.fetchDoc(e),i=r.querySelector(".post.topicpost .post-content")||r.querySelector(".post.topicpost")||r,a=function(e){const t=(e.querySelector("title")?.textContent||"").trim();if(/\[.+\]\s+.+/.test(t))return t;const n=e.querySelector(".crumbs, .crumbs-nav, #pun-crumbs1 .crumbs, #pun-crumbs1");if(n){const e=(n.textContent||"").replace(/\s+/g," ").trim(),t=e.split("»").pop()?.trim()||"";if(t)return t}const o=e.querySelector('a[href*="viewtopic.php?id="]');return(o?.textContent||"").trim()}(r),s=t||a||"",{dateRaw:c,episode:l}=function(e){const t=String(e||"").trim(),n=t.match(/^\s*\[(.*?)\]\s*(.*)$/s);if(n){const e=(n[1]||"").trim(),t=(n[2]||"").trim(),o=u(e);if(o&&o.hasDate)return{dateRaw:e,episode:t.replace(/\s+/g," ")}}return{dateRaw:"",episode:t.replace(/\s+/g," ")}}(s),p=u(c),m=function(e,t,n){const o=String(t||"").trim();let r=!0;if("plot"===e){const e=/\s\[\s*(?:c|с)\s*\]$/i,t=e.test(o);return r=!!n&&t,{title:t?o.replace(e,"").trim():o,ok:r}}if("au"===e){const e=/^(?:\[\s*au\s*\]\s+|\[\s*AU\s*\]\s+)/,t=e.test(o);return r=t,{title:t?o.replace(e,"").trim():o,ok:r}}return{title:o,ok:r}}(n,l||"",p.hasDate),f=FMV.readTagText(i,"characters"),g=FMV.readTagText(i,"location"),h=FMV.readTagText(i,"order"),w=await FMV.buildIdToNameMapFromTags(f),y=FMV.parseCharactersUnified(f,w,window.profileLink),b=y.ok?y.participantsLower:[],v=y.ok?y.masksByCharLower:new Map,S=FMV.parseOrderStrict(h).ok?FMV.parseOrderStrict(h).value:0,_=g?g.split(/\s*[,;]\s*/).map(e=>e.trim().toLowerCase()).filter(Boolean):[],k=b.map(e=>{const t=Array.from(v.get(e)||[]),n=/^user(\d+)$/i.exec(String(e));if(n){const e=n[1];return w&&w.has(e)?{id:e,name:w.get(e),masks:t}:{name:`user${e}`,masks:t}}return{name:String(e),masks:t}}),x=p.hasDate?null!=p.left?.d||null!=p.left?.m?d(p.left):String(p.left?.y??""):"";return{dateStart:x,dateEnd:p.hasDate?null!=p.right?.d||null!=p.right?.m?d(p.right):String(p.right?.y??p.left?.y??""):x||"",title:m.title||"",href:e,type:n,status:o,order:Number(S)||0,location:_.join(", "),participants:k,isTitleNormalized:m.ok,__hasDate:p.hasDate,__startSort:p.startSort,__endSort:p.endSort}}catch{return null}}const g=new Set;let h=[];for(const e of n){const t=await m(e,g);h=h.concat(t)}return h=h.filter(Boolean).sort(function(e,t){const n=!!e.__hasDate;if(n!==!!t.__hasDate)return n?-1:1;if(n){const n=p(e.__startSort,t.__startSort);if(n)return n;const o=p(e.__endSort,t.__endSort);if(o)return o}const o=e.order??0,r=t.order??0;return o!==r?o-r:String(e.title||"").toLowerCase().localeCompare(String(t.title||"").toLowerCase(),"ru",{sensitivity:"base"})}),h.forEach(e=>{delete e.__hasDate,delete e.__startSort,delete e.__endSort}),h}async function collectChronoByUser(e={}){if("function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");let t=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];const n=Number.isFinite(+e.maxPagesPerSection)?+e.maxPagesPerSection:void 0,o=await collectEpisodesFromForums({sections:t,maxPagesPerSection:n}),r=Object.create(null);o.forEach((e,t)=>{Number.isFinite(e.order)||(e.order=t)});for(const e of o){const t=(e.participants||[]).map(e=>{const t=e?.id?String(e.id).trim():"";return t?{id:t,name:(e.name||"").trim(),masks:Array.isArray(e.masks)?e.masks.slice():[]}:null}).filter(Boolean);for(const n of t){const o=t.filter(e=>e!==n).map(e=>({id:e.id,name:e.name,masks:e.masks.slice()})),i={dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",order:Number(e.order||0),location:e.location||"",masks:n.masks||[],participants:o,isTitleNormalized:!!e.isTitleNormalized};r[n.id]||(r[n.id]={name:n.name||"",episodes:[]}),r[n.id].episodes.push(i)}}return r}(async()=>{console.log("[skin_data] Начало загрузки данных скинов"),console.log("[skin_data] window.SKIN:",window.SKIN);const e=await collectSkinSets();console.log("[skin_data] collectSkinSets вернул:",e);const t=e?.icons||[],n=e?.plashki||[],o=e?.backs||[];console.log("[skin_data] icons:",t.length,"plashki:",n.length,"backs:",o.length),window.SKIN?.PlashkaFieldID?(console.log("[skin_data] Применяем плашку, fieldID:",window.SKIN.PlashkaFieldID),applyImagePicker(n,SKIN.PlashkaFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0})):console.log("[skin_data] PlashkaFieldID не найден"),window.SKIN?.BackFieldID?(console.log("[skin_data] Применяем фон, fieldID:",window.SKIN.BackFieldID),applyImagePicker(o,SKIN.BackFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0})):console.log("[skin_data] BackFieldID не найден"),window.SKIN?.IconFieldID?(console.log("[skin_data] Применяем иконку, fieldID:",window.SKIN.IconFieldID),applyImagePicker(t,SKIN.IconFieldID,{btnWidth:44})):console.log("[skin_data] IconFieldID не найден"),console.log("[skin_data] Завершено")})(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-bank-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-bank-link",t.innerHTML='\n      <span>Банковская операция:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePosts)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserLogin)return void t(e,"нет данных пользователя");const n=window.FORUMS_IDS?.Bank||[0];try{const o=await window.scrapePosts(window.UserLogin,n,{title_prefix:"Гринготтс",stopOnNthPost:1,keywords:"ИТОГО"});if(Array.isArray(o)&&o.length&&o[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t){e.classList.remove("is-empty"),e.href=t,e.textContent="Последняя"}(e,`${t}/viewtopic.php?${o[0].src}`,o[0].date_text||o[0].text)}else t(e)}catch(n){console.error("[bank_last_comment] scrapePosts failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-lastpost-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-lastpost-link",t.innerHTML='\n      <span>Последний пост:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePosts)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserLogin)return void t(e,"нет данных пользователя");const n=[...window.FORUMS_IDS?.PersonalPosts||[1e4],...window.FORUMS_IDS?.PlotPosts||[1e4]];try{const o=await window.scrapePosts(window.UserLogin,n,{stopOnNthPost:1,comments_only:!0});if(Array.isArray(o)&&o.length&&o[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t,n){e.classList.remove("is-empty"),e.href=t,e.textContent=n||"Последняя"}(e,`${t}/viewtopic.php?${o[0].src}`,o[0].date_text||"Последний пост")}else t(e)}catch(n){console.error("[post_last_comment] scrapePosts failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),(()=>{"use strict";"function"!=typeof window.extractErrorMessage&&(window.extractErrorMessage=()=>""),"function"!=typeof window.extractInfoMessage&&(window.extractInfoMessage=()=>""),"function"!=typeof window.classifyResult&&(window.classifyResult=()=>"unknown"),window.FMV=window.FMV||{},window.FMV.replaceComment=async function(e,t,n){const o="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():null,r=new Set((e||[]).map(e=>String(Number(e))));if(!o||!r.has(String(Number(o))))return{ok:!1,status:"forbidden",postId:String(t),newText:n,errorMessage:"Нет доступа по группе"};const i=parseInt(t,10);if(!Number.isFinite(i))return{ok:!1,status:"badid",postId:String(t),newText:n,errorMessage:`Некорректный postId: ${t}`};const a=String(i),s=`/edit.php?id=${encodeURIComponent(a)}&action=edit`;try{let e,t,o,r="";try{e=await fetchCP1251Doc(s),r=e.documentElement?e.documentElement.outerHTML:"",o=e.querySelector('textarea#main-reply[name="req_message"], textarea[name="req_message"]'),o&&(t=o.closest("form"))}catch(e){return{ok:!1,status:"transport",postId:a,newText:n,errorMessage:e?.message||String(e)}}if(!t||!o){const e=extractInfoMessage(r)||"",t=extractErrorMessage(r)||"";return{ok:!1,status:classifyResult(r)||"noform",postId:a,newText:n,infoMessage:e,errorMessage:t}}const i=String(o.value||"").trim();o.value=n;const c=[...t.elements].find(e=>"submit"===e.type&&(e.name||/Отправ|Сохран|Submit|Save/i.test(e.value||"")))?.name||"submit",l=serializeFormCP1251_SelectSubmit(t,c),{res:d,text:u}=await fetchCP1251Text(s,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l,referrer:s,referrerPolicy:"strict-origin-when-cross-origin"}),p=extractInfoMessage(u)||"",m=extractErrorMessage(u)||"",f=classifyResult(u);let g="string"==typeof f?f:f&&(f.status||f.code)?String(f.status||f.code):"unknown";return!d.ok||"unknown"!==g&&""!==g||(g="ok"),d.ok&&"ok"===g?{ok:!0,status:"ok",postId:a,oldText:i,newText:n,httpStatus:d.status}:{ok:!1,status:g,postId:a,oldText:i,newText:n,httpStatus:d.status,infoMessage:p.slice(0,200),errorMessage:m.slice(0,200)}}catch(e){return{ok:!1,status:"transport",postId:String(t),newText:n,errorMessage:e?.message||String(e)}}}})(),function(){"use strict";window.checkChronoFields=function(e=[]){const t=window.CHRONO_CHECK;return!(!t||"object"!=typeof t)&&(!Array.isArray(e)||!e.length||e.every(e=>{const n=t[e];return null!=n&&(Array.isArray(n)?n.length>0:"string"==typeof n?""!==n.trim():"number"==typeof n?Number.isFinite(n):"object"!=typeof n||Object.keys(n).length>0)}))}}(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_update_total] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),o=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),r=new URL(`/viewtopic.php?id=${n}#p${o}`,location.href).href,i=window.CHRONO_CHECK.ForumInfo;let a=!1;function s(e="",t=200){const n=String(e).replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"…":n}createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить общее хроно",order:1,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть ссылку",linkHref:r,async onClick(t){if(a)return;a=!0;const n=t?.setStatus||(()=>{}),c=t?.setDetails||(()=>{});t?.setLinkVisible?.(!1),t?.setLink?.("","");try{if(n("Собираю…"),c(""),"function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");const a=await collectEpisodesFromForums({sections:i});n("Формирую текст…");const d=function(e){const t=(e||[]).map(e=>{const t=renderStatus(e.type,e.status),n="au"===e.type?"":e.dateStart?`[b]${FMV.escapeHtml(e.dateEnd&&e.dateEnd!==e.dateStart?`${e.dateStart}-${e.dateEnd}`:e.dateStart)}[/b]`:"[mark]дата не указана[/mark]",o=FMV.escapeHtml(e.href||""),r=FMV.escapeHtml(e.title||""),i=e.isTitleNormalized?"":"au"===e.type?" [mark]в названии нет [au][/mark]":" [mark]в названии нет [с][/mark]",a=`${FMV.escapeHtml(String(e.order??0))}`,s=!0;return`${n}${n?" — ":" "}[url=${o}]${r}[/url]${i}\n[${t} / ${a}]\n[i]${Array.isArray(e.participants)&&e.participants.length?e.participants.map(e=>{const t=null!=e.id&&""!==e.id?userLink(String(e.id),e.name,s):missingUser(String(e.name||""),s),n=Array.isArray(e.masks)?e.masks:[];return`${t}${n.length?` [as ${FMV.escapeHtml(n.join(", "))}]`:""}`}).join(", "):"[mark]не указаны[/mark]"}[/i]\n${e.location?FMV.escapeHtml(e.location):"[mark]локация не указана[/mark]"}\n\n`});return`[media="Общая хронология"]${t.join("")||""}[/media]`}(a);n("Записываю…");const u=FMV.toCp1251Entities(d),p=await FMV.replaceComment(e,o,u),m=null==(l=p.status)?"":"string"==typeof l?l:String("object"==typeof l?l.status||l.code||(l.ok?"ok":"unknown"):l),f=!!p.ok||"ok"===m;n(f?"Готово":"Ошибка"),f?(t?.setLink?.(r,"Открыть ссылку"),t?.setLinkVisible?.(!0)):(t?.setLink?.("",""),t?.setLinkVisible?.(!1));const g=s(p.infoMessage||""),h=s(p.errorMessage||""),w=[`Статус: ${f?"ok":m||"unknown"}`];g&&w.push(g),h&&w.push(`<span style="color:#b00020">${FMV.escapeHtml(h)}</span>`),c(w.join("<br>"))}catch(e){n("✖ ошибка","red"),c(FMV.escapeHtmlShort(e?.message||String(e))),t?.setLinkVisible?.(!1),t?.setLink?.("","")}finally{a=!1}var l}}),"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`)})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_total_to_excel] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),o=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),r=new URL(`/viewtopic.php?id=${n}#p${o}`,location.href).href,i=(window.SITE_URL||location.origin).replace(/\/+$/,""),a=window.CHRONO_CHECK.ForumInfo;let s="";createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"выгрузить общее хроно в excel",order:2,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Скачать",linkHref:"",async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{}),o=e?.setLink||(()=>{});e?.setLink?.("","");try{t("Собираю…"),n("");const p=await collectEpisodesFromForums({sections:a});if(!p.length)throw new Error("Эпизоды не найдены.");const g=p.map(e=>{const t=(e.participants||[]).map(e=>{const t=String(e.name||"").trim();if(!t)return"";if(null!=e.id&&""!==e.id){return`${t} — ${`${i}/profile.php?id=${encodeURIComponent(String(e.id))}`}`}return t}).filter(Boolean).join("\n"),n=(e.participants||[]).flatMap(e=>{const t=Array.isArray(e.masks)?e.masks.filter(Boolean):[],n=String(e.name||"").trim()||(null!=e.id?`user${e.id}`:"");return t.map(e=>`${n} — ${e}`)}).filter(Boolean);return{type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",order:Number(e.order||0)||0,participantsText:t,masksLines:n,location:e.location||""}});t("Формирую файл…");const{blob:h,filename:b}=function(e){const t=[],n=(e,n)=>t.push({name:e,data:c(n)}),o='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n</Relationships>',r='<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"\n          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n  <sheets>\n    <sheet name="Хронология" sheetId="1" r:id="rId1"/>\n  </sheets>\n</workbook>';n("[Content_Types].xml",'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml"  ContentType="application/xml"/>\n  <Override PartName="/xl/workbook.xml"          ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>\n  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n</Types>'),n("_rels/.rels",'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n</Relationships>'),n("xl/workbook.xml",r),n("xl/_rels/workbook.xml.rels",o),n("xl/worksheets/sheet1.xml",function(e){const t=`<row r="1">${["Тип","Статус","Тема","Дата начала","Дата конца","Порядок","Участники","Маски","Локация"].map(w).join("")}</row>`,n=e.map((e,t)=>`<row r="${t+2}">${[w(e.type||""),w(e.status||""),v(e.href||"",e.title||e.href||""),w(e.dateStart||""),w(e.dateEnd||e.dateStart||""),y(e.order||0),w(e.participantsText||""),w((e.masksLines||[]).join("\n")),w(e.location||"")].join("")}</row>`).join("");return`<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n  <sheetData>${t}${n}</sheetData>\n</worksheet>`}(e));const i=function(e){const t=f(),n=[],o=[];let r=0;e.forEach(e=>{const i=c(e.name),a=e.data,s=m(a),p=u([d(67324752),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(a.length),d(a.length),l(i.length),l(0),i,a]),f=u([d(33639248),l(20),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(a.length),d(a.length),l(i.length),l(0),l(0),l(0),l(0),d(0),d(r),i]);n.push(p),o.push(f),r+=p.length});const i=u(o),a=n.reduce((e,t)=>e+t.length,0),s=i.length,p=u([d(101010256),l(0),l(0),l(e.length),l(e.length),d(s),d(a),l(0)]);return new Blob([u([...n,i,p])],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}(t),a=`chronology_${(new Date).toISOString().slice(0,10)}.xlsx`;return{blob:i,filename:a}}(g);if(s)try{URL.revokeObjectURL(s)}catch{}s=URL.createObjectURL(h),t("✓ готово","green"),n(`Строк: ${g.length}\nИсточник: ${FMV.escapeHtml(r)}\nФайл: ${FMV.escapeHtml(b)}`),o(s,"Скачать");const S=e?.wrap?.querySelector("a.fmv-action-link");S&&S.setAttribute("download",b)}catch(o){t("✖ ошибка","red"),n(FMV.escapeHtmlShort(o?.message||String(o))),e?.setLink?.("","")}}});const c=e=>(new TextEncoder).encode(e),l=e=>new Uint8Array([255&e,e>>>8&255]),d=e=>new Uint8Array([255&e,e>>>8&255,e>>>16&255,e>>>24&255]),u=e=>{let t=0;e.forEach(e=>t+=e.length);const n=new Uint8Array(t);let o=0;return e.forEach(e=>{n.set(e,o),o+=e.length}),n},p=(()=>{let e,t=new Uint32Array(256);for(let n=0;n<256;n++){e=n;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e>>>0}return t})(),m=e=>{let t=~0;for(let n=0;n<e.length;n++)t=t>>>8^p[255&(t^e[n])];return(-1^t)>>>0},f=(e=new Date)=>({time:(31&e.getHours())<<11|(63&e.getMinutes())<<5|31&Math.floor(e.getSeconds()/2),date:(e.getFullYear()-1980&127)<<9|(e.getMonth()+1&15)<<5|31&e.getDate()}),g=e=>String(e||"").replace(/[<>&"]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e])),h=e=>String(e||"").replace(/"/g,'""');function w(e){return`<c t="inlineStr"><is><t xml:space="preserve">${g(e).replace(/\r?\n/g,"&#10;")}</t></is></c>`}function y(e){return`<c><v>${Number(e)||0}</v></c>`}function b(e){return`<c><f>${g(e)}</f></c>`}function v(e,t){return e&&t?b(`HYPERLINK("${h(e)}","${h(t)}")`):e&&!t?b(`HYPERLINK("${h(e)}","${h(e)}")`):w(t||"")}})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","PerPersonChronoPostID","ForumInfo"]))return void console.warn("[button_update_per_user] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, PerPersonChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),o=String(window.CHRONO_CHECK.PerPersonChronoPostID).trim(),r=(window.SITE_URL||location.origin).replace(/\/+$/,""),i=window.CHRONO_CHECK.ForumInfo;"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`);const a=e=>String(e||"").trim();function s(e){const t=function(e,t){const n=a(e),o=a(t);return n||o?o&&o!==n?`[b]${n}-${o}[/b]`:`[b]${n}[/b]`:""}(e.dateStart,e.dateEnd),n=`[url=${FMV.escapeHtml(a(e.href))}]${FMV.escapeHtml(a(e.title)||a(e.href))}[/url]`,o=Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:"",r=t?`${t} — ${n}${o}`:`${n}${o}`,i=`[${renderStatus(e.type,e.status)} / ${`${FMV.escapeHtml(String(e.order??0))}`}]`,s=function(e=[]){return e.length?`[i]${e.map(e=>{const t=!0;return`${null!=e.id&&""!==String(e.id)?userLink(String(e.id),e.name,t):missingUser(String(e.name||""),t)}${Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:""}`}).join(", ")}[/i]`:""}(e.participants||[]),c=[r,i];return s&&c.push(s),a(e.location)&&c.push(FMV.escapeHtml(a(e.location))),c.join("\n")}const c=`${r}/viewtopic.php?id=${n}#p${o}`;createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить хроно по персам",order:3,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть пост",linkHref:c,async onClick(t){const l=t?.setStatus||(()=>{}),d=t?.setDetails||(()=>{}),u=t?.setLink||(()=>{}),p=t?.setLinkVisible||(()=>{});u("",""),p?.(!1);try{l("Собираю…"),d("");const t=await(window.collectChronoByUser?window.collectChronoByUser({sections:i}):Promise.reject(new Error("collectChronoByUser недоступна"))),m=Object.entries(t||{}).map(([e,t])=>({id:e,name:t?.name||"",episodes:Array.isArray(t?.episodes)?t.episodes:[]})).filter(e=>e.name).sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));if(!m.length)return l("Пусто"),void d("Нет данных для вывода.");l("Формирую текст…");const f=m.map(e=>function(e,t=[]){return`[media="[url=${r}/viewtopic.php?id=${n}]${FMV.escapeHtml(a(e))}[/url]"]\n${t.map(s).join("\n\n")}\n[/media]`}(e.name,e.episodes)).join("\n\n"),g=`[media="Хронология по персонажам"]\n${f}\n[/media]`;l("Записываю…");const h=FMV.toCp1251Entities(g),w=await FMV.replaceComment(e,o,h),y=String(w?.status||""),b=!!w?.ok||"ok"===y;l(b?"Готово":"Ошибка"),b?(u(c,"Открыть пост"),p?.(!0)):(u("",""),p?.(!1));const v=(w?.infoMessage||"").replace(/<[^>]*>/g," ").trim(),S=(w?.errorMessage||"").replace(/<[^>]*>/g," ").trim(),_=[`Статус: ${b?"ok":y||"unknown"}`];v&&_.push(v),S&&_.push(S),d(_.join("<br>"))}catch(e){l("✖ ошибка","red"),d(e?.message||String(e)),u("",""),p?.(!1)}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","ForumInfo"]))return void console.warn("[button_update_chrono_api] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),o=window.CHRONO_CHECK.ForumInfo;function r(e){const t=e.split(".").reduce((e,t)=>e&&e[t],window);if("function"!=typeof t)throw new Error(`${e} не найден — подключите соответствующий скрипт`);return t}async function i(e,t){const n=r("FMVbank.storageGet"),o=r("FMVbank.storageSet"),i=String(e);if(!t||"object"!=typeof t)return{id:i,status:"нет данных для сохранения"};try{const e=await n(Number(i),"chrono_"),r=e&&"object"==typeof e?e:{};r.chrono=t,r.last_timestamp=Math.floor(Date.now()/1e3);const a=function(e){return!0===e?"сохранено":!1===e?"ошибка сохранения":String(e)}(await o(r,Number(i),"chrono_"));return{id:i,status:a}}catch(e){return{id:i,status:`ошибка сохранения: ${e?.message||e}`}}}function a(e){const t=String(e||"").toLowerCase();return t.includes("ошибка сохранения")?"ошибка сохранения":t.includes("нет данных")||t.includes("не найден")?"пользователь не упоминается в хронологии":""}window.FMV||(window.FMV={}),"function"!=typeof window.userLinkHtml&&(window.userLinkHtml=(e,t)=>`${FMV.escapeHtml(String(t||e))}`),createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"Сохранить хронологию в API",order:5,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{});n("");try{t("Собираю…");const e=Array.isArray(window.CHRONO_CHECK?.UserIDs)?window.CHRONO_CHECK.UserIDs:void 0,s=await async function(e){const t=window.FMV&&"function"==typeof FMV.fetchUsers?FMV.fetchUsers:null;let n=[];if(Array.isArray(e)&&e.length)n=e.map(e=>({id:String(e)}));else if(t)try{const e=await t();n=Array.isArray(e)?e:[]}catch{}const o=new Map;for(const e of n){if(!e)continue;const t=String(e.id??""),n=String(e.name??"").trim();t&&o.set(t,n||t)}return o}(e);t("Сохраняю…");const c=await async function(e={}){const t=Number.isFinite(e.delayMs)?e.delayMs:200,n=r("collectChronoByUser"),o=e.sections;let a,s;try{a=await n({sections:o})}catch(e){throw new Error(`Ошибка collectChronoByUser: ${e?.message||e}`)}if(!a||"object"!=typeof a)throw new Error("collectChronoByUser вернул пустой результат");s=Array.isArray(e.ids)&&e.ids.length?e.ids.map(e=>({id:String(e)})):Object.keys(a).map(e=>({id:String(e)}));const c=[];for(const e of s){const n=a[e.id];if(!n){c.push({id:e.id,status:"нет данных (пользователь не найден в хроно-коллекции)"});continue}const o=await i(e.id,n);c.push(o),t&&await FMV.sleep(t)}try{console.table(c.map(e=>({id:e.id,status:e.status})))}catch{}return c}({ids:e,sections:o}),l=[];for(const e of c||[]){const t=a(e?.status);if(!t)continue;const n=String(e?.id||""),o=s.get(n)||n;l.push(`${userLinkHtml(n,o)} — ${FMV.escapeHtml(t)}`)}t("✓ готово","green"),n(l.length?l.join("<br>"):"")}catch(e){t("✖ ошибка","red"),n(e?.message||String(e))}}})})(),function(){"use strict";var e;window.FMV||(window.FMV={}),window.FMV.fetchUsers||console.warn("[FMV] Подключите общий модуль с FMV.fetchUsers до ui.js"),window.FMV.UI||function(){function e(e){const t=String(e||"").match(/\[FMVcast\]([\s\S]*?)\[\/FMVcast\]/i),n=t&&t[1]?(o=t[1],String(o||"").split(";").map(e=>e.trim()).filter(Boolean)):[];var o;const r={};return n.forEach(e=>{const t=e.match(/^(user\d+)(?:=(.+))?$/i);if(!t)return;const n=t[1],o=(t[2]||"").trim(),i=r[n]||(r[n]={code:n,masks:[]});o&&i.masks.push(o)}),r}function t(e){const t=[];return(e||[]).forEach(e=>{const n=Array.isArray(e.masks)?e.masks.filter(Boolean):[];n.length?n.forEach(n=>t.push(e.code+"="+n)):t.push(e.code)}),t.length?"[FMVcast]"+t.join(";")+"[/FMVcast]":""}function n(e){return(e=String(e||"").trim())?"[FMVplace]"+e+"[/FMVplace]":""}function o(e){let t=parseInt(String(e||"").trim(),10);return Number.isNaN(t)&&(t=0),"[FMVord]"+t+"[/FMVord]"}function r(e){return String(e||"").replace(/\[FMVcast\][\s\S]*?\[\/FMVcast\]/gi,"").replace(/\[FMVplace\][\s\S]*?\[\/FMVplace\]/gi,"").replace(/\[FMVord\][\s\S]*?\[\/FMVord\]/gi,"").replace(/^\s+|\s+$/g,"")}let i=!1;window.FMV.UI={attach:function(a){!function(){if(i)return;i=!0;const e=document.createElement("style");e.textContent="\n        :root{\n          --fmv-bg:#f7f4ea; --fmv-b:#d8d1c3; --fmv-chip:#fff;\n          --fmv-radius:10px; --fmv-gap:8px; --fmv-text:#2d2a26; --fmv-muted:#6b6359;\n        }\n\n        .msg-with-characters.fmv,\n        .msg-with-characters.fmv * { box-sizing: border-box; }\n        .msg-with-characters.fmv { width:100%; max-width:100%; overflow-x:hidden; }\n\n        .msg-with-characters.fmv{margin:10px 0; padding:10px; border:1px solid var(--fmv-b); background:var(--fmv-bg); border-radius:var(--fmv-radius)}\n        .fmv .char-row{display:flex; gap:var(--fmv-gap); align-items:flex-start; flex-wrap:wrap}\n        .fmv .combo{position:relative; flex:1 1 480px; width:100%; max-width:100%}\n        .fmv .combo input,\n        .fmv .place-row input,\n        .fmv .order-row input{\n          width:100%; max-width:100%; height:36px;\n          padding:8px 10px; border:1px solid var(--fmv-b); border-radius:8px;\n          background:#efe9dc; color:var(--fmv-text); font-size:14px;\n        }\n        .fmv .place-row,.fmv .order-row{margin-top:8px; width:100%; max-width:100%}\n        .fmv .order-row label{display:block; margin-bottom:4px; font-weight:600; color:var(--fmv-text)}\n        .fmv .order-hint,.fmv .hint{font-size:12.5px; color:var(--fmv-muted); margin-top:4px; overflow-wrap:anywhere}\n\n        .fmv .ac-list{\n          position:absolute; z-index:50; left:0; right:0; max-width:100%; background:#fff;\n          border:1px solid var(--fmv-b); border-radius:8px; margin-top:4px; max-height:240px; overflow:auto\n        }\n        .fmv .ac-item{padding:.45em .65em; cursor:pointer; font-size:14px}\n        .fmv .ac-item.active,.fmv .ac-item:hover{background:#f0efe9}\n        .fmv .ac-item .muted{color:var(--fmv-muted)}\n\n        .fmv .chips{ max-width:100%; overflow-x:hidden; }\n        .fmv .chips .chip{\n          display:flex; align-items:center; justify-content:flex-start;\n          gap:10px; padding:.45em .6em; background:var(--fmv-chip);\n          border:1px solid var(--fmv-b); border-radius:8px; margin:.35em 0; font-size:14px\n        }\n        .fmv .chip .drag{cursor:grab; margin-right:.4em; color:#8b8378}\n        .fmv .chip .name{font-weight:600}\n\n        .fmv .masks{display:flex; align-items:center; gap:6px; flex-wrap:wrap; color:var(--fmv-muted)}\n        .fmv .masks .masks-label{ color:var(--fmv-muted); margin-right:2px; }\n        .fmv .mask-badge{\n          display:inline-flex; align-items:center; gap:6px;\n          padding:2px 8px; border:1px solid var(--fmv-b); border-radius:999px;\n          background:#efe9dc; font-size:13px; color:var(--fmv-text);\n        }\n        .fmv .mask-badge .mask-remove{\n          border:0; background:none; cursor:pointer; line-height:1;\n          color:#8b8378; font-size:14px; padding:0 2px;\n        }\n\n        .fmv .chip .add-mask{border:0; background:none; color:#2e5aac; cursor:pointer; padding:0; text-decoration:underline; margin-left:auto}\n        .fmv .chip .x{border:0; background:none; font-size:16px; line-height:1; cursor:pointer; color:#8b8378; margin-left:8px}\n\n        .fmv .chip .mask-input{ display:none; margin-left:auto; }\n        .fmv .chip .mask-input.is-open{ display:flex; align-items:center; gap:8px; }\n        .fmv .chip .mask-input input{\n          flex:1; min-width:220px; height:30px;\n          padding:6px 8px; border:1px solid var(--fmv-b); border-radius:6px;\n          background:#efe9dc; color:var(--fmv-text);\n        }\n        .fmv .chip .btn{ border:1px solid var(--fmv-b); border-radius:6px; background:#fff; padding:6px 10px; cursor:pointer; line-height:1; }\n        .fmv .chip .btn-ok{ background:#e9f6e9; }\n        .fmv .chip .btn-cancel{ background:#f4eeee; }\n\n        .fmv-admin-tools{display:flex;justify-content:flex-end;margin:6px 0 8px}\n        .fmv-admin-tools .fmv-toggle{border:1px solid var(--fmv-b);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}\n\n        /* заголовок блока */\n        .fmv .section-title{\n          font-weight:700;\n          font-size:14px;\n          text-align: center;\n          line-height:1.25;\n          margin:4px 0 12px;\n          color: var(--fmv-text);\n        }\n\n        /* делаем «колонку» с равным шагом и без внутренних margin */\n        .fmv .combo,\n        .fmv .place-row,\n        .fmv .order-row {\n          display: grid;\n          grid-template-columns: 1fr;\n          row-gap: 8px;             /* вот этим управляем расстоянием между label ↔ input ↔ hint */\n        }\n        \n        .fmv .place-row label,\n        .fmv .order-row label,\n        .fmv .combo label,\n        .fmv .place-row .hint,\n        .fmv .order-row .order-hint,\n        .fmv .combo .hint {\n          margin: 0;                /* убираем наследованные отступы, чтобы они не «схлопывались» */\n        }\n        \n        /* (оставляем общий верхний зазор секции) */\n        .fmv .place-row, .fmv .order-row { margin-top: 8px; }\n\n        .fmv .chip .name { font-weight: 600; }\n        .fmv .chip .name .name-code { font-weight: 400; color: var(--fmv-muted); }\n\n        ",document.head.appendChild(e)}();const s="string"==typeof a.form?$(a.form):a.form,c="string"==typeof a.textarea?$(a.textarea):a.textarea;if(!s?.length||!c?.length)return null;const l=c.val()||"",d=/\[FMV(?:cast|place|ord)\][\s\S]*?\[\/FMV(?:cast|place|ord)\]/i.test(l);if(a.showOnlyIfFMVcast&&!d)return null;if(a.stripOnMount&&c.val(r(l)),s.data("fmvBoundUI"))return s.data("fmvBoundUI");const u="msg-with-characters fmv "+(a.className||""),p=$("<div/>",{class:u}),m=$('<div class="section-title">Для автоматического сбора хронологии</div>'),f=$('<div class="char-row"/>'),g=$('<div class="combo"/>'),h=$('<label for="character-combo" style="font-weight:600;display:block;margin-bottom:4px">Участники эпизода:</label>'),w=$('<input type="text" id="character-combo" placeholder="Наберите имя персонажа…" autocomplete="off">'),y=$('<div class="ac-list" role="listbox" aria-label="Варианты персонажей"></div>'),b=$('<div class="hint">Если что-то не работает, напишите в Приемную.</div>');g.append(h,w,y,b),f.append(g);const v=$('<div class="chips"/>'),S=$('<div class="place-row"/>'),_=$('<label for="fmv-place" style="font-weight:600">Локация:</label>'),k=$('<input type="text" id="fmv-place" placeholder="Укажите локацию">'),x=$('<div class="hint">Лучше указывать в едином формате: Хогвартс, Косой переулок, Лютный переулок, Министерство и т.д.</div>');S.append(_,k,x);const C=$('<div class="order-row"/>'),E=$('<label for="fmv-ord" style="font-weight:600">Для сортировки эпизодов в один день</label>'),F=$('<input type="number" id="fmv-ord" placeholder="0" value="0" step="1">'),I=$('<div class="order-hint">Помогает упорядочить эпизоды, которые стоят в один день. Чем больше значение, тем позже эпизод. Лучше оставлять 0.</div>');C.append(E,F,I),c.before(p),p.append(m,f,v,S,C);let M=[],L=[];function D(){v.empty(),M.forEach(function(e,t){const n=$('<div class="chip" draggable="true" data-idx="'+t+'"/>');n.append('<span class="drag" title="Перетащите для изменения порядка">↕</span>');const o=$('<span class="name"/>');o.append(document.createTextNode(e.name+" ")),o.append($('<span class="name-code"/>').text("("+e.code+")")),n.append(o);const r=$('<span class="masks"/>');e.masks?.length?(r.append('<span class="masks-label">— маски:</span>'),e.masks.forEach(function(e,t){const n=$('<span class="mask-badge" data-mi="'+t+'"><span class="mask-text"></span><button type="button" class="mask-remove" aria-label="Удалить маску">×</button></span>');n.find(".mask-text").text(e),r.append(n)})):r.text(" — масок нет");const i=$('<button class="add-mask" type="button">добавить маску</button>'),a=$('<button class="x" type="button" aria-label="Удалить">×</button>'),s=$('<span class="mask-input"></span>').hide(),c=$('<input type="text" placeholder="маска (текст)">'),l=$('<button type="button" class="btn btn-ok">Ок</button>'),d=$('<button type="button" class="btn btn-cancel">Отмена</button>');s.append(c,l,d),c.on("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),l.click())}),i.on("click",()=>{n.find(".mask-input").removeClass("is-open").hide(),s.addClass("is-open").show(),c.val("").focus()}),l.on("click",()=>{const t=$.trim(c.val());t&&((e.masks||(e.masks=[])).push(t),D())}),d.on("click",()=>{s.removeClass("is-open").hide()}),a.on("click",()=>{M.splice(t,1),D()}),n.append(r,i,s,a),v.append(n)})}function A(e){if(!e||M.some(t=>t.code===e))return;const t=L.find(t=>t.code===e);M.push({code:e,name:t?t.name:e,masks:[]}),D(),w.val(""),y.hide().empty()}function O(e){const t=(e||"").trim().toLowerCase(),n=L.filter(e=>!M.some(t=>t.code===e.code)).filter(e=>!t||e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)).slice().sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));y.empty(),n.length?(n.slice(0,40).forEach(e=>{y.append($('<div class="ac-item" role="option"/>').attr("data-code",e.code).text(e.name+" ("+e.code+")"))}),y.show(),N(0)):y.append('<div class="ac-item"><span class="muted">Ничего не найдено</span></div>').show()}function N(e){const t=y.children(".ac-item");t.removeClass("active"),t.length&&(e=(e+t.length)%t.length,t.eq(e).addClass("active"),y.data("activeIndex",e))}if(v.on("dragstart",".chip",function(e){$(this).addClass("dragging"),e.originalEvent.dataTransfer.setData("text/plain",$(this).data("idx"))}),v.on("dragend",".chip",function(){$(this).removeClass("dragging")}),v.on("dragover",function(e){e.preventDefault()}),v.on("drop",function(e){e.preventDefault();const t=+e.originalEvent.dataTransfer.getData("text/plain"),n=$(e.target).closest(".chip");if(!n.length)return;const o=+n.data("idx");if(isNaN(t)||isNaN(o)||t===o)return;const r=M.splice(t,1)[0];M.splice(o,0,r),D()}),v.on("click",".mask-remove",function(){const e=+$(this).closest(".chip").data("idx"),t=+$(this).closest(".mask-badge").data("mi");isNaN(e)||isNaN(t)||!Array.isArray(M[e].masks)||(M[e].masks.splice(t,1),D())}),w.on("input",function(){O(this.value)}),w.on("keydown",function(e){const t=0|y.data("activeIndex");if("ArrowDown"===e.key&&y.is(":visible"))e.preventDefault(),N(t+1);else if("ArrowUp"===e.key&&y.is(":visible"))e.preventDefault(),N(t-1);else if("Enter"===e.key){e.preventDefault();const t=y.is(":visible")?function(){const e=0|y.data("activeIndex");return y.children(".ac-item").eq(e).data("code")}():function(){const e=($.trim(w.val())||"").toLowerCase();if(!e)return null;const t=L.filter(e=>!M.some(t=>t.code===e.code)),n=t.find(t=>t.name.toLowerCase()===e)||t.find(t=>t.code.toLowerCase()===e);if(n)return n.code;const o=t.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e));if(1===o.length)return o[0].code;const r=o.filter(t=>t.name.toLowerCase().startsWith(e));return 1===r.length?r[0].code:null}();t?A(t):O(this.value)}else"Escape"===e.key&&y.hide()}),y.on("mousedown",".ac-item",function(){const e=$(this).data("code");e&&A(e)}),$(document).on("click",function(e){$(e.target).closest(g).length||y.hide()}),"function"==typeof FMV.fetchUsers&&FMV.fetchUsers().then(function(t){L=(t||[]).slice(),!1!==a.prefill&&function(t){M=[];const n=e(t||""),o=String(t||"").match(/\[FMVplace\]([\s\S]*?)\[\/FMVplace\]/i);o&&"string"==typeof o[1]&&k.val(o[1].trim());const r=String(t||"").match(/\[FMVord\]([\s\S]*?)\[\/FMVord\]/i);if(r&&"string"==typeof r[1]){let e=parseInt(r[1].trim(),10);Number.isNaN(e)&&(e=0),F.val(e)}Object.keys(n).forEach(e=>{const t=L.find(t=>t.code===e);M.push({code:e,name:t?t.name:e,masks:n[e].masks})}),D()}(l)}).catch(function(e){y.html('<div class="ac-item"><span class="muted">'+(e||"Ошибка загрузки")+"</span></div>").show()}),s.off("submit.fmv.ui").on("submit.fmv.ui",function(e){const i=s.find('input[name="req_subject"]'),a=!i.length||$.trim(i.val()||"").length>0,l=r(c.val()||""),d=$.trim(l).length>0,u=M.length>0,p=$.trim(k.val()||"").length>0;if(!(a&&d&&u&&p)){e.preventDefault(),"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation(),"function"==typeof e.stopPropagation&&e.stopPropagation();const t=[];return a||t.push("Заголовок"),d||t.push("Основной текст"),u||t.push("Участники"),p||t.push("Локация"),alert("Заполните: "+t.join(", ")),!1}const m=[t(M),n(k.val()),o(F.val())].filter(Boolean).join("");let f=l.replace(/[ \t]+$/,"");const g=!f||/\n$/.test(f)?"":"\n";c.val(f+g+m)}),function(){const e=(window.CHRONO_CHECK?.GroupID||[]).map(String),t=(window.CHRONO_CHECK?.AllowedUser||[]).map(String),n="function"==typeof window.getCurrentGroupId?String(window.getCurrentGroupId()):"",o="function"==typeof window.getCurrentUserId?String(window.getCurrentUserId()):"";return n&&e.includes(n)||o&&t.includes(o)}()){let e=s.data("fmvAdminTools");e&&e.length||(e=$('<div class="fmv-admin-tools"><button type="button" class="fmv-toggle">Режим ручного редактирования</button></div>'),s.data("fmvAdminTools",e)),p.before(e);const i=e.find(".fmv-toggle");i.off("click.fmv");const a=()=>{const e=[t(M),n(k.val()),o(F.val())].filter(Boolean).join(""),a=r(c.val()||"").replace(/[ \t]+$/,""),l=!a||/\n$/.test(a)?"":"\n";c.val(a+(e?l+e:"")),p.remove(),s.off("submit.fmv.ui").removeData("fmvBoundUI"),i.data("raw",!0).text("Вернуться к удобной форме")},l=()=>{FMV.UI.attach({form:s,textarea:c,prefill:!0,showOnlyIfFMVcast:!1,className:"fmv--compact",stripOnMount:!0}),i.data("raw",!1).text("Режим ручного редактирования")};i.on("click.fmv",()=>i.data("raw")?l():a())}const T={serialize:()=>[t(M),n(k.val()),o(F.val())].filter(Boolean).join(""),stripFMV:r,mountPoint:p};return s.data("fmvBoundUI",T),T}}}(),e=function(){if(window.__FMV_BOOTSTRAPPED__)return;if(window.__FMV_BOOTSTRAPPED__=!0,!FMV.UI||"function"!=typeof FMV.UI.attach)return;const e=new URL(location.href),t=e.pathname,n=e.searchParams;function o({strip:e=!1,showOnlyIfCast:t=!1}={}){const n=$('#post form, form[action*="post.php"], form[action*="edit.php"]').first(),o=n.find('textarea[name="req_message"], #main-reply, .questionary-post textarea').first();return n.length&&o.length?FMV.UI.attach({form:n,textarea:o,prefill:!0,showOnlyIfFMVcast:!!t,className:"fmv--compact",stripOnMount:!!e}):null}if(/\/post\.php$/i.test(t)&&!n.has("action")){const e=+(n.get("fid")||0);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(e)&&o({strip:!1,showOnlyIfCast:!1})}if(/\/post\.php$/i.test(t)&&"post"===n.get("action")){if(n.has("tid"))return;const e=Number(n.get("fid")),t=(window.CHRONO_CHECK?.ForumID||[]).map(Number);e&&!t.includes(e)||o({strip:!0,showOnlyIfCast:!1})}if(/\/edit\.php$/i.test(t)&&n.has("id")&&document.querySelector('input[name="firstpost"]')){const e=document.querySelector(".container.crumbs a:nth-of-type(2)");if(e&&e.href.includes("/viewforum.php?id=")&&e.href.split("/viewforum.php?id=").length>=2){const t=Number(e.href.split("/viewforum.php?id=")[1]);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(t)&&o({strip:!0,showOnlyIfCast:!1})}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}(),(()=>{"use strict";const e="Показать скрытые теги";async function t(e,{timeout:t=1e4,interval:n=100}={}){const o=performance.now();for(;performance.now()-o<t;){try{const t=e();if(t)return t}catch{}await FMV.sleep(n)}return null}function n(){const t=document.querySelector(".ams_info");return t&&Array.from(t.querySelectorAll("div[data-order]")).find(t=>{const n=t.querySelector("button.button");return 1===Number(t.dataset.order)&&n&&n.textContent.trim()===e})||null}async function o(){if(!await t(()=>window.FMV&&"function"==typeof FMV.readTagText&&"function"==typeof FMV.escapeHtml&&"function"==typeof FMV.parseOrderStrict&&"function"==typeof FMV.buildIdToNameMapFromTags&&"function"==typeof FMV.parseCharactersUnified&&"function"==typeof window.profileLink,{timeout:15e3}))return null;const e=await t(()=>document.querySelector(".topic .post.topicpost, .post.topicpost, .message:first-of-type"),{timeout:15e3});if(!e)return null;const n=window.CHRONO_CHECK?.GroupID||[];if("function"==typeof window.ensureAllowed&&!window.ensureAllowed(n))return null;const o=FMV.readTagText(e,"characters"),r=FMV.readTagText(e,"location"),i=FMV.readTagText(e,"order"),a=await FMV.buildIdToNameMapFromTags(o),s=[];if(o){const e=FMV.renderParticipantsHtml(o,a,(e,t)=>window.profileLink(e,t));s.push(`<div class="fmv-row"><span class="fmv-label">Участники:</span>${e}</div>`)}if(r&&s.push(`<div class="fmv-row"><span class="fmv-label">Локация:</span>${FMV.escapeHtml(r)}</div>`),i){const e=FMV.parseOrderStrict(i);s.push(`<div class="fmv-row"><span class="fmv-label">Для сортировки:</span>${e.html}</div>`)}if(!s.length)return null;!function(){if(document.getElementById("fmv-meta-style"))return;const e=document.createElement("style");e.id="fmv-meta-style",e.textContent="\n      .fmv-meta{\n        margin:8px 0; padding:8px; border:1px solid #d7d7d7;\n        background:#f7f7f7; border-radius:6px;\n      }\n      .fmv-row{margin:.25em 0}\n      .fmv-label{font-weight:700;margin-right:.25em}\n      .fmv-missing{color:#c00;background:#ffe6e6;border-radius:6px;padding:0 .25em;font-weight:700}\n    ",document.head.appendChild(e)}();const c=document.createElement("div");return c.className="fmv-meta",c.innerHTML=s.join("\n"),c}async function r(){const e=n();if(!e)return;!function(){const e=n(),t=e?.nextElementSibling;t&&t.classList.contains("fmv-meta")&&t.remove()}();const t=await o();t&&e.parentNode.insertBefore(t,e.nextSibling)}window.CHRONO_CHECK&&Array.isArray(window.CHRONO_CHECK.GroupID)&&Array.isArray(window.CHRONO_CHECK.ForumID)?createForumButton({allowedGroups:window.CHRONO_CHECK.GroupID,allowedForums:window.CHRONO_CHECK.ForumID,label:e,order:1,showStatus:!1,showDetails:!1,showLink:!1,async onClick({wrap:e}){if(e.nextElementSibling?.classList.contains("fmv-meta"))e.nextElementSibling.remove(),localStorage.setItem("fmv:meta:enabled","0");else{const t=await o();t&&(e.parentNode.insertBefore(t,e.nextSibling),localStorage.setItem("fmv:meta:enabled","1"))}}}):console.warn("[tags_visibility] Требуются CHRONO_CHECK.GroupID, ForumID"),(async()=>{"1"!==localStorage.getItem(function(){try{const e=new URL(location.href);return`fmv:meta:enabled:${e.searchParams.get("id")||e.searchParams.get("tid")||e.pathname}`}catch{return`fmv:meta:enabled:${location.href}`}}())||function(){const e=n(),t=e?.nextElementSibling;return!(!t||!t.classList.contains("fmv-meta"))}()||await r()})()})();