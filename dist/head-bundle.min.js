/*!
 * QuadroBoards Automatizations - HEAD BUNDLE
 * @version 1.0.0
 */
var SITE_URL=location.origin,ALLOWED_PARENTS=["https://testfmvoice.rusff.me","https://followmyvoice.rusff.me"],GROUP_IDS={Admin:1,Moderator:2,Guest:3,User:4,Player:5,Listener:-1,Ads:-2},PROFILE_FIELDS={MoneyID:6,MoneyTemplate:0,IconID:5,BackgroundID:4,PlashkaID:3,PlashkaTemplate:'<a id="ID" class="modal-link" data-reveal-id="character">личная страница</a>'},FIELDS_WITH_HTML=[PROFILE_FIELDS.PlashkaID,PROFILE_FIELDS.BackgroundID,PROFILE_FIELDS.IconID],EPS_FORUM_INFO=[{id:8,type:"au",status:"on"},{id:9,type:"plot",status:"archived"},{id:5,type:"personal",status:"archived"},{id:4,type:"personal",status:"off"}],FORUMS_IDS={Ams:[6],Ads:[3],Bank:[1],PersonalPosts:EPS_FORUM_INFO.filter(e=>"plot"!==e.type).map(e=>e.id),PlotPosts:EPS_FORUM_INFO.filter(e=>"plot"===e.type).map(e=>e.id),NewForm:[10]},EX_PROFILES={topicID:31,commentID:117},CHRONO_CHECK={GroupID:[GROUP_IDS.Admin],AllowedUser:[],ForumID:EPS_FORUM_INFO.map(e=>e.id),AmsForumID:FORUMS_IDS.Ams,ChronoTopicID:13,TotalChronoPostID:83,PerPersonChronoPostID:92,EpisodeMapType:{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},EpisodeMapStat:{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},ForumInfo:EPS_FORUM_INFO},PROFILE_CHECK={GroupID:[GROUP_IDS.Admin],GroupUserID:GROUP_IDS.User,GroupPlayerID:GROUP_IDS.Player,ForumID:FORUMS_IDS.NewForm,PPageTemplate:'<div class="character">шаблон</div>',PPageGroupID:[GROUP_IDS.Admin,GROUP_IDS.Moderator,GROUP_IDS.User,GROUP_IDS.Player],PPageFieldID:PROFILE_FIELDS.PlashkaID,PPageFieldTemplate:PROFILE_FIELDS.PlashkaTemplate,MoneyFieldID:PROFILE_FIELDS.MoneyID,MoneyFieldTemplate:PROFILE_FIELDS.MoneyTemplate},SKIN={GroupID:[GROUP_IDS.Admin],LibraryFieldID:41,LibraryGiftPostID:[133],LibraryPlashkaPostID:[134],LibraryIconPostID:[135],LibraryBackPostID:[136],LibraryCouponPostID:[222],PlashkaFieldID:PROFILE_FIELDS.PlashkaID,IconFieldID:PROFILE_FIELDS.IconID,BackFieldID:PROFILE_FIELDS.BackgroundID};!function(){"use strict";const e=window.FMV=window.FMV||{};e.escapeHtml=e.escapeHtml||function(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},e.normSpace=e.normSpace||function(e){return String(e??"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim()},e.waitForSelector=e.waitForSelector||function(e,t=8e3){return new Promise((r,n)=>{const o=document.querySelector(e);if(o)return r(o);const s=new MutationObserver(()=>{const t=document.querySelector(e);t&&(s.disconnect(),r(t))});s.observe(document.documentElement,{childList:!0,subtree:!0}),setTimeout(()=>{s.disconnect(),n(new Error("timeout: "+e))},t)})},e.sleep=e.sleep||function(e){return new Promise(t=>setTimeout(t,e))},e.readTagText=e.readTagText||function(t,r){if(!t)return"";const n=t.querySelector(r);return e.normSpace(n?n.textContent??"":"")},e.idToNameFromPage=e.idToNameFromPage||function(){const t=new Map;return document.querySelectorAll('a[href*="profile.php?id="]').forEach(r=>{const n=r.href.match(/profile\.php\?id=(\d+)/i),o=e.normSpace(r.textContent||"");n&&o&&!t.has(n[1])&&t.set(n[1],o)}),t},e.parseOrderStrict=e.parseOrderStrict||function(t){const r=e.normSpace(t);return r?/^-?\d+$/.test(r)?{ok:!0,value:parseInt(r,10),html:e.escapeHtml(r)}:{ok:!1,html:`<span class="fmv-missing">Ошибка! Нужен формат целого числа (пример: -3 или 5)</span> — ${e.escapeHtml(r)}`}:{ok:!1,html:""}},e.extractUserIdsFromTags=e.extractUserIdsFromTags||function(e){const t=new Set;return String(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},e.buildIdToNameMapFromTags=e.buildIdToNameMapFromTags||async function(t){if(window.__FMV_ID_TO_NAME_MAP__ instanceof Map&&window.__FMV_ID_TO_NAME_MAP__.size)return window.__FMV_ID_TO_NAME_MAP__;const r=e.extractUserIdsFromTags(t),n=new Map;return"function"!=typeof window.getProfileNameById||await Promise.all(r.map(async e=>{try{const t=await window.getProfileNameById(e);t&&n.set(e,t)}catch{}})),n},e.parseCharactersUnified=e.parseCharactersUnified||function(t,r,n=window.profileLink){const o=String(t||"").trim();if(!o)return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:""};if(!/^\s*user\d+(?:\s*=\s*[^;]+)?(?:\s*;\s*user\d+(?:\s*=\s*[^;]+)?)*\s*$/i.test(o))return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:'<span class="fmv-missing">Ошибка формата! Нужен вид: userN; userM=маска; userM=маска; …</span>'};const s=o.split(/\s*;\s*/).filter(Boolean),a=new Set,i=new Map,c=[];for(const t of s){const[o,s]=t.split("="),l=String(Number((o.match(/user(\d+)/i)||[,""])[1])),u=("user"+l).toLowerCase();a.add(u);const f="function"==typeof n?n(l,r?.get(l)):e.escapeHtml(`user${l}`);if(s){const t=e.normSpace(s);i.has(u)||i.set(u,new Set),i.get(u).add(t.toLowerCase()),c.push(`${f}=${e.escapeHtml(t)}`)}}const l=Array.from(a),u=l.map(t=>{const o=Array.from(i.get(t)||[]),s=String(+t.replace(/^user/i,"")),a="function"==typeof n?n(s,r?.get(s)):e.escapeHtml(`user${s}`);return o.length?`${a} [as ${e.escapeHtml(o.join(", "))}]`:a}).join("; ");return{ok:!0,participantsLower:l,masksByCharLower:i,htmlParticipants:u,htmlMasks:c.join("; "),htmlError:""}},e.renderParticipantsHtml=e.renderParticipantsHtml||function(t,r,n=window.profileLink){const o=e.parseCharactersUnified(t,r,n);if(o&&o.ok)return o.htmlParticipants;const s=e.escapeHtml(String(t??""));return o&&o.htmlError&&o.htmlError.trim()?o.htmlError:`<span class="fmv-missing">Аааа! Нужен формат: userN; userM=маска; userK</span> — ${s}`},window.scrapeUsers=async function(t={}){const r=t.force||!1,n=t.maxPages||1e3,o=t.batchSize||5,s="fmv_users_cache_v2",a=(()=>{if(r)return null;try{const e=sessionStorage.getItem(s);if(!e)return null;const t=JSON.parse(e);return t&&t.time&&t.data?Date.now()-t.time>18e5?null:t.data:null}catch(e){return null}})();if(a)return window.scrapedUsers=a,a;async function i(t){const r=`/userlist.php?p=${t}`;let n;if("function"==typeof window.fetchHtml)n=await window.fetchHtml(r);else{const e=await fetch(r,{credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status} (${r})`);n=await e.text()}const o=(new DOMParser).parseFromString(n,"text/html"),s=[];return o.querySelectorAll("td.tcl.username span.usersname").forEach(t=>{const r=t.querySelector("a[href*='id=']"),n=e.normSpace(r?.textContent||""),o=(e=>{if(!e)return null;const t=e.match(/(?:[?&/])id=(\d+)/i);return t?Number(t[1]):null})(r?.getAttribute("href")||"");n&&Number.isFinite(o)&&s.push({id:o,code:"user"+o,name:n})}),s}const c=new Set,l=[];(await i(1)).forEach(e=>{c.has(e.code)||(c.add(e.code),l.push(e))});for(let t=2;t<=n;t+=o){const r=[];for(let e=0;e<o&&t+e<=n;e++)r.push(t+e);const s=await Promise.all(r.map(e=>i(e).catch(()=>[])));let a=!1;for(const e of s){const t=e.filter(e=>!c.has(e.code));t.length>0&&(a=!0,t.forEach(e=>{c.add(e.code),l.push(e)}))}if(!a)break;t+o<=n&&await e.sleep(300)}return l.sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"})),(e=>{try{sessionStorage.setItem(s,JSON.stringify({time:Date.now(),data:e}))}catch(e){}})(l),window.scrapedUsers=l,l},window.fetchProfileInfo=async function(e=window.UserID){if(null==e)throw new Error("UserID не задан (ни аргументом, ни в window.UserID)");const t=`/profile.php?id=${encodeURIComponent(e)}`,r=await fetch(t,{credentials:"same-origin"});if(!r.ok)throw new Error(`HTTP ${r.status} для ${t}`);const n=await r.text(),o=(new DOMParser).parseFromString(n,"text/html"),s=(e,t=o)=>(t.querySelector(e)?.textContent||"").replace(/\u00A0/g," ").trim(),a=e=>{if(!e)return null;const t=String(e).replace(/[^\d+-]/g,"").match(/^[+-]?\d+/);return t?Number(t[0]):null},i=await(async()=>{const e=window.MainUsrFieldResolver?.getFieldValue;if(e)try{return await e({doc:o,fieldId:6})}catch(e){console.warn("[fetchProfileInfo] getFieldValue error:",e)}const t=s("li#pa-fld6 strong");if(t)return t;const r=s("li#pa-fld6");return r?r.split(":").slice(-1)[0].trim():""})(),c=(()=>{const e=a(i);return Number.isFinite(e)?e:0})(),l=s("li#pa-register-date strong"),u=s("li#pa-respect strong"),f=s("li#pa-positive strong"),m=s("li#pa-posts strong");return{id:Number(e),date:(e=>{const t=(e||"").match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);if(!t)return null;const r=Number(t[1]),n=Number(t[2]);return[Number(t[3]),n,r]})(l),respect:a(u),positive:a(f),messages:(p=m,a((p||"").split(" - ")[0])),money:c};var p},window.encodeForSearch=function(e){e=String(e).normalize("NFC");const t=new Map([[160,160],[171,171],[187,187],[8230,133],[8211,150],[8212,151],[8216,145],[8217,146],[8220,147],[8221,148],[183,183],[8470,185],[169,169],[174,174],[8482,153]]),r=new Map([[1028,170],[1108,186],[1030,178],[1110,179],[1031,175],[1111,191],[1168,165],[1169,180]]);let n="";for(const o of e){const e=o.codePointAt(0);let s;s=e<=127?e:e>=1040&&e<=1103?e-1040+192:1025===e?168:1105===e?184:r.has(e)?r.get(e):t.has(e)?t.get(e):8208===e||8722===e||45===e?45:63,n+=32===s?"+":"%"+s.toString(16).toUpperCase().padStart(2,"0")}return n},window.scrapeTopicFirstPostLinks=async function(e,t,{maxPages:r=999,delayMs:n=300,keywords:o=""}={}){if(!e)throw new Error("author обязателен");if(!Array.isArray(t)||0===t.length)throw new Error("forums обязателен и должен быть массивом");const s=t.join(","),a=e,i=String(o??"").trim(),c=t=>{const r=[["action","search"],["keywords",i?encodeForSearch(i.trim()):""],["author",encodeForSearch(e.trim())],["forums",s],["search_in","0"],["sort_by","0"],["sort_dir","DESC"],["show_as","topics"],["search",encodeForSearch("Отправить")],["p",String(t)]].filter(([e,t])=>""!==t).map(([e,t])=>`${e}=${t}`).join("&");return console.log("[scrapePosts] search params:",`?${r}`),new URL(`/search.php?${r}`,location.origin).toString()};async function l(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),r=await t.text();return(new DOMParser).parseFromString(r,"text/html")}function u(e){for(const t of e.children)if("A"===t.tagName)return t;return null}function f(e){const t=[...e.querySelectorAll(".tclcon")],r=[];for(const e of t){let t=e.querySelector(".byuser-username")?.textContent?.trim();if(!t){const r=e.closest("tr");t=r?.querySelector(".tcr .byuser-username")?.textContent?.trim()||""}if(t!==a)continue;const n=u(e),o=n?.getAttribute("href");o&&r.push(new URL(o,location.href).href)}return r}function m(e){try{const t=new URL(e,location.href);if(("/viewtopic.php"===t.pathname||t.pathname.endsWith("/viewtopic.php"))&&t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}if(t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}return t.href}catch{return e}}function p(e,t){let r=e.querySelector(".post.topicpost a.permalink");if(r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;if(r=e.querySelector(".post.topicpost h3 a[href*='#p']"),r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;if(r=e.querySelector(".post.topicpost a[href*='#p']"),r?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;try{const r=new URL(t).searchParams.get("id");if(r)for(const n of e.querySelectorAll("a[href*='#p']")){const e=new URL(n.getAttribute("href"),t);if(e.pathname.endsWith("/viewtopic.php")&&e.searchParams.get("id")===r)return e.href}}catch{}return null}const d=[...f(await l(c(1)))];await(window.FMV?.sleep?.(n)??new Promise(e=>setTimeout(e,n)));for(let e=2;e<=r;e++){const t=await l(c(e));if(1===Number(t.querySelector("div.linkst div.pagelink strong")?.textContent||1)&&1!==e)break;const r=f(t);if(!r.length)break;d.push(...r),await(window.FMV?.sleep?.(n)??new Promise(e=>setTimeout(e,n)))}const w=[...new Set(d)],h=[];for(const e of w){const t=m(e);try{const e=p(await l(t),t);if(e){const r=e.match(/#p(\d+)/);if(r){const n=r[1],o=new URL(e,t),s=new URL("/viewtopic.php",o.origin);s.searchParams.set("pid",n),h.push(`${s.href}#p${n}`)}else h.push(e)}}catch{}await(window.FMV?.sleep?.(n)??new Promise(e=>setTimeout(e,n)))}return window.__scrapedTopicFirstPosts=h,h},window.scrapePosts=async function(e,t,{stopOnFirstNonEmpty:r=!1,last_src:n=[],title_prefix:o="",maxPages:s=999,delayMs:a=300,keywords:i="",comments_only:c=!1}={}){if(!e)throw new Error("author обязателен");if(!t||Array.isArray(t)&&0===t.length)throw new Error("forums обязателен");const l=Array.isArray(t)?t.join(","):String(t),u=String(i??"").trim(),f=String(o||"").trim().toLocaleLowerCase("ru"),m=Array.isArray(n)?n:[n].filter(Boolean),p=new Set(m.map(d));function d(e){try{const t=new URL(e,location.href),r=t.hash&&t.hash.match(/^#p(\d+)$/);if(r){const e=r[1];return`pid=${e}#p${e}`}const n=t.searchParams.get("pid");if(n)return`pid=${n}#p${n}`;const o=t.searchParams.get("p");return o?`pid=${o}#p${o}`:t.toString()}catch{return e}}function w(e){const t=[];for(const r of e.querySelectorAll(".post")){const e=r.querySelector("h3 > span"),n=e?e.querySelectorAll("a"):[],o=n[2]?.getAttribute("href");o&&t.push(new URL(o,location.href).href)}return t}const h=e=>(e=>{let t=0;for(const r of e)t=(t<<5)-t+r.charCodeAt(0),t|=0;return t})(e.join("\n")),y=t=>{console.log("[scrapePosts] keywords:",`${u}`);const r=[["action","search"],["keywords",u?encodeForSearch(u.trim()):""],["author",encodeForSearch(e.trim())],["forums",l],["search_in","0"],["sort_by","0"],["sort_dir","DESC"],["show_as","posts"],["search",encodeForSearch("Отправить")],["p",String(t)]].filter(([e,t])=>""!==t).map(([e,t])=>`${e}=${t}`).join("&");return console.log("[scrapePosts] search params:",`?${r}`),new URL(`/search.php?${r}`,location.origin).toString()};async function g(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),r=await t.text();return(new DOMParser).parseFromString(r,"text/html")}function _(e){if("Информация"===(e.querySelector("title")?.textContent||"").trim()){const t=e.querySelector("#pun-main .info .container");if(t&&/ничего не найдено/i.test(t.textContent))return!0}return!1}const S=(e="")=>{const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll(".quote-box.hide-box").forEach(e=>{const t=e.querySelector("blockquote");if(t){const r=document.createElement("div");r.innerHTML=t.innerHTML,e.replaceWith(r)}}),t.querySelectorAll("cite").forEach(e=>e.remove()),t.querySelectorAll(".code-box").forEach(e=>{const t=e.querySelector("pre"),r=t?t.textContent:"",n=document.createElement("div");n.textContent=r||"",e.replaceWith(n)}),t.querySelectorAll(".custom_tag, .hidden_tag, characters, location, order").forEach(e=>e.remove()),t.querySelectorAll('script[type="text/html"]').forEach(e=>{const t=document.createElement("div");t.innerHTML=e.textContent||"",t.querySelectorAll("p, br").forEach(e=>e.insertAdjacentText("afterend","\n"));let r=(t.textContent||"").replace(/\u00A0/g," ").replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");e.insertAdjacentText("beforebegin",r?`\n${r}\n`:""),e.remove()});t.querySelectorAll(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DIV","DL","DT","DD","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","THEAD","TBODY","TFOOT","TR","UL","BR"].join(",")).forEach(e=>{"BR"===e.tagName?e.insertAdjacentText("beforebegin","\n"):e.insertAdjacentText("afterend","\n")});let r=(t.textContent||"").replace(/\u00A0/g," ");r=r.replace(/\[\/?indent\]/gi,"").replace(/\[\/?float(?:=[^\]]+)?\]/gi,"").replace(/\[DiceFM[^\]]*?\]/gi,""),r=r.replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n");const n=[];for(const e of r.split("\n")){const t=e.trim();""===t?n.length&&""!==n[n.length-1]&&n.push(""):n.push(t)}return n.join("\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n").replace(/^\n+|\n+$/g,"").trim()},b=e=>{const t=e.querySelector("h3 > span"),r=t?t.querySelectorAll("a"):[],n=(r[1]?.textContent?.trim()||"").toLocaleLowerCase("ru"),o=r[2]?new URL(r[2].getAttribute("href"),location.href).href:"",s=o?d(o):"",a=r[2]?.innerText?.trim()||"",i=e.getAttribute("data-posted"),c=Number(i),l=e.querySelector(".post-content");let u=l?.innerHTML?.trim()||"";const f=((e="")=>e.replace(/\[html\]([\s\S]*?)\[\/html\]/gi,(e,t)=>S(t)))(u),m=S(f);return{title:n,src:s,text:m,html:u,symbols_num:m.length,date_ts:c,date_text:a}};let P=new Set;if(c&&"function"==typeof window.scrapeTopicFirstPostLinks)try{const r=Array.isArray(t)?t:[t],n=await window.scrapeTopicFirstPostLinks(e,r,{maxPages:s,delayMs:a});P=new Set(n.map(d))}catch(e){console.warn("[scrapePosts] cannot preload first-post links:",e)}const A=e=>{const t=[...e.querySelectorAll(".post")].map(b);console.groupCollapsed(`[scrapePosts] Найдено ${t.length} постов на странице`);for(const e of t)console.log("→",e.title,"| символов:",e.symbols_num,"| src:",e.src);console.groupEnd();let r=t.filter(e=>{return t=e.title,!f||t.startsWith(f);var t});console.groupCollapsed(`[scrapePosts] После фильтрации title_prefix='${o}' → ${r.length} постов`);for(const e of r)console.log("✓",e.title,"| символов:",e.symbols_num,"| src:",e.src);if(console.groupEnd(),c&&P.size){const e=r.length;r=r.filter(e=>!P.has(e.src)),console.log(`[scrapePosts] comments_only: исключено ${e-r.length} первых постов тем`)}return r};n&&d(n);const E=r?1:Number.POSITIVE_INFINITY;return await async function(e){const t=[],r=await g(y(1));if(_(r))return F(t);let n=null;for(let o=1;o<=s;o++){const s=1===o?r:await g(y(o));if(_(s))return F(t);const i=A(s),c=w(s),l=h(c);if(!c.length&&!s.querySelector(".post"))return F(t);if(null!==n&&l===n)return F(t);n=l;for(const r of i){if(p.size&&p.has(r.src))return console.log(`[scrapePosts] найден last_src: ${r.src}, остановка`),F(t);if(r.symbols_num>0&&(t.push(r),t.length>=e))return F(t)}await(window.FMV?.sleep?.(a)??new Promise(e=>setTimeout(e,a)))}return F(t)}(E);function F(e){const t=e.slice().reverse();console.log(t);try{console.table(t.map(e=>({title:e.title,src:e.src,symbols_num:e.symbols_num,html:e.html,textPreview:e.text.slice(0,120).replace(/\s+/g," "),date:e.date_ts})))}catch{console.log(t)}return window.__scrapedPosts=t,t}}}(),function(){"use strict";window.FMV||(window.FMV={}),FMV.fetchUsers=async function(e={}){if("function"!=typeof window.scrapeUsers)throw new Error("window.scrapeUsers не найдена. Убедитесь, что common.js загружен.");return await window.scrapeUsers(e)},FMV.invalidateUsersCache=function(){try{sessionStorage.removeItem("fmv_users_cache_v2"),sessionStorage.removeItem("fmv_users_cache_v1")}catch(e){}}}();const __cp1251Map=(()=>{const e={};for(let t=1040;t<=1103;t++)e[t]=t-848;return e[1025]=168,e[1105]=184,e})();function encodeURIcp1251(e){const t=[];for(const r of String(e)){let e=r.charCodeAt(0);if(void 0!==__cp1251Map[e]&&(e=__cp1251Map[e]),e<=255)e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"));else{const e=`&#${r.charCodeAt(0)};`;for(const r of e){const e=r.charCodeAt(0);e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"))}}}return t.join("").replace(/\+/g,"%2B")}function serializeFormCP1251_SelectSubmit(e,t="save"){const r=[];for(const n of Array.from(e.elements||[])){if(!n.name||n.disabled)continue;const e=(n.type||"").toLowerCase();if("submit"!==e&&"button"!==e){if("preview"!==n.name&&("checkbox"!==e&&"radio"!==e||n.checked))if("SELECT"===n.tagName&&n.multiple)for(const e of n.options)e.selected&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(e.value));else r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value??""))}else n.name===t&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value||""))}return r.join("&")}async function fetchWithRetry(e,t={},r=3,n=1e3){let o;for(let s=0;s<=r;s++)try{const a=await fetch(e,t);if(a.status<500)return a;if(o=new Error(`HTTP ${a.status}`),s===r)throw o;console.warn(`[fetchWithRetry] HTTP ${a.status} для ${e}, повтор ${s+1}/${r} через ${n}мс`),await new Promise(e=>setTimeout(e,n))}catch(t){if(o=t,s===r)throw o;console.warn(`[fetchWithRetry] Ошибка для ${e}: ${t.message}, повтор ${s+1}/${r} через ${n}мс`),await new Promise(e=>setTimeout(e,n))}throw o}async function fetchCP1251Doc(e){const t=await fetchWithRetry(e,{credentials:"include"});if(!t.ok)throw new Error(`GET ${e} → HTTP ${t.status}`);const r=await t.arrayBuffer(),n=new TextDecoder("windows-1251").decode(r);return(new DOMParser).parseFromString(n,"text/html")}async function fetchCP1251Text(e,t){const r=await fetchWithRetry(e,t),n=await r.arrayBuffer();return{res:r,text:new TextDecoder("windows-1251").decode(n)}}function serializeFormCP1251(e){const t=[];for(const r of Array.from(e.elements||[]))if(r.name&&!r.disabled&&("checkbox"!==r.type&&"radio"!==r.type||r.checked))if("SELECT"===r.tagName&&r.multiple)for(const e of r.options)e.selected&&t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(e.value));else t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(r.value));return t.join("&")}async function fetchHtml(e){const t=await fetchWithRetry(e,{credentials:"include"});if(!t.ok)throw new Error("HTTP "+t.status);const r=await t.arrayBuffer(),n=t.headers.get("content-type")||"",o=(n.match(/charset=([\w-]+)/i)||[])[1]?.toLowerCase();if(o&&"utf-8"!==o)try{return new TextDecoder(o).decode(r)}catch{}const s=new TextDecoder("utf-8").decode(r),a=s.match(/<meta[^>]+charset\s*=\s*["']?([\w-]+)/i)||s.match(/<meta[^>]+content=["'][^"']*charset\s*=\s*([\w-]+)/i),i=(a&&a[1]||"").toLowerCase();if(!o&&i&&"utf-8"!==i)try{return new TextDecoder(i).decode(r)}catch{}const c=new TextDecoder("windows-1251").decode(r),l=/[ÂÃÐÑ][\u0080-\u00FF]?/g,u=e=>({mixed:(e.match(/\b(?:[A-Za-z]+[А-Яа-яЁё]+|[А-Яа-яЁё]+[A-Za-z]+)[A-Za-zА-Яа-яЁё]*\b/g)||[]).length,bad:(e.match(l)||[]).length+(e.match(/\uFFFD/g)||[]).length}),f=u(s),m=u(c);return m.bad>f.bad+3?s:f.bad>m.bad+3||f.mixed>m.mixed+1?c:s}function userLink(e,t="",r=!1){const n=String(e),o=t||`user${n}`,s=(window.SITE_URL||location.origin).replace(/\/+$/,"");return r?`[url=${s}/profile.php?id=${n}]${o}[/url]`:"function"==typeof window.profileLink?window.profileLink(n,o):`<a href="/profile.php?id=${n}">${o}</a>`}function missingUser(e,t=!1){const r=String(e);return t?`[mark]${r}[/mark]`:`<span class="fmv-missing" data-found="0">${r}</span>`}function topicTitleFromCrumbs(e){const t=e.querySelector("#pun-crumbs1 .crumbs")||e.querySelector(".section .crumbs, .container.crumbs, .crumbs");if(!t)return"";for(let e=t.childNodes.length-1;e>=0;e--){const r=t.childNodes[e];if(r)if(3===r.nodeType){const e=r.nodeValue.replace(/\s+/g," ").trim();if(e)return e}else if(1===r.nodeType&&"A"!==r.tagName&&"EM"!==r.tagName){const e=r.textContent.replace(/\s+/g," ").trim();if(e)return e}}return""}function parseFromScriptHTML(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstElementChild,r=[];return t.querySelectorAll("p").forEach(e=>{const t=parseParagraph(e);t&&r.push(t)}),r}function parseFromRendered(e){const t=e.querySelectorAll("p");if(t.length)return Array.from(t).map(parseParagraph).filter(Boolean);return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").split(/\n{2,}/).map(e=>{const t=document.createElement("div");return t.innerHTML=`<p>${e}</p>`,parseParagraph(t.firstElementChild)}).filter(Boolean)}function findPostNode(e,t){const r=`p${t}`;let n=e.getElementById(r);if(n)return n;const o=e.querySelector(`a[name="${r}"]`);return o?o.closest(".post")||o.closest(".blockpost")||o.parentElement:(n=e.querySelector(`[id^="p${t}"]`),n)}function textFromNodes(e){return e.map(e=>3===e.nodeType?e.nodeValue||"":1===e.nodeType&&e.textContent||"").join("").replace(/\s+/g," ").trim()}function getCurrentGroupId(){const e=Number(document.body?.dataset?.groupId||NaN),t=Number((window&&window.GroupID)??(window&&window.PUNBB&&window.PUNBB.group_id)??(window&&window.PUNBB&&window.PUNBB.user&&window.PUNBB.user.g_id)??e);return Number.isFinite(t)?t:null}async function ensureAllowed(e){const t=getCurrentGroupId(),r=new Set(e.map(String));return null!==t&&r.has(String(t))}
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */function formatBankText(e){if(!e||!Array.isArray(e.fullData))return"";let t="";"undefined"!=typeof window&&"string"==typeof window.SITE_URL&&(t=window.SITE_URL.trim().replace(/\/+$/,""));const r=["form-income-anketa","form-income-akcion","form-income-needchar","form-income-episode-of","form-income-post-of","form-income-writer","form-income-activist"],n=["form-income-topup","form-income-ams"],o=["form-income-firstpost"],s=["form-income-personalpost","form-income-plotpost"],a=["form-income-flyer"],i=["form-income-100msgs","form-income-100pos","form-income-100rep","form-income-month"],c=["form-income-needrequest","form-income-contest","form-income-avatar","form-income-avatar","form-income-design-other","form-income-run-contest","form-income-mastering","form-income-rpgtop"],l=["form-income-banner-mayak","form-income-banner-reno"],u=["form-exp-face-1m","form-exp-face-3m","form-exp-face-6m","form-exp-char-1m","form-exp-char-3m","form-exp-char-6m","form-exp-face-own-1m","form-exp-face-own-3m","form-exp-face-own-6m","form-exp-need-1w","form-exp-need-2w","form-exp-need-1m"],f=["form-exp-thirdchar"],m=["form-exp-changechar"],p=["form-exp-refuse"],d=["form-exp-transfer"],w=["form-exp-mask","form-exp-bonus1d1","form-exp-bonus2d1","form-exp-bonus1w1","form-exp-bonus2w1","form-exp-bonus1m1","form-exp-bonus2m1","form-exp-bonus1m3","form-exp-bonus2m3","form-exp-clean"],h=["form-icon-custom","form-icon-present","form-badge-custom","form-badge-present","form-bg-custom","form-bg-present","form-gift-custom","form-gift-present"],y=["price-adjustment"],g=["personal-coupon"],_=["gift-discount"],S=[...r,...n,...o,...s,...a,...i,...c,...l,...u,...f,...m,...p,...d,...w,...h,...y,...g,..._],b=new Map;for(let e=0;e<S.length;e++)b.has(S[e])||b.set(S[e],e);const P=(e,t,r)=>`[b]— ${e}[/b] = ${t}\n[quote]${r.length?r.join("\n"):""}[/quote]`,A=(e,t)=>`[b]— ${e}[/b]\n[quote]${t.length?t.join("\n"):""}[/quote]`,E=e=>{if(!e)return[];try{const t="string"==typeof e?JSON.parse(e):e;return Array.isArray(t)?t:[]}catch{return[]}},F=e=>null!=e&&""!==String(e).trim(),I=e.fullData.filter(e=>b.has(e.form_id)).sort((e,t)=>b.get(e.form_id)-b.get(t.form_id)),M=new Set([...r,...n,...o,...s,...a,...i,...c,...l]),k=new Set([...u,...f,...m,...p,...d,...w,...y,...h]),$=new Set([...w,...h,...y]),T=I.some(e=>M.has(e.form_id)),D=I.findIndex(e=>k.has(e.form_id)),L=-1!==D;let x=-1,R=-1;I.forEach((e,t)=>{$.has(e.form_id)&&(-1===x&&(x=t),R=t)});const N=-1!==x,O=[];T&&O.push("[quote][size=16][b][align=center]ДОХОДЫ[/align][/b][/size][/quote]"),I.forEach((e,c)=>{L&&c===D&&O.push("[quote][size=16][b][align=center]РАСХОДЫ[/align][/b][/size][/quote]"),N&&c===x&&O.push("[hide=99999999]");const S=e?.title??"",b=e?.modalAmount??e?.amount??"";let I;if(r.includes(e.form_id))I=A(S,((e,r)=>{if(!Array.isArray(e))return[];const n=[];let o=1;for(const s of e){const e=s?.data;if(!e||"object"!=typeof e)continue;const a=Object.keys(e).filter(e=>e.startsWith("recipient_"));for(const s of a){const a=e[`recipient_${s.split("_")[1]}`];a&&(n.push(`${o}. ${t}/profile.php?id=${a} — ${r??""}`),o++)}}return n})(e.entries,e.price));else if(n.includes(e.form_id))I=A(S,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((o,a)=>{const i=o.split("_")[1],c=e[`recipient_${i}`],l=e[`amount_${i}`],u=e[`comment_${i}`];if(!c)return;let f=`${n}. ${t}/profile.php?id=${c} — ${l??""}\n`;const m=F(u);m&&(f+=`\n[b]Комментарий:[/b] ${String(u).trim()}\n`),!(a===s.length-1)&&m&&(f+="[hr]\n"),r.push(f),n++})}return r})(e.entries));else if(o.includes(e.form_id))I=((e,t)=>`[b]— ${e}[/b] = ${t}`)(S,b);else if(s.includes(e.form_id)){const t="form-income-personalpost"===e.form_id?"personal":"plot";I=P(S,b,((e,t)=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data||{},s="personal"===t?e.personal_posts_json??e.personalPostsJson:e.plot_posts_json??e.plotPostsJson;for(const e of E(s)){const t=e?.src??"",o=e?.symbols_num??"";r.push(`${n}. ${t} — ${o} символов`),n++}}return r})(e.entries,t))}else I=a.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data||{};for(const n of E(e.flyer_links_json??e.flyerLinksJson)){const e=n?.src??"";t.push(`${r}. ${e}`),r++}}return t})(e.entries)):i.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[],r=(e,t)=>{if(!e)return;const r=String(t).toLowerCase();for(const t of Object.keys(e))if(t.toLowerCase().endsWith(r))return e[t]};for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(!e)continue;const o=r(e,"_old"),s=r(e,"_new"),a=r(e,"_rounded"),i=n?.multiplier;t.push(`[b]Последнее обработанное значение:[/b] ${o??""}`,`[b]Текущее значение:[/b] ${s??""}`,`[b]Условно округленное значение:[/b] ${a??""}`,`[b]Сколько раз начисляем:[/b] ${i??""}`)}return t})(e.entries)):l.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data?.url;e&&t.push(`[b]Ссылка:[/b] ${e}`)}return t})(e.entries)):u.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data?.quantity;null!=e&&t.push(`[b]Количество[/b]: ${e}`)}return t})(e.entries)):f.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.url??"";r&&t.push(`[b]Согласование:[/b] ${r}`)}}return t})(e.entries)):m.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.text??"";""!==r&&t.push(`[b]Новое имя профиля:[/b]\n[code]${r}[/code]`)}}return t})(e.entries)):p.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const r of e){const e=r?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const r=e?.comment??"";""!==r&&t.push(`[b]Комментарий:[/b]\n${r}`)}}return t})(e.entries)):d.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(e&&"object"==typeof e)for(const o of Object.keys(e))if(o.startsWith("recipient_")){const s=o.split("_")[1],a=e[`recipient_${s}`],i=e[`amount_${s}`];a&&(r.push(`${n}. ${t}/profile.php?id=${a} — ${i??""}`),n++)}}return r})(e.entries)):w.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((o,a)=>{const i=o.split("_")[1],c=e[`recipient_${i}`],l=e[`quantity_${i}`],u=e[`from_${i}`],f=e[`wish_${i}`],m=F(u),p=F(f);if(!c)return;let d=`${n}. ${t}/profile.php?id=${c} — ${l??""}\n`;if(m||p){let e="";m&&p?e=`${String(u).trim()}: ${String(f).trim()}`:m?e=String(u).trim():p&&(e=String(f).trim()),d+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}d+=a===s.length-1||!m&&!p?"":"[hr]\n",r.push(d),n++})}return r})(e.entries)):h.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const r=[];let n=1;for(const o of e){const e=o?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((o,a)=>{const i=o.split("_")[1],c=e[`recipient_${i}`],l=e[`from_${i}`],u=e[`wish_${i}`],f=e[`gift_data_${i}`],m=F(l),p=F(u),d=F(f);if(!c)return;let w=`${n}. ${t}/profile.php?id=${c}\n`;if(m||p){let e="";m&&p?e=`${String(l).trim()}: ${String(u).trim()}`:m?e=String(l).trim():p&&(e=String(u).trim()),w+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}d&&(w+=`\n[b]Данные:[/b]\n${String(f)}\n`),w+=a!==s.length-1&&(m||p||d)?"[hr]\n":"",r.push(w),n++})}return r})(e.entries)):y.includes(e.form_id)?A(S,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data;if(!e){r++;continue}const o=Array.isArray(e)?e:[e];for(const e of o){const n=e?.adjustment_title??"",o=e?.adjustment_amount??"";t.push(`${r}. [b]${n}:[/b] -${o}`)}r++}return t})(e.entries)):g.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data;if(!e){r++;continue}const o=Array.isArray(e)?e:[e];for(const e of o){const n=e?.coupon_title??"",o=e?.discount_amount??"";t.push(`${r}. [b]${n}:[/b] ${o}`)}r++}return t})(e.entries)):_.includes(e.form_id)?P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n?.data;if(!e){r++;continue}const o=Array.isArray(e)?e:[e];for(const e of o){const n=e?.discount_title??"",o=e?.discount_amount??"";t.push(`${r}. [b]${n}:[/b] ${o}`)}r++}return t})(e.entries)):P(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let r=1;for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(e)for(const n of Object.keys(e))t.push(`${r}. ${e[n]}`),r++}return t})(e.entries));O.push(I),N&&c===R&&O.push("[/hide]")});let U=O.join("\n\n");if(void 0!==e.totalSum&&null!==e.totalSum&&""!==e.totalSum){const t=(""!==e.environment.CURRENT_BANK&&null!==e.environment.CURRENT_BANK&&"undefined"!==e.environment.CURRENT_BANK&&void 0!==e.environment.CURRENT_BANK?Number(e.environment.CURRENT_BANK):0)+Number(e.totalSum);U+=`\n\n[quote][size=16][align=center][b]ИТОГО:[/b] [color=${Number(e.totalSum)<0?"red":"green"}]${Number(e.totalSum)>0?"+":""}${e.totalSum}[/color]\n[b]ВАШ СЧЁТ:[/b] ${t}[/align][/size][/quote]`}return""!==e.environment.COMMENT_ID&&null!==e.environment.COMMENT_ID&&"undefined"!==e.environment.COMMENT_ID&&void 0!==e.environment.COMMENT_ID&&""!==e.editLogs&&null!==e.editLogs&&"undefined"!==e.editLogs&&void 0!==e.editLogs&&(U+=`\n\n[hide=9999999999][b]Комментарий администратора:[/b]\n${e.editLogs}[/hide]`),U}function encodeJSON(e){const t=JSON.stringify(e),r=(new TextEncoder).encode(t),n=Array.from(r,e=>String.fromCharCode(e)).join("");return btoa(n)}function decodeJSON(e){const t=atob(e),r=Uint8Array.from(t,e=>e.charCodeAt(0)),n=(new TextDecoder).decode(r);return JSON.parse(n)}function getBlockquoteTextAfterPersonalPost(e,t,r=""){const n=Array.from(e.querySelectorAll("p > strong")).map(e=>e.closest("p")).find(e=>e&&e.querySelector("strong")?.textContent?.includes(t));if(!n)return null;let o=null;for(let e=n.nextElementSibling;e&&"p"!==e.tagName?.toLowerCase();e=e.nextElementSibling){const t=e.matches?.("blockquote")?e:e.querySelector?.("blockquote");if(t){o=t;break}}return o?"last_value"===r?function(t=e){const r=Array.from(t.querySelectorAll("strong")).find(e=>e.textContent.trim().startsWith("Условно округленное значение:"));if(!r)return null;const n=[];for(let e=r.nextSibling;e&&(e.nodeType!==Node.ELEMENT_NODE||"strong"!==e.tagName?.toLowerCase());e=e.nextSibling)e.nodeType===Node.TEXT_NODE?n.push(e.nodeValue):e.nodeType===Node.ELEMENT_NODE&&n.push(e.textContent);return n.join(" ").replace(/\s+/g," ").trim()||null}(o):"link"===r?Array.from(o.querySelectorAll("a")).map(e=>e.getAttribute("href")).filter(Boolean):o.innerHTML.trim():null}function getBlockquoteTextFromHtml(e,t,r=""){return getBlockquoteTextAfterPersonalPost((new DOMParser).parseFromString(e,"text/html"),t,r)}window.parseChronoTagsRaw=function(e){const t=t=>e.querySelector(t)?.textContent.trim()||"",r=t("characters"),n=t("masks"),o=(r?r.split(/\s*;\s*/):[]).map(e=>e.trim().toLowerCase()).filter(Boolean),s={};(n||"").split(/\s*;\s*/).forEach(e=>{const t=e.indexOf("=");t>0&&(s[e.slice(0,t).trim().toLowerCase()]=e.slice(t+1).trim())});const a=new Set(o);return Object.keys(s).forEach(e=>a.add(e)),{participantsLower:Array.from(a),masks:s,location:t("location"),order:t("order")}},window.resolveChronoData=async function(e,t={}){const r={...e,idToName:new Map,participantsHtml:"",masksHtml:""},n=new Set;for(const t of e.participantsLower){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const t of Object.keys(e.masks||{})){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const e of n)try{r.idToName.set(e,await getProfileNameById(e)||null)}catch{r.idToName.set(e,null)}const o=e=>{const t=/^user(\d+)$/i.exec(e);if(!t)return window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml(e):e;const n=String(+t[1]),o=r.idToName.get(n)||null;return profileLink(n,o)},s=window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml:e=>e;return r.participantsHtml=e.participantsLower.map(o).join("; "),r.masksHtml=Object.entries(e.masks||{}).map(([e,t])=>`${o(e)}=${s(t)}`).join("; "),r},function(){"use strict";window.FMV=window.FMV||{},FMV.escapeHtmlShort=FMV.escapeHtmlShort||function(e="",t=500){const r=String(e),n=r.length>t?r.slice(0,t)+"…":r;return"function"==typeof FMV.escapeHtml?FMV.escapeHtml(n):n},FMV.fetchDoc=FMV.fetchDoc||async function(e){const t=await fetchHtml(e);return"function"==typeof window.parseHTML?window.parseHTML(t):(new DOMParser).parseFromString(t,"text/html")},FMV.toCp1251Entities=FMV.toCp1251Entities||function(e){const t=/[\u0000-\u007F\u0400-\u045F\u0401\u0451]/;let r="";for(const n of String(e))r+=t.test(n)?n:`&#${n.codePointAt(0)};`;return r},window.fetchWithRetry=window.fetchWithRetry||fetchWithRetry}(),(()=>{"use strict";const e=window.MAKE_NAMES_LINKS??!0;const t=window.fetchHtml||(async e=>{const t=await fetch(e,{credentials:"include"});return await t.text()});window.profileLink=function(t,r){const n=String(Number(t));if(!("string"==typeof r&&r.trim().length>0)){const e=`user${n}`;return`<span class="fmv-missing" data-user-id="${n}" data-found="0">${FMV.escapeHtml(e)}</span>`}const o=FMV.escapeHtml(r.trim());if(!e)return o;const s=document.createElement("a");return s.className="fmv-user",s.href="/profile.php?id="+encodeURIComponent(n),s.textContent=o,s.setAttribute("data-user-id",n),s.setAttribute("data-found","1"),s.outerHTML},window.profileLinkMeta=function(e,t){const r=window.profileLink(e,t),n="string"==typeof r&&!/\bfmv-missing\b/.test(r);return{html:String(r||""),found:n,id:String(Number(e)),name:"string"==typeof t&&t.trim()?t.trim():null}};const r=new Map;let n=null,o=null;async function s(e){const r=await async function(){if(n)return n;if(o)return o;if(!window.EX_PROFILES||"object"!=typeof window.EX_PROFILES)return console.error("[loadExProfiles] Ошибка: window.EX_PROFILES не задан или имеет неверный формат"),n=new Map,n;const{topicID:e,commentID:r}=window.EX_PROFILES;if(null==e||null==r)return console.error("[loadExProfiles] Ошибка: отсутствует topicID или commentID в window.EX_PROFILES"),n=new Map,n;const s=`/viewtopic.php?id=${encodeURIComponent(e)}#p${encodeURIComponent(r)}`;return o=(async()=>{const e=await t(s),r=(new DOMParser).parseFromString(e,"text/html"),o=new Map;for(const e of r.querySelectorAll('a[href*="profile.php?id="]')){const t=(e.getAttribute("href")||"").match(/profile\.php\?id=(\d+)/i);if(!t)continue;const r=String(Number(t[1])),n=(e.textContent||"").trim().toLowerCase();n&&!o.has(r)&&o.set(r,n)}return n=o,o})(),o}();return r.get(String(Number(e)))||null}async function a(e){if(e=String(Number(e)),r.has(e))return r.get(e);let n=function(e){const t=Array.from(document.querySelectorAll(`a[href*="profile.php?id=${e}"]`));for(const e of t){const t=(e.textContent||"").trim();if(t&&!/Профил|Profile/i.test(t))return t}return null}(e);if(!n)try{const r=await t(`/profile.php?id=${e}`);n=function(e){const t=e.querySelector(".user-ident .username")||e.querySelector(".user-box .username")||null;if(t){const e=(t.textContent||"").trim();if(e)return e}const r=["#pun-title span","h1 span","h1","h2.hn",".hn",".title",".subhead h2"].map(t=>e.querySelector(t)).filter(Boolean).map(e=>(e.textContent||"").trim()).filter(Boolean),n=(e.querySelector("title")?.textContent||"").trim();n&&r.unshift(n);const o=[/Профил[ья]\s*[:\-—–]\s*(.+)$/i,/Просмотр\s+профиля\s*[:\-—–]\s*(.+)$/i,/Profile\s*[:\-—–]\s*(.+)$/i];for(let e of r){e=e.replace(/\s+/g," ").trim();for(const t of o){const r=e.match(t);if(r){const e=r[1].trim().replace(/^[«"'\\[]|[»"'\\]]$/g,"").trim();if(e)return e}}}return null}((new DOMParser).parseFromString(r,"text/html"))}catch{}if(!n)try{const t=await s(e);t&&(n=`[ex] ${t}`)}catch{}return r.set(e,n||null),n||null}window.profileLinkByIdAsync=async function(e){const t=String(Number(e)),r=await a(t);return window.profileLinkMeta(t,r)},window.extractUserIdsFromString=function(e){const t=new Set;return(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},window.getProfileNameById=a})(),function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,r=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),n=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${r(e)}, .${r(e)}`,s=new TextDecoder("utf-8");let a;async function i(e){const t=await fetch(e,{credentials:"same-origin"}),r=await t.arrayBuffer();let n=s.decode(r);if(/charset\s*=\s*windows-1251/i.test(n)||n.includes("�"))try{n=(a||=new TextDecoder("windows-1251")).decode(r)}catch{}return n}function c(e,t){const r=e.querySelector(o(t)),n=r?.querySelector("strong, b");let s=n?.textContent?.trim();if(!s){const e=(r?.textContent||"").trim();s=e.split(":").slice(-1)[0]?.trim()}return(s||"").replace(/\u00A0/g," ").trim()}const l=new Map;function u(e,t){if(l.has(e))return l.get(e);const r=(async()=>{const r=await i(`/profile.php?id=${encodeURIComponent(e)}`);return c((new DOMParser).parseFromString(r,"text/html"),t)})();return l.set(e,r),r}function f(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const r=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=r.nextNode();){const t=(e.nodeValue||"").match(n);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:r})=>{u(r,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+r,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:r}={}){const s=`pa-fld${String(r??e).replace(/\D/g,"")||e}`,a=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(n);if(t)return t[1]}return null}(t.querySelector(o(s)));if(a)try{return await u(a,s)}catch(e){console.warn("[main-field] remote error:",e)}return c(t,s)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f,{once:!0}):f()}(),function(e){const t="/api.php";let r=!1;const n=e=>new URLSearchParams(e);async function o(e,o={},s=1){const a="fmv_bank_info_"+s;if("storage.get"===e){const r=n({user_id:1,method:e,key:a}),o=await fetch(`${t}?${r}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!o.ok)throw new Error(`GET ${o.status}`);return o.json()}if("storage.set"===e){const s=n({user_id:1,token:r,method:e,key:a,...o}),i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},credentials:"same-origin",body:s});if(!i.ok)throw new Error(`POST ${i.status}`);return!0}throw new Error("Unknown method")}!function(){const t=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;if(t)r=t;else{let t=5;const n=setInterval(()=>{if(r||--t<0)return void clearInterval(n);const o=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;o&&(r=o,clearInterval(n))},200)}}(),e.FMVbank={setTicket:function(e){r=e},storageGet:async function(e=1){const t="fmv_bank_info_"+e;return((e,t)=>{try{const r=e?.response?.storage?.data?.[t];return r?JSON.parse(r):{}}catch{return{}}})(await o("storage.get",{},e),t)},storageSet:async function(e,t=1){if(!e||"object"!=typeof e||Array.isArray(e))throw new Error("[FMVbank] storageSet: ожидался объект JSON");const r=JSON.stringify(e);return await o("storage.set",{value:r},t),!0}}}(window),window.formatBankText=formatBankText,window.encodeJSON=encodeJSON,window.decodeJSON=decodeJSON,window.getBlockquoteTextAfterPersonalPost=getBlockquoteTextAfterPersonalPost,window.getBlockquoteTextFromHtml=getBlockquoteTextFromHtml;let preScrapeBarrier=Promise.resolve(!0);const delay=e=>new Promise(t=>setTimeout(t,e));async function withTimeout(e,t,r="request"){let n;const o=new Promise((e,o)=>{n=setTimeout(()=>o(new Error(`${r} timeout after ${t} ms`)),t)});try{return await Promise.race([e,o])}finally{clearTimeout(n)}}async function retry(e,{retries:t=3,baseDelay:r=600,maxDelay:n=6e3,timeoutMs:o=15e3}={},s="request"){let a;console.log(`🟦 [STEP] ${s} start`);for(let i=0;i<t;i++)try{const r=await withTimeout(e(),o,s);return console.log(`✅ [OK]   ${s} success (try ${i+1}/${t})`),r}catch(e){a=e;if(i===t-1){console.warn(`❌ [ERROR] ${s} failed after ${t} tries:`,e?.message||e);break}const o=.8+.4*Math.random(),c=Math.min(r*2**i,n)*o;console.log(`⚠️  [RETRY] ${s} try ${i+1} failed: ${e?.message||e}. Waiting ${Math.round(c)}ms before retry...`),await delay(c)}throw a}const SCRAPE_BASE_GAP_MS=1200,SCRAPE_JITTER_MS=800,SEND_BASE_GAP_MS=900,SEND_JITTER_MS=500;function humanPause(e,t,r="pause"){const n=e+Math.floor(Math.random()*t);return console.log(`🟨 [WAIT] ${r}: ${n}ms`),delay(n)}const IFRAME_ORIGIN="https://forumscripts.ru",BankPrefix={ads:"Реклама",bank:"Гринготтс"},BankForums={ads:window.FORUMS_IDS?.Ads||[0],bank:window.FORUMS_IDS?.Bank||[0],personal_posts:window.FORUMS_IDS?.PersonalPosts||[0],plot_posts:window.FORUMS_IDS?.PlotPosts||[0]},BankLabel={ads:"— Каждая рекламная листовка",banner_mayak:"— Баннер FMV в подписи на Маяке",banner_reno:"— Баннер FMV в подписи на Рено",first_post:"— Первый пост на профиле",message100:"— Каждые 100 сообщений",positive100:"— Каждые 100 позитива",reputation100:"— Каждые 100 репутации",month:"— Каждый игровой месяц",personal_posts:"— Каждый личный пост",plot_posts:"— Каждый сюжетный пост"},BankPostMessagesType={ads:"ADS_POSTS",banner_mayak:"BANNER_MAYAK_FLAG",banner_reno:"BANNER_RENO_FLAG",first_post:"FIRST_POST_FLAG",first_post_missed:"FIRST_POST_MISSED_FLAG",personal_posts:"PERSONAL_POSTS",plot_posts:"PLOT_POSTS",profile_info:"PROFILE_INFO",user_info:"USER_INFO",users_list:"USERS_LIST"};function getBankToday(){const e=new Date;return[e.getFullYear(),e.getMonth()+1,e.getDate()]}function waitForIframeReady(e){return new Promise(t=>{window.addEventListener("message",function r(n){if(n.origin!==e)return;if("IFRAME_READY"!==n.data?.type)return;window.removeEventListener("message",r);const o=n.source;o.postMessage({type:"IFRAME_ACK"},e),console.log("✅ [IFRAME] ACK sent, iframe ready"),t(o)}),console.log("🟦 [STEP] waiting for IFRAME_READY…")})}const sendQueue=[];let sending=!1;async function processQueue(){if(!sending){sending=!0,console.log(`🟦 [STEP] send queue started (items: ${sendQueue.length})`);try{for(;sendQueue.length;){const e=sendQueue.shift();try{await e()}catch(e){console.warn("❌ [ERROR] send task failed:",e?.message||e)}await humanPause(900,500,"gap between sends")}}finally{sending=!1,console.log("✅ [OK]   send queue drained")}}}function queueJob(e,t){e.then(e=>{sendQueue.push(async()=>{const r=Date.now();console.log("🟪 [QUEUE] job started"),await t(e),console.log(`🟩 [SENT]  job done in ${Date.now()-r}ms`)}),console.log(`🟪 [QUEUE] job enqueued (size: ${sendQueue.length})`),processQueue()}).catch(e=>console.warn("queueJob skipped:",e?.message||e))}function queueMessage(e,t,r="message"){queueJob(e,async e=>{const n=t();n?(e.postMessage(n,IFRAME_ORIGIN),console.log(`🟩 [SENT]  ${r}:`,n.type||"(no type)")):console.log(`⚪ [SKIP]  ${r}: empty message`)})}async function sendPosts(e,{seedPosts:t,label:r,forums:n,type:o,is_ads:s=!1,title_prefix:a=""}){try{const i=Array.isArray(t)?t[0]:null,c=i&&"string"==typeof i.html?i.html:"",l=c?getBlockquoteTextFromHtml(c,r,"link"):null,u=(Array.isArray(l)?l:"string"==typeof l&&""!==l.trim()?[l]:[]).filter(e=>"string"==typeof e&&e.includes("/viewtopic.php?")).map(e=>e.split("/viewtopic.php?")[1]);console.log(`🟦 [STEP] scrape new posts for ${o} (filter used_posts: ${u.length})`);const f=await retry(()=>window.scrapePosts(window.UserLogin,n,{last_src:u,comments_only:!0,title_prefix:a}),{retries:4,baseDelay:800,maxDelay:8e3,timeoutMs:18e3},`scrapePosts(${o})`),m=Array.isArray(f)?f.map(e=>({src:`${SITE_URL}/viewtopic.php?${e.src}`,text:e.title,...s?{}:{symbols_num:e.symbols_num}})):[];e.postMessage({type:o,posts:m},IFRAME_ORIGIN),console.log(`🟩 [SENT]  ${o}: ${m.length} item(s)`)}catch(e){console.warn(`❌ [ERROR] sendPosts(${o}) failed after retries:`,e?.message||e)}}async function getLastValue(e,{label:t,is_month:r=!1}){try{const n=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:t.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(personal_seed)"),o=window.scrapePosts?.bind(window);"function"==typeof o&&(window.scrapePosts=async(...e)=>(await(window.preScrapeBarrier??preScrapeBarrier??Promise.resolve()),o(...e)));const s=Array.isArray(n)?n[0]:null,a=s&&"string"==typeof s.html?s.html:"",i=a?getBlockquoteTextFromHtml(a,t,"last_value"):null;let c;return c=null==i?e:1==r?i.trim().split("-").map(Number):Number(i.trim()),console.log(`🟩 [FOUND] Новое значение ${t}: ${c}`),c}catch(e){return console.warn(`❌ [ERROR] getLastValue(${t}) failed after retries:`,e?.message||e),null}}document.addEventListener("DOMContentLoaded",()=>{if(!(document.querySelector("head > title")?.textContent||"").startsWith("Гринготтс"))return;preScrapeBarrier=(async()=>(console.log("🟨 [WAIT] pre-scrape barrier: 15000ms"),await delay(15e3),console.log("🟢 [GO]   pre-scrape barrier passed"),!0))(),window.preScrapeBarrier=preScrapeBarrier;const e=document.querySelector('textarea[name="req_message"]'),t=waitForIframeReady(IFRAME_ORIGIN);queueMessage(t,()=>({type:BankPostMessagesType.user_info,user_id:window.UserID,user_name:window.UserLogin,is_admin:2==window.UserID}),"user_info"),window.addEventListener("message",async t=>{if(t.origin!==IFRAME_ORIGIN)return;if(!t.data||"PURCHASE"!==t.data.type)return;console.log("🟦 [STEP] PURCHASE received");encodeJSON(t.data);const r=formatBankText(t.data),n=Date.now(),o=await FMVbank.storageGet(window.UserID);if(o[n]=t.data,FMVbank.storageSet(o,window.UserID),e){e.value=`[FMVbank]${n}[/FMVbank]${r}`;const t=document.querySelector('input[type="submit"].button.submit[name="submit"][value="Отправить"][accesskey="s"]');t?(t.click(),console.log("🟩 [SENT]  PURCHASE form submitted")):console.warn("❌ [ERROR] Submit button not found.")}}),(async()=>{try{const e=await retry(()=>scrapeUsers(),{retries:2,baseDelay:700,maxDelay:6e3,timeoutMs:15e3},"scrapeUsers");queueMessage(t,()=>({type:BankPostMessagesType.users_list,users_list:e}),"users_list"),await humanPause(1200,800,"between scrapes (users_list)");const r=await retry(()=>fetchProfileInfo(),{retries:4,baseDelay:900,maxDelay:9e3,timeoutMs:2e4},"fetchProfileInfo"),n=await getLastValue(0,{label:BankLabel.message100});await humanPause(1200,800,"between getLastValue (msg100_old)");const o=await getLastValue(0,{label:BankLabel.reputation100});await humanPause(1200,800,"between getLastValue (rep100_old)");const s=await getLastValue(0,{label:BankLabel.positive100});await humanPause(1200,800,"between getLastValue (pos100_old)");const a=await getLastValue(r.date,{label:BankLabel.month,is_month:!0});queueMessage(t,()=>({type:BankPostMessagesType.profile_info,msg100_old:n,msg100_new:r.messages,rep100_old:o,rep100_new:r.respect,pos100_old:s,pos100_new:r.positive,month_old:a,month_new:getBankToday(),money:r.money}),"profile_info"),await humanPause(1200,800,"between getLastValue (pos100_old)");const i=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.banner_mayak.split(" ").join(" AND ")}),{retries:3,baseDelay:800,maxDelay:7e3,timeoutMs:15e3},"scrapePosts(banner_mayak)");queueMessage(t,()=>({type:BankPostMessagesType.banner_mayak,banner_mayak_flag:!Array.isArray(i)||0===i.length}),"banner_mayak_flag"),await humanPause(1200,800,"between scrapes (banner_mayak)");const c=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.banner_reno.split(" ").join(" AND ")}),{retries:3,baseDelay:800,maxDelay:7e3,timeoutMs:15e3},"scrapePosts(banner_reno)");queueMessage(t,()=>({type:BankPostMessagesType.banner_reno,banner_reno_flag:!Array.isArray(c)||0===c.length}),"banner_reno_flag"),await humanPause(1200,800,"between scrapes (banner_reno)");const l=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.ads.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(ads_seed)");queueJob(t,async e=>{await sendPosts(e,{seedPosts:l,label:BankLabel.ads,forums:BankForums.ads,type:BankPostMessagesType.ads,is_ads:!0,title_prefix:BankPrefix.ads})}),await humanPause(1200,800,"between scrapes (ads)");const u=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.first_post.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:15e3},"scrapePosts(first_post)");queueMessage(t,()=>({type:BankPostMessagesType.first_post,first_post_flag:!Array.isArray(u)||0===u.length}),"first_post_flag"),await humanPause(1200,800,"between scrapes (first_post)");const f=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.personal_posts.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(personal_seed)");queueJob(t,async e=>{await sendPosts(e,{seedPosts:f,label:BankLabel.personal_posts,forums:BankForums.personal_posts,type:BankPostMessagesType.personal_posts,is_ads:!1})}),await humanPause(1200,800,"between scrapes (personal)");const m=await retry(()=>window.scrapePosts(window.UserLogin,BankForums.bank,{title_prefix:BankPrefix.bank,stopOnFirstNonEmpty:!0,keywords:BankLabel.plot_posts.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(plot_seed)");queueJob(t,async e=>{await sendPosts(e,{seedPosts:m,label:BankLabel.plot_posts,forums:BankForums.plot_posts,type:BankPostMessagesType.plot_posts,is_ads:!1})}),await humanPause(1200,800,"between scrapes (plot)"),queueMessage(t,()=>({type:BankPostMessagesType.first_post_missed,first_post_missed_flag:Array.isArray(f)&&f.length>0||Array.isArray(m)&&m.length>0}),"first_post_missed_flag"),console.log("🏁 [DONE] sequential scrape+send flow finished")}catch(e){console.warn("❌ [ERROR] Sequential scrape flow aborted:",e?.message||e)}})()}),function(){window.renderExtraFieldsAsHTML=function(e){if(/\/profile\.php\b/.test(location.pathname)&&/section=fields/.test(location.search))return;const t=function(e){const t=new Set;return(Array.isArray(e)?e:[e]).forEach(e=>{const r=String(e).trim();if(/^\d+$/.test(r))return void t.add(r);const n=r.match(/(?:^|[-_])fld(\d+)$/i);if(n)return void t.add(n[1]);const o=r.match(/^(\d+)\s*-\s*(\d+)$/);if(o){const e=Math.min(+o[1],+o[2]),r=Math.max(+o[1],+o[2]);for(let n=e;n<=r;n++)t.add(String(n))}}),[...t]}(e);if(!t.length)return;const r=e=>/<([a-zA-Z!\/?][^>]*)>/.test(e);function n(e){e.querySelectorAll("a.modal-link").forEach(e=>{e.querySelectorAll(":scope > br").forEach(e=>e.remove())}),e.querySelectorAll(":scope > br").forEach(e=>e.remove())}function o(e){const t=function(e){const t=new Set;[`.pa-fld${e}`,`[class~="pa-fld${e}"]`,`[class*="fld${e}"]`,`[id*="fld${e}"]`,`[data-fld="${e}"]`].forEach(e=>document.querySelectorAll(e).forEach(e=>t.add(e)));const r=[];return[...t].forEach(e=>{const t=e.querySelector?.(".pa-value, .field-value, .value")||null;r.push(t||e)}),r.filter(e=>{if(!e)return!1;const t=(e.innerHTML||"").trim(),r=(e.textContent||"").trim();return t||r})}(e);t.forEach(e=>{if(!e||"1"===e.dataset.htmlRendered)return;const t=(e.innerHTML||"").trim(),o=(e.textContent||"").trim();if(!t&&!o)return;if(r(t)&&!t.includes("&lt;")&&!t.includes("&gt;"))return n(e),void(e.dataset.htmlRendered="1");const s=(e=>{const t=document.createElement("textarea");return t.innerHTML=e,t.value})(t||o);(s!==t||r(s))&&(e.innerHTML=s,n(e),e.dataset.htmlRendered="1")})}t.forEach(o);new MutationObserver(()=>t.forEach(o)).observe(document.documentElement,{childList:!0,subtree:!0})};const e=window.FIELDS_WITH_HTML,t=Array.isArray(e)?e:"string"==typeof e&&e.trim()?[e.trim()]:[];t.length&&window.renderExtraFieldsAsHTML(t)}();