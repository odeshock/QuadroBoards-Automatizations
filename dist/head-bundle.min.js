/*!
 * QuadroBoards Automatizations - HEAD BUNDLE
 * @version 1.0.0
 */
var SITE_URL=location.origin,ALLOWED_PARENTS=["https://testfmvoice.rusff.me","https://followmyvoice.rusff.me"],GROUP_IDS={Admin:1,Moderator:2,Guest:3,User:4,Player:5,Listener:-1,Ads:-2},PROFILE_FIELDS={MoneyID:6,MoneyTemplate:0,IconID:5,BackgroundID:4,PlashkaID:3,PlashkaTemplate:'<a id="ID" class="modal-link" data-reveal-id="character">личная страница</a>'},FIELDS_WITH_HTML=[PROFILE_FIELDS.PlashkaID,PROFILE_FIELDS.BackgroundID,PROFILE_FIELDS.IconID],EPS_FORUM_INFO=[{id:8,type:"au",status:"on"},{id:9,type:"plot",status:"archived"},{id:5,type:"personal",status:"archived"},{id:4,type:"personal",status:"off"}],FORUMS_IDS={Ams:[6],Ads:[3],Bank:[1],PersonalPosts:EPS_FORUM_INFO.filter(e=>"plot"!==e.type).map(e=>e.id),PlotPosts:EPS_FORUM_INFO.filter(e=>"plot"===e.type).map(e=>e.id),NewForm:[10]},EX_PROFILES={topicID:31,commentID:117},CHRONO_CHECK={GroupID:[GROUP_IDS.Admin],AllowedUser:[],ForumID:EPS_FORUM_INFO.map(e=>e.id),AmsForumID:FORUMS_IDS.Ams,ChronoTopicID:13,TotalChronoPostID:83,PerPersonChronoPostID:92,EpisodeMapType:{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},EpisodeMapStat:{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},ForumInfo:EPS_FORUM_INFO},PROFILE_CHECK={GroupID:[GROUP_IDS.Admin],GroupUserID:GROUP_IDS.User,GroupPlayerID:GROUP_IDS.Player,ForumID:FORUMS_IDS.NewForm,PPageTemplate:'<div class="character">шаблон</div>',PPageGroupID:[GROUP_IDS.Admin,GROUP_IDS.Moderator,GROUP_IDS.User,GROUP_IDS.Player],PPageFieldID:PROFILE_FIELDS.PlashkaID,PPageFieldTemplate:PROFILE_FIELDS.PlashkaTemplate,MoneyFieldID:PROFILE_FIELDS.MoneyID,MoneyFieldTemplate:PROFILE_FIELDS.MoneyTemplate},BANK_CHECK={GroupID:[GROUP_IDS.Admin],UserID:[2],ForumID:FORUMS_IDS.Bank},SKIN={GroupID:[GROUP_IDS.Admin],LibraryForumID:FORUMS_IDS.Ams,LibraryFieldID:41,LibraryGiftPostID:[133],LibraryPlashkaPostID:[134],LibraryIconPostID:[135],LibraryBackPostID:[136],LibraryCouponPostID:[222],LogFieldID:55,PlashkaFieldID:PROFILE_FIELDS.PlashkaID,IconFieldID:PROFILE_FIELDS.IconID,BackFieldID:PROFILE_FIELDS.BackgroundID};!function(){"use strict";const e=window.FMV=window.FMV||{},t=console.log.bind(console),o=console.warn.bind(console),n=(console.error.bind(console),console.table.bind(console)),r=console.groupCollapsed.bind(console),s=console.groupEnd.bind(console);e.escapeHtml=e.escapeHtml||function(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},e.normSpace=e.normSpace||function(e){return String(e??"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim()},e.waitForSelector=e.waitForSelector||function(e,t=8e3){return new Promise((o,n)=>{const r=document.querySelector(e);if(r)return o(r);const s=new MutationObserver(()=>{const t=document.querySelector(e);t&&(s.disconnect(),o(t))});s.observe(document.documentElement,{childList:!0,subtree:!0}),setTimeout(()=>{s.disconnect(),n(new Error("timeout: "+e))},t)})},e.sleep=e.sleep||function(e){return new Promise(t=>setTimeout(t,e))},e.readTagText=e.readTagText||function(t,o){if(!t)return"";const n=t.querySelector(o);return e.normSpace(n?n.textContent??"":"")},e.idToNameFromPage=e.idToNameFromPage||function(){const t=new Map;return document.querySelectorAll('a[href*="profile.php?id="]').forEach(o=>{const n=o.href.match(/profile\.php\?id=(\d+)/i),r=e.normSpace(o.textContent||"");n&&r&&!t.has(n[1])&&t.set(n[1],r)}),t},e.parseOrderStrict=e.parseOrderStrict||function(t){const o=e.normSpace(t);return o?/^-?\d+$/.test(o)?{ok:!0,value:parseInt(o,10),html:e.escapeHtml(o)}:{ok:!1,html:`<span class="fmv-missing">Ошибка! Нужен формат целого числа (пример: -3 или 5)</span> — ${e.escapeHtml(o)}`}:{ok:!1,html:""}},e.extractUserIdsFromTags=e.extractUserIdsFromTags||function(e){const t=new Set;return String(e||"").replace(/user(\d+)/gi,(e,o)=>(t.add(String(Number(o))),e)),Array.from(t)},e.buildIdToNameMapFromTags=e.buildIdToNameMapFromTags||async function(t){if(window.__FMV_ID_TO_NAME_MAP__ instanceof Map&&window.__FMV_ID_TO_NAME_MAP__.size)return window.__FMV_ID_TO_NAME_MAP__;const o=e.extractUserIdsFromTags(t),n=new Map;return"function"!=typeof window.getProfileNameById||await Promise.all(o.map(async e=>{try{const t=await window.getProfileNameById(e);t&&n.set(e,t)}catch{}})),n},e.parseCharactersUnified=e.parseCharactersUnified||function(t,o,n=window.profileLink){const r=String(t||"").trim();if(!r)return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:""};if(!/^\s*user\d+(?:\s*=\s*[^;]+)?(?:\s*;\s*user\d+(?:\s*=\s*[^;]+)?)*\s*$/i.test(r))return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:'<span class="fmv-missing">Ошибка формата! Нужен вид: userN; userM=маска; userM=маска; …</span>'};const s=r.split(/\s*;\s*/).filter(Boolean),i=new Set,a=new Map,c=[];for(const t of s){const[r,s]=t.split("="),l=String(Number((r.match(/user(\d+)/i)||[,""])[1])),u=("user"+l).toLowerCase();i.add(u);const d="function"==typeof n?n(l,o?.get(l)):e.escapeHtml(`user${l}`);if(s){const t=e.normSpace(s);a.has(u)||a.set(u,new Set),a.get(u).add(t.toLowerCase()),c.push(`${d}=${e.escapeHtml(t)}`)}}const l=Array.from(i),u=l.map(t=>{const r=Array.from(a.get(t)||[]),s=String(+t.replace(/^user/i,"")),i="function"==typeof n?n(s,o?.get(s)):e.escapeHtml(`user${s}`);return r.length?`${i} [as ${e.escapeHtml(r.join(", "))}]`:i}).join("; ");return{ok:!0,participantsLower:l,masksByCharLower:a,htmlParticipants:u,htmlMasks:c.join("; "),htmlError:""}},e.renderParticipantsHtml=e.renderParticipantsHtml||function(t,o,n=window.profileLink){const r=e.parseCharactersUnified(t,o,n);if(r&&r.ok)return r.htmlParticipants;const s=e.escapeHtml(String(t??""));return r&&r.htmlError&&r.htmlError.trim()?r.htmlError:`<span class="fmv-missing">Аааа! Нужен формат: userN; userM=маска; userK</span> — ${s}`},window.scrapeUsers=async function(t={}){const o=t.force||!1,n=t.maxPages||1e3,r=t.batchSize||5,s="fmv_users_cache_v2",i=(()=>{if(o)return null;try{const e=sessionStorage.getItem(s);if(!e)return null;const t=JSON.parse(e);return t&&t.time&&t.data?Date.now()-t.time>18e5?null:t.data:null}catch(e){return null}})();if(i)return window.scrapedUsers=i,i;async function a(t){const o=`/userlist.php?p=${t}`;let n;if("function"==typeof window.fetchHtml)n=await window.fetchHtml(o);else{const e=await fetch(o,{credentials:"same-origin"});if(!e.ok)throw new Error(`HTTP ${e.status} (${o})`);n=await e.text()}const r=(new DOMParser).parseFromString(n,"text/html"),s=[];return r.querySelectorAll("td.tcl.username span.usersname").forEach(t=>{const o=t.querySelector("a[href*='id=']"),n=e.normSpace(o?.textContent||""),r=(e=>{if(!e)return null;const t=e.match(/(?:[?&/])id=(\d+)/i);return t?Number(t[1]):null})(o?.getAttribute("href")||"");n&&Number.isFinite(r)&&s.push({id:r,code:"user"+r,name:n})}),s}const c=new Set,l=[];(await a(1)).forEach(e=>{c.has(e.code)||(c.add(e.code),l.push(e))});for(let t=2;t<=n;t+=r){const o=[];for(let e=0;e<r&&t+e<=n;e++)o.push(t+e);const s=await Promise.all(o.map(e=>a(e).catch(()=>[])));let i=!1;for(const e of s){const t=e.filter(e=>!c.has(e.code));t.length>0&&(i=!0,t.forEach(e=>{c.add(e.code),l.push(e)}))}if(!i)break;t+r<=n&&await e.sleep(300)}return l.sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"})),(e=>{try{sessionStorage.setItem(s,JSON.stringify({time:Date.now(),data:e}))}catch(e){}})(l),window.scrapedUsers=l,l},window.fetchProfileInfo=async function(e=window.UserID){if(null==e)throw new Error("UserID не задан (ни аргументом, ни в window.UserID)");const t=`/profile.php?id=${encodeURIComponent(e)}`,n=await fetch(t,{credentials:"same-origin"});if(!n.ok)throw new Error(`HTTP ${n.status} для ${t}`);const r=await n.text(),s=(new DOMParser).parseFromString(r,"text/html"),i=(e,t=s)=>(t.querySelector(e)?.textContent||"").replace(/\u00A0/g," ").trim(),a=e=>{if(!e)return null;const t=String(e).replace(/[^\d+-]/g,"").match(/^[+-]?\d+/);return t?Number(t[0]):null},c=await(async()=>{const e=window.MainUsrFieldResolver?.getFieldValue;if(e)try{return await e({doc:s,fieldId:6})}catch(e){o("[fetchProfileInfo] getFieldValue error:",e)}const t=i("li#pa-fld6 strong");if(t)return t;const n=i("li#pa-fld6");return n?n.split(":").slice(-1)[0].trim():""})(),l=(()=>{const e=a(c);return Number.isFinite(e)?e:0})(),u=i("li#pa-register-date strong"),d=i("li#pa-respect strong"),m=i("li#pa-positive strong"),f=i("li#pa-posts strong");return{id:Number(e),date:(e=>{const t=(e||"").match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);if(!t)return null;const o=Number(t[1]),n=Number(t[2]);return[Number(t[3]),n,o]})(u),respect:a(d),positive:a(m),messages:(p=f,a((p||"").split(" - ")[0])),money:l};var p},window.encodeForSearch=function(e){e=String(e).normalize("NFC");const t=new Map([[160,160],[171,171],[187,187],[8230,133],[8211,150],[8212,151],[8216,145],[8217,146],[8220,147],[8221,148],[183,183],[8470,185],[169,169],[174,174],[8482,153]]),o=new Map([[1028,170],[1108,186],[1030,178],[1110,179],[1031,175],[1111,191],[1168,165],[1169,180]]);let n="";for(const r of e){const e=r.codePointAt(0);let s;s=e<=127?e:e>=1040&&e<=1103?e-1040+192:1025===e?168:1105===e?184:o.has(e)?o.get(e):t.has(e)?t.get(e):8208===e||8722===e||45===e?45:63,n+=32===s?"+":"%"+s.toString(16).toUpperCase().padStart(2,"0")}return n},window.scrapeTopicFirstPostLinks=async function(e,o,{maxPages:n=999,delayMs:r=300,keywords:s=""}={}){if(!e)throw new Error("author обязателен");if(!Array.isArray(o)||0===o.length)throw new Error("forums обязателен и должен быть массивом");const i=o.join(","),a=e,c=String(s??"").trim(),l=o=>{const n=[["action","search"],["keywords",c?encodeForSearch(c.trim()):""],["author",encodeForSearch(e.trim())],["forums",i],["search_in","0"],["sort_by","0"],["sort_dir","DESC"],["show_as","topics"],["search",encodeForSearch("Отправить")],["p",String(o)]].filter(([e,t])=>""!==t).map(([e,t])=>`${e}=${t}`).join("&");return t("[scrapePosts] search params:",`?${n}`),new URL(`/search.php?${n}`,location.origin).toString()};async function u(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),o=await t.text();return(new DOMParser).parseFromString(o,"text/html")}function d(e){for(const t of e.children)if("A"===t.tagName)return t;return null}function m(e){const t=[...e.querySelectorAll(".tclcon")],o=[];for(const e of t){let t=e.querySelector(".byuser-username")?.textContent?.trim();if(!t){const o=e.closest("tr");t=o?.querySelector(".tcr .byuser-username")?.textContent?.trim()||""}if(t!==a)continue;const n=d(e),r=n?.getAttribute("href");r&&o.push(new URL(r,location.href).href)}return o}function f(e){try{const t=new URL(e,location.href);if(("/viewtopic.php"===t.pathname||t.pathname.endsWith("/viewtopic.php"))&&t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}if(t.searchParams.has("id")){const e=new URL("/viewtopic.php",t.origin);return e.searchParams.set("id",t.searchParams.get("id")),e.href}return t.href}catch{return e}}function p(e,t){let o=e.querySelector(".post.topicpost a.permalink");if(o?.getAttribute("href"))return new URL(o.getAttribute("href"),t).href;if(o=e.querySelector(".post.topicpost h3 a[href*='#p']"),o?.getAttribute("href"))return new URL(o.getAttribute("href"),t).href;if(o=e.querySelector(".post.topicpost a[href*='#p']"),o?.getAttribute("href"))return new URL(o.getAttribute("href"),t).href;try{const o=new URL(t).searchParams.get("id");if(o)for(const n of e.querySelectorAll("a[href*='#p']")){const e=new URL(n.getAttribute("href"),t);if(e.pathname.endsWith("/viewtopic.php")&&e.searchParams.get("id")===o)return e.href}}catch{}return null}const w=[...m(await u(l(1)))];await(window.FMV?.sleep?.(r)??new Promise(e=>setTimeout(e,r)));for(let e=2;e<=n;e++){const t=await u(l(e));if(1===Number(t.querySelector("div.linkst div.pagelink strong")?.textContent||1)&&1!==e)break;const o=m(t);if(!o.length)break;w.push(...o),await(window.FMV?.sleep?.(r)??new Promise(e=>setTimeout(e,r)))}const g=[...new Set(w)],y=[];for(const e of g){const t=f(e);try{const e=p(await u(t),t);if(e){const o=e.match(/#p(\d+)/);if(o){const n=o[1],r=new URL(e,t),s=new URL("/viewtopic.php",r.origin);s.searchParams.set("pid",n),y.push(`${s.href}#p${n}`)}else y.push(e)}}catch{}await(window.FMV?.sleep?.(r)??new Promise(e=>setTimeout(e,r)))}return window.__scrapedTopicFirstPosts=y,y},window.scrapePosts=async function(e,i,{stopOnNthPost:a,last_src:c=[],title_prefix:l="",maxPages:u=999,delayMs:d=300,keywords:m="",comments_only:f=!1,min_symbols_num:p=-1}={}){if(!e)throw new Error("author обязателен");if(!i||Array.isArray(i)&&0===i.length)throw new Error("forums обязателен");const w=Array.isArray(i)?i.join(","):String(i),g=String(m??"").trim(),y=String(l||"").trim().toLocaleLowerCase("ru"),h=Array.isArray(c)?c:[c].filter(Boolean),_=new Set(h.map(S));function S(e){try{const t=new URL(e,location.href),o=t.hash&&t.hash.match(/^#p(\d+)$/);if(o){const e=o[1];return`pid=${e}#p${e}`}const n=t.searchParams.get("pid");if(n)return`pid=${n}#p${n}`;const r=t.searchParams.get("p");return r?`pid=${r}#p${r}`:t.toString()}catch{return e}}function b(e){const t=[];for(const o of e.querySelectorAll(".post")){const e=o.querySelector("h3 > span"),n=e?e.querySelectorAll("a"):[],r=n[2]?.getAttribute("href");r&&t.push(new URL(r,location.href).href)}return t}const E=e=>(e=>{let t=0;for(const o of e)t=(t<<5)-t+o.charCodeAt(0),t|=0;return t})(e.join("\n")),k=o=>{t("[scrapePosts] keywords:",`${g}`);const n=[["action","search"],["keywords",g?encodeForSearch(g.trim()):""],["author",encodeForSearch(e.trim())],["forums",w],["search_in","0"],["sort_by","0"],["sort_dir","DESC"],["show_as","posts"],["search",encodeForSearch("Отправить")],["p",String(o)]].filter(([e,t])=>""!==t).map(([e,t])=>`${e}=${t}`).join("&");return t("[scrapePosts] search params:",`?${n}`),new URL(`/search.php?${n}`,location.origin).toString()};async function A(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),o=await t.text();return(new DOMParser).parseFromString(o,"text/html")}function $(e){if("Информация"===(e.querySelector("title")?.textContent||"").trim()){const t=e.querySelector("#pun-main .info .container");if(t&&/ничего не найдено/i.test(t.textContent))return!0}return!1}const I=(e="")=>{const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll(".quote-box.hide-box").forEach(e=>{const t=e.querySelector("blockquote");if(t){const o=document.createElement("div");o.innerHTML=t.innerHTML,e.replaceWith(o)}}),t.querySelectorAll("cite").forEach(e=>e.remove()),t.querySelectorAll(".code-box").forEach(e=>{const t=e.querySelector("pre"),o=t?t.textContent:"",n=document.createElement("div");n.textContent=o||"",e.replaceWith(n)}),t.querySelectorAll(".custom_tag, .hidden_tag, characters, location, order").forEach(e=>e.remove()),t.querySelectorAll('script[type="text/html"]').forEach(e=>{const t=document.createElement("div");t.innerHTML=e.textContent||"",t.querySelectorAll("p, br").forEach(e=>e.insertAdjacentText("afterend","\n"));let o=(t.textContent||"").replace(/\u00A0/g," ").replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");e.insertAdjacentText("beforebegin",o?`\n${o}\n`:""),e.remove()});t.querySelectorAll(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DIV","DL","DT","DD","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","THEAD","TBODY","TFOOT","TR","UL","BR"].join(",")).forEach(e=>{"BR"===e.tagName?e.insertAdjacentText("beforebegin","\n"):e.insertAdjacentText("afterend","\n")});let o=(t.textContent||"").replace(/\u00A0/g," ");o=o.replace(/\[\/?indent\]/gi,"").replace(/\[\/?float(?:=[^\]]+)?\]/gi,"").replace(/\[DiceFM[^\]]*?\]/gi,""),o=o.replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n");const n=[];for(const e of o.split("\n")){const t=e.trim();""===t?n.length&&""!==n[n.length-1]&&n.push(""):n.push(t)}return n.join("\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n").replace(/^\n+|\n+$/g,"").trim()},P=e=>{const t=e.querySelector("h3 > span"),o=t?t.querySelectorAll("a"):[],n=(o[1]?.textContent?.trim()||"").toLocaleLowerCase("ru"),r=o[2]?new URL(o[2].getAttribute("href"),location.href).href:"",s=r?S(r):"",i=o[2]?.innerText?.trim()||"",a=e.getAttribute("data-posted"),c=Number(a),l=e.querySelector(".post-content");let u=l?.innerHTML?.trim()||"";const d=((e="")=>e.replace(/\[html\]([\s\S]*?)\[\/html\]/gi,(e,t)=>I(t)))(u),m=I(d);return{title:n,src:s,text:m,html:u,symbols_num:m.length,date_ts:c,date_text:i}};let M=new Set;if(f&&"function"==typeof window.scrapeTopicFirstPostLinks)try{const t=Array.isArray(i)?i:[i],o=await window.scrapeTopicFirstPostLinks(e,t,{maxPages:u,delayMs:d});M=new Set(o.map(S))}catch(e){o("[scrapePosts] cannot preload first-post links:",e)}const D=e=>{const o=[...e.querySelectorAll(".post")].map(P);r(`[scrapePosts] Найдено ${o.length} постов на странице`);for(const e of o)t("→",e.title,"| символов:",e.symbols_num,"| src:",e.src);s();let n=o.filter(e=>{return t=e.title,!y||t.startsWith(y);var t});r(`[scrapePosts] После фильтрации title_prefix='${l}' → ${n.length} постов`);for(const e of n)t("✓",e.title,"| символов:",e.symbols_num,"| src:",e.src);if(s(),f&&M.size){const e=n.length;n=n.filter(e=>!M.has(e.src)),t(`[scrapePosts] comments_only: исключено ${e-n.length} первых постов тем`)}return n};c&&S(c);const B=void 0!==a&&a>0?a:Number.POSITIVE_INFINITY;return await async function(e){const o=[],n=await A(k(1));if($(n))return C(o);let r=null;for(let s=1;s<=u;s++){const i=1===s?n:await A(k(s));if($(i))return C(o);const a=D(i),c=b(i),l=E(c);if(!c.length&&!i.querySelector(".post"))return C(o);if(null!==r&&l===r)return C(o);r=l;for(const n of a){if(n.symbols_num>p){if(_.size&&_.has(n.src))return t(`[scrapePosts] найден last_src (после фильтра по длине): ${n.src}, остановка`),C(o);if(o.push(n),o.length>=e)return C(o)}}await(window.FMV?.sleep?.(d)??new Promise(e=>setTimeout(e,d)))}return C(o)}(B);function C(e){const o=e.slice().reverse();t(o);try{n(o.map(e=>({title:e.title,src:e.src,symbols_num:e.symbols_num,html:e.html,textPreview:e.text.slice(0,120).replace(/\s+/g," "),date:e.date_ts})))}catch{t(o)}return window.__scrapedPosts=o,o}}}(),function(){"use strict";window.FMV||(window.FMV={}),FMV.fetchUsers=async function(e={}){if("function"!=typeof window.scrapeUsers)throw new Error("window.scrapeUsers не найдена. Убедитесь, что common.js загружен.");return await window.scrapeUsers(e)},FMV.invalidateUsersCache=function(){try{sessionStorage.removeItem("fmv_users_cache_v2"),sessionStorage.removeItem("fmv_users_cache_v1")}catch(e){}}}();const __cp1251Map=(()=>{const e={};for(let t=1040;t<=1103;t++)e[t]=t-848;return e[1025]=168,e[1105]=184,e})();function encodeURIcp1251(e){const t=[];for(const o of String(e)){let e=o.charCodeAt(0);if(void 0!==__cp1251Map[e]&&(e=__cp1251Map[e]),e<=255)e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"));else{const e=`&#${o.charCodeAt(0)};`;for(const o of e){const e=o.charCodeAt(0);e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||45===e||46===e||95===e||126===e?t.push(String.fromCharCode(e)):t.push("%"+e.toString(16).toUpperCase().padStart(2,"0"))}}}return t.join("").replace(/\+/g,"%2B")}function serializeFormCP1251_SelectSubmit(e,t="save"){const o=[];for(const n of Array.from(e.elements||[])){if(!n.name||n.disabled)continue;const e=(n.type||"").toLowerCase();if("submit"!==e&&"button"!==e){if("preview"!==n.name&&("checkbox"!==e&&"radio"!==e||n.checked))if("SELECT"===n.tagName&&n.multiple)for(const e of n.options)e.selected&&o.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(e.value));else o.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value??""))}else n.name===t&&o.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value||""))}return o.join("&")}async function fetchWithRetry(e,t={},o=3,n=1e3){let r;for(let s=0;s<=o;s++)try{const i=await fetch(e,t);if(i.status<500)return i;if(r=new Error(`HTTP ${i.status}`),s===o)throw r;console.warn(`[fetchWithRetry] HTTP ${i.status} для ${e}, повтор ${s+1}/${o} через ${n}мс`),await new Promise(e=>setTimeout(e,n))}catch(t){if(r=t,s===o)throw r;console.warn(`[fetchWithRetry] Ошибка для ${e}: ${t.message}, повтор ${s+1}/${o} через ${n}мс`),await new Promise(e=>setTimeout(e,n))}throw r}async function fetchCP1251Doc(e){const t=await fetchWithRetry(e,{credentials:"include"});if(!t.ok)throw new Error(`GET ${e} → HTTP ${t.status}`);const o=await t.arrayBuffer(),n=new TextDecoder("windows-1251").decode(o);return(new DOMParser).parseFromString(n,"text/html")}async function fetchCP1251Text(e,t){const o=await fetchWithRetry(e,t),n=await o.arrayBuffer();return{res:o,text:new TextDecoder("windows-1251").decode(n)}}function serializeFormCP1251(e){const t=[];for(const o of Array.from(e.elements||[]))if(o.name&&!o.disabled&&("checkbox"!==o.type&&"radio"!==o.type||o.checked))if("SELECT"===o.tagName&&o.multiple)for(const e of o.options)e.selected&&t.push(encodeURIcp1251(o.name)+"="+encodeURIcp1251(e.value));else t.push(encodeURIcp1251(o.name)+"="+encodeURIcp1251(o.value));return t.join("&")}async function fetchHtml(e){const t=await fetchWithRetry(e,{credentials:"include"});if(!t.ok)throw new Error("HTTP "+t.status);const o=await t.arrayBuffer(),n=t.headers.get("content-type")||"",r=(n.match(/charset=([\w-]+)/i)||[])[1]?.toLowerCase();if(r&&"utf-8"!==r)try{return new TextDecoder(r).decode(o)}catch{}const s=new TextDecoder("utf-8").decode(o),i=s.match(/<meta[^>]+charset\s*=\s*["']?([\w-]+)/i)||s.match(/<meta[^>]+content=["'][^"']*charset\s*=\s*([\w-]+)/i),a=(i&&i[1]||"").toLowerCase();if(!r&&a&&"utf-8"!==a)try{return new TextDecoder(a).decode(o)}catch{}const c=new TextDecoder("windows-1251").decode(o),l=/[ÂÃÐÑ][\u0080-\u00FF]?/g,u=e=>({mixed:(e.match(/\b(?:[A-Za-z]+[А-Яа-яЁё]+|[А-Яа-яЁё]+[A-Za-z]+)[A-Za-zА-Яа-яЁё]*\b/g)||[]).length,bad:(e.match(l)||[]).length+(e.match(/\uFFFD/g)||[]).length}),d=u(s),m=u(c);return m.bad>d.bad+3?s:d.bad>m.bad+3||d.mixed>m.mixed+1?c:s}function userLink(e,t="",o=!1){const n=String(e),r=t||`user${n}`,s=(window.SITE_URL||location.origin).replace(/\/+$/,"");return o?`[url=${s}/profile.php?id=${n}]${r}[/url]`:"function"==typeof window.profileLink?window.profileLink(n,r):`<a href="/profile.php?id=${n}">${r}</a>`}function missingUser(e,t=!1){const o=String(e);return t?`[mark]${o}[/mark]`:`<span class="fmv-missing" data-found="0">${o}</span>`}function topicTitleFromCrumbs(e){const t=e.querySelector("#pun-crumbs1 .crumbs")||e.querySelector(".section .crumbs, .container.crumbs, .crumbs");if(!t)return"";for(let e=t.childNodes.length-1;e>=0;e--){const o=t.childNodes[e];if(o)if(3===o.nodeType){const e=o.nodeValue.replace(/\s+/g," ").trim();if(e)return e}else if(1===o.nodeType&&"A"!==o.tagName&&"EM"!==o.tagName){const e=o.textContent.replace(/\s+/g," ").trim();if(e)return e}}return""}function parseFromScriptHTML(e){const t=(new DOMParser).parseFromString(`<div>${e}</div>`,"text/html").body.firstElementChild,o=[];return t.querySelectorAll("p").forEach(e=>{const t=parseParagraph(e);t&&o.push(t)}),o}function parseFromRendered(e){const t=e.querySelectorAll("p");if(t.length)return Array.from(t).map(parseParagraph).filter(Boolean);return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").split(/\n{2,}/).map(e=>{const t=document.createElement("div");return t.innerHTML=`<p>${e}</p>`,parseParagraph(t.firstElementChild)}).filter(Boolean)}function findPostNode(e,t){const o=`p${t}`;let n=e.getElementById(o);if(n)return n;const r=e.querySelector(`a[name="${o}"]`);return r?r.closest(".post")||r.closest(".blockpost")||r.parentElement:(n=e.querySelector(`[id^="p${t}"]`),n)}function textFromNodes(e){return e.map(e=>3===e.nodeType?e.nodeValue||"":1===e.nodeType&&e.textContent||"").join("").replace(/\s+/g," ").trim()}function getCurrentGroupId(){const e=Number(document.body?.dataset?.groupId||NaN),t=Number((window&&window.GroupID)??(window&&window.PUNBB&&window.PUNBB.group_id)??(window&&window.PUNBB&&window.PUNBB.user&&window.PUNBB.user.g_id)??e);return Number.isFinite(t)?t:null}async function ensureAllowed(e){const t=getCurrentGroupId(),o=new Set(e.map(String));return null!==t&&o.has(String(t))}
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */function formatBankText(e){if(!e||!Array.isArray(e.fullData))return"";let t="";"undefined"!=typeof window&&"string"==typeof window.SITE_URL&&(t=window.SITE_URL.trim().replace(/\/+$/,""));const o=["form-income-anketa","form-income-akcion","form-income-needchar","form-income-episode-of","form-income-post-of","form-income-writer","form-income-activist"],n=["form-income-topup","form-income-ams"],r=["form-income-firstpost"],s=["form-income-personalpost","form-income-plotpost"],i=["form-income-flyer"],a=["form-income-100msgs","form-income-100pos","form-income-100rep","form-income-month"],c=["form-income-needrequest","form-income-ep-personal","form-income-ep-plot","form-income-contest","form-income-avatar","form-income-design-other","form-income-run-contest","form-income-mastering","form-income-rpgtop"],l=["form-income-banner-mayak","form-income-banner-reno"],u=["form-exp-face-1m","form-exp-face-3m","form-exp-face-6m","form-exp-char-1m","form-exp-char-3m","form-exp-char-6m","form-exp-face-own-1m","form-exp-face-own-3m","form-exp-face-own-6m","form-exp-need-1w","form-exp-need-2w","form-exp-need-1m"],d=["form-exp-thirdchar"],m=["form-exp-changeapp","form-exp-changechar"],f=["form-exp-refuse"],p=["form-exp-transfer"],w=["form-exp-mask","form-exp-bonus1d1","form-exp-bonus2d1","form-exp-bonus1w1","form-exp-bonus2w1","form-exp-bonus1m1","form-exp-bonus2m1","form-exp-bonus1m3","form-exp-bonus2m3","form-exp-clean"],g=["form-icon-custom","form-icon-present","form-badge-custom","form-badge-present","form-bg-custom","form-bg-present","form-gift-custom","form-gift-present"],y=["price-adjustment"],h=["personal-coupon"],_=["gift-discount"],S=[...o,...n,...r,...s,...i,...a,...c,...l,...u,...d,...m,...f,...p,...w,...g,...y,...h,..._],b=new Map;for(let e=0;e<S.length;e++)b.has(S[e])||b.set(S[e],e);const E=(e,t,o)=>`[b]— ${e}[/b] = ${t}\n[quote]${o.length?o.join("\n"):""}[/quote]`,k=(e,t)=>`[b]— ${e}[/b]\n[quote]${t.length?t.join("\n"):""}[/quote]`,A=e=>{if(!e)return[];try{const t="string"==typeof e?JSON.parse(e):e;return Array.isArray(t)?t:[]}catch{return[]}},$=e=>null!=e&&""!==String(e).trim(),I=e.fullData.filter(e=>b.has(e.form_id)).sort((e,t)=>b.get(e.form_id)-b.get(t.form_id)),P=new Set([...o,...n,...r,...s,...i,...a,...c,...l]),M=new Set([...u,...d,...m,...f,...p,...w,...y,...g]),D=new Set([...w,...g,...y]),B=I.some(e=>P.has(e.form_id)),C=I.findIndex(e=>M.has(e.form_id)),N=-1!==C;let F=-1,T=-1;I.forEach((e,t)=>{D.has(e.form_id)&&(-1===F&&(F=t),T=t)});const L=-1!==F,R=[];B&&R.push("[quote][size=16][b][align=center]ДОХОДЫ[/align][/b][/size][/quote]"),I.forEach((e,c)=>{N&&c===C&&R.push("[quote][size=16][b][align=center]РАСХОДЫ[/align][/b][/size][/quote]"),L&&c===F&&R.push("[hide=99999999]");const S=e?.title??"",b=e?.modalAmount??e?.amount??"";let I;if(o.includes(e.form_id))I=k(S,((e,o)=>{if(!Array.isArray(e))return[];const n=[];let r=1;for(const s of e){const e=s?.data;if(!e||"object"!=typeof e)continue;const i=Object.keys(e).filter(e=>e.startsWith("recipient_"));for(const s of i){const i=e[`recipient_${s.split("_")[1]}`];i&&(n.push(`${r}. ${t}/profile.php?id=${i} — ${o??""}`),r++)}}return n})(e.entries,e.price));else if(n.includes(e.form_id))I=k(S,(e=>{if(!Array.isArray(e))return[];const o=[];let n=1;for(const r of e){const e=r?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((r,i)=>{const a=r.split("_")[1],c=e[`recipient_${a}`],l=e[`amount_${a}`],u=e[`comment_${a}`];if(!c)return;let d=`${n}. ${t}/profile.php?id=${c} — ${l??""}\n`;const m=$(u);m&&(d+=`\n[b]Комментарий:[/b] ${String(u).trim()}\n`),!(i===s.length-1)&&m&&(d+="[hr]\n"),o.push(d),n++})}return o})(e.entries));else if(r.includes(e.form_id))I=((e,t)=>`[b]— ${e}[/b] = ${t}`)(S,b);else if(s.includes(e.form_id)){const t="form-income-personalpost"===e.form_id?"personal":"plot";I=E(S,b,((e,t)=>{if(!Array.isArray(e))return[];const o=[];let n=1;for(const r of e){const e=r?.data||{},s="personal"===t?e.personal_posts_json??e.personalPostsJson:e.plot_posts_json??e.plotPostsJson;for(const e of A(s)){const t=e?.src??"",r=e?.symbols_num??"";o.push(`${n}. ${t} — ${r} символов`),n++}}return o})(e.entries,t))}else I=i.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let o=1;for(const n of e){const e=n?.data||{};for(const n of A(e.flyer_links_json??e.flyerLinksJson)){const e=n?.src??"";t.push(`${o}. ${e}`),o++}}return t})(e.entries)):a.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[],o=(e,t)=>{if(!e)return;const o=String(t).toLowerCase();for(const t of Object.keys(e))if(t.toLowerCase().endsWith(o))return e[t]};for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(!e)continue;const r=o(e,"_old"),s=o(e,"_new"),i=o(e,"_rounded"),a=n?.multiplier;t.push(`[b]Последнее обработанное значение:[/b] ${r??""}`,`[b]Текущее значение:[/b] ${s??""}`,`[b]Условно округленное значение:[/b] ${i??""}`,`[b]Сколько раз начисляем:[/b] ${a??""}`)}return t})(e.entries)):l.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const o of e){const e=o?.data?.url;e&&t.push(`[b]Ссылка:[/b] ${e}`)}return t})(e.entries)):u.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const o of e){const e=o?.data?.quantity;null!=e&&t.push(`[b]Количество[/b]: ${e}`)}return t})(e.entries)):d.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const o of e){const e=o?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const o=e?.url??"";o&&t.push(`[b]Согласование:[/b] ${o}`)}}return t})(e.entries)):m.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const o of e){const e=o?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const o=e?.text??"";""!==o&&t.push(`[b]Новое имя профиля:[/b]\n[code]${o}[/code]`)}}return t})(e.entries)):f.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];for(const o of e){const e=o?.data;if(!e)continue;const n=Array.isArray(e)?e:[e];for(const e of n){const o=e?.comment??"";""!==o&&t.push(`[b]Комментарий:[/b]\n${o}`)}}return t})(e.entries)):p.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const o=[];let n=1;for(const r of e){const e=r?.data;if(e&&"object"==typeof e)for(const r of Object.keys(e))if(r.startsWith("recipient_")){const s=r.split("_")[1],i=e[`recipient_${s}`],a=e[`amount_${s}`];i&&(o.push(`${n}. ${t}/profile.php?id=${i} — ${a??""}`),n++)}}return o})(e.entries)):w.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const o=[];let n=1;for(const r of e){const e=r?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((r,i)=>{const a=r.split("_")[1],c=e[`recipient_${a}`],l=e[`quantity_${a}`],u=e[`from_${a}`],d=e[`wish_${a}`],m=$(u),f=$(d);if(!c)return;let p=`${n}. ${t}/profile.php?id=${c} — ${l??""}\n`;if(m||f){let e="";m&&f?e=`${String(u).trim()}: ${String(d).trim()}`:m?e=String(u).trim():f&&(e=String(d).trim()),p+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}p+=i===s.length-1||!m&&!f?"":"[hr]\n",o.push(p),n++})}return o})(e.entries)):g.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const o=[];let n=1;for(const r of e){const e=r?.data;if(!e||"object"!=typeof e)continue;const s=Object.keys(e).filter(e=>e.startsWith("recipient_"));s.forEach((r,i)=>{const a=r.split("_")[1],c=e[`recipient_${a}`],l=e[`from_${a}`],u=e[`wish_${a}`],d=e[`gift_data_${a}`],m=$(l),f=$(u),p=$(d);if(!c)return;let w=`${n}. ${t}/profile.php?id=${c}\n`;if(m||f){let e="";m&&f?e=`${String(l).trim()}: ${String(u).trim()}`:m?e=String(l).trim():f&&(e=String(u).trim()),w+=`\n[b]Комментарий:[/b]\n[code]${e}[/code]`}p&&(w+=`\n[b]Данные:[/b]\n${String(d)}\n`),w+=i!==s.length-1&&(m||f||p)?"[hr]\n":"",o.push(w),n++})}return o})(e.entries)):y.includes(e.form_id)?k(S,(e=>{if(!Array.isArray(e))return[];const t=[];let o=1;for(const n of e){const e=n?.data;if(!e){o++;continue}const r=Array.isArray(e)?e:[e];for(const e of r){const n=e?.adjustment_title??"",r=e?.adjustment_amount??"";t.push(`${o}. [b]${n}:[/b] -${r}`)}o++}return t})(e.entries)):h.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let o=1;for(const n of e){const e=n?.data;if(!e){o++;continue}const r=Array.isArray(e)?e:[e];for(const e of r){const n=e?.coupon_title??"",r=e?.discount_amount??"";t.push(`${o}. [b]${n}:[/b] ${r}`)}o++}return t})(e.entries)):_.includes(e.form_id)?E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let o=1;for(const n of e){const e=n?.data;if(!e){o++;continue}const r=Array.isArray(e)?e:[e];for(const e of r){const n=e?.discount_title??"",r=e?.discount_amount??"";t.push(`${o}. [b]${n}:[/b] ${r}`)}o++}return t})(e.entries)):E(S,b,(e=>{if(!Array.isArray(e))return[];const t=[];let o=1;for(const n of e){const e=n&&n.data&&"object"==typeof n.data?n.data:null;if(e)for(const n of Object.keys(e))t.push(`${o}. ${e[n]}`),o++}return t})(e.entries));R.push(I),L&&c===T&&R.push("[/hide]")});let v=R.join("\n\n");if(void 0!==e.totalSum&&null!==e.totalSum&&""!==e.totalSum){v+=`\n\n[quote][size=16][align=center][b]ИТОГО:[/b] [color=${Number(e.totalSum)<0?"red":"green"}]${Number(e.totalSum)>0?"+":""}${e.totalSum}[/color][/align][/size][/quote]`}return""!==e.environment.COMMENT_ID&&null!==e.environment.COMMENT_ID&&"undefined"!==e.environment.COMMENT_ID&&void 0!==e.environment.COMMENT_ID&&""!==e.editLogs&&null!==e.editLogs&&"undefined"!==e.editLogs&&void 0!==e.editLogs&&(v+=`\n\n[hide=9999999999][b]Комментарий администратора:[/b]\n${e.editLogs}[/hide]`),v}function encodeJSON(e){const t=JSON.stringify(e),o=(new TextEncoder).encode(t),n=Array.from(o,e=>String.fromCharCode(e)).join("");return btoa(n)}function decodeJSON(e){const t=atob(e),o=Uint8Array.from(t,e=>e.charCodeAt(0)),n=(new TextDecoder).decode(o);return JSON.parse(n)}function getBlockquoteTextAfterPersonalPost(e,t,o=""){const n=Array.from(e.querySelectorAll("p > strong")).map(e=>e.closest("p")).find(e=>e&&e.querySelector("strong")?.textContent?.includes(t));if(!n)return null;let r=null;for(let e=n.nextElementSibling;e&&"p"!==e.tagName?.toLowerCase();e=e.nextElementSibling){const t=e.matches?.("blockquote")?e:e.querySelector?.("blockquote");if(t){r=t;break}}return r?"last_value"===o?function(t=e){const o=Array.from(t.querySelectorAll("strong")).find(e=>e.textContent.trim().startsWith("Условно округленное значение:"));if(!o)return null;const n=[];for(let e=o.nextSibling;e&&(e.nodeType!==Node.ELEMENT_NODE||"strong"!==e.tagName?.toLowerCase());e=e.nextSibling)e.nodeType===Node.TEXT_NODE?n.push(e.nodeValue):e.nodeType===Node.ELEMENT_NODE&&n.push(e.textContent);return n.join(" ").replace(/\s+/g," ").trim()||null}(r):"link"===o?Array.from(r.querySelectorAll("a")).map(e=>e.getAttribute("href")).filter(Boolean):r.innerHTML.trim():null}function getBlockquoteTextFromHtml(e,t,o=""){return getBlockquoteTextAfterPersonalPost((new DOMParser).parseFromString(e,"text/html"),t,o)}async function fetchDesignItems(e,t){const o=`${location.origin.replace(/\/$/,"")}/viewtopic.php?id=${encodeURIComponent(String(e))}`,n=e=>{const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""},r="function"==typeof window.fetchHtml?await window.fetchHtml(o):await(async()=>{const e="function"==typeof window.fetchWithRetry?window.fetchWithRetry:fetch;return(await e(o,{credentials:"include"})).text()})(),s=(new DOMParser).parseFromString(r,"text/html"),i=[];for(const e of t){const t=s.querySelector(`#p${String(e)}-content`);if(!t){console.warn(`Не найден #p${e}-content на ${o}`);continue}const r=[...t.querySelectorAll('script[type="text/html"]')];if(!r.length)continue;const a=n(r.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," "),c=[...(new DOMParser).parseFromString(a,"text/html").querySelectorAll("#grid article.card:not(.hidden)")].map(e=>({id:FMV.normSpace(e.querySelector(".id")?.textContent||""),icon:(e.querySelector(".content")?.innerHTML||"").replace(/\u00A0/g," ").trim()}));i.push(...c)}return i}async function fetchLibraryItems(){const e=["icon","plashka","background","gift","coupon"],t={plashka:[],icon:[],back:[],gift:[],coupon:[]};for(const o of e)try{const e=await window.FMVbank.storageGet(1,`library_${o}_`);if(!e||!e.items||!Array.isArray(e.items)){console.warn(`[fetchLibraryItems] library_${o}_1 не найдена или пуста`);continue}if("coupon"===o)t.coupon=e.items.map(e=>{const t={id:e.id,icon:e.content||""};return e.s_t&&(t.system_title=e.s_t),e.type&&(t.type=e.type),e.f&&(t.form=e.f),void 0!==e.v&&(t.value=e.v),t});else{const n=e.items.map(e=>{const t={id:e.id,icon:e.content||""};return void 0!==e.h&&(t.hidden=1===e.h),void 0!==e.c&&(t.custom=1===e.c),void 0!==e.s&&(t.system=1===e.s),t});t["background"===o?"back":o]=n}}catch(e){console.error(`[fetchLibraryItems] Ошибка загрузки ${o}:`,e)}return t}window.parseChronoTagsRaw=function(e){const t=t=>e.querySelector(t)?.textContent.trim()||"",o=t("characters"),n=t("masks"),r=(o?o.split(/\s*;\s*/):[]).map(e=>e.trim().toLowerCase()).filter(Boolean),s={};(n||"").split(/\s*;\s*/).forEach(e=>{const t=e.indexOf("=");t>0&&(s[e.slice(0,t).trim().toLowerCase()]=e.slice(t+1).trim())});const i=new Set(r);return Object.keys(s).forEach(e=>i.add(e)),{participantsLower:Array.from(i),masks:s,location:t("location"),order:t("order")}},window.resolveChronoData=async function(e,t={}){const o={...e,idToName:new Map,participantsHtml:"",masksHtml:""},n=new Set;for(const t of e.participantsLower){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const t of Object.keys(e.masks||{})){const e=/^user(\d+)$/i.exec(t);e&&n.add(String(+e[1]))}for(const e of n)try{o.idToName.set(e,await getProfileNameById(e)||null)}catch{o.idToName.set(e,null)}const r=e=>{const t=/^user(\d+)$/i.exec(e);if(!t)return window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml(e):e;const n=String(+t[1]),r=o.idToName.get(n)||null;return profileLink(n,r)},s=window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml:e=>e;return o.participantsHtml=e.participantsLower.map(r).join("; "),o.masksHtml=Object.entries(e.masks||{}).map(([e,t])=>`${r(e)}=${s(t)}`).join("; "),o},function(){"use strict";window.FMV=window.FMV||{},FMV.escapeHtmlShort=FMV.escapeHtmlShort||function(e="",t=500){const o=String(e),n=o.length>t?o.slice(0,t)+"…":o;return"function"==typeof FMV.escapeHtml?FMV.escapeHtml(n):n},FMV.fetchDoc=FMV.fetchDoc||async function(e){const t=await fetchHtml(e);return"function"==typeof window.parseHTML?window.parseHTML(t):(new DOMParser).parseFromString(t,"text/html")},FMV.toCp1251Entities=FMV.toCp1251Entities||function(e){const t=/[\u0000-\u007F\u0400-\u045F\u0401\u0451]/;let o="";for(const n of String(e))o+=t.test(n)?n:`&#${n.codePointAt(0)};`;return o},window.fetchWithRetry=window.fetchWithRetry||fetchWithRetry}(),(()=>{"use strict";const e=window.MAKE_NAMES_LINKS??!0;const t=window.fetchHtml||(async e=>{const t=await fetch(e,{credentials:"include"});return await t.text()});window.profileLink=function(t,o){const n=String(Number(t));if(!("string"==typeof o&&o.trim().length>0)){const e=`user${n}`;return`<span class="fmv-missing" data-user-id="${n}" data-found="0">${FMV.escapeHtml(e)}</span>`}const r=FMV.escapeHtml(o.trim());if(!e)return r;const s=document.createElement("a");return s.className="fmv-user",s.href="/profile.php?id="+encodeURIComponent(n),s.textContent=r,s.setAttribute("data-user-id",n),s.setAttribute("data-found","1"),s.outerHTML},window.profileLinkMeta=function(e,t){const o=window.profileLink(e,t),n="string"==typeof o&&!/\bfmv-missing\b/.test(o);return{html:String(o||""),found:n,id:String(Number(e)),name:"string"==typeof t&&t.trim()?t.trim():null}};const o=new Map;let n=null,r=null;async function s(e){const o=await async function(){if(n)return n;if(r)return r;if(!window.EX_PROFILES||"object"!=typeof window.EX_PROFILES)return console.error("[loadExProfiles] Ошибка: window.EX_PROFILES не задан или имеет неверный формат"),n=new Map,n;const{topicID:e,commentID:o}=window.EX_PROFILES;if(null==e||null==o)return console.error("[loadExProfiles] Ошибка: отсутствует topicID или commentID в window.EX_PROFILES"),n=new Map,n;const s=`/viewtopic.php?id=${encodeURIComponent(e)}#p${encodeURIComponent(o)}`;return r=(async()=>{const e=await t(s),o=(new DOMParser).parseFromString(e,"text/html"),r=new Map;for(const e of o.querySelectorAll('a[href*="profile.php?id="]')){const t=(e.getAttribute("href")||"").match(/profile\.php\?id=(\d+)/i);if(!t)continue;const o=String(Number(t[1])),n=(e.textContent||"").trim().toLowerCase();n&&!r.has(o)&&r.set(o,n)}return n=r,r})(),r}();return o.get(String(Number(e)))||null}async function i(e){if(e=String(Number(e)),o.has(e))return o.get(e);let n=function(e){const t=Array.from(document.querySelectorAll(`a[href*="profile.php?id=${e}"]`));for(const e of t){const t=(e.textContent||"").trim();if(t&&!/Профил|Profile/i.test(t))return t}return null}(e);if(!n)try{const o=await t(`/profile.php?id=${e}`);n=function(e){const t=e.querySelector(".user-ident .username")||e.querySelector(".user-box .username")||null;if(t){const e=(t.textContent||"").trim();if(e)return e}const o=["#pun-title span","h1 span","h1","h2.hn",".hn",".title",".subhead h2"].map(t=>e.querySelector(t)).filter(Boolean).map(e=>(e.textContent||"").trim()).filter(Boolean),n=(e.querySelector("title")?.textContent||"").trim();n&&o.unshift(n);const r=[/Профил[ья]\s*[:\-—–]\s*(.+)$/i,/Просмотр\s+профиля\s*[:\-—–]\s*(.+)$/i,/Profile\s*[:\-—–]\s*(.+)$/i];for(let e of o){e=e.replace(/\s+/g," ").trim();for(const t of r){const o=e.match(t);if(o){const e=o[1].trim().replace(/^[«"'\\[]|[»"'\\]]$/g,"").trim();if(e)return e}}}return null}((new DOMParser).parseFromString(o,"text/html"))}catch{}if(!n)try{const t=await s(e);t&&(n=`[ex] ${t}`)}catch{}return o.set(e,n||null),n||null}window.profileLinkByIdAsync=async function(e){const t=String(Number(e)),o=await i(t);return window.profileLinkMeta(t,o)},window.extractUserIdsFromString=function(e){const t=new Set;return(e||"").replace(/user(\d+)/gi,(e,o)=>(t.add(String(Number(o))),e)),Array.from(t)},window.getProfileNameById=i})(),function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,o=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),n=/^\s*main:\s*usr(\d+)\s*$/i,r=e=>`#${o(e)}, .${o(e)}`,s=new TextDecoder("utf-8");let i;async function a(e){const t=await fetch(e,{credentials:"same-origin"}),o=await t.arrayBuffer();let n=s.decode(o);if(/charset\s*=\s*windows-1251/i.test(n)||n.includes("�"))try{n=(i||=new TextDecoder("windows-1251")).decode(o)}catch{}return n}function c(e,t){const o=e.querySelector(r(t)),n=o?.querySelector("strong, b");let s=n?.textContent?.trim();if(!s){const e=(o?.textContent||"").trim();s=e.split(":").slice(-1)[0]?.trim()}return(s||"").replace(/\u00A0/g," ").trim()}const l=new Map;function u(e,t){if(l.has(e))return l.get(e);const o=(async()=>{const o=await a(`/profile.php?id=${encodeURIComponent(e)}`);return c((new DOMParser).parseFromString(o,"text/html"),t)})();return l.set(e,o),o}function d(){document.querySelectorAll(r(t)).forEach(e=>function(e,t){const o=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),r=[];for(let e;e=o.nextNode();){const t=(e.nodeValue||"").match(n);t&&r.push({node:e,uid:t[1]})}r.forEach(({node:e,uid:o})=>{u(o,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+o,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:o}={}){const s=`pa-fld${String(o??e).replace(/\D/g,"")||e}`,i=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(n);if(t)return t[1]}return null}(t.querySelector(r(s)));if(i)try{return await u(i,s)}catch(e){console.warn("[main-field] remote error:",e)}return c(t,s)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d,{once:!0}):d()}(),(()=>{"use strict";const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});window.createForumButton=async function(t){const{allowedGroups:o=[],allowedForums:n=[],allowedUsers:r=[],label:s="Действие",onClick:i,containerSelector:a=".ams_info",order:c=0,showStatus:l=!0,showDetails:u=!0,showLink:d=!0,topicId:m=null}=t||{};if(console.log(`[createForumButton] Вызов для "${s}":`,{allowedGroups:o,allowedForums:n,allowedUsers:r,containerSelector:a}),"function"!=typeof i)return void console.log(`[createForumButton] "${s}": onClick не функция, выход`);await async function(){await e,window.__ams_ready||await new Promise(e=>window.addEventListener("ams:ready",e,{once:!0}))}(),console.log(`[createForumButton] "${s}": AMS готов`);const f="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log(`[createForumButton] "${s}": текущая группа = ${f}, разрешённые = [${o}]`),!Array.isArray(o)||0===o.length)return void console.log(`[createForumButton] "${s}": allowedGroups пустой, выход`);if(!o.map(Number).includes(Number(f)))return void console.log(`[createForumButton] "${s}": группа ${f} не в списке, выход`);if(console.log(`[createForumButton] "${s}": проверка группы пройдена`),!Array.isArray(n)||0===n.length)return void console.log(`[createForumButton] "${s}": allowedForums пустой, выход`);if(!function(e){const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))}(n))return void console.log(`[createForumButton] "${s}": форум не разрешён, выход`);if(console.log(`[createForumButton] "${s}": проверка форума пройдена`),Array.isArray(r)&&r.length>0){const e=Number(window.UserID);if(console.log(`[createForumButton] "${s}": текущий UserID = ${e}, разрешённые = [${r}]`),!r.map(Number).includes(e))return void console.log(`[createForumButton] "${s}": пользователь ${e} не в списке, выход`)}if(console.log(`[createForumButton] "${s}": проверка пользователей пройдена`),!function(e){if(null==e)return!0;const t=String(e).trim();if(!t)return!1;try{const e=new URL(location.href);return!!e.pathname.includes("viewtopic.php")&&(e.searchParams.get("id")||"").trim()===t}catch{return!1}}(m))return void console.log(`[createForumButton] "${s}": topicId не совпадает, выход`);console.log(`[createForumButton] "${s}": ищем контейнер "${a}"`);const p=await FMV.waitForSelector(a,5e3).catch(()=>null);if(!p)return void console.log(`[createForumButton] "${s}": контейнер "${a}" не найден, выход`);console.log(`[createForumButton] "${s}": контейнер найден, создаём кнопку`);const w=document.createElement("br"),g=document.createElement("div");g.dataset.order=c;const y=document.createElement("button");y.type="button",y.className="button",y.textContent=s;const h=l?document.createElement("span"):null;h&&(h.style.marginLeft="10px",h.style.fontSize="14px",h.style.color="#555");const _=d?document.createElement("a"):null;_&&(_.className="fmv-action-link",_.target="_blank",_.rel="noopener",_.style.marginLeft="10px",_.style.fontSize="14px",_.style.display="none");const S=u?document.createElement("details"):null;let b=null;if(S){S.style.marginTop="6px";const e=document.createElement("summary");e.textContent="Показать детали",e.style.cursor="pointer",b=document.createElement("pre"),b.style.whiteSpace="pre-wrap",b.style.margin="6px 0 0",b.style.fontSize="12px",S.appendChild(e),S.appendChild(b)}g.appendChild(y),h&&g.appendChild(h),_&&g.appendChild(_),S&&g.appendChild(S),p.appendChild(w);const E=Array.from(p.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>Number(c));E?p.insertBefore(g,E):p.appendChild(g);const k=(e,t="#555")=>{h&&(h.textContent=e,h.style.color=t)},A=(e="")=>{if(!b)return;const t=String(e||"");t.includes("<")&&t.includes(">")?b.innerHTML=t:b.textContent=t},$=(e,t="Открыть")=>{_&&(e?(_.href=e,_.textContent=t,_.style.display="inline"):(_.style.display="none",_.textContent="",_.removeAttribute("href")))};y.addEventListener("click",async()=>{l&&k("Выполняю…","#555"),u&&A(""),d&&$(null);try{await i({statusEl:h||null,linkEl:_||null,detailsEl:b||null,setStatus:k,setDetails:A,setLink:$,wrap:g})}catch(e){l&&k("✖ Ошибка","red"),u&&A(e&&e.message?e.message:String(e)),console.error("[createForumButton]",e)}})}})(),document.addEventListener("DOMContentLoaded",()=>{if(!document.title.startsWith("Гринготтс"))return;const e=document.getElementById("post-form"),t=document.querySelector('#post-form input[id="fld10"]');e&&!t&&(e.style.display="none");const o=window.BANK_CHECK?.UserID||[],n=Number(window.UserID);if(o.length>0&&o.map(Number).includes(n)){let e=0;document.querySelectorAll("div.post").forEach(t=>{if(t.classList.contains("topicpost"))return;const o=t.querySelector(".post-content");if(!o)return;if(!o.querySelector("bank_ams_done")&&!o.querySelector(".ams_info")){const t=document.createElement("div");t.className="ams_info",o.appendChild(t),e++}}),console.log(`[gringotts_page_update] .ams_info создано для UserID=${n}: ${e}`)}else console.log(`[gringotts_page_update] UserID=${n} не в списке allowedUsers=[${o}], .ams_info не создаётся`);document.querySelectorAll("div.post").forEach(async e=>{try{const t=e.querySelector(".pl-edit a");if(!t)return;if(!e||e.classList.contains("topicpost"))return;const o=e.querySelector(".pl-email.profile a"),n=o?new URL(o.href):void 0,r=n?Number(n.searchParams.get("id")):0,s=e.querySelector("bank_data"),i=s?Number(s.textContent.trim()):0;let a=0;try{const e=new URL(t.href);a=Number(e.searchParams.get("id"))||0}catch(e){console.warn("Не удалось извлечь comment_id из href:",e)}let c=0;try{const t=`pa-fld${window.PROFILE_FIELDS?.MoneyID||0}`,o=e.querySelector(`.${t}`);if(o){const e=document.createTreeWalker(o,NodeFilter.SHOW_COMMENT);let t=!1;const n=/^\s*main:\s*usr(\d+)\s*$/i;for(let o;o=e.nextNode();){if((o.nodeValue||"").match(n)){if(t=!0,window.MainUsrFieldResolver?.getFieldValue)try{const e=await window.MainUsrFieldResolver.getFieldValue({doc:document,fieldId:window.PROFILE_FIELDS?.MoneyID||0});c=Number(e)||0}catch(e){console.warn("Ошибка получения значения через MainUsrFieldResolver:",e),c=0}break}}if(!t){const e=o.querySelector("span.fld-name");let t=o.textContent||"";e&&(t=t.replace(e.textContent,"")),t=t.replace(/\u00A0/g," ").trim();const n=t.match(/-?\d+(?:\.\d+)?/);n&&(c=Number(n[0])||0)}}else c=0}catch(e){console.warn("Не удалось извлечь current_bank:",e)}t.removeAttribute("href"),t.removeAttribute("rel"),t.setAttribute("onclick",`bankCommentEditFromBackup(${r}, ${i}, ${a}, ${c})`)}catch(e){console.error("Ошибка при обработке контейнера:",e)}}),window.__gringotts_ready=!0,window.dispatchEvent(new CustomEvent("gringotts:ready")),console.log("[gringotts_page_update] Событие gringotts:ready отправлено, флаг установлен")}),function(){"use strict";if(!document.title.startsWith("Гринготтс"))return;const e="[FMVbankAmsCheck]",t=(window.SITE_URL||location.origin).replace(/\/+$/,"");async function o(o,{setStatus:n,setDetails:r}){try{n("⏳ Загрузка...");const s=document.createElement("iframe");s.style.display="none",s.src=`${t}/edit.php?id=${o}`,document.body.appendChild(s),await new Promise((e,t)=>{s.onload=e,s.onerror=()=>t(new Error("Не удалось загрузить страницу редактирования")),setTimeout(()=>t(new Error("Таймаут загрузки страницы редактирования")),1e4)});const i=s.contentDocument||s.contentWindow.document,a=i.querySelector('textarea[name="req_message"]'),c=i.querySelector('input[type="submit"].button.submit[name="submit"][value="Отправить"][accesskey="s"]');if(!a||!c)throw new Error("Не найдена форма редактирования");const l=c.closest("form");l&&(l.removeAttribute("target"),console.log("[START_AMS_CHECK] Удалён атрибут target из формы"));const u=a.value||"";u.includes(e)?r(`Тег ${e} уже присутствует`):(a.value=e+u,r(`Тег ${e} добавлен`)),n("⏳ Отправка...");let d=null,m=!1;const f=setInterval(()=>{try{const e=s.contentWindow.location.href;e.includes("/viewtopic.php?")&&(d=e,m=!0)}catch(e){}},500);if(setTimeout(()=>{clearInterval(f),m||s.remove()},1e4),c.click(),await new Promise(e=>{const t=setInterval(()=>{m&&(clearInterval(t),clearInterval(f),e())},100);setTimeout(()=>{clearInterval(t),e()},1e4)}),s.remove(),m)return n("✅ Проверка запущена"),r(`Комментарий ${o} обновлён`),{success:!0,redirectUrl:d,commentId:o};throw new Error("Не удалось обнаружить редирект после отправки")}catch(e){return n("❌ Ошибка"),r(e.message),{success:!1,error:e.message}}}async function n(e){const{allowedGroups:t=[],allowedForums:o=[],allowedUsers:n=[],label:r="Действие",onClick:s,containerSelector:i=".ams_info",order:a=0,postSelector:c="div.post",showStatus:l=!0,showDetails:u=!0}=e||{};if(console.log(`[createPostButtons] "${r}": Вызов с параметрами:`,{allowedGroups:t,allowedForums:o,allowedUsers:n,containerSelector:i,postSelector:c}),!document.title.startsWith("Гринготтс"))return void console.log(`[createPostButtons] "${r}": Страница не Гринготтс, выход`);if("function"!=typeof s)return void console.log(`[createPostButtons] "${r}": onClick не функция, выход`);window.__gringotts_ready?console.log(`[createPostButtons] "${r}": gringotts уже готов (флаг установлен)`):(console.log(`[createPostButtons] "${r}": Ждём события gringotts:ready`),await new Promise(e=>window.addEventListener("gringotts:ready",e,{once:!0}))),console.log(`[createPostButtons] "${r}": Продолжаем работу`);const d="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log(`[createPostButtons] "${r}": текущая группа = ${d}, разрешённые = [${t}]`),!Array.isArray(t)||0===t.length)return void console.log(`[createPostButtons] "${r}": allowedGroups пустой, выход`);if(!t.map(Number).includes(Number(d)))return void console.log(`[createPostButtons] "${r}": группа ${d} не в списке, выход`);if(console.log(`[createPostButtons] "${r}": проверка группы пройдена`),!Array.isArray(o)||0===o.length)return void console.log(`[createPostButtons] "${r}": allowedForums пустой, выход`);if(!(e=>{const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))})(o))return void console.log(`[createPostButtons] "${r}": форум не разрешён, выход`);if(console.log(`[createPostButtons] "${r}": проверка форума пройдена`),Array.isArray(n)&&n.length>0){const e=Number(window.UserID);if(console.log(`[createPostButtons] "${r}": текущий UserID = ${e}, разрешённые = [${n}]`),!n.map(Number).includes(e))return void console.log(`[createPostButtons] "${r}": пользователь ${e} не в списке, выход`)}console.log(`[createPostButtons] "${r}": проверка пользователей пройдена`);const m=document.querySelectorAll(c);console.log(`[createPostButtons] "${r}": Найдено постов по селектору "${c}":`,m.length);let f=0;m.forEach((e,t)=>{const o=e.querySelector(".post-content");if(!o)return void console.log(`[createPostButtons] "${r}": Пост ${t}: нет .post-content, пропуск`);const n=o.querySelector("bank_ams_check"),c=o.querySelector("bank_ams_done");if(n||c)return void console.log(`[createPostButtons] "${r}": Пост ${t}: есть bank_ams_check или bank_ams_done, пропуск`);const d=o.querySelector(i);if(!d)return void console.log(`[createPostButtons] "${r}": Пост ${t}: контейнер "${i}" не найден, пропуск`);if(d.querySelector(`[data-post-button-label="${r}"]`))return void console.log(`[createPostButtons] "${r}": Пост ${t}: кнопка уже добавлена, пропуск`);const m=function(e){const t=e.querySelector(".pl-edit a");if(!t)return 0;try{const e=new URL(t.href);return Number(e.searchParams.get("id"))||0}catch(e){return 0}}(e);if(!m)return void console.log(`[createPostButtons] "${r}": Пост ${t}: не удалось получить commentId, пропуск`);console.log(`[createPostButtons] "${r}": Пост ${t}: добавляем кнопку для комментария ${m}`);const p=document.createElement("div");p.dataset.order=a,p.dataset.postButtonLabel=r;const w=document.createElement("button");w.type="button",w.className="button",w.textContent=r;const g=l?document.createElement("span"):null;g&&(g.style.marginLeft="10px",g.style.fontSize="14px",g.style.color="#555");const y=u?document.createElement("details"):null;let h=null;if(y){y.style.marginTop="6px";const e=document.createElement("summary");e.textContent="Показать детали",e.style.cursor="pointer",h=document.createElement("pre"),h.style.whiteSpace="pre-wrap",h.style.margin="6px 0 0",h.style.fontSize="12px",y.appendChild(e),y.appendChild(h)}p.appendChild(w),g&&p.appendChild(g),y&&p.appendChild(y);const _=Array.from(d.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>Number(a));_?d.insertBefore(p,_):d.appendChild(p);const S=(e,t="#555")=>{g&&(g.textContent=e,g.style.color=t)},b=(e="")=>{h&&(h.textContent=String(e||""))};w.addEventListener("click",async()=>{l&&S("Выполняю…","#555"),u&&b("");try{await s({commentId:m,post:e,statusEl:g||null,detailsEl:h||null,setStatus:S,setDetails:b,wrap:p})}catch(e){l&&S("✖ Ошибка","red"),u&&b(e&&e.message?e.message:String(e))}}),f++}),console.log(`[createPostButtons] "${r}": Добавлено кнопок: ${f}`)}async function r(){await n({allowedGroups:window.BANK_CHECK?.GroupID||[],allowedForums:window.BANK_CHECK?.ForumID||[],allowedUsers:window.BANK_CHECK?.UserID||[],label:"Начать проверку",order:1,containerSelector:".ams_info",postSelector:"div.post",onClick:async({commentId:e,post:t,setStatus:n,setDetails:r,wrap:s})=>{const i=await o(e,{setStatus:n,setDetails:r});if(i&&i.success){console.log("[START_AMS_CHECK] Успешно! Обновляем DOM без перезагрузки");const e=t.querySelector("div.post-content");if(e){const t=document.createElement("bank_ams_check");e.appendChild(t),console.log("[START_AMS_CHECK] Добавлен тег bank_ams_check в DOM")}s&&(s.remove(),console.log('[START_AMS_CHECK] Удалена кнопка "Начать проверку"')),window.dispatchEvent(new CustomEvent("bank:buttons:refresh"))}}})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r(),window.startAmsCheck=o,window.createPostButtons=n}(),function(){"use strict";async function e(e){const t=e.querySelector(".pl-email.profile a"),o=t?new URL(t.href):null,n=o&&Number(o.searchParams.get("id"))||0,r=e.querySelector("bank_data"),s=r&&Number(r.textContent.trim())||0;let i=0;const a=e.querySelector("h3 span .permalink");if(a&&a.href)try{const e=new URL(a.href).hash;e&&e.startsWith("#p")&&(i=Number(e.substring(2))||0)}catch(e){console.warn("[adminEdit] Не удалось извлечь comment_id из permalink:",e)}let c=0;try{const t=`pa-fld${window.PROFILE_FIELDS?.MoneyID||0}`,o=e.querySelector(`.${t}`);if(o){const e=document.createTreeWalker(o,NodeFilter.SHOW_COMMENT);let t=!1;const n=/^\s*main:\s*usr(\d+)\s*$/i;for(let o;o=e.nextNode();){if((o.nodeValue||"").match(n)){if(t=!0,window.MainUsrFieldResolver?.getFieldValue)try{const e=await window.MainUsrFieldResolver.getFieldValue({doc:document,fieldId:window.PROFILE_FIELDS?.MoneyID||0});c=Number(e)||0}catch(e){console.warn("Ошибка получения значения через MainUsrFieldResolver:",e),c=0}break}}if(!t){const e=o.querySelector("span.fld-name");let t=o.textContent||"";e&&(t=t.replace(e.textContent,"")),t=t.replace(/\u00A0/g," ").trim();const n=t.match(/-?\d+(?:\.\d+)?/);n&&(c=Number(n[0])||0)}}}catch(e){console.warn("[adminEdit] Не удалось извлечь current_bank:",e)}return{usr_id:n,ts:s,comment_id:i,current_bank:c}}async function t(t){const{allowedGroups:o=[],allowedForums:n=[],allowedUsers:r=[],label:s="Внести правки",containerSelector:i=".ams_info",order:a=2,postSelector:c="div.post",showStatus:l=!0,showDetails:u=!0}=t||{};if(console.log(`[adminEdit] "${s}": Вызов с параметрами:`,{allowedGroups:o,allowedForums:n,allowedUsers:r}),!document.title.startsWith("Гринготтс"))return void console.log(`[adminEdit] "${s}": Страница не Гринготтс, выход`);window.__gringotts_ready?console.log(`[adminEdit] "${s}": gringotts уже готов`):(console.log(`[adminEdit] "${s}": Ждём события gringotts:ready`),await new Promise(e=>window.addEventListener("gringotts:ready",e,{once:!0})));const d="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log(`[adminEdit] "${s}": текущая группа = ${d}, разрешённые = [${o}]`),!Array.isArray(o)||0===o.length)return void console.log(`[adminEdit] "${s}": allowedGroups пустой, выход`);if(!o.map(Number).includes(Number(d)))return void console.log(`[adminEdit] "${s}": группа ${d} не в списке, выход`);if(!Array.isArray(n)||0===n.length)return void console.log(`[adminEdit] "${s}": allowedForums пустой, выход`);if(!(e=>{const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))})(n))return void console.log(`[adminEdit] "${s}": форум не разрешён, выход`);if(Array.isArray(r)&&r.length>0){const e=Number(window.UserID);if(console.log(`[adminEdit] "${s}": текущий UserID = ${e}, разрешённые = [${r}]`),!r.map(Number).includes(e))return void console.log(`[adminEdit] "${s}": пользователь ${e} не в списке, выход`)}const m=document.querySelectorAll(c);console.log(`[adminEdit] "${s}": Найдено постов: ${m.length}`);let f=0;for(let t=0;t<m.length;t++){const o=m[t];if(o.classList.contains("topicpost"))continue;const n=o.querySelector(".post-content");if(!n)continue;const r=n.querySelector("bank_ams_check"),c=n.querySelector("bank_ams_done");if(!r||c){console.log(`[adminEdit] "${s}": Пост ${t}: hasAmsCheck=${!!r}, hasAmsDone=${!!c}, пропуск`);continue}const d=n.querySelector(i);if(!d)continue;if(d.querySelector(`[data-post-button-label="${s}"]`))continue;const p=await e(o);console.log(`[adminEdit] "${s}": Пост ${t}: getPostData вернул:`,p);const{usr_id:w,ts:g,comment_id:y,current_bank:h}=p;if(!w||!g||!y){console.log(`[adminEdit] "${s}": Пост ${t}: проверка не прошла - usr_id=${w}, ts=${g}, comment_id=${y}`);continue}console.log(`[adminEdit] "${s}": Пост ${t}: данные OK - usr_id=${w}, ts=${g}, comment_id=${y}, current_bank=${h}`);const _=document.createElement("div");_.dataset.order=a,_.dataset.postButtonLabel=s;const S=document.createElement("button");S.type="button",S.className="button",S.textContent=s;const b=l?document.createElement("span"):null;b&&(b.style.marginLeft="10px",b.style.fontSize="14px",b.style.color="#555");const E=u?document.createElement("details"):null;let k=null;if(E){E.style.marginTop="6px";const e=document.createElement("summary");e.textContent="Показать детали",e.style.cursor="pointer",k=document.createElement("pre"),k.style.whiteSpace="pre-wrap",k.style.margin="6px 0 0",k.style.fontSize="12px",E.appendChild(e),E.appendChild(k)}_.appendChild(S),b&&_.appendChild(b),E&&_.appendChild(E);const A=Array.from(d.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>Number(a));A?d.insertBefore(_,A):d.appendChild(_),S.addEventListener("click",async()=>{console.log("[adminEdit] Вызов bankCommentEditFromBackup с NEW_IS_ADMIN_TO_EDIT=true"),b&&(b.textContent="Выполняю…",b.style.color="#555"),k&&(k.textContent="");try{if("function"!=typeof window.bankCommentEditFromBackup)throw new Error("Функция bankCommentEditFromBackup недоступна");await window.bankCommentEditFromBackup(w,g,y,h,{NEW_IS_ADMIN_TO_EDIT:!0}),b&&(b.textContent="✅ Готово",b.style.color="green"),k&&(k.textContent="Вызвано с NEW_ADMIN_EDIT=true")}catch(e){b&&(b.textContent="✖ Ошибка",b.style.color="red"),k&&(k.textContent=e&&e.message?e.message:String(e)),console.error("[adminEdit] Ошибка:",e)}}),f++}console.log(`[adminEdit] "${s}": Добавлено кнопок: ${f}`)}async function o(){await t({allowedGroups:window.BANK_CHECK?.GroupID||[],allowedForums:window.BANK_CHECK?.ForumID||[],allowedUsers:window.BANK_CHECK?.UserID||[],label:"Внести правки",order:2,containerSelector:".ams_info",postSelector:"div.post"})}document.title.startsWith("Гринготтс")&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o(),window.addEventListener("bank:buttons:refresh",()=>{console.log("[adminEdit] Получено событие bank:buttons:refresh, пересоздаём кнопки"),o()}),window.createAdminEditButtons=t)}(),function(){"use strict";const e=console.log.bind(console),t=console.warn.bind(console),o=console.error.bind(console);function n(o){if(e("[groupByRecipient] Входные данные:",o),e("[groupByRecipient] backupData существует?",!!o),e("[groupByRecipient] backupData.fullData существует?",!!o?.fullData),e("[groupByRecipient] backupData.fullData:",o?.fullData),!o||!o.fullData)return t("[groupByRecipient] Некорректные данные backup"),[];const n=o.environment?.USER_ID||0;if(e("[groupByRecipient] defaultUserId:",n),!n)return t("[groupByRecipient] USER_ID не найден в backupData.environment"),[];const r=["form-income-needrequest","form-income-firstpost","form-income-personalpost","form-income-plotpost","form-income-ep-personal","form-income-ep-plot","form-income-100msgs","form-income-100rep","form-income-100pos","form-income-month","form-income-flyer","form-income-contest","form-income-avatar","form-income-design-other","form-income-run-contest","form-income-mastering","form-income-rpgtop","form-income-banner-reno","form-income-banner-mayak","form-exp-thirdchar","form-exp-changeapp","form-exp-changechar","form-exp-refuse","gift-discount"],s={};return o.fullData.forEach(t=>{r.includes(t.form_id)?e("[groupByRecipient] Пропущена операция:",t.form_id,t.title):["discount","adjustment"].includes(t.type)?e("[groupByRecipient] Пропущен тип операции:",t.type,t.title):t.entries.forEach(e=>{const o=e.data||{},r=Object.keys(o).filter(e=>/^recipient_\d+$/.test(e));r.length>0?r.forEach(e=>{const n=Number(o[e])||0;if(n>0){s[n]||(s[n]=[]);const r=e.match(/^recipient_(\d+)$/)?.[1],i={};r&&void 0!==o[`amount_${r}`]&&(i.amount=o[`amount_${r}`]),r&&void 0!==o[`quantity_${r}`]&&(i.quantity=o[`quantity_${r}`]),r&&void 0!==o[`thousand_${r}`]&&(i.thousand=o[`thousand_${r}`]),r&&void 0!==o[`from_${r}`]&&(i.from=o[`from_${r}`]),r&&void 0!==o[`wish_${r}`]&&(i.wish=o[`wish_${r}`]),r&&void 0!==o[`gift_id_${r}`]&&(i.gift_id=o[`gift_id_${r}`]),s[n].push({form_id:t.form_id,title:t.title,type:t.type,kind:t.kind,price:t.price,bonus:t.bonus,mode:t.mode,modalAmount:t.modalAmount,entry_data:i,entry_key:e})}}):(s[n]||(s[n]=[]),s[n].push({form_id:t.form_id,title:t.title,type:t.type,kind:t.kind,price:t.price,bonus:t.bonus,mode:t.mode,modalAmount:t.modalAmount,entry_data:o,entry_key:null}))})}),e("[groupByRecipient] Сгруппированные данные:",s),s}function r(e,t){const o=(e||"").trim(),n=(t||"").trim();return""!==o&&""!==n?`${o}: ${n}`:""!==o||""!==n?`${o}${n}`:void 0}async function s(n){try{const o=`/pages/usr${n}`,r=await fetch(o);if(!r.ok)return t(`[groupByRecipient] Не удалось загрузить ${o}`),Number(n);const s=await r.text(),i=new DOMParser,a=i.parseFromString(s,"text/html").querySelector(".modal_script");if(!a)return t(`[groupByRecipient] .modal_script не найден в ${o}, используем profileId=${n}`),Number(n);const c=a.getAttribute("data-main-user_id");return c&&c.trim()?(e(`[groupByRecipient] Найден data-main-user_id=${c} для profileId=${n}`),Number(c.trim())):Number(n)}catch(e){return o("[groupByRecipient] Ошибка загрузки страницы:",e),Number(n)}}async function i(e,n,r){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return t("[groupByRecipient] FMVbank.storageGet недоступен"),!1;try{const t=await window.FMVbank.storageGet(e,"info_");if(!t||"object"!=typeof t)return!1;const o=t[n]||[];return!!Array.isArray(o)&&o.some(e=>String(e.id)===String(r))}catch(e){return o(`[groupByRecipient] Ошибка проверки существования ${n}/${r}:`,e),!1}}async function a(e,n){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return t("[groupByRecipient] FMVbank.storageGet недоступен"),!1;try{const o="plashka"===e?"plashka":e,r=await window.FMVbank.storageGet(1,`library_${o}_`);return r&&r.items&&Array.isArray(r.items)?r.items.some(e=>String(e.id)===String(n)):(t(`[groupByRecipient] library_${o}_1 не найдена или пуста`),!1)}catch(t){return o(`[groupByRecipient] Ошибка проверки библиотеки ${e}/${n}:`,t),!1}}async function c(e,n){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return t("[groupByRecipient] FMVbank.storageGet недоступен"),!1;try{const t=await window.FMVbank.storageGet(e,"info_");if(!t||"object"!=typeof t)return!1;const o=t.coupon||[];return!!Array.isArray(o)&&o.some(e=>String(e.id)===String(n))}catch(e){return o(`[groupByRecipient] Ошибка проверки существования купона ${n}:`,e),!1}}"undefined"!=typeof window&&(window.groupOperationsByRecipient=n,window.groupByRecipientWithGifts=async function(l){if(!l||"object"!=typeof l)return t("[groupByRecipientWithGifts] Входные данные невалидны:",l),[];const u=n(l);e("[groupByRecipientWithGifts] groupedData после groupOperationsByRecipient:",u);const d=l?.environment?.USER_ID?Number(l.environment.USER_ID):0,m=l?.totalSum?Number(l.totalSum):0,f={"form-gift-collection":"gift","form-icon-collection":"icon","form-badge-collection":"plashka","form-back-collection":"background","form-gift-custom":"gift","form-icon-custom":"icon","form-badge-custom":"plashka","form-back-custom":"background"},p={};for(const[e,t]of Object.entries(u))if(Array.isArray(t)&&0!==t.length){p[e]||(p[e]={amount:0,items:[]});for(const o of t){const t=o.form_id,n=t&&t.includes("-custom"),s=f[t],i=o.entry_data||{},a=r(i.from,i.wish),c={form_id:t,title:o.title,category:s||null,is_custom:n};if(void 0!==i.amount&&null!==i.amount){const t=Number(i.amount);isNaN(t)||(p[e].amount+=t,c.amount=t)}if(s)c.gift_id=i.gift_id||null,a&&(c.custom_title=a),p[e].items.push(c);else{c.gift_id=i.gift_id||null,"coupon"===o.type&&(c.type="coupon",c.remove=!0);const t=Number(i.quantity)||1;for(let o=0;o<t;o++)p[e].items.push({...c})}}}e("[groupByRecipientWithGifts] Временная группировка:",p);const w={},g=Object.keys(p).map(Number);for(const t of g){const o=await s(t);w[t]=o,e(`[groupByRecipientWithGifts] Маппинг: ${t} -> ${o}`)}const y={};for(const[e,t]of Object.entries(p)){const o=w[Number(e)];y[o]||(y[o]={recipient_id:o,amount:0,items:[]}),y[o].amount+=t.amount,y[o].items.push(...t.items)}d&&y[d]&&(y[d].amount+=m,e(`[groupByRecipientWithGifts] Добавлен totalSum (${m}) к получателю ${d}`));for(const[e,n]of Object.entries(y))for(const r of n.items)if(r.is_custom&&r.category&&"custom"===r.gift_id)r.error="not_selected_custom",o(`[groupByRecipientWithGifts] Найден custom без ID для recipient ${e}:`,r);else{if(!0===r.remove&&"coupon"===r.type){if(!r.gift_id){r.error="not_selected_custom",o(`[groupByRecipientWithGifts] Купон без gift_id для recipient ${e}:`,r);continue}await c(Number(e),r.gift_id)||(r.error="coupon_not_exists",t(`[groupByRecipientWithGifts] Купон с system_id ${r.gift_id} не найден у recipient ${e}`));continue}if(r.category&&r.gift_id&&"custom"!==r.gift_id){if(!await a(r.category,r.gift_id)){r.error="not_in_library",t(`[groupByRecipientWithGifts] ID ${r.gift_id} не найден в библиотеке ${r.category} для recipient ${e}`);continue}await i(Number(e),r.category,r.gift_id)&&(r.error="already_exists",t(`[groupByRecipientWithGifts] Дубликат ${r.category}/${r.gift_id} для recipient ${e}`))}}const h=Object.values(y).filter(e=>0!==e.amount||e.items.length>0);return e("[groupByRecipientWithGifts] Финальный результат:",h),h})}(),function(){"use strict";async function e(e){const t=e.querySelector(".pl-email.profile a"),o=t?new URL(t.href):null,n=o&&Number(o.searchParams.get("id"))||0,r=e.querySelector("bank_data");return{usr_id:n,ts:r&&Number(r.textContent.trim())||0}}function t(e){if(!Array.isArray(e)||0===e.length)return"Нет данных для проверки";const t=[];return e.forEach(e=>{const o=e.recipient_id,n=e.amount||0,r=e.items||[];t.push(`\n📋 Получатель usr${o}:`),0!==n&&t.push(`  💰 Баланс: ${n>0?"+":""}${n}`),r.length>0&&r.forEach(e=>{const o=e.error?"  ❌":"  ✅";if(e.remove)t.push(`${o} Удалить купон: ${e.title||e.form_id||"Неизвестный купон"}`),e.error&&t.push(`     ⚠️ Ошибка: ${e.error}`);else if(e.category){const n={gift:"Подарок",icon:"Иконка",plashka:"Плашка",background:"Фон"}[e.category]||e.category;if(t.push(`${o} ${n}: ${e.title||e.form_id||"Неизвестный"}`),e.custom_title&&t.push(`     💬 "${e.custom_title}"`),e.error){const o={not_selected_custom:"Не выбран элемент для индивидуального подарка",not_in_library:"Элемент не найден в библиотеке",already_exists:"Элемент уже есть у получателя",coupon_not_exists:"Купон не найден у получателя"}[e.error]||e.error;t.push(`     ⚠️ Ошибка: ${o}`)}}else t.push(`${o} ${e.title||e.form_id||"Операция"}`),e.amount&&t.push(`     💰 Сумма: ${e.amount}`),e.error&&t.push(`     ⚠️ Ошибка: ${e.error}`)})}),t.join("\n")}async function o(o){const{allowedGroups:n=[],allowedForums:r=[],allowedUsers:s=[],label:i="Автопроверка",containerSelector:a=".ams_info",order:c=1,postSelector:l="div.post",showStatus:u=!0,showDetails:d=!0}=o||{};if(console.log(`[adminAutoCheck] "${i}": Вызов с параметрами:`,{allowedGroups:n,allowedForums:r,allowedUsers:s}),!document.title.startsWith("Гринготтс"))return void console.log(`[adminAutoCheck] "${i}": Страница не Гринготтс, выход`);window.__gringotts_ready?console.log(`[adminAutoCheck] "${i}": gringotts уже готов`):(console.log(`[adminAutoCheck] "${i}": Ждём события gringotts:ready`),await new Promise(e=>window.addEventListener("gringotts:ready",e,{once:!0})));const m="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log(`[adminAutoCheck] "${i}": текущая группа = ${m}, разрешённые = [${n}]`),!Array.isArray(n)||0===n.length)return void console.log(`[adminAutoCheck] "${i}": allowedGroups пустой, выход`);if(!n.map(Number).includes(Number(m)))return void console.log(`[adminAutoCheck] "${i}": группа ${m} не в списке, выход`);if(!Array.isArray(r)||0===r.length)return void console.log(`[adminAutoCheck] "${i}": allowedForums пустой, выход`);if(!(e=>{const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))})(r))return void console.log(`[adminAutoCheck] "${i}": форум не разрешён, выход`);if(Array.isArray(s)&&s.length>0){const e=Number(window.UserID);if(console.log(`[adminAutoCheck] "${i}": текущий UserID = ${e}, разрешённые = [${s}]`),!s.map(Number).includes(e))return void console.log(`[adminAutoCheck] "${i}": пользователь ${e} не в списке, выход`)}const f=document.querySelectorAll(l);console.log(`[adminAutoCheck] "${i}": Найдено постов: ${f.length}`);let p=0;for(let o=0;o<f.length;o++){const n=f[o];if(n.classList.contains("topicpost"))continue;const r=n.querySelector(".post-content");if(!r)continue;const s=r.querySelector("bank_ams_check"),l=r.querySelector("bank_ams_done");if(!s||l){console.log(`[adminAutoCheck] "${i}": Пост ${o}: hasAmsCheck=${!!s}, hasAmsDone=${!!l}, пропуск`);continue}const m=r.querySelector(a);if(!m)continue;if(m.querySelector(`[data-post-button-label="${i}"]`))continue;const w=await e(n);console.log(`[adminAutoCheck] "${i}": Пост ${o}: getPostData вернул:`,w);const{usr_id:g,ts:y}=w;if(!g||!y){console.log(`[adminAutoCheck] "${i}": Пост ${o}: проверка не прошла - usr_id=${g}, ts=${y}`);continue}console.log(`[adminAutoCheck] "${i}": Пост ${o}: данные OK - usr_id=${g}, ts=${y}`);const h=document.createElement("div");h.dataset.order=c,h.dataset.postButtonLabel=i;const _=document.createElement("button");_.type="button",_.className="button",_.textContent=i;const S=u?document.createElement("span"):null;S&&(S.style.marginLeft="10px",S.style.fontSize="14px",S.style.color="#555");const b=d?document.createElement("details"):null;let E=null;if(b){b.style.marginTop="6px";const e=document.createElement("summary");e.textContent="Показать подробности",e.style.cursor="pointer",E=document.createElement("pre"),E.style.whiteSpace="pre-wrap",E.style.margin="6px 0 0",E.style.fontSize="12px",b.appendChild(e),b.appendChild(E)}h.appendChild(_),S&&h.appendChild(S),b&&h.appendChild(b);const k=Array.from(m.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>Number(c));k?m.insertBefore(h,k):m.appendChild(h),_.addEventListener("click",async()=>{console.log(`[adminAutoCheck] Начало автопроверки для usr_id=${g}, ts=${y}`),S&&(S.textContent="Проверяю…",S.style.color="#555"),E&&(E.textContent="");try{if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank.storageGet недоступен");const e=(await window.FMVbank.storageGet(g,"fmv_bank_info_"))[y];if(!e)throw new Error("BACKUP_DATA не найден");if(console.log("[adminAutoCheck] BACKUP_DATA:",e),"function"!=typeof window.groupByRecipientWithGifts)throw new Error("Функция groupByRecipientWithGifts недоступна");const o=await window.groupByRecipientWithGifts(e);console.log("[adminAutoCheck] Результат проверки:",o);let n=!1;if(Array.isArray(o))for(const e of o){if(Array.isArray(e.items))for(const t of e.items)if(t.error){n=!0;break}if(n)break}S&&(n?(S.textContent="⚠️ Найдены ошибки",S.style.color="orange"):(S.textContent="✅ ОК",S.style.color="green")),E&&(E.textContent=t(o)),n&&b&&(b.open=!0)}catch(e){S&&(S.textContent="✖ Ошибка",S.style.color="red"),E&&(E.textContent=e&&e.message?e.message:String(e)),console.error("[adminAutoCheck] Ошибка:",e)}}),p++}console.log(`[adminAutoCheck] "${i}": Добавлено кнопок: ${p}`)}async function n(){await o({allowedGroups:window.BANK_CHECK?.GroupID||[],allowedForums:window.BANK_CHECK?.ForumID||[],allowedUsers:window.BANK_CHECK?.UserID||[],label:"Автопроверка",order:1,containerSelector:".ams_info",postSelector:"div.post"})}document.title.startsWith("Гринготтс")&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n(),window.addEventListener("bank:buttons:refresh",()=>{console.log("[adminAutoCheck] Получено событие bank:buttons:refresh, пересоздаём кнопки"),n()}),window.createAutoCheckButtons=o)}(),function(){"use strict";if(!document.title.startsWith("Гринготтс"))return;const e={allowedGroups:window.BANK_CHECK?.GroupID||[],allowedForums:window.BANK_CHECK?.ForumID||[],allowedUsers:window.BANK_CHECK?.UserID||[]};function t(){(async function(e){const t=e?.allowedGroups||[],o=e?.allowedForums||[],n=e?.allowedUsers||[];console.log("[NO_EDITS_NEEDED] Вызов с параметрами:",{allowedGroups:t,allowedForums:o,allowedUsers:n}),window.__gringotts_ready?console.log("[NO_EDITS_NEEDED] gringotts уже готов"):(console.log("[NO_EDITS_NEEDED] Ждём события gringotts:ready"),await new Promise(e=>window.addEventListener("gringotts:ready",e,{once:!0})));const r="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log("[NO_EDITS_NEEDED] текущая группа =",r,", разрешённые =",t),!Array.isArray(t)||0===t.length)return void console.log("[NO_EDITS_NEEDED] allowedGroups пустой, выход");if(!t.map(Number).includes(Number(r)))return void console.log("[NO_EDITS_NEEDED] группа",r,"не в списке, выход");if(!Array.isArray(o)||0===o.length)return void console.log("[NO_EDITS_NEEDED] allowedForums пустой, выход");if(!(e=>{const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))})(o))return void console.log("[NO_EDITS_NEEDED] форум не разрешён, выход");if(Array.isArray(n)&&n.length>0){const e=Number(window.UserID);if(console.log("[NO_EDITS_NEEDED] текущий UserID =",e,", разрешённые =",n),!n.map(Number).includes(e))return void console.log("[NO_EDITS_NEEDED] пользователь",e,"не в списке, выход")}console.log("[NO_EDITS_NEEDED] Начинаем создание кнопок");const s=Array.from(document.querySelectorAll("div.post"));console.log(`[NO_EDITS_NEEDED] Найдено постов: ${s.length}`);for(let e=0;e<s.length;e++){const t=s[e].querySelector("div.post-content");if(!t)continue;const o=!!t.querySelector("bank_ams_check"),n=!!t.querySelector("bank_ams_done");if(!o||n)continue;console.log(`[NO_EDITS_NEEDED] Пост #${e}: подходит для кнопки`);const r=t.querySelector(".ams_info");if(!r){console.warn(`[NO_EDITS_NEEDED] Пост #${e}: не найден .ams_info`);continue}if(r.querySelector('[data-post-button-label="В правках не нуждается"]')){console.log(`[NO_EDITS_NEEDED] Пост #${e}: кнопка уже существует`);continue}const i=document.createElement("div");i.dataset.order=3,i.dataset.postButtonLabel="В правках не нуждается";const a=document.createElement("button");a.type="button",a.className="button",a.textContent="В правках не нуждается",i.appendChild(a);const c=Array.from(r.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>3);c?r.insertBefore(i,c):r.appendChild(i),a.addEventListener("click",function(){console.log(`[NO_EDITS_NEEDED] Кнопка нажата для поста #${e}`);const t=r.querySelector('[data-post-button-label="Внести правки"]');if(t){const e=t.querySelector("button");e&&(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",console.log('[NO_EDITS_NEEDED] Заблокирована кнопка "Внести правки"'))}a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed";const o=r.querySelector('[data-post-button-label="Выплатить"]');if(o){const e=o.querySelector("button");e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",console.log('[NO_EDITS_NEEDED] Разблокирована кнопка "Выплатить"'))}}),console.log(`[NO_EDITS_NEEDED] Кнопка добавлена в пост #${e}`)}})(e).catch(e=>{console.error("[NO_EDITS_NEEDED] Ошибка при создании кнопок:",e)})}t(),window.addEventListener("bank:buttons:refresh",()=>{console.log("[NO_EDITS_NEEDED] Получено событие bank:buttons:refresh, пересоздаём кнопки"),t()})}(),function(){"use strict";if(!document.title.startsWith("Гринготтс"))return;const e={allowedGroups:window.BANK_CHECK?.GroupID||[],allowedForums:window.BANK_CHECK?.ForumID||[],allowedUsers:window.BANK_CHECK?.UserID||[]};function t(){(async function(e){const t=e?.allowedGroups||[],o=e?.allowedForums||[],n=e?.allowedUsers||[];console.log("[PAY_OUT] Вызов с параметрами:",{allowedGroups:t,allowedForums:o,allowedUsers:n}),window.__gringotts_ready?console.log("[PAY_OUT] gringotts уже готов"):(console.log("[PAY_OUT] Ждём события gringotts:ready"),await new Promise(e=>window.addEventListener("gringotts:ready",e,{once:!0})));const r="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():NaN;if(console.log("[PAY_OUT] текущая группа =",r,", разрешённые =",t),!Array.isArray(t)||0===t.length)return void console.log("[PAY_OUT] allowedGroups пустой, выход");if(!t.map(Number).includes(Number(r)))return void console.log("[PAY_OUT] группа",r,"не в списке, выход");if(!Array.isArray(o)||0===o.length)return void console.log("[PAY_OUT] allowedForums пустой, выход");if(!(e=>{const t=(e||[]).map(String),o=document.querySelector(".container.crumbs"),n=e=>Array.from(e.querySelectorAll("a[href]")).some(e=>{try{const o=new URL(e.getAttribute("href"),location.href);if(!o.pathname.includes("viewforum.php"))return!1;const n=(o.searchParams.get("id")||"").trim();return n&&t.includes(n)}catch{return!1}});if(o&&n(o))return!0;if(n(document))return!0;const r=document.body?.dataset?.forumId;return!(!r||!t.includes(String(r)))})(o))return void console.log("[PAY_OUT] форум не разрешён, выход");if(Array.isArray(n)&&n.length>0){const e=Number(window.UserID);if(console.log("[PAY_OUT] текущий UserID =",e,", разрешённые =",n),!n.map(Number).includes(e))return void console.log("[PAY_OUT] пользователь",e,"не в списке, выход")}console.log("[PAY_OUT] Начинаем создание кнопок");const s=Array.from(document.querySelectorAll("div.post"));console.log(`[PAY_OUT] Найдено постов: ${s.length}`);for(let e=0;e<s.length;e++){const t=s[e].querySelector("div.post-content");if(!t)continue;const o=!!t.querySelector("bank_ams_check"),n=!!t.querySelector("bank_ams_done");if(!o||n)continue;console.log(`[PAY_OUT] Пост #${e}: подходит для кнопки`);const r=t.querySelector(".ams_info");if(!r){console.warn(`[PAY_OUT] Пост #${e}: не найден .ams_info`);continue}if(r.querySelector('[data-post-button-label="Выплатить"]')){console.log(`[PAY_OUT] Пост #${e}: кнопка уже существует`);continue}const i=document.createElement("div");i.dataset.order=4,i.dataset.postButtonLabel="Выплатить";const a=document.createElement("button");a.type="button",a.className="button",a.textContent="Выплатить",a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed",i.appendChild(a);const c=Array.from(r.querySelectorAll("div[data-order]")).find(e=>Number(e.dataset.order)>4);c?r.insertBefore(i,c):r.appendChild(i),a.addEventListener("click",function(){return console.log(`[PAY_OUT] Кнопка нажата для поста #${e}`),console.log("[PAY_OUT] Возвращаем true"),!0}),console.log(`[PAY_OUT] Кнопка добавлена в пост #${e} (заблокирована)`)}})(e).catch(e=>{console.error("[PAY_OUT] Ошибка при создании кнопок:",e)})}t(),window.addEventListener("bank:buttons:refresh",()=>{console.log("[PAY_OUT] Получено событие bank:buttons:refresh, пересоздаём кнопки"),t()})}(),function(e){const t="/api.php";let o=!1;const n=e=>new URLSearchParams(e);async function r(e,r={},s=1,i){const a=i+s;if("storage.get"===e){const o=n({user_id:1,method:e,key:a}),r=await fetch(`${t}?${o}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!r.ok)throw new Error(`GET ${r.status}`);return r.json()}if("storage.set"===e){const s=n({user_id:1,token:o,method:e,key:a,...r}),i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},credentials:"same-origin",body:s});if(!i.ok)throw new Error(`POST ${i.status}`);return!0}throw new Error("Unknown method")}!function(){const t=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;if(t)o=t;else{let t=5;const n=setInterval(()=>{if(o||--t<0)return void clearInterval(n);const r=e.ForumAPITicket||e.ticket||e.TOKEN||e.API_TOKEN||e.session&&e.session.token||e.FORUM&&e.FORUM.ticket||null;r&&(o=r,clearInterval(n))},200)}}(),e.FMVbank={setTicket:function(e){o=e},storageGet:async function(e=1,t){const o=t+e;return((e,t)=>{try{const o=e?.response?.storage?.data?.[t];return o?JSON.parse(o):{}}catch{return{}}})(await r("storage.get",{},e,t),o)},storageSet:async function(e,t=1,o="fmv_bank_info_"){if(console.log("[FMVbank] 🔵 storageSet вызван: NEEDED_USER_ID=",t,"api_key_label=",o),console.log("[FMVbank] 🔵 Итоговый API_KEY будет:",o+t),!e||"object"!=typeof e||Array.isArray(e))return console.log("[FMVbank] storageSet: ожидался объект JSON"),!1;const n=JSON.stringify(e);return console.log("[FMVbank] 🔵 Отправляю в storage.set, длина данных:",n.length),await r("storage.set",{value:n},t,o),console.log("[FMVbank] 🔵 storage.set завершён успешно"),!0}}}(window),window.formatBankText=formatBankText,window.encodeJSON=encodeJSON,window.decodeJSON=decodeJSON,window.getBlockquoteTextAfterPersonalPost=getBlockquoteTextAfterPersonalPost,window.getBlockquoteTextFromHtml=getBlockquoteTextFromHtml,window.fetchDesignItems=fetchDesignItems,window.fetchLibraryItems=fetchLibraryItems;const typeRank={item:0,fixed:1},rankType=e=>e in typeRank?typeRank[e]:2,toNumber=e=>{const t=Number(e);return Number.isFinite(t)?t:-1/0},toTimeOrInf=e=>{if(null==e||""===e)return 1/0;const t=e instanceof Date?e.getTime():Date.parse(e);return Number.isFinite(t)?t:1/0},comparator=(e,t)=>{let o=rankType(e.type)-rankType(t.type);if(0!==o)return o;if(o=toNumber(t.value)-toNumber(e.value),0!==o)return o;const n=toTimeOrInf(e.expiresAt),r=toTimeOrInf(t.expiresAt);return n===1/0&&r!==1/0?1:r===1/0&&n!==1/0?-1:(o=n-r,0!==o?o:0)};async function getUserIdFromPage(e){try{const t=`/pages/usr${e}`,o=await fetch(t);if(!o.ok)return console.error(`[fetchUserCoupons] Не удалось загрузить ${t}`),Number(e);const n=await o.text(),r=new DOMParser,s=r.parseFromString(n,"text/html").querySelector(".modal_script");if(!s)return console.warn(`[fetchUserCoupons] .modal_script не найден в ${t}, используем profileId=${e}`),Number(e);const i=s.getAttribute("data-main-user_id");return i&&i.trim()?(console.log(`[fetchUserCoupons] Найден data-main-user_id=${i}`),Number(i.trim())):Number(e)}catch(t){return console.error("[fetchUserCoupons] Ошибка загрузки страницы:",t),Number(e)}}async function fetchUserCoupons(){const e=window.UserID;if(!e)return console.warn("[fetchUserCoupons] window.UserID не определён"),[];const t=await getUserIdFromPage(e);if(console.log("[fetchUserCoupons] Целевой userId:",t),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[fetchUserCoupons] FMVbank.storageGet не найден"),[];const o=(()=>{const e=new Date,t=e.getTimezoneOffset(),o=new Date(e.getTime()+6e4*(180+t));return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`})();let n;try{n=await window.FMVbank.storageGet(t,"info_"),console.log("[fetchUserCoupons] API ответ:",n)}catch(e){return console.error("[fetchUserCoupons] Ошибка загрузки из API:",e),[]}if(!n||"object"!=typeof n)return console.warn("[fetchUserCoupons] Неверный формат ответа API"),[];const r=n.coupon||[];if(!Array.isArray(r))return console.warn("[fetchUserCoupons] response.coupon не является массивом"),[];console.log("[fetchUserCoupons] Купоны из API:",r);const s=[];r.forEach(e=>{if(!1===e.is_visible)return void console.log(`[fetchUserCoupons] Пропущен невидимый купон id=${e.id}`);const t=String(e.id||""),n=e.coupon_type||"",r=e.coupon_form||"",i=Number(e.coupon_value||0),a=e.coupon_title||e.title||"",c=e.expired_date;if(c&&c<o)return void console.log(`[fetchUserCoupons] Пропущен купон "${a}" (истёк: ${c} < ${o})`);const l=e=>(e||"").replace(/"/g,"&quot;"),u=[`data-id="${l(t)}"`,`title="${l(e.title||"")}"`];Object.keys(e).forEach(t=>{if("id"!==t&&"title"!==t&&"content"!==t&&"is_visible"!==t){const o="data-"+t.replace(/_/g,"-");u.push(`${o}="${l(String(e[t]||""))}"`)}});const d={system_id:t,type:n,form:r,value:i,title:a,html:`<div class="item" ${u.join(" ")}>${e.content||""}</div>`};c&&(d.expiresAt=c),s.push(d)}),console.log(`[fetchUserCoupons] Загружено купонов: ${s.length}`);const i=s.sort(comparator);return i.forEach((e,t)=>{e.id=String(t+1)}),i}window.fetchUserCoupons=fetchUserCoupons,function(){"use strict";window.BankMessagesLog=console.log.bind(console),window.BankMessagesWarn=console.warn.bind(console),window.BankMessagesError=console.error.bind(console),window.BankPreScrapeBarrier=Promise.resolve(!0),window.BankDelay=e=>new Promise(t=>setTimeout(t,e)),window.BankWithTimeout=async function(e,t,o="request"){let n;const r=new Promise((e,r)=>{n=setTimeout(()=>r(new Error(`${o} timeout after ${t} ms`)),t)});try{return await Promise.race([e,r])}finally{clearTimeout(n)}},window.BankRetry=async function(e,{retries:t=3,baseDelay:o=600,maxDelay:n=6e3,timeoutMs:r=15e3}={},s="request"){let i;window.BankMessagesLog("🟦 [STEP] "+s+" start");for(let a=0;a<t;a++)try{const o=await window.BankWithTimeout(e(),r,s);return window.BankMessagesLog("✅ [OK]   "+s+" success (try "+(a+1)+"/"+t+")"),o}catch(e){i=e;if(a===t-1){window.BankMessagesWarn("❌ [ERROR] "+s+" failed after "+t+" tries:",e?.message||e);break}const r=.8+.4*Math.random(),c=Math.min(o*2**a,n)*r;window.BankMessagesLog("⚠️  [RETRY] "+s+" try "+(a+1)+" failed: "+(e?.message||e)+". Waiting "+Math.round(c)+"ms before retry..."),await window.BankDelay(c)}throw i},window.SCRAPE_BASE_GAP_MS=500,window.SCRAPE_JITTER_MS=800,window.SEND_BASE_GAP_MS=900,window.SEND_JITTER_MS=500,window.BankHumanPause=function(e,t,o="pause"){const n=e+Math.floor(Math.random()*t);return window.BankMessagesLog("🟨 [WAIT] "+o+": "+n+"ms"),window.BankDelay(n)},window.BankGetToday=function(){const e=new Date;return[e.getFullYear(),e.getMonth()+1,e.getDate()]},window.BankWaitForIframeReady=function(e){return new Promise(t=>{window.addEventListener("message",function o(n){if(n.origin!==e)return;if("IFRAME_READY"!==n.data?.type)return;window.removeEventListener("message",o);const r=n.source;r.postMessage({type:"IFRAME_ACK"},e),window.BankMessagesLog("✅ [IFRAME] ACK sent, iframe ready"),t(r)}),window.BankMessagesLog("🟦 [STEP] waiting for IFRAME_READY…")})},window.BankMessagesLog("✅ [MODULE] messages-utils.js loaded")}(),function(){"use strict";window.BANK_IFRAME_ORIGIN="https://forumscripts.ru",window.BankPrefix={ads:"Реклама",bank:"Гринготтс"},window.BankForums={ads:window.FORUMS_IDS?.Ads||[0],bank:window.FORUMS_IDS?.Bank||[0],personal_posts:window.FORUMS_IDS?.PersonalPosts||[0],plot_posts:window.FORUMS_IDS?.PlotPosts||[0]},window.BankLabel={ads:"— Каждая рекламная листовка",banner_mayak:"— Баннер FMV в подписи на Маяке",banner_reno:"— Баннер FMV в подписи на Рено",first_post:"— Первый пост на профиле",message100:"— Каждые 100 сообщений",positive100:"— Каждые 100 позитива",reputation100:"— Каждые 100 репутации",month:"— Каждый игровой месяц",personal_posts:"— Каждый личный пост",plot_posts:"— Каждый сюжетный пост"},window.BankPostMessagesType={ads:"ADS_POSTS",backup_data:"BACKUP_DATA",banner_mayak:"BANNER_MAYAK_FLAG",banner_reno:"BANNER_RENO_FLAG",comment_info:"COMMENT_INFO",coupons:"PERSONAL_DISCOUNTS",first_post:"FIRST_POST_FLAG",first_post_missed:"FIRST_POST_MISSED_FLAG",skin:"SKIN",personal_posts:"PERSONAL_POSTS",plot_posts:"PLOT_POSTS",profile_info:"PROFILE_INFO",user_info:"USER_INFO",users_list:"USERS_LIST"},window.BankSkinFieldID=window.SKIN?.LibraryFieldID||0,window.BankSkinPostID={Plashka:window.SKIN?.LibraryPlashkaPostID||[],Icon:window.SKIN?.LibraryIconPostID||[],Back:window.SKIN?.LibraryBackPostID||[],Gift:window.SKIN?.LibraryGiftPostID||[]},window.BankMessagesLog&&window.BankMessagesLog("✅ [MODULE] messages-config.js loaded")}(),function(){"use strict";const e=[];let t=!1;window.BankQueueJob=function(o,n){o.then(o=>{e.push(async()=>{const e=Date.now();window.BankMessagesLog("🟪 [QUEUE] job started"),await n(o);const t=Date.now()-e;window.BankMessagesLog("🟩 [SENT]  job done in "+t+"ms")});const r=e.length;window.BankMessagesLog("🟪 [QUEUE] job enqueued (size: "+r+")"),async function(){if(t)return;t=!0;const o=e.length;window.BankMessagesLog("🟦 [STEP] send queue started (items: "+o+")");try{for(;e.length;){const t=e.shift();try{await t()}catch(e){window.BankMessagesWarn("❌ [ERROR] send task failed:",e?.message||e)}await window.BankHumanPause(window.SEND_BASE_GAP_MS,window.SEND_JITTER_MS,"gap between sends")}}finally{t=!1,window.BankMessagesLog("✅ [OK]   send queue drained")}}()}).catch(e=>window.BankMessagesWarn("queueJob skipped:",e?.message||e))},window.BankQueueMessage=function(e,t,o){o=o||"message",window.BankQueueJob(e,async e=>{const n=t();n?(e.postMessage(n,window.BANK_IFRAME_ORIGIN),window.BankMessagesLog("🟩 [SENT]  "+o+":",n.type||"(no type)")):window.BankMessagesLog("⚪ [SKIP]  "+o+": empty message")})},window.BankSendMessageImmediately=function(e,t,o){o=o||"message",e.then(e=>{const n=t();n?(e.postMessage(n,window.BANK_IFRAME_ORIGIN),window.BankMessagesLog("🟢 [IMMEDIATE] "+o+":",n.type||"(no type)")):window.BankMessagesLog("⚪ [SKIP]  "+o+": empty message")}).catch(e=>window.BankMessagesWarn("sendMessageImmediately skipped:",e?.message||e))},window.BankMessagesLog&&window.BankMessagesLog("✅ [MODULE] messages-queue.js loaded")}(),function(){"use strict";const e=window.location.origin;window.BankSendPosts=async function(t,{seedPosts:o,label:n,forums:r,type:s,is_ads:i=!1,title_prefix:a=""}){try{const c=[];if(Array.isArray(o))for(const e of o){const t=e&&"string"==typeof e.html?e.html:"",o=t?getBlockquoteTextFromHtml(t,n,"link"):null;Array.isArray(o)?c.push(...o):"string"==typeof o&&""!==o.trim()&&c.push(o)}const l=c.filter(e=>"string"==typeof e&&e.includes("/viewtopic.php?")).map(e=>e.split("/viewtopic.php?")[1]);window.BankMessagesLog("🟦 [STEP] scrape new posts for "+s+" (filter used_posts: "+l.length+")");const u=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,r,{last_src:l,comments_only:!0,title_prefix:a}),{retries:4,baseDelay:800,maxDelay:8e3,timeoutMs:18e3},"scrapePosts("+s+")"),d=Array.isArray(u)?u.map(t=>({src:e+"/viewtopic.php?"+t.src,text:t.title,...i?{}:{symbols_num:t.symbols_num}})):[];t.postMessage({type:s,posts:d},window.BANK_IFRAME_ORIGIN),window.BankMessagesLog("🟩 [SENT]  "+s+": "+d.length+" item(s)")}catch(e){window.BankMessagesWarn("❌ [ERROR] sendPosts("+s+") failed after retries:",e?.message||e)}},window.BankGetLastValue=async function(e,{label:t,is_month:o=!1}){try{const n=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:t.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(personal_seed)"),r=window.scrapePosts?.bind(window);"function"==typeof r&&(window.scrapePosts=async(...e)=>(await(window.preScrapeBarrier??window.BankPreScrapeBarrier??Promise.resolve()),r(...e)));const s=Array.isArray(n)?n[0]:null,i=s&&"string"==typeof s.html?s.html:"",a=i?getBlockquoteTextFromHtml(i,t,"last_value"):null;let c;return c=null==a?e:1==o?a.trim().split("-").map(Number):Number(a.trim()),window.BankMessagesLog("🟩 [FOUND] Новое значение "+t+": "+c),c}catch(e){return window.BankMessagesWarn("❌ [ERROR] getLastValue("+t+") failed after retries:",e?.message||e),null}},window.BankMessagesLog&&window.BankMessagesLog("✅ [MODULE] messages-scrapers.js loaded")}(),document.addEventListener("DOMContentLoaded",()=>{if(!(document.querySelector("head > title")?.textContent||"").startsWith("Гринготтс"))return;window.BankPreScrapeBarrier=(async()=>!0)(),window.preScrapeBarrier=window.BankPreScrapeBarrier;const e=document.querySelector('textarea[name="req_message"]'),t=window.BankWaitForIframeReady(window.BANK_IFRAME_ORIGIN);window.bankCommentEditFromBackup=async function(e,o,n=0,r=0,{NEW_IS_ADMIN_TO_EDIT:s=!1}={}){window.BankMessagesLog(`🟦 [BACKUP] bankCommentEditFromBackup called: user_id=${e}, ts=${o}, comment_id=${n}, current_bank=${r}, NEW_IS_ADMIN_TO_EDIT=${s}`);const i=document.querySelector(`#p${n}-content`);if(i){if(i.querySelector("bank_ams_done"))return window.BankMessagesWarn("⚠️ [BACKUP] Обнаружен bank_ams_done, редактирование запрещено"),void alert("Извините! Администратор уже обработал Вашу запись в банке. Пожалуйста, обратитесь в Приёмную, если нужно будет внести изменения.")}if(!s){if(0===n)return window.BankMessagesError("❌ [BACKUP] NEW_COMMENT_ID = 0, редактирование невозможно"),void alert("Извините! Произошла ошибка. Пожалуйста, обратитесь в Приёмную.");if(i){if(i.querySelector("bank_ams_check"))return window.BankMessagesWarn("⚠️ [BACKUP] Обнаружен bank_ams_check, редактирование запрещено"),void alert("Извините! Администратор уже начал обрабатывать Вашу запись в банке. Пожалуйста, обратитесь в Приёмную, если нужно будет внести изменения.")}else window.BankMessagesWarn(`⚠️ [BACKUP] Элемент #p${n}-content не найден`)}const a=await FMVbank.storageGet(e,"fmv_bank_info_");window.BankMessagesLog("🟦 [BACKUP] current_storage:",a);const c=a[o];if(window.BankMessagesLog(`🟦 [BACKUP] BACKUP_DATA for ts=${o}:`,c),c){window.BankSendMessageImmediately(t,()=>({type:window.BankPostMessagesType.comment_info,NEW_COMMENT_TIMESTAMP:o,NEW_COMMENT_ID:n,NEW_CURRENT_BANK:2==Number(window.user_id)?99999999:r,NEW_IS_ADMIN_TO_EDIT:s}),"comment_info"),window.BankSendMessageImmediately(t,()=>({type:window.BankPostMessagesType.backup_data,BACKUP_DATA:c}),"backup_data");const e=document.querySelector("div.post.topicpost");e?(e.scrollIntoView({behavior:"smooth",block:"start"}),window.BankMessagesLog("🟦 [BACKUP] Скролл к div.post.topicpost выполнен")):window.BankMessagesWarn("⚠️ [BACKUP] div.post.topicpost не найден")}},window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.user_info,user_id:window.UserID,user_name:window.UserLogin,is_admin:2==window.UserID}),"user_info"),(async()=>{try{const e=await fetchLibraryItems();window.BankMessagesLog("[SKIN from API]",e),window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.skin,skin_data_plashka:e.plashka,skin_data_icon:e.icon,skin_data_back:e.back,skin_data_gift:e.gift}),"skin_data")}catch(e){window.BankMessagesWarn("❌ [ERROR] Skin loading from API failed:",e?.message||e)}})(),(async()=>{try{const e=await fetchUserCoupons();window.BankMessagesLog("[COUPONS from info_]",e),window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.coupons,coupons_data:e}),"coupons_data")}catch(e){window.BankMessagesWarn("❌ [ERROR] Coupons loading from info_ failed:",e?.message||e)}})(),window.addEventListener("message",async t=>{if(t.origin!==window.BANK_IFRAME_ORIGIN)return;if(!t.data||"PURCHASE"!==t.data.type)return;window.BankMessagesLog("🟦 [STEP] PURCHASE received");encodeJSON(t.data);const o=formatBankText(t.data),n=t.data.timestamp,r=await FMVbank.storageGet(window.UserID,"fmv_bank_info_");r[n]=t.data;if(FMVbank.storageSet(r,window.UserID,"fmv_bank_info_")){if(e){e.value=`[FMVbank]${n}[/FMVbank]${o}`;const t=document.querySelector('input[type="submit"].button.submit[name="submit"][value="Отправить"][accesskey="s"]');t?(t.click(),window.BankMessagesLog("🟩 [SENT]  PURCHASE form submitted")):window.BankMessagesWarn("❌ [ERROR] Submit button not found.")}}else alert("Попробуйте нажать на кнопку еще раз.")}),window.addEventListener("message",async e=>{if(e.origin!==window.BANK_IFRAME_ORIGIN)return;if(!e.data||"EDIT_PURCHASE"!==e.data.type)return;window.BankMessagesLog("🟦 [STEP] EDIT_PURCHASE received");const t=(window.SITE_URL||location.origin).replace(/\/+$/,""),o=formatBankText(e.data),n=e.data.timestamp,r=e.data.comment_timestamp,s=e.data.comment_id,i=e.data.comment_user_id,a=e.data.is_admin_to_edit||!1,c=a?"[FMVbankAmsCheck]":"";window.BankMessagesLog("🟦 [EDIT] Открываем страницу редактирования комментария:",s);const l=document.createElement("iframe");l.style.display="none",l.src=`${t}/edit.php?id=${s}`,document.body.appendChild(l),l.onload=async function(){try{const t=l.contentDocument||l.contentWindow.document,s=t.querySelector('textarea[name="req_message"]'),u=t.querySelector('input[type="submit"].button.submit[name="submit"][value="Отправить"][accesskey="s"]');if(!s||!u)return window.BankMessagesWarn("❌ [ERROR] Не найдена форма редактирования в iframe"),void l.remove();if(!a&&s.value.includes("[FMVbankAmsDone]"))return window.BankMessagesWarn("⚠️ [EDIT] Обнаружен [FMVbankAmsDone], редактирование запрещено"),l.remove(),void alert("Извините! Администратор уже обработал Вашу запись в банке. Пожалуйста, обратитесь в Приёмную, если нужно будет внести изменения.");if(!a&&s.value.includes("[FMVbankAmsCheck]"))return window.BankMessagesWarn("⚠️ [EDIT] Обнаружен [FMVbankAmsCheck], редактирование запрещено"),l.remove(),void alert("Извините! Администратор уже начал обрабатывать Вашу запись в банке. Пожалуйста, обратитесь в Приёмную, если нужно будет внести изменения.");const d=await FMVbank.storageGet(i,"fmv_bank_info_");d[n]=e.data,delete d[r];if(!FMVbank.storageSet(d,i,"fmv_bank_info_"))return l.remove(),void alert("Попробуйте нажать на кнопку еще раз.");s.value=`${c}[FMVbank]${n}[/FMVbank]${o}`,window.BankMessagesLog("✅ [EDIT] Текст вставлен в форму редактирования");let m,f=null,p=!1;m=setInterval(()=>{try{const e=l.contentWindow.location.href;window.BankMessagesLog("🔍 [EDIT] Проверяем URL iframe:",e),e.includes("/viewtopic.php?")&&(f=e,p=!0,window.BankMessagesLog("✅ [EDIT] Обнаружен редирект на:",f),clearInterval(m),l.remove(),window.BankMessagesLog("🟩 [EDIT] Переходим по ссылке:",f),window.location.reload())}catch(e){window.BankMessagesLog("⚠️ [EDIT] CORS или другая ошибка при проверке redirect:",e.message)}},500),setTimeout(()=>{clearInterval(m),p||(window.BankMessagesWarn("⚠️ [EDIT] Редирект не обнаружен за 10 секунд"),l.remove())},1e4),u.click(),window.BankMessagesLog("🟩 [SENT] EDIT_PURCHASE form submitted в iframe")}catch(e){window.BankMessagesError("❌ [ERROR] Ошибка при работе с iframe:",e),l.remove()}},l.onerror=function(){window.BankMessagesError("❌ [ERROR] Не удалось загрузить страницу редактирования"),l.remove()}}),(async()=>{try{const e=await window.BankRetry(()=>scrapeUsers(),{retries:2,baseDelay:700,maxDelay:6e3,timeoutMs:15e3},"scrapeUsers");window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.users_list,users_list:e}),"users_list"),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (users_list)");const o=await window.BankRetry(()=>fetchProfileInfo(),{retries:4,baseDelay:900,maxDelay:9e3,timeoutMs:2e4},"fetchProfileInfo"),n=await window.BankGetLastValue(0,{label:window.BankLabel.message100});await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between getLastValue (msg100_old)");const r=await window.BankGetLastValue(0,{label:window.BankLabel.reputation100});await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between getLastValue (rep100_old)");const s=await window.BankGetLastValue(0,{label:window.BankLabel.positive100});await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between getLastValue (pos100_old)");const i=await window.BankGetLastValue(o.date,{label:window.BankLabel.month,is_month:!0});window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.profile_info,msg100_old:n,msg100_new:o.messages,rep100_old:r,rep100_new:o.respect,pos100_old:s,pos100_new:o.positive,month_old:i,month_new:window.BankGetToday(),money:o.money}),"profile_info"),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between getLastValue (pos100_old)");const a=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:window.BankLabel.banner_mayak.split(" ").join(" AND ")}),{retries:3,baseDelay:800,maxDelay:7e3,timeoutMs:15e3},"scrapePosts(banner_mayak)");window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.banner_mayak,banner_mayak_flag:!Array.isArray(a)||0===a.length}),"banner_mayak_flag"),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (banner_mayak)");const c=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:window.BankLabel.banner_reno.split(" ").join(" AND ")}),{retries:3,baseDelay:800,maxDelay:7e3,timeoutMs:15e3},"scrapePosts(banner_reno)");window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.banner_reno,banner_reno_flag:!Array.isArray(c)||0===c.length}),"banner_reno_flag"),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (banner_reno)");const l=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:window.BankLabel.ads.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(ads_seed)");window.BankQueueJob(t,async e=>{await window.BankSendPosts(e,{seedPosts:l,label:window.BankLabel.ads,forums:window.BankForums.ads,type:window.BankPostMessagesType.ads,is_ads:!0,title_prefix:window.BankPrefix.ads})}),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (ads)");const u=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:window.BankLabel.first_post.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:15e3},"scrapePosts(first_post)");window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.first_post,first_post_flag:!Array.isArray(u)||0===u.length}),"first_post_flag"),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (first_post)");const d=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:1,keywords:window.BankLabel.personal_posts.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(personal_seed)");window.BankQueueJob(t,async e=>{await window.BankSendPosts(e,{seedPosts:d,label:window.BankLabel.personal_posts,forums:window.BankForums.personal_posts,type:window.BankPostMessagesType.personal_posts,is_ads:!1})}),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (personal)");const m=await window.BankRetry(()=>window.scrapePosts(window.UserLogin,window.BankForums.bank,{title_prefix:window.BankPrefix.bank,stopOnNthPost:10,keywords:window.BankLabel.plot_posts.split(" ").join(" AND ")}),{retries:3,baseDelay:900,maxDelay:8e3,timeoutMs:18e3},"scrapePosts(plot_seed)");window.BankQueueJob(t,async e=>{await window.BankSendPosts(e,{seedPosts:m,label:window.BankLabel.plot_posts,forums:window.BankForums.plot_posts,type:window.BankPostMessagesType.plot_posts,is_ads:!1})}),await window.BankHumanPause(window.SCRAPE_BASE_GAP_MS,window.SCRAPE_JITTER_MS,"between scrapes (plot)"),window.BankQueueMessage(t,()=>({type:window.BankPostMessagesType.first_post_missed,first_post_missed_flag:Array.isArray(d)&&d.length>0||Array.isArray(m)&&m.length>0}),"first_post_missed_flag"),window.BankMessagesLog("🏁 [DONE] sequential scrape+send flow finished")}catch(e){window.BankMessagesWarn("❌ [ERROR] Sequential scrape flow aborted:",e?.message||e)}})()}),function(){window.renderExtraFieldsAsHTML=function(e){if(/\/profile\.php\b/.test(location.pathname)&&/section=fields/.test(location.search))return;const t=function(e){const t=new Set;return(Array.isArray(e)?e:[e]).forEach(e=>{const o=String(e).trim();if(/^\d+$/.test(o))return void t.add(o);const n=o.match(/(?:^|[-_])fld(\d+)$/i);if(n)return void t.add(n[1]);const r=o.match(/^(\d+)\s*-\s*(\d+)$/);if(r){const e=Math.min(+r[1],+r[2]),o=Math.max(+r[1],+r[2]);for(let n=e;n<=o;n++)t.add(String(n))}}),[...t]}(e);if(!t.length)return;const o=e=>/<([a-zA-Z!\/?][^>]*)>/.test(e);function n(e){e.querySelectorAll("a.modal-link").forEach(e=>{e.querySelectorAll(":scope > br").forEach(e=>e.remove())}),e.querySelectorAll(":scope > br").forEach(e=>e.remove())}function r(e){const t=function(e){const t=new Set;[`.pa-fld${e}`,`[class~="pa-fld${e}"]`,`[class*="fld${e}"]`,`[id*="fld${e}"]`,`[data-fld="${e}"]`].forEach(e=>document.querySelectorAll(e).forEach(e=>t.add(e)));const o=[];return[...t].forEach(e=>{const t=e.querySelector?.(".pa-value, .field-value, .value")||null;o.push(t||e)}),o.filter(e=>{if(!e)return!1;const t=(e.innerHTML||"").trim(),o=(e.textContent||"").trim();return t||o})}(e);t.forEach(e=>{if(!e||"1"===e.dataset.htmlRendered)return;const t=(e.innerHTML||"").trim(),r=(e.textContent||"").trim();if(!t&&!r)return;if(o(t)&&!t.includes("&lt;")&&!t.includes("&gt;"))return n(e),void(e.dataset.htmlRendered="1");const s=(e=>{const t=document.createElement("textarea");return t.innerHTML=e,t.value})(t||r);(s!==t||o(s))&&(e.innerHTML=s,n(e),e.dataset.htmlRendered="1")})}t.forEach(r);new MutationObserver(()=>t.forEach(r)).observe(document.documentElement,{childList:!0,subtree:!0})};const e=window.FIELDS_WITH_HTML,t=Array.isArray(e)?e:"string"==typeof e&&e.trim()?[e.trim()]:[];t.length&&window.renderExtraFieldsAsHTML(t)}();