# üîÑ –û—Ç—á—ë—Ç –æ –∑–∞–º–µ–Ω–µ FMV.fetchUsers

**–î–∞—Ç–∞**: 2025-10-10  
**–ó–∞–¥–∞—á–∞**: –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—É—é jQuery-–≤–µ—Ä—Å–∏—é `FMV.fetchUsers` –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ `scrapeUsers`

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –£–ª—É—á—à–µ–Ω `scrapeUsers`

**–§–∞–π–ª**: [src/profile/fields/bank_common.js:1-148](src/profile/fields/bank_common.js#L1-L148)

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (sessionStorage, 30 –º–∏–Ω, –∫–ª—é—á `fmv_users_cache_v2`)
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `opts` —Å `force`, `maxPages`, `batchSize`
- ‚úÖ –ü–æ–ª–µ `code: 'user' + id` –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `name` (locale-aware, —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω (`normSpace` - —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ `\u00A0`)
- ‚úÖ CP1251 –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (—á–µ—Ä–µ–∑ `window.fetchHtml` –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–ø–æ 5 —Å—Ç—Ä–∞–Ω–∏—Ü –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**:
```javascript
[
  { id: 5, code: 'user5', name: '–ò–º—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' },
  // ... –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ name
]
```

---

### 2. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å `FMV.fetchUsers`

**–§–∞–π–ª**: [src/core/common_users.js](src/core/common_users.js)

–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç:
- `FMV.fetchUsers(opts)` - –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- `FMV.invalidateUsersCache()` - –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- üöÄ Async/await –≤–º–µ—Å—Ç–æ jQuery Deferred
- ‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ 1000 —Å—Ç—Ä–∞–Ω–∏—Ü (vs 50)
- üíæ –ö—ç—à –Ω–∞ 30 –º–∏–Ω—É—Ç
- üî§ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä—É—Å—Å–∫–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ (CP1251)
- üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É

---

### 3. –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è

**–§–∞–π–ª**: [src/core/common.js:190-191](src/core/common.js#L190-L191)

–£–¥–∞–ª–µ–Ω–æ ~110 —Å—Ç—Ä–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ jQuery –∫–æ–¥–∞.

---

### 4. –ò–∑–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤ –≤ `ui.js`

**–§–∞–π–ª**: [src/episodes/ui.js:350-355](src/episodes/ui.js#L350-L355)

**–ë—ã–ª–æ** (jQuery Deferred):
```javascript
FMV.fetchUsers().done(function(list){
  knownUsers=(list||[]).slice();
  if (opts.prefill!==false) prefillFrom(initialRaw);
}).fail(function(msg){
  $ac.html('<div class="ac-item"><span class="muted">'+(msg||'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏')+'</span></div>').show();
});
```

**–°—Ç–∞–ª–æ** (Promise):
```javascript
FMV.fetchUsers().then(function(list){
  knownUsers=(list||[]).slice();
  if (opts.prefill!==false) prefillFrom(initialRaw);
}).catch(function(msg){
  $ac.html('<div class="ac-item"><span class="muted">'+(msg||'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏')+'</span></div>').show();
});
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- `.done()` ‚Üí `.then()` ‚úÖ
- `.fail()` ‚Üí `.catch()` ‚úÖ

---

### 5. –û–±–Ω–æ–≤–ª–µ–Ω—ã build scripts

**–§–∞–π–ª**: [dist/build-head-bundle.sh:16-18](dist/build-head-bundle.sh#L16-L18)

–î–æ–±–∞–≤–ª–µ–Ω MODULE 2: `common_users.js` —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π `FMV.fetchUsers`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ HEAD bundle** (–±—ã–ª–æ 7 –º–æ–¥—É–ª–µ–π, —Å—Ç–∞–ª–æ 8):
1. common.js
2. **common_users.js** ‚Üê –Ω–æ–≤—ã–π!
3. helpers.js
4. profile_from_user.js
5. check_group.js
6. load_main_users_money.js
7. bank_common.js
8. bank/parent.js

---

### 6. –ü–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã bundle —Ñ–∞–π–ª—ã

```bash
./dist/build-head-bundle.sh
./dist/build-body-bundle.sh
npx terser dist/head-bundle.js --compress --mangle -o dist/head-bundle.min.js
npx terser dist/body-bundle.js --compress --mangle -o dist/body-bundle.min.js
```

**–†–∞–∑–º–µ—Ä—ã**:
- HEAD bundle: 66KB ‚Üí 28KB –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (+4KB –∏–∑-–∑–∞ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è)
- BODY bundle: 260KB ‚Üí 136KB –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è | –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------------|---------------|--------------|-----------|
| **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è** | jQuery Deferred | Async/await Promise | ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** | jQuery –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω | –ù–∞—Ç–∏–≤–Ω—ã–π JS | ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | sessionStorage 30 –º–∏–Ω | sessionStorage 30 –º–∏–Ω | üü∞ –†–∞–≤–Ω–æ |
| **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å** | 5 —Å—Ç—Ä–∞–Ω–∏—Ü | 5 —Å—Ç—Ä–∞–Ω–∏—Ü | üü∞ –†–∞–≤–Ω–æ |
| **–ú–∞–∫—Å–∏–º—É–º —Å—Ç—Ä–∞–Ω–∏—Ü** | 50 | 1000 | ‚úÖ +20x |
| **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö** | `{id, code, name}` | `{id, code, name}` | üü∞ –†–∞–≤–Ω–æ |
| **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** | Locale-aware | Locale-aware | üü∞ –†–∞–≤–Ω–æ |
| **CP1251** | –î–∞ | –î–∞ | üü∞ –†–∞–≤–Ω–æ |
| **–†–∞–∑–º–µ—Ä –∫–æ–¥–∞** | ~110 —Å—Ç—Ä–æ–∫ | ~145 —Å—Ç—Ä–æ–∫ | –ß—É—Ç—å –±–æ–ª—å—à–µ |

---

## ‚ö†Ô∏è –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç:
- `.then()` –∏ `.catch()` —Ä–∞–±–æ—Ç–∞—é—Ç —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ Promise
- –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è: `FMV.fetchUsers(opts)`

### ‚ö†Ô∏è –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚ùå `.done()` - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ Promise
- ‚ùå `.fail()` - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ Promise
- ‚ùå `.always()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.finally()` –≤–º–µ—Å—Ç–æ

**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω–∏—Ç—å `.done()` ‚Üí `.then()` –∏ `.fail()` ‚Üí `.catch()` –≤–µ–∑–¥–µ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–°–¥–µ–ª–∞–Ω–æ**: –í `ui.js` —É–∂–µ –∑–∞–º–µ–Ω–µ–Ω–æ ‚úÖ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å:
1. ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç jQuery –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ 1000 —Å—Ç—Ä–∞–Ω–∏—Ü –≤–º–µ—Å—Ç–æ 50
3. ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π async/await –∫–æ–¥
4. ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å —É–º–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
5. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω

### –ß—Ç–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
1. üü∞ –ö—ç—à –Ω–∞ 30 –º–∏–Ω—É—Ç
2. üü∞ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å (5 —Å—Ç—Ä–∞–Ω–∏—Ü)
3. üü∞ CP1251 –ø–æ–¥–¥–µ—Ä–∂–∫–∞
4. üü∞ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
5. üü∞ –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö

### –†–∞–∑–º–µ—Ä—ã:
- HEAD bundle: **62KB** ‚Üí **66KB** (+4KB, +6%)
- HEAD min: **28KB** ‚Üí **28KB** (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ gzip)

---

## üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ:
```javascript
const users = await FMV.fetchUsers();
// [{id: 1, code: 'user1', name: '–ò–º—è'}, ...]
```

### –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
```javascript
const users = await FMV.fetchUsers({
  force: true,        // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
  maxPages: 500,      // –ú–∞–∫—Å–∏–º—É–º 500 —Å—Ç—Ä–∞–Ω–∏—Ü
  batchSize: 10       // –ü–æ 10 —Å—Ç—Ä–∞–Ω–∏—Ü –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
});
```

### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:
```javascript
FMV.invalidateUsersCache();
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã. Bundle —Ñ–∞–π–ª—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ

**–ê–≤—Ç–æ—Ä**: Claude Code  
**–í–µ—Ä—Å–∏—è**: 2.0.0
