/*!
 * QuadroBoards Automatizations - HEAD BUNDLE
 * @version 1.0.0
 */ !function(){"use strict";let e=window.FMV=window.FMV||{};e.escapeHtml=e.escapeHtml||function(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},e.normSpace=e.normSpace||function(e){return String(e??"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim()},e.waitForSelector=e.waitForSelector||function(e,t=8e3){return new Promise((r,n)=>{let i=document.querySelector(e);if(i)return r(i);let a=new MutationObserver(()=>{let t=document.querySelector(e);t&&(a.disconnect(),r(t))});a.observe(document.documentElement,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),n(Error("timeout: "+e))},t)})},e.sleep=e.sleep||function(e){return new Promise(t=>setTimeout(t,e))},e.readTagText=e.readTagText||function(t,r){if(!t)return"";let n=t.querySelector(r);return e.normSpace(n?n.textContent??"":"")},e.idToNameFromPage=e.idToNameFromPage||function(){let t=new Map;return document.querySelectorAll('a[href*="profile.php?id="]').forEach(r=>{let n=r.href.match(/profile\.php\?id=(\d+)/i),i=e.normSpace(r.textContent||"");n&&i&&!t.has(n[1])&&t.set(n[1],i)}),t},e.parseOrderStrict=e.parseOrderStrict||function(t){let r=e.normSpace(t);return r?/^-?\d+$/.test(r)?{ok:!0,value:parseInt(r,10),html:e.escapeHtml(r)}:{ok:!1,html:`<span class="fmv-missing">Ошибка! Нужен формат целого числа (пример: -3 или 5)</span> — ${e.escapeHtml(r)}`}:{ok:!1,html:""}},e.extractUserIdsFromTags=e.extractUserIdsFromTags||function(e){let t=new Set;return String(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)},e.buildIdToNameMapFromTags=e.buildIdToNameMapFromTags||async function(t){if(window.__FMV_ID_TO_NAME_MAP__ instanceof Map&&window.__FMV_ID_TO_NAME_MAP__.size)return window.__FMV_ID_TO_NAME_MAP__;let r=e.extractUserIdsFromTags(t),n=new Map;return"function"!=typeof window.getProfileNameById||await Promise.all(r.map(async e=>{try{let t=await window.getProfileNameById(e);t&&n.set(e,t)}catch{}})),n},e.parseCharactersUnified=e.parseCharactersUnified||function(t,r,n=window.profileLink){let i=String(t||"").trim();if(!i)return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:""};if(!/^\s*user\d+(?:\s*=\s*[^;]+)?(?:\s*;\s*user\d+(?:\s*=\s*[^;]+)?)*\s*$/i.test(i))return{ok:!1,participantsLower:[],masksByCharLower:new Map,htmlParticipants:"",htmlMasks:"",htmlError:`<span class="fmv-missing">Ошибка формата! Нужен вид: userN; userM=маска; userM=маска; …</span>`};let a=i.split(/\s*;\s*/).filter(Boolean),l=new Set,o=new Map,s=[];for(let c of a){let[u,f]=c.split("="),p=String(Number((u.match(/user(\d+)/i)||[,""])[1])),m=("user"+p).toLowerCase();l.add(m);let h="function"==typeof n?n(p,r?.get(p)):e.escapeHtml(`user${p}`);if(f){let d=e.normSpace(f);o.has(m)||o.set(m,new Set),o.get(m).add(d.toLowerCase()),s.push(`${h}=${e.escapeHtml(d)}`)}}let w=Array.from(l),g=w.map(t=>{let i=Array.from(o.get(t)||[]),a=String(+t.replace(/^user/i,"")),l="function"==typeof n?n(a,r?.get(a)):e.escapeHtml(`user${a}`);return i.length?`${l} [as ${e.escapeHtml(i.join(", "))}]`:l}).join("; ");return{ok:!0,participantsLower:w,masksByCharLower:o,htmlParticipants:g,htmlMasks:s.join("; "),htmlError:""}},e.renderParticipantsHtml=e.renderParticipantsHtml||function(t,r,n=window.profileLink){let i=e.parseCharactersUnified(t,r,n);if(i&&i.ok)return i.htmlParticipants;let a=e.escapeHtml(String(t??"")),l=i&&i.htmlError&&i.htmlError.trim()?i.htmlError:`<span class="fmv-missing">Аааа! Нужен формат: userN; userM=маска; userK</span> — ${a}`;return l},window.scrapeUsers=async function t(r={}){let n=r.force||!1,i=r.maxPages||1e3,a=r.batchSize||5,l="fmv_users_cache_v2",o=e=>{if(!e)return null;let t=e.match(/(?:[?&/])id=(\d+)/i);return t?Number(t[1]):null},s=(()=>{if(n)return null;try{let e=sessionStorage.getItem(l);if(!e)return null;let t=JSON.parse(e);if(!t||!t.time||!t.data||Date.now()-t.time>18e5)return null;return t.data}catch(r){return null}})();if(s)return window.scrapedUsers=s,s;async function c(t){let r=`/userlist.php?p=${t}`,n;if("function"==typeof window.fetchHtml)n=await window.fetchHtml(r);else{let i=await fetch(r,{credentials:"same-origin"});if(!i.ok)throw Error(`HTTP ${i.status} (${r})`);n=await i.text()}let a=new DOMParser().parseFromString(n,"text/html"),l=[];return a.querySelectorAll("td.tcl.username span.usersname").forEach(t=>{let r=t.querySelector("a[href*='id=']"),n=e.normSpace(r?.textContent||""),i=o(r?.getAttribute("href")||"");n&&Number.isFinite(i)&&l.push({id:i,code:"user"+i,name:n})}),l}let u=new Set,f=[],p=await c(1);p.forEach(e=>{u.has(e.code)||(u.add(e.code),f.push(e))});for(let m=2;m<=i;m+=a){let h=[];for(let d=0;d<a&&m+d<=i;d++)h.push(m+d);let w=await Promise.all(h.map(e=>c(e).catch(()=>[]))),g=!1;for(let y of w){let _=y.filter(e=>!u.has(e.code));_.length>0&&(g=!0,_.forEach(e=>{u.add(e.code),f.push(e)}))}if(!g)break;m+a<=i&&await e.sleep(300)}return f.sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"})),(e=>{try{sessionStorage.setItem(l,JSON.stringify({time:Date.now(),data:e}))}catch(t){}})(f),window.scrapedUsers=f,f},window.fetchProfileInfo=async function e(t=window.UserID){var r;if(null==t)throw Error("UserID не задан (ни аргументом, ни в window.UserID)");let n=`/profile.php?id=${encodeURIComponent(t)}`,i=await fetch(n,{credentials:"same-origin"});if(!i.ok)throw Error(`HTTP ${i.status} для ${n}`);let a=await i.text(),l=new DOMParser().parseFromString(a,"text/html"),o=(e,t=l)=>(t.querySelector(e)?.textContent||"").replace(/\u00A0/g," ").trim(),s=e=>{if(!e)return null;let t=String(e).replace(/[^\d+-]/g,""),r=t.match(/^[+-]?\d+/);return r?Number(r[0]):null},c=await (async()=>{let e=window.MainUsrFieldResolver?.getFieldValue;if(e)try{return await e({doc:l,fieldId:6})}catch(t){console.warn("[fetchProfileInfo] getFieldValue error:",t)}let r=o("li#pa-fld6 strong");if(r)return r;let n=o("li#pa-fld6");return n?n.split(":").slice(-1)[0].trim():""})(),u=(()=>{let e=s(c);return Number.isFinite(e)?e:0})(),f=o("li#pa-register-date strong"),p=o("li#pa-respect strong"),m=o("li#pa-positive strong"),h=o("li#pa-posts strong");return{id:Number(t),date:(e=>{let t=(e||"").match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);if(!t)return null;let r=Number(t[1]),n=Number(t[2]),i=Number(t[3]);return[i,n,r]})(f),respect:s(p),positive:s(m),messages:(r=h,s((r||"").split(" - ")[0])),money:u}},window.encodeWithSep=function e(t,r=!1){let n=t.trim().split(/\s+/),i=n.map(e=>e.split("").map(e=>/[A-Za-z0-9'`~_]/.test(e)?e:encodeURIComponent(e)).join(""));return i.join(r?"+AND+":"+")},window.scrapePosts=async function t(r,n,i=!1,a="",{maxPages:l=999,delayMs:o=300}={}){if(!r)throw Error("author обязателен");if(!n||Array.isArray(n)&&0===n.length)throw Error("forums обязателен");let s=Array.isArray(n)?n.join(","):String(n),c=e=>{let t=new URL("/search.php",location.origin);return t.search=new URLSearchParams({action:"search",author:window.encodeWithSep(r),forums:s,sort_dir:"DESC",p:String(e)}).toString(),t.toString()};async function u(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){let t=await fetchHtml(e);return new DOMParser().parseFromString(t,"text/html")}let r=await fetch(e,{credentials:"include"}),n=await r.text();return new DOMParser().parseFromString(n,"text/html")}let f=e=>{let t=0;for(let r of e)t=(t<<5)-t+r.charCodeAt(0),t|=0;return t},p=(e="")=>{let t=document.createElement("div");t.innerHTML=e,t.querySelectorAll(".quote-box.hide-box").forEach(e=>{let t=e.querySelector("blockquote");if(t){let r=document.createElement("div");r.innerHTML=t.innerHTML,e.replaceWith(r)}}),t.querySelectorAll("cite").forEach(e=>e.remove()),t.querySelectorAll(".code-box").forEach(e=>{let t=e.querySelector("pre"),r=t?t.textContent:"",n=document.createElement("div");n.textContent=r||"",e.replaceWith(n)}),t.querySelectorAll(".custom_tag, .hidden_tag, characters, location, order").forEach(e=>e.remove()),t.querySelectorAll('script[type="text/html"]').forEach(e=>{let t=document.createElement("div");t.innerHTML=e.textContent||"",t.querySelectorAll("p, br").forEach(e=>e.insertAdjacentText("afterend","\n"));let r=(t.textContent||"").replace(/\u00A0/g," ").replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");e.insertAdjacentText("beforebegin",r?`
${r}
`:""),e.remove()}),t.querySelectorAll("ADDRESS,ARTICLE,ASIDE,BLOCKQUOTE,DIV,DL,DT,DD,FIELDSET,FIGCAPTION,FIGURE,FOOTER,FORM,H1,H2,H3,H4,H5,H6,HEADER,HR,LI,MAIN,NAV,OL,P,PRE,SECTION,TABLE,THEAD,TBODY,TFOOT,TR,UL,BR").forEach(e=>{"BR"===e.tagName?e.insertAdjacentText("beforebegin","\n"):e.insertAdjacentText("afterend","\n")});let r=(t.textContent||"").replace(/\u00A0/g," ");r=(r=r.replace(/\[\/?indent\]/gi,"").replace(/\[\/?float(?:=[^\]]+)?\]/gi,"").replace(/\[DiceFM[^\]]*?\]/gi,"")).replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n");let n=[];for(let i of r.split("\n")){let a=i.trim();""===a?n.length&&""!==n[n.length-1]&&n.push(""):n.push(a)}return n.join("\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n").replace(/^\n+|\n+$/g,"").trim()},m=(e="")=>e.replace(/\[html\]([\s\S]*?)\[\/html\]/gi,(e,t)=>p(t)),h=e=>{let t=e.querySelector("h3 > span"),r=t?t.querySelectorAll("a"):[],n=r[1]?.textContent?.trim()||"",i=r[2]?new URL(r[2].getAttribute("href"),location.href).href:"",a=e.querySelector(".post-content"),l=a?.innerHTML?.trim()||"";l=m(l);let o=p(l);return{title:n,src:i,text:o,html:l,symbols_num:o.length}},d=e=>[...e.querySelectorAll(".post")].map(h),w=e=>f(e.map(e=>e.src).join("\n"));async function g(){let t=await u(c(1)),r=d(t);if(!r.length)return _([]);let n=w(r);for(let i of r){if(a&&i.src===a)return _([]);if(i.symbols_num>0)return _([i])}await e.sleep(o);for(let s=2;s<=l;s++){let f=await u(c(s)),p=d(f);if(!p.length||w(p)===n)break;for(let m of p){if(a&&m.src===a)return _([]);if(m.symbols_num>0)return _([m])}await e.sleep(o)}return _([])}async function y(){let t=[],r=await u(c(1)),n=d(r);if(!n.length)return _([]);let i=w(n),s=e=>{for(let r of e){if(a&&r.src===a)return!0;t.push(r)}return!1};if(s(n))return _(t);await e.sleep(o);for(let f=2;f<=l;f++){let p=await u(c(f)),m=d(p);if(!m.length||w(m)===i||s(m))break;await e.sleep(o)}return _(t)}if(i)return await g();return await y();function _(e){let t=e.slice().reverse();try{console.table(t.map(e=>({title:e.title,src:e.src,symbols_num:e.symbols_num,textPreview:e.text.slice(0,120).replace(/\s+/g," ")})))}catch{console.log(t)}return window.__scrapedPosts=t,t}},window.scrapeTopicFirstPostLinks=async function t(r,n,{maxPages:i=999,delayMs:a=300}={}){if(!r)throw Error("author обязателен");if(!Array.isArray(n)||0===n.length)throw Error("forums обязателен и должен быть массивом");let l=n.join(","),o=e=>{let t=new URL("/search.php",location.origin);return t.search=new URLSearchParams({action:"search",author:window.encodeWithSep(r),forums:l,sort_dir:"DESC",show_as:"topics",p:String(e)}).toString(),t.toString()};async function s(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){let t=await fetchHtml(e);return new DOMParser().parseFromString(t,"text/html")}let r=await fetch(e,{credentials:"include"}),n=await r.text();return new DOMParser().parseFromString(n,"text/html")}let c=e=>{let t=0;for(let r of e)t=(t<<5)-t+r.charCodeAt(0),t|=0;return t};function u(e){for(let t of e.children)if("A"===t.tagName)return t;return null}function f(e){let t=[...e.querySelectorAll(".tclcon")],r=[];for(let n of t){let i=n.querySelector(".byuser-username")?.textContent?.trim();if(!i){let a=n.closest("tr");i=a?.querySelector(".tcr .byuser-username")?.textContent?.trim()||""}if(i!==targetAuthor)continue;let l=u(n),o=l?.getAttribute("href");o&&r.push(new URL(o,location.href).href)}return r}function p(e){try{let t=new URL(e,location.href);if(("/viewtopic.php"===t.pathname||t.pathname.endsWith("/viewtopic.php"))&&t.searchParams.has("id")){let r=new URL("/viewtopic.php",t.origin);return r.searchParams.set("id",t.searchParams.get("id")),r.href}if(t.searchParams.has("id")){let n=new URL("/viewtopic.php",t.origin);return n.searchParams.set("id",t.searchParams.get("id")),n.href}return t.href}catch{return e}}function m(e,t){let r=e.querySelector(".post.topicpost a.permalink");if(r?.getAttribute("href")||(r=e.querySelector(".post.topicpost h3 a[href*='#p']"))?.getAttribute("href")||(r=e.querySelector(".post.topicpost a[href*='#p']"))?.getAttribute("href"))return new URL(r.getAttribute("href"),t).href;try{let n=new URL(t).searchParams.get("id");if(n)for(let i of e.querySelectorAll("a[href*='#p']")){let a=new URL(i.getAttribute("href"),t);if(a.pathname.endsWith("/viewtopic.php")&&a.searchParams.get("id")===n)return a.href}}catch{}return null}let h=await s(o(1)),d=f(h),w=c(d.join("\n")),g=[...d];await e.sleep(a);for(let y=2;y<=i;y++){let _=await s(o(y)),$=f(_),S=c($.join("\n"));if(S===w)break;g.push(...$),await e.sleep(a)}let x=[...new Set(g)],E=[];for(let F of x){let A=p(F);try{let C=await s(A),T=m(C,A);if(T){let I=T.match(/#p(\d+)/);if(I){let b=I[1],M=new URL(T,A),P=new URL("/viewtopic.php",M.origin);P.searchParams.set("pid",b),E.push(`${P.href}#p${b}`)}else E.push(T)}}catch{}await e.sleep(a)}return window.__scrapedTopicFirstPosts=E,E}}(),window.FMV||(window.FMV={}),FMV.fetchUsers=async function(e={}){if("function"!=typeof window.scrapeUsers)throw Error("window.scrapeUsers не найдена. Убедитесь, что common.js загружен.");return await window.scrapeUsers(e)},FMV.invalidateUsersCache=function(){try{sessionStorage.removeItem("fmv_users_cache_v2"),sessionStorage.removeItem("fmv_users_cache_v1")}catch(e){}};const __cp1251Map=(()=>{let e={};for(let t=1040;t<=1103;t++)e[t]=t-848;return e[1025]=168,e[1105]=184,e})();function encodeURIcp1251(e){let t=[];for(let r of String(e)){let n=r.charCodeAt(0);if(void 0!==__cp1251Map[n]&&(n=__cp1251Map[n]),n<=255)n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||45===n||46===n||95===n||126===n?t.push(String.fromCharCode(n)):t.push("%"+n.toString(16).toUpperCase().padStart(2,"0"));else{let i=`&#${r.charCodeAt(0)};`;for(let a of i){let l=a.charCodeAt(0);l>=48&&l<=57||l>=65&&l<=90||l>=97&&l<=122||45===l||46===l||95===l||126===l?t.push(String.fromCharCode(l)):t.push("%"+l.toString(16).toUpperCase().padStart(2,"0"))}}}return t.join("").replace(/\+/g,"%2B")}function serializeFormCP1251_SelectSubmit(e,t="save"){let r=[];for(let n of Array.from(e.elements||[])){if(!n.name||n.disabled)continue;let i=(n.type||"").toLowerCase();if("submit"===i||"button"===i){n.name===t&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value||""));continue}if("preview"!==n.name&&("checkbox"!==i&&"radio"!==i||n.checked)){if("SELECT"===n.tagName&&n.multiple){for(let a of n.options)a.selected&&r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(a.value));continue}r.push(encodeURIcp1251(n.name)+"="+encodeURIcp1251(n.value??""))}}return r.join("&")}async function fetchCP1251Doc(e){let t=await fetch(e,{credentials:"include"});if(!t.ok)throw Error(`GET ${e} → HTTP ${t.status}`);let r=await t.arrayBuffer(),n=new TextDecoder("windows-1251").decode(r);return new DOMParser().parseFromString(n,"text/html")}async function fetchCP1251Text(e,t){let r=await fetch(e,t),n=await r.arrayBuffer();return{res:r,text:new TextDecoder("windows-1251").decode(n)}}function serializeFormCP1251(e){let t=[];for(let r of Array.from(e.elements||[]))if(r.name&&!r.disabled&&("checkbox"!==r.type&&"radio"!==r.type||r.checked)){if("SELECT"===r.tagName&&r.multiple){for(let n of r.options)n.selected&&t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(n.value));continue}t.push(encodeURIcp1251(r.name)+"="+encodeURIcp1251(r.value))}return t.join("&")}async function fetchHtml(e){let t=await fetch(e,{credentials:"include"});if(!t.ok)throw Error("HTTP "+t.status);let r=await t.arrayBuffer(),n=t.headers.get("content-type")||"",i=(n.match(/charset=([\w-]+)/i)||[])[1]?.toLowerCase();if(i&&"utf-8"!==i)try{return new TextDecoder(i).decode(r)}catch{}let a=new TextDecoder("utf-8").decode(r),l=a.match(/<meta[^>]+charset\s*=\s*["']?([\w-]+)/i)||a.match(/<meta[^>]+content=["'][^"']*charset\s*=\s*([\w-]+)/i),o=(l&&l[1]||"").toLowerCase();if(!i&&o&&"utf-8"!==o)try{return new TextDecoder(o).decode(r)}catch{}let s=new TextDecoder("windows-1251").decode(r),c=/[ÂÃÐÑ][\u0080-\u00FF]?/g,u=e=>{let t=(e.match(/\b(?:[A-Za-z]+[А-Яа-яЁё]+|[А-Яа-яЁё]+[A-Za-z]+)[A-Za-zА-Яа-яЁё]*\b/g)||[]).length,r=(e.match(c)||[]).length+(e.match(/\uFFFD/g)||[]).length;return{mixed:t,bad:r}},f=u(a),p=u(s);return p.bad>f.bad+3?a:f.bad>p.bad+3||f.mixed>p.mixed+1?s:a}function userLink(e,t="",r=!1){let n=String(e),i=t||`user${n}`,a=(window.SITE_URL||location.origin).replace(/\/+$/,"");return r?`[url=${a}/profile.php?id=${n}]${i}[/url]`:"function"==typeof window.profileLink?window.profileLink(n,i):`<a href="/profile.php?id=${n}">${i}</a>`}function missingUser(e,t=!1){let r=String(e);return t?`[mark]${r}[/mark]`:`<span class="fmv-missing" data-found="0">${r}</span>`}function topicTitleFromCrumbs(e){let t=e.querySelector("#pun-crumbs1 .crumbs")||e.querySelector(".section .crumbs, .container.crumbs, .crumbs");if(!t)return"";for(let r=t.childNodes.length-1;r>=0;r--){let n=t.childNodes[r];if(n){if(3===n.nodeType){let i=n.nodeValue.replace(/\s+/g," ").trim();if(i)return i}else if(1===n.nodeType&&"A"!==n.tagName&&"EM"!==n.tagName){let a=n.textContent.replace(/\s+/g," ").trim();if(a)return a}}}return""}function parseFromScriptHTML(e){let t=new DOMParser,r=t.parseFromString(`<div>${e}</div>`,"text/html"),n=r.body.firstElementChild,i=[];return n.querySelectorAll("p").forEach(e=>{let t=parseParagraph(e);t&&i.push(t)}),i}function parseFromRendered(e){let t=e.querySelectorAll("p");if(t.length)return Array.from(t).map(parseParagraph).filter(Boolean);let r=e.innerHTML.replace(/<br\s*\/?>/gi,"\n");return r.split(/\n{2,}/).map(e=>{let t=document.createElement("div");return t.innerHTML=`<p>${e}</p>`,parseParagraph(t.firstElementChild)}).filter(Boolean)}function findPostNode(e,t){let r=`p${t}`,n=e.getElementById(r);if(n)return n;let i=e.querySelector(`a[name="${r}"]`);return i?i.closest(".post")||i.closest(".blockpost")||i.parentElement:n=e.querySelector(`[id^="p${t}"]`)}function textFromNodes(e){return e.map(e=>3===e.nodeType?e.nodeValue||"":1===e.nodeType&&e.textContent||"").join("").replace(/\s+/g," ").trim()}function getCurrentGroupId(){let e=Number(document.body?.dataset?.groupId||NaN),t=Number((window&&window.GroupID)??(window&&window.PUNBB&&window.PUNBB.group_id)??(window&&window.PUNBB&&window.PUNBB.user&&window.PUNBB.user.g_id)??e);return Number.isFinite(t)?t:null}async function ensureAllowed(e){let t=getCurrentGroupId(),r=new Set(e.map(String));return null!==t&&r.has(String(t))}window.parseChronoTagsRaw=function(e){let t=t=>e.querySelector(t)?.textContent.trim()||"",r=t("characters"),n=t("masks"),i=(r?r.split(/\s*;\s*/):[]).map(e=>e.trim().toLowerCase()).filter(Boolean),a={};(n||"").split(/\s*;\s*/).forEach(e=>{let t=e.indexOf("=");t>0&&(a[e.slice(0,t).trim().toLowerCase()]=e.slice(t+1).trim())});let l=new Set(i);return Object.keys(a).forEach(e=>l.add(e)),{participantsLower:Array.from(l),masks:a,location:t("location"),order:t("order")}},window.resolveChronoData=async function(e,t={}){let r={...e,idToName:new Map,participantsHtml:"",masksHtml:""},n=new Set;for(let i of e.participantsLower){let a=/^user(\d+)$/i.exec(i);a&&n.add(String(+a[1]))}for(let l of Object.keys(e.masks||{})){let o=/^user(\d+)$/i.exec(l);o&&n.add(String(+o[1]))}for(let s of n)try{r.idToName.set(s,await getProfileNameById(s)||null)}catch{r.idToName.set(s,null)}let c=e=>{let t=/^user(\d+)$/i.exec(e);if(!t)return window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml(e):e;let n=String(+t[1]),i=r.idToName.get(n)||null;return profileLink(n,i)},u=window.FMV&&window.FMV.escapeHtml?window.FMV.escapeHtml:e=>e;return r.participantsHtml=e.participantsLower.map(c).join("; "),r.masksHtml=Object.entries(e.masks||{}).map(([e,t])=>`${c(e)}=${u(t)}`).join("; "),r},window.FMV=window.FMV||{},FMV.escapeHtmlShort=FMV.escapeHtmlShort||function(e="",t=500){let r=String(e),n=r.length>t?r.slice(0,t)+"…":r;return"function"==typeof FMV.escapeHtml?FMV.escapeHtml(n):n},FMV.fetchDoc=FMV.fetchDoc||async function(e){let t=await fetchHtml(e);return"function"==typeof window.parseHTML?window.parseHTML(t):new DOMParser().parseFromString(t,"text/html")},FMV.toCp1251Entities=FMV.toCp1251Entities||function(e){let t=/[\u0000-\u007F\u0400-\u045F\u0401\u0451]/,r="";for(let n of String(e))r+=t.test(n)?n:`&#${n.codePointAt(0)};`;return r},(()=>{"use strict";let e=window.MAKE_NAMES_LINKS??!0;function t(e){let t=new Set;return(e||"").replace(/user(\d+)/gi,(e,r)=>(t.add(String(Number(r))),e)),Array.from(t)}let r=window.fetchHtml||(async e=>{let t=await fetch(e,{credentials:"include"});return await t.text()});window.profileLink=function t(r,n){let i=String(Number(r)),a="string"==typeof n&&n.trim().length>0;if(!a){let l=`user${i}`;return`<span class="fmv-missing" data-user-id="${i}" data-found="0">${FMV.escapeHtml(l)}</span>`}let o=FMV.escapeHtml(n.trim());if(!e)return o;let s=document.createElement("a");return s.className="fmv-user",s.href="/profile.php?id="+encodeURIComponent(i),s.textContent=o,s.setAttribute("data-user-id",i),s.setAttribute("data-found","1"),s.outerHTML},window.profileLinkMeta=function e(t,r){let n=window.profileLink(t,r),i="string"==typeof n&&!/\bfmv-missing\b/.test(n);return{html:String(n||""),found:i,id:String(Number(t)),name:"string"==typeof r&&r.trim()?r.trim():null}};let n=new Map,i=null,a=null;async function l(){if(i)return i;if(a)return a;if(!window.EX_PROFILES||"object"!=typeof window.EX_PROFILES)return console.error("[loadExProfiles] Ошибка: window.EX_PROFILES не задан или имеет неверный формат"),i=new Map;let{topicID:e,commentID:t}=window.EX_PROFILES;if(null==e||null==t)return console.error("[loadExProfiles] Ошибка: отсутствует topicID или commentID в window.EX_PROFILES"),i=new Map;let n=`/viewtopic.php?id=${encodeURIComponent(e)}#p${encodeURIComponent(t)}`;return a=(async()=>{let e=await r(n),t=new DOMParser().parseFromString(e,"text/html"),a=new Map;for(let l of t.querySelectorAll('a[href*="profile.php?id="]')){let o=(l.getAttribute("href")||"").match(/profile\.php\?id=(\d+)/i);if(!o)continue;let s=String(Number(o[1])),c=(l.textContent||"").trim().toLowerCase();c&&!a.has(s)&&a.set(s,c)}return i=a,a})()}async function o(e){let t=await l();return t.get(String(Number(e)))||null}async function s(e){if(e=String(Number(e)),n.has(e))return n.get(e);let t=c(e);if(!t)try{let i=await r(`/profile.php?id=${e}`),a=new DOMParser().parseFromString(i,"text/html");t=u(a)}catch{}if(!t)try{let l=await o(e);l&&(t=`[ex] ${l}`)}catch{}return n.set(e,t||null),t||null}function c(e){let t=Array.from(document.querySelectorAll(`a[href*="profile.php?id=${e}"]`));for(let r of t){let n=(r.textContent||"").trim();if(n&&!/Профил|Profile/i.test(n))return n}return null}function u(e){let t=e.querySelector(".user-ident .username")||e.querySelector(".user-box .username")||null;if(t){let r=(t.textContent||"").trim();if(r)return r}let n=["#pun-title span","h1 span","h1","h2.hn",".hn",".title",".subhead h2"].map(t=>e.querySelector(t)).filter(Boolean).map(e=>(e.textContent||"").trim()).filter(Boolean),i=(e.querySelector("title")?.textContent||"").trim();i&&n.unshift(i);let a=[/Профил[ья]\s*[:\-—–]\s*(.+)$/i,/Просмотр\s+профиля\s*[:\-—–]\s*(.+)$/i,/Profile\s*[:\-—–]\s*(.+)$/i];for(let l of n)for(let o of(l=l.replace(/\s+/g," ").trim(),a)){let s=l.match(o);if(s){let c=s[1].trim(),u=c.replace(/^[«"'\\[]|[»"'\\]]$/g,"").trim();if(u)return u}}return null}window.profileLinkByIdAsync=async function e(t){let r=String(Number(t)),n=await s(r),i=window.profileLinkMeta(r,n);return i},window.extractUserIdsFromString=t,window.getProfileNameById=s})(),/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */ function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID){console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");return}let e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,r=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),n=/^\s*main:\s*usr(\d+)\s*$/i,i=e=>`#${r(e)}, .${r(e)}`,a=new TextDecoder("utf-8"),l,o=()=>l||=new TextDecoder("windows-1251");async function s(e){let t=await fetch(e,{credentials:"same-origin"}),r=await t.arrayBuffer(),n=a.decode(r);if(/charset\s*=\s*windows-1251/i.test(n)||n.includes("�"))try{n=o().decode(r)}catch{}return n}function c(e,t){let r=e.querySelector(i(t)),n=r?.querySelector("strong, b"),a=n?.textContent?.trim();if(!a){let l=(r?.textContent||"").trim();a=l.split(":").slice(-1)[0]?.trim()}return(a||"").replace(/\u00A0/g," ").trim()}let u=new Map;function f(e,t){if(u.has(e))return u.get(e);let r=(async()=>{let r=await s(`/profile.php?id=${encodeURIComponent(e)}`),n=new DOMParser().parseFromString(r,"text/html");return c(n,t)})();return u.set(e,r),r}async function p({doc:t=document,fieldId:r}={}){let a=String(r??e).replace(/\D/g,"")||e,l=`pa-fld${a}`,o=t.querySelector(i(l)),s=function e(t){if(!t)return null;let r=t.ownerDocument.createTreeWalker(t,NodeFilter.SHOW_COMMENT);for(let i;i=r.nextNode();){let a=(i.nodeValue||"").match(n);if(a)return a[1]}return null}(o);if(s)try{return await f(s,l)}catch(u){console.warn("[main-field] remote error:",u)}return c(t,l)}function m(){document.querySelectorAll(i(t)).forEach(e=>(function e(t,r){let i=document.createTreeWalker(t,NodeFilter.SHOW_COMMENT),a=[];for(let l;l=i.nextNode();){let o=(l.nodeValue||"").match(n);o&&a.push({node:l,uid:o[1]})}a.forEach(({node:e,uid:t})=>{f(t,r).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+t,e))})})(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=p),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m,{once:!0}):m()}();const HIDDEN_OPERATIONS=["Подарок из коллекции","Индивидуальная иконка","Иконка из коллекции","Индивидуальная плашка","Плашка из коллекции","Индивидуальный фон","Фон из коллекции","Отказ от персонажа",];function formatBankOperations(e){let t="";return e.forEach((e,r)=>{let n=HIDDEN_OPERATIONS.some(t=>e.title.startsWith(t));t+=n?"[hide=9999999999]":"",t+=`[b]— ${e.title}[/b] = ${e.sum}
`;let i=e.info?.[0];if(!i){t+="\n\n";return}let{comment:a,type:l}=i;Array.isArray(a)&&("plain"===l?t+=a.join("\n"):"list"===l?t+=a.map((e,t)=>`${t+1}. ${e}`).join("\n"):"list separated"===l?t+=a.map((e,t)=>`${t+1}. ${e}`).join("\n\n"):l&&(t+=a.join("\n"))),t+=n?"[/hide]\n\n":"\n\n"}),t.trim()}window.formatBankOperations=formatBankOperations;