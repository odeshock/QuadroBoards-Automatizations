# Тесты системы персональных купонов

## Порядок применения
1. **Operations** (базовые операции)
2. **Item coupons** (бесплатные товары)
3. **Price adjustments** (корректировки цен)
4. **Fixed coupons** (фиксированные скидки)
5. **Percent coupons** (процентные скидки)
6. **Auto discounts** (автоматические скидки)

---

## ✅ Группа 1: Базовые тесты с одним купоном

### ✅ Тест 1.1: Один item купон (достаточно товаров)
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка на 1 подарок"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 40₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽ (5 × 40₽)
Купоны: +40₽
  - Скидка на 1 подарок: 40 × 1 = 40
Корректировки: 0₽ (эффективно 5-1=4 подарка, недостаточно для правила "5 подарков")
Автоскидки: +120₽ (75% от (200-40-0) = 75% от 160)
ИТОГО: -40₽
```
Потому что количество подарков 5 - 1 = 4, а 4 < 5 для работы корректировок

---

### ✅ Тест 1.2: Один item купон (недостаточно товаров)
**Начальная корзина:**
- 2 подарка × 40₽ = 80₽

**Доступные купоны:**
- "Скидка на 3 подарка" (item, value=3, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Попытаться выбрать купон "Скидка на 3 подарка"

**Ожидаемый результат в модалке:**
- Купон не выбирается (серый/недоступен)
- Ошибка: "Недостаточно позиций. Нужно: 3, в корзине: 2."
- Кнопка "Сохранить" disabled

**Ожидаемый результат в итогах:**
```
Подарки: -80₽
Корректировки: 0₽ (недостаточно для правила)
Автоскидки: +60₽ (75% от 80)
ИТОГО: -20₽
```

---

### ✅ Тест 1.3: Один fixed купон (достаточно средств)
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка -100₽ на подарки" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка -100₽"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 100₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +100₽
  - Скидка -100₽: 100
Корректировки: 0₽ (3 подарка < 5, правило не срабатывает)
Автоскидки: +15₽ (75% от (120-100-0) = 75% от 20)
ИТОГО: -5₽
```

---

### ✅ Тест 1.4: Один fixed купон (недостаточно средств)
**Начальная корзина:**
- 1 подарок × 40₽ = 40₽

**Доступные купоны:**
- "Скидка -100₽ на подарки" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка -100₽"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 40₽
- ⚠️ Предупреждение: "Купон применён частично: будет использовано 40 из 100."

**Ожидаемый результат в итогах:**
```
Подарки: -40₽
Купоны: +40₽
  - Скидка -100₽: 40 (частично)
Корректировки: 0₽ (1 подарок < 5, правило не срабатывает)
Автоскидки: 0₽ (остаток = 40-40-0 = 0)
ИТОГО: 0₽
```

---

### ✅ Тест 1.5: Один percent купон
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка 25% на подарки" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка 25%"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 30₽ (25% от 120)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +30₽
  - Скидка 25%: (120-0) × 25% = 30
Корректировки: 0₽ (3 подарка < 5, правило не срабатывает)
Автоскидки: +68₽ (75% от (120-30-0) = 75% от 90, округление вверх)
ИТОГО: -22₽
```

---

## ⚠️ Группа 2: Несколько купонов для ОДНОЙ формы

### ✅ Тест 2.1: Два item купона для одной формы
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок #1" (item, value=1, form=gifts)
- "Скидка на 2 подарка #2" (item, value=2, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 120₽ (40 + 80)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽ (5 подарков)
Купоны: +120₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка на 2 подарка: 40 × 2 = 80
Корректировки: 0₽ (эффективно 5-3=2 подарка, недостаточно для правила "5 подарков")
Автоскидки: +60₽ (75% от (200-120) = 75% от 80)
ИТОГО: -20₽
```

---

### ✅ Тест 2.2: Item + Fixed для одной формы
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 260₽ (80 + 180)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -280₽ (7 подарков)
Купоны: +260₽
  - Скидка на 2 подарка: 40 × 2 = 80
  - Скидка -180₽: 180
Корректировки: +20₽ (эффективно 7-2=5 подарков: 40×1×5 - 180×1 = 20)
Автоскидки: 0₽ (остаток = 280-80-20-180 = 0)
ИТОГО: 0₽
```

---

### ✅ Тест 2.3: Item + Fixed (частичное применение)
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 200₽ (40 + 160)
- ⚠️ Предупреждение под fixed купоном: "Купон применён частично: будет использовано 160 из 180."

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Купоны: +200₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка -180₽: 160 (частично)
Корректировки: 0₽ (эффективно 5-1=4 подарка, недостаточно для правила)
Автоскидки: 0₽ (остаток = 200-200-0 = 0)
ИТОГО: 0₽
```

---

### ⚠️ Тест 2.4: Два Fixed купона (оба применяются полностью)
**Начальная корзина:**
- 6 подарков × 40₽ = 240₽

**Доступные купоны:**
- "Скидка -100₽ #1" (fixed, value=100, form=gifts)
- "Скидка -50₽ #2" (fixed, value=50, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 150₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -240₽
Купоны: +150₽
  - Скидка -100₽: 100
  - Скидка -50₽: 50
Корректировки: +20₽ (6 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +53₽ (75% от (240-150-20) = 75% от 70, округление вверх)
ИТОГО: -17₽
```

---

### ✅ Тест 2.5: Два Fixed купона (второй применяется частично)
**Начальная корзина:**
- 4 подарка × 40₽ = 160₽

**Доступные купоны:**
- "Скидка -100₽ #1" (fixed, value=100, form=gifts)
- "Скидка -100₽ #2" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать первый купон -100₽ #1
3. Выбрать второй купон -100₽ #2

**Ожидаемый результат в модалке:**
- Скидка: 160₽
- Первый купон: предупреждений нет
- ⚠️ Второй купон: "Купон применён частично: будет использовано 60 из 100."

**Ожидаемый результат в итогах:**
```
Подарки: -160₽
Купоны: +160₽
  - Скидка -100₽ #1: 100
  - Скидка -100₽ #2: 60 (частично)
Корректировки: 0₽ (4 подарка < 5, правило не срабатывает)
Автоскидки: 0₽ (остаток = 160-160-0 = 0)
ИТОГО: 0₽
```

---

### ⚠️ Тест 2.6: Fixed + Percent для одной формы
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка -100₽" (fixed, value=100, form=gifts)
- "Скидка 25%" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 120₽ (100 + 20)
- Percent купон видит остаток: 200-20(корректировки)-100(fixed) = 80
- 80 × 25% = 20
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Купоны: +120₽
  - Скидка -100₽: 100
  - Скидка 25%: (200-20-100) × 25% = 80 × 25% = 20
Корректировки: +20₽ (5 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +45₽ (75% от (200-120-20) = 75% от 60)
ИТОГО: -15₽
```

---

### ⚠️ Тест 2.7: Item + Fixed + Percent (полный набор)
**Начальная корзина:**
- 8 подарков × 40₽ = 320₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)
- "Скидка 25%" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать все три купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 240₽ (40 + 180 + 20)
- Percent купон видит остаток: 320-40(item)-20(корректировки)-180(fixed) = 80
- 80 × 25% = 20
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -320₽ (8 подарков)
Купоны: +240₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка -180₽: 180
  - Скидка 25%: (320-40-20-180) × 25% = 80 × 25% = 20
Корректировки: +20₽ (эффективно 8-1=7 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +45₽ (75% от (320-240-20) = 75% от 60)
ИТОГО: -15₽
```

---

### ⚠️ Тест 2.8: Два Percent купона для одной формы (НЕВОЗМОЖНО)
**Начальная корзина:**
- 4 подарка × 40₽ = 160₽

**Доступные купоны:**
- "Скидка 25% #1" (percent, value=25, form=gifts)
- "Скидка 10% #2" (percent, value=10, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать первый купон 25%
3. Попытаться выбрать второй купон 10%

**Ожидаемый результат в модалке:**
- Первый купон (25%) выбран, предупреждений нет
- ❌ Второй купон (10%) показывает ошибку: "Для формы 'Подарок из коллекции' уже выбран процентный купон."
- Кнопка "Сохранить" disabled
- Пользователь должен снять один из percent купонов

**Правило:** Для одной формы можно выбрать только ОДИН процентный купон.

**Примечание:** Если купоны для РАЗНЫХ форм (например, 25% на подарки + 10% на иконки), то ошибки не будет.

---

## ✅ Группа 3: Купоны для РАЗНЫХ форм

### ✅ Тест 3.1: Item купоны для разных форм
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽
- 2 индивидуальных иконки × 111₽ = 222₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка на 1 индивидуальную иконку" (item, value=1, form=icons)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 151₽ (40 + 111)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Иконки: -222₽
Купоны: +151₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка на 1 индивидуальную иконку: 111 × 1 = 111
Корректировки: 0₽ (эффективно 3-1=2 подарка < 5)
Автоскидки: +144₽ (75% от (342-151-0) = 75% от 191, округление вверх)
ИТОГО: -47₽
```

---

### ✅ Тест 3.2: Fixed купоны для разных форм
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽
- 3 индивид иконки × 111₽ = 333₽

**Доступные купоны:**
- "Скидка -180₽ на подарки" (fixed, value=180, form=gifts)
- "Скидка -100₽ на индивид иконки" (fixed, value=100, form=icons)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 280₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Иконки: -333₽
Купоны: +280₽
  - Скидка -180₽ на подарки: 180
  - Скидка -100₽ на индивид иконки: 100
Корректировки: +20₽ (за подарки: 5 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +175₽ (75% от (533-280-20) = 75% от 233, округление вверх)
ИТОГО: -58₽
```

---

## ⚠️ Группа 4: Динамические изменения корзины

### ✅ Тест 4.1: Добавление товаров после выбора купона
**Начальный сценарий:**
- Корзина: 1 подарок × 40₽ = 40₽
- Выбран купон: "Скидка -100₽" (частично применяется на 40)

**Действия:**
1. Добавить еще 2 подарка (итого 3 × 40₽ = 120₽)
2. Открыть модалку купонов

**Ожидаемый результат в модалке:**
- Купон остаётся выбранным
- Скидка: 100₽
- Предупреждение исчезло (теперь купон применяется полностью)

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +100₽
  - Скидка -100₽: 100 (теперь полностью)
Корректировки: 0₽ (3 подарка < 5)
Автоскидки: +15₽ (75% от (120-100-0) = 75% от 20)
ИТОГО: -5₽
```

---

### ✅ Тест 4.2: Удаление товаров после выбора item купона
**Начальный сценарий:**
- Корзина: 3 подарка × 40₽ = 120₽
- Выбран купон: "Скидка на 2 подарка" (item, value=2)

**Действия:**
1. Удалить 2 подарка (остался 1 подарок)
2. Открыть модалку купонов

**Ожидаемый результат в модалке:**
- Купон автоматически снят (cleanupInvalidCoupons)
- Уведомление (всплывающее): "Купон 'Скидка на 2 подарка' автоматически снят, т.к. условия для его применения больше не выполняются"
- Скидка: 0₽

**Ожидаемый результат в итогах:**
```
Подарки: -40₽
Купоны: 0₽ (купон снят)
Корректировки: 0₽ (1 подарок < 5)
Автоскидки: +30₽ (75% от (40-0-0) = 75% от 40)
ИТОГО: -10₽
```

---

### ⚠️ Тест 4.3: Удаление товаров -> второй fixed купон становится невалидным
**Начальный сценарий:**
- Корзина: 8 подарков × 40₽ = 320₽
- Выбраны купоны:
  - "Скидка на 2 подарка" (item, value=2) = 80₽
  - "Скидка -100₽ #1" (fixed) = 100₽
  - "Скидка -80₽ #2" (fixed) = 80₽

**Ожидаемый результат в модалке (начальное состояние):**
- Скидка: 260₽ (80 + 100 + 80)
- Все купоны применяются полностью

**Ожидаемый результат в итогах (начальное состояние):**
```
Подарки: -320₽
Купоны: +260₽
  - Скидка на 2 подарка: 80
  - Скидка -100₽ #1: 100
  - Скидка -80₽ #2: 80
Корректировки: +20₽ (эффективно 8-2=6 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +30₽ (75% от (320-260-20) = 75% от 40)
ИТОГО: -10₽
```

**Действия:**
1. Удалить 2 подарка (остаётся 6 × 40₽ = 240₽)
2. Открыть модалку купонов

**Ожидаемый результат в модалке после удаления:**
- Item купон остаётся
- Первый fixed купон -100₽ остаётся
- Второй fixed купон -80₽ остаётся, но применяется частично
- ⚠️ Предупреждение под вторым купоном: "Купон применён частично: будет использовано 60 из 80"
- Скидка: 240₽ (80 + 100 + 60)

**Расчёт:**
1. После item купона: 240 - 80 = 160₽
2. Корректировки: 0₽ (эффективно 6-2=4 подарка < 5)
3. Остаток для fixed купонов: 160₽
4. Первый fixed -100₽: 160 - 100 = 60₽ остаток
5. Второй fixed -80₽: применяется только 60 из 80 (частично)

**Ожидаемый результат в итогах после удаления:**
```
Подарки: -240₽
Купоны: +240₽
  - Скидка на 2 подарка: 80
  - Скидка -100₽ #1: 100
  - Скидка -80₽ #2: 60 (частично)
Корректировки: 0₽ (эффективно 6-2=4 подарка < 5)
Автоскидки: 0₽ (остаток = 240-240-0 = 0)
ИТОГО: 0₽
```

---

## ✅ Группа 5: Корректировки цен

### ✅ Тест 5.1: Корректировка с item купоном
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Правила корректировок:**
- "За 5 подарков": 40×1×5 - 180×1 = 20₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон
3. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽ (7 подарков)
Купоны: +80₽
  - Скидка на 2 подарка: 40 × 2 = 80
Корректировки: +20₽ (эффективно 7-2=5 подарков -> правило срабатывает)
Автоскидки: +135₽ (75% от (280-80-20) = 75% от 180)
ИТОГО: -45₽
```

---

### ✅ Тест 5.2: Корректировка перестаёт применяться
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 3 подарка" (item, value=3)

**Действия:**
1. Выбрать купон на 3 подарка
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽ (7 подарков)
Купоны: +120₽
  - Скидка на 3 подарка: 40 × 3 = 120
Корректировки: 0₽ (эффективно 7-3=4 подарка -> правило НЕ срабатывает)
Автоскидки: +120₽ (75% от (280-120) = 75% от 160)
ИТОГО: -40₽
```

---

## ✅ Группа 6: Автоматические скидки

### ✅ Тест 6.1: Автоскидка с одним купоном
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Правила автоскидок:**
- "75% на все расходы"

**Доступные купоны:**
- "Скидка -100₽" (fixed)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -200₽
Купоны: +100₽
  - Скидка -100₽: 100
Корректировки: +20₽ (5 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +60₽ (75% от (200-100-20) = 75% от 80)
ИТОГО: -20₽
```

**Примечание:** Корректировки применяются т.к. в корзине 5 подарков (купоны не влияют на условие корректировок).

---

### ✅ Тест 6.2: Несколько автоскидок
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽
- 2 индивидуальные иконки × 111₽ = 222₽

**Правила автоскидок:**
- "75% на подарки"
- "50% на инд. иконки"

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -120₽
Инд. иконки: -222₽
Купоны: +40₽
  - Скидка на 1 подарок: 40
Корректировки: 0₽ (эффективно 3-1=2 подарка < 5)
Автоскидки: +255₽
  - 50% на инд. иконки: 222 × 50% = 111
  - 75% на все расходы: (120+222-111-40) × 75% = 191 × 75% = 144
ИТОГО: -47₽
```

**Расчёт автоскидок (последовательно):**
1. Скидка на иконки (конкретная форма): 222 × 50% = 111
2. Скидка на "все расходы": (120+222-111-40) × 75% = 191 × 75% = 143.25 → 144
3. Итого автоскидок: 111 + 144 = 255

---

## ⚠️  Группа 7: Граничные случаи

###  ✅ Тест 7.1: Купоны + корректировки + автоскидки = расходы (ноль в итоге)
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2) = 80₽
- "Скидка -180₽" (fixed) = 180₽

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽
Купоны: +260₽
  - Скидка на 2 подарка: 80
  - Скидка -180₽: 180
Корректировки: +20₽ (эффективно 7-2=5 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: 0₽ (остаток = 280-260-20 = 0)
ИТОГО: 0₽
```

---

### ✅ Тест 7.2: Купоны превышают расходы (невозможная ситуация?)
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2) = 80₽
- "Скидка -100₽" (fixed) = 100₽

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -120₽
Купоны: +120₽
  - Скидка на 2 подарка: 80
  - Скидка -100₽: 40 (частично, т.к. остаток только 40 после item купона)
Корректировки: 0₽ (эффективно 3-2=1 подарок < 5)
Автоскидки: 0₽ (остаток = 120-120-0 = 0)
ИТОГО: 0₽
```

**Примечание:** Fixed купоны ограничены доступным остатком, поэтому сумма купонов не может превысить расходы.

---

### ✅ Тест 7.3: Percent > 100%
**Начальная корзина:**
- 2 подарка × 40₽ = 80₽

**Доступные купоны:**
- "Скидка 150%" (percent, value=150, form=gifts)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -80₽
Купоны: +80₽ (ограничено до 100%)
  - Скидка 150%: (80-0) × 100% = 80
Корректировки: 0₽ (2 подарка < 5)
Автоскидки: 0₽ (остаток = 80-80-0 = 0)
ИТОГО: 0₽
```

---

### ⚠️ Тест 7.4: Применение процентного купона с очень малым остатком
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка -195₽" (fixed, value=195)
- "Скидка 50%" (percent, value=50)

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -200₽
Купоны: +198₽
  - Скидка -195₽: 195
  - Скидка 50%: (200-0-195) × 50% = 5 × 50% = 3 (округление вверх)
Корректировки: 0₽ (5 подарков, но после -195₽ недостаточно для корректировки)
Автоскидки: +2₽ (75% от (200-198-0) = 75% от 2, округление вверх)
ИТОГО: 0₽
```

**Неверно**
Правильное поведение:
1. При выборе -195 пишется "Купон применен частично: будет использовано 180 из 195"
2. Купон "скидка на 50%" уже выбрать просто не дает, т.к. это применение к 0

Правильный результат:
Подарок: -200
Купоны: -195 -> 180 (применен частично)
Корректировка: 20 (т.к. 5 подарков)
Итого: 0

**Этот результат и наблюдается при ручной проверке**

---

## ⚠️ Группа 8: Комплексные сценарии

### ⚠️ Тест 8.1: Максимальная комбинация для одной формы
**Начальная корзина:**
- 10 подарков × 40₽ = 400₽

**Доступные купоны:**
- "Скидка на 1 подарок #1" (item, value=1)
- "Скидка на 2 подарка #2" (item, value=2)
- "Скидка -100₽ #1" (fixed, value=100)
- "Скидка -50₽ #2" (fixed, value=50)
- "Скидка 25%" (percent, value=25)
- "Скидка 10%" (percent, value=10)

**Действия:**
1. Выбрать ВСЕ купоны
2. Сохранить

**Ожидаемый результат в модалке:**
- ❌ Невозможно выбрать два percent купона для одной формы
- После выбора первого percent купона (25%), второй (10%) покажет ошибку
- Предположим, выбраны: item #1, item #2, fixed #1, fixed #2, percent 25%

**Ожидаемый результат в итогах (без второго percent):**
```
Подарки: -400₽
Купоны: +298₽
  - Скидка на 1 подарок: 40
  - Скидка на 2 подарка: 80
  - Скидка -100₽: 100
  - Скидка -50₽: 50
  - Скидка 25%: (400-120-20-150) × 25% = 110 × 25% = 28
Корректировки: +20₽ (эффективно 10-3=7 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +61₽ (75% от (400-298-20) = 75% от 82, округление вверх)
ИТОГО: -21₽
```

**Важное замечание**
Автоскидка = 82 * 0.75 = 61.5 -> 62
Поэтому ИТОГО: 20

**Этот результат и наблюдается при ручной проверке**

---

### ⚠️ Тест 8.2: Две формы с полным набором купонов
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽
- 4 инд. иконки × 111₽ = 444₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2, form=gifts)
- "Скидка -180₽ на подарки" (fixed, value=180, form=gifts)
- "Скидка 25% на подарки" (percent, value=25, form=gifts)
- "Скидка на 1 инд. иконку" (item, value=1, form=icons)
- "Скидка -100₽ на инд. иконки" (fixed, value=100, form=icons)
- "Скидка 10% на инд. иконки" (percent, value=10, form=icons)

**Действия:**
1. Выбрать ВСЕ купоны
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽
Инд. иконки: -444₽
Купоны: +495₽
  Подарки:
    - Скидка на 2 подарка: 80
    - Скидка -180₽: 180
    - Скидка 25%: (280-80-20-180) × 25% = 0 × 25% = 0 (недостаточно средств)
  Иконки:
    - Скидка на 1 инд. иконку: 111
    - Скидка -100₽: 100
    - Скидка 10%: (444-111-0-100) × 10% = 233 × 10% = 24 (округление вверх)
Корректировки: +20₽ (эффективно 7-2=5 подарков ≥ 5: 40×1×5 - 180×1 = 20)
Автоскидки: +175₽ (75% от (724-495-20) = 75% от 209, округление вверх)
ИТОГО: -34₽
```

**Неверно!!**
Правильное поведение:
- При попытке добавить "Скидка 25% на подарки" система говорит, что "В корзине недостаточно средств после применения других купонов" и не дает сохранить, потому что 280-80-20(корректировки)-180=0

**Этот результат и наблюдается при ручной проверке**


---

## Сводная таблица ожидаемых результатов

| Тест | Корзина | Купоны | Корректировки | Автоскидки | Итого | Предупреждения |
|------|---------|---------|---------------|------------|-------|----------------|
| 1.1 | 5 подарков (200₽) | +40₽ | 0₽ | +120₽ | -40₽ | Нет |
| 1.2 | 2 подарка (80₽) | 0₽ | 0₽ | +60₽ | -20₽ | Ошибка: недостаточно товаров |
| 1.3 | 3 подарка (120₽) | +100₽ | 0₽ | +15₽ | -5₽ | Нет |
| 1.4 | 1 подарок (40₽) | +40₽ | 0₽ | 0₽ | 0₽ | ⚠️ Частичное применение |
| 1.5 | 3 подарка (120₽) | +30₽ | 0₽ | +68₽ | -22₽ | Нет |
| 2.1 | 5 подарков (200₽) | +120₽ | 0₽ | +60₽ | -20₽ | Нет |
| 2.2 | 7 подарков (280₽) | +260₽ | +20₽ | 0₽ | 0₽ | Нет |
| 2.3 | 5 подарков (200₽) | +200₽ | 0₽ | 0₽ | 0₽ | ⚠️ Fixed частично |
| 2.4 | 6 подарков (240₽) | +150₽ | +20₽ | +53₽ | -17₽ | Нет |
| 2.5 | 4 подарка (160₽) | +160₽ | 0₽ | 0₽ | 0₽ | ⚠️ Второй fixed частично |

---

## Потенциальные проблемы для проверки

### ~~Проблема 1: Порядок percent купонов~~ ✅ РЕШЕНО
**Вопрос:** Должны ли percent купоны применяться:
- A) Параллельно (оба от базовой суммы после fixed)
- B) Последовательно (второй от остатка после первого)

**Решение:** Для одной формы может быть выбран **только ОДИН** percent купон. Вопрос неактуален.

**Реализация:** Добавлена валидация - при попытке выбрать второй percent купон для той же формы показывается ошибка.

---

### Проблема 2: Купоны превышают расходы
**Вопрос:** Возможна ли ситуация когда купоны + корректировки + автоскидки > расходы?

**Пример:**
- Расходы: 120₽
- Item купон: 80₽
- Fixed купон: 60₽ (частично применится на 40₽)
- Итого: 120₽ скидок на 120₽ расходов = 0₽

**Ответ:** Нет, благодаря `Math.min()` в fixed купонах и правильному расчету percent купонов это невозможно.

---

### Проблема 3: Percent купон > 100%
**Вопрос:** Как обрабатывается купон со значением > 100%?

**Текущая реализация:** Ограничивается до 100%

**Статус:** ✅ Правильно

---

### Проблема 4: Округление в percent купонах
**Вопрос:** Как округляются дробные значения?

**Текущая реализация:** `Math.ceil()` - округление вверх

**Пример:** 5 × 50% = 2.5 → 3

**Статус:** ✅ Правильно (в пользу пользователя)

---

## Рекомендации по тестированию

1. **Начните с простых тестов** (Группа 1)
2. **Проверьте комбинации** (Группа 2)
3. **Протестируйте динамику** (Группа 4)
4. **Проверьте граничные случаи** (Группа 7)
5. **Завершите комплексными сценариями** (Группа 8)

Для каждого теста:
- ✅ Зелёная галочка - тест пройден
- ❌ Красный крестик - тест не пройден
- ⚠️ Жёлтый треугольник - неожиданное поведение

---

## Чек-лист для ручного тестирования

- [ ] Купоны правильно отображаются в модалке
- [ ] Предупреждения появляются когда нужно
- [ ] Предупреждения исчезают когда условия выполнены
- [ ] Купоны снимаются автоматически при недостаточности ресурсов
- [ ] Кнопка "Сохранить" disabled при ошибках
- [ ] Скидка в модалке совпадает со скидкой в итогах
- [ ] Корректировки учитывают item купоны
- [ ] Автоскидки применяются к правильному остатку
- [ ] Итого никогда не положительное (если только нет доходов)
- [ ] Логи в консоли корректные и информативные
