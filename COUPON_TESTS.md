# Тесты системы персональных купонов

## Порядок применения
1. **Operations** (базовые операции)
2. **Item coupons** (бесплатные товары)
3. **Price adjustments** (корректировки цен)
4. **Fixed coupons** (фиксированные скидки)
5. **Percent coupons** (процентные скидки)
6. **Auto discounts** (автоматические скидки)

---

## Группа 1: Базовые тесты с одним купоном

### Тест 1.1: Один item купон (достаточно товаров)
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка на 1 подарок"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 40₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽ (5 × 40₽)
Купоны: +40₽
  - Скидка на 1 подарок: 40 × 1 = 40
Корректировки: +20₽ (за 5 подарков: 40×1×5 - 180×1 = 20)
Автоскидки: +102₽ (75% от (200-40-20) = 75% от 140 = 105, но округляем)
ИТОГО: -38₽
```

---

### Тест 1.2: Один item купон (недостаточно товаров)
**Начальная корзина:**
- 2 подарка × 40₽ = 80₽

**Доступные купоны:**
- "Скидка на 3 подарка" (item, value=3, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Попытаться выбрать купон "Скидка на 3 подарка"

**Ожидаемый результат в модалке:**
- Купон не выбирается (серый/недоступен)
- Ошибка: "Недостаточно позиций. Нужно: 3, в корзине: 2."
- Кнопка "Сохранить" disabled

**Ожидаемый результат в итогах:**
```
Подарки: -80₽
Корректировки: 0₽ (недостаточно для правила)
Автоскидки: +60₽ (75% от 80)
ИТОГО: -20₽
```

---

### Тест 1.3: Один fixed купон (достаточно средств)
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка -100₽ на подарки" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка -100₽"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 100₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +100₽
  - Скидка -100₽: 100
Корректировки: 0₽
Автоскидки: +15₽ (75% от (120-100) = 75% от 20)
ИТОГО: -5₽
```

---

### Тест 1.4: Один fixed купон (недостаточно средств)
**Начальная корзина:**
- 1 подарок × 40₽ = 40₽

**Доступные купоны:**
- "Скидка -100₽ на подарки" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка -100₽"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 40₽
- ⚠️ Предупреждение: "Купон применён частично: будет использовано 40 из 100."

**Ожидаемый результат в итогах:**
```
Подарки: -40₽
Купоны: +40₽
  - Скидка -100₽: 40
Корректировки: 0₽
Автоскидки: 0₽
ИТОГО: 0₽
```

---

### Тест 1.5: Один percent купон
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка 25% на подарки" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон "Скидка 25%"
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 30₽ (25% от 120)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +30₽
  - Скидка 25%: 120 × 25% = 30
Корректировки: 0₽
Автоскидки: +68₽ (75% от (120-30) = 75% от 90)
ИТОГО: -22₽
```

---

## Группа 2: Несколько купонов для ОДНОЙ формы

### Тест 2.1: Два item купона для одной формы
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок #1" (item, value=1, form=gifts)
- "Скидка на 2 подарка #2" (item, value=2, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 120₽ (40 + 80)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽ (5 подарков)
Купоны: +120₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка на 2 подарка: 40 × 2 = 80
Корректировки: 0₽ (эффективно 5-3=2 подарка, недостаточно для правила "5 подарков")
Автоскидки: +60₽ (75% от (200-120) = 75% от 80)
ИТОГО: -20₽
```

---

### Тест 2.2: Item + Fixed для одной формы
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 260₽ (80 + 180)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -280₽ (7 подарков)
Купоны: +260₽
  - Скидка на 2 подарка: 40 × 2 = 80
  - Скидка -180₽: 180
Корректировки: +20₽ (эффективно 7-2=5 подарков: 40×1×5 - 180×1 = 20)
Автоскидки: 0₽ (остаток = 280-80-20-180 = 0)
ИТОГО: 0₽
```

---

### Тест 2.3: Item + Fixed (частичное применение)
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 180₽ (40 + 140)
- ⚠️ Предупреждение под fixed купоном: "Купон применён частично: будет использовано 140 из 180."

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Купоны: +180₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка -180₽: 140 (частично)
Корректировки: +20₽ (эффективно 5-1=4 подарка, недостаточно для правила)
Автоскидки: 0₽ (остаток = 200-40-20-140 = 0)
ИТОГО: 0₽
```

---

### Тест 2.4: Два Fixed купона (оба применяются полностью)
**Начальная корзина:**
- 6 подарков × 40₽ = 240₽

**Доступные купоны:**
- "Скидка -100₽ #1" (fixed, value=100, form=gifts)
- "Скидка -50₽ #2" (fixed, value=50, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 150₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -240₽
Купоны: +150₽
  - Скидка -100₽: 100
  - Скидка -50₽: 50
Корректировки: 0₽
Автоскидки: +68₽ (75% от (240-150) = 75% от 90)
ИТОГО: -22₽
```

---

### Тест 2.5: Два Fixed купона (второй применяется частично)
**Начальная корзина:**
- 4 подарка × 40₽ = 160₽

**Доступные купоны:**
- "Скидка -100₽ #1" (fixed, value=100, form=gifts)
- "Скидка -100₽ #2" (fixed, value=100, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать первый купон -100₽ #1
3. Выбрать второй купон -100₽ #2

**Ожидаемый результат в модалке:**
- Скидка: 160₽
- Первый купон: предупреждений нет
- ⚠️ Второй купон: "Купон применён частично: будет использовано 60 из 100."

**Ожидаемый результат в итогах:**
```
Подарки: -160₽
Купоны: +160₽
  - Скидка -100₽ #1: 100
  - Скидка -100₽ #2: 60 (частично)
Корректировки: 0₽
Автоскидки: 0₽
ИТОГО: 0₽
```

---

### Тест 2.6: Fixed + Percent для одной формы
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка -100₽" (fixed, value=100, form=gifts)
- "Скидка 25%" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 125₽ (100 + 25)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Купоны: +125₽
  - Скидка -100₽: 100
  - Скидка 25%: (200-100) × 25% = 25
Корректировки: 0₽
Автоскидки: +56₽ (75% от (200-125) = 75% от 75)
ИТОГО: -19₽
```

---

### Тест 2.7: Item + Fixed + Percent (полный набор)
**Начальная корзина:**
- 8 подарков × 40₽ = 320₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка -180₽" (fixed, value=180, form=gifts)
- "Скидка 25%" (percent, value=25, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать все три купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 250₽ (40 + 180 + 30)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -320₽ (8 подарков)
Купоны: +250₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка -180₽: 180
  - Скидка 25%: (320-40-20-180) × 25% = 80 × 25% = 20
Корректировки: +20₽ (эффективно 8-1=7 подарков: 40×1×5 - 180×1 = 20)
Автоскидки: +38₽ (75% от (320-40-20-180-20) = 75% от 60)
ИТОГО: -12₽
```

---

### Тест 2.8: Два Percent купона
**Начальная корзина:**
- 4 подарка × 40₽ = 160₽

**Доступные купоны:**
- "Скидка 25% #1" (percent, value=25, form=gifts)
- "Скидка 10% #2" (percent, value=10, form=gifts)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 56₽ (40 + 16)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -160₽
Купоны: +56₽
  - Скидка 25%: 160 × 25% = 40
  - Скидка 10%: (160-40) × 10% = 120 × 10% = 12
Корректировки: 0₽
Автоскидки: +78₽ (75% от (160-56) = 75% от 104)
ИТОГО: -26₽
```

**ВОПРОС:** Percent купоны должны применяться параллельно (оба от базовой суммы) или последовательно (второй от остатка после первого)?

---

## Группа 3: Купоны для РАЗНЫХ форм

### Тест 3.1: Item купоны для разных форм
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽
- 2 иконки × 111₽ = 222₽

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1, form=gifts)
- "Скидка на 1 иконку" (item, value=1, form=icons)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 151₽ (40 + 111)
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Иконки: -222₽
Купоны: +151₽
  - Скидка на 1 подарок: 40 × 1 = 40
  - Скидка на 1 иконку: 111 × 1 = 111
Корректировки: 0₽
Автоскидки: +143₽ (75% от (342-151) = 75% от 191)
ИТОГО: -48₽
```

---

### Тест 3.2: Fixed купоны для разных форм
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽
- 3 иконки × 111₽ = 333₽

**Доступные купоны:**
- "Скидка -180₽ на подарки" (fixed, value=180, form=gifts)
- "Скидка -100₽ на иконки" (fixed, value=100, form=icons)

**Действия:**
1. Открыть модалку купонов
2. Выбрать оба купона
3. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 280₽
- Предупреждений нет

**Ожидаемый результат в итогах:**
```
Подарки: -200₽
Иконки: -333₽
Купоны: +280₽
  - Скидка -180₽ на подарки: 180
  - Скидка -100₽ на иконки: 100
Корректировки: +20₽ (за подарки: 40×1×5 - 180×1 = 20)
Автоскидки: +186₽ (75% от (533-280-20) = 75% от 233)
ИТОГО: -67₽
```

---

## Группа 4: Динамические изменения корзины

### Тест 4.1: Добавление товаров после выбора купона
**Начальный сценарий:**
- Корзина: 1 подарок × 40₽ = 40₽
- Выбран купон: "Скидка -100₽" (частично применяется на 40)

**Действия:**
1. Добавить еще 2 подарка (итого 3 × 40₽ = 120₽)
2. Открыть модалку купонов

**Ожидаемый результат в модалке:**
- Купон остаётся выбранным
- Скидка: 100₽
- Предупреждение исчезло (теперь купон применяется полностью)

**Ожидаемый результат в итогах:**
```
Подарки: -120₽
Купоны: +100₽
  - Скидка -100₽: 100 (теперь полностью)
Корректировки: 0₽
Автоскидки: +15₽ (75% от 20)
ИТОГО: -5₽
```

---

### Тест 4.2: Удаление товаров после выбора item купона
**Начальный сценарий:**
- Корзина: 3 подарка × 40₽ = 120₽
- Выбран купон: "Скидка на 2 подарка" (item, value=2)

**Действия:**
1. Удалить 2 подарка (остался 1 подарок)
2. Открыть модалку купонов

**Ожидаемый результат в модалке:**
- Купон автоматически снят (cleanupInvalidCoupons)
- Сообщение в консоли: "🎫❌ Купон [id] автоматически снят"
- Скидка: 0₽

**Ожидаемый результат в итогах:**
```
Подарки: -40₽
Купоны: 0₽ (купон снят)
Корректировки: 0₽
Автоскидки: +30₽ (75% от 40)
ИТОГО: -10₽
```

---

### Тест 4.3: Удаление товаров -> второй fixed купон становится невалидным
**Начальный сценарий:**
- Корзина: 7 подарков × 40₽ = 280₽
- Выбраны купоны:
  - "Скидка на 2 подарка" (item, value=2) = 80₽
  - "Скидка -180₽" (fixed) = 180₽
  - "Скидка -10₽" (fixed) = 10₽

**Действия:**
1. Удалить 1 подарок (остаётся 6 × 40₽ = 240₽)
2. Открыть модалку купонов

**Ожидаемый результат в модалке:**
- Item купон остаётся
- Первый fixed купон -180₽ остаётся
- Второй fixed купон -10₽ автоматически снят (недостаточно средств)
- Скидка: 260₽ -> 240₽

**Ожидаемый результат в итогах:**
```
Подарки: -240₽
Купоны: +240₽
  - Скидка на 2 подарка: 80
  - Скидка -180₽: 160 (частично)
Корректировки: 0₽ (эффективно 6-2=4 подарка, недостаточно)
Автоскидки: 0₽
ИТОГО: 0₽
```

---

## Группа 5: Корректировки цен

### Тест 5.1: Корректировка с item купоном
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Правила корректировок:**
- "За 5 подарков": 40×1×5 - 180×1 = 20₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2)

**Действия:**
1. Открыть модалку купонов
2. Выбрать купон
3. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽ (7 подарков)
Купоны: +80₽
  - Скидка на 2 подарка: 40 × 2 = 80
Корректировки: +20₽ (эффективно 7-2=5 подарков -> правило срабатывает)
Автоскидки: +135₽ (75% от (280-80-20) = 75% от 180)
ИТОГО: -45₽
```

---

### Тест 5.2: Корректировка перестаёт применяться
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 3 подарка" (item, value=3)

**Действия:**
1. Выбрать купон на 3 подарка
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽ (7 подарков)
Купоны: +120₽
  - Скидка на 3 подарка: 40 × 3 = 120
Корректировки: 0₽ (эффективно 7-3=4 подарка -> правило НЕ срабатывает)
Автоскидки: +120₽ (75% от (280-120) = 75% от 160)
ИТОГО: -40₽
```

---

## Группа 6: Автоматические скидки

### Тест 6.1: Автоскидка с одним купоном
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Правила автоскидок:**
- "75% на все расходы"

**Доступные купоны:**
- "Скидка -100₽" (fixed)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -200₽
Купоны: +100₽
Корректировки: 0₽
Автоскидки: +75₽ (75% от (200-100) = 75% от 100)
ИТОГО: -25₽
```

---

### Тест 6.2: Несколько автоскидок
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽
- 2 иконки × 111₽ = 222₽

**Правила автоскидок:**
- "75% на подарки"
- "50% на иконки"

**Доступные купоны:**
- "Скидка на 1 подарок" (item, value=1)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -120₽
Иконки: -222₽
Купоны: +40₽
  - Скидка на 1 подарок: 40
Корректировки: 0₽
Автоскидки: +171₽
  - 75% на подарки: (120-40) × 75% = 60
  - 50% на иконки: 222 × 50% = 111
ИТОГО: -131₽
```

---

## Группа 7: Граничные случаи

### Тест 7.1: Купоны + корректировки + автоскидки = расходы (ноль в итоге)
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2) = 80₽
- "Скидка -180₽" (fixed) = 180₽

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽
Купоны: +260₽
  - Скидка на 2 подарка: 80
  - Скидка -180₽: 180
Корректировки: +20₽ (за 5 эффективных подарков)
Автоскидки: 0₽ (остаток = 0)
ИТОГО: 0₽
```

---

### Тест 7.2: Купоны превышают расходы (невозможная ситуация?)
**Начальная корзина:**
- 3 подарка × 40₽ = 120₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2) = 80₽
- "Скидка -100₽" (fixed) = 100₽

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -120₽
Купоны: +140₽?
  - Скидка на 2 подарка: 80
  - Скидка -100₽: 60 (частично, т.к. остаток только 40 после item купона)

ИТОГО: +20₽
```

**ВОПРОС:** Это правильное поведение? Должны ли мы ограничивать общую сумму купонов?

---

### Тест 7.3: Percent > 100%
**Начальная корзина:**
- 2 подарка × 40₽ = 80₽

**Доступные купоны:**
- "Скидка 150%" (percent, value=150, form=gifts)

**Действия:**
1. Выбрать купон
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -80₽
Купоны: +80₽ (ограничено до 100%)
  - Скидка 150%: 80 × 100% = 80
Корректировки: 0₽
Автоскидки: 0₽
ИТОГО: 0₽
```

---

### Тест 7.4: Применение процентного купона с очень малым остатком
**Начальная корзина:**
- 5 подарков × 40₽ = 200₽

**Доступные купоны:**
- "Скидка -195₽" (fixed, value=195)
- "Скидка 50%" (percent, value=50)

**Действия:**
1. Выбрать оба купона
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -200₽
Купоны: +198₽
  - Скидка -195₽: 195
  - Скидка 50%: (200-195) × 50% = 5 × 50% = 3 (округление вверх)
Корректировки: 0₽
Автоскидки: +2₽ (75% от 2 = 1.5 -> 2)
ИТОГО: 0₽
```

---

## Группа 8: Комплексные сценарии

### Тест 8.1: Максимальная комбинация для одной формы
**Начальная корзина:**
- 10 подарков × 40₽ = 400₽

**Доступные купоны:**
- "Скидка на 1 подарок #1" (item, value=1)
- "Скидка на 2 подарка #2" (item, value=2)
- "Скидка -100₽ #1" (fixed, value=100)
- "Скидка -50₽ #2" (fixed, value=50)
- "Скидка 25%" (percent, value=25)
- "Скидка 10%" (percent, value=10)

**Действия:**
1. Выбрать ВСЕ купоны
2. Сохранить

**Ожидаемый результат в модалке:**
- Скидка: 40 + 80 + 100 + 50 + 25 + 10 = 305₽ (примерно)

**Ожидаемый результат в итогах:**
```
Подарки: -400₽
Купоны: +305₽ (примерно)
  - Скидка на 1 подарок: 40
  - Скидка на 2 подарка: 80
  - Скидка -100₽: 100
  - Скидка -50₽: 50
  - Скидка 25%: (400-120-20-100-50) × 25% = 110 × 25% = 28
  - Скидка 10%: (110-28) × 10% = 82 × 10% = 9
Корректировки: +20₽ (эффективно 10-3=7 подарков: правило "5 подарков" срабатывает)
Автоскидки: +56₽ (75% от (400-120-20-150-37) = 75% от 73)
ИТОГО: -19₽
```

---

### Тест 8.2: Две формы с полным набором купонов
**Начальная корзина:**
- 7 подарков × 40₽ = 280₽
- 4 иконки × 111₽ = 444₽

**Доступные купоны:**
- "Скидка на 2 подарка" (item, value=2, form=gifts)
- "Скидка -180₽ на подарки" (fixed, value=180, form=gifts)
- "Скидка 25% на подарки" (percent, value=25, form=gifts)
- "Скидка на 1 иконку" (item, value=1, form=icons)
- "Скидка -100₽ на иконки" (fixed, value=100, form=icons)
- "Скидка 10% на иконки" (percent, value=10, form=icons)

**Действия:**
1. Выбрать ВСЕ купоны
2. Сохранить

**Ожидаемый результат:**
```
Подарки: -280₽
Иконки: -444₽
Купоны: +496₽
  Подарки:
    - Скидка на 2 подарка: 80
    - Скидка -180₽: 180
    - Скидка 25%: (280-80-20-180) × 25% = 0 (недостаточно средств)
  Иконки:
    - Скидка на 1 иконку: 111
    - Скидка -100₽: 100
    - Скидка 10%: (444-111-100) × 10% = 233 × 10% = 24
Корректировки: +20₽ (за подарки)
Автоскидки: +186₽ (75% от остатка)
ИТОГО: -42₽
```

---

## Сводная таблица ожидаемых результатов

| Тест | Корзина | Купоны | Корректировки | Автоскидки | Итого | Предупреждения |
|------|---------|---------|---------------|------------|-------|----------------|
| 1.1 | 5 подарков (200₽) | +40₽ | +20₽ | +102₽ | -38₽ | Нет |
| 1.2 | 2 подарка (80₽) | 0₽ | 0₽ | +60₽ | -20₽ | Ошибка: недостаточно товаров |
| 1.3 | 3 подарка (120₽) | +100₽ | 0₽ | +15₽ | -5₽ | Нет |
| 1.4 | 1 подарок (40₽) | +40₽ | 0₽ | 0₽ | 0₽ | ⚠️ Частичное применение |
| 1.5 | 3 подарка (120₽) | +30₽ | 0₽ | +68₽ | -22₽ | Нет |
| 2.1 | 5 подарков (200₽) | +120₽ | 0₽ | +60₽ | -20₽ | Нет |
| 2.2 | 7 подарков (280₽) | +260₽ | +20₽ | 0₽ | 0₽ | Нет |
| 2.3 | 5 подарков (200₽) | +180₽ | +20₽ | 0₽ | 0₽ | ⚠️ Fixed частично |
| 2.4 | 6 подарков (240₽) | +150₽ | 0₽ | +68₽ | -22₽ | Нет |
| 2.5 | 4 подарка (160₽) | +160₽ | 0₽ | 0₽ | 0₽ | ⚠️ Второй fixed частично |

---

## Потенциальные проблемы для проверки

### Проблема 1: Порядок percent купонов
**Вопрос:** Должны ли percent купоны применяться:
- A) Параллельно (оба от базовой суммы после fixed)
- B) Последовательно (второй от остатка после первого)

**Текущая реализация:** Последовательно

**Предложение:** Оставить последовательно, но документировать

---

### Проблема 2: Купоны превышают расходы
**Вопрос:** Возможна ли ситуация когда купоны + корректировки + автоскидки > расходы?

**Пример:**
- Расходы: 120₽
- Item купон: 80₽
- Fixed купон: 60₽ (частично применится на 40₽)
- Итого: 120₽ скидок на 120₽ расходов = 0₽

**Ответ:** Нет, благодаря `Math.min()` в fixed купонах и правильному расчету percent купонов это невозможно.

---

### Проблема 3: Percent купон > 100%
**Вопрос:** Как обрабатывается купон со значением > 100%?

**Текущая реализация:** Ограничивается до 100%

**Статус:** ✅ Правильно

---

### Проблема 4: Округление в percent купонах
**Вопрос:** Как округляются дробные значения?

**Текущая реализация:** `Math.ceil()` - округление вверх

**Пример:** 5 × 50% = 2.5 → 3

**Статус:** ✅ Правильно (в пользу пользователя)

---

## Рекомендации по тестированию

1. **Начните с простых тестов** (Группа 1)
2. **Проверьте комбинации** (Группа 2)
3. **Протестируйте динамику** (Группа 4)
4. **Проверьте граничные случаи** (Группа 7)
5. **Завершите комплексными сценариями** (Группа 8)

Для каждого теста:
- ✅ Зелёная галочка - тест пройден
- ❌ Красный крестик - тест не пройден
- ⚠️ Жёлтый треугольник - неожиданное поведение

---

## Чек-лист для ручного тестирования

- [ ] Купоны правильно отображаются в модалке
- [ ] Предупреждения появляются когда нужно
- [ ] Предупреждения исчезают когда условия выполнены
- [ ] Купоны снимаются автоматически при недостаточности ресурсов
- [ ] Кнопка "Сохранить" disabled при ошибках
- [ ] Скидка в модалке совпадает со скидкой в итогах
- [ ] Корректировки учитывают item купоны
- [ ] Автоскидки применяются к правильному остатку
- [ ] Итого никогда не положительное (если только нет доходов)
- [ ] Логи в консоли корректные и информативные
