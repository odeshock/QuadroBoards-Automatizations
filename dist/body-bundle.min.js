/*!
 * QuadroBoards Automatizations - BODY BUNDLE
 * @version 1.0.0
 */
function dfm_escape(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function dfm_insertAtCaret(e,t){e.focus();var n="number"==typeof e.selectionStart?e.selectionStart:e.value.length,r="number"==typeof e.selectionEnd?e.selectionEnd:e.value.length;e.value=e.value.slice(0,n)+t+e.value.slice(r),e.selectionStart=e.selectionEnd=n+t.length;try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch(e){}}function dfm_hash32(e){var t,n=2166136261;for(t=0;t<e.length;t++)n=16777619*((n^=e.charCodeAt(t))>>>0);return n>>>0}function dfm_prng(e){var t=e>>>0||2654435769;return function(){return t^=t<<13,t^=t>>>17,t^=t<<5,(t>>>=0)/4294967296}}function dfm_rng_int(e,t,n){var r=e();return t+Math.floor(r*(n-t+1))}function dfm_roll_det(e,t,n){var r,o=dfm_prng(n),i=[];for(r=0;r<e;r++)i.push(dfm_rng_int(o,1,t));return i}function dfm_canon(e,t,n){var r=String(parseInt(e,10)),o=String(parseInt(t,10)),i=parseInt(n,10);return r+":"+o+":"+(i=i>=0?"+"+i:""+i)}function dfm_makeSeed(e,t,n){return dfm_hash32("DiceFM|"+((e&&e.id?e.id:"").match(/\d+/)||[0])[0]+"|"+(e&&e.getAttribute("data-posted")||"0")+"|"+t+"|"+n)}function dfm_attach(){var e=document.getElementById("dicefm-btn"),t=document.getElementById("main-reply");e&&t&&e.addEventListener("click",function(){var e=prompt("Сколько дайсов бросаем?","1");if(null!==e){var n=parseInt(e,10);if(n>=1&&n<=100){var r=prompt("Сколько граней у каждого дайса?","6");if(null!==r){var o=parseInt(r,10);if(o>=2&&o<=1e5){var i=prompt("Есть ли бонус/штраф?","+0");if(null!==i)if(i=(i||"").trim(),/^[+-]?\d+$/.test(i)){var a=parseInt(i,10);if(Math.abs(a)>1e5)alert("Абсолютное значение должно быть не больше 100000");else{var s=a>=0?"+"+a:""+a,c=prompt("Причина броска (опционально)","")||"";c=c.replace(/\]/g," ").replace(/\s+/g," ").trim(),dfm_insertAtCaret(t,"[DiceFM "+n+":"+o+":"+s+":"+(c||"")+"]")}}else alert("Нужен формат +1 или -1")}else alert("Значение должно быть в пределах [2;100000]")}}else alert("Значение должно быть в пределах [1;100]")}})}function dfm_render(e,t,n,r,o){var i=parseInt(e,10),a=parseInt(t,10),s=parseInt(n,10);if(!(i>=1&&i<=100&&a>=2&&a<=1e5&&Math.abs(s)<=1e5))throw new Error("Проблема с данными");var c,l=dfm_roll_det(i,a,o),d=0,u="";for(c=0;c<l.length;c++)d+=l[c],u+=(c?"+":"")+l[c];var p="("+u+")"+(0===s?"":s>0?"+"+s:""+s)+"="+(d+s);return'<div class="quote-box"><blockquote style="text-align:left"><p>'+("<b>Бросок "+i+"d"+a+(0===s?"":s>0?" с бонусом "+s:" со штрафом "+s)+"</b>")+(r?"<br><em>"+dfm_escape(r)+"</em>":"")+"<br><br><b>Результат:</b> "+p+"</p></blockquote></div>"}function dfm_replace(e){if(e){var t=e.closest?e.closest(".post"):null,n=e.innerHTML,r={},o=n.replace(/\[(?:DiceFM)\s+(\d+)\s*:\s*(\d+)\s*:\s*([+-]?\d+)\s*:\s*(?:"([^"]*)"|([^\]]*))\s*\]/gi,function(e,n,o,i,a,s){try{var c=((null!=a?a:s)||"").replace(/\s+/g," ").trim(),l=dfm_canon(n,o,i),d=r[l]||0;return r[l]=d+1,dfm_render(n,o,i,c,dfm_makeSeed(t,l,d))}catch(t){return e}});o!==n&&(e.innerHTML=o)}}function dfm_init(){if("undefined"==typeof FORUM||FORUM.topic)for(var e=document.querySelectorAll?document.querySelectorAll(".post-content"):[],t=0;t<e.length;t++)dfm_replace(e[t])}window.jQuery?(jQuery(function(){dfm_attach(),dfm_init()}),jQuery(document).on("pun_post",function(){dfm_init()}),jQuery(document).on("pun_edit",function(){dfm_init()})):document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){dfm_attach(),dfm_init()}),$.fn.fixDashes=function(){var e="[\\s\\u00A0\\u202F\\u2009\\u2002-\\u2008\\u200A\\u200B\\uFEFF\\u200C\\u200D]",t=new RegExp(e),n=new RegExp("^"+e+"*$");function r(e){return!!e&&t.test(e)}function o(e){return!e||n.test(e)}function i(e){return"-"===e||"−"===e||e&&e>="‐"&&e<="―"}var a=new RegExp("("+e+")(?:-|[\\u2010-\\u2015]|\\u2212)(?="+e+")","g"),s=new RegExp(e+"(?:-|[\\u2010-\\u2015]|\\u2212)"+e+"*$"),c={ADDRESS:1,ARTICLE:1,ASIDE:1,BLOCKQUOTE:1,DIV:1,DL:1,DT:1,DD:1,FIELDSET:1,FIGCAPTION:1,FIGURE:1,FOOTER:1,FORM:1,H1:1,H2:1,H3:1,H4:1,H5:1,H6:1,HEADER:1,HR:1,LI:1,MAIN:1,NAV:1,OL:1,P:1,PRE:1,SECTION:1,TABLE:1,THEAD:1,TBODY:1,TFOOT:1,TR:1,TD:1,TH:1,UL:1},l={SCRIPT:1,STYLE:1,CODE:1,PRE:1,KBD:1,SAMP:1};function d(e){for(var t=e.length-1;t>=0;t--)if(!r(e.charAt(t)))return t;return-1}function u(e){for(var t=0;t<e.length;t++)if(!r(e.charAt(t)))return t;return-1}function p(e){for(var t,n=[e];n.length;)for(t=n.shift().firstChild;t;t=t.nextSibling){if(3===t.nodeType&&!o(t.nodeValue))return t;if(1===t.nodeType){var r=t.nodeName.toUpperCase();if(l[r])continue;n.push(t)}}return null}function m(e){for(var t=e;t;t=t.parentNode)if(1===t.nodeType){var n=t.className||"";if("string"==typeof n&&-1!==n.indexOf("quote-box")&&-1!==n.indexOf("spoiler-box")&&-1!==n.indexOf("media-box"))return!0}return!1}function f(e,t){if(e&&t){var n=e.nodeValue;if(s.test(n)){var o=d(n);if(-1!==o){var a=n.charAt(o),c=o>0?n.charAt(o-1):"";if(i(a)&&r(c)){var l=t.nodeValue;l.length&&r(l.charAt(0))&&(e.nodeValue=n.slice(0,o)+"—"+n.slice(o+1))}}}}}function h(e,t){try{if("text/html"!==(e.getAttribute("type")||"").toLowerCase())return;var n=e.text||e.textContent||"";if(!n)return;var r=document.createElement("div");r.innerHTML=n,t(r);var o=r.innerHTML;e.text=o,e.textContent=o}catch(e){}}function g(e){var t=null,n=!1;!function w(y){for(var v=y.firstChild;v;v=v.nextSibling)if(3===v.nodeType){var b=v.nodeValue;if(o(b)){t&&(n=!0);continue}b=b.replace(a,"$1—");var S=!t||n||t&&t.nodeValue.length&&r(t.nodeValue.charAt(t.nodeValue.length-1)),x=u(b);if(S&&-1!==x&&i(b.charAt(x)))r(x+1<b.length?b.charAt(x+1):"")&&(b=b.slice(0,x)+"—"+b.slice(x+1));if(v.nodeValue=b,t){var k=t.nodeValue,C=b.length&&r(b.charAt(0));if(s.test(k)){var E=d(k);if(-1!==E){var _=k.charAt(E),$=E>0?k.charAt(E-1):"";i(_)&&r($)&&(C||n)&&(t.nodeValue=k.slice(0,E)+"—"+k.slice(E+1))}}}t=v,n=!1}else if(1===v.nodeType){var F=v.nodeName.toUpperCase();if("SCRIPT"===F&&m(v)){h(v,g),t=null,n=!1;continue}if(l[F]){t=null,n=!1;continue}if("BR"===F){t=null,n=!1;continue}if(c[F]&&v!==e)g(v),t=null,n=!1;else{if(t){var I=p(v);I&&f(t,I)}w(v)}}}(e)}return this.each(function(){g(this)})},$(function(){$(".post-content").fixDashes()}),(()=>{const e=new Promise(e=>{"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});(async()=>{try{await e;Number(document.body?.dataset?.groupId||NaN);const t=window.GroupID?Number(window.GroupID):null,n=[...window.PROFILE_CHECK?.GroupID||[],...window.CHRONO_CHECK?.GroupID||[]],r=[...window.PROFILE_CHECK?.ForumID||[],...window.CHRONO_CHECK?.ForumID||[],...window.CHRONO_CHECK?.AmsForumID||[]],o=n.includes(t),i=document.querySelector(".container.crumbs"),a=i&&Array.from(i.querySelectorAll("a[href]")).some(e=>{try{const t=new URL(e.getAttribute("href"),location.href),n=t.searchParams.get("id"),o=!!n&&r.includes(Number(n));return t.pathname.endsWith("/viewforum.php")&&o}catch{return!1}});if(!o||!a)return;let s=document.querySelectorAll(".topicpost .post-body .post-box .post-content");if(!s.length)try{await FMV.waitForSelector(".topicpost .post-body .post-box .post-content",5e3),s=document.querySelectorAll(".topicpost .post-body .post-box .post-content")}catch{return}const c=s[s.length-1];if(!c||c.querySelector(".ams_info"))return;const l=document.createElement("div");l.className="ams_info",l.textContent="",c.appendChild(document.createElement("br")),c.appendChild(l),window.__ams_ready=!0,window.dispatchEvent(new CustomEvent("ams:ready",{detail:{node:l}})),"function"==typeof window.__amsReadyResolve&&window.__amsReadyResolve(l)}catch(e){console.log("[AMS injector] error:",e)}})()})(),function(){async function e(e){if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(e),!0}catch(e){}return function(){try{return document.execCommand&&document.execCommand("copy")}catch(e){return!1}}()}let t=null;function n(){try{const e=window.getSelection&&window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges(),document.selection&&document.selection.empty&&document.selection.empty()}catch(e){}try{document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}catch(e){}const e=document.body,t=e.style.userSelect,n=e.style.webkitUserSelect;e.style.userSelect="none",e.style.webkitUserSelect="none",e.offsetHeight,e.style.userSelect=t,e.style.webkitUserSelect=n}function r(e){(function(e){return!!t&&!t.contains(e)})(e.target||e.srcElement)&&(t=null,n())}function o(n){!function(e){let t=e.querySelector(".legend");if(t||(t=document.createElement("strong"),t.className="legend",e.insertBefore(t,e.firstChild)),!t.dataset.copyReady){if(!t.querySelector(".code-copy")){let e=(t.textContent||"").trim();e&&!/^код:?\s*$/i.test(e)||(e="Скопировать код"),t.textContent="";const n=document.createElement("button");n.type="button",n.className="code-copy",n.textContent=e,t.appendChild(n)}t.dataset.copyReady="1"}}(n),n.__armed||(n.__armed=!0,n.addEventListener("click",async function(r){if(!(r.target.closest&&r.target.closest(".code-copy, .legend")||null))return;r.preventDefault(),r.stopPropagation();const o=n.querySelector("pre");o&&(!function(e){try{var t=document.createRange();t.selectNodeContents(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}catch(e){}}(o),function(e){t=e||null}(o),await e(function(e){return(e&&(e.innerText||e.textContent)||"").replace(/\s+$/,"")}(o)))},!0))}function i(e){var t,n;(t=".code-box",n=e,Array.prototype.slice.call((n||document).querySelectorAll(t))).forEach(o)}i(),document.addEventListener("pun_main_ready",function(){i()}),new MutationObserver(function(e){e.forEach(function(e){(e.addedNodes||[]).forEach(function(e){1===e.nodeType&&(e.matches&&e.matches(".code-box")&&o(e),e.querySelectorAll&&e.querySelectorAll(".code-box").forEach(o))})})}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("pointerdown",r,!0),document.addEventListener("mousedown",r,!0),document.addEventListener("click",r,!0),document.addEventListener("touchstart",r,!0),document.addEventListener("focusin",r,!0),document.addEventListener("scroll",function(){t&&(t=null,n())},!0),document.addEventListener("selectionchange",function(){if(!t)return;const e=window.getSelection&&window.getSelection();if(!e||!e.rangeCount||e.isCollapsed)return void(t=null);const r=e.anchorNode;r&&!t.contains(r)&&(t=null,n())},!0),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&(t=null,n())},!0),window.addEventListener("blur",function(){t&&(t=null,n())},!0)}(),function(){"use strict";async function e(e,t,n=null){if(console.log("[admin_bridge_json] 🔥 СОХРАНЕНИЕ ДЛЯ userId:",e),console.log("[admin_bridge_json] 🔥 skinData:",JSON.parse(JSON.stringify(t))),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet||"function"!=typeof window.FMVbank.storageSet)return console.error("[admin_bridge_json] FMVbank.storageGet или storageSet не найдены"),!1;const r=(()=>{const e=new Date,t=e.getTimezoneOffset(),n=new Date(e.getTime()+6e4*(180+t));return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`})();try{console.log("[admin_bridge_json] 📥 Загружаю текущие данные из API...");const o=await window.FMVbank.storageGet(e,"skin_"),i=o&&"object"==typeof o?o:{};if(console.log("[admin_bridge_json] 📥 Текущие данные из API:",JSON.parse(JSON.stringify(i))),null!==n){const e=i.last_timestamp||null;if(console.log("[admin_bridge_json] 🕐 Проверка timestamp: initial="+n+", current="+e),null!==e&&e!==n)return alert("К сожалению, за время работы на странице данные для этого пользователя были изменены. Пожалуйста, откройте новую вкладку и заполните обновления снова."),console.error("[admin_bridge_json] ❌ Конфликт: данные были изменены другим пользователем"),!1}const a=i.comment_id;if(!a)return alert("Укажите id комментария для юзера."),console.error("[admin_bridge_json] ❌ comment_id не указан"),!1;console.log("[admin_bridge_json] ✅ comment_id:",a);const s=["icon","plashka","background","gift","coupon"];for(const e of s){let n=t[e]||[];if("coupon"===e){const e=n.length;n=n.filter(e=>!(e.expired_date&&e.expired_date<r)||(console.log(`[admin_bridge_json] Удалён истекший купон: ${e.id}, expired_date=${e.expired_date} < ${r}`),!1));const t=n.length;e!==t&&console.log(`[admin_bridge_json] 🗑️ Купоны: удалено ${e-t} истекших`)}console.log("[admin_bridge_json] 📦 "+e+": "+n.length+" элементов"),i[e]=n}i.last_timestamp=Math.floor(Date.now()/1e3),console.log("[admin_bridge_json] 💾 Финальный объект для сохранения:",JSON.parse(JSON.stringify(i))),console.log("[admin_bridge_json] 📝 Обновляю комментарий #"+a);const c=await async function(e,t,n){return new Promise((r,o)=>{try{const i={...n},a=["icon","plashka","background","gift","coupon"];for(const e of a){const t=n[e]||[];i[e]=t.map(e=>{const t={...e};return delete t.content,t})}const s=JSON.stringify(i),c=window.SITE_URL+"/profile.php?id="+t+'\n[media="лог"]'+s+"[/media]",l="/edit.php?id="+e;console.log("[admin_bridge_json] 🌐 Создаём iframe для редактирования комментария:",l);const d=document.createElement("iframe");d.style.display="none",d.src=l,document.body.appendChild(d);const u=setTimeout(()=>{d.remove(),o(new Error("Таймаут обновления комментария (10 секунд)"))},1e4);let p=0;d.onload=function(){if(p++,console.log("[admin_bridge_json] iframe onload #"+p),1!==p)2===p&&(console.log("[admin_bridge_json] ✅ Форма успешно отправлена, комментарий обновлён"),clearTimeout(u),d.remove(),r(!0));else try{const e=d.contentDocument||d.contentWindow.document,t=e.querySelector('textarea[name="req_message"]'),n=e.querySelector('input[type="submit"][name="submit"]');if(!t||!n)return clearTimeout(u),d.remove(),void o(new Error("Форма редактирования не найдена"));t.value=c,console.log("[admin_bridge_json] 📝 Данные вставлены в форму, длина:",c.length),console.log("[admin_bridge_json] 📤 Нажимаю кнопку отправки"),n.click()}catch(e){clearTimeout(u),d.remove(),o(e)}},d.onerror=function(){clearTimeout(u),d.remove(),o(new Error("Не удалось загрузить страницу редактирования"))}}catch(e){console.error("[admin_bridge_json] Ошибка обновления комментария:",e),o(e)}})}(a,e,i);if(!c)return console.error("[admin_bridge_json] ❌ Не удалось обновить комментарий"),!1;console.log("[admin_bridge_json] ✅ Комментарий успешно обновлён");return await window.FMVbank.storageSet(i,e,"skin_")?(console.log("[admin_bridge_json] ✅ Данные успешно сохранены в API"),!0):(console.error("[admin_bridge_json] ❌ Не удалось сохранить данные в API"),!1)}catch(e){return console.error("[admin_bridge_json] Ошибка сохранения:",e),!1}}window.skinAdmin={load:async function(t,n){const r=await async function(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return console.error(`[admin_bridge_json] Не удалось загрузить ${t}`),Number(e);const r=await n.text(),o=(new DOMParser).parseFromString(r,"text/html").querySelector(".modal_script");if(!o)return console.warn(`[admin_bridge_json] .modal_script не найден в ${t}, используем profileId=${e}`),Number(e);const i=o.getAttribute("data-main-user_id");return i&&i.trim()?Number(i.trim()):Number(e)}catch(t){return console.error("[admin_bridge_json] Ошибка загрузки страницы:",t),Number(e)}}(t);if(!r)return{status:"error",visibleData:{},chrono:{},comment_id:null,save:null,targetUserId:null};const{data:o,chrono:i,comment_id:a,last_timestamp:s}=await async function(e){const t={icon:[],plashka:[],background:[],gift:[],coupon:[]};let n={},r=null,o=null;if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[admin_bridge_json] FMVbank.storageGet не найден"),{data:t,chrono:n,comment_id:r,last_timestamp:o};const i=(()=>{const e=new Date,t=e.getTimezoneOffset(),n=new Date(e.getTime()+6e4*(180+t));return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`})();try{const a=await window.FMVbank.storageGet(e,"skin_");if(!a||"object"!=typeof a)return console.warn("[admin_bridge_json] Нет данных в API для userId="+e),{data:t,chrono:n,comment_id:r,last_timestamp:o};n=a.chrono||{},r=a.comment_id||null,o=a.last_timestamp||null;const s=["icon","plashka","background","gift","coupon"];for(const e of s){const n=a[e]||[];Array.isArray(n)&&n.forEach(n=>{"coupon"===e&&n.expired_date&&n.expired_date<i?console.log(`[admin_bridge_json] Пропущен истекший купон: ${n.id}, expired_date=${n.expired_date} < ${i}`):t[e].push(n)})}}catch(e){console.error("[admin_bridge_json] Ошибка загрузки данных:",e)}return{data:t,chrono:n,comment_id:r,last_timestamp:o}}(r);return{status:"ok",visibleData:o,chrono:i,comment_id:a,save:async function(t){const n=await e(r,t,s);return{ok:n,status:n?"успешно":"ошибка сохранения"}},targetUserId:r}}}}();const DEBUG=!1,log=(...e)=>{false};function isProfileFieldsPage(){try{const e=new URL(location.href);return/\/profile\.php$/i.test(e.pathname)&&"fields"===e.searchParams.get("section")&&/^\d+$/.test(e.searchParams.get("id")||"")}catch{return!1}}function getProfileId(){return new URL(location.href).searchParams.get("id")||""}async function getUserIdFromPage(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return console.error("[get_skin_api] Не удалось загрузить",t),Number(e);const r=await n.text(),o=new DOMParser,i=o.parseFromString(r,"text/html").querySelector(".modal_script");if(!i)return log(),Number(e);const a=i.getAttribute("data-main-user_id");return a&&a.trim()?(log(),Number(a.trim())):Number(e)}catch(t){return console.error("[get_skin_api] Ошибка загрузки страницы:",t),Number(e)}}async function loadSkinsFromAPI(e){if(log(),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[get_skin_api] FMVbank.storageGet не найден"),{icons:[],plashki:[],backs:[]};const t={icons:[],plashki:[],backs:[]};try{const n=await window.FMVbank.storageGet(e,"skin_");if(log(),!n||"object"!=typeof n)return log(),t;const r={icon:"icons",plashka:"plashki",background:"backs"};for(const[e,o]of Object.entries(r)){const r=n[e];Array.isArray(r)?(t[o]=r.map(e=>e.content||"").filter(Boolean),log(r.length)):log()}}catch(e){console.error("[get_skin_api] Ошибка загрузки данных:",e)}return log(),t}async function collectSkinSets(){if(log(),!isProfileFieldsPage())return log(),{icons:[],plashki:[],backs:[]};const e=getProfileId();log();const t=await getUserIdFromPage(e);log();const n=await loadSkinsFromAPI(t);return log(),n}async function pageExistsViaEditEndpoint(e){const t=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,n=await fetchCP1251Doc(t),r=(n.querySelector("title")?.textContent||"").trim(),o=(n.querySelector("h1, .pagetitle, .tclcon h2")?.textContent||"").trim(),i=/Страница создана/i.test(r),a=!!n.querySelector('input[name="edit_page"]'),s=!![...n.querySelectorAll('input[type="submit"],button[type="submit"]')].find(e=>/сохран/i.test(e.value||e.textContent||""));/Информация/i.test(r)||/Информация/i.test(o);return!!(i||a||s)}function extractInfoMessage(e){const t=(new DOMParser).parseFromString(e,"text/html"),n=(t.querySelector("title")?.textContent||"").trim();return(n?`[${n}] `:"")+([...t.querySelectorAll(".message, .msg, .infobox, .warn, .error, #pun-main p, .block p, .box p")].map(e=>e.textContent.trim()).filter(Boolean).join("\n").trim()||"").trim()}function classifyResult(e){const t=extractInfoMessage(e).toLowerCase();return/уже существует|занято|должно быть уникаль/.test(t)?{status:"duplicate",msg:t}:/страница создана|добавлен|успешно|сохранена/.test(t)?{status:"created",msg:t}:/ошибка|forbidden|нет прав|не удалось|некоррект|заполните/.test(t)?{status:"error",msg:t}:{status:"unknown",msg:t}}async function FMVcreatePersonalPage(e,t,n,r,o,i){const a="/admin_pages.php?action=adddel";try{if(await pageExistsViaEditEndpoint(t))return{status:"exists",title:e,name:t,serverMessage:`Страница "${t}" уже существует (до отправки формы).`,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`};const s=await fetchCP1251Doc(a),c=[...s.querySelectorAll("form")].find(e=>(e.action||"").includes("/admin_pages.php"))||s.querySelector('form[action*="admin_pages.php"]');if(!c)return{status:"error",title:e,name:t,serverMessage:"Форма добавления не найдена",details:"admin_pages.php без формы"};(c.querySelector('[name="title"]')||{}).value=e,(c.querySelector('[name="name"]')||{}).value=t,(c.querySelector('[name="content"]')||{}).value=n;const l=c.querySelector('[name="tags"]');l&&(l.value=r);const d=c.querySelector('select[name="announcement"]');d?d.value=i:[...c.querySelectorAll('input[name="announcement"]')].forEach(e=>e.checked=e.value===i);for(const e of o){const t=c.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}let u="add_page";const p=[...c.elements].find(e=>"submit"===e.type&&("add_page"===e.name||/создать/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(c,u),{res:f,text:h}=await fetchCP1251Text(a,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m}),g=classifyResult(h),w=extractInfoMessage(h)||"",y=await pageExistsViaEditEndpoint(t);return"created"===g.status||y?(console.log(w||"Страница создана"),{status:"created",title:e,name:t,serverMessage:w||"Страница создана",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"duplicate"===g.status?(console.log(w||"Уже существует страница с таким адресным именем"),{status:"exists",title:e,name:t,serverMessage:w||"Уже существует страница с таким адресным именем",httpStatus:f.status,url:`/admin_pages.php?edit_page=${encodeURIComponent(t)}`}):"error"===g.status?(console.log(g.msg||w||"Ошибка при создании"),{status:"error",title:e,name:t,serverMessage:g.msg||w||"Ошибка при создании",httpStatus:f.status}):(console.log(w||"Не удалось подтвердить создание. Проверьте админку."),{status:"uncertain",title:e,name:t,serverMessage:w||"Не удалось подтвердить создание. Проверьте админку.",httpStatus:f.status})}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,console.log(t),n}}async function FMVeditPersonalPage(e,t={}){if(!e)throw new Error('FMVeditPersonalPage: "name" is required');const n=`/admin_pages.php?edit_page=${encodeURIComponent(e)}`,r=await("function"==typeof fetchCP1251Doc?fetchCP1251Doc(n):(async()=>{const e=await fetch(n,{credentials:"include"}).then(e=>e.text());return(new DOMParser).parseFromString(e,"text/html")})()),o=(r.body&&r.body.textContent||"").trim();if(/Ссылка, по которой Вы пришли, неверная или устаревшая\./i.test(o))return{status:"forbidden",serverMessage:"Ссылка неверная или устаревшая",url:n};const i=[...r.querySelectorAll("form")].find(e=>(e.action||"").includes("admin_pages.php"))||r.querySelector("form");if(!i)return{status:"notfound",serverMessage:"Форма редактирования не найдена",url:n};if(null!=t.title){const e=i.querySelector('[name="title"]');e&&(e.value=String(t.title))}if(null!=t.content){const e=i.querySelector('#page-content,[name="content"]');e&&(e.value=String(t.content))}if(null!=t.announcement){const e=i.querySelector('select[name="announcement"]');if(e)e.value=String(t.announcement);else{const e=[...i.querySelectorAll('input[name="announcement"]')];e.length&&e.forEach(e=>e.checked=e.value==t.announcement)}}if(null!=t.tags){const e=i.querySelector('[name="tags"]');e&&(e.value=String(t.tags))}if(Array.isArray(t.groupsOn))for(const e of t.groupsOn){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!0)}if(Array.isArray(t.groupsOff))for(const e of t.groupsOff){const t=i.querySelector(`[name="group[${e}]"]`);t&&(t.checked=!1)}let a="save";const s=[...i.elements].find(e=>"submit"===e.type&&("save"===e.name||/сохр|save/i.test(e.value||e.textContent||"")));let c,l;s?.name&&(a=s.name);const d=new URL(i.getAttribute("action")||n,location.origin).toString();if("function"==typeof serializeFormCP1251_SelectSubmit&&"function"==typeof fetchCP1251Text){const e=serializeFormCP1251_SelectSubmit(i,a);({res:c,text:l}=await fetchCP1251Text(d,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=windows-1251"},referrer:n,referrerPolicy:"strict-origin-when-cross-origin",body:e}))}else{const e=new FormData(i);e.append(a,s?.value||"1"),c=await fetch(d,{method:"POST",credentials:"include",body:e}),l=await c.text()}const u=/Сохранено|успешн|изменени[яй]\s+сохранены/i.test(l),p=("function"==typeof extractInfoMessage?extractInfoMessage(l):"")||"",m=c.ok&&c.url&&/\/admin_pages\.php(?:\?|$)/.test(c.url)&&!/ошибк|forbidden|нет прав|устаревш/i.test((l||"").toLowerCase()),f=/Администрировани[ея]\s*[–-]\s*Страниц[ыь]/i.test(l)||/Список\s+персональных\s+страниц/i.test(l);if(c.ok&&(u||m||f))return{status:"saved",serverMessage:p||"Изменения сохранены",httpStatus:c.status,url:n};let h={status:"unknown",msg:p};if("function"==typeof classifyResult)try{h=classifyResult(l)}catch{}return/ошибк|forbidden|нет прав|устаревш/i.test((p||h.msg||"").toLowerCase())?{status:"forbidden",serverMessage:p||h.msg||"Нет прав/ошибка сохранения",httpStatus:c.status,url:n}:{status:"error",serverMessage:p||"Ошибка сохранения",httpStatus:c.status,url:n}}async function FMVeditTextareaOnly(e,t){return FMVeditPersonalPage(e,{content:t})}async function fetchAllLibraries(){const e=(...e)=>{false};if(e(),!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[fetchAllLibraries] FMVbank.storageGet не найден"),{plashka:[],icon:[],back:[],gift:[],coupon:[]};function t(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const n={plashka:[],icon:[],back:[],gift:[],coupon:[]},r=["icon","plashka","background","gift","coupon"];for(const o of r)try{const r=await window.FMVbank.storageGet(1,`library_${o}_`);if(!r||!r.items||!Array.isArray(r.items)){e();continue}const i=!0===window.IS_ADMIN||!0===window.IS_ADMIN_TO_EDIT;if("coupon"===o)n.coupon=r.items.map(e=>{const n=e.t?` title="${t(e.t)}"`:"",r=e.s_t?` data-coupon-title="${t(e.s_t)}"`:"",o=e.type?` data-coupon-type="${t(e.type)}"`:"",i=e.f?` data-coupon-form="${t(e.f)}"`:"",a=void 0!==e.v?` data-coupon-value="${t(String(e.v))}"`:"";return{id:e.id,html:`<div class="item" data-id="${t(e.id)}"${n}${r}${o}${i}${a}>${e.content||""}</div>`}});else{const e=(i?r.items:r.items.filter(e=>1!==e.h)).map(e=>({id:e.id,html:`<div class="item" data-id="${t(e.id)}" title="${t(e.t||"")}">${e.content||""}</div>`}));n["background"===o?"back":o]=e}}catch(e){console.error(`[fetchAllLibraries] Ошибка загрузки ${o}:`,e)}return n}!function(){const e=".modal_script[data-id]",t=(...e)=>false,n={icon:"._icon",plashka:"._plashka",background:"._background",gift:"._gift",coupon:"._coupon"};function r(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function o(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function i(i){if(!i)return;if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return void console.warn("[collect_skins_api] FMVbank.storageGet не найден");const a=i.querySelector(e)||document.querySelector(e);if(!a)return;const s=o(a);!function(t){const r=t.querySelector(e);r&&Object.values(n).forEach(e=>{const n=t.querySelector(e);n&&n.parentElement!==r&&r.appendChild(n)})}(s);const c=function(e){if(!e)return null;const t=e.getAttribute("data-main-user_id");if(t&&t.trim()){return Number(t.trim())}const n=e.getAttribute("data-id");if(n&&n.trim()){return Number(n.trim())}return null}(a);if(!c)return;const l=await async function(e){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)return console.error("[collect_skins_api] FMVbank.storageGet не найден"),null;const t={icon:[],plashka:[],background:[],gift:[],coupon:[]};try{const n=await window.FMVbank.storageGet(e,"skin_");return n&&"object"==typeof n?(["icon","plashka","background","gift","coupon"].forEach(e=>{const r=n[e];if(Array.isArray(r)){const n=r.filter(e=>!1!==e.is_visible);t[e]=n,n.length,r.length}else t[e]=[]}),t):t}catch(e){return console.error("[collect_skins_api] Ошибка загрузки данных:",e),t}}(c);l&&function(e,o){for(const[i,a]of Object.entries(n)){const n=e.querySelector(a);if(!n){t();continue}const s=o[i]||[];if(0===s.length){t(),n.innerHTML="";continue}const c=s.map(e=>{const t=[`data-id="${r(e.id)}"`,`title="${r(e.title||"")}"`];return Object.keys(e).forEach(n=>{if("id"!==n&&"title"!==n&&"content"!==n&&"is_visible"!==n){const o="data-"+n.replace(/_/g,"-");t.push(`${o}="${r(e[n]||"")}"`)}}),`<div class="item" ${t.join(" ")}>${e.content||""}</div>`}).join("\n");n.innerHTML=c,t(s.length)}}(s,l)}window.loadUserSkinsFromApi=function({root:e,rootSelector:t}={}){i(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{i(document)});const a=new WeakSet;new MutationObserver(t=>{t.forEach(t=>{t.addedNodes&&t.addedNodes.forEach(t=>{t instanceof Element&&(t.matches&&t.matches(e)&&!a.has(t)&&(a.add(t),i(o(t))),t.querySelectorAll&&t.querySelectorAll(e).forEach(e=>{a.has(e)||(a.add(e),i(o(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0})}(),function(){const e=".modal_script[data-id]",t=".chrono_info";function n(){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank не найден — подключите src/bank/api.js")}function r(e){return e.closest(".modal_wrap, .reveal-modal, .container, #character")||e.parentElement||document}async function o(e,r){const o=r.querySelector(t);if(!o)return;o.innerHTML="<p>Загрузка хронологии...</p>";const i=await async function(e){n();try{const t=await window.FMVbank.storageGet(Number(e),"chrono_");return t&&"object"==typeof t&&t.chrono?(t.chrono,t.chrono):null}catch(t){return console.error(`[collect_api] Ошибка получения данных для userId ${e}:`,t),null}}(e);if(!i)return void(o.innerHTML="<p>Не удалось загрузить данные хронологии</p>");const a=function(e){if(!e||"object"!=typeof e)return"<p>Нет данных хронологии</p>";if(window.FMV&&"function"==typeof window.FMV.buildChronoHtml)try{return window.FMV.buildChronoHtml(e,{titlePrefix:"Хронология"})}catch(e){console.error("[collect_api] Ошибка FMV.buildChronoHtml:",e)}const t=Object.entries(e);if(0===t.length)return"<p>Хронология пуста</p>";let n='<div class="chrono-data">';for(const[e,r]of t)n+=`<div><strong>${e}:</strong> ${JSON.stringify(r)}</div>`;return n+="</div>",n}(i);a.length,function(e,t){e&&(e.innerHTML=t)}(o,a)}async function i(i){if(!i)return;try{n()}catch(e){return void console.warn("[collect_api]",e.message)}const a=i.querySelector(e)||document.querySelector(e);if(!a)return;const s=r(a);!function(n){const r=n.querySelector(e);if(!r)return;const o=n.querySelector(t);o&&o.parentElement!==r&&r.appendChild(o)}(s);const c=a.getAttribute("data-id")?.trim();c&&await o(c,s)}window.loadUserChronoFromApi=function({root:e,rootSelector:t}={}){i(e||(t?document.querySelector(t):document))},document.addEventListener("DOMContentLoaded",()=>{i(document)});const a=new WeakSet;new MutationObserver(t=>{t.forEach(t=>{t.addedNodes&&t.addedNodes.forEach(t=>{t instanceof Element&&(t.matches&&t.matches(e)&&!a.has(t)&&(a.add(t),i(r(t))),t.querySelectorAll&&t.querySelectorAll(e).forEach(e=>{a.has(e)||(a.add(e),i(r(e)))}))})})}).observe(document.documentElement,{childList:!0,subtree:!0})}(),(()=>{"use strict";const e=(...e)=>{false};if(!(window.PROFILE_CHECK&&window.PROFILE_CHECK.GroupID&&window.SKIN&&window.PROFILE_CHECK.ForumID&&window.SKIN.LogFieldID))return void console.warn("[button_create_storage] Требуется window.PROFILE_CHECK с GroupID, ForumID и window.SKIN с LogFieldID");const t=window.PROFILE_CHECK.GroupID.map(Number),n=window.SKIN.LogFieldID,r=window.PROFILE_CHECK.ForumID||[];async function o(t,r,o,i){try{r("Проверяю..."),o(""),i&&i("");const a=window.SITE_URL||window.location.origin,s=await async function(t){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageGet)throw new Error("FMVbank.storageGet не найден");try{const e=await window.FMVbank.storageGet(t,"skin_");return e&&"object"==typeof e?{skinExists:!0,commentId:e.comment_id||null,data:e,error:!1}:{skinExists:!1,commentId:null,data:null,error:!1}}catch(t){return e(),{skinExists:!1,commentId:null,data:null,error:!0}}}(t);if(!s.error&&s.skinExists&&s.commentId){if(r("✓ уже указано","green"),o(`Хранилище уже создано (comment_id: ${s.commentId})`),i){i(`${a}/viewtopic.php?id=${n}#p${s.commentId}`)}return}r("Проверяю страницу...");const c=await async function(e){try{const t=`/pages/usr${e}`,n=await fetch(t);if(!n.ok)return{valid:!1,error:`HTTP ${n.status}`,isTwink:!1};const r=await n.text(),o=(new DOMParser).parseFromString(r,"text/html"),i=o.querySelector(".info .container");if(i&&/неверная или устаревшая/i.test(i.textContent))return{valid:!1,error:"Необходимо создать и заполнить персональную страницу по шаблону.",isTwink:!1};const a=o.querySelector(".modal_script");if(!a)return{valid:!1,error:"Необходимо создать и заполнить персональную страницу по шаблону.",isTwink:!1};const s=a.getAttribute("data-main-user_id");if(null!==s){const e=s.trim();return e&&"УБРАТЬ ЕСЛИ НЕ НУЖНО"!==e&&/^\d+$/.test(e)?{valid:!1,error:"Это твинк, ему не нужно отдельное хранилище",isTwink:!0}:{valid:!1,error:"Необходимо создать и заполнить персональную страницу по шаблону.",isTwink:!1}}return{valid:!0,error:null,isTwink:!1}}catch(e){return{valid:!1,error:`Ошибка загрузки страницы: ${e.message}`,isTwink:!1}}}(t);if(!c.valid)return c.isTwink?r("✖ ошибка","red"):r("✖ отсутствует персональная страница","red"),void o(c.error);r("Создаю комментарий...");const l=await async function(t){return new Promise((r,o)=>{const i="/viewtopic.php?id="+n,a=window.SITE_URL+"/profile.php?id="+t;e();const s=document.createElement("iframe");s.style.display="none",s.src=i,document.body.appendChild(s);let c=0;const l=setTimeout(()=>{s.remove(),o(new Error("Таймаут создания комментария (15 секунд)"))},15e3);s.onload=function(){if(c++,e(),1!==c){if(2===c){e();try{const t=(s.contentDocument||s.contentWindow.document).querySelectorAll('div.post[id^="p"]');if(e(t.length),t.length>0){const n=t[t.length-1].id;e();const o=n.match(/^p(\d+)$/);if(o){const t=Number(o[1]);return e(),clearTimeout(l),s.remove(),void r(t)}}try{const t=s.contentWindow.location.href;e();const n=t.match(/[?&]pid=(\d+)/);if(n){const t=Number(n[1]);return e(),clearTimeout(l),s.remove(),void r(t)}const o=t.match(/#p(\d+)/);if(o){const t=Number(o[1]);return e(),clearTimeout(l),s.remove(),void r(t)}}catch(t){e(t.message)}clearTimeout(l),s.remove(),o(new Error("Не удалось извлечь comment_id после создания комментария"))}catch(e){clearTimeout(l),s.remove(),o(e)}}}else try{const t=s.contentDocument||s.contentWindow.document,n=t.querySelector('textarea#main-reply[name="req_message"]'),r=t.querySelector('input[type="submit"][name="submit"]');if(!n||!r)return clearTimeout(l),s.remove(),void o(new Error("Не найдена форма ответа в теме логов"));n.value=a,e(),e(),r.click()}catch(e){clearTimeout(l),s.remove(),o(e)}},s.onerror=function(){clearTimeout(l),clearInterval(redirectCheckInterval),s.remove(),o(new Error("Не удалось загрузить страницу темы"))}})}(t);if(r("Сохраняю..."),await async function(t,n,r=null){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageSet)throw new Error("FMVbank не найден");const o=r&&"object"==typeof r?r:{};if(o.comment_id=n,o.last_timestamp=Math.floor(Date.now()/1e3),!await window.FMVbank.storageSet(o,t,"skin_"))throw new Error("Не удалось сохранить данные в API");return e(),!0}(t,l,s.data),r("✓ готово","green"),o(`Хранилище создано (comment_id: ${l})`),i){i(`${a}/viewtopic.php?id=${n}#p${l}`)}}catch(e){r("✖ ошибка","red"),o(e?.message||String(e)),console.error("[button_create_storage] Ошибка:",e)}}window.FMV||(window.FMV={}),"function"==typeof window.createForumButton?window.createForumButton({allowedGroups:t,allowedForums:r,label:"Создать хранилище данных",order:4.5,showStatus:!0,showDetails:!0,showLink:!0,async onClick(t){const n=t?.setStatus||(()=>{}),r=t?.setDetails||(()=>{}),i=t?.setLink||(()=>{}),a=document.querySelector("div.post.topicpost");if(!a)return n("✖ ошибка","red"),void r("Не найден контейнер div.post.topicpost");const s=function(e){const t=e.querySelector('.pl-email.profile a[href*="profile.php?id="]');if(!t)return null;const n=t.href.match(/profile\.php\?id=(\d+)/);return n?Number(n[1]):null}(a);if(!s)return n("✖ ошибка","red"),void r("Не удалось определить ID пользователя");e(),await o(s,n,r,i)}}):console.warn("[button_create_storage] createForumButton не найдена")})(),(()=>{"use strict";const e=(...e)=>{false};if(e(),e(window.SKIN),!window.SKIN||!window.SKIN.LibraryFieldID)return console.warn("[button_load_library] Требуется window.SKIN с LibraryFieldID"),void console.warn("[button_load_library] window.SKIN:",window.SKIN);const t=[window.SKIN.LibraryForumID],n=window.SKIN.GroupID||[],r=String(window.SKIN.LibraryFieldID).trim();e(),e(),e();const o={gift:window.SKIN.LibraryGiftPostID||[],plashka:window.SKIN.LibraryPlashkaPostID||[],icon:window.SKIN.LibraryIconPostID||[],background:window.SKIN.LibraryBackPostID||[],coupon:window.SKIN.LibraryCouponPostID||[]};function i(e){const t=e.querySelector(".id"),n=e.querySelector(".content"),r=e.querySelector(".desc");if(!t)return null;const o=t.textContent.trim();if(!o)return null;const i={id:o,content:n?n.innerHTML.trim():"",t:r?r.textContent.trim():""};return i.h=e.classList.contains("hidden")?1:0,i}function a(e){const t=e.querySelector(".id"),n=e.querySelector(".content"),r=e.querySelector(".desc"),o=e.querySelector(".title"),i=e.querySelector(".type"),a=e.querySelector(".form"),s=e.querySelector(".value");if(!t)return null;const c=t.textContent.trim();if(!c)return null;const l={id:c,content:n?n.innerHTML.trim():"",t:r?r.textContent.trim():""};if(o){const e=o.textContent.trim();e&&(l.s_t=e)}if(i){const e=i.textContent.trim();e&&(l.type=e)}if(a){const e=a.textContent.trim();e&&(l.f=e)}if(s){const e=s.textContent.trim();if(e){const t=Number(e);isNaN(t)||(l.v=t)}}return l}async function s(t,n=!1){try{const r=`/viewtopic.php?pid=${t}#p${t}`;e();const o=await async function(e){const t=await fetch(e,{credentials:"include"}),n=await t.arrayBuffer(),r=e=>{try{return new TextDecoder(e).decode(n)}catch{return null}},o=r("utf-8")??"",i=r("windows-1251")??"",a=e=>(e.match(/\uFFFD/g)||[]).length;if(a(i)&&!a(o))return o;if(a(o)&&!a(i))return i;const s=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return s(i)>s(o)?i:o}(r),s=new DOMParser,c=s.parseFromString(o,"text/html").querySelector(`#p${t}-content`);if(!c)return console.warn(`[button_load_library] Не найден #p${t}-content`),[];e();const l=[...c.querySelectorAll('script[type="text/html"]')];if(e(l.length),!l.length)return console.warn(`[button_load_library] Нет script[type="text/html"] в посте ${t}`),[];const d=function(e){const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""}(l.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," "),u=s.parseFromString(d,"text/html").querySelectorAll("#grid article.card");e(u.length);const p=[];for(const e of u){const t=n?a(e):i(e);t&&p.push(t)}return p}catch(e){return console.error(`[button_load_library] Ошибка загрузки поста ${t}:`,e),[]}}e(window.createForumButton),"function"==typeof window.createForumButton?(e(),window.createForumButton({allowedGroups:n,allowedForums:t,topicId:r,label:"Подгрузить библиотеку",order:1,showStatus:!0,showDetails:!0,showLink:!1,async onClick(t){const n=t?.setStatus||(()=>{}),r=t?.setDetails||(()=>{});try{n("Собираю данные..."),r("");const t=await async function(){const t={gift:[],plashka:[],icon:[],background:[],coupon:[]};for(const[n,r]of Object.entries(o)){if(!Array.isArray(r)||0===r.length){e();continue}const o="coupon"===n;for(const i of r){e();const r=await s(i,o);t[n].push(...r),e(r.length)}}return t}(),i=Object.values(t).reduce((e,t)=>e+t.length,0);if(0===i)return n("✓ готово","green"),void r("Не найдено элементов в постах библиотеки");n("Сохраняю..."),await async function(t){if(!window.FMVbank||"function"!=typeof window.FMVbank.storageSet)throw new Error("FMVbank.storageSet не найден");const n=Math.floor(Date.now()/1e3),r=["icon","plashka","background","gift","coupon"];for(const o of r){const r={items:t[o]||[],last_timestamp:n};if(e(),!await window.FMVbank.storageSet(r,1,`library_${o}_`))throw new Error(`Не удалось сохранить данные для ${o} в API`)}return!0}(t),n("✓ готово","green");r(`Загружено элементов:<br>${Object.entries(t).map(([e,t])=>`${e}: ${t.length} шт.`).join("<br>")}<br>Всего: ${i}`)}catch(e){n("✖ ошибка","red"),r(e?.message||String(e)),console.error("[button_load_library] Ошибка:",e)}}}),e()):console.warn("[button_load_library] createForumButton не найдена"),e()})(),window.ChronoFilter={init:({root:e}={})=>function(e){const t=(t,n=e)=>n.querySelector(t),n=(t,n=e)=>Array.from(n.querySelectorAll(t)),r=e=>e?new Date(e):null,o=(e,t)=>Array.from(e?.querySelectorAll(`input[name="${t}"]:checked`)||[]).map(e=>e.value),i=t("#filters"),a=t("#list");if(!i||!a)return{apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}};const s=t("#dateStart"),c=t("#dateEnd"),l=t("#resetBtn"),d=t("#typeList"),u=t("#statusList"),p=t("#maskList"),m=t("#playerList"),f=t("#locationList");function h(e,n){const r=t(e);if(!r||!n)return()=>{};const o=e=>{e.stopPropagation(),n.style.display="block"===n.style.display?"none":"block"},i=e=>{n.contains(e.target)||r.contains(e.target)||(n.style.display="none")};return r.addEventListener("click",o),document.addEventListener("click",i),()=>{r.removeEventListener("click",o),document.removeEventListener("click",i)}}const g=h("#typeToggle",d),w=h("#statusToggle",u),y=h("#maskToggle",p),v=h("#playerToggle",m),b=h("#locationToggle",f),S=n("#list .episode").map(e=>{const t=(e.dataset.mask||"").split(";").map(e=>e.trim()).filter(Boolean),n=(e.dataset.players||"").split(";").map(e=>e.trim()).filter(Boolean);return{el:e,type:(e.dataset.type||"").trim(),status:(e.dataset.status||"").trim(),startL:r(e.dataset.startL),startR:r(e.dataset.startR),endL:r(e.dataset.endL),endR:r(e.dataset.endR),masks:t,players:n,location:(e.dataset.location||"").trim()}});function x(){const t=s?.value?new Date(s.value):null,n=c?.value?new Date(c.value):null,r=o(d,"type"),i=o(u,"status"),a=o(p,"mask"),l=o(m,"player"),h=o(f,"location"),g=[],w=[];return S.forEach(e=>{let o=!0;o&&t&&e.endL&&e.endL<t&&(o=!1),o&&n&&e.startR&&e.startR>n&&(o=!1),o&&r.length&&!r.includes(e.type)&&(o=!1),o&&i.length&&!i.includes(e.status)&&(o=!1),o&&a.length&&!e.masks.some(e=>a.includes(e))&&(o=!1),o&&l.length&&!e.players.some(e=>l.includes(e))&&(o=!1),o&&h.length&&!h.includes(e.location)&&(o=!1),e.el.style.display=o?"":"none",(o?g:w).push(e.el)}),e.dispatchEvent(new CustomEvent("chrono:filtered",{detail:{visible:g,hidden:w}})),g}function k(){return s&&(s.value=""),c&&(c.value=""),n('#filters .dropdown-list input[type="checkbox"]').forEach(e=>{e.checked=!1}),x()}function C(e){e.target.closest("#filters .dropdown-list")&&e.target.matches('input[type="checkbox"]')&&x()}return e.addEventListener("change",C),s?.addEventListener("change",x),c?.addEventListener("change",x),l?.addEventListener("click",e=>{e.preventDefault(),k()}),x(),{apply:x,reset:k,getVisible:()=>S.filter(e=>"none"!==e.el.style.display).map(e=>e.el),destroy:()=>{e.removeEventListener("change",C),s?.removeEventListener("change",x),c?.removeEventListener("change",x),l?.removeEventListener("click",k),g(),w(),y(),v(),b()}}}(e||document),apply:()=>[],reset:()=>[],getVisible:()=>[],destroy:()=>{}},function(){window.FMV||(window.FMV={});const e=e=>String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),t=t=>e(t).replace(/"/g,"&quot;"),n=e=>Array.from(new Set((e||[]).filter(Boolean))),r=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"";FMV.utils={esc:e,escAttr:t,unique:n,capitalize:r};const o={personal:{label:"личный",emoji:"<иконка>"},plot:{label:"сюжетный",emoji:"<иконка>"},au:{label:"au",emoji:"<иконка>"}},i={on:{label:"активен",emoji:"<иконка>"},archived:{label:"неактуален",emoji:"<иконка>"},off:{label:"закрыт",emoji:"<иконка>"}},a=e=>String(e).padStart(2,"0"),s=(e,t)=>new Date(e,t,0).getDate(),c=(e,t,n)=>`${e}-${a(t)}-${a(n)}`;function l(e){const t=String(e||"").trim();if(!t)return null;let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);return n?{y:+n[3],m:+n[2],d:+n[1],g:"day"}:(n=t.match(/^(\d{4})-(\d{2})-(\d{2})$/),n?{y:+n[1],m:+n[2],d:+n[3],g:"day"}:(n=t.match(/^(\d{1,2})\.(\d{4})$/),n?{y:+n[2],m:+n[1],d:1,g:"month"}:(n=t.match(/^(\d{4})$/),n?{y:+n[1],m:1,d:1,g:"year"}:null)))}FMV.buildChronoHtml=function(d,u={}){u.titlePrefix,e(d?.name||"");const p=Array.isArray(d?.episodes)?d.episodes:[],m=n(p.flatMap(e=>Array.isArray(e?.masks)?e.masks:[])),f=n(p.flatMap(e=>(Array.isArray(e?.participants)?e.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return t.length?t.join(", "):String(e?.name||"").trim()}).map(e=>e.replace(/;/g," ")).filter(Boolean))),h=n(p.map(e=>e?.location).filter(Boolean));let g=null,w=null;const y=p.map(e=>{const t=function(e,t){const n=l(e),r=t?l(t):null;if(!n&&!r)return{startL:"",startR:"",endL:"",endR:""};let o="",i="";n?"day"===n.g?(o=c(n.y,n.m,1),i=c(n.y,n.m,n.d)):"month"===n.g?(o=c(n.y,n.m,1),i=c(n.y,n.m,s(n.y,n.m))):(o=c(n.y,1,1),i=c(n.y,12,31)):r&&("day"===r.g?(o=c(r.y,r.m,1),i=c(r.y,r.m,r.d)):"month"===r.g?(o=c(r.y,r.m,1),i=c(r.y,r.m,s(r.y,r.m))):(o=c(r.y,1,1),i=c(r.y,12,31)));let a="",d="";return r?"day"===r.g?(a=c(r.y,r.m,r.d),d=c(r.y,r.m,s(r.y,r.m))):"month"===r.g?(a=c(r.y,r.m,1),d=c(r.y,r.m,s(r.y,r.m))):(a=c(r.y,1,1),d=c(r.y,12,31)):n&&("day"===n.g?(a=c(n.y,n.m,n.d),d=c(n.y,n.m,s(n.y,n.m))):"month"===n.g?(a=c(n.y,n.m,1),d=c(n.y,n.m,s(n.y,n.m))):(a=c(n.y,1,1),d=c(n.y,12,31))),{startL:o,startR:i,endL:a,endR:d}}(e?.dateStart,e?.dateEnd);return t.startL&&(!g||t.startL<g)&&(g=t.startL),t.endR&&(!w||t.endR>w)&&(w=t.endR),t}),v=Object.entries(o).map(([n,r])=>`<label><input type="checkbox" name="type" value="${t(n)}"> ${e(r.label)}</label>`).join(""),b=Object.entries(i).map(([n,r])=>`<label><input type="checkbox" name="status" value="${t(n)}"> ${e(r.label)}</label>`).join(""),S=n(m).map(n=>`<label><input type="checkbox" name="mask" value="${t(n)}"> ${e(n)}</label>`).join(""),x=f.map(n=>`<label><input type="checkbox" name="player" value="${t(n)}"> ${e(n)}</label>`).join(""),k=h.map(n=>`<label><input type="checkbox" name="location" value="${t(n)}"> ${e(n)}</label>`).join("");let C=`<div class="filters" id="filters">\n    <div class="f">\n      <label>Дата начала фильтра</label>\n      <input type="date" id="dateStart" value="${t(g||"")}">\n    </div>\n    <div class="f">\n      <label>Дата конца фильтра</label>\n      <input type="date" id="dateEnd" value="${t(w||"")}">\n    </div>\n    <div class="f">\n      <label>Тип</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="typeToggle">Выбрать тип</button>\n        <div class="dropdown-list" id="typeList">\n          ${v}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Статус</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="statusToggle">Выбрать статус</button>\n        <div class="dropdown-list" id="statusList">\n          ${b}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Маска</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="maskToggle">Выбрать маску</button>\n        <div class="dropdown-list" id="maskList">\n          ${S}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Участник</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="playerToggle">Выбрать участника</button>\n        <div class="dropdown-list" id="playerList">\n          ${x}\n        </div>\n      </div>\n    </div>\n    <div class="f">\n      <label>Локация</label>\n      <div class="dropdown-wrapper">\n        <button class="dropdown-toggle" id="locationToggle">Выбрать локацию</button>\n        <div class="dropdown-list" id="locationList">\n          ${k}\n        </div>\n      </div>\n    </div>\n    <div class="actions">\n      <button class="button" id="resetBtn">Сбросить</button>\n    </div>\n  </div>\n  \n  <div class="list" id="list">\n    `;return p.length?(p.forEach((n,s)=>{const c=o[n?.type]||o.au,d=i[n?.status]||i.archived,u=n?.type||"",p=`${r(u)} ${c.emoji}`,m=n?.status||"",f=`${r(m)} ${d.emoji}`,h=Array.isArray(n?.masks)?n.masks.filter(Boolean):[],g=(Array.isArray(n?.participants)?n.participants:[]).map(e=>{const t=Array.isArray(e?.masks)?e.masks.filter(Boolean).map(e=>String(e).trim()).filter(Boolean):"string"==typeof e?.mask&&e.mask.trim()?[e.mask.trim()]:[];return(t.length?t.join(", "):String(e?.name||"").trim()).replace(/;/g," ")}).filter(Boolean),w=g.join(";"),v=(Array.isArray(n?.participants)?n.participants:[]).map(n=>{const r=Array.isArray(n?.masks)&&n.masks.length?n.masks.join(", "):String(n?.name||"").trim(),o=n?.id?String(n.id).trim():"";return o?`<a href="/profile.php?id=${t(o)}">${e(r)}</a>`:e(r)}).filter(Boolean).join(", "),b=n?.location||"",S=y[s],x=function(e,t){const n=l(e),r=l(t),o=e=>`${a(e.d)}.${a(e.m)}.${e.y}`,i=e=>`${a(e.m)}.${e.y}`,s=e=>`${e.y}`;if(!n&&!r)return"";if(n&&r&&("day"===n.g&&"day"===r.g&&n.y===r.y&&n.m===r.m&&n.d===r.d||"month"===n.g&&"month"===r.g&&n.y===r.y&&n.m===r.m||"year"===n.g&&"year"===r.g&&n.y===r.y)){if("day"===n.g)return o(n);if("month"===n.g)return i(n);if("year"===n.g)return s(n)}if(!n||!r)return"";const c={...n},d={...r},u=(e,t,n=1)=>{e.m="number"==typeof t?t:e.m??1,e.d=n,e.g="day"},p=(e,t)=>{e.m="number"==typeof t?t:e.m??1,e.d=1,e.g="month"};return"day"===c.g&&"month"===d.g&&u(d,d.m,1),"day"===d.g&&"month"===c.g&&u(c,c.m,1),"day"===c.g&&"year"===d.g&&u(d,1,1),"day"===d.g&&"year"===c.g&&u(c,1,1),"month"===c.g&&"year"===d.g&&p(d,c.m),"month"===d.g&&"year"===c.g&&p(c,d.m),"day"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m&&c.d===d.d?o(c):c.y===d.y&&c.m===d.m?`${a(c.d)}-${a(d.d)}.${a(c.m)}.${c.y}`:c.y===d.y&&c.m!==d.m?`${a(c.d)}.${a(c.m)}-${a(d.d)}.${a(d.m)}.${c.y}`:`${o(c)}-${o(d)}`:"month"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?i(c):c.y===d.y&&c.m!==d.m?`${a(c.m)}-${a(d.m)}.${c.y}`:`${i(c)}-${i(d)}`:"year"===c.g&&"year"===d.g?c.y===d.y?s(c):`${s(c)}-${s(d)}`:"day"===c.g&&"month"===d.g?c.y===d.y&&c.m===d.m?o(c):c.y===d.y?`${a(c.d)}.${a(c.m)}-${a(d.m)}.${c.y}`:`${o(c)}-${i(d)}`:"month"===c.g&&"day"===d.g?c.y===d.y&&c.m===d.m?o(d):c.y===d.y?`${a(c.m)}.${c.y}-${a(d.d)}.${a(d.m)}.${d.y}`:`${i(c)}-${o(d)}`:"day"===c.g&&"year"===d.g?c.y===d.y?o(c):`${o(c)}-${s(d)}`:"year"===c.g&&"day"===d.g?c.y===d.y?o(d):`${s(c)}-${o(d)}`:"month"===c.g&&"year"===d.g?c.y===d.y?i(c):`${i(c)}-${s(d)}`:"year"===c.g&&"month"===d.g?c.y===d.y?i(d):`${s(c)}-${i(d)}`:""}(n?.dateStart,n?.dateEnd),k=x?`<span class="muted">${e(x)} — </span>`:"";C+=`\n  <div class="episode" \n       data-type="${t(u)}" \n       data-status="${t(m)}" \n       data-start-l="${t(S.startL)}" data-start-r="${t(S.startR)}" \n       data-end-l="${t(S.endL)}" data-end-r="${t(S.endR)}"\n       ${h.length?`data-mask="${t(h.join(";"))}"`:""}\n       ${b?`data-location="${t(b)}"`:""}\n       ${g.length?`data-players="${t(w)}"`:""}>\n    <div>тип: ${e(p)}; статус: ${e(f)}</div>\n    <div>${k}<span class="title"><a href="${e(n?.href||"#")}">${e(n?.title||"")}</a></span>\n      ${h.length?` [as ${e(h.join(", "))}]`:""}</div>\n    <div>локация: ${e(b)}</div>\n    <div>участники: ${v}</div>\n  </div>`}),C+="</div>",C):(C+='<div class="meta">Нет эпизодов</div></section>',C)}}(),(()=>{"use strict";const e=(...e)=>{false},t=document.querySelector('textarea#main-reply[name="req_message"]');if(!t)return void e();if(e(),document.querySelector('input[type="checkbox"][name="firstpost"]'))return void e();e();let n=!1;const r=(document.querySelector("head title")?.textContent||"").toLowerCase().trim();if((r.startsWith("гринготтс")||r.startsWith("реклама"))&&(e(),n=!0),!n&&window.EPS_FORUM_INFO&&Array.isArray(window.EPS_FORUM_INFO)){const t=document.querySelector(".container.crumbs");if(t){const r=Array.from(t.querySelectorAll('a[href*="/viewforum.php?id="]')).map(e=>{const t=e.getAttribute("href")?.match(/viewforum\.php\?id=(\d+)/);return t?Number(t[1]):null}).filter(Boolean),o=window.EPS_FORUM_INFO.map(e=>Number(e.id)).filter(e=>!isNaN(e));r.some(e=>o.includes(e))&&(e(),n=!0)}}if(!n)return void e();e();const o=window.UserID;if(!o)return void console.warn("[auto_author_tag] window.UserID не найден");e();const i=Array.isArray(window.GAME_MASTERS)&&window.GAME_MASTERS.includes(o);e();const a=window.GroupID===window.GROUP_IDS?.Admin;e();const s=i||a;e();const c=/^\[FMVauthor\]usr(\d+);?\[\/FMVauthor\]\s*/i;function l(e){const t=e.match(c);return t?{authorId:t[1],cleanText:e.replace(c,"")}:null}function d(e,t){return c.test(e)?e:`[FMVauthor]usr${t};[/FMVauthor]${e}`}let u=!1;function p(){if(u)return;u=!0;const e=document.createElement("style");e.textContent="\n      .fmvauthor-badge {\n        margin-bottom: 8px;\n        padding: 8px 12px;\n        background-color: #f3f4f6;\n        border: 1px solid #d1d5db;\n        border-radius: 6px;\n        font-size: 14px;\n        color: #374151;\n        font-weight: 500;\n      }\n      .fmvauthor-gm-selector {\n        margin-bottom: 12px;\n      }\n      .fmvauthor-gm-selector label {\n        display: block;\n        font-weight: 600;\n        margin-bottom: 6px;\n        font-size: 14px;\n        color: #2d2a26;\n      }\n      .fmvauthor-gm-selector .combo {\n        position: relative;\n      }\n      .fmvauthor-gm-selector input {\n        width: 100%;\n        padding: 8px 10px;\n        border: 1px solid #d8d1c3;\n        border-radius: 8px;\n        background: #efe9dc;\n        color: #2d2a26;\n        font-size: 14px;\n      }\n      .fmvauthor-gm-selector .hint {\n        margin-top: 4px;\n        font-size: 12.5px;\n        color: #6b6359;\n      }\n      .fmvauthor-gm-selector .autocomplete-list {\n        position: absolute;\n        z-index: 50;\n        left: 0;\n        right: 0;\n        background: #fff;\n        border: 1px solid #d8d1c3;\n        border-radius: 8px;\n        margin-top: 4px;\n        max-height: 240px;\n        overflow: auto;\n        display: none;\n      }\n      .fmvauthor-gm-selector .autocomplete-list.show {\n        display: block;\n      }\n      .fmvauthor-gm-selector .autocomplete-item {\n        padding: 0.45em 0.65em;\n        cursor: pointer;\n        font-size: 14px;\n      }\n      .fmvauthor-gm-selector .autocomplete-item:hover,\n      .fmvauthor-gm-selector .autocomplete-item.active {\n        background-color: #f0efe9;\n      }\n      .fmvauthor-gm-selector .autocomplete-item .muted {\n        color: #6b6359;\n      }\n      .fmvauthor-gm-selector .chip {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        padding: 0.45em 0.6em;\n        background: #fff;\n        border: 1px solid #d8d1c3;\n        border-radius: 8px;\n        margin: 0.35em 0;\n        font-size: 14px;\n      }\n      .fmvauthor-gm-selector .chip .name {\n        font-weight: 600;\n      }\n      .fmvauthor-gm-selector .chip .x {\n        border: 0;\n        background: none;\n        font-size: 16px;\n        line-height: 1;\n        cursor: pointer;\n        color: #8b8378;\n        margin-left: auto;\n      }\n      .fmvauthor-gm-selector .chip .x:hover {\n        color: #2d2a26;\n      }\n    ",document.head.appendChild(e)}let m=null;function f(n){m&&m.remove(),p(),m=document.createElement("div"),m.className="fmvauthor-badge",m.textContent=`Автор комментария: user${n}`,t.parentNode.insertBefore(m,t),e()}let h=null,g=null,w=null,y=[];function v(n=null){h&&h.remove(),p(),h=document.createElement("div"),h.className="fmvauthor-gm-selector";const r=document.createElement("label");r.textContent="Автор поста: *",r.setAttribute("for","fmvauthor-gm-input");const o=document.createElement("div");o.className="combo";const i=document.createElement("input");i.type="text",i.id="fmvauthor-gm-input",i.placeholder="Наберите имя пользователя...",i.autocomplete="off";const a=document.createElement("div");a.className="autocomplete-list",o.appendChild(i),o.appendChild(a);const s=document.createElement("div");s.className="chip-container";const c=document.createElement("div");if(c.className="hint",c.textContent="Необходимо для автоматического подсчета постов. Начните вводить имя или user ID.",h.appendChild(r),h.appendChild(o),h.appendChild(s),h.appendChild(c),t.parentNode.insertBefore(h,t),n){g=n;const t=y.find(e=>e.id===Number(n));w=t?t.name:`user${n}`,b(s,o),e()}else e();!function(t,n,r,o){let i=-1;function a(e){const t=e.toLowerCase().trim();if(n.innerHTML="",!t)return void n.classList.remove("show");const r=y.filter(e=>e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)).slice(0,20);0!==r.length?(r.forEach((e,t)=>{const r=document.createElement("div");r.className="autocomplete-item",r.textContent=`${e.name} `;const o=document.createElement("span");o.className="muted",o.textContent=`(${e.code})`,r.appendChild(o),r.dataset.userId=e.id,r.dataset.index=t,r.addEventListener("click",()=>{s(e)}),n.appendChild(r)}),n.classList.add("show"),i=-1):n.classList.remove("show")}function s(i){g=i.id,w=i.name,t.value="",n.classList.remove("show"),b(r,o),e(i.id,i.name)}function c(e){e.forEach((e,t)=>{e.classList.toggle("active",t===i)}),i>=0&&e[i]&&e[i].scrollIntoView({block:"nearest"})}t.addEventListener("input",()=>{a(t.value)}),t.addEventListener("keydown",e=>{const t=n.querySelectorAll(".autocomplete-item");if("ArrowDown"===e.key)e.preventDefault(),i=Math.min(i+1,t.length-1),c(t);else if("ArrowUp"===e.key)e.preventDefault(),i=Math.max(i-1,-1),c(t);else if("Enter"===e.key){if(e.preventDefault(),i>=0&&t[i]){const e=t[i].dataset.userId,n=y.find(t=>t.id===Number(e));n&&s(n)}}else"Escape"===e.key&&n.classList.remove("show")}),document.addEventListener("click",e=>{h?.contains(e.target)||n.classList.remove("show")})}(i,a,s,o)}function b(t,n){if(t.innerHTML="",!g)return void(n.style.display="block");n.style.display="none";const r=document.createElement("div");r.className="chip";const o=document.createElement("span");o.className="name",o.textContent=w||`user${g}`;const i=document.createElement("button");i.type="button",i.className="x",i.textContent="×",i.setAttribute("aria-label","Удалить"),i.addEventListener("click",()=>{g=null,w=null,b(t,n),e()}),r.appendChild(o),r.appendChild(i),t.appendChild(r)}let S=null;function x(){const n=l(t.value);i?n?(e(n.authorId),S=n.authorId,t.value=n.cleanText,v(n.authorId)):(e(),S=null,v(null)):n?(e(n.authorId),S=n.authorId,t.value=n.cleanText,s?f(n.authorId):e()):(e(),S=null,s&&m&&(m.remove(),m=null,e()))}function k(){if(e(),e(),null!==S)return e(),{shouldAdd:!0,authorId:S};const t=window.location.href;if(e(),/\/edit\.php\?id=/i.test(t))return e(),{shouldAdd:!1,authorId:null};const n=(document.querySelector("head title")?.textContent||"").toLowerCase().trim();if(e(),n.startsWith("гринготтс")||n.startsWith("реклама"))return e(),{shouldAdd:!0,authorId:o};if(e(window.EPS_FORUM_INFO),window.EPS_FORUM_INFO&&Array.isArray(window.EPS_FORUM_INFO)){const t=document.querySelector(".container.crumbs");if(t){const n=Array.from(t.querySelectorAll('a[href*="/viewforum.php?id="]')).map(e=>{const t=e.getAttribute("href")?.match(/viewforum\.php\?id=(\d+)/);return t?Number(t[1]):null}).filter(Boolean);e();const r=window.EPS_FORUM_INFO.map(e=>Number(e.id)).filter(e=>!isNaN(e));if(e(),n.some(e=>r.includes(e)))return e(),{shouldAdd:!0,authorId:o}}}return e(),{shouldAdd:!1,authorId:null}}t.addEventListener("input",()=>{const e=l(t.value);if(e)if(t.value=e.cleanText,i){if(h){g=e.authorId;const t=h.querySelector("input"),n=y.find(t=>t.id===Number(e.authorId));t&&(t.value=n?n.name:`user${e.authorId}`)}}else s&&f(e.authorId)});const C=t.closest("form");e(),C||console.warn("[auto_author_tag] Форма не найдена - submit handler не будет установлен");const E=C?.querySelector('input[type="submit"][name="submit"]');e(),E?(e(),"undefined"!=typeof $&&$(C).length?$(C).off("submit.fmvauthor").on("submit.fmvauthor",function(n){if(e(),i){if(!g)return n.preventDefault(),alert("Необходимо выбрать автора поста из списка!"),e(),!1;if(k().shouldAdd){const n=t.value,r=d(n,g);r!==n&&(e(),t.value=r)}}else{const n=k();if(!n.shouldAdd)return void e();const r=t.value,o=d(r,n.authorId);o!==r?(e(n.authorId),t.value=o):e()}}):C.addEventListener("submit",n=>{if(e(),i){if(!g)return n.preventDefault(),alert("Необходимо выбрать автора поста из списка!"),e(),!1;if(k().shouldAdd){const n=t.value,r=d(n,g);r!==n&&(e(),t.value=r)}}else{const n=k();if(!n.shouldAdd)return void e();const r=t.value,o=d(r,n.authorId);o!==r?(e(n.authorId),t.value=o):e()}})):console.warn("[auto_author_tag] Кнопка отправки не найдена - submit handler не будет установлен"),(async()=>{await async function(){if(i){e();try{"function"==typeof window.FMV?.fetchUsers?(y=await window.FMV.fetchUsers(),e(y.length)):"function"==typeof window.scrapeUsers?(y=await window.scrapeUsers(),e(y.length)):Array.isArray(window.scrapedUsers)?(y=window.scrapedUsers,e(y.length)):(console.warn("[auto_author_tag] Нет доступных методов для загрузки пользователей"),y=[])}catch(e){console.error("[auto_author_tag] Ошибка загрузки пользователей:",e),y=[]}}}(),x(),e()})()})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Создать страницу",order:1,async onClick({setStatus:e,setDetails:t,setLink:n}){const r=document.querySelector("#pun-main h1 span"),o=r?r.textContent.trim().toLowerCase():"";if(!o)return e("✖ нет имени темы","red"),void t("Ожидался #pun-main h1 span");let i=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]');if(!i)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),i=document.querySelector('a[href*="profile.php?id="]')}catch{}const a=i?.href?.match(/profile\.php\?id=(\d+)/i);if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const s=a[1],c=`usr${s}`,l=(window.PROFILE_CHECK?.PPageTemplate||"").replace(/data-id="N"/g,`data-id="${s}"`),d=window.PROFILE_CHECK?.PPageGroupID;if("function"!=typeof window.FMVcreatePersonalPage)return e("✖ функция не найдена","red"),void t("Ожидалась window.FMVcreatePersonalPage(arg1, arg2, arg3, arg4, arg5, arg6)");e("Создаём…","#555"),t(""),n(null);try{const r=await window.FMVcreatePersonalPage(o,c,l,"",d,"0");switch(r?.status){case"created":e("✓ создано","green");break;case"exists":e("ℹ уже существует","green");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}r?.url&&n(r.url,"Открыть страницу");const i=[];r?.serverMessage&&i.push("Сообщение сервера: "+r.serverMessage),r?.httpStatus&&i.push("HTTP: "+r.httpStatus),r?.title&&i.push("Пользователь: "+r.title),r?.name&&i.push("Адресное имя: "+r.name),r?.details&&i.push("Details: "+r.details),t(i.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n?.message||String(n)),console.error("[button_personal_page]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Сменить группу",order:4,async onClick({setStatus:e,setDetails:t}){const n=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupUserID||"",r=window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupPlayerID||"";if(!n||!r){const o=[n?null:"PROFILE_CHECK.GroupUserID",r?null:"PROFILE_CHECK.GroupPlayerID"].filter(Boolean).join(", ");return e("✖ замена не выполнена","red"),void t("Не удалось запустить изменение группы: "+(o?`не заданы параметры ${o}. Укажите значения и повторите.`:"отсутствуют необходимые параметры."))}let o=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]')||document.querySelector('.topic .post .post-links a[href*="profile.php?id="]')||document.querySelector('a[href*="profile.php?id="]');if(!o)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),o=document.querySelector('a[href*="profile.php?id="]')}catch{}const i=o?.href?.match(/profile\.php\?id=(\d+)/i),a=i?i[1]:"";if(!a)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=... из страницы темы");if("function"!=typeof window.FMVupdateGroupIfEquals)return e("✖ функция недоступна","red"),void t("Ожидалась window.FMVupdateGroupIfEquals(userId, fromId, toId)");e("Проверяю и обновляю…","#555"),t("");try{const o=await window.FMVupdateGroupIfEquals(a,n,r);let i="";if(o?.details){const e=String(o.details).match(/current=([^\s]+)/);e&&(i=e[1])}switch(o?.status){case"updated":e("✓ группа изменена","green");break;case"nochange":e("ℹ изменений нет — пользователь уже в целевой группе","green");break;case"skipped":return e("✖ исходная группа не совпадает","red"),void t(`Исходное значение группы — ${i||"не определено"}.\nЛибо вы пытаетесь поправить не тот профиль, либо выполните замену вручную для дополнительной валидации.`);case"uncertain":e("❔ не удалось подтвердить результат","#b80");break;default:e("✖ ошибка при сохранении","red")}const s=[];o?.serverMessage&&s.push("Сообщение сервера: "+o.serverMessage),o?.httpStatus&&s.push("HTTP: "+o.httpStatus),s.push("Пользователь: "+(o?.userId??a)),s.push(`Замена: ${n} → ${r}`),i&&s.push("Текущее (до попытки): "+i),o?.details&&!i&&s.push("Details: "+o.details),t(s.join("\n")||"Нет дополнительных данных")}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_group]",n)}}})})(),(()=>{"use strict";createForumButton({allowedGroups:window.PROFILE_CHECK&&window.PROFILE_CHECK?.GroupID||[],allowedForums:window.PROFILE_CHECK&&window.PROFILE_CHECK?.ForumID||[],label:"Выдать монетки",order:3,async onClick({setStatus:e,setDetails:t}){let n=document.querySelector('.topic .post-links .profile a[href*="profile.php?id="]');if(!n)try{await FMV.waitForSelector('a[href*="profile.php?id="]',3e3),n=document.querySelector('a[href*="profile.php?id="]')}catch{}const r=n?.href?.match(/profile\.php\?id=(\d+)/i);if(!r)return e("✖ не найден userId","red"),void t("Не удалось извлечь profile.php?id=...");const o=r[1],i=window.PROFILE_CHECK?.MoneyFieldID,a=window.PROFILE_CHECK?.MoneyFieldTemplate;let s;try{const n=`/pages/usr${o}`,r=await fetch(n);if(!r.ok)return e("✖ ошибка загрузки страницы","red"),void t(`Не удалось загрузить ${n}: HTTP ${r.status}`);const i=await r.text(),c=(new DOMParser).parseFromString(i,"text/html"),l=c.querySelector(".info .container");if(l&&/неверная или устаревшая/i.test(l.textContent))return e("✖ отсутствует персональная страница","red"),void t("Необходимо создать и заполнить персональную страницу по шаблону.");const d=c.querySelector(".modal_script");if(!d)return e("✖ отсутствует персональная страница","red"),void t("Необходимо создать и заполнить персональную страницу по шаблону.");const u=d.getAttribute("data-main-user_id");if(null!==u){const n=u.trim();if(!n||"УБРАТЬ ЕСЛИ НЕ НУЖНО"===n)return e("✖ отсутствует персональная страница","red"),void t("Необходимо создать и заполнить персональную страницу по шаблону.");if(!/^\d+$/.test(n))return e("✖ отсутствует персональная страница","red"),void t("Необходимо создать и заполнить персональную страницу по шаблону.");s=`\x3c!-- main: usr${n} --\x3e`}else s=String(a)}catch(n){return e("✖ ошибка проверки страницы","red"),t(`Ошибка при загрузке /pages/usr${o}: ${n.message}`),void console.error("[button_update_money_field]",n)}if("function"!=typeof window.FMVreplaceFieldData)return e("✖ функция обновления не найдена","red"),void t("Ожидалась window.FMVreplaceFieldData(userId, fieldId, value)");e("Обновляем…","#555"),t("");try{const n=await window.FMVreplaceFieldData(o,i,s);switch(n?.status){case"updated":e("✓ обновлено","green");break;case"nochange":e("ℹ изменений нет","green");break;case"error":e("✖ ошибка","red");break;default:e("❔ не удалось подтвердить","#b80")}const r=[];n?.serverMessage&&r.push("Сообщение сервера: "+n.serverMessage),n?.httpStatus&&r.push("HTTP: "+n.httpStatus),r.push("Поле: "+(n?.fieldId??i)),r.push("Пользователь: "+(n?.userId??o)),r.push("Значение: "+s),n?.details&&r.push("Details: "+n.details),t(r.join("\n"))}catch(n){e("✖ сеть/транспорт","red"),t(n&&n.message?n.message:String(n)),console.error("[button_update_money_field]",n)}}})})(),window.fetchAllLibraries=fetchAllLibraries,function(){"use strict";const e='\n  details.ufo-panel{margin-top:12px;border:1px solid #d0d0d7;border-radius:10px;background:#fff}\n  details.ufo-panel>summary{cursor:pointer;list-style:none;padding:10px 14px;font-weight:600;background:#f6f6f8;border-bottom:1px solid #e6e6ef;border-radius:10px}\n  details.ufo-panel>summary::-webkit-details-marker{display:none}\n  .ufo-wrap{display:flex;flex-direction:column;gap:16px;padding:14px}\n  .ufo-col{display:flex;flex-direction:column;gap:8px}\n  .ufo-col h4{margin:0;font-size:14px;opacity:.8;display:flex;justify-content:space-between;align-items:center}\n  .ufo-search{padding:6px 10px;font-size:13px;border:1px solid #d0d0d7;border-radius:8px;background:#f5f2e8}\n  .ufo-lib,.ufo-selected{border:1px dashed #c9c9d9;border-radius:8px;background:#fafafd;padding:8px;overflow:auto}\n  .ufo-lib{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}\n  .ufo-lib .ufo-card{margin:0}\n  .ufo-card{display:grid;grid-template-columns:auto 1fr auto auto;grid-template-rows:auto auto;grid-template-areas:"id full date actions" "id title title actions";gap:8px;background:#fff;border:1px solid #e7e7ef;border-radius:8px;padding:8px;margin:6px 0;max-width:100%;position:relative;overflow:hidden}\n  .ufo-idtag{grid-area:id;font-size:11px;opacity:.7;align-self:start}\n  .ufo-actions{grid-area:actions;display:flex;align-items:center;gap:6px}\n  .ufo-btn{border:1px solid #d7d7e0;background:#f3f3f7;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;line-height:1.15;display:inline-flex;align-items:center}\n  .ufo-btn:hover{background:#ececf4}\n  .ufo-card.disabled{opacity:.4;pointer-events:none}\n  .ufo-full{grid-area:full;box-sizing:border-box;margin:0;padding:0;border:0;background:transparent;overflow:hidden}\n  .ufo-full .item{position:relative;margin:0}\n  .ufo-full .item .modal-link{display:block}\n  .ufo-full .item img{display:block;max-width:100%;height:auto;border-radius:6px}\n  .ufo-lib .ufo-full .item img{height:90px;width:100%;object-fit:cover}\n  .ufo-lib .ufo-full a{pointer-events:none}\n  .ufo-title-edit{grid-area:title;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;white-space:pre-wrap;overflow:visible}\n  .ufo-title-edit:focus{outline:none;background:#fffdf1}\n  .ufo-date-edit{grid-area:date;border:1px dashed #aaa;border-radius:6px;padding:6px 8px;background:#fffef7;font-size:13px;align-self:start}\n  .ufo-date-edit input{border:none;background:transparent;font-size:13px;width:100%;font-family:inherit}\n  .ufo-date-edit input:focus{outline:none}\n  ';!function(){if(window.__ufoCSS)return;window.__ufoCSS=!0;const t=document.createElement("style");t.textContent=e,document.head.appendChild(t),"function"==typeof GM_addStyle&&GM_addStyle(e)}();const t=(e,t)=>{const n=document.createElement("button");return n.type="button",n.className="ufo-btn",n.textContent=e,n.addEventListener("click",t),n};function n(e){const t=e.querySelector(".ufo-card");if(!t)return void(e.style.maxHeight="");const n=getComputedStyle(t),r=t.getBoundingClientRect().height,o=parseFloat(n.marginTop)||0,i=parseFloat(n.marginBottom)||0,a=getComputedStyle(e),s=parseFloat(a.paddingTop)||0,c=parseFloat(a.paddingBottom)||0,l=Math.round(2*r+3*(o+i)+s+c);e.style.maxHeight=l+"px"}function r(e){const t=function(e){return[...e.querySelectorAll(".ufo-card")].find(e=>"none"!==getComputedStyle(e).display)||null}(e);if(!t)return void(e.style.maxHeight="");const n=t.getBoundingClientRect().height,r=getComputedStyle(e),o=parseFloat(r.rowGap)||0,i=parseFloat(r.paddingTop)||0,a=parseFloat(r.paddingBottom)||0,s=Math.round(2*n+o+i+a);e.style.maxHeight=s+"px"}window.createChoicePanelJSON=function(e){const o=Object.assign({title:"Библиотека и выбранные",targetClass:"_section",library:[],startOpen:!1,itemSelector:".item",idAttr:"data-id",editableAttr:"title",searchPlaceholder:"поиск по id",mountEl:null,allowMultiAdd:!1,expirableAttr:null},e||{});Array.isArray(o.library)||(o.library=[]);const i="ufo_"+(o.targetClass||"section").replace(/\W+/g,"_")+"_"+Math.random().toString(36).slice(2,7);let a=[];const s=document.createElement("details");s.className="ufo-panel",s.open=!!o.startOpen;const c=document.createElement("summary");c.textContent=o.title||"Панель";const l=document.createElement("div");l.className="ufo-wrap";const d=document.createElement("div");d.className="ufo-col";const u=document.createElement("h4");u.textContent="Библиотека";const p=document.createElement("input");p.type="text",p.placeholder=o.searchPlaceholder||"поиск по id",p.className="ufo-search",u.appendChild(p);const m=document.createElement("div");m.className="ufo-lib",m.id=i+"-lib",d.append(u,m);const f=document.createElement("div");f.className="ufo-col",f.innerHTML="<h4>Выбранные (сверху — новее)</h4>";const h=document.createElement("div");function g(e){const n=document.createElement("div");n.className="ufo-card",n.dataset.id=e.id;const r=document.createElement("div");r.className="ufo-idtag",r.textContent="#"+e.id;const i=document.createElement("div");i.className="ufo-full";const s=document.createElement("div");s.innerHTML=e.html.trim(),i.appendChild(s.firstElementChild);const c=document.createElement("div");return c.className="ufo-actions",c.appendChild(t("Добавить ↑",t=>{t.preventDefault(),t.stopPropagation(),function(e){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);if(!o.allowMultiAdd){if(a.some(t=>t.id===e.id))return;t&&t.classList.add("disabled")}const n=document.createElement("div");n.innerHTML=e.html.trim();const r=n.querySelector(o.itemSelector),i={id:e.id,title:r&&r.getAttribute(o.editableAttr)||"",content:r?r.innerHTML.trim():""};if(r&&r.attributes)for(let e=0;e<r.attributes.length;e++){const t=r.attributes[e];if(t.name.startsWith("data-")&&"data-id"!==t.name){i[t.name.substring(5).replace(/-/g,"_")]=t.value}}o.expirableAttr&&r&&(i.expired_date=r.getAttribute(o.expirableAttr)||"");a.unshift(i),w()}(e)})),n.append(r,i,c),n}function w(){h.innerHTML="",a.forEach((e,n)=>{const r=function(e,n){const r=document.createElement("div");r.className="ufo-card",r.draggable=!0,r.dataset.id=e.id,r.dataset.index=n;const i=document.createElement("div");i.className="ufo-idtag",i.textContent="#"+e.id;const s=document.createElement("div");s.className="ufo-full";const c=document.createElement("div");c.innerHTML=e.content.trim(),s.appendChild(c.firstElementChild);const l=document.createElement("div");l.className="ufo-title-edit",l.contentEditable=!0,l.textContent=e.title||"",l.addEventListener("blur",()=>{const e=String(l.innerHTML||"").replace(/<br\s*\/?>/gi,"\n").replace(/&nbsp;|[\u00A0\u200B-\u200D\u2060\uFEFF]/g,"").replace(/\s+/g," ").trim();a[n].title=e});let d=null;if(o.expirableAttr){d=document.createElement("div"),d.className="ufo-date-edit";const t=document.createElement("input");t.type="date",t.value=e.expired_date||"",t.addEventListener("change",()=>{a[n].expired_date=t.value}),d.appendChild(t)}const u=document.createElement("div");u.className="ufo-actions";const p=t("↑",e=>{e.preventDefault(),e.stopPropagation(),n>0&&([a[n-1],a[n]]=[a[n],a[n-1]],w())}),f=t("↓",e=>{e.preventDefault(),e.stopPropagation(),n<a.length-1&&([a[n],a[n+1]]=[a[n+1],a[n]],w())}),h=t("✕",t=>{if(t.preventDefault(),t.stopPropagation(),a.splice(n,1),!o.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.remove("disabled")}w()});u.append(p,f,h),r.append(i,s,u,l),d&&r.appendChild(d);return r}(e,n);h.appendChild(r)}),n(h)}return h.className="ufo-selected",h.id=i+"-selected",f.appendChild(h),l.append(d,f),s.append(c,l),o.mountEl&&o.mountEl.appendChild(s),o.library.forEach(e=>m.appendChild(g(e))),function(e){let t=null;e.addEventListener("dragstart",e=>{const n=e.target.closest(".ufo-card");n&&(t=parseInt(n.dataset.index,10),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""))}),e.addEventListener("dragover",e=>{e.preventDefault();const n=e.target.closest(".ufo-card");if(!n||null===t)return;const r=parseInt(n.dataset.index,10);if(t===r)return;const o=a[t];a.splice(t,1),a.splice(r,0,o),t=r,w()}),e.addEventListener("drop",e=>{e.preventDefault(),t=null}),e.addEventListener("dragend",()=>{t=null})}(h),p.addEventListener("input",()=>{const e=p.value.trim();m.querySelectorAll(".ufo-card").forEach(t=>{t.style.display=!e||t.dataset.id.includes(e)?"":"none"}),r(m)}),new MutationObserver(()=>n(h)).observe(h,{childList:!0,subtree:!0,attributes:!0}),new MutationObserver(()=>r(m)).observe(m,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),window.addEventListener("resize",()=>{r(m),n(h)}),r(m),n(h),{details:s,init:function(e){Array.isArray(e)&&(a=[],e.forEach(e=>{if(a.push({...e}),!o.allowMultiAdd){const t=m.querySelector(`.ufo-card[data-id="${e.id}"]`);t&&t.classList.add("disabled")}}),w())},getData:function(){return a.map(e=>{const t=document.createElement("div");if(t.innerHTML=e.content.trim(),o.expirableAttr){const n=t.querySelector("img");if(n){const t=n.parentNode.querySelector(".coupon_deadline");t&&t.remove();const r=document.createElement("span");if(r.className="coupon_deadline",e.expired_date){const t=e.expired_date.split("-");if(3===t.length){const e=t[0].slice(2),n=t[1],o=t[2];r.textContent=`${o}/${n}/${e}`}}n.nextSibling?n.parentNode.insertBefore(r,n.nextSibling):n.parentNode.appendChild(r)}}if(e.title){t.querySelectorAll(`[${o.editableAttr}]`).forEach(t=>{t.setAttribute(o.editableAttr,e.title)})}const n={id:e.id,title:e.title||"",content:t.innerHTML.trim()};return Object.keys(e).forEach(t=>{"id"!==t&&"title"!==t&&"content"!==t&&(n[t]=e[t])}),n})}}}}(),function(){"use strict";window.setupSkinsJSON=async function(e,t={}){if(!(e&&e instanceof HTMLElement))throw new Error("[setupSkinsJSON] container обязателен и должен быть HTMLElement");if("function"!=typeof window.createChoicePanelJSON)throw new Error("[setupSkinsJSON] createChoicePanelJSON не найден. Подключите файл с панелью раньше.");if(window.__skinsSetupJSONMounted)return window.__skinsSetupJSONMounted;const n=t.withHeaders??!0,r=t.startOpen??!1,o=t.initialData||{};if("function"!=typeof window.fetchAllLibraries)return void console.error("[setupSkinsJSON] window.fetchAllLibraries не найдена. Подключите fetch_libraries.js");const i=await window.fetchAllLibraries(),a=i.plashka,s=i.icon,c=i.back,l=i.gift,d=i.coupon;let u=e.querySelector(".skins-setup-grid");u||(u=document.createElement("div"),u.className="skins-setup-grid",u.style.display="grid",u.style.gridTemplateColumns="1fr",u.style.gap="16px",e.appendChild(u));const p=window.createChoicePanelJSON({title:n?"Подарки":void 0,targetClass:"_gift",library:l,mountEl:u,startOpen:r,allowMultiAdd:!0}),m=window.createChoicePanelJSON({title:n?"Купоны":void 0,targetClass:"_coupon",library:d,mountEl:u,startOpen:r,allowMultiAdd:!0,expirableAttr:"data-expired-date"}),f=window.createChoicePanelJSON({title:n?"Плашки":void 0,targetClass:"_plashka",library:a,mountEl:u,startOpen:r}),h=window.createChoicePanelJSON({title:n?"Иконки":void 0,targetClass:"_icon",library:s,mountEl:u,startOpen:r}),g=window.createChoicePanelJSON({title:n?"Фон":void 0,targetClass:"_background",library:c,mountEl:u,startOpen:r});o.gift&&p.init(o.gift),o.coupon&&m.init(o.coupon),o.plashka&&f.init(o.plashka),o.icon&&h.init(o.icon),o.background&&g.init(o.background);const w={getData:function(){return{icon:h.getData(),plashka:f.getData(),background:g.getData(),gift:p.getData(),coupon:m.getData()}},getLibraryIds:function(){return{icon:new Set(s.map(e=>String(e.id))),plashka:new Set(a.map(e=>String(e.id))),background:new Set(c.map(e=>String(e.id))),gift:new Set(l.map(e=>String(e.id))),coupon:new Set(d.map(e=>String(e.id)))}},panels:{plashka:f,icon:h,back:g,gift:p,coupon:m}};return window.__skinsSetupJSONMounted=w,w}}(),function(){"use strict";if(window.__profileRunnerJSONMounted)return;window.__profileRunnerJSONMounted=!0;const e=(e,t=document)=>t.querySelector(e);async function t(){await new Promise(e=>{if("complete"===document.readyState||"interactive"===document.readyState)return e();document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})});const t=e("#viewprofile .container")||e("#viewprofile")||e("#pun-main")||document.body,n=document.createElement("div");return n.id="fmv-skins-panel",n.style.margin="16px 0",n.innerHTML='\n       <details open style="border:1px solid #d6d6de;border-radius:10px;background:#fff">\n        <summary style="list-style:none;padding:10px 14px;border-bottom:1px solid #e8e8ef;border-radius:10px;font-weight:600;background:#f6f7fb;cursor:pointer">\n          Обновление скинов\n        </summary>\n        <div class="fmv-skins-body" style="padding:14px"></div>\n        <div class="fmv-skins-footer" style="display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid #eee">\n          <button type="button" class="fmv-save"\n            style="background:#2f67ff;color:#fff;border:1px solid #2f67ff;border-radius:8px;padding:8px 14px;cursor:pointer">\n            Сохранить\n          </button>\n          <span class="fmv-status" style="margin-left:8px;font-size:14px;color:#666"></span>\n        </div>\n      </details>\n    ',t.appendChild(n),n.querySelector(".fmv-skins-body")}(async()=>{if("/profile.php"!==location.pathname)return;const e=new URLSearchParams(location.search);if(!e.has("id")||[...e.keys()].some(e=>"id"!==e))return;const n=(e.get("id")||"").trim();if(!n)return;const r=window.SKIN?.GroupID||[];if("function"!=typeof window.ensureAllowed)return;if(!await window.ensureAllowed(r))return;const o=await t();let i=null,a=null;if("function"==typeof window.setupSkinsJSON)try{const e=await window.setupSkinsJSON(o,{initialData:{}});e&&"function"==typeof e.getData&&(i=e.getData),e&&"function"==typeof e.getLibraryIds&&(a=e.getLibraryIds)}catch(e){console.error("setupSkinsJSON() error:",e)}if(!i||!a)return void console.error("[profile_runner_json] Не удалось инициализировать панели");const s=a();if(!window.skinAdmin||"function"!=typeof window.skinAdmin.load)return void console.error("[profile_runner_json] skinAdmin.load не найден.");const{status:c,visibleData:l,save:d}=await window.skinAdmin.load(n,s);if("ok"!==c&&"ок"!==c)return void console.error("[profile_runner_json] Не удалось загрузить данные со скинами");if(window.__skinsSetupJSONMounted&&window.__skinsSetupJSONMounted.panels){const e=window.__skinsSetupJSONMounted.panels;l.gift&&e.gift&&e.gift.init(l.gift),l.coupon&&e.coupon&&e.coupon.init(l.coupon),l.plashka&&e.plashka&&e.plashka.init(l.plashka),l.icon&&e.icon&&e.icon.init(l.icon),l.background&&e.back&&e.back.init(l.background)}const u=document.getElementById("fmv-skins-panel"),p=u?.querySelector(".fmv-save"),m=u?.querySelector(".fmv-status");p&&p.addEventListener("click",async()=>{try{m&&(m.textContent="Сохраняю…",m.style.color="#666");const e=i?i():null;if(!e)return void(m&&(m.textContent="Нечего сохранять",m.style.color="#c24141"));let t=null;if("function"!=typeof d)return void(m&&(m.textContent="Нет функции сохранения",m.style.color="#c24141"));t=await d(e);const n=!(!t||!t.ok&&"saved"!==t.status&&"успешно"!==t.status&&"ok"!==t.status);m&&(n?(m.textContent="✓ Успешно сохранено",m.style.color="#16a34a",setTimeout(()=>location.reload(),1e3)):(m.textContent="Ошибка сохранения",m.style.color="#c24141"))}catch(e){console.error(e),m&&(m.textContent="Ошибка сохранения",m.style.color="#c24141")}})})()}(),
/*!
 * money-upd-slim.js — один экспорт: getFieldValue({ doc, fieldId }) -> string
 * - Заменяет <!-- main: usrN --> в li#pa-fldN
 * - Предоставляет window.MainUsrFieldResolver.getFieldValue
 */
function(){"use strict";if(!window.PROFILE_FIELDS?.MoneyID)return void console.error("Ошибка: не найдено значение PROFILE_FIELDS.MoneyID");const e=String(window.PROFILE_FIELDS?.MoneyID),t=`pa-fld${e}`,n=CSS.escape||(e=>String(e).replace(/[^a-zA-Z0-9_-]/g,"\\$&")),r=/^\s*main:\s*usr(\d+)\s*$/i,o=e=>`#${n(e)}, .${n(e)}`,i=new TextDecoder("utf-8");let a;async function s(e){const t=await fetch(e,{credentials:"same-origin"}),n=await t.arrayBuffer();let r=i.decode(n);if(/charset\s*=\s*windows-1251/i.test(r)||r.includes("�"))try{r=(a||=new TextDecoder("windows-1251")).decode(n)}catch{}return r}function c(e,t){const n=e.querySelector(o(t)),r=n?.querySelector("strong, b");let i=r?.textContent?.trim();if(!i){const e=(n?.textContent||"").trim();i=e.split(":").slice(-1)[0]?.trim()}return(i||"").replace(/\u00A0/g," ").trim()}const l=new Map;function d(e,t){if(l.has(e))return l.get(e);const n=(async()=>{const n=await s(`/profile.php?id=${encodeURIComponent(e)}`);return c((new DOMParser).parseFromString(n,"text/html"),t)})();return l.set(e,n),n}function u(){document.querySelectorAll(o(t)).forEach(e=>function(e,t){const n=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT),o=[];for(let e;e=n.nextNode();){const t=(e.nodeValue||"").match(r);t&&o.push({node:e,uid:t[1]})}o.forEach(({node:e,uid:n})=>{d(n,t).then(t=>{e?.isConnected&&e.replaceWith(document.createTextNode(t))}).catch(e=>console.error("[main-field] replace error usr"+n,e))})}(e,t))}window.MainUsrFieldResolver=window.MainUsrFieldResolver||{},window.MainUsrFieldResolver.getFieldValue||(window.MainUsrFieldResolver.getFieldValue=async function({doc:t=document,fieldId:n}={}){const i=`pa-fld${String(n??e).replace(/\D/g,"")||e}`,a=function(e){if(!e)return null;const t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_COMMENT);for(let e;e=t.nextNode();){const t=(e.nodeValue||"").match(r);if(t)return t[1]}return null}(t.querySelector(o(i)));if(a)try{return await d(a,i)}catch(e){console.warn("[main-field] remote error:",e)}return c(t,i)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()}();const IP_ROWS=1,IP_GAP=8,IP_REQUIRED=!0;function isProfileFieldsPage(){try{const e=new URL(location.href);if(!/\/profile\.php$/i.test(e.pathname))return!1;const t=e.searchParams;if("fields"!==t.get("section"))return!1;const n=t.get("id");return!!n&&/^\d+$/.test(n)}catch{return!1}}const STYLE_ID="ip-style-clean";function injectStylesOnce(){if(document.getElementById(STYLE_ID))return;const e=document.createElement("style");e.id=STYLE_ID,e.textContent="\n    /* скрываем исходный textarea/input */\n    .ip-hidden {\n      display: none !important;\n      resize: none !important;\n      visibility: hidden !important;\n    }\n\n    /* Белый контейнер подстраивается под ширину контента */\n    .ip-box {\n      position: relative;\n      display: inline-block;          /* ширина = контенту */\n      max-width: 100%;\n      border: 1px solid #ccc;\n      border-radius: 10px;\n      background: #fff;\n      padding: 6px;\n    }\n\n    /* Вертикальный скролл */\n    .ip-scroll {\n      overflow-y: auto;\n      overflow-x: hidden;\n      -webkit-overflow-scrolling: touch;\n      max-height: calc(var(--ip-rows,1) * var(--ip-h,44px)\n                      + (var(--ip-rows,1) - 1) * var(--ip-gap,8px));\n    }\n\n    /* Сетка: перенос вниз, ширина по контенту */\n    .ip-grid {\n      display: flex;\n      flex-wrap: wrap;\n      gap: var(--ip-gap,8px);\n      align-content: flex-start;\n      justify-content: flex-start;\n    }\n\n    .ip-btn {\n      position: relative;\n      overflow: hidden;\n      width: var(--ip-w,44px);\n      height: var(--ip-h,44px);\n      border: 2px solid #d0d0d0;\n      border-radius: 10px;\n      background: #fff;\n      padding: 0;\n      cursor: pointer;\n      touch-action: manipulation;\n    }\n    .ip-btn[selected] {\n      border-color: #0b74ff;\n      box-shadow: 0 0 0 3px rgba(11,116,255,.15);\n    }\n\n    .ip-slot {\n      position: relative;\n      width: 100%;\n      height: 100%;\n    }\n    .ip-slot img {\n      width: 100%;\n      height: 100%;\n      display: block;\n      object-fit: cover;\n    }\n    .ip-slot * {\n      pointer-events: none;\n    }\n  ",document.head.appendChild(e)}function resolveFieldBySuffix(e){const t=`fld${String(e)}`,n=`form[fld${String(e)}]`;return document.querySelector(`#${CSS.escape(t)}[name="${n}"]`)||document.getElementById(t)||document.querySelector(`[name="${n}"]`)}function normalizeModalLinkAttrs(e){const t=document.createElement("template");return t.innerHTML=String(e??""),t.content.querySelectorAll("a.modal-link").forEach(e=>{Array.from(e.attributes).forEach(t=>{"class"!==t.name&&"style"!==t.name&&e.removeAttribute(t.name)})}),t.innerHTML.trim()}function prepareModalLinkAttrs(e){const t=document.createElement("template");t.innerHTML=String(e??"");const n=t.content.querySelectorAll("a.modal-link");if(n.length){const e=new URL(location.href).searchParams.get("id"),t=e&&/^\d+$/.test(e)?`usr${e}`:null;n.forEach(e=>{e.setAttribute("data-reveal-id","character"),t&&e.setAttribute("id",t)})}return t.innerHTML.trim()}function createThumbSlot(e){const t=document.createElement("div");t.className="ip-slot";const n=String(e??"").trim();if(!n)return t;const r=document.createElement("template");if(r.innerHTML=n,r.content.querySelector("*"))t.appendChild(r.content.cloneNode(!0));else{const e=document.createElement("img");e.src=n,e.alt="",e.loading="lazy",t.appendChild(e)}return t}function keyFor(e){const t=String(e??"");let n=5381;for(let e=0;e<t.length;e++)n=(n<<5)+n^t.charCodeAt(e);return"k"+(n>>>0).toString(36)}const FORM_STATE=new WeakMap;function applyImagePicker(e,t,n={}){if(!isProfileFieldsPage())return;injectStylesOnce();const r=!!n.modalLinkMode,o=(Array.isArray(e)?e:[]).map(e=>String(e??"")),i=resolveFieldBySuffix(t);if(!i)return;i.classList.add("ip-hidden");const a=Number.isFinite(n.btnWidth)?Math.max(1,n.btnWidth):44,s=Number.isFinite(n.btnHeight)?Math.max(1,n.btnHeight):44,c=Number.isFinite(n.gridColSize)?Math.max(1,n.gridColSize):a,l=o.map(e=>r?normalizeModalLinkAttrs(e):e),d=new Set(l),u=new Map(l.map(e=>[e,keyFor(e)])),p=r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");let m=null;if(o.length>0){const e=document.createElement("div");e.className="ip-box",e.style.setProperty("--ip-rows",String(1)),e.style.setProperty("--ip-gap","8px"),e.style.setProperty("--ip-w",`${a}px`),e.style.setProperty("--ip-h",`${s}px`),e.style.setProperty("--ip-col",`${c}px`);const t=document.createElement("div");t.className="ip-scroll";const n=document.createElement("div");n.className="ip-grid";const d=i.id?document.querySelector(`label[for="${i.id}"]`):null;(i.closest("label")||d||i).insertAdjacentElement("afterend",e),t.addEventListener("pointerdown",e=>e.stopPropagation()),t.addEventListener("click",e=>e.stopPropagation()),l.forEach((e,t)=>{const i=document.createElement("button");i.type="button",i.className="ip-btn",i.dataset.key=u.get(e);const a=r?e:o[t];i.appendChild(createThumbSlot(a));const s=t=>{t.preventDefault(),t.stopPropagation(),g(e)};i.addEventListener("pointerdown",s),i.addEventListener("click",s),n.appendChild(i)}),t.appendChild(n),e.appendChild(t),m=n}function f(e){if(!m)return;const t=u.get(String(e))||"";if(m.querySelectorAll(".ip-btn").forEach(e=>e.removeAttribute("selected")),t){const e=m.querySelector(`.ip-btn[data-key="${t}"]`);e&&e.setAttribute("selected","")}}let h=!1;function g(e){const t=String(e??"");i.value!==t&&(h=!0,i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})),h=!1),f(t)}const w=l[0]||"",y=o.length?d.has(p)?p:w:"";i.dataset.ipInitial=y,g(y),i.addEventListener("input",()=>{h||f(r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))}),i.addEventListener("change",()=>{h||f(r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??""))});const v=i.closest("form");if(!v)return{set:g};let b=FORM_STATE.get(v);b||(b={entries:[],hooked:!1},FORM_STATE.set(v,b));if(b.entries.push({input:i,fieldSuffix:t,prepareOne:()=>{let e=r?normalizeModalLinkAttrs(String(i.value??"")):String(i.value??"");if(!o.length){const e=r?prepareModalLinkAttrs(""):"";return i.value=e,e}if(!d.has(e)){const t=i.dataset.ipInitial??w;e=String(t),g(e)}const t=r?prepareModalLinkAttrs(e):e;return i.value=t,t}}),!b.hooked){b.hooked=!0;const e=v.submit,t=()=>{b.entries.forEach(({prepareOne:e})=>{e()})};v.addEventListener("submit",e=>{"1"!==v.dataset.ipResuming&&t()},!0),v.addEventListener("formdata",e=>{t(),b.entries.forEach(({input:t,fieldSuffix:n})=>{try{const r=t.name||`form[fld${n}]`;e.formData.set(r,t.value)}catch(e){}})}),v.submit=function(...n){return"1"===v.dataset.ipResuming||t(),e.apply(this,n)}}return{set:g}}async function FMVreplaceFieldData(e,t,n,r=!1){const o=`/profile.php?section=fields&id=${encodeURIComponent(e)}&nohead`,i="#fld"+t;try{const e=await fetchCP1251Doc(o),s=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!s)return{status:"error",fieldId:String(t),value:n,serverMessage:"Форма редактирования профиля не найдена",details:"profile.php без формы"};const c=s.querySelector(i);if(!c)return{status:"error",fieldId:String(t),value:n,serverMessage:`Поле ${i} не найдено. Проверьте номер fld.`};const l=c.value??"";if(""!==(a=l)&&" "!==a&&!r)return{status:"nochange",fieldId:String(t),value:n,serverMessage:"Поле уже содержит значение. Перезапись запрещена.",details:`Прежнее значение: ${String(l)}`};if(c.value=n,![...s.elements].some(e=>"update"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="update",t.value="1",s.appendChild(t)}let d="update";const u=[...s.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));u?.name&&(d=u.name);const p=serializeFormCP1251_SelectSubmit(s,d),m=s.getAttribute("action")||"/profile.php",{res:f}=await fetchCP1251Text(m,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:o,referrerPolicy:"strict-origin-when-cross-origin",body:p});if(!f.ok)return{status:"error",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:`HTTP ${f.status} при сохранении`};const h=await fetchCP1251Doc(o),g=h.querySelector("form#profile8")||[...h.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));return(g?.querySelector(i)?.value??null)===n?{status:"updated",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Значение успешно обновлено"}:{status:"uncertain",fieldId:String(t),value:n,httpStatus:f.status,serverMessage:"Не удалось подтвердить новое значение, проверьте вручную"}}catch(e){const t=e&&e.message?e.message:String(e),n=new Error("Transport/Runtime error: "+t);throw n.cause=e,n}var a}async function FMVupdateGroupIfEquals(e,t,n,r={}){const o=!!r.overwriteSame,i=String(e),a=`/profile.php?section=admin&id=${encodeURIComponent(i)}&nohead`;try{const e=await fetchCP1251Doc(a),r=e.querySelector("form#profile8")||[...e.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php"));if(!r)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Форма администрирования профиля не найдена",details:"profile.php?section=admin без ожидаемой формы"};const s=r.querySelector('select[name="group_id"]')||r.querySelector("#group_id");if(!s)return{status:"error",userId:i,fromGroupId:String(t),toGroupId:String(n),serverMessage:"Селектор group_id не найден"};const c=(s.value??"").trim(),l=String(t).trim(),d=String(n).trim();if(c===d&&!o)return{status:"nochange",userId:i,fromGroupId:l,toGroupId:d,serverMessage:"Пользователь уже в целевой группе; перезапись отключена",details:`current=${c}`};if(c!==l&&(c!==d||!o))return{status:"skipped",userId:i,fromGroupId:l,toGroupId:d,serverMessage:"Текущая группа не совпадает с fromGroupId — изменения не требуются",details:`current=${c}`};if(s.value=d,![...r.elements].some(e=>"form_sent"===e.name)){const t=e.createElement("input");t.type="hidden",t.name="form_sent",t.value="1",r.appendChild(t)}let u="update_group_membership";const p=[...r.elements].find(e=>"submit"===e.type&&(e.name||/сохран|обнов/i.test(e.value||"")));p?.name&&(u=p.name);const m=serializeFormCP1251_SelectSubmit(r,u),f=r.getAttribute("action")||`/profile.php?section=admin&id=${encodeURIComponent(i)}`,{res:h,text:g}=await fetchCP1251Text(f,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},referrer:a,referrerPolicy:"strict-origin-when-cross-origin",body:m});if(!h.ok)return{status:"error",userId:i,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:`HTTP ${h.status} при сохранении`};const w=await fetchCP1251Doc(a),y=w.querySelector("form#profile8")||[...w.querySelectorAll("form")].find(e=>(e.action||"").includes("/profile.php")),v=y?.querySelector('select[name="group_id"]')||y?.querySelector("#group_id"),b=(v?.value??"").trim();return b===d?{status:"updated",userId:i,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:"Группа успешно обновлена"}:{status:"uncertain",userId:i,fromGroupId:l,toGroupId:d,httpStatus:h.status,serverMessage:"Сервер ответил 200, но подтвердить новое значение не удалось — проверьте вручную",details:`readback=${b}`}}catch(r){const o=r&&r.message?r.message:String(r);return{status:"error",userId:String(e),fromGroupId:String(t),toGroupId:String(n),serverMessage:"Transport/Runtime error",details:o}}}async function fetchCardsWrappedClean(e,t,n={}){const{isCoupon:r=!1}=n,o=`${location.origin.replace(/\/$/,"")}/viewtopic.php?id=${encodeURIComponent(String(e))}`,i=e=>{const t=document.createElement("div");return t.innerHTML=String(e??""),t.textContent||t.innerText||""},a=e=>(new DOMParser).parseFromString(e,"text/html");const s=a(await async function(e){if("function"==typeof window.fetchHtml)return window.fetchHtml(e);const t="function"==typeof window.fetchWithRetry?window.fetchWithRetry:fetch,n=await t(e,{credentials:"include"}),r=await n.arrayBuffer(),o=/charset=([^;]+)/i.exec(n.headers.get("content-type")||"")?.[1]?.toLowerCase(),i=e=>{try{return new TextDecoder(e).decode(r)}catch{return null}};if(o){const e=i(o);if(e)return e}const a=i("utf-8")??"",s=i("windows-1251")??"",c=e=>(e.match(/\uFFFD/g)||[]).length;if(c(s)&&!c(a))return a;if(c(a)&&!c(s))return s;const l=e=>(e.match(/[\u0400-\u04FF]/g)||[]).length;return l(s)>l(a)?s:a}(o)),c=[];for(const e of t){const t=s.querySelector(`#p${String(e)}-content`);if(!t){console.warn(`Не найден #p${e}-content на ${o}`);continue}const n=[...t.querySelectorAll('script[type="text/html"]')];if(!n.length)continue;const l=[...a(i(n.map(e=>e.textContent||e.innerHTML||"").join("\n")).replace(/\u00A0/g," ")).querySelectorAll("#grid article.card")].map(e=>{const t=FMV.normSpace(e.querySelector(".id")?.textContent||""),n=FMV.normSpace(e.querySelector(".desc")?.textContent||""),o=(e.querySelector(".content")?.innerHTML||"").replace(/\u00A0/g," ").trim(),i=n?` title="${n}"`:"";let a="";if(r){const t=FMV.normSpace(e.querySelector(".title")?.textContent||""),n=FMV.normSpace(e.querySelector(".type")?.textContent||""),r=FMV.normSpace(e.querySelector(".form")?.textContent||""),o=FMV.normSpace(e.querySelector(".value")?.textContent||"");a=`${t?` data-coupon-title="${t}"`:""}${n?` data-coupon-type="${n}"`:""}${r?` data-coupon-form="${r}"`:""}${o?` data-coupon-value="${o}"`:""}`}return{id:t,html:`<div class="item" data-id="${t}"${i}${a}>${o}</div>`}});c.push(...l)}return c}function findChronoRendered(e){const t=Array.from(e.querySelectorAll("*")).find(e=>/Собранная\s+хронология/i.test(e.textContent||""));return t?t.closest(".quote-box, .media, .spoiler-box, .content, .post, div, section")||t:null}function renderStatus(e,t){const n=window.CHRONO_CHECK?.EpisodeMapType||{personal:["personal","black"],plot:["plot","black"],au:["au","black"]},r=window.CHRONO_CHECK?.EpisodeMapStat||{on:["active","green"],off:["closed","teal"],archived:["archived","maroon"]},o=n[e]||n.au,i=r[t]||r.archived;return`[color=${o[1]}]${o[0]}[/color] / [color=${i[1]}]${i[0]}[/color]`}function parseParagraph(e){const t=[[],[],[],[]];let n=0;for(const r of e.childNodes)1!==r.nodeType||"BR"!==r.tagName?t[n].push(r):n=Math.min(n+1,3);const r=t[0],o=t[1],i=t[2],a=t[3],s=document.createElement("div");r.forEach(e=>s.appendChild(e.cloneNode(!0)));const c=s.querySelector('a[href*="viewtopic.php?id="]')||e.querySelector('a[href*="viewtopic.php?id="]'),{type:l,status:d,order:u,dateStart:p,dateEnd:m,title:f}=parseHeaderNew(r,o,c),{participants:h,masksLines:g}=parseParticipants(i),w=cleanLocation(textFromNodes(a)),y="au"===l?"":p||"",v="au"===l?"":m||y||"";return{type:l,status:d,title:f,href:c?.href||"",dateStart:y,dateEnd:v,order:Number.isFinite(u)?u:0,participants:h,masksLines:g,location:w}}function parseHeaderNew(e,t,n){const r=(n?.textContent||"").trim(),o=document.createElement("div");e.forEach(e=>o.appendChild(e.cloneNode(!0)));const i=(o.textContent||"").replace(/\s+/g," ").trim();let a="",s="",c=(o.querySelector("strong")?.textContent||"").trim();if(c){const e=c.replace(/[\u2012-\u2015\u2212—–−]/g,"-").replace(/\s*-\s*/g,"-").split("-").slice(0,2).map(e=>e.trim());a=e[0]||"",s=e[1]||""}else{const e=i.split(/\s[—–-]\s/)[0]?.trim()||"",t=parseDateFlexible(e);if(t&&t.hasDate){const e=e=>null!=e?.y?null!=e.d?`${String(e.d).padStart(2,"0")}.${String(e.m).padStart(2,"0")}.${e.y}`:null!=e.m?`${String(e.m).padStart(2,"0")}.${e.y}`:String(e.y):"";a=e(t.left),s=!t.right||t.right.y===t.left.y&&null==t.right.m&&null==t.right.d?"":e(t.right)}}/дата\s+не\s+указан/i.test(c||"")&&(a="",s="");let l="",d="",u=0;const p=textFromNodes(t).match(/\[([^\]]+)\]/);if(p){const e=p[1].split("/").map(e=>e.trim());if(l=(e[0]||"").toLowerCase(),d=(e[1]||"").toLowerCase(),e[2]){const t=parseInt(e[2],10);Number.isFinite(t)&&(u=t)}}return{type:l,status:d,order:u,dateStart:a,dateEnd:s,title:r}}function parseParticipants(e){const t=[];!function e(n){Array.from(n).forEach(n=>{3===n.nodeType?t.push({t:"text",v:n.nodeValue||""}):1===n.nodeType&&("A"===n.tagName?t.push({t:"link",name:(n.textContent||"").trim(),href:n.href||""}):e(n.childNodes))})}(e);const n=[],r=new Map;let o=null;for(const e of t){if("link"===e.t){const t=e.name;n.push({name:t,href:e.href}),o=t;continue}if("text"===e.t){let t=e.v||"";if(/\bне\s*указан/i.test(t))return{participants:[],masksLines:[]};t=t.replace(/\[\s*as\s*([^\]]+)\]/gi,(e,t)=>{const n=t.split(/\s*,\s*/).map(e=>e.trim()).filter(Boolean);var i,a;return a=n,(i=o)&&a&&a.length&&(r.has(i)||r.set(i,[]),r.get(i).push(...a)),""}),t.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{/^[–—-]+$/.test(e)||/^\[.*\]$/.test(e)||(n.push({name:e,href:""}),o=e)})}}const i=[];for(const e of n){const t=r.get(e.name);t&&t.length&&t.forEach(t=>i.push(`${e.name} — ${t}`))}return{participants:n,masksLines:i}}function cleanLocation(e){const t=String(e||"").trim();return t?/^локац/i.test(t)&&/не\s+указан/i.test(t)||/^не\s+указан/i.test(t)?"":t:""}async function collectEpisodesFromForums(e={}){async function t(e,t,n){const r=[],o=new Set;for(const i of t){const t=Promise.resolve().then(()=>n(i));r.push(t),o.add(t);const a=()=>o.delete(t);t.then(a,a),o.size>=e&&await Promise.race(o)}return Promise.all(r)}let n=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];if(!n.length){const e=new Set;document.querySelectorAll('a[href*="viewforum.php?id="]').forEach(t=>{const n=String(t.getAttribute("href")||"").match(/viewforum\.php\?id=(\d+)/i);n&&e.add(n[1])}),n=Array.from(e).map(e=>({id:e}))}if(!n.length)return console.warn("[collectEpisodesFromForums] Не удалось определить список разделов (sections)"),[];const r=(e,t)=>{try{return new URL(t,e).href}catch{return t}};const o=/[\u2012-\u2015\u2212—–−]/g,i=/[.\u2024\u2219\u00B7\u2027\u22C5·∙•]/g,a=e=>String(e).padStart(2,"0");function s(e){const t=Number(e);return Number.isFinite(t)?2===String(e).length?t>30?1900+t:2e3+t:t:null}function c(e,t){return new Date(e,t,0).getDate()}function l(e){const t=String(e||"").trim().replace(i,".");let n=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4})$/);if(n){const e=+n[1],t=+n[2],r=s(n[3]);return t<1||t>12||(e<1||e>c(r,t))?null:{y:r,m:t,d:e}}if(n=t.match(/^(\d{1,2})\.(\d{2}|\d{4})$/),n){const e=+n[1],t=s(n[2]);if(e>=1&&e<=12)return{y:t,m:e}}if(n=t.match(/^(\d{1,2})\.(\d{1,2})$/),n){const e=+n[1],t=+n[2];return t>=1&&t<=12&&e>=1&&e<=31?{m:t,d:e}:null}return n=t.match(/^(\d{2}|\d{4})$/),n?{y:s(n[1])}:null}function d(e){return null!=e.d?`${a(e.d)}.${a(e.m)}.${e.y}`:null!=e.m?`${a(e.m)}.${e.y}`:String(e.y)}function u(e){let t=String(e||"").trim();if(!t)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};t=t.replace(o,"-").replace(i,".").replace(/\s*-\s*/g,"-");const n=t.split("-").slice(0,2);if(1===n.length){const e=l(n[0]);if(!e||!e.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};const t=[e.y,e.m??0,e.d??0];return{hasDate:!0,display:d(e),startSort:t,endSort:t,left:e,right:e}}const r=n[0].trim(),u=n[1].trim(),p=l(u);if(!p||!p.y)return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};let m=l(r);const f=r.match(/^\d{1,2}$/);if(f){const e=+f[0];m=null!=p.d&&null!=p.m?{y:p.y,m:p.m,d:e}:null!=p.m?{y:p.y,m:e}:{y:s(e)}}const h=/^\d{1,2}$/.test(r),g=/^\d{1,2}$/.test(u);if(h&&g&&m?.y&&p?.y&&null==m.m&&null==m.d&&null==p.m&&null==p.d&&m.y>p.y){const e=100*Math.floor(p.y/100),t=+r;m.y=e+t}m&&null==m.y&&null!=m.d&&null!=m.m&&p.y&&(m.y=p.y);const w=e=>null==e.d||e.y&&e.m&&e.d>=1&&e.d<=c(e.y,e.m);if(!w(m)||!w(p))return{hasDate:!1,display:"",startSort:[0,0,0],endSort:[0,0,0]};return{hasDate:!0,startSort:[m.y,m.m??0,m.d??0],endSort:[p.y??m.y,p.m??0,p.d??0],display:(y=m,v=p,null!=y.d&&null!=v.d?`${a(y.d)}.${a(y.m)}.${y.y}-${a(v.d)}.${v.m}.${v.y}`:null!=y.m&&null!=v.m?`${a(y.m)}.${y.y}-${a(v.m)}.${v.y}`:`${y.y}-${v.y}`),left:m,right:p};var y,v}function p(e,t){for(let n=0;n<3;n++){const r=(e[n]??0)-(t[n]??0);if(r)return r}return 0}async function m(n,o){let i=r(location.href,`/viewforum.php?id=${n.id}`);const a=new Set,s=[];let c=0;const l=new Set;let d="";for(;i&&!a.has(i)&&c<100;){c++,a.add(i);const u=await FMV.fetchDoc(i),p=new Map;u.querySelectorAll('a[href*="viewtopic.php?id="]').forEach(e=>{const t=r(i,e.getAttribute("href")),n=t.match(/viewtopic\.php\?id=(\d+)/i),o=((a=e)&&(a.innerText??a.textContent)||"").trim();var a;n&&(/^\s*(RSS|Atom)\s*$/i.test(o)||/#p\d+$/i.test(t)||/^\d{1,2}\.\d{1,2}\.\d{2,4}(?:\s+\d{1,2}:\d{2})?$/.test(o)||p.set(n[1],{url:t,title:o}))});const m=Array.from(p.keys()).sort(),h=m.join(",");if(h&&h===d)break;d=h;const g=m.filter(e=>!l.has(e));if(0===g.length)break;g.forEach(e=>l.add(e));const w=Number.isFinite(+e?.concurrencyPerPage)?+e.concurrencyPerPage:6,y=Array.from(p.entries()),v=await t(w,y,async([e,{url:t,title:r}])=>{const i=e?`id:${e}`:`url:${t.replace(/#.*$/,"")}`;if(o.has(i))return null;const a=await f(t,r,n.type,n.status);return a?{key:i,row:a}:null});for(const e of v)e&&(o.add(e.key),s.push(e.row));const b=function(e){const t=e.querySelector('a[rel="next"], a[href*="&p="]:not([rel="prev"])');return t?t.getAttribute("href"):null}(u),S=b?r(i,b):null;if(!S||a.has(S)){i=null;break}i=S}return s}async function f(e,t,n,r){try{const o=await FMV.fetchDoc(e),i=o.querySelector(".post.topicpost .post-content")||o.querySelector(".post.topicpost")||o,a=function(e){const t=(e.querySelector("title")?.textContent||"").trim();if(/\[.+\]\s+.+/.test(t))return t;const n=e.querySelector(".crumbs, .crumbs-nav, #pun-crumbs1 .crumbs, #pun-crumbs1");if(n){const e=(n.textContent||"").replace(/\s+/g," ").trim(),t=e.split("»").pop()?.trim()||"";if(t)return t}const r=e.querySelector('a[href*="viewtopic.php?id="]');return(r?.textContent||"").trim()}(o),s=t||a||"",{dateRaw:c,episode:l}=function(e){const t=String(e||"").trim(),n=t.match(/^\s*\[(.*?)\]\s*(.*)$/s);if(n){const e=(n[1]||"").trim(),t=(n[2]||"").trim(),r=u(e);if(r&&r.hasDate)return{dateRaw:e,episode:t.replace(/\s+/g," ")}}return{dateRaw:"",episode:t.replace(/\s+/g," ")}}(s),p=u(c),m=function(e,t,n){const r=String(t||"").trim();let o=!0;if("plot"===e){const e=/\s\[\s*(?:c|с)\s*\]$/i,t=e.test(r);return o=!!n&&t,{title:t?r.replace(e,"").trim():r,ok:o}}if("au"===e){const e=/^(?:\[\s*au\s*\]\s+|\[\s*AU\s*\]\s+)/,t=e.test(r);return o=t,{title:t?r.replace(e,"").trim():r,ok:o}}return{title:r,ok:o}}(n,l||"",p.hasDate),f=FMV.readTagText(i,"characters"),h=FMV.readTagText(i,"location"),g=FMV.readTagText(i,"order"),w=await FMV.buildIdToNameMapFromTags(f),y=FMV.parseCharactersUnified(f,w,window.profileLink),v=y.ok?y.participantsLower:[],b=y.ok?y.masksByCharLower:new Map,S=FMV.parseOrderStrict(g).ok?FMV.parseOrderStrict(g).value:0,x=h?h.split(/\s*[,;]\s*/).map(e=>e.trim().toLowerCase()).filter(Boolean):[],k=v.map(e=>{const t=Array.from(b.get(e)||[]),n=/^user(\d+)$/i.exec(String(e));if(n){const e=n[1];return w&&w.has(e)?{id:e,name:w.get(e),masks:t}:{name:`user${e}`,masks:t}}return{name:String(e),masks:t}}),C=p.hasDate?null!=p.left?.d||null!=p.left?.m?d(p.left):String(p.left?.y??""):"";return{dateStart:C,dateEnd:p.hasDate?null!=p.right?.d||null!=p.right?.m?d(p.right):String(p.right?.y??p.left?.y??""):C||"",title:m.title||"",href:e,type:n,status:r,order:Number(S)||0,location:x.join(", "),participants:k,isTitleNormalized:m.ok,__hasDate:p.hasDate,__startSort:p.startSort,__endSort:p.endSort}}catch{return null}}const h=new Set;let g=[];for(const e of n){const t=await m(e,h);g=g.concat(t)}return g=g.filter(Boolean).sort(function(e,t){const n=!!e.__hasDate;if(n!==!!t.__hasDate)return n?-1:1;if(n){const n=p(e.__startSort,t.__startSort);if(n)return n;const r=p(e.__endSort,t.__endSort);if(r)return r}const r=e.order??0,o=t.order??0;return r!==o?r-o:String(e.title||"").toLowerCase().localeCompare(String(t.title||"").toLowerCase(),"ru",{sensitivity:"base"})}),g.forEach(e=>{delete e.__hasDate,delete e.__startSort,delete e.__endSort}),g}async function collectChronoByUser(e={}){if("function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");let t=Array.isArray(e.sections)&&e.sections.length?e.sections.slice():[];const n=Number.isFinite(+e.maxPagesPerSection)?+e.maxPagesPerSection:void 0,r=await collectEpisodesFromForums({sections:t,maxPagesPerSection:n}),o=Object.create(null);r.forEach((e,t)=>{Number.isFinite(e.order)||(e.order=t)});for(const e of r){const t=(e.participants||[]).map(e=>{const t=e?.id?String(e.id).trim():"";return t?{id:t,name:(e.name||"").trim(),masks:Array.isArray(e.masks)?e.masks.slice():[]}:null}).filter(Boolean);for(const n of t){const r=t.filter(e=>e!==n).map(e=>({id:e.id,name:e.name,masks:e.masks.slice()})),i={dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",order:Number(e.order||0),location:e.location||"",masks:n.masks||[],participants:r,isTitleNormalized:!!e.isTitleNormalized};o[n.id]||(o[n.id]={name:n.name||"",episodes:[]}),o[n.id].episodes.push(i)}}return o}(async()=>{const e=(...e)=>{false};e(),e(window.SKIN);const t=await collectSkinSets();e();const n=t?.icons||[],r=t?.plashki||[],o=t?.backs||[];e(n.length,r.length,o.length),window.SKIN?.PlashkaFieldID?(e(window.SKIN.PlashkaFieldID),applyImagePicker(r,SKIN.PlashkaFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0})):e(),window.SKIN?.BackFieldID?(e(window.SKIN.BackFieldID),applyImagePicker(o,SKIN.BackFieldID,{btnWidth:229,btnHeight:42,modalLinkMode:!0})):e(),window.SKIN?.IconFieldID?(e(window.SKIN.IconFieldID),applyImagePicker(n,SKIN.IconFieldID,{btnWidth:44})):e(),e()})(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-bank-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-bank-link",t.innerHTML='\n      <span>Банковская операция:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePostsByAuthorTag)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserID)return void t(e,"нет данных пользователя");const n=window.FORUMS_IDS?.Bank||[0];try{const r=await window.scrapePostsByAuthorTag(window.UserID,n,{title_prefix:"Гринготтс",stopOnNthPost:1,keywords:"ИТОГО"});if(Array.isArray(r)&&r.length&&r[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t){e.classList.remove("is-empty"),e.href=t,e.textContent="Последняя"}(e,`${t}/viewtopic.php?${r[0].src}`,r[0].date_text||r[0].text)}else t(e)}catch(n){console.error("[bank_last_comment] scrapePostsByAuthorTag failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),function(){"use strict";if(!/\/profile\.php$/i.test(location.pathname))return;if(!/[?&]id=\d+/.test(location.search))return;const e=document.createElement("style");function t(e,t){const n="Не найдена";e.classList.add("is-empty"),e.href="#",e.title=t||n,e.textContent=n}var n;e.textContent="\n    #pa-lastpost-link a.is-empty {\n      color: #999 !important;\n      text-decoration: none !important;\n      pointer-events: none;\n      cursor: default;\n      opacity: .8;\n    }\n  ",(document.head||document.documentElement).appendChild(e),n=async()=>{const e=function(){const e=document.querySelector("#viewprofile #profile-right");if(!e)return null;const t=document.createElement("li");t.id="pa-lastpost-link",t.innerHTML='\n      <span>Последний пост:</span>\n      <strong><a href="#" target="_blank" rel="nofollow noopener" class="is-empty">Загрузка…</a></strong>\n    ';const n=e.querySelector("#pa-last-visit");return n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t),t.querySelector("a")}();if(!e)return;if(!await async function(e=8e3,t=250){const n=Date.now();for(;Date.now()-n<=e;){if("function"==typeof window.scrapePostsByAuthorTag)return!0;await new Promise(e=>setTimeout(e,t))}return!1}())return void t(e,"нет доступа к поиску");if(!window.UserID)return void t(e,"нет данных пользователя");const n=[...window.FORUMS_IDS?.PersonalPosts||[1e4],...window.FORUMS_IDS?.PlotPosts||[1e4]];try{const r=await window.scrapePostsByAuthorTag(window.UserID,n,{stopOnNthPost:1,comments_only:!0});if(Array.isArray(r)&&r.length&&r[0]?.src){const t="string"==typeof window.SITE_URL&&window.SITE_URL.trim()?window.SITE_URL.trim().replace(/\/$/,""):location.origin.replace(/\/$/,"");!function(e,t,n){e.classList.remove("is-empty"),e.href=t,e.textContent=n||"Последняя"}(e,`${t}/viewtopic.php?${r[0].src}`,r[0].date_text||"Последний пост")}else t(e)}catch(n){console.error("[post_last_comment] scrapePostsByAuthorTag failed",n),t(e,"ошибка поиска")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}(),(()=>{"use strict";"function"!=typeof window.extractErrorMessage&&(window.extractErrorMessage=()=>""),"function"!=typeof window.extractInfoMessage&&(window.extractInfoMessage=()=>""),"function"!=typeof window.classifyResult&&(window.classifyResult=()=>"unknown"),window.FMV=window.FMV||{},window.FMV.replaceComment=async function(e,t,n){const r="function"==typeof window.getCurrentGroupId?window.getCurrentGroupId():null,o=new Set((e||[]).map(e=>String(Number(e))));if(!r||!o.has(String(Number(r))))return{ok:!1,status:"forbidden",postId:String(t),newText:n,errorMessage:"Нет доступа по группе"};const i=parseInt(t,10);if(!Number.isFinite(i))return{ok:!1,status:"badid",postId:String(t),newText:n,errorMessage:`Некорректный postId: ${t}`};const a=String(i),s=`/edit.php?id=${encodeURIComponent(a)}&action=edit`;try{let e,t,r,o="";try{e=await fetchCP1251Doc(s),o=e.documentElement?e.documentElement.outerHTML:"",r=e.querySelector('textarea#main-reply[name="req_message"], textarea[name="req_message"]'),r&&(t=r.closest("form"))}catch(e){return{ok:!1,status:"transport",postId:a,newText:n,errorMessage:e?.message||String(e)}}if(!t||!r){const e=extractInfoMessage(o)||"",t=extractErrorMessage(o)||"";return{ok:!1,status:classifyResult(o)||"noform",postId:a,newText:n,infoMessage:e,errorMessage:t}}const i=String(r.value||"").trim();r.value=n;const c=[...t.elements].find(e=>"submit"===e.type&&(e.name||/Отправ|Сохран|Submit|Save/i.test(e.value||"")))?.name||"submit",l=serializeFormCP1251_SelectSubmit(t,c),{res:d,text:u}=await fetchCP1251Text(s,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:l,referrer:s,referrerPolicy:"strict-origin-when-cross-origin"}),p=extractInfoMessage(u)||"",m=extractErrorMessage(u)||"",f=classifyResult(u);let h="string"==typeof f?f:f&&(f.status||f.code)?String(f.status||f.code):"unknown";return!d.ok||"unknown"!==h&&""!==h||(h="ok"),d.ok&&"ok"===h?{ok:!0,status:"ok",postId:a,oldText:i,newText:n,httpStatus:d.status}:{ok:!1,status:h,postId:a,oldText:i,newText:n,httpStatus:d.status,infoMessage:p.slice(0,200),errorMessage:m.slice(0,200)}}catch(e){return{ok:!1,status:"transport",postId:String(t),newText:n,errorMessage:e?.message||String(e)}}}})(),function(){"use strict";window.checkChronoFields=function(e=[]){const t=window.CHRONO_CHECK;return!(!t||"object"!=typeof t)&&(!Array.isArray(e)||!e.length||e.every(e=>{const n=t[e];return null!=n&&(Array.isArray(n)?n.length>0:"string"==typeof n?""!==n.trim():"number"==typeof n?Number.isFinite(n):"object"!=typeof n||Object.keys(n).length>0)}))}}(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_update_total] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,i=window.CHRONO_CHECK.ForumInfo;let a=!1;function s(e="",t=200){const n=String(e).replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"…":n}createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить общее хроно",order:1,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть ссылку",linkHref:o,async onClick(t){if(a)return;a=!0;const n=t?.setStatus||(()=>{}),c=t?.setDetails||(()=>{});t?.setLinkVisible?.(!1),t?.setLink?.("","");try{if(n("Собираю…"),c(""),"function"!=typeof collectEpisodesFromForums)throw new Error("collectEpisodesFromForums недоступна");const a=await collectEpisodesFromForums({sections:i});n("Формирую текст…");const d=function(e){const t=(e||[]).map(e=>{const t=renderStatus(e.type,e.status),n="au"===e.type?"":e.dateStart?`[b]${FMV.escapeHtml(e.dateEnd&&e.dateEnd!==e.dateStart?`${e.dateStart}-${e.dateEnd}`:e.dateStart)}[/b]`:"[mark]дата не указана[/mark]",r=FMV.escapeHtml(e.href||""),o=FMV.escapeHtml(e.title||""),i=e.isTitleNormalized?"":"au"===e.type?" [mark]в названии нет [au][/mark]":" [mark]в названии нет [с][/mark]",a=`${FMV.escapeHtml(String(e.order??0))}`,s=!0;return`${n}${n?" — ":" "}[url=${r}]${o}[/url]${i}\n[${t} / ${a}]\n[i]${Array.isArray(e.participants)&&e.participants.length?e.participants.map(e=>{const t=null!=e.id&&""!==e.id?userLink(String(e.id),e.name,s):missingUser(String(e.name||""),s),n=Array.isArray(e.masks)?e.masks:[];return`${t}${n.length?` [as ${FMV.escapeHtml(n.join(", "))}]`:""}`}).join(", "):"[mark]не указаны[/mark]"}[/i]\n${e.location?FMV.escapeHtml(e.location):"[mark]локация не указана[/mark]"}\n\n`});return`[media="Общая хронология"]${t.join("")||""}[/media]`}(a);n("Записываю…");const u=FMV.toCp1251Entities(d),p=await FMV.replaceComment(e,r,u),m=null==(l=p.status)?"":"string"==typeof l?l:String("object"==typeof l?l.status||l.code||(l.ok?"ok":"unknown"):l),f=!!p.ok||"ok"===m;n(f?"Готово":"Ошибка"),f?(t?.setLink?.(o,"Открыть ссылку"),t?.setLinkVisible?.(!0)):(t?.setLink?.("",""),t?.setLinkVisible?.(!1));const h=s(p.infoMessage||""),g=s(p.errorMessage||""),w=[`Статус: ${f?"ok":m||"unknown"}`];h&&w.push(h),g&&w.push(`<span style="color:#b00020">${FMV.escapeHtml(g)}</span>`),c(w.join("<br>"))}catch(e){n("✖ ошибка","red"),c(FMV.escapeHtmlShort(e?.message||String(e))),t?.setLinkVisible?.(!1),t?.setLink?.("","")}finally{a=!1}var l}}),"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`)})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","TotalChronoPostID","ForumInfo"]))return void console.warn("[button_total_to_excel] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, TotalChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.TotalChronoPostID).trim(),o=new URL(`/viewtopic.php?id=${n}#p${r}`,location.href).href,i=(window.SITE_URL||location.origin).replace(/\/+$/,""),a=window.CHRONO_CHECK.ForumInfo;let s="";createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"выгрузить общее хроно в excel",order:2,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Скачать",linkHref:"",async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{}),r=e?.setLink||(()=>{});e?.setLink?.("","");try{t("Собираю…"),n("");const p=await collectEpisodesFromForums({sections:a});if(!p.length)throw new Error("Эпизоды не найдены.");const h=p.map(e=>{const t=(e.participants||[]).map(e=>{const t=String(e.name||"").trim();if(!t)return"";if(null!=e.id&&""!==e.id){return`${t} — ${`${i}/profile.php?id=${encodeURIComponent(String(e.id))}`}`}return t}).filter(Boolean).join("\n"),n=(e.participants||[]).flatMap(e=>{const t=Array.isArray(e.masks)?e.masks.filter(Boolean):[],n=String(e.name||"").trim()||(null!=e.id?`user${e.id}`:"");return t.map(e=>`${n} — ${e}`)}).filter(Boolean);return{type:e.type||"",status:e.status||"",title:e.title||"",href:e.href||"",dateStart:e.dateStart||"",dateEnd:e.dateEnd||e.dateStart||"",order:Number(e.order||0)||0,participantsText:t,masksLines:n,location:e.location||""}});t("Формирую файл…");const{blob:g,filename:v}=function(e){const t=[],n=(e,n)=>t.push({name:e,data:c(n)}),r='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n</Relationships>',o='<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"\n          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n  <sheets>\n    <sheet name="Хронология" sheetId="1" r:id="rId1"/>\n  </sheets>\n</workbook>';n("[Content_Types].xml",'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml"  ContentType="application/xml"/>\n  <Override PartName="/xl/workbook.xml"          ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>\n  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n</Types>'),n("_rels/.rels",'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n</Relationships>'),n("xl/workbook.xml",o),n("xl/_rels/workbook.xml.rels",r),n("xl/worksheets/sheet1.xml",function(e){const t=`<row r="1">${["Тип","Статус","Тема","Дата начала","Дата конца","Порядок","Участники","Маски","Локация"].map(w).join("")}</row>`,n=e.map((e,t)=>`<row r="${t+2}">${[w(e.type||""),w(e.status||""),b(e.href||"",e.title||e.href||""),w(e.dateStart||""),w(e.dateEnd||e.dateStart||""),y(e.order||0),w(e.participantsText||""),w((e.masksLines||[]).join("\n")),w(e.location||"")].join("")}</row>`).join("");return`<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n  <sheetData>${t}${n}</sheetData>\n</worksheet>`}(e));const i=function(e){const t=f(),n=[],r=[];let o=0;e.forEach(e=>{const i=c(e.name),a=e.data,s=m(a),p=u([d(67324752),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(a.length),d(a.length),l(i.length),l(0),i,a]),f=u([d(33639248),l(20),l(20),l(0),l(0),l(t.time),l(t.date),d(s),d(a.length),d(a.length),l(i.length),l(0),l(0),l(0),l(0),d(0),d(o),i]);n.push(p),r.push(f),o+=p.length});const i=u(r),a=n.reduce((e,t)=>e+t.length,0),s=i.length,p=u([d(101010256),l(0),l(0),l(e.length),l(e.length),d(s),d(a),l(0)]);return new Blob([u([...n,i,p])],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}(t),a=`chronology_${(new Date).toISOString().slice(0,10)}.xlsx`;return{blob:i,filename:a}}(h);if(s)try{URL.revokeObjectURL(s)}catch{}s=URL.createObjectURL(g),t("✓ готово","green"),n(`Строк: ${h.length}\nИсточник: ${FMV.escapeHtml(o)}\nФайл: ${FMV.escapeHtml(v)}`),r(s,"Скачать");const S=e?.wrap?.querySelector("a.fmv-action-link");S&&S.setAttribute("download",v)}catch(r){t("✖ ошибка","red"),n(FMV.escapeHtmlShort(r?.message||String(r))),e?.setLink?.("","")}}});const c=e=>(new TextEncoder).encode(e),l=e=>new Uint8Array([255&e,e>>>8&255]),d=e=>new Uint8Array([255&e,e>>>8&255,e>>>16&255,e>>>24&255]),u=e=>{let t=0;e.forEach(e=>t+=e.length);const n=new Uint8Array(t);let r=0;return e.forEach(e=>{n.set(e,r),r+=e.length}),n},p=(()=>{let e,t=new Uint32Array(256);for(let n=0;n<256;n++){e=n;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e>>>0}return t})(),m=e=>{let t=~0;for(let n=0;n<e.length;n++)t=t>>>8^p[255&(t^e[n])];return(-1^t)>>>0},f=(e=new Date)=>({time:(31&e.getHours())<<11|(63&e.getMinutes())<<5|31&Math.floor(e.getSeconds()/2),date:(e.getFullYear()-1980&127)<<9|(e.getMonth()+1&15)<<5|31&e.getDate()}),h=e=>String(e||"").replace(/[<>&"]/g,e=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e])),g=e=>String(e||"").replace(/"/g,'""');function w(e){return`<c t="inlineStr"><is><t xml:space="preserve">${h(e).replace(/\r?\n/g,"&#10;")}</t></is></c>`}function y(e){return`<c><v>${Number(e)||0}</v></c>`}function v(e){return`<c><f>${h(e)}</f></c>`}function b(e,t){return e&&t?v(`HYPERLINK("${g(e)}","${g(t)}")`):e&&!t?v(`HYPERLINK("${g(e)}","${g(e)}")`):w(t||"")}})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","PerPersonChronoPostID","ForumInfo"]))return void console.warn("[button_update_per_user] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, PerPersonChronoPostID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=String(window.CHRONO_CHECK.PerPersonChronoPostID).trim(),o=(window.SITE_URL||location.origin).replace(/\/+$/,""),i=window.CHRONO_CHECK.ForumInfo;"function"!=typeof window.userLink&&(window.userLink=(e,t,n=!0)=>n?`[url=/profile.php?id=${FMV.escapeHtml(String(e))}]${FMV.escapeHtml(String(t))}[/url]`:`<a href="/profile.php?id=${FMV.escapeHtml(String(e))}">${FMV.escapeHtml(String(t))}</a>`),"function"!=typeof window.missingUser&&(window.missingUser=(e,t=!0)=>t?`[i]${FMV.escapeHtml(String(e))}[/i]`:`<i>${FMV.escapeHtml(String(e))}</i>`);const a=e=>String(e||"").trim();function s(e){const t=function(e,t){const n=a(e),r=a(t);return n||r?r&&r!==n?`[b]${n}-${r}[/b]`:`[b]${n}[/b]`:""}(e.dateStart,e.dateEnd),n=`[url=${FMV.escapeHtml(a(e.href))}]${FMV.escapeHtml(a(e.title)||a(e.href))}[/url]`,r=Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:"",o=t?`${t} — ${n}${r}`:`${n}${r}`,i=`[${renderStatus(e.type,e.status)} / ${`${FMV.escapeHtml(String(e.order??0))}`}]`,s=function(e=[]){return e.length?`[i]${e.map(e=>{const t=!0;return`${null!=e.id&&""!==String(e.id)?userLink(String(e.id),e.name,t):missingUser(String(e.name||""),t)}${Array.isArray(e.masks)&&e.masks.length?` [as ${FMV.escapeHtml(e.masks.join(", "))}]`:""}`}).join(", ")}[/i]`:""}(e.participants||[]),c=[o,i];return s&&c.push(s),a(e.location)&&c.push(FMV.escapeHtml(a(e.location))),c.join("\n")}const c=`${o}/viewtopic.php?id=${n}#p${r}`;createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"обновить хроно по персам",order:3,showStatus:!0,showDetails:!0,showLink:!0,linkText:"Открыть пост",linkHref:c,async onClick(t){const l=t?.setStatus||(()=>{}),d=t?.setDetails||(()=>{}),u=t?.setLink||(()=>{}),p=t?.setLinkVisible||(()=>{});u("",""),p?.(!1);try{l("Собираю…"),d("");const t=await(window.collectChronoByUser?window.collectChronoByUser({sections:i}):Promise.reject(new Error("collectChronoByUser недоступна"))),m=Object.entries(t||{}).map(([e,t])=>({id:e,name:t?.name||"",episodes:Array.isArray(t?.episodes)?t.episodes:[]})).filter(e=>e.name).sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));if(!m.length)return l("Пусто"),void d("Нет данных для вывода.");l("Формирую текст…");const f=m.map(e=>function(e,t=[]){return`[media="[url=${o}/viewtopic.php?id=${n}]${FMV.escapeHtml(a(e))}[/url]"]\n${t.map(s).join("\n\n")}\n[/media]`}(e.name,e.episodes)).join("\n\n"),h=`[media="Хронология по персонажам"]\n${f}\n[/media]`;l("Записываю…");const g=FMV.toCp1251Entities(h),w=await FMV.replaceComment(e,r,g),y=String(w?.status||""),v=!!w?.ok||"ok"===y;l(v?"Готово":"Ошибка"),v?(u(c,"Открыть пост"),p?.(!0)):(u("",""),p?.(!1));const b=(w?.infoMessage||"").replace(/<[^>]*>/g," ").trim(),S=(w?.errorMessage||"").replace(/<[^>]*>/g," ").trim(),x=[`Статус: ${v?"ok":y||"unknown"}`];b&&x.push(b),S&&x.push(S),d(x.join("<br>"))}catch(e){l("✖ ошибка","red"),d(e?.message||String(e)),u("",""),p?.(!1)}}})})(),(()=>{"use strict";if(!checkChronoFields(["GroupID","AmsForumID","ChronoTopicID","ForumInfo"]))return void console.warn("[button_update_chrono_api] Требуются CHRONO_CHECK.GroupID[], AmsForumID[], ChronoTopicID, ForumInfo");const e=window.CHRONO_CHECK.GroupID.map(Number),t=window.CHRONO_CHECK.AmsForumID.map(String),n=String(window.CHRONO_CHECK.ChronoTopicID).trim(),r=window.CHRONO_CHECK.ForumInfo;function o(e){const t=e.split(".").reduce((e,t)=>e&&e[t],window);if("function"!=typeof t)throw new Error(`${e} не найден — подключите соответствующий скрипт`);return t}async function i(e,t){const n=o("FMVbank.storageGet"),r=o("FMVbank.storageSet"),i=String(e);if(!t||"object"!=typeof t)return{id:i,status:"нет данных для сохранения"};try{const e=await n(Number(i),"chrono_"),o=e&&"object"==typeof e?e:{};o.chrono=t,o.last_timestamp=Math.floor(Date.now()/1e3);const a=function(e){return!0===e?"сохранено":!1===e?"ошибка сохранения":String(e)}(await r(o,Number(i),"chrono_"));return{id:i,status:a}}catch(e){return{id:i,status:`ошибка сохранения: ${e?.message||e}`}}}function a(e){const t=String(e||"").toLowerCase();return t.includes("ошибка сохранения")?"ошибка сохранения":t.includes("нет данных")||t.includes("не найден")?"пользователь не упоминается в хронологии":""}window.FMV||(window.FMV={}),"function"!=typeof window.userLinkHtml&&(window.userLinkHtml=(e,t)=>`${FMV.escapeHtml(String(t||e))}`),createForumButton({allowedGroups:e,allowedForums:t,topicId:n,label:"Сохранить хронологию в API",order:5,showStatus:!0,showDetails:!0,showLink:!1,async onClick(e){const t=e?.setStatus||(()=>{}),n=e?.setDetails||(()=>{});n("");try{t("Собираю…");const e=Array.isArray(window.CHRONO_CHECK?.UserIDs)?window.CHRONO_CHECK.UserIDs:void 0,s=await async function(e){const t=window.FMV&&"function"==typeof FMV.fetchUsers?FMV.fetchUsers:null;let n=[];if(Array.isArray(e)&&e.length)n=e.map(e=>({id:String(e)}));else if(t)try{const e=await t();n=Array.isArray(e)?e:[]}catch{}const r=new Map;for(const e of n){if(!e)continue;const t=String(e.id??""),n=String(e.name??"").trim();t&&r.set(t,n||t)}return r}(e);t("Сохраняю…");const c=await async function(e={}){const t=Number.isFinite(e.delayMs)?e.delayMs:200,n=o("collectChronoByUser"),r=e.sections;let a,s;try{a=await n({sections:r})}catch(e){throw new Error(`Ошибка collectChronoByUser: ${e?.message||e}`)}if(!a||"object"!=typeof a)throw new Error("collectChronoByUser вернул пустой результат");s=Array.isArray(e.ids)&&e.ids.length?e.ids.map(e=>({id:String(e)})):Object.keys(a).map(e=>({id:String(e)}));const c=[];for(const e of s){const n=a[e.id];if(!n){c.push({id:e.id,status:"нет данных (пользователь не найден в хроно-коллекции)"});continue}const r=await i(e.id,n);c.push(r),t&&await FMV.sleep(t)}try{console.table(c.map(e=>({id:e.id,status:e.status})))}catch{}return c}({ids:e,sections:r}),l=[];for(const e of c||[]){const t=a(e?.status);if(!t)continue;const n=String(e?.id||""),r=s.get(n)||n;l.push(`${userLinkHtml(n,r)} — ${FMV.escapeHtml(t)}`)}t("✓ готово","green"),n(l.length?l.join("<br>"):"")}catch(e){t("✖ ошибка","red"),n(e?.message||String(e))}}})})(),function(){"use strict";var e;window.FMV||(window.FMV={}),window.FMV.fetchUsers||console.warn("[FMV] Подключите общий модуль с FMV.fetchUsers до ui.js"),window.FMV.UI||function(){function e(e){const t=String(e||"").match(/\[FMVcast\]([\s\S]*?)\[\/FMVcast\]/i),n=t&&t[1]?(r=t[1],String(r||"").split(";").map(e=>e.trim()).filter(Boolean)):[];var r;const o={};return n.forEach(e=>{const t=e.match(/^(user\d+)(?:=(.+))?$/i);if(!t)return;const n=t[1],r=(t[2]||"").trim(),i=o[n]||(o[n]={code:n,masks:[]});r&&i.masks.push(r)}),o}function t(e){const t=[];return(e||[]).forEach(e=>{const n=Array.isArray(e.masks)?e.masks.filter(Boolean):[];n.length?n.forEach(n=>t.push(e.code+"="+n)):t.push(e.code)}),t.length?"[FMVcast]"+t.join(";")+"[/FMVcast]":""}function n(e){return(e=String(e||"").trim())?"[FMVplace]"+e+"[/FMVplace]":""}function r(e){let t=parseInt(String(e||"").trim(),10);return Number.isNaN(t)&&(t=0),"[FMVord]"+t+"[/FMVord]"}function o(e){return String(e||"").replace(/\[FMVcast\][\s\S]*?\[\/FMVcast\]/gi,"").replace(/\[FMVplace\][\s\S]*?\[\/FMVplace\]/gi,"").replace(/\[FMVord\][\s\S]*?\[\/FMVord\]/gi,"").replace(/^\s+|\s+$/g,"")}let i=!1;window.FMV.UI={attach:function(a){!function(){if(i)return;i=!0;const e=document.createElement("style");e.textContent="\n        :root{\n          --fmv-bg:#f7f4ea; --fmv-b:#d8d1c3; --fmv-chip:#fff;\n          --fmv-radius:10px; --fmv-gap:8px; --fmv-text:#2d2a26; --fmv-muted:#6b6359;\n        }\n\n        .msg-with-characters.fmv,\n        .msg-with-characters.fmv * { box-sizing: border-box; }\n        .msg-with-characters.fmv { width:100%; max-width:100%; overflow-x:hidden; }\n\n        .msg-with-characters.fmv{margin:10px 0; padding:10px; border:1px solid var(--fmv-b); background:var(--fmv-bg); border-radius:var(--fmv-radius)}\n        .fmv .char-row{display:flex; gap:var(--fmv-gap); align-items:flex-start; flex-wrap:wrap}\n        .fmv .combo{position:relative; flex:1 1 480px; width:100%; max-width:100%}\n        .fmv .combo input,\n        .fmv .place-row input,\n        .fmv .order-row input{\n          width:100%; max-width:100%; height:36px;\n          padding:8px 10px; border:1px solid var(--fmv-b); border-radius:8px;\n          background:#efe9dc; color:var(--fmv-text); font-size:14px;\n        }\n        .fmv .place-row,.fmv .order-row{margin-top:8px; width:100%; max-width:100%}\n        .fmv .order-row label{display:block; margin-bottom:4px; font-weight:600; color:var(--fmv-text)}\n        .fmv .order-hint,.fmv .hint{font-size:12.5px; color:var(--fmv-muted); margin-top:4px; overflow-wrap:anywhere}\n\n        .fmv .ac-list{\n          position:absolute; z-index:50; left:0; right:0; max-width:100%; background:#fff;\n          border:1px solid var(--fmv-b); border-radius:8px; margin-top:4px; max-height:240px; overflow:auto\n        }\n        .fmv .ac-item{padding:.45em .65em; cursor:pointer; font-size:14px}\n        .fmv .ac-item.active,.fmv .ac-item:hover{background:#f0efe9}\n        .fmv .ac-item .muted{color:var(--fmv-muted)}\n\n        .fmv .chips{ max-width:100%; overflow-x:hidden; }\n        .fmv .chips .chip{\n          display:flex; align-items:center; justify-content:flex-start;\n          gap:10px; padding:.45em .6em; background:var(--fmv-chip);\n          border:1px solid var(--fmv-b); border-radius:8px; margin:.35em 0; font-size:14px\n        }\n        .fmv .chip .drag{cursor:grab; margin-right:.4em; color:#8b8378}\n        .fmv .chip .name{font-weight:600}\n\n        .fmv .masks{display:flex; align-items:center; gap:6px; flex-wrap:wrap; color:var(--fmv-muted)}\n        .fmv .masks .masks-label{ color:var(--fmv-muted); margin-right:2px; }\n        .fmv .mask-badge{\n          display:inline-flex; align-items:center; gap:6px;\n          padding:2px 8px; border:1px solid var(--fmv-b); border-radius:999px;\n          background:#efe9dc; font-size:13px; color:var(--fmv-text);\n        }\n        .fmv .mask-badge .mask-remove{\n          border:0; background:none; cursor:pointer; line-height:1;\n          color:#8b8378; font-size:14px; padding:0 2px;\n        }\n\n        .fmv .chip .add-mask{border:0; background:none; color:#2e5aac; cursor:pointer; padding:0; text-decoration:underline; margin-left:auto}\n        .fmv .chip .x{border:0; background:none; font-size:16px; line-height:1; cursor:pointer; color:#8b8378; margin-left:8px}\n\n        .fmv .chip .mask-input{ display:none; margin-left:auto; }\n        .fmv .chip .mask-input.is-open{ display:flex; align-items:center; gap:8px; }\n        .fmv .chip .mask-input input{\n          flex:1; min-width:220px; height:30px;\n          padding:6px 8px; border:1px solid var(--fmv-b); border-radius:6px;\n          background:#efe9dc; color:var(--fmv-text);\n        }\n        .fmv .chip .btn{ border:1px solid var(--fmv-b); border-radius:6px; background:#fff; padding:6px 10px; cursor:pointer; line-height:1; }\n        .fmv .chip .btn-ok{ background:#e9f6e9; }\n        .fmv .chip .btn-cancel{ background:#f4eeee; }\n\n        .fmv-admin-tools{display:flex;justify-content:flex-end;margin:6px 0 8px}\n        .fmv-admin-tools .fmv-toggle{border:1px solid var(--fmv-b);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}\n\n        /* заголовок блока */\n        .fmv .section-title{\n          font-weight:700;\n          font-size:14px;\n          text-align: center;\n          line-height:1.25;\n          margin:4px 0 12px;\n          color: var(--fmv-text);\n        }\n\n        /* делаем «колонку» с равным шагом и без внутренних margin */\n        .fmv .combo,\n        .fmv .place-row,\n        .fmv .order-row {\n          display: grid;\n          grid-template-columns: 1fr;\n          row-gap: 8px;             /* вот этим управляем расстоянием между label ↔ input ↔ hint */\n        }\n        \n        .fmv .place-row label,\n        .fmv .order-row label,\n        .fmv .combo label,\n        .fmv .place-row .hint,\n        .fmv .order-row .order-hint,\n        .fmv .combo .hint {\n          margin: 0;                /* убираем наследованные отступы, чтобы они не «схлопывались» */\n        }\n        \n        /* (оставляем общий верхний зазор секции) */\n        .fmv .place-row, .fmv .order-row { margin-top: 8px; }\n\n        .fmv .chip .name { font-weight: 600; }\n        .fmv .chip .name .name-code { font-weight: 400; color: var(--fmv-muted); }\n\n        ",document.head.appendChild(e)}();const s="string"==typeof a.form?$(a.form):a.form,c="string"==typeof a.textarea?$(a.textarea):a.textarea;if(!s?.length||!c?.length)return null;const l=c.val()||"",d=/\[FMV(?:cast|place|ord)\][\s\S]*?\[\/FMV(?:cast|place|ord)\]/i.test(l);if(a.showOnlyIfFMVcast&&!d)return null;if(a.stripOnMount&&c.val(o(l)),s.data("fmvBoundUI"))return s.data("fmvBoundUI");const u="msg-with-characters fmv "+(a.className||""),p=$("<div/>",{class:u}),m=$('<div class="section-title">Для автоматического сбора хронологии</div>'),f=$('<div class="char-row"/>'),h=$('<div class="combo"/>'),g=$('<label for="character-combo" style="font-weight:600;display:block;margin-bottom:4px">Участники эпизода:</label>'),w=$('<input type="text" id="character-combo" placeholder="Наберите имя персонажа…" autocomplete="off">'),y=$('<div class="ac-list" role="listbox" aria-label="Варианты персонажей"></div>'),v=$('<div class="hint">Если что-то не работает, напишите в Приемную.</div>');h.append(g,w,y,v),f.append(h);const b=$('<div class="chips"/>'),S=$('<div class="place-row"/>'),x=$('<label for="fmv-place" style="font-weight:600">Локация:</label>'),k=$('<input type="text" id="fmv-place" placeholder="Укажите локацию">'),C=$('<div class="hint">Лучше указывать в едином формате: Хогвартс, Косой переулок, Лютный переулок, Министерство и т.д.</div>');S.append(x,k,C);const E=$('<div class="order-row"/>'),_=$('<label for="fmv-ord" style="font-weight:600">Для сортировки эпизодов в один день</label>'),F=$('<input type="number" id="fmv-ord" placeholder="0" value="0" step="1">'),I=$('<div class="order-hint">Помогает упорядочить эпизоды, которые стоят в один день. Чем больше значение, тем позже эпизод. Лучше оставлять 0.</div>');E.append(_,F,I),c.before(p),p.append(m,f,b,S,E);let M=[],A=[];function L(){b.empty(),M.forEach(function(e,t){const n=$('<div class="chip" draggable="true" data-idx="'+t+'"/>');n.append('<span class="drag" title="Перетащите для изменения порядка">↕</span>');const r=$('<span class="name"/>');r.append(document.createTextNode(e.name+" ")),r.append($('<span class="name-code"/>').text("("+e.code+")")),n.append(r);const o=$('<span class="masks"/>');e.masks?.length?(o.append('<span class="masks-label">— маски:</span>'),e.masks.forEach(function(e,t){const n=$('<span class="mask-badge" data-mi="'+t+'"><span class="mask-text"></span><button type="button" class="mask-remove" aria-label="Удалить маску">×</button></span>');n.find(".mask-text").text(e),o.append(n)})):o.text(" — масок нет");const i=$('<button class="add-mask" type="button">добавить маску</button>'),a=$('<button class="x" type="button" aria-label="Удалить">×</button>'),s=$('<span class="mask-input"></span>').hide(),c=$('<input type="text" placeholder="маска (текст)">'),l=$('<button type="button" class="btn btn-ok">Ок</button>'),d=$('<button type="button" class="btn btn-cancel">Отмена</button>');s.append(c,l,d),c.on("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),l.click())}),i.on("click",()=>{n.find(".mask-input").removeClass("is-open").hide(),s.addClass("is-open").show(),c.val("").focus()}),l.on("click",()=>{const t=$.trim(c.val());t&&((e.masks||(e.masks=[])).push(t),L())}),d.on("click",()=>{s.removeClass("is-open").hide()}),a.on("click",()=>{M.splice(t,1),L()}),n.append(o,i,s,a),b.append(n)})}function D(e){if(!e||M.some(t=>t.code===e))return;const t=A.find(t=>t.code===e);M.push({code:e,name:t?t.name:e,masks:[]}),L(),w.val(""),y.hide().empty()}function T(e){const t=(e||"").trim().toLowerCase(),n=A.filter(e=>!M.some(t=>t.code===e.code)).filter(e=>!t||e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)).slice().sort((e,t)=>e.name.localeCompare(t.name,"ru",{sensitivity:"base"}));y.empty(),n.length?(n.slice(0,40).forEach(e=>{y.append($('<div class="ac-item" role="option"/>').attr("data-code",e.code).text(e.name+" ("+e.code+")"))}),y.show(),N(0)):y.append('<div class="ac-item"><span class="muted">Ничего не найдено</span></div>').show()}function N(e){const t=y.children(".ac-item");t.removeClass("active"),t.length&&(e=(e+t.length)%t.length,t.eq(e).addClass("active"),y.data("activeIndex",e))}if(b.on("dragstart",".chip",function(e){$(this).addClass("dragging"),e.originalEvent.dataTransfer.setData("text/plain",$(this).data("idx"))}),b.on("dragend",".chip",function(){$(this).removeClass("dragging")}),b.on("dragover",function(e){e.preventDefault()}),b.on("drop",function(e){e.preventDefault();const t=+e.originalEvent.dataTransfer.getData("text/plain"),n=$(e.target).closest(".chip");if(!n.length)return;const r=+n.data("idx");if(isNaN(t)||isNaN(r)||t===r)return;const o=M.splice(t,1)[0];M.splice(r,0,o),L()}),b.on("click",".mask-remove",function(){const e=+$(this).closest(".chip").data("idx"),t=+$(this).closest(".mask-badge").data("mi");isNaN(e)||isNaN(t)||!Array.isArray(M[e].masks)||(M[e].masks.splice(t,1),L())}),w.on("input",function(){T(this.value)}),w.on("keydown",function(e){const t=0|y.data("activeIndex");if("ArrowDown"===e.key&&y.is(":visible"))e.preventDefault(),N(t+1);else if("ArrowUp"===e.key&&y.is(":visible"))e.preventDefault(),N(t-1);else if("Enter"===e.key){e.preventDefault();const t=y.is(":visible")?function(){const e=0|y.data("activeIndex");return y.children(".ac-item").eq(e).data("code")}():function(){const e=($.trim(w.val())||"").toLowerCase();if(!e)return null;const t=A.filter(e=>!M.some(t=>t.code===e.code)),n=t.find(t=>t.name.toLowerCase()===e)||t.find(t=>t.code.toLowerCase()===e);if(n)return n.code;const r=t.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e));if(1===r.length)return r[0].code;const o=r.filter(t=>t.name.toLowerCase().startsWith(e));return 1===o.length?o[0].code:null}();t?D(t):T(this.value)}else"Escape"===e.key&&y.hide()}),y.on("mousedown",".ac-item",function(){const e=$(this).data("code");e&&D(e)}),$(document).on("click",function(e){$(e.target).closest(h).length||y.hide()}),"function"==typeof FMV.fetchUsers&&FMV.fetchUsers().then(function(t){A=(t||[]).slice(),!1!==a.prefill&&function(t){M=[];const n=e(t||""),r=String(t||"").match(/\[FMVplace\]([\s\S]*?)\[\/FMVplace\]/i);r&&"string"==typeof r[1]&&k.val(r[1].trim());const o=String(t||"").match(/\[FMVord\]([\s\S]*?)\[\/FMVord\]/i);if(o&&"string"==typeof o[1]){let e=parseInt(o[1].trim(),10);Number.isNaN(e)&&(e=0),F.val(e)}Object.keys(n).forEach(e=>{const t=A.find(t=>t.code===e);M.push({code:e,name:t?t.name:e,masks:n[e].masks})}),L()}(l)}).catch(function(e){y.html('<div class="ac-item"><span class="muted">'+(e||"Ошибка загрузки")+"</span></div>").show()}),s.off("submit.fmv.ui").on("submit.fmv.ui",function(e){const i=s.find('input[name="req_subject"]'),a=!i.length||$.trim(i.val()||"").length>0,l=o(c.val()||""),d=$.trim(l).length>0,u=M.length>0,p=$.trim(k.val()||"").length>0;if(!(a&&d&&u&&p)){e.preventDefault(),"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation(),"function"==typeof e.stopPropagation&&e.stopPropagation();const t=[];return a||t.push("Заголовок"),d||t.push("Основной текст"),u||t.push("Участники"),p||t.push("Локация"),alert("Заполните: "+t.join(", ")),!1}const m=[t(M),n(k.val()),r(F.val())].filter(Boolean).join("");let f=l.replace(/[ \t]+$/,"");const h=!f||/\n$/.test(f)?"":"\n";c.val(f+h+m)}),function(){const e=(window.CHRONO_CHECK?.GroupID||[]).map(String),t=(window.CHRONO_CHECK?.AllowedUser||[]).map(String),n="function"==typeof window.getCurrentGroupId?String(window.getCurrentGroupId()):"",r="function"==typeof window.getCurrentUserId?String(window.getCurrentUserId()):"";return n&&e.includes(n)||r&&t.includes(r)}()){let e=s.data("fmvAdminTools");e&&e.length||(e=$('<div class="fmv-admin-tools"><button type="button" class="fmv-toggle">Режим ручного редактирования</button></div>'),s.data("fmvAdminTools",e)),p.before(e);const i=e.find(".fmv-toggle");i.off("click.fmv");const a=()=>{const e=[t(M),n(k.val()),r(F.val())].filter(Boolean).join(""),a=o(c.val()||"").replace(/[ \t]+$/,""),l=!a||/\n$/.test(a)?"":"\n";c.val(a+(e?l+e:"")),p.remove(),s.off("submit.fmv.ui").removeData("fmvBoundUI"),i.data("raw",!0).text("Вернуться к удобной форме")},l=()=>{FMV.UI.attach({form:s,textarea:c,prefill:!0,showOnlyIfFMVcast:!1,className:"fmv--compact",stripOnMount:!0}),i.data("raw",!1).text("Режим ручного редактирования")};i.on("click.fmv",()=>i.data("raw")?l():a())}const O={serialize:()=>[t(M),n(k.val()),r(F.val())].filter(Boolean).join(""),stripFMV:o,mountPoint:p};return s.data("fmvBoundUI",O),O}}}(),e=function(){if(window.__FMV_BOOTSTRAPPED__)return;if(window.__FMV_BOOTSTRAPPED__=!0,!FMV.UI||"function"!=typeof FMV.UI.attach)return;const e=new URL(location.href),t=e.pathname,n=e.searchParams;function r({strip:e=!1,showOnlyIfCast:t=!1}={}){const n=$('#post form, form[action*="post.php"], form[action*="edit.php"]').first(),r=n.find('textarea[name="req_message"], #main-reply, .questionary-post textarea').first();return n.length&&r.length?FMV.UI.attach({form:n,textarea:r,prefill:!0,showOnlyIfFMVcast:!!t,className:"fmv--compact",stripOnMount:!!e}):null}if(/\/post\.php$/i.test(t)&&!n.has("action")){const e=+(n.get("fid")||0);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(e)&&r({strip:!1,showOnlyIfCast:!1})}if(/\/post\.php$/i.test(t)&&"post"===n.get("action")){if(n.has("tid"))return;const e=Number(n.get("fid")),t=(window.CHRONO_CHECK?.ForumID||[]).map(Number);e&&!t.includes(e)||r({strip:!0,showOnlyIfCast:!1})}if(/\/edit\.php$/i.test(t)&&n.has("id")&&document.querySelector('input[name="firstpost"]')){const e=document.querySelector(".container.crumbs a:nth-of-type(2)");if(e&&e.href.includes("/viewforum.php?id=")&&e.href.split("/viewforum.php?id=").length>=2){const t=Number(e.href.split("/viewforum.php?id=")[1]);(window.CHRONO_CHECK?.ForumID||[]).map(Number).includes(t)&&r({strip:!0,showOnlyIfCast:!1})}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}(),(()=>{"use strict";const e="Показать скрытые теги";async function t(e,{timeout:t=1e4,interval:n=100}={}){const r=performance.now();for(;performance.now()-r<t;){try{const t=e();if(t)return t}catch{}await FMV.sleep(n)}return null}function n(){const t=document.querySelector(".ams_info");return t&&Array.from(t.querySelectorAll("div[data-order]")).find(t=>{const n=t.querySelector("button.button");return 1===Number(t.dataset.order)&&n&&n.textContent.trim()===e})||null}async function r(){if(!await t(()=>window.FMV&&"function"==typeof FMV.readTagText&&"function"==typeof FMV.escapeHtml&&"function"==typeof FMV.parseOrderStrict&&"function"==typeof FMV.buildIdToNameMapFromTags&&"function"==typeof FMV.parseCharactersUnified&&"function"==typeof window.profileLink,{timeout:15e3}))return null;const e=await t(()=>document.querySelector(".topic .post.topicpost, .post.topicpost, .message:first-of-type"),{timeout:15e3});if(!e)return null;const n=window.CHRONO_CHECK?.GroupID||[];if("function"==typeof window.ensureAllowed&&!window.ensureAllowed(n))return null;const r=FMV.readTagText(e,"characters"),o=FMV.readTagText(e,"location"),i=FMV.readTagText(e,"order"),a=await FMV.buildIdToNameMapFromTags(r),s=[];if(r){const e=FMV.renderParticipantsHtml(r,a,(e,t)=>window.profileLink(e,t));s.push(`<div class="fmv-row"><span class="fmv-label">Участники:</span>${e}</div>`)}if(o&&s.push(`<div class="fmv-row"><span class="fmv-label">Локация:</span>${FMV.escapeHtml(o)}</div>`),i){const e=FMV.parseOrderStrict(i);s.push(`<div class="fmv-row"><span class="fmv-label">Для сортировки:</span>${e.html}</div>`)}if(!s.length)return null;!function(){if(document.getElementById("fmv-meta-style"))return;const e=document.createElement("style");e.id="fmv-meta-style",e.textContent="\n      .fmv-meta{\n        margin:8px 0; padding:8px; border:1px solid #d7d7d7;\n        background:#f7f7f7; border-radius:6px;\n      }\n      .fmv-row{margin:.25em 0}\n      .fmv-label{font-weight:700;margin-right:.25em}\n      .fmv-missing{color:#c00;background:#ffe6e6;border-radius:6px;padding:0 .25em;font-weight:700}\n    ",document.head.appendChild(e)}();const c=document.createElement("div");return c.className="fmv-meta",c.innerHTML=s.join("\n"),c}async function o(){const e=n();if(!e)return;!function(){const e=n(),t=e?.nextElementSibling;t&&t.classList.contains("fmv-meta")&&t.remove()}();const t=await r();t&&e.parentNode.insertBefore(t,e.nextSibling)}window.CHRONO_CHECK&&Array.isArray(window.CHRONO_CHECK.GroupID)&&Array.isArray(window.CHRONO_CHECK.ForumID)?createForumButton({allowedGroups:window.CHRONO_CHECK.GroupID,allowedForums:window.CHRONO_CHECK.ForumID,label:e,order:1,showStatus:!1,showDetails:!1,showLink:!1,async onClick({wrap:e}){if(e.nextElementSibling?.classList.contains("fmv-meta"))e.nextElementSibling.remove(),localStorage.setItem("fmv:meta:enabled","0");else{const t=await r();t&&(e.parentNode.insertBefore(t,e.nextSibling),localStorage.setItem("fmv:meta:enabled","1"))}}}):console.warn("[tags_visibility] Требуются CHRONO_CHECK.GroupID, ForumID"),(async()=>{"1"!==localStorage.getItem(function(){try{const e=new URL(location.href);return`fmv:meta:enabled:${e.searchParams.get("id")||e.searchParams.get("tid")||e.pathname}`}catch{return`fmv:meta:enabled:${location.href}`}}())||function(){const e=n(),t=e?.nextElementSibling;return!(!t||!t.classList.contains("fmv-meta"))}()||await o()})()})(),window.scrapePostsByAuthorTag=async function(e,t,{stopOnNthPost:n,last_src:r=[],title_prefix:o="",maxPages:i=999,delayMs:a=300,keywords:s="",comments_only:c=!1,min_symbols_num:l=-1}={}){if(!e)throw new Error("authorUserId обязателен");if(!t||Array.isArray(t)&&0===t.length)throw new Error("forums обязателен");const d=Array.isArray(t)?t.join(","):String(t),u=String(s??"").trim(),p=u?`usr${e} AND ${u}`:"",m=String(o||"").trim().toLocaleLowerCase("ru"),f=Array.isArray(r)?r:[r].filter(Boolean),h=new Set(f.map(g));function g(e){try{const t=new URL(e,location.href),n=t.hash&&t.hash.match(/^#p(\d+)$/);if(n){const e=n[1];return`pid=${e}#p${e}`}const r=t.searchParams.get("pid");if(r)return`pid=${r}#p${r}`;const o=t.searchParams.get("p");return o?`pid=${o}#p${o}`:t.toString()}catch{return e}}function w(e){let t=0;const n=e.join("\n");for(const e of n)t=(t<<5)-t+e.charCodeAt(0),t|=0;return t}function y(e){const t=[["action","search"],["keywords",p?encodeForSearch(p):""],["author",""],["forums",d],["search_in","0"],["sort_by","0"],["sort_dir","DESC"],["show_as","posts"],["search",encodeForSearch("Отправить")],["p",String(e)]].filter(([e,t])=>""!==t).map(([e,t])=>`${e}=${t}`).join("&");return new URL(`/search.php?${t}`,location.origin).toString()}async function v(e){if(window.FMV?.fetchDoc)return await window.FMV.fetchDoc(e);if("function"==typeof fetchCP1251Doc)return await fetchCP1251Doc(e);if("function"==typeof fetchHtml){const t=await fetchHtml(e);return(new DOMParser).parseFromString(t,"text/html")}const t=await fetch(e,{credentials:"include"}),n=await t.text();return(new DOMParser).parseFromString(n,"text/html")}function b(e){if("Информация"===(e.querySelector("title")?.textContent||"").trim()){const t=e.querySelector("#pun-main .info .container");if(t&&/ничего не найдено/i.test(t.textContent))return!0}return!1}function S(e=""){const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll(".quote-box.hide-box").forEach(e=>{const t=e.querySelector("blockquote");if(t){const n=document.createElement("div");n.innerHTML=t.innerHTML,e.replaceWith(n)}}),t.querySelectorAll("cite").forEach(e=>e.remove()),t.querySelectorAll(".code-box").forEach(e=>{const t=e.querySelector("pre"),n=t?t.textContent:"",r=document.createElement("div");r.textContent=n||"",e.replaceWith(r)}),t.querySelectorAll(".custom_tag, .hidden_tag, characters, location, order").forEach(e=>e.remove()),t.querySelectorAll('script[type="text/html"]').forEach(e=>{const t=document.createElement("div");t.innerHTML=e.textContent||"",t.querySelectorAll("p, br").forEach(e=>e.insertAdjacentText("afterend","\n"));let n=(t.textContent||"").replace(/\u00A0/g," ").replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");e.insertAdjacentText("beforebegin",n?`\n${n}\n`:""),e.remove()});const n=["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DIV","DL","DT","DD","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","THEAD","TBODY","TFOOT","TR","UL","BR"].join(",");t.querySelectorAll(n).forEach(e=>{"BR"===e.tagName?e.insertAdjacentText("beforebegin","\n"):e.insertAdjacentText("afterend","\n")});let r=(t.textContent||"").replace(/\u00A0/g," ");r=r.replace(/\[\/?indent\]/gi,"").replace(/\[\/?float(?:=[^\]]+)?\]/gi,"").replace(/\[DiceFM[^\]]*?\]/gi,""),r=r.replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n");const o=[];for(const e of r.split("\n")){const t=e.trim();""===t?o.length&&""!==o[o.length-1]&&o.push(""):o.push(t)}return o.join("\n").replace(/ {2,}/g," ").replace(/\n{2,}/g,"\n").replace(/^\n+|\n+$/g,"").trim()}function x(e){const t=e.querySelector("h3 > span"),n=t?t.querySelectorAll("a"):[],r=(n[1]?.textContent?.trim()||"").toLocaleLowerCase("ru"),o=n[2]?new URL(n[2].getAttribute("href"),location.href).href:"",i=o?g(o):"",a=n[2]?.innerText?.trim()||"",s=e.getAttribute("data-posted"),c=Number(s),l=e.querySelector(".post-content");let d=l?.innerHTML?.trim()||"";d=d.replace(/\[html\]([\s\S]*?)\[\/html\]/gi,(e,t)=>S(t));const u=S(d);return{title:r,src:i,text:u,html:d,symbols_num:u.length,date_ts:c,date_text:a}}function k(e){let t=[...e.querySelectorAll(".post")].map(x).filter(e=>!m||e.title.startsWith(m));return t=t.filter(e=>!h.has(e.src)),l>0&&(t=t.filter(e=>e.symbols_num>=l)),t}const C=[];let E=null,_=0;for(let e=1;e<=i;e++){const t=await v(y(e));if(b(t))break;if(1===Number(t.querySelector("div.linkst div.pagelink strong")?.textContent||e)&&1!==e)break;const r=k(t);if(r.length)C.push(...r),r.forEach(e=>h.add(e.src)),_=0;else{const e=w(C.map(e=>e.src));if(e===E){if(_++,_>=3)break}else E=e,_=0}if(n&&C.length>=n)break;e<i&&await(window.FMV?.sleep?.(a)??new Promise(e=>setTimeout(e,a)))}return C};